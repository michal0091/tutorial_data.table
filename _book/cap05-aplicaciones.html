<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>12&nbsp; Aplicaciones del Mundo Real – Domina data.table en R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./conclusion.html" rel="next">
<link href="./cap05-visualizacion.html" rel="prev">
<link href="./images/favicon.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-d14ef1f108961a0fb37502f1e6f08aaf.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-aecbfc4a73d8344c2d918b5cbe22c140.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><style>html{ scroll-behavior: smooth; }</style>
<link rel="stylesheet" href="styles.css">
</head>
<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./cap05-visualizacion.html"><strong>Módulo 5</strong>: Integración con el Ecosistema R</a></li><li class="breadcrumb-item"><a href="./cap05-aplicaciones.html"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Aplicaciones del Mundo Real</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      <img src="./logos\kinelytic-header-logo.svg" alt="Company name with logo" class="sidebar-logo py-0 d-lg-inline d-none"></a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Domina data.table en R</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/tutorial-datatable/tutorial_data.table" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Prefacio</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introducción a <code>data.table</code></span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text"><strong>Módulo 1</strong>: Fundamentos y Sintaxis Esencial</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap01-sintaxis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">La Sintaxis <code>DT[i, j, by]</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap01-simbolos.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Símbolos Especiales en <code>data.table</code></span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text"><strong>Módulo 2</strong>: Manipulación de Datos Intermedia</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap02-encadenamiento.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Encadenamiento de Operaciones (Chaining)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap02-joins.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Uniones de Datos (Joins)</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text"><strong>Módulo 3</strong>: Técnicas Avanzadas y Funciones Especiales</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap03-joins-avanzados.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Joins Avanzados: Non-Equi y Rolling Joins</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap03-funciones-especiales.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Funciones Especiales y Análisis Temporal</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap03-reshape.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Remodelación de Datos: <code></code></span></span></a><code><a href="https://rdatatable.gitlab.io/data.table/reference/melt.data.table.html">melt()</a></code> y <code><a href="https://rdatatable.gitlab.io/data.table/reference/dcast.data.table.html">dcast()</a></code>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text"><strong>Módulo 4</strong>: Optimización y Buenas Prácticas</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap04-performance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Optimización de Performance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap04-buenas-practicas.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Buenas Prácticas y Código Idiomático</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text"><strong>Módulo 5</strong>: Integración con el Ecosistema R</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap05-visualizacion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Visualización de Datos con data.table</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap05-aplicaciones.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Aplicaciones del Mundo Real</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./conclusion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Conclusiones y Próximos Pasos</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Referencias</span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="2"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#aplicaciones-shiny-escalables-con-data.table" id="toc-aplicaciones-shiny-escalables-con-data.table" class="nav-link active" data-scroll-target="#aplicaciones-shiny-escalables-con-data.table"><span class="header-section-number">12.1</span> Aplicaciones Shiny Escalables con data.table</a>
  <ul class="collapse">
<li><a href="#arquitectura-de-app-shiny-profesional" id="toc-arquitectura-de-app-shiny-profesional" class="nav-link" data-scroll-target="#arquitectura-de-app-shiny-profesional"><span class="header-section-number">12.1.1</span> 1. <strong>Arquitectura de App Shiny Profesional</strong></a></li>
  <li><a href="#optimizaci%C3%B3n-de-performance-en-shiny" id="toc-optimización-de-performance-en-shiny" class="nav-link" data-scroll-target="#optimizaci%C3%B3n-de-performance-en-shiny"><span class="header-section-number">12.1.2</span> 2. <strong>Optimización de Performance en Shiny</strong></a></li>
  </ul>
</li>
  <li>
<a href="#integraci%C3%B3n-con-tidymodels-machine-learning-robusto" id="toc-integración-con-tidymodels-machine-learning-robusto" class="nav-link" data-scroll-target="#integraci%C3%B3n-con-tidymodels-machine-learning-robusto"><span class="header-section-number">12.2</span> Integración con tidymodels: Machine Learning Robusto</a>
  <ul class="collapse">
<li><a href="#workflow-completo-data.table-tidymodels-data.table" id="toc-workflow-completo-data.table-tidymodels-data.table" class="nav-link" data-scroll-target="#workflow-completo-data.table-tidymodels-data.table"><span class="header-section-number">12.2.1</span> 1. <strong>Workflow Completo: data.table → tidymodels → data.table</strong></a></li>
  <li><a href="#modelado-con-tidymodels-ejemplo-conceptual" id="toc-modelado-con-tidymodels-ejemplo-conceptual" class="nav-link" data-scroll-target="#modelado-con-tidymodels-ejemplo-conceptual"><span class="header-section-number">12.2.2</span> 2. <strong>Modelado con tidymodels (Ejemplo Conceptual)</strong></a></li>
  <li><a href="#post-procesamiento-y-an%C3%A1lisis-con-data.table" id="toc-post-procesamiento-y-análisis-con-data.table" class="nav-link" data-scroll-target="#post-procesamiento-y-an%C3%A1lisis-con-data.table"><span class="header-section-number">12.2.3</span> 3. <strong>Post-procesamiento y Análisis con data.table</strong></a></li>
  </ul>
</li>
  <li>
<a href="#dtplyr-el-puente-entre-data.table-y-tidyverse" id="toc-dtplyr-el-puente-entre-data.table-y-tidyverse" class="nav-link" data-scroll-target="#dtplyr-el-puente-entre-data.table-y-tidyverse"><span class="header-section-number">12.3</span> dtplyr: El Puente Entre data.table y tidyverse</a>
  <ul class="collapse">
<li><a href="#introducci%C3%B3n-y-casos-de-uso" id="toc-introducción-y-casos-de-uso" class="nav-link" data-scroll-target="#introducci%C3%B3n-y-casos-de-uso"><span class="header-section-number">12.3.1</span> 1. <strong>Introducción y Casos de Uso</strong></a></li>
  <li><a href="#comparaci%C3%B3n-de-performance-dtplyr-vs-dplyr-puro" id="toc-comparación-de-performance-dtplyr-vs-dplyr-puro" class="nav-link" data-scroll-target="#comparaci%C3%B3n-de-performance-dtplyr-vs-dplyr-puro"><span class="header-section-number">12.3.2</span> 2. <strong>Comparación de Performance: dtplyr vs dplyr puro</strong></a></li>
  </ul>
</li>
  <li>
<a href="#conexi%C3%B3n-con-bases-de-datos-y-big-data" id="toc-conexión-con-bases-de-datos-y-big-data" class="nav-link" data-scroll-target="#conexi%C3%B3n-con-bases-de-datos-y-big-data"><span class="header-section-number">12.4</span> Conexión con Bases de Datos y Big Data</a>
  <ul class="collapse">
<li><a href="#lecturaescritura-eficiente-con-freadfwrite" id="toc-lecturaescritura-eficiente-con-freadfwrite" class="nav-link" data-scroll-target="#lecturaescritura-eficiente-con-freadfwrite"><span class="header-section-number">12.4.1</span> 1. <strong>Lectura/Escritura Eficiente con fread/fwrite</strong></a></li>
  <li><a href="#integraci%C3%B3n-con-bases-de-datos" id="toc-integración-con-bases-de-datos" class="nav-link" data-scroll-target="#integraci%C3%B3n-con-bases-de-datos"><span class="header-section-number">12.4.2</span> 2. <strong>Integración con Bases de Datos</strong></a></li>
  <li><a href="#integraci%C3%B3n-con-apache-arrowparquet" id="toc-integración-con-apache-arrowparquet" class="nav-link" data-scroll-target="#integraci%C3%B3n-con-apache-arrowparquet"><span class="header-section-number">12.4.3</span> 3. <strong>Integración con Apache Arrow/Parquet</strong></a></li>
  </ul>
</li>
  <li>
<a href="#casos-de-uso-industriales-reales" id="toc-casos-de-uso-industriales-reales" class="nav-link" data-scroll-target="#casos-de-uso-industriales-reales"><span class="header-section-number">12.5</span> Casos de Uso Industriales Reales</a>
  <ul class="collapse">
<li><a href="#sistema-de-monitoreo-iot-en-tiempo-real" id="toc-sistema-de-monitoreo-iot-en-tiempo-real" class="nav-link" data-scroll-target="#sistema-de-monitoreo-iot-en-tiempo-real"><span class="header-section-number">12.5.1</span> 1. <strong>Sistema de Monitoreo IoT en Tiempo Real</strong></a></li>
  <li><a href="#sistema-de-recomendaciones-e-commerce" id="toc-sistema-de-recomendaciones-e-commerce" class="nav-link" data-scroll-target="#sistema-de-recomendaciones-e-commerce"><span class="header-section-number">12.5.2</span> 2. <strong>Sistema de Recomendaciones E-commerce</strong></a></li>
  </ul>
</li>
  <li><a href="#ejercicio-final-aplicaci%C3%B3n-completa-de-producci%C3%B3n" id="toc-ejercicio-final-aplicación-completa-de-producción" class="nav-link" data-scroll-target="#ejercicio-final-aplicaci%C3%B3n-completa-de-producci%C3%B3n"><span class="header-section-number">12.6</span> Ejercicio Final: Aplicación Completa de Producción</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/tutorial-datatable/tutorial_data.table/issues" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./cap05-visualizacion.html"><strong>Módulo 5</strong>: Integración con el Ecosistema R</a></li><li class="breadcrumb-item"><a href="./cap05-aplicaciones.html"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Aplicaciones del Mundo Real</span></a></li></ol></nav><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-aplicaciones" class="quarto-section-identifier"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Aplicaciones del Mundo Real</span></span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Código</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
En este capítulo dominarás
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>
<strong>Aplicaciones Shiny</strong> escalables con data.table</li>
<li>
<strong>Integración con tidymodels</strong> para machine learning robusto</li>
<li>
<strong>Conexión con bases de datos</strong> y ecosistemas Big Data</li>
<li>
<strong>dtplyr</strong>: El puente entre data.table y tidyverse</li>
<li>
<strong>Casos de uso industriales</strong> reales y prácticos</li>
</ul>
</div>
</div>
<section id="aplicaciones-shiny-escalables-con-data.table" class="level2" data-number="12.1"><h2 data-number="12.1" class="anchored" data-anchor-id="aplicaciones-shiny-escalables-con-data.table">
<span class="header-section-number">12.1</span> Aplicaciones Shiny Escalables con data.table</h2>
<section id="arquitectura-de-app-shiny-profesional" class="level3" data-number="12.1.1"><h3 data-number="12.1.1" class="anchored" data-anchor-id="arquitectura-de-app-shiny-profesional">
<span class="header-section-number">12.1.1</span> 1. <strong>Arquitectura de App Shiny Profesional</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Estructura modular para apps grandes</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://shiny.posit.co/">shiny</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/shinydashboard/">shinydashboard</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/DT">DT</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://plotly-r.com">plotly</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># === MÓDULO: Data Processing ===</span></span>
<span><span class="co"># Todas las operaciones data.table en funciones separadas</span></span>
<span><span class="va">process_customer_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">clientes_dt</span>, <span class="va">filters</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Aplicar filtros dinámicamente</span></span>
<span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="va">clientes_dt</span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">filters</span><span class="op">$</span><span class="va">region</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="va">filters</span><span class="op">$</span><span class="va">region</span> <span class="op">!=</span> <span class="st">"Todos"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">result</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">[</span><span class="va">region</span> <span class="op">==</span> <span class="va">filters</span><span class="op">$</span><span class="va">region</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">filters</span><span class="op">$</span><span class="va">edad_min</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">result</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">[</span><span class="va">edad</span> <span class="op">&gt;=</span> <span class="va">filters</span><span class="op">$</span><span class="va">edad_min</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">filters</span><span class="op">$</span><span class="va">fecha_desde</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Aquí se aplicarían filtros de fecha si tuviéramos esos datos</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">calculate_customer_metrics</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">clientes_dt</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">clientes_dt</span><span class="op">[</span>,</span>
<span>    <span class="fu">.</span><span class="op">(</span></span>
<span>      total_clientes <span class="op">=</span> <span class="va">.N</span>,</span>
<span>      edad_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">edad</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>      ingresos_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">ingresos</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>      satisfaccion_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">satisfaccion</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>      churn_rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">churn_flag</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>      valor_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">valor_cliente</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>      engagement_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">engagement_score</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">region</span>, <span class="va">categoria_ingresos</span><span class="op">)</span></span>
<span>  <span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># === UI: Dashboard Layout ===</span></span>
<span><span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shinydashboard/man/dashboardPage.html">dashboardPage</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/shinydashboard/man/dashboardHeader.html">dashboardHeader</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Customer Analytics - Powered by data.table"</span><span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/shinydashboard/man/dashboardSidebar.html">dashboardSidebar</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shinydashboard/man/sidebarMenu.html">sidebarMenu</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shinydashboard/man/sidebarMenu.html">menuItem</a></span><span class="op">(</span><span class="st">"Overview"</span>, tabName <span class="op">=</span> <span class="st">"overview"</span>, icon <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/icon.html">icon</a></span><span class="op">(</span><span class="st">"dashboard"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shinydashboard/man/sidebarMenu.html">menuItem</a></span><span class="op">(</span><span class="st">"Clientes"</span>, tabName <span class="op">=</span> <span class="st">"clientes"</span>, icon <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/icon.html">icon</a></span><span class="op">(</span><span class="st">"users"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shinydashboard/man/sidebarMenu.html">menuItem</a></span><span class="op">(</span><span class="st">"Segmentación"</span>, tabName <span class="op">=</span> <span class="st">"segmentacion"</span>, icon <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/icon.html">icon</a></span><span class="op">(</span><span class="st">"chart-pie"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shinydashboard/man/sidebarMenu.html">menuItem</a></span><span class="op">(</span><span class="st">"Predicciones"</span>, tabName <span class="op">=</span> <span class="st">"predicciones"</span>, icon <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/icon.html">icon</a></span><span class="op">(</span><span class="st">"brain"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shinydashboard/man/sidebarMenu.html">menuItem</a></span><span class="op">(</span><span class="st">"Datos Raw"</span>, tabName <span class="op">=</span> <span class="st">"datos"</span>, icon <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/icon.html">icon</a></span><span class="op">(</span><span class="st">"table"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/shinydashboard/man/dashboardBody.html">dashboardBody</a></span><span class="op">(</span></span>
<span>    <span class="va">tags</span><span class="op">$</span><span class="fu">head</span><span class="op">(</span></span>
<span>      <span class="va">tags</span><span class="op">$</span><span class="fu">style</span><span class="op">(</span><span class="fu"><a href="https://rstudio.github.io/htmltools/reference/HTML.html">HTML</a></span><span class="op">(</span><span class="st">"</span></span>
<span><span class="st">        .content-wrapper, .right-side {</span></span>
<span><span class="st">          background-color: #f4f4f4;</span></span>
<span><span class="st">        }</span></span>
<span><span class="st">        .main-header .navbar {</span></span>
<span><span class="st">          background-color: #2E8B57 !important;</span></span>
<span><span class="st">        }</span></span>
<span><span class="st">      "</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shinydashboard/man/tabItems.html">tabItems</a></span><span class="op">(</span></span>
<span>      <span class="co"># Tab Overview</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shinydashboard/man/tabItem.html">tabItem</a></span><span class="op">(</span>tabName <span class="op">=</span> <span class="st">"overview"</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidRow</a></span><span class="op">(</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/pkg/shinydashboard/man/valueBoxOutput.html">valueBoxOutput</a></span><span class="op">(</span><span class="st">"total_clientes"</span><span class="op">)</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/pkg/shinydashboard/man/valueBoxOutput.html">valueBoxOutput</a></span><span class="op">(</span><span class="st">"churn_rate"</span><span class="op">)</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/pkg/shinydashboard/man/valueBoxOutput.html">valueBoxOutput</a></span><span class="op">(</span><span class="st">"valor_promedio"</span><span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidRow</a></span><span class="op">(</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/pkg/shinydashboard/man/box.html">box</a></span><span class="op">(</span></span>
<span>            title <span class="op">=</span> <span class="st">"Filtros Globales"</span>, status <span class="op">=</span> <span class="st">"primary"</span>, solidHeader <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>            width <span class="op">=</span> <span class="fl">3</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/selectInput.html">selectInput</a></span><span class="op">(</span><span class="st">"region_filter"</span>, <span class="st">"Región:"</span>,</span>
<span>                       choices <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Todos"</span>, <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">datos_clientes</span><span class="op">$</span><span class="va">region</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                       selected <span class="op">=</span> <span class="st">"Todos"</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/sliderInput.html">sliderInput</a></span><span class="op">(</span><span class="st">"edad_range"</span>, <span class="st">"Rango de Edad:"</span>,</span>
<span>                       min <span class="op">=</span> <span class="fl">18</span>, max <span class="op">=</span> <span class="fl">80</span>, value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">18</span>, <span class="fl">80</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/actionButton.html">actionButton</a></span><span class="op">(</span><span class="st">"aplicar_filtros"</span>, <span class="st">"Aplicar Filtros"</span>, </span>
<span>                        class <span class="op">=</span> <span class="st">"btn-primary"</span><span class="op">)</span></span>
<span>          <span class="op">)</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/pkg/shinydashboard/man/box.html">box</a></span><span class="op">(</span></span>
<span>            title <span class="op">=</span> <span class="st">"Revenue por Región"</span>, status <span class="op">=</span> <span class="st">"success"</span>, solidHeader <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>            width <span class="op">=</span> <span class="fl">9</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/pkg/plotly/man/plotly-shiny.html">plotlyOutput</a></span><span class="op">(</span><span class="st">"revenue_plot"</span>, height <span class="op">=</span> <span class="st">"400px"</span><span class="op">)</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      </span>
<span>      <span class="co"># Tab Clientes</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shinydashboard/man/tabItem.html">tabItem</a></span><span class="op">(</span>tabName <span class="op">=</span> <span class="st">"clientes"</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidRow</a></span><span class="op">(</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/pkg/shinydashboard/man/box.html">box</a></span><span class="op">(</span></span>
<span>            title <span class="op">=</span> <span class="st">"Análisis de Clientes"</span>, status <span class="op">=</span> <span class="st">"primary"</span>, solidHeader <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>            width <span class="op">=</span> <span class="fl">12</span>,</span>
<span>            <span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/dataTableOutput.html">dataTableOutput</a></span><span class="op">(</span><span class="st">"clientes_table"</span><span class="op">)</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      </span>
<span>      <span class="co"># Tab Segmentación</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shinydashboard/man/tabItem.html">tabItem</a></span><span class="op">(</span>tabName <span class="op">=</span> <span class="st">"segmentacion"</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidRow</a></span><span class="op">(</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/pkg/shinydashboard/man/box.html">box</a></span><span class="op">(</span></span>
<span>            title <span class="op">=</span> <span class="st">"Segmentación por Valor"</span>, status <span class="op">=</span> <span class="st">"warning"</span>, solidHeader <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>            width <span class="op">=</span> <span class="fl">6</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/plotOutput.html">plotOutput</a></span><span class="op">(</span><span class="st">"segmentacion_plot"</span><span class="op">)</span></span>
<span>          <span class="op">)</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/pkg/shinydashboard/man/box.html">box</a></span><span class="op">(</span></span>
<span>            title <span class="op">=</span> <span class="st">"Matriz de Retención"</span>, status <span class="op">=</span> <span class="st">"info"</span>, solidHeader <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>            width <span class="op">=</span> <span class="fl">6</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/plotOutput.html">plotOutput</a></span><span class="op">(</span><span class="st">"matriz_retencion"</span><span class="op">)</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># === SERVER: Lógica Reactiva ===</span></span>
<span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Datos reactivos - aquí brilla data.table</span></span>
<span>  <span class="va">datos_filtrados</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">input</span><span class="op">$</span><span class="va">aplicar_filtros</span>  <span class="co"># Dependencia del botón</span></span>
<span>    </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/isolate.html">isolate</a></span><span class="op">(</span><span class="op">{</span></span>
<span>      <span class="va">filtros</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>        region <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">region_filter</span>,</span>
<span>        edad_min <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">edad_range</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>        edad_max <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">edad_range</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>      <span class="op">)</span></span>
<span>      </span>
<span>      <span class="va">result</span> <span class="op">&lt;-</span> <span class="va">datos_clientes</span><span class="op">[</span></span>
<span>        <span class="va">edad</span> <span class="op">&gt;=</span> <span class="va">filtros</span><span class="op">$</span><span class="va">edad_min</span> <span class="op">&amp;</span> <span class="va">edad</span> <span class="op">&lt;=</span> <span class="va">filtros</span><span class="op">$</span><span class="va">edad_max</span></span>
<span>      <span class="op">]</span></span>
<span>      </span>
<span>      <span class="kw">if</span><span class="op">(</span><span class="va">filtros</span><span class="op">$</span><span class="va">region</span> <span class="op">!=</span> <span class="st">"Todos"</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">result</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">[</span><span class="va">region</span> <span class="op">==</span> <span class="va">filtros</span><span class="op">$</span><span class="va">region</span><span class="op">]</span></span>
<span>      <span class="op">}</span></span>
<span>      </span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># ValueBoxes</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">total_clientes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shinydashboard/man/renderValueBox.html">renderValueBox</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shinydashboard/man/valueBox.html">valueBox</a></span><span class="op">(</span></span>
<span>      value <span class="op">=</span> <span class="fu">comma</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="fu">datos_filtrados</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      subtitle <span class="op">=</span> <span class="st">"Total Clientes"</span>,</span>
<span>      icon <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/icon.html">icon</a></span><span class="op">(</span><span class="st">"users"</span><span class="op">)</span>,</span>
<span>      color <span class="op">=</span> <span class="st">"blue"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">churn_rate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shinydashboard/man/renderValueBox.html">renderValueBox</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">rate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu">datos_filtrados</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">churn_flag</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shinydashboard/man/valueBox.html">valueBox</a></span><span class="op">(</span></span>
<span>      value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">rate</span>, <span class="st">"%"</span><span class="op">)</span>,</span>
<span>      subtitle <span class="op">=</span> <span class="st">"Tasa de Churn"</span>,</span>
<span>      icon <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/icon.html">icon</a></span><span class="op">(</span><span class="st">"exclamation-triangle"</span><span class="op">)</span>,</span>
<span>      color <span class="op">=</span> <span class="kw">if</span><span class="op">(</span><span class="va">rate</span> <span class="op">&gt;</span> <span class="fl">15</span><span class="op">)</span> <span class="st">"red"</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">rate</span> <span class="op">&gt;</span> <span class="fl">10</span><span class="op">)</span> <span class="st">"yellow"</span> <span class="kw">else</span> <span class="st">"green"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">valor_promedio</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shinydashboard/man/renderValueBox.html">renderValueBox</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">valor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu">datos_filtrados</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">valor_cliente</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shinydashboard/man/valueBox.html">valueBox</a></span><span class="op">(</span></span>
<span>      value <span class="op">=</span> <span class="fu">dollar</span><span class="op">(</span><span class="va">valor</span><span class="op">)</span>,</span>
<span>      subtitle <span class="op">=</span> <span class="st">"Valor Promedio"</span>,</span>
<span>      icon <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/icon.html">icon</a></span><span class="op">(</span><span class="st">"dollar-sign"</span><span class="op">)</span>,</span>
<span>      color <span class="op">=</span> <span class="st">"green"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Gráfico principal</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">revenue_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/plotly/man/plotly-shiny.html">renderPlotly</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="co"># Cálculo super rápido con data.table</span></span>
<span>    <span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="fu">datos_filtrados</span><span class="op">(</span><span class="op">)</span><span class="op">[</span>,</span>
<span>      <span class="fu">.</span><span class="op">(</span></span>
<span>        valor_total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">valor_cliente</span><span class="op">)</span>,</span>
<span>        clientes <span class="op">=</span> <span class="va">.N</span>,</span>
<span>        satisfaccion_avg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">satisfaccion</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      by <span class="op">=</span> <span class="va">region</span></span>
<span>    <span class="op">]</span></span>
<span>    </span>
<span>    <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">plot_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html">reorder</a></span><span class="op">(</span><span class="va">region</span>, <span class="va">valor_total</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">valor_total</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">satisfaccion_avg</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="fu">dollar</span><span class="op">(</span><span class="va">valor_total</span>, scale <span class="op">=</span> <span class="fl">1e-3</span>, suffix <span class="op">=</span> <span class="st">"K"</span><span class="op">)</span><span class="op">)</span>, </span>
<span>               hjust <span class="op">=</span> <span class="op">-</span><span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_fill_viridis_c</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Satisfacción\nPromedio"</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Valor Total por Región"</span>, x <span class="op">=</span> <span class="st">"Región"</span>, y <span class="op">=</span> <span class="st">"Valor Total"</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/plotly/man/ggplotly.html">ggplotly</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Tabla de clientes</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">clientes_table</span> <span class="op">&lt;-</span> <span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/dataTableOutput.html">renderDataTable</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">tabla_data</span> <span class="op">&lt;-</span> <span class="fu">datos_filtrados</span><span class="op">(</span><span class="op">)</span><span class="op">[</span>,</span>
<span>      <span class="fu">.</span><span class="op">(</span></span>
<span>        <span class="va">cliente_id</span>, <span class="va">edad</span>, <span class="va">region</span>, </span>
<span>        ingresos <span class="op">=</span> <span class="fu">dollar</span><span class="op">(</span><span class="va">ingresos</span><span class="op">)</span>,</span>
<span>        valor_cliente <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">valor_cliente</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>        <span class="va">satisfaccion</span>,</span>
<span>        engagement_score <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">engagement_score</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>        riesgo_churn <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">riesgo_churn</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">"Alto"</span>, <span class="st">"Bajo"</span><span class="op">)</span>,</span>
<span>        es_vip <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">cliente_vip</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">"Sí"</span>, <span class="st">"No"</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">]</span></span>
<span>    </span>
<span>    <span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/datatable.html">datatable</a></span><span class="op">(</span></span>
<span>      <span class="va">tabla_data</span>,</span>
<span>      options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>pageLength <span class="op">=</span> <span class="fl">25</span>, scrollX <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>      rownames <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/formatCurrency.html">formatStyle</a></span><span class="op">(</span></span>
<span>        <span class="st">"riesgo_churn"</span>,</span>
<span>        backgroundColor <span class="op">=</span> <span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/styleInterval.html">styleEqual</a></span><span class="op">(</span><span class="st">"Alto"</span>, <span class="st">"#ffebee"</span><span class="op">)</span></span>
<span>      <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/formatCurrency.html">formatStyle</a></span><span class="op">(</span></span>
<span>        <span class="st">"es_vip"</span>,</span>
<span>        backgroundColor <span class="op">=</span> <span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/styleInterval.html">styleEqual</a></span><span class="op">(</span><span class="st">"Sí"</span>, <span class="st">"#e8f5e8"</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Lanzar la app</span></span>
<span><span class="co"># shinyApp(ui = ui, server = server)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="optimización-de-performance-en-shiny" class="level3" data-number="12.1.2"><h3 data-number="12.1.2" class="anchored" data-anchor-id="optimización-de-performance-en-shiny">
<span class="header-section-number">12.1.2</span> 2. <strong>Optimización de Performance en Shiny</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># === TÉCNICAS DE OPTIMIZACIÓN ===</span></span>
<span></span>
<span><span class="co"># 1. Pre-procesar datos pesados al inicio</span></span>
<span><span class="va">onSessionStart</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Cálculos que no cambian frecuentemente</span></span>
<span>  <span class="va">session</span><span class="op">$</span><span class="va">userData</span><span class="op">$</span><span class="va">metricas_estaticas</span> <span class="op">&lt;-</span> <span class="va">datos_clientes</span><span class="op">[</span>,</span>
<span>    <span class="fu">.</span><span class="op">(</span></span>
<span>      clientes_por_region <span class="op">=</span> <span class="va">.N</span>,</span>
<span>      valor_total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">valor_cliente</span><span class="op">)</span>,</span>
<span>      edad_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">edad</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="va">region</span></span>
<span>  <span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Índices para búsquedas rápidas</span></span>
<span>  <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setkey.html">setkey</a></span><span class="op">(</span><span class="va">session</span><span class="op">$</span><span class="va">userData</span><span class="op">$</span><span class="va">clientes_dt</span>, <span class="va">cliente_id</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setkey.html">setindex</a></span><span class="op">(</span><span class="va">session</span><span class="op">$</span><span class="va">userData</span><span class="op">$</span><span class="va">clientes_dt</span>, <span class="va">region</span>, <span class="va">categoria_ingresos</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># 2. Usar reactive values para cache inteligente</span></span>
<span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Cache de cálculos costosos</span></span>
<span>  <span class="va">cache_metricas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactiveValues.html">reactiveValues</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Solo recalcular cuando cambien inputs relevantes</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observe.html">observe</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">key</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">region_filter</span>, <span class="va">input</span><span class="op">$</span><span class="va">edad_range</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">input</span><span class="op">$</span><span class="va">edad_range</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">cache_metricas</span><span class="op">[[</span><span class="va">key</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">cache_metricas</span><span class="op">[[</span><span class="va">key</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">calculate_customer_metrics</span><span class="op">(</span></span>
<span>        <span class="va">datos_clientes</span><span class="op">[</span></span>
<span>          <span class="va">region</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">input</span><span class="op">$</span><span class="va">region_filter</span> <span class="op">&amp;</span> </span>
<span>          <span class="va">edad</span> <span class="op"><a href="https://rdatatable.gitlab.io/data.table/reference/between.html">%between%</a></span> <span class="va">input</span><span class="op">$</span><span class="va">edad_range</span></span>
<span>        <span class="op">]</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># 3. Renderizado condicional</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">tabla_grande</span> <span class="op">&lt;-</span> <span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/dataTableOutput.html">renderDataTable</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="co"># Solo renderizar si la pestaña está visible</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/req.html">req</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">tabs</span> <span class="op">==</span> <span class="st">"datos_detallados"</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># data.table operation ultrarrápida</span></span>
<span>    <span class="va">datos_tabla</span> <span class="op">&lt;-</span> <span class="fu">datos_filtrados</span><span class="op">(</span><span class="op">)</span><span class="op">[</span>,</span>
<span>      <span class="fu">.</span><span class="op">(</span><span class="va">cliente_id</span>, <span class="va">region</span>, <span class="va">valor_cliente</span>, <span class="va">churn_flag</span><span class="op">)</span></span>
<span>    <span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">valor_cliente</span><span class="op">)</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/datatable.html">datatable</a></span><span class="op">(</span><span class="va">datos_tabla</span>, options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>pageLength <span class="op">=</span> <span class="fl">50</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># 4. Módulos para escalabilidad</span></span>
<span><span class="va">customerMetricsUI</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">ns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/NS.html">NS</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/tagList.html">tagList</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shinydashboard/man/valueBoxOutput.html">valueBoxOutput</a></span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"total_value"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/plotOutput.html">plotOutput</a></span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"distribution_plot"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">customerMetricsServer</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">id</span>, <span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/moduleServer.html">moduleServer</a></span><span class="op">(</span><span class="va">id</span>, <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">output</span><span class="op">$</span><span class="va">total_value</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shinydashboard/man/renderValueBox.html">renderValueBox</a></span><span class="op">(</span><span class="op">{</span></span>
<span>      <span class="co"># Cálculo modular con data.table</span></span>
<span>      <span class="va">total</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">valor_cliente</span><span class="op">)</span><span class="op">]</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shinydashboard/man/valueBox.html">valueBox</a></span><span class="op">(</span></span>
<span>        value <span class="op">=</span> <span class="fu">dollar</span><span class="op">(</span><span class="va">total</span>, scale <span class="op">=</span> <span class="fl">1e-6</span>, suffix <span class="op">=</span> <span class="st">"M"</span><span class="op">)</span>,</span>
<span>        subtitle <span class="op">=</span> <span class="st">"Valor Total"</span>,</span>
<span>        icon <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/icon.html">icon</a></span><span class="op">(</span><span class="st">"chart-line"</span><span class="op">)</span>,</span>
<span>        color <span class="op">=</span> <span class="st">"green"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="integración-con-tidymodels-machine-learning-robusto" class="level2" data-number="12.2"><h2 data-number="12.2" class="anchored" data-anchor-id="integración-con-tidymodels-machine-learning-robusto">
<span class="header-section-number">12.2</span> Integración con tidymodels: Machine Learning Robusto</h2>
<section id="workflow-completo-data.table-tidymodels-data.table" class="level3" data-number="12.2.1"><h3 data-number="12.2.1" class="anchored" data-anchor-id="workflow-completo-data.table-tidymodels-data.table">
<span class="header-section-number">12.2.1</span> 1. <strong>Workflow Completo: data.table → tidymodels → data.table</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># PASO 1: Feature Engineering con data.table (ultrarrápido)</span></span>
<span><span class="va">preparar_datos_ml</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">clientes_dt</span>, <span class="va">transacciones_dt</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Calcular métricas de transacciones por cliente</span></span>
<span>  <span class="va">metricas_transaccionales</span> <span class="op">&lt;-</span> <span class="va">transacciones_dt</span><span class="op">[</span>, <span class="va">monto_final</span> <span class="op">:=</span> <span class="va">monto</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">descuento_aplicado</span><span class="op">)</span><span class="op">]</span><span class="op">[</span></span>
<span>    <span class="va">fecha_transaccion</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">365</span>,  <span class="co"># Último año</span></span>
<span>    <span class="fu">.</span><span class="op">(</span></span>
<span>      transacciones_año <span class="op">=</span> <span class="va">.N</span>,</span>
<span>      monto_total_año <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">monto_final</span><span class="op">)</span>,</span>
<span>      monto_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">monto_final</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>      categorias_compradas <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/duplicated.html">uniqueN</a></span><span class="op">(</span><span class="va">producto_categoria</span><span class="op">)</span>,</span>
<span>      canal_principal <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">canal</span><span class="op">)</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>      frecuencia_compra_dias <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">fecha_transaccion</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">fecha_transaccion</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="va">.N</span>,</span>
<span>      usa_descuentos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">descuento_aplicado</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>      tasa_devolucion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">es_devolucion</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="va">cliente_id</span></span>
<span>  <span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Unir con datos de clientes</span></span>
<span>  <span class="va">datos_completos</span> <span class="op">&lt;-</span> <span class="va">clientes_dt</span><span class="op">[</span><span class="va">metricas_transaccionales</span>, on <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">cliente_id</span><span class="op">)</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Feature engineering adicional</span></span>
<span>  <span class="va">datos_completos</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span></span>
<span>    <span class="co"># Variables de interacción</span></span>
<span>    ingresos_edad_ratio <span class="op">=</span> <span class="va">ingresos</span> <span class="op">/</span> <span class="va">edad</span>,</span>
<span>    valor_por_producto <span class="op">=</span> <span class="va">valor_cliente</span> <span class="op">/</span> <span class="va">num_productos</span>,</span>
<span>    engagement_per_month <span class="op">=</span> <span class="va">engagement_score</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">antiguedad_meses</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    </span>
<span>    <span class="co"># Variables categóricas optimizadas</span></span>
<span>    segmento_valor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span><span class="va">valor_cliente</span>, </span>
<span>                        breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">valor_cliente</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="fl">1</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                        labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Bajo"</span>, <span class="st">"Medio-Bajo"</span>, <span class="st">"Medio-Alto"</span>, <span class="st">"Alto"</span><span class="op">)</span>,</span>
<span>                        include.lowest <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    </span>
<span>    <span class="co"># Variables binarias</span></span>
<span>    cliente_frecuente <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">transacciones_año</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">transacciones_año</span>, <span class="fl">0.75</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    multicanal <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">categorias_compradas</span> <span class="op">&gt;=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>    </span>
<span>    <span class="co"># Target variable limpia</span></span>
<span>    churn <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">churn_flag</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">"Si"</span>, <span class="st">"No"</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"No"</span>, <span class="st">"Si"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Remover casos con NAs en variables críticas</span></span>
<span>  <span class="va">datos_limpios</span> <span class="op">&lt;-</span> <span class="va">datos_completos</span><span class="op">[</span></span>
<span>    <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">transacciones_año</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>    <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">monto_total_año</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>    <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">churn</span><span class="op">)</span></span>
<span>  <span class="op">]</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">datos_limpios</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Ejecutar preparación</span></span>
<span><span class="va">datos_ml</span> <span class="op">&lt;-</span> <span class="fu">preparar_datos_ml</span><span class="op">(</span><span class="va">datos_clientes</span>, <span class="va">transacciones_detalle</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Datos preparados para ML:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Datos preparados para ML:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"- Filas:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">datos_ml</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; - Filas: 5938</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"- Columnas:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">datos_ml</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; - Columnas: 33</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"- Distribución de churn:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; - Distribución de churn:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">datos_ml</span><span class="op">[</span>, <span class="va">.N</span>, by <span class="op">=</span> <span class="va">churn</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;     churn     N</span></span>
<span><span class="co">#&gt;    &lt;fctr&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1:     Si   707</span></span>
<span><span class="co">#&gt; 2:     No  5231</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="modelado-con-tidymodels-ejemplo-conceptual" class="level3" data-number="12.2.2"><h3 data-number="12.2.2" class="anchored" data-anchor-id="modelado-con-tidymodels-ejemplo-conceptual">
<span class="header-section-number">12.2.2</span> 2. <strong>Modelado con tidymodels (Ejemplo Conceptual)</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Ejemplo de workflow completo con tidymodels</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidymodels.tidymodels.org">tidymodels</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/themis">themis</a></span><span class="op">)</span>  <span class="co"># Para balanceo de clases</span></span>
<span></span>
<span><span class="co"># PASO 2: Convertir a tibble para tidymodels</span></span>
<span><span class="va">datos_tibble</span> <span class="op">&lt;-</span> <span class="fu">as_tibble</span><span class="op">(</span><span class="va">datos_ml</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># PASO 3: Split de datos</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">data_split</span> <span class="op">&lt;-</span> <span class="fu">initial_split</span><span class="op">(</span></span>
<span>  <span class="va">datos_tibble</span>, </span>
<span>  prop <span class="op">=</span> <span class="fl">0.8</span>, </span>
<span>  strata <span class="op">=</span> <span class="va">churn</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">train_data</span> <span class="op">&lt;-</span> <span class="fu">training</span><span class="op">(</span><span class="va">data_split</span><span class="op">)</span></span>
<span><span class="va">test_data</span> <span class="op">&lt;-</span> <span class="fu">testing</span><span class="op">(</span><span class="va">data_split</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># PASO 4: Receta de preprocesamiento</span></span>
<span><span class="va">receta_churn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html">recipe</a></span><span class="op">(</span><span class="va">churn</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">train_data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Remover variables no predictivas</span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_rm.html">step_rm</a></span><span class="op">(</span><span class="va">cliente_id</span>, <span class="va">churn_flag</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  </span>
<span>  <span class="co"># Imputación de NAs</span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_impute_median.html">step_impute_median</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_numeric_predictors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_impute_mode.html">step_impute_mode</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_nominal_predictors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  </span>
<span>  <span class="co"># Feature engineering</span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_log.html">step_log</a></span><span class="op">(</span><span class="va">ingresos</span>, <span class="va">valor_cliente</span>, offset <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_normalize.html">step_normalize</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_numeric_predictors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  </span>
<span>  <span class="co"># Variables dummy</span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_dummy.html">step_dummy</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_nominal_predictors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  </span>
<span>  <span class="co"># Balanceo de clases</span></span>
<span>  <span class="fu"><a href="https://themis.tidymodels.org/reference/step_downsample.html">step_downsample</a></span><span class="op">(</span><span class="va">churn</span>, under_ratio <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  </span>
<span>  <span class="co"># Remover variables con varianza cero</span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_zv.html">step_zv</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_predictors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  </span>
<span>  <span class="co"># Correlación alta</span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_corr.html">step_corr</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_numeric_predictors</a></span><span class="op">(</span><span class="op">)</span>, threshold <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># PASO 5: Modelos</span></span>
<span><span class="va">modelo_rf</span> <span class="op">&lt;-</span> <span class="fu">rand_forest</span><span class="op">(</span></span>
<span>  trees <span class="op">=</span> <span class="fu">tune</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  mtry <span class="op">=</span> <span class="fu">tune</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  min_n <span class="op">=</span> <span class="fu">tune</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">set_mode</span><span class="op">(</span><span class="st">"classification"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">set_engine</span><span class="op">(</span><span class="st">"randomForest"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">modelo_xgb</span> <span class="op">&lt;-</span> <span class="fu">boost_tree</span><span class="op">(</span></span>
<span>  trees <span class="op">=</span> <span class="fu">tune</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  tree_depth <span class="op">=</span> <span class="fu">tune</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  learn_rate <span class="op">=</span> <span class="fu">tune</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  min_n <span class="op">=</span> <span class="fu">tune</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">set_mode</span><span class="op">(</span><span class="st">"classification"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">set_engine</span><span class="op">(</span><span class="st">"xgboost"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># PASO 6: Workflows</span></span>
<span><span class="va">workflow_rf</span> <span class="op">&lt;-</span> <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">add_recipe</span><span class="op">(</span><span class="va">receta_churn</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">modelo_rf</span><span class="op">)</span></span>
<span></span>
<span><span class="va">workflow_xgb</span> <span class="op">&lt;-</span> <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">add_recipe</span><span class="op">(</span><span class="va">receta_churn</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">modelo_xgb</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># PASO 7: Cross-validation y tuning</span></span>
<span><span class="va">cv_folds</span> <span class="op">&lt;-</span> <span class="fu">vfold_cv</span><span class="op">(</span><span class="va">train_data</span>, v <span class="op">=</span> <span class="fl">5</span>, strata <span class="op">=</span> <span class="va">churn</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Tuning Random Forest</span></span>
<span><span class="va">tune_rf</span> <span class="op">&lt;-</span> <span class="va">workflow_rf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">tune_grid</span><span class="op">(</span></span>
<span>    resamples <span class="op">=</span> <span class="va">cv_folds</span>,</span>
<span>    grid <span class="op">=</span> <span class="fl">20</span>,</span>
<span>    metrics <span class="op">=</span> <span class="fu">metric_set</span><span class="op">(</span><span class="va">roc_auc</span>, <span class="va">precision</span>, <span class="va">recall</span>, <span class="va">f_meas</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># PASO 8: Mejor modelo</span></span>
<span><span class="va">best_rf</span> <span class="op">&lt;-</span> <span class="fu">select_best</span><span class="op">(</span><span class="va">tune_rf</span>, metric <span class="op">=</span> <span class="st">"roc_auc"</span><span class="op">)</span></span>
<span><span class="va">final_workflow_rf</span> <span class="op">&lt;-</span> <span class="fu">finalize_workflow</span><span class="op">(</span><span class="va">workflow_rf</span>, <span class="va">best_rf</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># PASO 9: Fit final y predicciones</span></span>
<span><span class="va">modelo_final</span> <span class="op">&lt;-</span> <span class="fu">fit</span><span class="op">(</span><span class="va">final_workflow_rf</span>, <span class="va">train_data</span><span class="op">)</span></span>
<span><span class="va">predicciones</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">modelo_final</span>, <span class="va">test_data</span>, type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Métricas de evaluación</span></span>
<span><span class="va">metricas_modelo</span> <span class="op">&lt;-</span> <span class="va">test_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">predicciones</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pred <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fifelse.html">fifelse</a></span><span class="op">(</span><span class="va">.pred_Si</span> <span class="op">&gt;=</span> <span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"No"</span>, <span class="st">"Si"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">metrics</span><span class="op">(</span>truth <span class="op">=</span> <span class="va">churn</span>, <span class="va">pred</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">metricas_modelo</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="post-procesamiento-y-análisis-con-data.table" class="level3" data-number="12.2.3"><h3 data-number="12.2.3" class="anchored" data-anchor-id="post-procesamiento-y-análisis-con-data.table">
<span class="header-section-number">12.2.3</span> 3. <strong>Post-procesamiento y Análisis con data.table</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Simular predicciones para el ejemplo (en producción vendrían del modelo)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">789</span><span class="op">)</span></span>
<span><span class="va">predicciones_simuladas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span></span>
<span>  cliente_id <span class="op">=</span> <span class="va">datos_ml</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">.N</span>, <span class="fl">2000</span><span class="op">)</span>, <span class="va">cliente_id</span><span class="op">]</span>,</span>
<span>  prob_churn <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">2000</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  pred_churn <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Si"</span>, <span class="st">"No"</span><span class="op">)</span>, <span class="fl">2000</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.15</span>, <span class="fl">0.85</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  confidence_score <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">2000</span>, <span class="fl">0.6</span>, <span class="fl">0.95</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ANÁLISIS DE RESULTADOS con data.table</span></span>
<span><span class="co"># Unir predicciones con datos originales</span></span>
<span><span class="va">resultados_ml</span> <span class="op">&lt;-</span> <span class="va">datos_ml</span><span class="op">[</span><span class="va">predicciones_simuladas</span>, on <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">cliente_id</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Análisis de segmentos de riesgo</span></span>
<span><span class="va">analisis_riesgo</span> <span class="op">&lt;-</span> <span class="va">resultados_ml</span><span class="op">[</span>,</span>
<span>  <span class="fu">.</span><span class="op">(</span></span>
<span>    clientes_total <span class="op">=</span> <span class="va">.N</span>,</span>
<span>    churn_predicho <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">pred_churn</span> <span class="op">==</span> <span class="st">"Si"</span><span class="op">)</span>,</span>
<span>    prob_churn_media <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">prob_churn</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>    valor_en_riesgo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">valor_cliente</span><span class="op">[</span><span class="va">pred_churn</span> <span class="op">==</span> <span class="st">"Si"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    revenue_en_riesgo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">monto_total_año</span><span class="op">[</span><span class="va">pred_churn</span> <span class="op">==</span> <span class="st">"Si"</span><span class="op">]</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    ingresos_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">ingresos</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>    engagement_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">engagement_score</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">region</span>, <span class="va">categoria_ingresos</span><span class="op">)</span></span>
<span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">valor_en_riesgo</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"=== ANÁLISIS DE RIESGO DE CHURN POR SEGMENTO ===\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; === ANÁLISIS DE RIESGO DE CHURN POR SEGMENTO ===</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">analisis_riesgo</span><span class="op">)</span></span>
<span><span class="co">#&gt;     region categoria_ingresos clientes_total churn_predicho prob_churn_media</span></span>
<span><span class="co">#&gt;     &lt;char&gt;             &lt;fctr&gt;          &lt;int&gt;          &lt;int&gt;            &lt;num&gt;</span></span>
<span><span class="co">#&gt;  1: Centro               Alto            115             27            0.496</span></span>
<span><span class="co">#&gt;  2:  Norte               Alto            149             22            0.474</span></span>
<span><span class="co">#&gt;  3:   Este               Alto            149             26            0.476</span></span>
<span><span class="co">#&gt;  4:    Sur               Alto            136             15            0.472</span></span>
<span><span class="co">#&gt;  5: Centro              Medio            132             23            0.480</span></span>
<span><span class="co">#&gt; ---                                                                         </span></span>
<span><span class="co">#&gt; 11:  Oeste              Medio            123             20            0.477</span></span>
<span><span class="co">#&gt; 12: Centro               Bajo            141             19            0.477</span></span>
<span><span class="co">#&gt; 13:    Sur               Bajo            118             25            0.501</span></span>
<span><span class="co">#&gt; 14:   Este               Bajo            142             17            0.531</span></span>
<span><span class="co">#&gt; 15:  Oeste               Bajo            133             22            0.523</span></span>
<span><span class="co">#&gt;     valor_en_riesgo revenue_en_riesgo ingresos_promedio engagement_promedio</span></span>
<span><span class="co">#&gt;               &lt;num&gt;             &lt;num&gt;             &lt;num&gt;               &lt;num&gt;</span></span>
<span><span class="co">#&gt;  1:       3971.9904          4357.158            101231                7.74</span></span>
<span><span class="co">#&gt;  2:       3448.6127          3115.558            101081                7.56</span></span>
<span><span class="co">#&gt;  3:       2752.8342          2759.645            103060                7.62</span></span>
<span><span class="co">#&gt;  4:       1918.1725          1584.725             93285                7.55</span></span>
<span><span class="co">#&gt;  5:       1900.4059          2514.022             48193                7.54</span></span>
<span><span class="co">#&gt; ---                                                                        </span></span>
<span><span class="co">#&gt; 11:       1159.6149          2632.164             49278                7.63</span></span>
<span><span class="co">#&gt; 12:        912.9440          3273.967             27460                7.72</span></span>
<span><span class="co">#&gt; 13:        879.7883          3768.650             26754                7.62</span></span>
<span><span class="co">#&gt; 14:        812.1611          1624.176             27489                7.43</span></span>
<span><span class="co">#&gt; 15:        794.0182          2108.543             27076                7.72</span></span>
<span></span>
<span><span class="co"># Identificar clientes de alta prioridad para retención</span></span>
<span><span class="va">clientes_retencion</span> <span class="op">&lt;-</span> <span class="va">resultados_ml</span><span class="op">[</span></span>
<span>  <span class="va">pred_churn</span> <span class="op">==</span> <span class="st">"Si"</span> <span class="op">&amp;</span> </span>
<span>  <span class="va">prob_churn</span> <span class="op">&gt;</span> <span class="fl">0.7</span> <span class="op">&amp;</span> </span>
<span>  <span class="va">valor_cliente</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">resultados_ml</span><span class="op">$</span><span class="va">valor_cliente</span>, <span class="fl">0.7</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="fu">.</span><span class="op">(</span></span>
<span>    <span class="va">cliente_id</span>, <span class="va">region</span>, <span class="va">edad</span>, <span class="va">ingresos</span>, <span class="va">valor_cliente</span>,</span>
<span>    prob_churn <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">prob_churn</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>    <span class="va">transacciones_año</span>, <span class="va">monto_total_año</span>,</span>
<span>    <span class="va">satisfaccion</span>, <span class="va">engagement_score</span>,</span>
<span>    accion_recomendada <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fcase.html">fcase</a></span><span class="op">(</span></span>
<span>      <span class="va">satisfaccion</span> <span class="op">&lt;</span> <span class="fl">3</span>, <span class="st">"Mejora_Servicio"</span>,</span>
<span>      <span class="va">engagement_score</span> <span class="op">&lt;</span> <span class="fl">5</span>, <span class="st">"Aumentar_Engagement"</span>, </span>
<span>      <span class="va">monto_total_año</span> <span class="op">&lt;</span> <span class="fl">1000</span>, <span class="st">"Incentivo_Compra"</span>,</span>
<span>      default <span class="op">=</span> <span class="st">"Programa_Lealtad"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">valor_cliente</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\n=== TOP 10 CLIENTES PARA RETENCIÓN INMEDIATA ===\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; === TOP 10 CLIENTES PARA RETENCIÓN INMEDIATA ===</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">clientes_retencion</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;     cliente_id region  edad ingresos valor_cliente prob_churn transacciones_año</span></span>
<span><span class="co">#&gt;          &lt;int&gt; &lt;char&gt; &lt;num&gt;    &lt;num&gt;         &lt;num&gt;      &lt;num&gt;             &lt;int&gt;</span></span>
<span><span class="co">#&gt;  1:         69 Centro    49   312277      761.9559      0.899                 1</span></span>
<span><span class="co">#&gt;  2:       9176 Centro    22    70610      406.0075      0.888                 2</span></span>
<span><span class="co">#&gt;  3:       6866    Sur    49    61726      274.0634      0.967                 1</span></span>
<span><span class="co">#&gt;  4:       3461    Sur    23   138172      269.4354      0.998                 2</span></span>
<span><span class="co">#&gt;  5:       8123  Oeste    49   140832      266.1725      0.705                 1</span></span>
<span><span class="co">#&gt;  6:       3497  Norte    39   102743      240.4186      0.849                 1</span></span>
<span><span class="co">#&gt;  7:       2847   Este    41    82017      216.5249      0.890                 2</span></span>
<span><span class="co">#&gt;  8:       2896   Este    21    83534      197.9756      0.836                 2</span></span>
<span><span class="co">#&gt;  9:       4247  Oeste    35    68037      175.5355      0.709                 1</span></span>
<span><span class="co">#&gt; 10:       9463  Norte    20    46169      164.3616      0.843                 2</span></span>
<span><span class="co">#&gt;     monto_total_año satisfaccion engagement_score accion_recomendada</span></span>
<span><span class="co">#&gt;               &lt;num&gt;        &lt;num&gt;            &lt;num&gt;             &lt;char&gt;</span></span>
<span><span class="co">#&gt;  1:        11.56000          3.1             10.0   Incentivo_Compra</span></span>
<span><span class="co">#&gt;  2:       292.31936          3.5             10.0   Incentivo_Compra</span></span>
<span><span class="co">#&gt;  3:        55.99000          3.1             10.0   Incentivo_Compra</span></span>
<span><span class="co">#&gt;  4:       190.29448          4.3              9.3   Incentivo_Compra</span></span>
<span><span class="co">#&gt;  5:        42.78000          1.0              8.0    Mejora_Servicio</span></span>
<span><span class="co">#&gt;  6:       103.06000          2.4              6.8    Mejora_Servicio</span></span>
<span><span class="co">#&gt;  7:       169.53063          3.1             10.0   Incentivo_Compra</span></span>
<span><span class="co">#&gt;  8:        73.40943          4.7             10.0   Incentivo_Compra</span></span>
<span><span class="co">#&gt;  9:        49.41055          2.5              4.5    Mejora_Servicio</span></span>
<span><span class="co">#&gt; 10:       148.34431          2.3             10.0    Mejora_Servicio</span></span>
<span></span>
<span><span class="co"># Análisis de efectividad del modelo por segmento</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">resultados_ml</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">churn_flag</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">efectividad_modelo</span> <span class="op">&lt;-</span> <span class="va">resultados_ml</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">churn_flag</span><span class="op">)</span>,</span>
<span>    <span class="fu">.</span><span class="op">(</span></span>
<span>      precision <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">pred_churn</span> <span class="op">==</span> <span class="st">"Si"</span> <span class="op">&amp;</span> <span class="va">churn</span> <span class="op">==</span> <span class="st">"Si"</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">pred_churn</span> <span class="op">==</span> <span class="st">"Si"</span><span class="op">)</span>,</span>
<span>      recall <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">pred_churn</span> <span class="op">==</span> <span class="st">"Si"</span> <span class="op">&amp;</span> <span class="va">churn</span> <span class="op">==</span> <span class="st">"Si"</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">churn</span> <span class="op">==</span> <span class="st">"Si"</span><span class="op">)</span>,</span>
<span>      accuracy <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">pred_churn</span> <span class="op">==</span> <span class="va">churn</span><span class="op">)</span>,</span>
<span>      clientes_evaluados <span class="op">=</span> <span class="va">.N</span></span>
<span>    <span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">region</span>, <span class="va">categoria_edad</span><span class="op">)</span></span>
<span>  <span class="op">]</span><span class="op">[</span><span class="va">clientes_evaluados</span> <span class="op">&gt;=</span> <span class="fl">10</span><span class="op">]</span>  <span class="co"># Solo segmentos con suficientes datos</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\n=== EFECTIVIDAD DEL MODELO POR SEGMENTO ===\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">efectividad_modelo</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">accuracy</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; === EFECTIVIDAD DEL MODELO POR SEGMENTO ===</span></span>
<span><span class="co">#&gt;    region categoria_edad  precision     recall  accuracy clientes_evaluados</span></span>
<span><span class="co">#&gt;    &lt;char&gt;         &lt;fctr&gt;      &lt;num&gt;      &lt;num&gt;     &lt;num&gt;              &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1:  Oeste         Senior 0.20000000 0.25000000 0.8478261                 46</span></span>
<span><span class="co">#&gt; 2:   Este         Adulto 0.22222222 0.33333333 0.8225806                124</span></span>
<span><span class="co">#&gt; 3:   Este          Joven 0.13333333 0.22222222 0.8148148                108</span></span>
<span><span class="co">#&gt; 4:  Norte         Adulto 0.19047619 0.30769231 0.8000000                130</span></span>
<span><span class="co">#&gt; 5:  Oeste         Adulto 0.08333333 0.07142857 0.7837838                111</span></span>
<span><span class="co">#&gt; 6:  Norte          Joven 0.07142857 0.09090909 0.7676768                 99</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="dtplyr-el-puente-entre-data.table-y-tidyverse" class="level2" data-number="12.3"><h2 data-number="12.3" class="anchored" data-anchor-id="dtplyr-el-puente-entre-data.table-y-tidyverse">
<span class="header-section-number">12.3</span> dtplyr: El Puente Entre data.table y tidyverse</h2>
<section id="introducción-y-casos-de-uso" class="level3" data-number="12.3.1"><h3 data-number="12.3.1" class="anchored" data-anchor-id="introducción-y-casos-de-uso">
<span class="header-section-number">12.3.1</span> 1. <strong>Introducción y Casos de Uso</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"dtplyr"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"dplyr"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dtplyr.tidyverse.org">dtplyr</a></span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span>, warn.conflicts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Convertir data.table a lazy_dt</span></span>
<span>  <span class="va">clientes_lazy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dtplyr.tidyverse.org/reference/lazy_dt.html">lazy_dt</a></span><span class="op">(</span><span class="va">datos_clientes</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Workflow con sintaxis dplyr que se traduce a data.table</span></span>
<span>  <span class="va">analisis_dtplyr</span> <span class="op">&lt;-</span> <span class="va">clientes_lazy</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">edad</span> <span class="op">&gt;=</span> <span class="fl">25</span>, <span class="va">edad</span> <span class="op">&lt;=</span> <span class="fl">65</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>      categoria_valor <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>        <span class="va">valor_cliente</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">valor_cliente</span>, <span class="fl">0.8</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Premium"</span>,</span>
<span>        <span class="va">valor_cliente</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">valor_cliente</span>, <span class="fl">0.5</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Standard"</span>,</span>
<span>        <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"Basic"</span></span>
<span>      <span class="op">)</span>,</span>
<span>      riesgo_total <span class="op">=</span> <span class="va">riesgo_churn</span> <span class="op">+</span> <span class="op">(</span><span class="fl">5</span> <span class="op">-</span> <span class="va">satisfaccion</span><span class="op">)</span> <span class="op">/</span> <span class="fl">5</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">region</span>, <span class="va">categoria_valor</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>      clientes <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      valor_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">valor_cliente</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>      engagement_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">engagement_score</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>      churn_rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">churn_flag</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>      riesgo_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">riesgo_total</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>      .groups <span class="op">=</span> <span class="st">'drop'</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">valor_promedio</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="op">)</span>  <span class="co"># Convertir de vuelta a data.table</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Resultado del análisis con dtplyr:"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">analisis_dtplyr</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Ver el código data.table generado</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\n=== CÓDIGO DATA.TABLE GENERADO POR DTPLYR ===\n"</span><span class="op">)</span></span>
<span>  <span class="va">codigo_generado</span> <span class="op">&lt;-</span> <span class="va">clientes_lazy</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">edad</span> <span class="op">&gt;=</span> <span class="fl">25</span>, <span class="va">edad</span> <span class="op">&lt;=</span> <span class="fl">65</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>valor_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">valor_cliente</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">'drop'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"💡 Para usar dtplyr, instala los paquetes:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"install.packages(c('dtplyr', 'dplyr'))\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; 💡 Para usar dtplyr, instala los paquetes:</span></span>
<span><span class="co">#&gt; install.packages(c('dtplyr', 'dplyr'))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="comparación-de-performance-dtplyr-vs-dplyr-puro" class="level3" data-number="12.3.2"><h3 data-number="12.3.2" class="anchored" data-anchor-id="comparación-de-performance-dtplyr-vs-dplyr-puro">
<span class="header-section-number">12.3.2</span> 2. <strong>Comparación de Performance: dtplyr vs dplyr puro</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"dtplyr"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"dplyr"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/joshuaulrich/microbenchmark/">microbenchmark</a></span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Crear dataset más grande para benchmark</span></span>
<span>  <span class="va">datos_benchmark</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span><span class="op">(</span><span class="fl">5</span>, <span class="va">datos_clientes</span>, simplify <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Operación compleja para comparar</span></span>
<span>  <span class="va">operacion_compleja</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">metodo</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">metodo</span> <span class="op">==</span> <span class="st">"dplyr"</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># dplyr puro sobre data.frame</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">edad</span> <span class="op">&gt;=</span> <span class="fl">30</span>, <span class="va">satisfaccion</span> <span class="op">&gt;=</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">region</span>, <span class="va">categoria_ingresos</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>          clientes <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>          valor_total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">valor_cliente</span><span class="op">)</span>,</span>
<span>          engagement_avg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">engagement_score</span><span class="op">)</span>,</span>
<span>          .groups <span class="op">=</span> <span class="st">'drop'</span></span>
<span>        <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">valor_total</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">metodo</span> <span class="op">==</span> <span class="st">"dtplyr"</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># dtplyr (sintaxis dplyr + motor data.table)</span></span>
<span>      <span class="fu"><a href="https://dtplyr.tidyverse.org/reference/lazy_dt.html">lazy_dt</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">edad</span> <span class="op">&gt;=</span> <span class="fl">30</span>, <span class="va">satisfaccion</span> <span class="op">&gt;=</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">region</span>, <span class="va">categoria_ingresos</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>          clientes <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>          valor_total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">valor_cliente</span><span class="op">)</span>,</span>
<span>          engagement_avg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">engagement_score</span><span class="op">)</span>,</span>
<span>          .groups <span class="op">=</span> <span class="st">'drop'</span></span>
<span>        <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">valor_total</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="co"># data.table puro</span></span>
<span>      <span class="va">data</span><span class="op">[</span></span>
<span>        <span class="va">edad</span> <span class="op">&gt;=</span> <span class="fl">30</span> <span class="op">&amp;</span> <span class="va">satisfaccion</span> <span class="op">&gt;=</span> <span class="fl">3</span>,</span>
<span>        <span class="fu">.</span><span class="op">(</span></span>
<span>          clientes <span class="op">=</span> <span class="va">.N</span>,</span>
<span>          valor_total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">valor_cliente</span><span class="op">)</span>,</span>
<span>          engagement_avg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">engagement_score</span><span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>        by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">region</span>, <span class="va">categoria_ingresos</span><span class="op">)</span></span>
<span>      <span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">valor_total</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Benchmark</span></span>
<span>  <span class="va">benchmark_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span></span>
<span>    dplyr_puro <span class="op">=</span> <span class="fu">operacion_compleja</span><span class="op">(</span><span class="va">datos_benchmark</span>, <span class="st">"dplyr"</span><span class="op">)</span>,</span>
<span>    dtplyr <span class="op">=</span> <span class="fu">operacion_compleja</span><span class="op">(</span><span class="va">datos_benchmark</span>, <span class="st">"dtplyr"</span><span class="op">)</span>,</span>
<span>    data_table <span class="op">=</span> <span class="fu">operacion_compleja</span><span class="op">(</span><span class="va">datos_benchmark</span>, <span class="st">"data.table"</span><span class="op">)</span>,</span>
<span>    times <span class="op">=</span> <span class="fl">10</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"=== BENCHMARK DE PERFORMANCE ===\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">benchmark_results</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Calcular speedup</span></span>
<span>  <span class="va">medias</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">time</span> <span class="op">~</span> <span class="va">expr</span>, data <span class="op">=</span> <span class="va">benchmark_results</span>, FUN <span class="op">=</span> <span class="va">mean</span><span class="op">)</span></span>
<span>  <span class="va">medias</span><span class="op">$</span><span class="va">speedup</span> <span class="op">&lt;-</span> <span class="va">medias</span><span class="op">$</span><span class="va">time</span><span class="op">[</span><span class="va">medias</span><span class="op">$</span><span class="va">expr</span> <span class="op">==</span> <span class="st">"dplyr_puro"</span><span class="op">]</span> <span class="op">/</span> <span class="va">medias</span><span class="op">$</span><span class="va">time</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\n=== SPEEDUP RELATIVO (vs dplyr puro) ===\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">medias</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"expr"</span>, <span class="st">"speedup"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Benchmark requiere dtplyr y dplyr instalados\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Benchmark requiere dtplyr y dplyr instalados</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="conexión-con-bases-de-datos-y-big-data" class="level2" data-number="12.4"><h2 data-number="12.4" class="anchored" data-anchor-id="conexión-con-bases-de-datos-y-big-data">
<span class="header-section-number">12.4</span> Conexión con Bases de Datos y Big Data</h2>
<section id="lecturaescritura-eficiente-con-freadfwrite" class="level3" data-number="12.4.1"><h3 data-number="12.4.1" class="anchored" data-anchor-id="lecturaescritura-eficiente-con-freadfwrite">
<span class="header-section-number">12.4.1</span> 1. <strong>Lectura/Escritura Eficiente con fread/fwrite</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># === FREAD: Lectura ultrarrápida ===</span></span>
<span><span class="co"># Crear archivo de ejemplo grande</span></span>
<span><span class="va">archivo_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".csv"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generar datos sintéticos para el ejemplo</span></span>
<span><span class="va">datos_grandes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span></span>
<span>  id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100000</span>,</span>
<span>  timestamp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"2024-01-01"</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"min"</span>, length.out <span class="op">=</span> <span class="fl">100000</span><span class="op">)</span>,</span>
<span>  sensor_value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100000</span>, <span class="fl">50</span>, <span class="fl">15</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  location <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Factory_A"</span>, <span class="st">"Factory_B"</span>, <span class="st">"Factory_C"</span><span class="op">)</span>, <span class="fl">100000</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  quality_score <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">100000</span>, <span class="fl">0.8</span>, <span class="fl">1.0</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>  batch_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">1000</span>, <span class="fl">100000</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Escribir archivo</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Escribiendo archivo de prueba...\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Escribiendo archivo de prueba...</span></span>
<span><span class="va">tiempo_write</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fwrite.html">fwrite</a></span><span class="op">(</span><span class="va">datos_grandes</span>, <span class="va">archivo_test</span>, </span>
<span>         nThread <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/openmp-utils.html">getDTthreads</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>         showProgress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Información del archivo</span></span>
<span><span class="va">info_archivo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.info.html">file.info</a></span><span class="op">(</span><span class="va">archivo_test</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Archivo creado:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">info_archivo</span><span class="op">$</span><span class="va">size</span> <span class="op">/</span> <span class="fl">1024</span><span class="op">^</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"MB\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Archivo creado: 4.06 MB</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Tiempo de escritura:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">tiempo_write</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"segundos\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Tiempo de escritura: 0.01 segundos</span></span>
<span></span>
<span><span class="co"># Lectura con diferentes configuraciones</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\n=== COMPARACIÓN DE MÉTODOS DE LECTURA ===\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; === COMPARACIÓN DE MÉTODOS DE LECTURA ===</span></span>
<span></span>
<span><span class="co"># 1. fread básico</span></span>
<span><span class="va">tiempo_fread_basico</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">datos_fread</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fread.html">fread</a></span><span class="op">(</span><span class="va">archivo_test</span>, showProgress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. fread optimizado</span></span>
<span><span class="va">tiempo_fread_opt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">datos_fread_opt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fread.html">fread</a></span><span class="op">(</span></span>
<span>    <span class="va">archivo_test</span>,</span>
<span>    nThread <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/openmp-utils.html">getDTthreads</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    select <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"timestamp"</span>, <span class="st">"sensor_value"</span>, <span class="st">"location"</span><span class="op">)</span>,  <span class="co"># Solo columnas necesarias</span></span>
<span>    colClasses <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>character <span class="op">=</span> <span class="st">"location"</span>, numeric <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sensor_value"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    showProgress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. read.csv para comparación</span></span>
<span><span class="va">tiempo_base_r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">datos_base</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="va">archivo_test</span>, stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"fread básico:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">tiempo_fread_basico</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"segundos\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; fread básico: 0.006 segundos</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"fread optimizado:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">tiempo_fread_opt</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"segundos\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; fread optimizado: 0.004 segundos</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"read.csv (base R):"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">tiempo_base_r</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"segundos\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; read.csv (base R): 0.098 segundos</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Speedup fread vs base R:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">tiempo_base_r</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">/</span> <span class="va">tiempo_fread_basico</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"x\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Speedup fread vs base R: 16.3 x</span></span>
<span></span>
<span><span class="co"># Verificar que los datos son idénticos</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Datos idénticos:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op">(</span><span class="va">datos_fread</span><span class="op">$</span><span class="va">id</span>, <span class="va">datos_fread_opt</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Datos idénticos: TRUE</span></span>
<span></span>
<span><span class="co"># Limpiar</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span><span class="op">(</span><span class="va">archivo_test</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="integración-con-bases-de-datos" class="level3" data-number="12.4.2"><h3 data-number="12.4.2" class="anchored" data-anchor-id="integración-con-bases-de-datos">
<span class="header-section-number">12.4.2</span> 2. <strong>Integración con Bases de Datos</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Ejemplo de integración con bases de datos</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dbi.r-dbi.org">DBI</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rsqlite.r-dbi.org">RSQLite</a></span><span class="op">)</span>  <span class="co"># o RPostgreSQL, RMySQL, etc.</span></span>
<span></span>
<span><span class="co"># === SETUP DE CONEXIÓN ===</span></span>
<span><span class="co"># Crear base de datos SQLite para el ejemplo</span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html">dbConnect</a></span><span class="op">(</span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html">SQLite</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">":memory:"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Escribir data.table a la base de datos</span></span>
<span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbWriteTable.html">dbWriteTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"clientes"</span>, <span class="va">datos_clientes</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbWriteTable.html">dbWriteTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"transacciones"</span>, <span class="va">transacciones_detalle</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># === WORKFLOW HÍBRIDO: SQL + data.table ===</span></span>
<span></span>
<span><span class="co"># 1. Query inicial en SQL (aprovechar índices de DB)</span></span>
<span><span class="va">query_sql</span> <span class="op">&lt;-</span> <span class="st">"</span></span>
<span><span class="st">  SELECT c.cliente_id, c.region, c.edad, c.ingresos,</span></span>
<span><span class="st">         t.monto, t.fecha_transaccion, t.producto_categoria</span></span>
<span><span class="st">  FROM clientes c</span></span>
<span><span class="st">  JOIN transacciones t ON c.cliente_id = t.cliente_id</span></span>
<span><span class="st">  WHERE c.edad &gt;= 25 AND c.edad &lt;= 65</span></span>
<span><span class="st">    AND t.fecha_transaccion &gt;= '2024-01-01'</span></span>
<span><span class="st">"</span></span>
<span></span>
<span><span class="co"># 2. Traer datos a data.table</span></span>
<span><span class="va">datos_query</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="va">query_sql</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. Análisis complejo con data.table (más rápido que SQL)</span></span>
<span><span class="va">analisis_hibrido</span> <span class="op">&lt;-</span> <span class="va">datos_query</span><span class="op">[</span>,</span>
<span>  <span class="fu">.</span><span class="op">(</span></span>
<span>    transacciones_total <span class="op">=</span> <span class="va">.N</span>,</span>
<span>    monto_total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">monto</span><span class="op">)</span>,</span>
<span>    monto_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">monto</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    categorias_distintas <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/duplicated.html">uniqueN</a></span><span class="op">(</span><span class="va">producto_categoria</span><span class="op">)</span>,</span>
<span>    primera_compra <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">fecha_transaccion</span><span class="op">)</span>,</span>
<span>    ultima_compra <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">fecha_transaccion</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">cliente_id</span>, <span class="va">region</span><span class="op">)</span></span>
<span><span class="op">]</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span></span>
<span>  dias_activo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">ultima_compra</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">primera_compra</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>,</span>
<span>  frecuencia_compra <span class="op">=</span> <span class="va">transacciones_total</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">ultima_compra</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">primera_compra</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">monto_total</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># 4. Escribir resultados de vuelta a DB (opcional)</span></span>
<span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbWriteTable.html">dbWriteTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"analisis_clientes"</span>, <span class="va">analisis_hibrido</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 5. Verificación</span></span>
<span><span class="va">resumen_db</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"SELECT COUNT(*) as clientes_analizados FROM analisis_clientes"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Clientes analizados en DB:"</span>, <span class="va">resumen_db</span><span class="op">$</span><span class="va">clientes_analizados</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Cerrar conexión</span></span>
<span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html">dbDisconnect</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># === MEJORES PRÁCTICAS ===</span></span>
<span><span class="co"># 1. Usar SQL para filtros iniciales y joins simples</span></span>
<span><span class="co"># 2. Traer datos a data.table para análisis complejos</span></span>
<span><span class="co"># 3. Aprovechar índices de DB para WHERE y JOIN</span></span>
<span><span class="co"># 4. Usar data.table para agregaciones complejas y feature engineering</span></span>
<span><span class="co"># 5. Escribir resultados finales de vuelta a DB si es necesario</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="integración-con-apache-arrowparquet" class="level3" data-number="12.4.3"><h3 data-number="12.4.3" class="anchored" data-anchor-id="integración-con-apache-arrowparquet">
<span class="header-section-number">12.4.3</span> 3. <strong>Integración con Apache Arrow/Parquet</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Ejemplo de integración con ecosistema Arrow</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/apache/arrow/">arrow</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># === ESCRITURA A PARQUET ===</span></span>
<span><span class="co"># Parquet es ultra-eficiente para datasets grandes</span></span>
<span><span class="va">archivo_parquet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".parquet"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Escribir data.table a Parquet</span></span>
<span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/write_parquet.html">write_parquet</a></span><span class="op">(</span><span class="va">datos_clientes</span>, <span class="va">archivo_parquet</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># === LECTURA DESDE PARQUET ===</span></span>
<span><span class="co"># Leer directo a data.table</span></span>
<span><span class="va">datos_parquet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://arrow.apache.org/docs/r/reference/read_parquet.html">read_parquet</a></span><span class="op">(</span><span class="va">archivo_parquet</span>, as_data_frame <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setDT.html">setDT</a></span><span class="op">(</span><span class="va">datos_parquet</span><span class="op">)</span>  <span class="co"># Asegurar que es data.table</span></span>
<span></span>
<span><span class="co"># === DATASETS PARTICIONADOS ===</span></span>
<span><span class="co"># Para datasets muy grandes, usar particiones</span></span>
<span><span class="va">directorio_particionado</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"partitioned_data"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span><span class="op">(</span><span class="va">directorio_particionado</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Particionar por región - método más robusto</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">region_name</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">datos_clientes</span><span class="op">$</span><span class="va">region</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">region_data</span> <span class="op">&lt;-</span> <span class="va">datos_clientes</span><span class="op">[</span><span class="va">region</span> <span class="op">==</span> <span class="va">region_name</span><span class="op">]</span></span>
<span>  <span class="va">archivo_region</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">directorio_particionado</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"region_"</span>, <span class="va">region_name</span>, <span class="st">".parquet"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://arrow.apache.org/docs/r/reference/write_parquet.html">write_parquet</a></span><span class="op">(</span><span class="va">region_data</span>, <span class="va">archivo_region</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Verificar que los archivos se crearon correctamente</span></span>
<span><span class="va">archivos_parquet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="va">directorio_particionado</span>, pattern <span class="op">=</span> <span class="st">"\\.parquet$"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Archivos Parquet creados:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">archivos_parquet</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Leer dataset particionado solo si hay archivos válidos</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">archivos_parquet</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">dataset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://arrow.apache.org/docs/r/reference/open_dataset.html">open_dataset</a></span><span class="op">(</span><span class="va">directorio_particionado</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"No se pudieron crear archivos Parquet válidos"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Query con pushdown de predicados (muy eficiente)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">resultado_arrow</span> <span class="op">&lt;-</span> <span class="va">dataset</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">edad</span> <span class="op">&gt;=</span> <span class="fl">30</span>, <span class="va">satisfaccion</span> <span class="op">&gt;=</span> <span class="fl">4</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>      clientes <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      valor_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">valor_cliente</span><span class="op">)</span>,</span>
<span>      ingresos_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">ingresos</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">collect</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  <span class="co"># Traer a memoria</span></span>
<span>    <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="op">)</span>  <span class="co"># Convertir a data.table</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">resultado_arrow</span><span class="op">)</span></span>
<span><span class="op">}</span>, error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Error en consulta Arrow:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/conditions.html">conditionMessage</a></span><span class="op">(</span><span class="va">e</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Usando método alternativo con data.table directo...\n"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Fallback: usar data.table directamente</span></span>
<span>  <span class="va">resultado_arrow</span> <span class="op">&lt;-</span> <span class="va">datos_clientes</span><span class="op">[</span><span class="va">edad</span> <span class="op">&gt;=</span> <span class="fl">30</span> <span class="op">&amp;</span> <span class="va">satisfaccion</span> <span class="op">&gt;=</span> <span class="fl">4</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>    clientes <span class="op">=</span> <span class="va">.N</span>,</span>
<span>    valor_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">valor_cliente</span><span class="op">)</span>,</span>
<span>    ingresos_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">ingresos</span><span class="op">)</span></span>
<span>  <span class="op">)</span>, by <span class="op">=</span> <span class="va">region</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">resultado_arrow</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># === VENTAJAS DEL WORKFLOW ARROW + DATA.TABLE ===</span></span>
<span><span class="co"># 1. Parquet es extremadamente eficiente en espacio</span></span>
<span><span class="co"># 2. Pushdown de predicados reduce transferencia de datos</span></span>
<span><span class="co"># 3. Compatibilidad con otros lenguajes (Python, Spark)</span></span>
<span><span class="co"># 4. data.table para análisis final en R</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="casos-de-uso-industriales-reales" class="level2" data-number="12.5"><h2 data-number="12.5" class="anchored" data-anchor-id="casos-de-uso-industriales-reales">
<span class="header-section-number">12.5</span> Casos de Uso Industriales Reales</h2>
<section id="sistema-de-monitoreo-iot-en-tiempo-real" class="level3" data-number="12.5.1"><h3 data-number="12.5.1" class="anchored" data-anchor-id="sistema-de-monitoreo-iot-en-tiempo-real">
<span class="header-section-number">12.5.1</span> 1. <strong>Sistema de Monitoreo IoT en Tiempo Real</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># === ANÁLISIS DE SENSORES IOT ===</span></span>
<span><span class="co"># Simular análisis en tiempo real de sensores</span></span>
<span></span>
<span><span class="co"># Función para procesar batch de datos de sensores</span></span>
<span><span class="va">procesar_batch_sensores</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">datos_sensores</span>, <span class="va">ventana_horas</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Análisis de anomalías en tiempo real</span></span>
<span>  <span class="va">datos_sensores</span><span class="op">[</span>,</span>
<span>    <span class="fu">`:=`</span><span class="op">(</span></span>
<span>      temp_anomaly <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">temperatura</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">temperatura</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">temperatura</span><span class="op">)</span>,</span>
<span>      humidity_anomaly <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">humedad</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">humedad</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">humedad</span><span class="op">)</span>,</span>
<span>      battery_critical <span class="op">=</span> <span class="va">nivel_bateria</span> <span class="op">&lt;</span> <span class="fl">15</span></span>
<span>    <span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">sensor_id</span>, <span class="va">fecha</span><span class="op">)</span></span>
<span>  <span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Resumen por sensor y hora</span></span>
<span>  <span class="va">resumen_sensores</span> <span class="op">&lt;-</span> <span class="va">datos_sensores</span><span class="op">[</span>,</span>
<span>    <span class="fu">.</span><span class="op">(</span></span>
<span>      temp_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">temperatura</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>      temp_min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">temperatura</span><span class="op">)</span>,</span>
<span>      temp_max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">temperatura</span><span class="op">)</span>,</span>
<span>      humedad_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">humedad</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>      presion_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">presion</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>      movimientos_detectados <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">movimiento_detectado</span><span class="op">)</span>,</span>
<span>      anomalias_temp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">temp_anomaly</span><span class="op">)</span>,</span>
<span>      anomalias_humedad <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">humidity_anomaly</span><span class="op">)</span>,</span>
<span>      alertas_bateria <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">battery_critical</span><span class="op">)</span>,</span>
<span>      lecturas_total <span class="op">=</span> <span class="va">.N</span>,</span>
<span>      uptime_pct <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">temperatura</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="va">.N</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">sensor_id</span>, <span class="va">fecha</span>, <span class="va">hora</span><span class="op">)</span></span>
<span>  <span class="op">]</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span></span>
<span>    estado_sensor <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fcase.html">fcase</a></span><span class="op">(</span></span>
<span>      <span class="va">alertas_bateria</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="st">"CRÍTICO"</span>,</span>
<span>      <span class="va">anomalias_temp</span> <span class="op">+</span> <span class="va">anomalias_humedad</span> <span class="op">&gt;</span> <span class="fl">5</span>, <span class="st">"ADVERTENCIA"</span>,</span>
<span>      <span class="va">uptime_pct</span> <span class="op">&lt;</span> <span class="fl">95</span>, <span class="st">"DEGRADADO"</span>,</span>
<span>      default <span class="op">=</span> <span class="st">"NORMAL"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    score_salud <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmin</a></span><span class="op">(</span><span class="fl">100</span>, <span class="va">uptime_pct</span> <span class="op">-</span> <span class="op">(</span><span class="va">anomalias_temp</span> <span class="op">+</span> <span class="va">anomalias_humedad</span><span class="op">)</span> <span class="op">*</span> <span class="fl">5</span> <span class="op">-</span> <span class="va">alertas_bateria</span> <span class="op">*</span> <span class="fl">20</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">resumen_sensores</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Procesar datos de sensores</span></span>
<span><span class="va">analisis_sensores</span> <span class="op">&lt;-</span> <span class="fu">procesar_batch_sensores</span><span class="op">(</span><span class="va">sensores_iot</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Dashboard de alertas críticas</span></span>
<span><span class="va">alertas_criticas</span> <span class="op">&lt;-</span> <span class="va">analisis_sensores</span><span class="op">[</span></span>
<span>  <span class="va">estado_sensor</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"CRÍTICO"</span>, <span class="st">"ADVERTENCIA"</span><span class="op">)</span>,</span>
<span>  <span class="fu">.</span><span class="op">(</span></span>
<span>    <span class="va">sensor_id</span>, <span class="va">fecha</span>, <span class="va">hora</span>,</span>
<span>    <span class="va">estado_sensor</span>, <span class="va">score_salud</span>,</span>
<span>    <span class="va">anomalias_temp</span>, <span class="va">anomalias_humedad</span>, <span class="va">alertas_bateria</span>,</span>
<span>    accion_requerida <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fcase.html">fcase</a></span><span class="op">(</span></span>
<span>      <span class="va">alertas_bateria</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="st">"Cambiar_Batería"</span>,</span>
<span>      <span class="va">anomalias_temp</span> <span class="op">&gt;</span> <span class="fl">3</span>, <span class="st">"Revisar_Sensor_Temperatura"</span>,</span>
<span>      <span class="va">anomalias_humedad</span> <span class="op">&gt;</span> <span class="fl">3</span>, <span class="st">"Revisar_Sensor_Humedad"</span>,</span>
<span>      default <span class="op">=</span> <span class="st">"Inspección_General"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">fecha</span>, <span class="va">hora</span>, <span class="op">-</span><span class="va">score_salud</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"=== ALERTAS CRÍTICAS DEL SISTEMA IOT ===\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; === ALERTAS CRÍTICAS DEL SISTEMA IOT ===</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">alertas_criticas</span>, <span class="fl">15</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;     sensor_id      fecha  hora estado_sensor score_salud anomalias_temp</span></span>
<span><span class="co">#&gt;        &lt;char&gt;     &lt;Date&gt; &lt;int&gt;        &lt;char&gt;       &lt;num&gt;          &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1: SENSOR_091 2024-01-22    20       CRÍTICO          80              0</span></span>
<span><span class="co">#&gt; 2: SENSOR_078 2024-01-24     4       CRÍTICO          80              0</span></span>
<span><span class="co">#&gt; 3: SENSOR_030 2024-01-26    19       CRÍTICO          80              0</span></span>
<span><span class="co">#&gt; 4: SENSOR_032 2024-01-31     7       CRÍTICO          80              0</span></span>
<span><span class="co">#&gt;    anomalias_humedad alertas_bateria accion_requerida</span></span>
<span><span class="co">#&gt;                &lt;int&gt;           &lt;int&gt;           &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1:                 0               1  Cambiar_Batería</span></span>
<span><span class="co">#&gt; 2:                 0               1  Cambiar_Batería</span></span>
<span><span class="co">#&gt; 3:                 0               1  Cambiar_Batería</span></span>
<span><span class="co">#&gt; 4:                 0               1  Cambiar_Batería</span></span>
<span></span>
<span><span class="co"># Estadísticas de salud del sistema</span></span>
<span><span class="va">salud_sistema</span> <span class="op">&lt;-</span> <span class="va">analisis_sensores</span><span class="op">[</span>,</span>
<span>  <span class="fu">.</span><span class="op">(</span></span>
<span>    sensores_activos <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/duplicated.html">uniqueN</a></span><span class="op">(</span><span class="va">sensor_id</span><span class="op">)</span>,</span>
<span>    sensores_criticos <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/duplicated.html">uniqueN</a></span><span class="op">(</span><span class="va">sensor_id</span><span class="op">[</span><span class="va">estado_sensor</span> <span class="op">==</span> <span class="st">"CRÍTICO"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    sensores_degradados <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/duplicated.html">uniqueN</a></span><span class="op">(</span><span class="va">sensor_id</span><span class="op">[</span><span class="va">estado_sensor</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ADVERTENCIA"</span>, <span class="st">"DEGRADADO"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    score_salud_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">score_salud</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    anomalias_totales <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">anomalias_temp</span> <span class="op">+</span> <span class="va">anomalias_humedad</span><span class="op">)</span>,</span>
<span>    uptime_sistema <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">uptime_pct</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">fecha</span><span class="op">)</span></span>
<span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\n=== SALUD GENERAL DEL SISTEMA ===\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; === SALUD GENERAL DEL SISTEMA ===</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">salud_sistema</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;         fecha sensores_activos sensores_criticos sensores_degradados</span></span>
<span><span class="co">#&gt;        &lt;Date&gt;            &lt;int&gt;             &lt;int&gt;               &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1: 2023-12-31               12                 0                   0</span></span>
<span><span class="co">#&gt; 2: 2024-01-01              100                 0                   0</span></span>
<span><span class="co">#&gt; 3: 2024-01-02              100                 0                   0</span></span>
<span><span class="co">#&gt; 4: 2024-01-03              100                 0                   0</span></span>
<span><span class="co">#&gt; 5: 2024-01-04              100                 0                   0</span></span>
<span><span class="co">#&gt; 6: 2024-01-05              100                 0                   0</span></span>
<span><span class="co">#&gt;    score_salud_promedio anomalias_totales uptime_sistema</span></span>
<span><span class="co">#&gt;                   &lt;num&gt;             &lt;int&gt;          &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:                   NA                NA            100</span></span>
<span><span class="co">#&gt; 2:                  100                 0            100</span></span>
<span><span class="co">#&gt; 3:                  100                 0            100</span></span>
<span><span class="co">#&gt; 4:                  100                 0            100</span></span>
<span><span class="co">#&gt; 5:                  100                 0            100</span></span>
<span><span class="co">#&gt; 6:                  100                 0            100</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="sistema-de-recomendaciones-e-commerce" class="level3" data-number="12.5.2"><h3 data-number="12.5.2" class="anchored" data-anchor-id="sistema-de-recomendaciones-e-commerce">
<span class="header-section-number">12.5.2</span> 2. <strong>Sistema de Recomendaciones E-commerce</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># === MOTOR DE RECOMENDACIONES ===</span></span>
<span><span class="co"># Sistema basado en comportamiento de compra</span></span>
<span></span>
<span><span class="co"># Función para calcular similaridad entre clientes</span></span>
<span><span class="va">calcular_recomendaciones</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">transacciones_dt</span>, <span class="va">cliente_target</span>, <span class="va">top_n</span> <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Matriz de compras por cliente-categoría</span></span>
<span>  <span class="va">matriz_compras</span> <span class="op">&lt;-</span> <span class="va">transacciones_dt</span><span class="op">[</span>,</span>
<span>    <span class="fu">.</span><span class="op">(</span></span>
<span>      total_comprado <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">monto_final</span><span class="op">)</span>,</span>
<span>      frecuencia <span class="op">=</span> <span class="va">.N</span></span>
<span>    <span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">cliente_id</span>, <span class="va">producto_categoria</span><span class="op">)</span></span>
<span>  <span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Perfil del cliente target</span></span>
<span>  <span class="va">perfil_target</span> <span class="op">&lt;-</span> <span class="va">matriz_compras</span><span class="op">[</span><span class="va">cliente_id</span> <span class="op">==</span> <span class="va">cliente_target</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">perfil_target</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span>mensaje <span class="op">=</span> <span class="st">"Cliente no encontrado"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Encontrar clientes similares</span></span>
<span>  <span class="va">clientes_similares</span> <span class="op">&lt;-</span> <span class="va">matriz_compras</span><span class="op">[</span></span>
<span>    <span class="va">producto_categoria</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">perfil_target</span><span class="op">$</span><span class="va">producto_categoria</span> <span class="op">&amp;</span> </span>
<span>    <span class="va">cliente_id</span> <span class="op">!=</span> <span class="va">cliente_target</span>,</span>
<span>    <span class="fu">.</span><span class="op">(</span></span>
<span>      overlap_categorias <span class="op">=</span> <span class="va">.N</span>,</span>
<span>      valor_similar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">total_comprado</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="va">cliente_id</span></span>
<span>  <span class="op">]</span><span class="op">[</span><span class="va">overlap_categorias</span> <span class="op">&gt;=</span> <span class="fl">2</span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">overlap_categorias</span>, <span class="op">-</span><span class="va">valor_similar</span><span class="op">)</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Recomendaciones basadas en clientes similares</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">clientes_similares</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">recomendaciones</span> <span class="op">&lt;-</span> <span class="va">matriz_compras</span><span class="op">[</span></span>
<span>      <span class="va">cliente_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">clientes_similares</span><span class="op">$</span><span class="va">cliente_id</span>, <span class="fl">20</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>      <span class="op">!</span><span class="va">producto_categoria</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">perfil_target</span><span class="op">$</span><span class="va">producto_categoria</span>,</span>
<span>      <span class="fu">.</span><span class="op">(</span></span>
<span>        score_recomendacion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">total_comprado</span><span class="op">)</span>,</span>
<span>        clientes_que_compran <span class="op">=</span> <span class="va">.N</span>,</span>
<span>        frecuencia_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">frecuencia</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      by <span class="op">=</span> <span class="va">producto_categoria</span></span>
<span>    <span class="op">]</span><span class="op">[</span><span class="va">clientes_que_compran</span> <span class="op">&gt;=</span> <span class="fl">3</span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">score_recomendacion</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">top_n</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">recomendaciones</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span>mensaje <span class="op">=</span> <span class="st">"No hay suficientes datos para recomendaciones"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Función para análisis de mercado</span></span>
<span><span class="va">analizar_tendencias_mercado</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">transacciones_dt</span>, <span class="va">periodo_dias</span> <span class="op">=</span> <span class="fl">30</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">fecha_corte</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">transacciones_dt</span><span class="op">$</span><span class="va">fecha_transaccion</span><span class="op">)</span> <span class="op">-</span> <span class="va">periodo_dias</span></span>
<span>  </span>
<span>  <span class="va">tendencias</span> <span class="op">&lt;-</span> <span class="va">transacciones_dt</span><span class="op">[</span></span>
<span>    <span class="va">fecha_transaccion</span> <span class="op">&gt;=</span> <span class="va">fecha_corte</span>,</span>
<span>    <span class="fu">.</span><span class="op">(</span></span>
<span>      ventas_recientes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">monto_final</span><span class="op">)</span>,</span>
<span>      transacciones_recientes <span class="op">=</span> <span class="va">.N</span>,</span>
<span>      clientes_unicos <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/duplicated.html">uniqueN</a></span><span class="op">(</span><span class="va">cliente_id</span><span class="op">)</span>,</span>
<span>      ticket_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">monto_final</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>      crecimiento_semanal <span class="op">=</span> <span class="va">.N</span> <span class="op">/</span> <span class="op">(</span><span class="va">periodo_dias</span> <span class="op">/</span> <span class="fl">7</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="va">producto_categoria</span></span>
<span>  <span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">ventas_recientes</span><span class="op">)</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Calcular métricas adicionales</span></span>
<span>  <span class="va">tendencias</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span></span>
<span>    penetracion_mercado <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="op">(</span><span class="va">clientes_unicos</span> <span class="op">/</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/duplicated.html">uniqueN</a></span><span class="op">(</span><span class="va">transacciones_dt</span><span class="op">$</span><span class="va">cliente_id</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    velocidad_venta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">transacciones_recientes</span> <span class="op">/</span> <span class="va">periodo_dias</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    categoria_trend <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fcase.html">fcase</a></span><span class="op">(</span></span>
<span>      <span class="va">crecimiento_semanal</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">crecimiento_semanal</span>, <span class="fl">0.75</span><span class="op">)</span>, <span class="st">"📈 CRECIENTE"</span>,</span>
<span>      <span class="va">crecimiento_semanal</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">crecimiento_semanal</span>, <span class="fl">0.25</span><span class="op">)</span>, <span class="st">"📉 DECLINANTE"</span>,</span>
<span>      default <span class="op">=</span> <span class="st">"➡️ ESTABLE"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">tendencias</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Ejecutar análisis de recomendaciones</span></span>
<span><span class="va">cliente_ejemplo</span> <span class="op">&lt;-</span> <span class="va">datos_clientes</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">.N</span>, <span class="fl">1</span><span class="op">)</span>, <span class="va">cliente_id</span><span class="op">]</span></span>
<span><span class="va">recomendaciones</span> <span class="op">&lt;-</span> <span class="fu">calcular_recomendaciones</span><span class="op">(</span><span class="va">transacciones_detalle</span>, <span class="va">cliente_ejemplo</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"=== RECOMENDACIONES PARA CLIENTE"</span>, <span class="va">cliente_ejemplo</span>, <span class="st">"===\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; === RECOMENDACIONES PARA CLIENTE 3450 ===</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">recomendaciones</span><span class="op">)</span></span>
<span><span class="co">#&gt;    producto_categoria score_recomendacion clientes_que_compran</span></span>
<span><span class="co">#&gt;                &lt;char&gt;               &lt;num&gt;                &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1:        Electronics            2412.048                   16</span></span>
<span><span class="co">#&gt; 2:              Books            1472.585                   10</span></span>
<span><span class="co">#&gt; 3:             Beauty            1152.812                   15</span></span>
<span><span class="co">#&gt; 4:               &lt;NA&gt;                  NA                   NA</span></span>
<span><span class="co">#&gt; 5:               &lt;NA&gt;                  NA                   NA</span></span>
<span><span class="co">#&gt;    frecuencia_promedio</span></span>
<span><span class="co">#&gt;                  &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:                 1.4</span></span>
<span><span class="co">#&gt; 2:                 1.5</span></span>
<span><span class="co">#&gt; 3:                 1.2</span></span>
<span><span class="co">#&gt; 4:                  NA</span></span>
<span><span class="co">#&gt; 5:                  NA</span></span>
<span></span>
<span><span class="co"># Análisis de tendencias de mercado</span></span>
<span><span class="va">tendencias_mercado</span> <span class="op">&lt;-</span> <span class="fu">analizar_tendencias_mercado</span><span class="op">(</span><span class="va">transacciones_detalle</span>, <span class="fl">60</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\n=== TENDENCIAS DE MERCADO (últimos 60 días) ===\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; === TENDENCIAS DE MERCADO (últimos 60 días) ===</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">tendencias_mercado</span><span class="op">)</span></span>
<span><span class="co">#&gt;    producto_categoria ventas_recientes transacciones_recientes clientes_unicos</span></span>
<span><span class="co">#&gt;                &lt;char&gt;            &lt;num&gt;                   &lt;int&gt;           &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1:             Sports         59738.74                     728             696</span></span>
<span><span class="co">#&gt; 2:              Books         57747.86                     673             658</span></span>
<span><span class="co">#&gt; 3:               Home         57641.77                     700             678</span></span>
<span><span class="co">#&gt; 4:           Clothing         55649.79                     723             699</span></span>
<span><span class="co">#&gt; 5:             Beauty         55388.89                     680             662</span></span>
<span><span class="co">#&gt; 6:        Electronics         52302.97                     689             663</span></span>
<span><span class="co">#&gt;    ticket_promedio crecimiento_semanal penetracion_mercado velocidad_venta</span></span>
<span><span class="co">#&gt;              &lt;num&gt;               &lt;num&gt;               &lt;num&gt;           &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:           82.06            84.93333                 7.0           12.13</span></span>
<span><span class="co">#&gt; 2:           85.81            78.51667                 6.6           11.22</span></span>
<span><span class="co">#&gt; 3:           82.35            81.66667                 6.8           11.67</span></span>
<span><span class="co">#&gt; 4:           76.97            84.35000                 7.0           12.05</span></span>
<span><span class="co">#&gt; 5:           81.45            79.33333                 6.7           11.33</span></span>
<span><span class="co">#&gt; 6:           75.91            80.38333                 6.7           11.48</span></span>
<span><span class="co">#&gt;    categoria_trend</span></span>
<span><span class="co">#&gt;             &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1:    📈 CRECIENTE</span></span>
<span><span class="co">#&gt; 2:   📉 DECLINANTE</span></span>
<span><span class="co">#&gt; 3:       ➡️ ESTABLE</span></span>
<span><span class="co">#&gt; 4:    📈 CRECIENTE</span></span>
<span><span class="co">#&gt; 5:   📉 DECLINANTE</span></span>
<span><span class="co">#&gt; 6:       ➡️ ESTABLE</span></span>
<span></span>
<span><span class="co"># Análisis de cohorstes de clientes</span></span>
<span><span class="va">analisis_cohortes</span> <span class="op">&lt;-</span> <span class="va">transacciones_detalle</span><span class="op">[</span>,</span>
<span>  <span class="fu">.</span><span class="op">(</span></span>
<span>    primera_compra <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">fecha_transaccion</span><span class="op">)</span>,</span>
<span>    ultima_compra <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">fecha_transaccion</span><span class="op">)</span>,</span>
<span>    valor_total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">monto_final</span><span class="op">)</span>,</span>
<span>    frecuencia_compra <span class="op">=</span> <span class="va">.N</span></span>
<span>  <span class="op">)</span>,</span>
<span>  by <span class="op">=</span> <span class="va">cliente_id</span></span>
<span><span class="op">]</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span></span>
<span>  cohorte_mes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="va">primera_compra</span>, <span class="st">"%Y-%m"</span><span class="op">)</span>,</span>
<span>  dias_como_cliente <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">ultima_compra</span> <span class="op">-</span> <span class="va">primera_compra</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">)</span><span class="op">]</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span></span>
<span>  valor_por_dia <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">valor_total</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">dias_como_cliente</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">]</span><span class="op">[</span>,</span>
<span>  <span class="fu">.</span><span class="op">(</span></span>
<span>    clientes_cohorte <span class="op">=</span> <span class="va">.N</span>,</span>
<span>    valor_promedio_cohorte <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">valor_total</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    dias_retencion_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">dias_como_cliente</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    valor_por_dia_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">valor_por_dia</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  by <span class="op">=</span> <span class="va">cohorte_mes</span></span>
<span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">cohorte_mes</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\n=== ANÁLISIS DE COHORTES POR MES ===\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; === ANÁLISIS DE COHORTES POR MES ===</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">analisis_cohortes</span>, <span class="fl">12</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;     cohorte_mes clientes_cohorte valor_promedio_cohorte dias_retencion_promedio</span></span>
<span><span class="co">#&gt;          &lt;char&gt;            &lt;int&gt;                  &lt;num&gt;                   &lt;num&gt;</span></span>
<span><span class="co">#&gt;  1:     2023-01             1919                 480.73                   576.0</span></span>
<span><span class="co">#&gt;  2:     2023-02             1419                 468.32                   540.2</span></span>
<span><span class="co">#&gt;  3:     2023-03             1254                 449.64                   513.0</span></span>
<span><span class="co">#&gt;  4:     2023-04             1018                 434.10                   479.9</span></span>
<span><span class="co">#&gt;  5:     2023-05              797                 418.61                   458.0</span></span>
<span><span class="co">#&gt;  6:     2023-06              640                 400.50                   418.7</span></span>
<span><span class="co">#&gt;  7:     2023-07              573                 373.78                   393.7</span></span>
<span><span class="co">#&gt;  8:     2023-08              451                 354.58                   356.5</span></span>
<span><span class="co">#&gt;  9:     2023-09              366                 342.35                   336.0</span></span>
<span><span class="co">#&gt; 10:     2023-10              310                 326.32                   289.0</span></span>
<span><span class="co">#&gt; 11:     2023-11              218                 323.99                   274.6</span></span>
<span><span class="co">#&gt; 12:     2023-12              192                 277.01                   260.5</span></span>
<span><span class="co">#&gt;     valor_por_dia_promedio</span></span>
<span><span class="co">#&gt;                      &lt;num&gt;</span></span>
<span><span class="co">#&gt;  1:                   1.71</span></span>
<span><span class="co">#&gt;  2:                   1.81</span></span>
<span><span class="co">#&gt;  3:                   2.11</span></span>
<span><span class="co">#&gt;  4:                   2.59</span></span>
<span><span class="co">#&gt;  5:                   2.89</span></span>
<span><span class="co">#&gt;  6:                   2.14</span></span>
<span><span class="co">#&gt;  7:                   4.20</span></span>
<span><span class="co">#&gt;  8:                   3.89</span></span>
<span><span class="co">#&gt;  9:                   5.20</span></span>
<span><span class="co">#&gt; 10:                   7.84</span></span>
<span><span class="co">#&gt; 11:                   6.48</span></span>
<span><span class="co">#&gt; 12:                   5.16</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="ejercicio-final-aplicación-completa-de-producción" class="level2" data-number="12.6"><h2 data-number="12.6" class="anchored" data-anchor-id="ejercicio-final-aplicación-completa-de-producción">
<span class="header-section-number">12.6</span> Ejercicio Final: Aplicación Completa de Producción</h2>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
🏋️ Ejercicio 10: Sistema de Analytics Empresarial
</div>
</div>
<div class="callout-body-container callout-body">
<p>Diseña un sistema completo que integre:</p>
<ol type="1">
<li>
<strong>Pipeline de datos</strong> con data.table</li>
<li>
<strong>Dashboard Shiny</strong> interactivo</li>
<li>
<strong>Modelo predictivo</strong> con tidymodels</li>
<li><strong>Alertas automáticas</strong></li>
<li><strong>Reportes ejecutivos</strong></li>
</ol>
<p>Usa los datasets de clientes, transacciones y sensores como base.</p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
💡 Solución del Ejercicio 10
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># === PIPELINE DE DATOS UNIFICADO ===</span></span>
<span><span class="va">crear_pipeline_analytics</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># 1. CONSOLIDACIÓN DE DATOS</span></span>
<span>  <span class="va">pipeline_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Métricas de clientes</span></span>
<span>  <span class="va">pipeline_data</span><span class="op">$</span><span class="va">clientes_kpis</span> <span class="op">&lt;-</span> <span class="va">datos_clientes</span><span class="op">[</span>,</span>
<span>    <span class="fu">.</span><span class="op">(</span></span>
<span>      clientes_total <span class="op">=</span> <span class="va">.N</span>,</span>
<span>      valor_total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">valor_cliente</span><span class="op">)</span>,</span>
<span>      churn_rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">churn_flag</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>      satisfaccion_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">satisfaccion</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>      engagement_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">engagement_score</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">region</span>, <span class="va">categoria_ingresos</span><span class="op">)</span></span>
<span>  <span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Métricas de transacciones</span></span>
<span>  <span class="va">pipeline_data</span><span class="op">$</span><span class="va">transacciones_kpis</span> <span class="op">&lt;-</span> <span class="va">transacciones_detalle</span><span class="op">[</span></span>
<span>    <span class="va">fecha_transaccion</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">90</span>,  <span class="co"># Últimos 90 días</span></span>
<span>    <span class="fu">.</span><span class="op">(</span></span>
<span>      revenue_total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">monto_final</span><span class="op">)</span>,</span>
<span>      transacciones_total <span class="op">=</span> <span class="va">.N</span>,</span>
<span>      ticket_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">monto_final</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>      clientes_activos <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/duplicated.html">uniqueN</a></span><span class="op">(</span><span class="va">cliente_id</span><span class="op">)</span>,</span>
<span>      productos_vendidos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">es_devolucion</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span>mes <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/IDateTime.html">month</a></span><span class="op">(</span><span class="va">fecha_transaccion</span><span class="op">)</span>, <span class="va">producto_categoria</span><span class="op">)</span></span>
<span>  <span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Estado de sensores IoT</span></span>
<span>  <span class="va">pipeline_data</span><span class="op">$</span><span class="va">sensores_status</span> <span class="op">&lt;-</span> <span class="va">sensores_iot</span><span class="op">[</span></span>
<span>    <span class="va">fecha</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">7</span>,  <span class="co"># Última semana</span></span>
<span>    <span class="fu">.</span><span class="op">(</span></span>
<span>      sensores_activos <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/duplicated.html">uniqueN</a></span><span class="op">(</span><span class="va">sensor_id</span><span class="op">)</span>,</span>
<span>      alertas_criticas <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">alerta_temperatura</span> <span class="op">+</span> <span class="va">alerta_bateria</span> <span class="op">+</span> <span class="va">alerta_humedad</span><span class="op">)</span>,</span>
<span>      uptime_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">temperatura</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>      score_salud <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">-</span> <span class="va">alerta_temperatura</span> <span class="op">*</span> <span class="fl">20</span> <span class="op">-</span> <span class="va">alerta_bateria</span> <span class="op">*</span> <span class="fl">30</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="va">fecha</span></span>
<span>  <span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># 2. ALERTAS AUTOMÁTICAS</span></span>
<span>  <span class="va">alertas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Alerta de churn elevado</span></span>
<span>  <span class="va">alertas</span><span class="op">$</span><span class="va">churn_critico</span> <span class="op">&lt;-</span> <span class="va">pipeline_data</span><span class="op">$</span><span class="va">clientes_kpis</span><span class="op">[</span></span>
<span>    <span class="va">churn_rate</span> <span class="op">&gt;</span> <span class="fl">15</span>,</span>
<span>    <span class="fu">.</span><span class="op">(</span><span class="va">region</span>, <span class="va">categoria_ingresos</span>, <span class="va">churn_rate</span>, <span class="va">valor_total</span><span class="op">)</span></span>
<span>  <span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Alerta de caída de revenue</span></span>
<span>  <span class="va">alertas</span><span class="op">$</span><span class="va">revenue_bajo</span> <span class="op">&lt;-</span> <span class="va">pipeline_data</span><span class="op">$</span><span class="va">transacciones_kpis</span><span class="op">[</span>,</span>
<span>    <span class="fu">.</span><span class="op">(</span>revenue_cambio <span class="op">=</span> <span class="op">(</span><span class="va">revenue_total</span> <span class="op">/</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/shift.html">shift</a></span><span class="op">(</span><span class="va">revenue_total</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="va">producto_categoria</span></span>
<span>  <span class="op">]</span><span class="op">[</span><span class="va">revenue_cambio</span> <span class="op">&lt;</span> <span class="op">-</span><span class="fl">10</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">revenue_cambio</span><span class="op">)</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Alerta de sensores críticos</span></span>
<span>  <span class="va">alertas</span><span class="op">$</span><span class="va">sensores_criticos</span> <span class="op">&lt;-</span> <span class="va">pipeline_data</span><span class="op">$</span><span class="va">sensores_status</span><span class="op">[</span></span>
<span>    <span class="va">score_salud</span> <span class="op">&lt;</span> <span class="fl">80</span> <span class="op">|</span> <span class="va">alertas_criticas</span> <span class="op">&gt;</span> <span class="fl">10</span></span>
<span>  <span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># 3. DASHBOARD SUMMARY</span></span>
<span>  <span class="va">dashboard_summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    kpis_generales <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>      clientes_total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">pipeline_data</span><span class="op">$</span><span class="va">clientes_kpis</span><span class="op">$</span><span class="va">clientes_total</span><span class="op">)</span>,</span>
<span>      revenue_total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">pipeline_data</span><span class="op">$</span><span class="va">transacciones_kpis</span><span class="op">$</span><span class="va">revenue_total</span><span class="op">)</span>,</span>
<span>      churn_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span><span class="op">(</span><span class="va">pipeline_data</span><span class="op">$</span><span class="va">clientes_kpis</span><span class="op">$</span><span class="va">churn_rate</span>, </span>
<span>                                          <span class="va">pipeline_data</span><span class="op">$</span><span class="va">clientes_kpis</span><span class="op">$</span><span class="va">clientes_total</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>      alertas_activas <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">alertas</span><span class="op">$</span><span class="va">churn_critico</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">alertas</span><span class="op">$</span><span class="va">revenue_bajo</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">alertas</span><span class="op">$</span><span class="va">sensores_criticos</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    alertas_activas <span class="op">=</span> <span class="va">alertas</span>,</span>
<span>    datos_pipeline <span class="op">=</span> <span class="va">pipeline_data</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">dashboard_summary</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Ejecutar pipeline</span></span>
<span><span class="va">sistema_analytics</span> <span class="op">&lt;-</span> <span class="fu">crear_pipeline_analytics</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># === REPORTE EJECUTIVO AUTOMÁTICO ===</span></span>
<span><span class="va">generar_reporte_ejecutivo</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">analytics_data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"                    📊 REPORTE EJECUTIVO EMPRESARIAL                     \n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">kpis</span> <span class="op">&lt;-</span> <span class="va">analytics_data</span><span class="op">$</span><span class="va">kpis_generales</span></span>
<span>  <span class="va">alertas</span> <span class="op">&lt;-</span> <span class="va">analytics_data</span><span class="op">$</span><span class="va">alertas_activas</span></span>
<span>  </span>
<span>  <span class="co"># KPIs principales</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"📈 INDICADORES CLAVE DE RENDIMIENTO:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"   • Total de Clientes:"</span>, <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/comma.html">comma</a></span><span class="op">(</span><span class="va">kpis</span><span class="op">$</span><span class="va">clientes_total</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"   • Revenue Total:"</span>, <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/dollar_format.html">dollar</a></span><span class="op">(</span><span class="va">kpis</span><span class="op">$</span><span class="va">revenue_total</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"   • Tasa de Churn Promedio:"</span>, <span class="va">kpis</span><span class="op">$</span><span class="va">churn_promedio</span>, <span class="st">"%\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"   • Alertas Activas:"</span>, <span class="va">kpis</span><span class="op">$</span><span class="va">alertas_activas</span>, <span class="st">"\n\n"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Estado de alertas</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"🚨 ESTADO DE ALERTAS:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"   • Regiones con Churn Crítico:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">alertas</span><span class="op">$</span><span class="va">churn_critico</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"   • Productos con Revenue Bajo:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">alertas</span><span class="op">$</span><span class="va">revenue_bajo</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"   • Sensores en Estado Crítico:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">alertas</span><span class="op">$</span><span class="va">sensores_criticos</span><span class="op">)</span>, <span class="st">"\n\n"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Recomendaciones automáticas</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"💡 RECOMENDACIONES AUTOMÁTICAS:\n"</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">alertas</span><span class="op">$</span><span class="va">churn_critico</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"   • ACCIÓN INMEDIATA: Implementar programa de retención en regiones críticas\n"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">alertas</span><span class="op">$</span><span class="va">revenue_bajo</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"   • ANÁLISIS REQUERIDO: Investigar caída de ventas en productos específicos\n"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">alertas</span><span class="op">$</span><span class="va">sensores_criticos</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"   • MANTENIMIENTO: Revisar sensores con bajo score de salud\n"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">kpis</span><span class="op">$</span><span class="va">alertas_activas</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"   • ✅ SISTEMA SALUDABLE: Todos los indicadores dentro de rangos normales\n"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Reporte generado automáticamente:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"%Y-%m-%d %H:%M:%S"</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Generar reporte</span></span>
<span><span class="fu">generar_reporte_ejecutivo</span><span class="op">(</span><span class="va">sistema_analytics</span><span class="op">)</span></span>
<span><span class="co">#&gt; ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span></span>
<span><span class="co">#&gt;                     📊 REPORTE EJECUTIVO EMPRESARIAL                     </span></span>
<span><span class="co">#&gt; ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 📈 INDICADORES CLAVE DE RENDIMIENTO:</span></span>
<span><span class="co">#&gt;    • Total de Clientes: 10,000 </span></span>
<span><span class="co">#&gt;    • Revenue Total: $0 </span></span>
<span><span class="co">#&gt;    • Tasa de Churn Promedio: 12.1 %</span></span>
<span><span class="co">#&gt;    • Alertas Activas: 4 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 🚨 ESTADO DE ALERTAS:</span></span>
<span><span class="co">#&gt;    • Regiones con Churn Crítico: 0 </span></span>
<span><span class="co">#&gt;    • Productos con Revenue Bajo: 0 </span></span>
<span><span class="co">#&gt;    • Sensores en Estado Crítico: 0 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 💡 RECOMENDACIONES AUTOMÁTICAS:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span></span>
<span><span class="co">#&gt; Reporte generado automáticamente: 2025-08-21 01:32:29 </span></span>
<span><span class="co">#&gt; ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span></span>
<span></span>
<span><span class="co"># === MÉTRICAS DETALLADAS ===</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\n📊 DETALLE DE ALERTAS CRÍTICAS:\n\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 📊 DETALLE DE ALERTAS CRÍTICAS:</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">sistema_analytics</span><span class="op">$</span><span class="va">alertas_activas</span><span class="op">$</span><span class="va">churn_critico</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"🔴 CHURN CRÍTICO POR REGIÓN:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">sistema_analytics</span><span class="op">$</span><span class="va">alertas_activas</span><span class="op">$</span><span class="va">churn_critico</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">sistema_analytics</span><span class="op">$</span><span class="va">alertas_activas</span><span class="op">$</span><span class="va">revenue_bajo</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"📉 PRODUCTOS CON REVENUE BAJO:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">sistema_analytics</span><span class="op">$</span><span class="va">alertas_activas</span><span class="op">$</span><span class="va">revenue_bajo</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">sistema_analytics</span><span class="op">$</span><span class="va">alertas_activas</span><span class="op">$</span><span class="va">sensores_criticos</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"⚠️ SENSORES EN ESTADO CRÍTICO:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">sistema_analytics</span><span class="op">$</span><span class="va">alertas_activas</span><span class="op">$</span><span class="va">sensores_criticos</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Componentes del Sistema Completo:</strong></p>
<ol type="1">
<li>
<strong>Pipeline de Datos</strong>: Consolidación automática de múltiples fuentes</li>
<li>
<strong>Sistema de Alertas</strong>: Detección automática de anomalías</li>
<li>
<strong>Dashboard KPIs</strong>: Métricas en tiempo real</li>
<li>
<strong>Reporte Ejecutivo</strong>: Generación automática de insights</li>
<li>
<strong>Recomendaciones</strong>: Acciones basadas en datos</li>
<li>
<strong>Escalabilidad</strong>: Modular y extensible</li>
</ol>
</div>
</div>
</div>
<hr>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
🎯 Puntos Clave de Este Capítulo
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>
<strong>Shiny + data.table</strong> = Aplicaciones web ultrarrápidas y responsivas</li>
<li>
<strong>tidymodels</strong> se integra perfectamente con data.table para ML robusto</li>
<li>
<strong>dtplyr</strong> facilita la transición desde dplyr manteniendo performance</li>
<li>
<strong>fread/fwrite</strong> son las herramientas más rápidas de R para I/O</li>
<li>
<strong>Bases de datos</strong> + data.table = Workflow híbrido óptimo</li>
<li>
<strong>Casos reales</strong> demuestran la versatilidad industrial de data.table</li>
<li>
<strong>Sistemas completos</strong> integran múltiples componentes de forma modular</li>
</ol>
</div>
</div>
<p>Has completado tu formación integral en aplicaciones del mundo real con <code>data.table</code>. Ahora tienes las herramientas para construir sistemas completos de analytics empresarial de nivel industrial.</p>


<!-- -->

</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/tutorial-datatable\.github\.io\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./cap05-visualizacion.html" class="pagination-link" aria-label="Visualización de Datos con data.table">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Visualización de Datos con data.table</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./conclusion.html" class="pagination-link" aria-label="Conclusiones y Próximos Pasos">
        <span class="nav-page-text">Conclusiones y Próximos Pasos</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb14" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Aplicaciones del Mundo Real {#sec-aplicaciones}</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip icon="false"}</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="fu">## En este capítulo dominarás</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Aplicaciones Shiny** escalables con data.table</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Integración con tidymodels** para machine learning robusto</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Conexión con bases de datos** y ecosistemas Big Data</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**dtplyr**: El puente entre data.table y tidyverse</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Casos de uso industriales** reales y prácticos</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup-cap05-app</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DT)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Paquetes adicionales para ejemplos (cargar condicionalmente)</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">requireNamespace</span>(<span class="st">"shiny"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">library</span>(shiny)</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">requireNamespace</span>(<span class="st">"dtplyr"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">library</span>(dtplyr)</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Configuración</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">datatable.print.nrows =</span> <span class="dv">8</span>)</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">datatable.print.class =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Datasets para aplicaciones del mundo real</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2024</span>)</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Dataset de clientes para machine learning</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>datos_clientes <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">cliente_id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10000</span>,</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">edad =</span> <span class="fu">pmax</span>(<span class="dv">18</span>, <span class="fu">pmin</span>(<span class="dv">80</span>, <span class="fu">round</span>(<span class="fu">rnorm</span>(<span class="dv">10000</span>, <span class="dv">42</span>, <span class="dv">15</span>)))),</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">ingresos =</span> <span class="fu">pmax</span>(<span class="dv">20000</span>, <span class="fu">round</span>(<span class="fu">exp</span>(<span class="fu">rnorm</span>(<span class="dv">10000</span>, <span class="fl">10.8</span>, <span class="fl">0.6</span>)))),</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">antiguedad_meses =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">120</span>, <span class="dv">10000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">num_productos =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>, <span class="dv">10000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.3</span>, <span class="fl">0.25</span>, <span class="fl">0.2</span>, <span class="fl">0.1</span>, <span class="fl">0.08</span>, <span class="fl">0.04</span>, <span class="fl">0.02</span>, <span class="fl">0.01</span>)),</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">region =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Norte"</span>, <span class="st">"Sur"</span>, <span class="st">"Este"</span>, <span class="st">"Oeste"</span>, <span class="st">"Centro"</span>), <span class="dv">10000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>  <span class="at">canal_preferido =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Online"</span>, <span class="st">"Tienda"</span>, <span class="st">"Teléfono"</span>, <span class="st">"App"</span>), <span class="dv">10000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.45</span>, <span class="fl">0.3</span>, <span class="fl">0.15</span>, <span class="fl">0.1</span>)),</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">satisfaccion =</span> <span class="fu">round</span>(<span class="fu">runif</span>(<span class="dv">10000</span>, <span class="dv">1</span>, <span class="dv">5</span>), <span class="dv">1</span>),</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>  num_quejas_ultimo_año <span class="ot">=</span> <span class="fu">rpois</span>(<span class="dv">10000</span>, <span class="fl">0.8</span>),</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">uso_app_mensual =</span> <span class="fu">pmax</span>(<span class="dv">0</span>, <span class="fu">round</span>(<span class="fu">rnorm</span>(<span class="dv">10000</span>, <span class="dv">12</span>, <span class="dv">8</span>))),</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>  <span class="at">transacciones_ultimo_mes =</span> <span class="fu">rpois</span>(<span class="dv">10000</span>, <span class="dv">3</span>),</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">churn_flag =</span> <span class="fu">rbinom</span>(<span class="dv">10000</span>, <span class="dv">1</span>, <span class="fl">0.12</span>)  <span class="co"># 12% de churn</span></span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear features engineered</span></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>datos_clientes[, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>  <span class="at">valor_cliente =</span> (ingresos <span class="sc">*</span> antiguedad_meses <span class="sc">*</span> num_productos) <span class="sc">/</span> <span class="dv">100000</span>,</span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>  <span class="at">engagement_score =</span> <span class="fu">pmin</span>(<span class="dv">10</span>, (num_productos <span class="sc">*</span> <span class="dv">2</span> <span class="sc">+</span> uso_app_mensual <span class="sc">/</span> <span class="dv">5</span> <span class="sc">+</span> transacciones_ultimo_mes <span class="sc">+</span> (<span class="dv">5</span> <span class="sc">-</span> satisfaccion) <span class="sc">*</span> <span class="sc">-</span><span class="dv">1</span>)),</span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>  <span class="at">categoria_edad =</span> <span class="fu">cut</span>(edad, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">30</span>, <span class="dv">45</span>, <span class="dv">60</span>, <span class="dv">100</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Joven"</span>, <span class="st">"Adulto_Joven"</span>, <span class="st">"Adulto"</span>, <span class="st">"Senior"</span>)),</span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>  <span class="at">categoria_ingresos =</span> <span class="fu">cut</span>(ingresos, <span class="fu">quantile</span>(ingresos, <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.33</span>, <span class="fl">0.66</span>, <span class="dv">1</span>)), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Bajo"</span>, <span class="st">"Medio"</span>, <span class="st">"Alto"</span>), <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>datos_clientes[, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>  <span class="at">riesgo_churn =</span> <span class="fu">as.numeric</span>(num_quejas_ultimo_año <span class="sc">&gt;</span> <span class="dv">2</span> <span class="sc">|</span> satisfaccion <span class="sc">&lt;</span> <span class="dv">3</span> <span class="sc">|</span> engagement_score <span class="sc">&lt;</span> <span class="dv">4</span>),</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>  <span class="at">cliente_vip =</span> <span class="fu">as.numeric</span>(valor_cliente <span class="sc">&gt;</span> <span class="fu">quantile</span>(valor_cliente, <span class="fl">0.9</span>) <span class="sc">&amp;</span> satisfaccion <span class="sc">&gt;=</span> <span class="dv">4</span>))]</span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Dataset de transacciones para análisis temporal</span></span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>transacciones_detalle <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>  <span class="at">transaccion_id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">50000</span>,</span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>  <span class="at">cliente_id =</span> <span class="fu">sample</span>(datos_clientes<span class="sc">$</span>cliente_id, <span class="dv">50000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>  <span class="at">fecha_transaccion =</span> <span class="fu">sample</span>(<span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">"2023-01-01"</span>), <span class="fu">as.Date</span>(<span class="st">"2024-12-31"</span>), <span class="at">by =</span> <span class="st">"day"</span>), <span class="dv">50000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>  <span class="at">producto_categoria =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Electronics"</span>, <span class="st">"Clothing"</span>, <span class="st">"Books"</span>, <span class="st">"Home"</span>, <span class="st">"Sports"</span>, <span class="st">"Beauty"</span>), <span class="dv">50000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>  <span class="at">monto =</span> <span class="fu">round</span>(<span class="fu">rexp</span>(<span class="dv">50000</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">75</span>) <span class="sc">+</span> <span class="dv">10</span>, <span class="dv">2</span>),</span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>  <span class="at">canal =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Online"</span>, <span class="st">"Tienda"</span>, <span class="st">"App"</span>, <span class="st">"Teléfono"</span>), <span class="dv">50000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.4</span>, <span class="fl">0.35</span>, <span class="fl">0.2</span>, <span class="fl">0.05</span>)),</span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>  <span class="at">metodo_pago =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Tarjeta_Credito"</span>, <span class="st">"Tarjeta_Debito"</span>, <span class="st">"Efectivo"</span>, <span class="st">"Digital"</span>), <span class="dv">50000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.45</span>, <span class="fl">0.25</span>, <span class="fl">0.2</span>, <span class="fl">0.1</span>)),</span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>  <span class="at">descuento_aplicado =</span> <span class="fu">rbinom</span>(<span class="dv">50000</span>, <span class="dv">1</span>, <span class="fl">0.3</span>) <span class="sc">*</span> <span class="fu">runif</span>(<span class="dv">50000</span>, <span class="fl">0.05</span>, <span class="fl">0.25</span>),</span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>  <span class="at">es_devolucion =</span> <span class="fu">rbinom</span>(<span class="dv">50000</span>, <span class="dv">1</span>, <span class="fl">0.08</span>)</span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear métricas derivadas</span></span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a>transacciones_detalle[, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a>  <span class="at">monto_final =</span> monto <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> descuento_aplicado),</span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>  año <span class="ot">=</span> <span class="fu">year</span>(fecha_transaccion),</span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a>  <span class="at">mes =</span> <span class="fu">month</span>(fecha_transaccion),</span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a>  <span class="at">trimestre =</span> <span class="fu">quarter</span>(fecha_transaccion),</span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a>  <span class="at">dia_semana =</span> <span class="fu">wday</span>(fecha_transaccion, <span class="at">label =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a>  <span class="at">es_fin_semana =</span> <span class="fu">wday</span>(fecha_transaccion) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">7</span>),</span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a>  <span class="at">hora_estimada =</span> <span class="fu">sample</span>(<span class="dv">8</span><span class="sc">:</span><span class="dv">22</span>, <span class="dv">50000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)  <span class="co"># Hora estimada de compra</span></span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a><span class="co"># Dataset de sensores IoT para análisis en tiempo real</span></span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a>sensores_iot <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a>  <span class="at">timestamp =</span> <span class="fu">seq</span>(<span class="fu">as.POSIXct</span>(<span class="st">"2024-01-01 00:00:00"</span>), </span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">as.POSIXct</span>(<span class="st">"2024-01-31 23:59:00"</span>), <span class="at">by =</span> <span class="st">"5 min"</span>),</span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a>  <span class="at">sensor_id =</span> <span class="fu">rep</span>(<span class="fu">paste0</span>(<span class="st">"SENSOR_"</span>, <span class="fu">sprintf</span>(<span class="st">"%03d"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>)), <span class="at">length.out =</span> <span class="dv">8928</span>),</span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a>  <span class="at">temperatura =</span> <span class="fu">round</span>(<span class="fu">rnorm</span>(<span class="dv">8928</span>, <span class="dv">22</span>, <span class="dv">4</span>), <span class="dv">2</span>),</span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a>  <span class="at">humedad =</span> <span class="fu">pmax</span>(<span class="dv">20</span>, <span class="fu">pmin</span>(<span class="dv">90</span>, <span class="fu">round</span>(<span class="fu">rnorm</span>(<span class="dv">8928</span>, <span class="dv">45</span>, <span class="dv">15</span>), <span class="dv">1</span>))),</span>
<span id="cb14-94"><a href="#cb14-94" aria-hidden="true" tabindex="-1"></a>  <span class="at">presion =</span> <span class="fu">round</span>(<span class="fu">rnorm</span>(<span class="dv">8928</span>, <span class="dv">1013</span>, <span class="dv">8</span>), <span class="dv">1</span>),</span>
<span id="cb14-95"><a href="#cb14-95" aria-hidden="true" tabindex="-1"></a>  <span class="at">luminosidad =</span> <span class="fu">pmax</span>(<span class="dv">0</span>, <span class="fu">round</span>(<span class="fu">rnorm</span>(<span class="dv">8928</span>, <span class="dv">500</span>, <span class="dv">200</span>))),</span>
<span id="cb14-96"><a href="#cb14-96" aria-hidden="true" tabindex="-1"></a>  <span class="at">movimiento_detectado =</span> <span class="fu">rbinom</span>(<span class="dv">8928</span>, <span class="dv">1</span>, <span class="fl">0.15</span>),</span>
<span id="cb14-97"><a href="#cb14-97" aria-hidden="true" tabindex="-1"></a>  <span class="at">nivel_bateria =</span> <span class="fu">pmax</span>(<span class="dv">5</span>, <span class="fu">pmin</span>(<span class="dv">100</span>, <span class="fu">round</span>(<span class="fu">rnorm</span>(<span class="dv">8928</span>, <span class="dv">85</span>, <span class="dv">20</span>))))</span>
<span id="cb14-98"><a href="#cb14-98" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-99"><a href="#cb14-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-100"><a href="#cb14-100" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear alertas y anomalías</span></span>
<span id="cb14-101"><a href="#cb14-101" aria-hidden="true" tabindex="-1"></a>sensores_iot[, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-102"><a href="#cb14-102" aria-hidden="true" tabindex="-1"></a>  <span class="at">fecha =</span> <span class="fu">as.Date</span>(timestamp),</span>
<span id="cb14-103"><a href="#cb14-103" aria-hidden="true" tabindex="-1"></a>  <span class="at">hora =</span> <span class="fu">hour</span>(timestamp),</span>
<span id="cb14-104"><a href="#cb14-104" aria-hidden="true" tabindex="-1"></a>  <span class="at">alerta_temperatura =</span> <span class="fu">as.numeric</span>(temperatura <span class="sc">&gt;</span> <span class="dv">30</span> <span class="sc">|</span> temperatura <span class="sc">&lt;</span> <span class="dv">10</span>),</span>
<span id="cb14-105"><a href="#cb14-105" aria-hidden="true" tabindex="-1"></a>  <span class="at">alerta_bateria =</span> <span class="fu">as.numeric</span>(nivel_bateria <span class="sc">&lt;</span> <span class="dv">20</span>),</span>
<span id="cb14-106"><a href="#cb14-106" aria-hidden="true" tabindex="-1"></a>  <span class="at">alerta_humedad =</span> <span class="fu">as.numeric</span>(humedad <span class="sc">&gt;</span> <span class="dv">80</span> <span class="sc">|</span> humedad <span class="sc">&lt;</span> <span class="dv">30</span>),</span>
<span id="cb14-107"><a href="#cb14-107" aria-hidden="true" tabindex="-1"></a>  <span class="at">estado_sensor =</span> <span class="fu">fifelse</span>(nivel_bateria <span class="sc">&lt;</span> <span class="dv">10</span>, <span class="st">"Crítico"</span>,</span>
<span id="cb14-108"><a href="#cb14-108" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">fifelse</span>(nivel_bateria <span class="sc">&lt;</span> <span class="dv">30</span>, <span class="st">"Advertencia"</span>, <span class="st">"Normal"</span>))</span>
<span id="cb14-109"><a href="#cb14-109" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb14-110"><a href="#cb14-110" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-111"><a href="#cb14-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-112"><a href="#cb14-112" aria-hidden="true" tabindex="-1"></a><span class="fu">## Aplicaciones Shiny Escalables con data.table</span></span>
<span id="cb14-113"><a href="#cb14-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-114"><a href="#cb14-114" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1. **Arquitectura de App Shiny Profesional**</span></span>
<span id="cb14-115"><a href="#cb14-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-118"><a href="#cb14-118" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-119"><a href="#cb14-119" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: shiny-arquitectura</span></span>
<span id="cb14-120"><a href="#cb14-120" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb14-121"><a href="#cb14-121" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb14-122"><a href="#cb14-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-123"><a href="#cb14-123" aria-hidden="true" tabindex="-1"></a><span class="co"># Estructura modular para apps grandes</span></span>
<span id="cb14-124"><a href="#cb14-124" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(shiny)</span>
<span id="cb14-125"><a href="#cb14-125" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(shinydashboard)</span>
<span id="cb14-126"><a href="#cb14-126" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb14-127"><a href="#cb14-127" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DT)</span>
<span id="cb14-128"><a href="#cb14-128" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb14-129"><a href="#cb14-129" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plotly)</span>
<span id="cb14-130"><a href="#cb14-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-131"><a href="#cb14-131" aria-hidden="true" tabindex="-1"></a><span class="co"># === MÓDULO: Data Processing ===</span></span>
<span id="cb14-132"><a href="#cb14-132" aria-hidden="true" tabindex="-1"></a><span class="co"># Todas las operaciones data.table en funciones separadas</span></span>
<span id="cb14-133"><a href="#cb14-133" aria-hidden="true" tabindex="-1"></a>process_customer_data <span class="ot">&lt;-</span> <span class="cf">function</span>(clientes_dt, <span class="at">filters =</span> <span class="fu">list</span>()) {</span>
<span id="cb14-134"><a href="#cb14-134" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Aplicar filtros dinámicamente</span></span>
<span id="cb14-135"><a href="#cb14-135" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> clientes_dt</span>
<span id="cb14-136"><a href="#cb14-136" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-137"><a href="#cb14-137" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(filters<span class="sc">$</span>region) <span class="sc">&amp;&amp;</span> filters<span class="sc">$</span>region <span class="sc">!=</span> <span class="st">"Todos"</span>) {</span>
<span id="cb14-138"><a href="#cb14-138" aria-hidden="true" tabindex="-1"></a>    result <span class="ot">&lt;-</span> result[region <span class="sc">==</span> filters<span class="sc">$</span>region]</span>
<span id="cb14-139"><a href="#cb14-139" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-140"><a href="#cb14-140" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-141"><a href="#cb14-141" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(filters<span class="sc">$</span>edad_min)) {</span>
<span id="cb14-142"><a href="#cb14-142" aria-hidden="true" tabindex="-1"></a>    result <span class="ot">&lt;-</span> result[edad <span class="sc">&gt;=</span> filters<span class="sc">$</span>edad_min]</span>
<span id="cb14-143"><a href="#cb14-143" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-144"><a href="#cb14-144" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-145"><a href="#cb14-145" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(filters<span class="sc">$</span>fecha_desde)) {</span>
<span id="cb14-146"><a href="#cb14-146" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aquí se aplicarían filtros de fecha si tuviéramos esos datos</span></span>
<span id="cb14-147"><a href="#cb14-147" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-148"><a href="#cb14-148" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-149"><a href="#cb14-149" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb14-150"><a href="#cb14-150" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-151"><a href="#cb14-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-152"><a href="#cb14-152" aria-hidden="true" tabindex="-1"></a>calculate_customer_metrics <span class="ot">&lt;-</span> <span class="cf">function</span>(clientes_dt) {</span>
<span id="cb14-153"><a href="#cb14-153" aria-hidden="true" tabindex="-1"></a>  clientes_dt[,</span>
<span id="cb14-154"><a href="#cb14-154" aria-hidden="true" tabindex="-1"></a>    .(</span>
<span id="cb14-155"><a href="#cb14-155" aria-hidden="true" tabindex="-1"></a>      <span class="at">total_clientes =</span> .N,</span>
<span id="cb14-156"><a href="#cb14-156" aria-hidden="true" tabindex="-1"></a>      <span class="at">edad_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(edad), <span class="dv">1</span>),</span>
<span id="cb14-157"><a href="#cb14-157" aria-hidden="true" tabindex="-1"></a>      <span class="at">ingresos_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(ingresos), <span class="dv">0</span>),</span>
<span id="cb14-158"><a href="#cb14-158" aria-hidden="true" tabindex="-1"></a>      <span class="at">satisfaccion_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(satisfaccion), <span class="dv">2</span>),</span>
<span id="cb14-159"><a href="#cb14-159" aria-hidden="true" tabindex="-1"></a>      <span class="at">churn_rate =</span> <span class="fu">round</span>(<span class="fu">mean</span>(churn_flag) <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>),</span>
<span id="cb14-160"><a href="#cb14-160" aria-hidden="true" tabindex="-1"></a>      <span class="at">valor_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(valor_cliente), <span class="dv">2</span>),</span>
<span id="cb14-161"><a href="#cb14-161" aria-hidden="true" tabindex="-1"></a>      <span class="at">engagement_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(engagement_score), <span class="dv">2</span>)</span>
<span id="cb14-162"><a href="#cb14-162" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb14-163"><a href="#cb14-163" aria-hidden="true" tabindex="-1"></a>    by <span class="ot">=</span> .(region, categoria_ingresos)</span>
<span id="cb14-164"><a href="#cb14-164" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb14-165"><a href="#cb14-165" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-166"><a href="#cb14-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-167"><a href="#cb14-167" aria-hidden="true" tabindex="-1"></a><span class="co"># === UI: Dashboard Layout ===</span></span>
<span id="cb14-168"><a href="#cb14-168" aria-hidden="true" tabindex="-1"></a>ui <span class="ot">&lt;-</span> <span class="fu">dashboardPage</span>(</span>
<span id="cb14-169"><a href="#cb14-169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dashboardHeader</span>(<span class="at">title =</span> <span class="st">"Customer Analytics - Powered by data.table"</span>),</span>
<span id="cb14-170"><a href="#cb14-170" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-171"><a href="#cb14-171" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dashboardSidebar</span>(</span>
<span id="cb14-172"><a href="#cb14-172" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sidebarMenu</span>(</span>
<span id="cb14-173"><a href="#cb14-173" aria-hidden="true" tabindex="-1"></a>      <span class="fu">menuItem</span>(<span class="st">"Overview"</span>, <span class="at">tabName =</span> <span class="st">"overview"</span>, <span class="at">icon =</span> <span class="fu">icon</span>(<span class="st">"dashboard"</span>)),</span>
<span id="cb14-174"><a href="#cb14-174" aria-hidden="true" tabindex="-1"></a>      <span class="fu">menuItem</span>(<span class="st">"Clientes"</span>, <span class="at">tabName =</span> <span class="st">"clientes"</span>, <span class="at">icon =</span> <span class="fu">icon</span>(<span class="st">"users"</span>)),</span>
<span id="cb14-175"><a href="#cb14-175" aria-hidden="true" tabindex="-1"></a>      <span class="fu">menuItem</span>(<span class="st">"Segmentación"</span>, <span class="at">tabName =</span> <span class="st">"segmentacion"</span>, <span class="at">icon =</span> <span class="fu">icon</span>(<span class="st">"chart-pie"</span>)),</span>
<span id="cb14-176"><a href="#cb14-176" aria-hidden="true" tabindex="-1"></a>      <span class="fu">menuItem</span>(<span class="st">"Predicciones"</span>, <span class="at">tabName =</span> <span class="st">"predicciones"</span>, <span class="at">icon =</span> <span class="fu">icon</span>(<span class="st">"brain"</span>)),</span>
<span id="cb14-177"><a href="#cb14-177" aria-hidden="true" tabindex="-1"></a>      <span class="fu">menuItem</span>(<span class="st">"Datos Raw"</span>, <span class="at">tabName =</span> <span class="st">"datos"</span>, <span class="at">icon =</span> <span class="fu">icon</span>(<span class="st">"table"</span>))</span>
<span id="cb14-178"><a href="#cb14-178" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-179"><a href="#cb14-179" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb14-180"><a href="#cb14-180" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-181"><a href="#cb14-181" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dashboardBody</span>(</span>
<span id="cb14-182"><a href="#cb14-182" aria-hidden="true" tabindex="-1"></a>    tags<span class="sc">$</span><span class="fu">head</span>(</span>
<span id="cb14-183"><a href="#cb14-183" aria-hidden="true" tabindex="-1"></a>      tags<span class="sc">$</span><span class="fu">style</span>(<span class="fu">HTML</span>(<span class="st">"</span></span>
<span id="cb14-184"><a href="#cb14-184" aria-hidden="true" tabindex="-1"></a><span class="st">        .content-wrapper, .right-side {</span></span>
<span id="cb14-185"><a href="#cb14-185" aria-hidden="true" tabindex="-1"></a><span class="st">          background-color: #f4f4f4;</span></span>
<span id="cb14-186"><a href="#cb14-186" aria-hidden="true" tabindex="-1"></a><span class="st">        }</span></span>
<span id="cb14-187"><a href="#cb14-187" aria-hidden="true" tabindex="-1"></a><span class="st">        .main-header .navbar {</span></span>
<span id="cb14-188"><a href="#cb14-188" aria-hidden="true" tabindex="-1"></a><span class="st">          background-color: #2E8B57 !important;</span></span>
<span id="cb14-189"><a href="#cb14-189" aria-hidden="true" tabindex="-1"></a><span class="st">        }</span></span>
<span id="cb14-190"><a href="#cb14-190" aria-hidden="true" tabindex="-1"></a><span class="st">      "</span>))</span>
<span id="cb14-191"><a href="#cb14-191" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb14-192"><a href="#cb14-192" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-193"><a href="#cb14-193" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tabItems</span>(</span>
<span id="cb14-194"><a href="#cb14-194" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Tab Overview</span></span>
<span id="cb14-195"><a href="#cb14-195" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tabItem</span>(<span class="at">tabName =</span> <span class="st">"overview"</span>,</span>
<span id="cb14-196"><a href="#cb14-196" aria-hidden="true" tabindex="-1"></a>        <span class="fu">fluidRow</span>(</span>
<span id="cb14-197"><a href="#cb14-197" aria-hidden="true" tabindex="-1"></a>          <span class="fu">valueBoxOutput</span>(<span class="st">"total_clientes"</span>),</span>
<span id="cb14-198"><a href="#cb14-198" aria-hidden="true" tabindex="-1"></a>          <span class="fu">valueBoxOutput</span>(<span class="st">"churn_rate"</span>),</span>
<span id="cb14-199"><a href="#cb14-199" aria-hidden="true" tabindex="-1"></a>          <span class="fu">valueBoxOutput</span>(<span class="st">"valor_promedio"</span>)</span>
<span id="cb14-200"><a href="#cb14-200" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb14-201"><a href="#cb14-201" aria-hidden="true" tabindex="-1"></a>        <span class="fu">fluidRow</span>(</span>
<span id="cb14-202"><a href="#cb14-202" aria-hidden="true" tabindex="-1"></a>          <span class="fu">box</span>(</span>
<span id="cb14-203"><a href="#cb14-203" aria-hidden="true" tabindex="-1"></a>            <span class="at">title =</span> <span class="st">"Filtros Globales"</span>, <span class="at">status =</span> <span class="st">"primary"</span>, <span class="at">solidHeader =</span> <span class="cn">TRUE</span>,</span>
<span id="cb14-204"><a href="#cb14-204" aria-hidden="true" tabindex="-1"></a>            <span class="at">width =</span> <span class="dv">3</span>,</span>
<span id="cb14-205"><a href="#cb14-205" aria-hidden="true" tabindex="-1"></a>            <span class="fu">selectInput</span>(<span class="st">"region_filter"</span>, <span class="st">"Región:"</span>,</span>
<span id="cb14-206"><a href="#cb14-206" aria-hidden="true" tabindex="-1"></a>                       <span class="at">choices =</span> <span class="fu">c</span>(<span class="st">"Todos"</span>, <span class="fu">unique</span>(datos_clientes<span class="sc">$</span>region)),</span>
<span id="cb14-207"><a href="#cb14-207" aria-hidden="true" tabindex="-1"></a>                       <span class="at">selected =</span> <span class="st">"Todos"</span>),</span>
<span id="cb14-208"><a href="#cb14-208" aria-hidden="true" tabindex="-1"></a>            <span class="fu">sliderInput</span>(<span class="st">"edad_range"</span>, <span class="st">"Rango de Edad:"</span>,</span>
<span id="cb14-209"><a href="#cb14-209" aria-hidden="true" tabindex="-1"></a>                       <span class="at">min =</span> <span class="dv">18</span>, <span class="at">max =</span> <span class="dv">80</span>, <span class="at">value =</span> <span class="fu">c</span>(<span class="dv">18</span>, <span class="dv">80</span>)),</span>
<span id="cb14-210"><a href="#cb14-210" aria-hidden="true" tabindex="-1"></a>            <span class="fu">actionButton</span>(<span class="st">"aplicar_filtros"</span>, <span class="st">"Aplicar Filtros"</span>, </span>
<span id="cb14-211"><a href="#cb14-211" aria-hidden="true" tabindex="-1"></a>                        <span class="at">class =</span> <span class="st">"btn-primary"</span>)</span>
<span id="cb14-212"><a href="#cb14-212" aria-hidden="true" tabindex="-1"></a>          ),</span>
<span id="cb14-213"><a href="#cb14-213" aria-hidden="true" tabindex="-1"></a>          <span class="fu">box</span>(</span>
<span id="cb14-214"><a href="#cb14-214" aria-hidden="true" tabindex="-1"></a>            <span class="at">title =</span> <span class="st">"Revenue por Región"</span>, <span class="at">status =</span> <span class="st">"success"</span>, <span class="at">solidHeader =</span> <span class="cn">TRUE</span>,</span>
<span id="cb14-215"><a href="#cb14-215" aria-hidden="true" tabindex="-1"></a>            <span class="at">width =</span> <span class="dv">9</span>,</span>
<span id="cb14-216"><a href="#cb14-216" aria-hidden="true" tabindex="-1"></a>            <span class="fu">plotlyOutput</span>(<span class="st">"revenue_plot"</span>, <span class="at">height =</span> <span class="st">"400px"</span>)</span>
<span id="cb14-217"><a href="#cb14-217" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb14-218"><a href="#cb14-218" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb14-219"><a href="#cb14-219" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb14-220"><a href="#cb14-220" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb14-221"><a href="#cb14-221" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Tab Clientes</span></span>
<span id="cb14-222"><a href="#cb14-222" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tabItem</span>(<span class="at">tabName =</span> <span class="st">"clientes"</span>,</span>
<span id="cb14-223"><a href="#cb14-223" aria-hidden="true" tabindex="-1"></a>        <span class="fu">fluidRow</span>(</span>
<span id="cb14-224"><a href="#cb14-224" aria-hidden="true" tabindex="-1"></a>          <span class="fu">box</span>(</span>
<span id="cb14-225"><a href="#cb14-225" aria-hidden="true" tabindex="-1"></a>            <span class="at">title =</span> <span class="st">"Análisis de Clientes"</span>, <span class="at">status =</span> <span class="st">"primary"</span>, <span class="at">solidHeader =</span> <span class="cn">TRUE</span>,</span>
<span id="cb14-226"><a href="#cb14-226" aria-hidden="true" tabindex="-1"></a>            <span class="at">width =</span> <span class="dv">12</span>,</span>
<span id="cb14-227"><a href="#cb14-227" aria-hidden="true" tabindex="-1"></a>            DT<span class="sc">::</span><span class="fu">dataTableOutput</span>(<span class="st">"clientes_table"</span>)</span>
<span id="cb14-228"><a href="#cb14-228" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb14-229"><a href="#cb14-229" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb14-230"><a href="#cb14-230" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb14-231"><a href="#cb14-231" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb14-232"><a href="#cb14-232" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Tab Segmentación</span></span>
<span id="cb14-233"><a href="#cb14-233" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tabItem</span>(<span class="at">tabName =</span> <span class="st">"segmentacion"</span>,</span>
<span id="cb14-234"><a href="#cb14-234" aria-hidden="true" tabindex="-1"></a>        <span class="fu">fluidRow</span>(</span>
<span id="cb14-235"><a href="#cb14-235" aria-hidden="true" tabindex="-1"></a>          <span class="fu">box</span>(</span>
<span id="cb14-236"><a href="#cb14-236" aria-hidden="true" tabindex="-1"></a>            <span class="at">title =</span> <span class="st">"Segmentación por Valor"</span>, <span class="at">status =</span> <span class="st">"warning"</span>, <span class="at">solidHeader =</span> <span class="cn">TRUE</span>,</span>
<span id="cb14-237"><a href="#cb14-237" aria-hidden="true" tabindex="-1"></a>            <span class="at">width =</span> <span class="dv">6</span>,</span>
<span id="cb14-238"><a href="#cb14-238" aria-hidden="true" tabindex="-1"></a>            <span class="fu">plotOutput</span>(<span class="st">"segmentacion_plot"</span>)</span>
<span id="cb14-239"><a href="#cb14-239" aria-hidden="true" tabindex="-1"></a>          ),</span>
<span id="cb14-240"><a href="#cb14-240" aria-hidden="true" tabindex="-1"></a>          <span class="fu">box</span>(</span>
<span id="cb14-241"><a href="#cb14-241" aria-hidden="true" tabindex="-1"></a>            <span class="at">title =</span> <span class="st">"Matriz de Retención"</span>, <span class="at">status =</span> <span class="st">"info"</span>, <span class="at">solidHeader =</span> <span class="cn">TRUE</span>,</span>
<span id="cb14-242"><a href="#cb14-242" aria-hidden="true" tabindex="-1"></a>            <span class="at">width =</span> <span class="dv">6</span>,</span>
<span id="cb14-243"><a href="#cb14-243" aria-hidden="true" tabindex="-1"></a>            <span class="fu">plotOutput</span>(<span class="st">"matriz_retencion"</span>)</span>
<span id="cb14-244"><a href="#cb14-244" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb14-245"><a href="#cb14-245" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb14-246"><a href="#cb14-246" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb14-247"><a href="#cb14-247" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-248"><a href="#cb14-248" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-249"><a href="#cb14-249" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-250"><a href="#cb14-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-251"><a href="#cb14-251" aria-hidden="true" tabindex="-1"></a><span class="co"># === SERVER: Lógica Reactiva ===</span></span>
<span id="cb14-252"><a href="#cb14-252" aria-hidden="true" tabindex="-1"></a>server <span class="ot">&lt;-</span> <span class="cf">function</span>(input, output, session) {</span>
<span id="cb14-253"><a href="#cb14-253" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-254"><a href="#cb14-254" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Datos reactivos - aquí brilla data.table</span></span>
<span id="cb14-255"><a href="#cb14-255" aria-hidden="true" tabindex="-1"></a>  datos_filtrados <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb14-256"><a href="#cb14-256" aria-hidden="true" tabindex="-1"></a>    input<span class="sc">$</span>aplicar_filtros  <span class="co"># Dependencia del botón</span></span>
<span id="cb14-257"><a href="#cb14-257" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-258"><a href="#cb14-258" aria-hidden="true" tabindex="-1"></a>    <span class="fu">isolate</span>({</span>
<span id="cb14-259"><a href="#cb14-259" aria-hidden="true" tabindex="-1"></a>      filtros <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb14-260"><a href="#cb14-260" aria-hidden="true" tabindex="-1"></a>        <span class="at">region =</span> input<span class="sc">$</span>region_filter,</span>
<span id="cb14-261"><a href="#cb14-261" aria-hidden="true" tabindex="-1"></a>        <span class="at">edad_min =</span> input<span class="sc">$</span>edad_range[<span class="dv">1</span>],</span>
<span id="cb14-262"><a href="#cb14-262" aria-hidden="true" tabindex="-1"></a>        <span class="at">edad_max =</span> input<span class="sc">$</span>edad_range[<span class="dv">2</span>]</span>
<span id="cb14-263"><a href="#cb14-263" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb14-264"><a href="#cb14-264" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb14-265"><a href="#cb14-265" aria-hidden="true" tabindex="-1"></a>      result <span class="ot">&lt;-</span> datos_clientes[</span>
<span id="cb14-266"><a href="#cb14-266" aria-hidden="true" tabindex="-1"></a>        edad <span class="sc">&gt;=</span> filtros<span class="sc">$</span>edad_min <span class="sc">&amp;</span> edad <span class="sc">&lt;=</span> filtros<span class="sc">$</span>edad_max</span>
<span id="cb14-267"><a href="#cb14-267" aria-hidden="true" tabindex="-1"></a>      ]</span>
<span id="cb14-268"><a href="#cb14-268" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb14-269"><a href="#cb14-269" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(filtros<span class="sc">$</span>region <span class="sc">!=</span> <span class="st">"Todos"</span>) {</span>
<span id="cb14-270"><a href="#cb14-270" aria-hidden="true" tabindex="-1"></a>        result <span class="ot">&lt;-</span> result[region <span class="sc">==</span> filtros<span class="sc">$</span>region]</span>
<span id="cb14-271"><a href="#cb14-271" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb14-272"><a href="#cb14-272" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb14-273"><a href="#cb14-273" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(result)</span>
<span id="cb14-274"><a href="#cb14-274" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb14-275"><a href="#cb14-275" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb14-276"><a href="#cb14-276" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-277"><a href="#cb14-277" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ValueBoxes</span></span>
<span id="cb14-278"><a href="#cb14-278" aria-hidden="true" tabindex="-1"></a>  output<span class="sc">$</span>total_clientes <span class="ot">&lt;-</span> <span class="fu">renderValueBox</span>({</span>
<span id="cb14-279"><a href="#cb14-279" aria-hidden="true" tabindex="-1"></a>    <span class="fu">valueBox</span>(</span>
<span id="cb14-280"><a href="#cb14-280" aria-hidden="true" tabindex="-1"></a>      <span class="at">value =</span> <span class="fu">comma</span>(<span class="fu">nrow</span>(<span class="fu">datos_filtrados</span>())),</span>
<span id="cb14-281"><a href="#cb14-281" aria-hidden="true" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="st">"Total Clientes"</span>,</span>
<span id="cb14-282"><a href="#cb14-282" aria-hidden="true" tabindex="-1"></a>      <span class="at">icon =</span> <span class="fu">icon</span>(<span class="st">"users"</span>),</span>
<span id="cb14-283"><a href="#cb14-283" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> <span class="st">"blue"</span></span>
<span id="cb14-284"><a href="#cb14-284" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-285"><a href="#cb14-285" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb14-286"><a href="#cb14-286" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-287"><a href="#cb14-287" aria-hidden="true" tabindex="-1"></a>  output<span class="sc">$</span>churn_rate <span class="ot">&lt;-</span> <span class="fu">renderValueBox</span>({</span>
<span id="cb14-288"><a href="#cb14-288" aria-hidden="true" tabindex="-1"></a>    rate <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">mean</span>(<span class="fu">datos_filtrados</span>()<span class="sc">$</span>churn_flag) <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>)</span>
<span id="cb14-289"><a href="#cb14-289" aria-hidden="true" tabindex="-1"></a>    <span class="fu">valueBox</span>(</span>
<span id="cb14-290"><a href="#cb14-290" aria-hidden="true" tabindex="-1"></a>      <span class="at">value =</span> <span class="fu">paste0</span>(rate, <span class="st">"%"</span>),</span>
<span id="cb14-291"><a href="#cb14-291" aria-hidden="true" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="st">"Tasa de Churn"</span>,</span>
<span id="cb14-292"><a href="#cb14-292" aria-hidden="true" tabindex="-1"></a>      <span class="at">icon =</span> <span class="fu">icon</span>(<span class="st">"exclamation-triangle"</span>),</span>
<span id="cb14-293"><a href="#cb14-293" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> <span class="cf">if</span>(rate <span class="sc">&gt;</span> <span class="dv">15</span>) <span class="st">"red"</span> <span class="cf">else</span> <span class="cf">if</span>(rate <span class="sc">&gt;</span> <span class="dv">10</span>) <span class="st">"yellow"</span> <span class="cf">else</span> <span class="st">"green"</span></span>
<span id="cb14-294"><a href="#cb14-294" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-295"><a href="#cb14-295" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb14-296"><a href="#cb14-296" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-297"><a href="#cb14-297" aria-hidden="true" tabindex="-1"></a>  output<span class="sc">$</span>valor_promedio <span class="ot">&lt;-</span> <span class="fu">renderValueBox</span>({</span>
<span id="cb14-298"><a href="#cb14-298" aria-hidden="true" tabindex="-1"></a>    valor <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">mean</span>(<span class="fu">datos_filtrados</span>()<span class="sc">$</span>valor_cliente), <span class="dv">2</span>)</span>
<span id="cb14-299"><a href="#cb14-299" aria-hidden="true" tabindex="-1"></a>    <span class="fu">valueBox</span>(</span>
<span id="cb14-300"><a href="#cb14-300" aria-hidden="true" tabindex="-1"></a>      <span class="at">value =</span> <span class="fu">dollar</span>(valor),</span>
<span id="cb14-301"><a href="#cb14-301" aria-hidden="true" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="st">"Valor Promedio"</span>,</span>
<span id="cb14-302"><a href="#cb14-302" aria-hidden="true" tabindex="-1"></a>      <span class="at">icon =</span> <span class="fu">icon</span>(<span class="st">"dollar-sign"</span>),</span>
<span id="cb14-303"><a href="#cb14-303" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> <span class="st">"green"</span></span>
<span id="cb14-304"><a href="#cb14-304" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-305"><a href="#cb14-305" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb14-306"><a href="#cb14-306" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-307"><a href="#cb14-307" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Gráfico principal</span></span>
<span id="cb14-308"><a href="#cb14-308" aria-hidden="true" tabindex="-1"></a>  output<span class="sc">$</span>revenue_plot <span class="ot">&lt;-</span> <span class="fu">renderPlotly</span>({</span>
<span id="cb14-309"><a href="#cb14-309" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cálculo super rápido con data.table</span></span>
<span id="cb14-310"><a href="#cb14-310" aria-hidden="true" tabindex="-1"></a>    plot_data <span class="ot">&lt;-</span> <span class="fu">datos_filtrados</span>()[,</span>
<span id="cb14-311"><a href="#cb14-311" aria-hidden="true" tabindex="-1"></a>      .(</span>
<span id="cb14-312"><a href="#cb14-312" aria-hidden="true" tabindex="-1"></a>        <span class="at">valor_total =</span> <span class="fu">sum</span>(valor_cliente),</span>
<span id="cb14-313"><a href="#cb14-313" aria-hidden="true" tabindex="-1"></a>        <span class="at">clientes =</span> .N,</span>
<span id="cb14-314"><a href="#cb14-314" aria-hidden="true" tabindex="-1"></a>        <span class="at">satisfaccion_avg =</span> <span class="fu">round</span>(<span class="fu">mean</span>(satisfaccion), <span class="dv">2</span>)</span>
<span id="cb14-315"><a href="#cb14-315" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb14-316"><a href="#cb14-316" aria-hidden="true" tabindex="-1"></a>      by <span class="ot">=</span> region</span>
<span id="cb14-317"><a href="#cb14-317" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb14-318"><a href="#cb14-318" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-319"><a href="#cb14-319" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_data, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(region, valor_total), <span class="at">y =</span> valor_total)) <span class="sc">+</span></span>
<span id="cb14-320"><a href="#cb14-320" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_col</span>(<span class="fu">aes</span>(<span class="at">fill =</span> satisfaccion_avg), <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb14-321"><a href="#cb14-321" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">dollar</span>(valor_total, <span class="at">scale =</span> <span class="fl">1e-3</span>, <span class="at">suffix =</span> <span class="st">"K"</span>)), </span>
<span id="cb14-322"><a href="#cb14-322" aria-hidden="true" tabindex="-1"></a>               <span class="at">hjust =</span> <span class="sc">-</span><span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb14-323"><a href="#cb14-323" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_fill_viridis_c</span>(<span class="at">name =</span> <span class="st">"Satisfacción</span><span class="sc">\n</span><span class="st">Promedio"</span>) <span class="sc">+</span></span>
<span id="cb14-324"><a href="#cb14-324" aria-hidden="true" tabindex="-1"></a>      <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb14-325"><a href="#cb14-325" aria-hidden="true" tabindex="-1"></a>      <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Valor Total por Región"</span>, <span class="at">x =</span> <span class="st">"Región"</span>, <span class="at">y =</span> <span class="st">"Valor Total"</span>) <span class="sc">+</span></span>
<span id="cb14-326"><a href="#cb14-326" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_minimal</span>()</span>
<span id="cb14-327"><a href="#cb14-327" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-328"><a href="#cb14-328" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplotly</span>(p)</span>
<span id="cb14-329"><a href="#cb14-329" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb14-330"><a href="#cb14-330" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-331"><a href="#cb14-331" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Tabla de clientes</span></span>
<span id="cb14-332"><a href="#cb14-332" aria-hidden="true" tabindex="-1"></a>  output<span class="sc">$</span>clientes_table <span class="ot">&lt;-</span> DT<span class="sc">::</span><span class="fu">renderDataTable</span>({</span>
<span id="cb14-333"><a href="#cb14-333" aria-hidden="true" tabindex="-1"></a>    tabla_data <span class="ot">&lt;-</span> <span class="fu">datos_filtrados</span>()[,</span>
<span id="cb14-334"><a href="#cb14-334" aria-hidden="true" tabindex="-1"></a>      .(</span>
<span id="cb14-335"><a href="#cb14-335" aria-hidden="true" tabindex="-1"></a>        cliente_id, edad, region, </span>
<span id="cb14-336"><a href="#cb14-336" aria-hidden="true" tabindex="-1"></a>        <span class="at">ingresos =</span> <span class="fu">dollar</span>(ingresos),</span>
<span id="cb14-337"><a href="#cb14-337" aria-hidden="true" tabindex="-1"></a>        <span class="at">valor_cliente =</span> <span class="fu">round</span>(valor_cliente, <span class="dv">2</span>),</span>
<span id="cb14-338"><a href="#cb14-338" aria-hidden="true" tabindex="-1"></a>        satisfaccion,</span>
<span id="cb14-339"><a href="#cb14-339" aria-hidden="true" tabindex="-1"></a>        <span class="at">engagement_score =</span> <span class="fu">round</span>(engagement_score, <span class="dv">2</span>),</span>
<span id="cb14-340"><a href="#cb14-340" aria-hidden="true" tabindex="-1"></a>        <span class="at">riesgo_churn =</span> <span class="fu">ifelse</span>(riesgo_churn <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"Alto"</span>, <span class="st">"Bajo"</span>),</span>
<span id="cb14-341"><a href="#cb14-341" aria-hidden="true" tabindex="-1"></a>        <span class="at">es_vip =</span> <span class="fu">ifelse</span>(cliente_vip <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"Sí"</span>, <span class="st">"No"</span>)</span>
<span id="cb14-342"><a href="#cb14-342" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb14-343"><a href="#cb14-343" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb14-344"><a href="#cb14-344" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-345"><a href="#cb14-345" aria-hidden="true" tabindex="-1"></a>    DT<span class="sc">::</span><span class="fu">datatable</span>(</span>
<span id="cb14-346"><a href="#cb14-346" aria-hidden="true" tabindex="-1"></a>      tabla_data,</span>
<span id="cb14-347"><a href="#cb14-347" aria-hidden="true" tabindex="-1"></a>      <span class="at">options =</span> <span class="fu">list</span>(<span class="at">pageLength =</span> <span class="dv">25</span>, <span class="at">scrollX =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-348"><a href="#cb14-348" aria-hidden="true" tabindex="-1"></a>      <span class="at">rownames =</span> <span class="cn">FALSE</span></span>
<span id="cb14-349"><a href="#cb14-349" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb14-350"><a href="#cb14-350" aria-hidden="true" tabindex="-1"></a>      DT<span class="sc">::</span><span class="fu">formatStyle</span>(</span>
<span id="cb14-351"><a href="#cb14-351" aria-hidden="true" tabindex="-1"></a>        <span class="st">"riesgo_churn"</span>,</span>
<span id="cb14-352"><a href="#cb14-352" aria-hidden="true" tabindex="-1"></a>        <span class="at">backgroundColor =</span> DT<span class="sc">::</span><span class="fu">styleEqual</span>(<span class="st">"Alto"</span>, <span class="st">"#ffebee"</span>)</span>
<span id="cb14-353"><a href="#cb14-353" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb14-354"><a href="#cb14-354" aria-hidden="true" tabindex="-1"></a>      DT<span class="sc">::</span><span class="fu">formatStyle</span>(</span>
<span id="cb14-355"><a href="#cb14-355" aria-hidden="true" tabindex="-1"></a>        <span class="st">"es_vip"</span>,</span>
<span id="cb14-356"><a href="#cb14-356" aria-hidden="true" tabindex="-1"></a>        <span class="at">backgroundColor =</span> DT<span class="sc">::</span><span class="fu">styleEqual</span>(<span class="st">"Sí"</span>, <span class="st">"#e8f5e8"</span>)</span>
<span id="cb14-357"><a href="#cb14-357" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb14-358"><a href="#cb14-358" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb14-359"><a href="#cb14-359" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-360"><a href="#cb14-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-361"><a href="#cb14-361" aria-hidden="true" tabindex="-1"></a><span class="co"># Lanzar la app</span></span>
<span id="cb14-362"><a href="#cb14-362" aria-hidden="true" tabindex="-1"></a><span class="co"># shinyApp(ui = ui, server = server)</span></span>
<span id="cb14-363"><a href="#cb14-363" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-364"><a href="#cb14-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-365"><a href="#cb14-365" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2. **Optimización de Performance en Shiny**</span></span>
<span id="cb14-366"><a href="#cb14-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-369"><a href="#cb14-369" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-370"><a href="#cb14-370" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: shiny-performance</span></span>
<span id="cb14-371"><a href="#cb14-371" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb14-372"><a href="#cb14-372" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb14-373"><a href="#cb14-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-374"><a href="#cb14-374" aria-hidden="true" tabindex="-1"></a><span class="co"># === TÉCNICAS DE OPTIMIZACIÓN ===</span></span>
<span id="cb14-375"><a href="#cb14-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-376"><a href="#cb14-376" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Pre-procesar datos pesados al inicio</span></span>
<span id="cb14-377"><a href="#cb14-377" aria-hidden="true" tabindex="-1"></a>onSessionStart <span class="ot">&lt;-</span> <span class="cf">function</span>(session) {</span>
<span id="cb14-378"><a href="#cb14-378" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Cálculos que no cambian frecuentemente</span></span>
<span id="cb14-379"><a href="#cb14-379" aria-hidden="true" tabindex="-1"></a>  session<span class="sc">$</span>userData<span class="sc">$</span>metricas_estaticas <span class="ot">&lt;-</span> datos_clientes[,</span>
<span id="cb14-380"><a href="#cb14-380" aria-hidden="true" tabindex="-1"></a>    .(</span>
<span id="cb14-381"><a href="#cb14-381" aria-hidden="true" tabindex="-1"></a>      <span class="at">clientes_por_region =</span> .N,</span>
<span id="cb14-382"><a href="#cb14-382" aria-hidden="true" tabindex="-1"></a>      <span class="at">valor_total =</span> <span class="fu">sum</span>(valor_cliente),</span>
<span id="cb14-383"><a href="#cb14-383" aria-hidden="true" tabindex="-1"></a>      <span class="at">edad_promedio =</span> <span class="fu">mean</span>(edad)</span>
<span id="cb14-384"><a href="#cb14-384" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb14-385"><a href="#cb14-385" aria-hidden="true" tabindex="-1"></a>    by <span class="ot">=</span> region</span>
<span id="cb14-386"><a href="#cb14-386" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb14-387"><a href="#cb14-387" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-388"><a href="#cb14-388" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Índices para búsquedas rápidas</span></span>
<span id="cb14-389"><a href="#cb14-389" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setkey</span>(session<span class="sc">$</span>userData<span class="sc">$</span>clientes_dt, cliente_id)</span>
<span id="cb14-390"><a href="#cb14-390" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setindex</span>(session<span class="sc">$</span>userData<span class="sc">$</span>clientes_dt, region, categoria_ingresos)</span>
<span id="cb14-391"><a href="#cb14-391" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-392"><a href="#cb14-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-393"><a href="#cb14-393" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Usar reactive values para cache inteligente</span></span>
<span id="cb14-394"><a href="#cb14-394" aria-hidden="true" tabindex="-1"></a>server <span class="ot">&lt;-</span> <span class="cf">function</span>(input, output, session) {</span>
<span id="cb14-395"><a href="#cb14-395" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Cache de cálculos costosos</span></span>
<span id="cb14-396"><a href="#cb14-396" aria-hidden="true" tabindex="-1"></a>  cache_metricas <span class="ot">&lt;-</span> <span class="fu">reactiveValues</span>()</span>
<span id="cb14-397"><a href="#cb14-397" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-398"><a href="#cb14-398" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Solo recalcular cuando cambien inputs relevantes</span></span>
<span id="cb14-399"><a href="#cb14-399" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observe</span>({</span>
<span id="cb14-400"><a href="#cb14-400" aria-hidden="true" tabindex="-1"></a>    key <span class="ot">&lt;-</span> <span class="fu">paste</span>(input<span class="sc">$</span>region_filter, input<span class="sc">$</span>edad_range[<span class="dv">1</span>], input<span class="sc">$</span>edad_range[<span class="dv">2</span>], <span class="at">sep =</span> <span class="st">"_"</span>)</span>
<span id="cb14-401"><a href="#cb14-401" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-402"><a href="#cb14-402" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.null</span>(cache_metricas[[key]])) {</span>
<span id="cb14-403"><a href="#cb14-403" aria-hidden="true" tabindex="-1"></a>      cache_metricas[[key]] <span class="ot">&lt;-</span> <span class="fu">calculate_customer_metrics</span>(</span>
<span id="cb14-404"><a href="#cb14-404" aria-hidden="true" tabindex="-1"></a>        datos_clientes[</span>
<span id="cb14-405"><a href="#cb14-405" aria-hidden="true" tabindex="-1"></a>          region <span class="sc">%in%</span> input<span class="sc">$</span>region_filter <span class="sc">&amp;</span> </span>
<span id="cb14-406"><a href="#cb14-406" aria-hidden="true" tabindex="-1"></a>          edad <span class="sc">%between%</span> input<span class="sc">$</span>edad_range</span>
<span id="cb14-407"><a href="#cb14-407" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb14-408"><a href="#cb14-408" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb14-409"><a href="#cb14-409" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-410"><a href="#cb14-410" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb14-411"><a href="#cb14-411" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-412"><a href="#cb14-412" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3. Renderizado condicional</span></span>
<span id="cb14-413"><a href="#cb14-413" aria-hidden="true" tabindex="-1"></a>  output<span class="sc">$</span>tabla_grande <span class="ot">&lt;-</span> DT<span class="sc">::</span><span class="fu">renderDataTable</span>({</span>
<span id="cb14-414"><a href="#cb14-414" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Solo renderizar si la pestaña está visible</span></span>
<span id="cb14-415"><a href="#cb14-415" aria-hidden="true" tabindex="-1"></a>    <span class="fu">req</span>(input<span class="sc">$</span>tabs <span class="sc">==</span> <span class="st">"datos_detallados"</span>)</span>
<span id="cb14-416"><a href="#cb14-416" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-417"><a href="#cb14-417" aria-hidden="true" tabindex="-1"></a>    <span class="co"># data.table operation ultrarrápida</span></span>
<span id="cb14-418"><a href="#cb14-418" aria-hidden="true" tabindex="-1"></a>    datos_tabla <span class="ot">&lt;-</span> <span class="fu">datos_filtrados</span>()[,</span>
<span id="cb14-419"><a href="#cb14-419" aria-hidden="true" tabindex="-1"></a>      .(cliente_id, region, valor_cliente, churn_flag)</span>
<span id="cb14-420"><a href="#cb14-420" aria-hidden="true" tabindex="-1"></a>    ][<span class="fu">order</span>(<span class="sc">-</span>valor_cliente)]</span>
<span id="cb14-421"><a href="#cb14-421" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-422"><a href="#cb14-422" aria-hidden="true" tabindex="-1"></a>    DT<span class="sc">::</span><span class="fu">datatable</span>(datos_tabla, <span class="at">options =</span> <span class="fu">list</span>(<span class="at">pageLength =</span> <span class="dv">50</span>))</span>
<span id="cb14-423"><a href="#cb14-423" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb14-424"><a href="#cb14-424" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-425"><a href="#cb14-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-426"><a href="#cb14-426" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Módulos para escalabilidad</span></span>
<span id="cb14-427"><a href="#cb14-427" aria-hidden="true" tabindex="-1"></a>customerMetricsUI <span class="ot">&lt;-</span> <span class="cf">function</span>(id) {</span>
<span id="cb14-428"><a href="#cb14-428" aria-hidden="true" tabindex="-1"></a>  ns <span class="ot">&lt;-</span> <span class="fu">NS</span>(id)</span>
<span id="cb14-429"><a href="#cb14-429" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tagList</span>(</span>
<span id="cb14-430"><a href="#cb14-430" aria-hidden="true" tabindex="-1"></a>    <span class="fu">valueBoxOutput</span>(<span class="fu">ns</span>(<span class="st">"total_value"</span>)),</span>
<span id="cb14-431"><a href="#cb14-431" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plotOutput</span>(<span class="fu">ns</span>(<span class="st">"distribution_plot"</span>))</span>
<span id="cb14-432"><a href="#cb14-432" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-433"><a href="#cb14-433" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-434"><a href="#cb14-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-435"><a href="#cb14-435" aria-hidden="true" tabindex="-1"></a>customerMetricsServer <span class="ot">&lt;-</span> <span class="cf">function</span>(id, data) {</span>
<span id="cb14-436"><a href="#cb14-436" aria-hidden="true" tabindex="-1"></a>  <span class="fu">moduleServer</span>(id, <span class="cf">function</span>(input, output, session) {</span>
<span id="cb14-437"><a href="#cb14-437" aria-hidden="true" tabindex="-1"></a>    output<span class="sc">$</span>total_value <span class="ot">&lt;-</span> <span class="fu">renderValueBox</span>({</span>
<span id="cb14-438"><a href="#cb14-438" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Cálculo modular con data.table</span></span>
<span id="cb14-439"><a href="#cb14-439" aria-hidden="true" tabindex="-1"></a>      total <span class="ot">&lt;-</span> <span class="fu">data</span>()[, <span class="fu">sum</span>(valor_cliente)]</span>
<span id="cb14-440"><a href="#cb14-440" aria-hidden="true" tabindex="-1"></a>      <span class="fu">valueBox</span>(</span>
<span id="cb14-441"><a href="#cb14-441" aria-hidden="true" tabindex="-1"></a>        <span class="at">value =</span> <span class="fu">dollar</span>(total, <span class="at">scale =</span> <span class="fl">1e-6</span>, <span class="at">suffix =</span> <span class="st">"M"</span>),</span>
<span id="cb14-442"><a href="#cb14-442" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="st">"Valor Total"</span>,</span>
<span id="cb14-443"><a href="#cb14-443" aria-hidden="true" tabindex="-1"></a>        <span class="at">icon =</span> <span class="fu">icon</span>(<span class="st">"chart-line"</span>),</span>
<span id="cb14-444"><a href="#cb14-444" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"green"</span></span>
<span id="cb14-445"><a href="#cb14-445" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb14-446"><a href="#cb14-446" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb14-447"><a href="#cb14-447" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb14-448"><a href="#cb14-448" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-449"><a href="#cb14-449" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-450"><a href="#cb14-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-451"><a href="#cb14-451" aria-hidden="true" tabindex="-1"></a><span class="fu">## Integración con tidymodels: Machine Learning Robusto</span></span>
<span id="cb14-452"><a href="#cb14-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-453"><a href="#cb14-453" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1. **Workflow Completo: data.table → tidymodels → data.table**</span></span>
<span id="cb14-454"><a href="#cb14-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-457"><a href="#cb14-457" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-458"><a href="#cb14-458" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tidymodels-workflow</span></span>
<span id="cb14-459"><a href="#cb14-459" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb14-460"><a href="#cb14-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-461"><a href="#cb14-461" aria-hidden="true" tabindex="-1"></a><span class="co"># PASO 1: Feature Engineering con data.table (ultrarrápido)</span></span>
<span id="cb14-462"><a href="#cb14-462" aria-hidden="true" tabindex="-1"></a>preparar_datos_ml <span class="ot">&lt;-</span> <span class="cf">function</span>(clientes_dt, transacciones_dt) {</span>
<span id="cb14-463"><a href="#cb14-463" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular métricas de transacciones por cliente</span></span>
<span id="cb14-464"><a href="#cb14-464" aria-hidden="true" tabindex="-1"></a>  metricas_transaccionales <span class="ot">&lt;-</span> transacciones_dt[, monto_final <span class="sc">:</span><span class="er">=</span> monto <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> descuento_aplicado)][</span>
<span id="cb14-465"><a href="#cb14-465" aria-hidden="true" tabindex="-1"></a>    fecha_transaccion <span class="sc">&gt;=</span> <span class="fu">Sys.Date</span>() <span class="sc">-</span> <span class="dv">365</span>,  <span class="co"># Último año</span></span>
<span id="cb14-466"><a href="#cb14-466" aria-hidden="true" tabindex="-1"></a>    .(</span>
<span id="cb14-467"><a href="#cb14-467" aria-hidden="true" tabindex="-1"></a>      transacciones_año <span class="ot">=</span> .N,</span>
<span id="cb14-468"><a href="#cb14-468" aria-hidden="true" tabindex="-1"></a>      monto_total_año <span class="ot">=</span> <span class="fu">sum</span>(monto_final),</span>
<span id="cb14-469"><a href="#cb14-469" aria-hidden="true" tabindex="-1"></a>      <span class="at">monto_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(monto_final), <span class="dv">2</span>),</span>
<span id="cb14-470"><a href="#cb14-470" aria-hidden="true" tabindex="-1"></a>      <span class="at">categorias_compradas =</span> <span class="fu">uniqueN</span>(producto_categoria),</span>
<span id="cb14-471"><a href="#cb14-471" aria-hidden="true" tabindex="-1"></a>      <span class="at">canal_principal =</span> <span class="fu">names</span>(<span class="fu">sort</span>(<span class="fu">table</span>(canal), <span class="at">decreasing =</span> <span class="cn">TRUE</span>))[<span class="dv">1</span>],</span>
<span id="cb14-472"><a href="#cb14-472" aria-hidden="true" tabindex="-1"></a>      <span class="at">frecuencia_compra_dias =</span> <span class="fu">as.numeric</span>(<span class="fu">max</span>(fecha_transaccion) <span class="sc">-</span> <span class="fu">min</span>(fecha_transaccion)) <span class="sc">/</span> .N,</span>
<span id="cb14-473"><a href="#cb14-473" aria-hidden="true" tabindex="-1"></a>      <span class="at">usa_descuentos =</span> <span class="fu">mean</span>(descuento_aplicado <span class="sc">&gt;</span> <span class="dv">0</span>),</span>
<span id="cb14-474"><a href="#cb14-474" aria-hidden="true" tabindex="-1"></a>      <span class="at">tasa_devolucion =</span> <span class="fu">mean</span>(es_devolucion)</span>
<span id="cb14-475"><a href="#cb14-475" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb14-476"><a href="#cb14-476" aria-hidden="true" tabindex="-1"></a>    by <span class="ot">=</span> cliente_id</span>
<span id="cb14-477"><a href="#cb14-477" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb14-478"><a href="#cb14-478" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-479"><a href="#cb14-479" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Unir con datos de clientes</span></span>
<span id="cb14-480"><a href="#cb14-480" aria-hidden="true" tabindex="-1"></a>  datos_completos <span class="ot">&lt;-</span> clientes_dt[metricas_transaccionales, on <span class="ot">=</span> .(cliente_id)]</span>
<span id="cb14-481"><a href="#cb14-481" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-482"><a href="#cb14-482" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Feature engineering adicional</span></span>
<span id="cb14-483"><a href="#cb14-483" aria-hidden="true" tabindex="-1"></a>  datos_completos[, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-484"><a href="#cb14-484" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Variables de interacción</span></span>
<span id="cb14-485"><a href="#cb14-485" aria-hidden="true" tabindex="-1"></a>    <span class="at">ingresos_edad_ratio =</span> ingresos <span class="sc">/</span> edad,</span>
<span id="cb14-486"><a href="#cb14-486" aria-hidden="true" tabindex="-1"></a>    <span class="at">valor_por_producto =</span> valor_cliente <span class="sc">/</span> num_productos,</span>
<span id="cb14-487"><a href="#cb14-487" aria-hidden="true" tabindex="-1"></a>    <span class="at">engagement_per_month =</span> engagement_score <span class="sc">/</span> <span class="fu">pmax</span>(antiguedad_meses, <span class="dv">1</span>),</span>
<span id="cb14-488"><a href="#cb14-488" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-489"><a href="#cb14-489" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Variables categóricas optimizadas</span></span>
<span id="cb14-490"><a href="#cb14-490" aria-hidden="true" tabindex="-1"></a>    <span class="at">segmento_valor =</span> <span class="fu">cut</span>(valor_cliente, </span>
<span id="cb14-491"><a href="#cb14-491" aria-hidden="true" tabindex="-1"></a>                        <span class="at">breaks =</span> <span class="fu">quantile</span>(valor_cliente, <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="dv">1</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-492"><a href="#cb14-492" aria-hidden="true" tabindex="-1"></a>                        <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Bajo"</span>, <span class="st">"Medio-Bajo"</span>, <span class="st">"Medio-Alto"</span>, <span class="st">"Alto"</span>),</span>
<span id="cb14-493"><a href="#cb14-493" aria-hidden="true" tabindex="-1"></a>                        <span class="at">include.lowest =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-494"><a href="#cb14-494" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-495"><a href="#cb14-495" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Variables binarias</span></span>
<span id="cb14-496"><a href="#cb14-496" aria-hidden="true" tabindex="-1"></a>    <span class="at">cliente_frecuente =</span> <span class="fu">as.numeric</span>(transacciones_año <span class="sc">&gt;</span> <span class="fu">quantile</span>(transacciones_año, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb14-497"><a href="#cb14-497" aria-hidden="true" tabindex="-1"></a>    <span class="at">multicanal =</span> <span class="fu">as.numeric</span>(categorias_compradas <span class="sc">&gt;=</span> <span class="dv">3</span>),</span>
<span id="cb14-498"><a href="#cb14-498" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-499"><a href="#cb14-499" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Target variable limpia</span></span>
<span id="cb14-500"><a href="#cb14-500" aria-hidden="true" tabindex="-1"></a>    <span class="at">churn =</span> <span class="fu">factor</span>(<span class="fu">ifelse</span>(churn_flag <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"Si"</span>, <span class="st">"No"</span>), <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"No"</span>, <span class="st">"Si"</span>))</span>
<span id="cb14-501"><a href="#cb14-501" aria-hidden="true" tabindex="-1"></a>  )]</span>
<span id="cb14-502"><a href="#cb14-502" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-503"><a href="#cb14-503" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remover casos con NAs en variables críticas</span></span>
<span id="cb14-504"><a href="#cb14-504" aria-hidden="true" tabindex="-1"></a>  datos_limpios <span class="ot">&lt;-</span> datos_completos[</span>
<span id="cb14-505"><a href="#cb14-505" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(transacciones_año) <span class="sc">&amp;</span> </span>
<span id="cb14-506"><a href="#cb14-506" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(monto_total_año) <span class="sc">&amp;</span> </span>
<span id="cb14-507"><a href="#cb14-507" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(churn)</span>
<span id="cb14-508"><a href="#cb14-508" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb14-509"><a href="#cb14-509" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-510"><a href="#cb14-510" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(datos_limpios)</span>
<span id="cb14-511"><a href="#cb14-511" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-512"><a href="#cb14-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-513"><a href="#cb14-513" aria-hidden="true" tabindex="-1"></a><span class="co"># Ejecutar preparación</span></span>
<span id="cb14-514"><a href="#cb14-514" aria-hidden="true" tabindex="-1"></a>datos_ml <span class="ot">&lt;-</span> <span class="fu">preparar_datos_ml</span>(datos_clientes, transacciones_detalle)</span>
<span id="cb14-515"><a href="#cb14-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-516"><a href="#cb14-516" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Datos preparados para ML:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-517"><a href="#cb14-517" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"- Filas:"</span>, <span class="fu">nrow</span>(datos_ml), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-518"><a href="#cb14-518" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"- Columnas:"</span>, <span class="fu">ncol</span>(datos_ml), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-519"><a href="#cb14-519" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"- Distribución de churn:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-520"><a href="#cb14-520" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(datos_ml[, .N, <span class="at">by =</span> churn])</span>
<span id="cb14-521"><a href="#cb14-521" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-522"><a href="#cb14-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-523"><a href="#cb14-523" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2. **Modelado con tidymodels (Ejemplo Conceptual)**</span></span>
<span id="cb14-524"><a href="#cb14-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-527"><a href="#cb14-527" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-528"><a href="#cb14-528" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tidymodels-modeling</span></span>
<span id="cb14-529"><a href="#cb14-529" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb14-530"><a href="#cb14-530" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb14-531"><a href="#cb14-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-532"><a href="#cb14-532" aria-hidden="true" tabindex="-1"></a><span class="co"># Ejemplo de workflow completo con tidymodels</span></span>
<span id="cb14-533"><a href="#cb14-533" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb14-534"><a href="#cb14-534" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(themis)  <span class="co"># Para balanceo de clases</span></span>
<span id="cb14-535"><a href="#cb14-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-536"><a href="#cb14-536" aria-hidden="true" tabindex="-1"></a><span class="co"># PASO 2: Convertir a tibble para tidymodels</span></span>
<span id="cb14-537"><a href="#cb14-537" aria-hidden="true" tabindex="-1"></a>datos_tibble <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(datos_ml)</span>
<span id="cb14-538"><a href="#cb14-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-539"><a href="#cb14-539" aria-hidden="true" tabindex="-1"></a><span class="co"># PASO 3: Split de datos</span></span>
<span id="cb14-540"><a href="#cb14-540" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb14-541"><a href="#cb14-541" aria-hidden="true" tabindex="-1"></a>data_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(</span>
<span id="cb14-542"><a href="#cb14-542" aria-hidden="true" tabindex="-1"></a>  datos_tibble, </span>
<span id="cb14-543"><a href="#cb14-543" aria-hidden="true" tabindex="-1"></a>  <span class="at">prop =</span> <span class="fl">0.8</span>, </span>
<span id="cb14-544"><a href="#cb14-544" aria-hidden="true" tabindex="-1"></a>  <span class="at">strata =</span> churn</span>
<span id="cb14-545"><a href="#cb14-545" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-546"><a href="#cb14-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-547"><a href="#cb14-547" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> <span class="fu">training</span>(data_split)</span>
<span id="cb14-548"><a href="#cb14-548" aria-hidden="true" tabindex="-1"></a>test_data <span class="ot">&lt;-</span> <span class="fu">testing</span>(data_split)</span>
<span id="cb14-549"><a href="#cb14-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-550"><a href="#cb14-550" aria-hidden="true" tabindex="-1"></a><span class="co"># PASO 4: Receta de preprocesamiento</span></span>
<span id="cb14-551"><a href="#cb14-551" aria-hidden="true" tabindex="-1"></a>receta_churn <span class="ot">&lt;-</span> <span class="fu">recipe</span>(churn <span class="sc">~</span> ., <span class="at">data =</span> train_data) <span class="sc">%&gt;%</span></span>
<span id="cb14-552"><a href="#cb14-552" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remover variables no predictivas</span></span>
<span id="cb14-553"><a href="#cb14-553" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_rm</span>(cliente_id, churn_flag) <span class="sc">%&gt;%</span></span>
<span id="cb14-554"><a href="#cb14-554" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-555"><a href="#cb14-555" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Imputación de NAs</span></span>
<span id="cb14-556"><a href="#cb14-556" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_median</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb14-557"><a href="#cb14-557" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_mode</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb14-558"><a href="#cb14-558" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-559"><a href="#cb14-559" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Feature engineering</span></span>
<span id="cb14-560"><a href="#cb14-560" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_log</span>(ingresos, valor_cliente, <span class="at">offset =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-561"><a href="#cb14-561" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb14-562"><a href="#cb14-562" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-563"><a href="#cb14-563" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Variables dummy</span></span>
<span id="cb14-564"><a href="#cb14-564" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb14-565"><a href="#cb14-565" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-566"><a href="#cb14-566" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Balanceo de clases</span></span>
<span id="cb14-567"><a href="#cb14-567" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_downsample</span>(churn, <span class="at">under_ratio =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-568"><a href="#cb14-568" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-569"><a href="#cb14-569" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remover variables con varianza cero</span></span>
<span id="cb14-570"><a href="#cb14-570" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_zv</span>(<span class="fu">all_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb14-571"><a href="#cb14-571" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-572"><a href="#cb14-572" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Correlación alta</span></span>
<span id="cb14-573"><a href="#cb14-573" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_corr</span>(<span class="fu">all_numeric_predictors</span>(), <span class="at">threshold =</span> <span class="fl">0.9</span>)</span>
<span id="cb14-574"><a href="#cb14-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-575"><a href="#cb14-575" aria-hidden="true" tabindex="-1"></a><span class="co"># PASO 5: Modelos</span></span>
<span id="cb14-576"><a href="#cb14-576" aria-hidden="true" tabindex="-1"></a>modelo_rf <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>(</span>
<span id="cb14-577"><a href="#cb14-577" aria-hidden="true" tabindex="-1"></a>  <span class="at">trees =</span> <span class="fu">tune</span>(),</span>
<span id="cb14-578"><a href="#cb14-578" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry =</span> <span class="fu">tune</span>(),</span>
<span id="cb14-579"><a href="#cb14-579" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_n =</span> <span class="fu">tune</span>()</span>
<span id="cb14-580"><a href="#cb14-580" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb14-581"><a href="#cb14-581" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-582"><a href="#cb14-582" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"randomForest"</span>)</span>
<span id="cb14-583"><a href="#cb14-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-584"><a href="#cb14-584" aria-hidden="true" tabindex="-1"></a>modelo_xgb <span class="ot">&lt;-</span> <span class="fu">boost_tree</span>(</span>
<span id="cb14-585"><a href="#cb14-585" aria-hidden="true" tabindex="-1"></a>  <span class="at">trees =</span> <span class="fu">tune</span>(),</span>
<span id="cb14-586"><a href="#cb14-586" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree_depth =</span> <span class="fu">tune</span>(),</span>
<span id="cb14-587"><a href="#cb14-587" aria-hidden="true" tabindex="-1"></a>  <span class="at">learn_rate =</span> <span class="fu">tune</span>(),</span>
<span id="cb14-588"><a href="#cb14-588" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_n =</span> <span class="fu">tune</span>()</span>
<span id="cb14-589"><a href="#cb14-589" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb14-590"><a href="#cb14-590" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-591"><a href="#cb14-591" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"xgboost"</span>)</span>
<span id="cb14-592"><a href="#cb14-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-593"><a href="#cb14-593" aria-hidden="true" tabindex="-1"></a><span class="co"># PASO 6: Workflows</span></span>
<span id="cb14-594"><a href="#cb14-594" aria-hidden="true" tabindex="-1"></a>workflow_rf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb14-595"><a href="#cb14-595" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(receta_churn) <span class="sc">%&gt;%</span></span>
<span id="cb14-596"><a href="#cb14-596" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(modelo_rf)</span>
<span id="cb14-597"><a href="#cb14-597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-598"><a href="#cb14-598" aria-hidden="true" tabindex="-1"></a>workflow_xgb <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb14-599"><a href="#cb14-599" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(receta_churn) <span class="sc">%&gt;%</span></span>
<span id="cb14-600"><a href="#cb14-600" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(modelo_xgb)</span>
<span id="cb14-601"><a href="#cb14-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-602"><a href="#cb14-602" aria-hidden="true" tabindex="-1"></a><span class="co"># PASO 7: Cross-validation y tuning</span></span>
<span id="cb14-603"><a href="#cb14-603" aria-hidden="true" tabindex="-1"></a>cv_folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(train_data, <span class="at">v =</span> <span class="dv">5</span>, <span class="at">strata =</span> churn)</span>
<span id="cb14-604"><a href="#cb14-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-605"><a href="#cb14-605" aria-hidden="true" tabindex="-1"></a><span class="co"># Tuning Random Forest</span></span>
<span id="cb14-606"><a href="#cb14-606" aria-hidden="true" tabindex="-1"></a>tune_rf <span class="ot">&lt;-</span> workflow_rf <span class="sc">%&gt;%</span></span>
<span id="cb14-607"><a href="#cb14-607" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tune_grid</span>(</span>
<span id="cb14-608"><a href="#cb14-608" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> cv_folds,</span>
<span id="cb14-609"><a href="#cb14-609" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> <span class="dv">20</span>,</span>
<span id="cb14-610"><a href="#cb14-610" aria-hidden="true" tabindex="-1"></a>    <span class="at">metrics =</span> <span class="fu">metric_set</span>(roc_auc, precision, recall, f_meas)</span>
<span id="cb14-611"><a href="#cb14-611" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-612"><a href="#cb14-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-613"><a href="#cb14-613" aria-hidden="true" tabindex="-1"></a><span class="co"># PASO 8: Mejor modelo</span></span>
<span id="cb14-614"><a href="#cb14-614" aria-hidden="true" tabindex="-1"></a>best_rf <span class="ot">&lt;-</span> <span class="fu">select_best</span>(tune_rf, <span class="at">metric =</span> <span class="st">"roc_auc"</span>)</span>
<span id="cb14-615"><a href="#cb14-615" aria-hidden="true" tabindex="-1"></a>final_workflow_rf <span class="ot">&lt;-</span> <span class="fu">finalize_workflow</span>(workflow_rf, best_rf)</span>
<span id="cb14-616"><a href="#cb14-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-617"><a href="#cb14-617" aria-hidden="true" tabindex="-1"></a><span class="co"># PASO 9: Fit final y predicciones</span></span>
<span id="cb14-618"><a href="#cb14-618" aria-hidden="true" tabindex="-1"></a>modelo_final <span class="ot">&lt;-</span> <span class="fu">fit</span>(final_workflow_rf, train_data)</span>
<span id="cb14-619"><a href="#cb14-619" aria-hidden="true" tabindex="-1"></a>predicciones <span class="ot">&lt;-</span> <span class="fu">predict</span>(modelo_final, test_data, <span class="at">type =</span> <span class="st">"prob"</span>)</span>
<span id="cb14-620"><a href="#cb14-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-621"><a href="#cb14-621" aria-hidden="true" tabindex="-1"></a><span class="co"># Métricas de evaluación</span></span>
<span id="cb14-622"><a href="#cb14-622" aria-hidden="true" tabindex="-1"></a>metricas_modelo <span class="ot">&lt;-</span> test_data <span class="sc">%&gt;%</span></span>
<span id="cb14-623"><a href="#cb14-623" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(predicciones) <span class="sc">%&gt;%</span></span>
<span id="cb14-624"><a href="#cb14-624" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pred =</span> <span class="fu">factor</span>(<span class="fu">fifelse</span>(.pred_Si <span class="sc">&gt;=</span> <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">0</span>), <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"No"</span>, <span class="st">"Si"</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb14-625"><a href="#cb14-625" aria-hidden="true" tabindex="-1"></a>  <span class="fu">metrics</span>(<span class="at">truth =</span> churn, pred)</span>
<span id="cb14-626"><a href="#cb14-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-627"><a href="#cb14-627" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(metricas_modelo)</span>
<span id="cb14-628"><a href="#cb14-628" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-629"><a href="#cb14-629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-630"><a href="#cb14-630" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3. **Post-procesamiento y Análisis con data.table**</span></span>
<span id="cb14-631"><a href="#cb14-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-634"><a href="#cb14-634" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-635"><a href="#cb14-635" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: post-procesamiento-ml</span></span>
<span id="cb14-636"><a href="#cb14-636" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb14-637"><a href="#cb14-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-638"><a href="#cb14-638" aria-hidden="true" tabindex="-1"></a><span class="co"># Simular predicciones para el ejemplo (en producción vendrían del modelo)</span></span>
<span id="cb14-639"><a href="#cb14-639" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">789</span>)</span>
<span id="cb14-640"><a href="#cb14-640" aria-hidden="true" tabindex="-1"></a>predicciones_simuladas <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb14-641"><a href="#cb14-641" aria-hidden="true" tabindex="-1"></a>  <span class="at">cliente_id =</span> datos_ml[<span class="fu">sample</span>(.N, <span class="dv">2000</span>), cliente_id],</span>
<span id="cb14-642"><a href="#cb14-642" aria-hidden="true" tabindex="-1"></a>  <span class="at">prob_churn =</span> <span class="fu">runif</span>(<span class="dv">2000</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb14-643"><a href="#cb14-643" aria-hidden="true" tabindex="-1"></a>  <span class="at">pred_churn =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Si"</span>, <span class="st">"No"</span>), <span class="dv">2000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.15</span>, <span class="fl">0.85</span>)),</span>
<span id="cb14-644"><a href="#cb14-644" aria-hidden="true" tabindex="-1"></a>  <span class="at">confidence_score =</span> <span class="fu">runif</span>(<span class="dv">2000</span>, <span class="fl">0.6</span>, <span class="fl">0.95</span>)</span>
<span id="cb14-645"><a href="#cb14-645" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-646"><a href="#cb14-646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-647"><a href="#cb14-647" aria-hidden="true" tabindex="-1"></a><span class="co"># ANÁLISIS DE RESULTADOS con data.table</span></span>
<span id="cb14-648"><a href="#cb14-648" aria-hidden="true" tabindex="-1"></a><span class="co"># Unir predicciones con datos originales</span></span>
<span id="cb14-649"><a href="#cb14-649" aria-hidden="true" tabindex="-1"></a>resultados_ml <span class="ot">&lt;-</span> datos_ml[predicciones_simuladas, on <span class="ot">=</span> .(cliente_id)]</span>
<span id="cb14-650"><a href="#cb14-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-651"><a href="#cb14-651" aria-hidden="true" tabindex="-1"></a><span class="co"># Análisis de segmentos de riesgo</span></span>
<span id="cb14-652"><a href="#cb14-652" aria-hidden="true" tabindex="-1"></a>analisis_riesgo <span class="ot">&lt;-</span> resultados_ml[,</span>
<span id="cb14-653"><a href="#cb14-653" aria-hidden="true" tabindex="-1"></a>  .(</span>
<span id="cb14-654"><a href="#cb14-654" aria-hidden="true" tabindex="-1"></a>    <span class="at">clientes_total =</span> .N,</span>
<span id="cb14-655"><a href="#cb14-655" aria-hidden="true" tabindex="-1"></a>    <span class="at">churn_predicho =</span> <span class="fu">sum</span>(pred_churn <span class="sc">==</span> <span class="st">"Si"</span>),</span>
<span id="cb14-656"><a href="#cb14-656" aria-hidden="true" tabindex="-1"></a>    <span class="at">prob_churn_media =</span> <span class="fu">round</span>(<span class="fu">mean</span>(prob_churn), <span class="dv">3</span>),</span>
<span id="cb14-657"><a href="#cb14-657" aria-hidden="true" tabindex="-1"></a>    <span class="at">valor_en_riesgo =</span> <span class="fu">sum</span>(valor_cliente[pred_churn <span class="sc">==</span> <span class="st">"Si"</span>]),</span>
<span id="cb14-658"><a href="#cb14-658" aria-hidden="true" tabindex="-1"></a>    <span class="at">revenue_en_riesgo =</span> <span class="fu">sum</span>(monto_total_año[pred_churn <span class="sc">==</span> <span class="st">"Si"</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-659"><a href="#cb14-659" aria-hidden="true" tabindex="-1"></a>    <span class="at">ingresos_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(ingresos), <span class="dv">0</span>),</span>
<span id="cb14-660"><a href="#cb14-660" aria-hidden="true" tabindex="-1"></a>    <span class="at">engagement_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(engagement_score), <span class="dv">2</span>)</span>
<span id="cb14-661"><a href="#cb14-661" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb14-662"><a href="#cb14-662" aria-hidden="true" tabindex="-1"></a>  by <span class="ot">=</span> .(region, categoria_ingresos)</span>
<span id="cb14-663"><a href="#cb14-663" aria-hidden="true" tabindex="-1"></a>][<span class="fu">order</span>(<span class="sc">-</span>valor_en_riesgo)]</span>
<span id="cb14-664"><a href="#cb14-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-665"><a href="#cb14-665" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== ANÁLISIS DE RIESGO DE CHURN POR SEGMENTO ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-666"><a href="#cb14-666" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(analisis_riesgo)</span>
<span id="cb14-667"><a href="#cb14-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-668"><a href="#cb14-668" aria-hidden="true" tabindex="-1"></a><span class="co"># Identificar clientes de alta prioridad para retención</span></span>
<span id="cb14-669"><a href="#cb14-669" aria-hidden="true" tabindex="-1"></a>clientes_retencion <span class="ot">&lt;-</span> resultados_ml[</span>
<span id="cb14-670"><a href="#cb14-670" aria-hidden="true" tabindex="-1"></a>  pred_churn <span class="sc">==</span> <span class="st">"Si"</span> <span class="sc">&amp;</span> </span>
<span id="cb14-671"><a href="#cb14-671" aria-hidden="true" tabindex="-1"></a>  prob_churn <span class="sc">&gt;</span> <span class="fl">0.7</span> <span class="sc">&amp;</span> </span>
<span id="cb14-672"><a href="#cb14-672" aria-hidden="true" tabindex="-1"></a>  valor_cliente <span class="sc">&gt;</span> <span class="fu">quantile</span>(resultados_ml<span class="sc">$</span>valor_cliente, <span class="fl">0.7</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-673"><a href="#cb14-673" aria-hidden="true" tabindex="-1"></a>  .(</span>
<span id="cb14-674"><a href="#cb14-674" aria-hidden="true" tabindex="-1"></a>    cliente_id, region, edad, ingresos, valor_cliente,</span>
<span id="cb14-675"><a href="#cb14-675" aria-hidden="true" tabindex="-1"></a>    <span class="at">prob_churn =</span> <span class="fu">round</span>(prob_churn, <span class="dv">3</span>),</span>
<span id="cb14-676"><a href="#cb14-676" aria-hidden="true" tabindex="-1"></a>    transacciones_año, monto_total_año,</span>
<span id="cb14-677"><a href="#cb14-677" aria-hidden="true" tabindex="-1"></a>    satisfaccion, engagement_score,</span>
<span id="cb14-678"><a href="#cb14-678" aria-hidden="true" tabindex="-1"></a>    <span class="at">accion_recomendada =</span> <span class="fu">fcase</span>(</span>
<span id="cb14-679"><a href="#cb14-679" aria-hidden="true" tabindex="-1"></a>      satisfaccion <span class="sc">&lt;</span> <span class="dv">3</span>, <span class="st">"Mejora_Servicio"</span>,</span>
<span id="cb14-680"><a href="#cb14-680" aria-hidden="true" tabindex="-1"></a>      engagement_score <span class="sc">&lt;</span> <span class="dv">5</span>, <span class="st">"Aumentar_Engagement"</span>, </span>
<span id="cb14-681"><a href="#cb14-681" aria-hidden="true" tabindex="-1"></a>      monto_total_año <span class="sc">&lt;</span> <span class="dv">1000</span>, <span class="st">"Incentivo_Compra"</span>,</span>
<span id="cb14-682"><a href="#cb14-682" aria-hidden="true" tabindex="-1"></a>      <span class="at">default =</span> <span class="st">"Programa_Lealtad"</span></span>
<span id="cb14-683"><a href="#cb14-683" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-684"><a href="#cb14-684" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-685"><a href="#cb14-685" aria-hidden="true" tabindex="-1"></a>][<span class="fu">order</span>(<span class="sc">-</span>valor_cliente)]</span>
<span id="cb14-686"><a href="#cb14-686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-687"><a href="#cb14-687" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== TOP 10 CLIENTES PARA RETENCIÓN INMEDIATA ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-688"><a href="#cb14-688" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(clientes_retencion, <span class="dv">10</span>))</span>
<span id="cb14-689"><a href="#cb14-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-690"><a href="#cb14-690" aria-hidden="true" tabindex="-1"></a><span class="co"># Análisis de efectividad del modelo por segmento</span></span>
<span id="cb14-691"><a href="#cb14-691" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(resultados_ml[<span class="sc">!</span><span class="fu">is.na</span>(churn_flag)]) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb14-692"><a href="#cb14-692" aria-hidden="true" tabindex="-1"></a>  efectividad_modelo <span class="ot">&lt;-</span> resultados_ml[<span class="sc">!</span><span class="fu">is.na</span>(churn_flag),</span>
<span id="cb14-693"><a href="#cb14-693" aria-hidden="true" tabindex="-1"></a>    .(</span>
<span id="cb14-694"><a href="#cb14-694" aria-hidden="true" tabindex="-1"></a>      <span class="at">precision =</span> <span class="fu">sum</span>(pred_churn <span class="sc">==</span> <span class="st">"Si"</span> <span class="sc">&amp;</span> churn <span class="sc">==</span> <span class="st">"Si"</span>) <span class="sc">/</span> <span class="fu">sum</span>(pred_churn <span class="sc">==</span> <span class="st">"Si"</span>),</span>
<span id="cb14-695"><a href="#cb14-695" aria-hidden="true" tabindex="-1"></a>      <span class="at">recall =</span> <span class="fu">sum</span>(pred_churn <span class="sc">==</span> <span class="st">"Si"</span> <span class="sc">&amp;</span> churn <span class="sc">==</span> <span class="st">"Si"</span>) <span class="sc">/</span> <span class="fu">sum</span>(churn <span class="sc">==</span> <span class="st">"Si"</span>),</span>
<span id="cb14-696"><a href="#cb14-696" aria-hidden="true" tabindex="-1"></a>      <span class="at">accuracy =</span> <span class="fu">mean</span>(pred_churn <span class="sc">==</span> churn),</span>
<span id="cb14-697"><a href="#cb14-697" aria-hidden="true" tabindex="-1"></a>      <span class="at">clientes_evaluados =</span> .N</span>
<span id="cb14-698"><a href="#cb14-698" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb14-699"><a href="#cb14-699" aria-hidden="true" tabindex="-1"></a>    by <span class="ot">=</span> .(region, categoria_edad)</span>
<span id="cb14-700"><a href="#cb14-700" aria-hidden="true" tabindex="-1"></a>  ][clientes_evaluados <span class="sc">&gt;=</span> <span class="dv">10</span>]  <span class="co"># Solo segmentos con suficientes datos</span></span>
<span id="cb14-701"><a href="#cb14-701" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-702"><a href="#cb14-702" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== EFECTIVIDAD DEL MODELO POR SEGMENTO ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-703"><a href="#cb14-703" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">head</span>(efectividad_modelo[<span class="fu">order</span>(<span class="sc">-</span>accuracy)]))</span>
<span id="cb14-704"><a href="#cb14-704" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-705"><a href="#cb14-705" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-706"><a href="#cb14-706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-707"><a href="#cb14-707" aria-hidden="true" tabindex="-1"></a><span class="fu">## dtplyr: El Puente Entre data.table y tidyverse</span></span>
<span id="cb14-708"><a href="#cb14-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-709"><a href="#cb14-709" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1. **Introducción y Casos de Uso**</span></span>
<span id="cb14-710"><a href="#cb14-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-713"><a href="#cb14-713" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-714"><a href="#cb14-714" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: dtplyr-introduccion</span></span>
<span id="cb14-715"><a href="#cb14-715" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb14-716"><a href="#cb14-716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-717"><a href="#cb14-717" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">requireNamespace</span>(<span class="st">"dtplyr"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>) <span class="sc">&amp;&amp;</span> <span class="fu">requireNamespace</span>(<span class="st">"dplyr"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb14-718"><a href="#cb14-718" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(dtplyr)</span>
<span id="cb14-719"><a href="#cb14-719" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(dplyr, <span class="at">warn.conflicts =</span> <span class="cn">FALSE</span>)</span>
<span id="cb14-720"><a href="#cb14-720" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-721"><a href="#cb14-721" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convertir data.table a lazy_dt</span></span>
<span id="cb14-722"><a href="#cb14-722" aria-hidden="true" tabindex="-1"></a>  clientes_lazy <span class="ot">&lt;-</span> <span class="fu">lazy_dt</span>(datos_clientes)</span>
<span id="cb14-723"><a href="#cb14-723" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-724"><a href="#cb14-724" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Workflow con sintaxis dplyr que se traduce a data.table</span></span>
<span id="cb14-725"><a href="#cb14-725" aria-hidden="true" tabindex="-1"></a>  analisis_dtplyr <span class="ot">&lt;-</span> clientes_lazy <span class="sc">%&gt;%</span></span>
<span id="cb14-726"><a href="#cb14-726" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(edad <span class="sc">&gt;=</span> <span class="dv">25</span>, edad <span class="sc">&lt;=</span> <span class="dv">65</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-727"><a href="#cb14-727" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb14-728"><a href="#cb14-728" aria-hidden="true" tabindex="-1"></a>      <span class="at">categoria_valor =</span> <span class="fu">case_when</span>(</span>
<span id="cb14-729"><a href="#cb14-729" aria-hidden="true" tabindex="-1"></a>        valor_cliente <span class="sc">&gt;=</span> <span class="fu">quantile</span>(valor_cliente, <span class="fl">0.8</span>) <span class="sc">~</span> <span class="st">"Premium"</span>,</span>
<span id="cb14-730"><a href="#cb14-730" aria-hidden="true" tabindex="-1"></a>        valor_cliente <span class="sc">&gt;=</span> <span class="fu">quantile</span>(valor_cliente, <span class="fl">0.5</span>) <span class="sc">~</span> <span class="st">"Standard"</span>,</span>
<span id="cb14-731"><a href="#cb14-731" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Basic"</span></span>
<span id="cb14-732"><a href="#cb14-732" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb14-733"><a href="#cb14-733" aria-hidden="true" tabindex="-1"></a>      <span class="at">riesgo_total =</span> riesgo_churn <span class="sc">+</span> (<span class="dv">5</span> <span class="sc">-</span> satisfaccion) <span class="sc">/</span> <span class="dv">5</span></span>
<span id="cb14-734"><a href="#cb14-734" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb14-735"><a href="#cb14-735" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(region, categoria_valor) <span class="sc">%&gt;%</span></span>
<span id="cb14-736"><a href="#cb14-736" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb14-737"><a href="#cb14-737" aria-hidden="true" tabindex="-1"></a>      <span class="at">clientes =</span> <span class="fu">n</span>(),</span>
<span id="cb14-738"><a href="#cb14-738" aria-hidden="true" tabindex="-1"></a>      <span class="at">valor_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(valor_cliente), <span class="dv">2</span>),</span>
<span id="cb14-739"><a href="#cb14-739" aria-hidden="true" tabindex="-1"></a>      <span class="at">engagement_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(engagement_score), <span class="dv">2</span>),</span>
<span id="cb14-740"><a href="#cb14-740" aria-hidden="true" tabindex="-1"></a>      <span class="at">churn_rate =</span> <span class="fu">round</span>(<span class="fu">mean</span>(churn_flag) <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>),</span>
<span id="cb14-741"><a href="#cb14-741" aria-hidden="true" tabindex="-1"></a>      <span class="at">riesgo_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(riesgo_total), <span class="dv">2</span>),</span>
<span id="cb14-742"><a href="#cb14-742" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="st">'drop'</span></span>
<span id="cb14-743"><a href="#cb14-743" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb14-744"><a href="#cb14-744" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">desc</span>(valor_promedio)) <span class="sc">%&gt;%</span></span>
<span id="cb14-745"><a href="#cb14-745" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.data.table</span>()  <span class="co"># Convertir de vuelta a data.table</span></span>
<span id="cb14-746"><a href="#cb14-746" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-747"><a href="#cb14-747" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">"Resultado del análisis con dtplyr:"</span>)</span>
<span id="cb14-748"><a href="#cb14-748" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">head</span>(analisis_dtplyr, <span class="dv">10</span>))</span>
<span id="cb14-749"><a href="#cb14-749" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-750"><a href="#cb14-750" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ver el código data.table generado</span></span>
<span id="cb14-751"><a href="#cb14-751" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== CÓDIGO DATA.TABLE GENERADO POR DTPLYR ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-752"><a href="#cb14-752" aria-hidden="true" tabindex="-1"></a>  codigo_generado <span class="ot">&lt;-</span> clientes_lazy <span class="sc">%&gt;%</span></span>
<span id="cb14-753"><a href="#cb14-753" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(edad <span class="sc">&gt;=</span> <span class="dv">25</span>, edad <span class="sc">&lt;=</span> <span class="dv">65</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-754"><a href="#cb14-754" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(region) <span class="sc">%&gt;%</span></span>
<span id="cb14-755"><a href="#cb14-755" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">valor_promedio =</span> <span class="fu">mean</span>(valor_cliente), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-756"><a href="#cb14-756" aria-hidden="true" tabindex="-1"></a>    <span class="fu">show_query</span>()</span>
<span id="cb14-757"><a href="#cb14-757" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-758"><a href="#cb14-758" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb14-759"><a href="#cb14-759" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"💡 Para usar dtplyr, instala los paquetes:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-760"><a href="#cb14-760" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"install.packages(c('dtplyr', 'dplyr'))</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-761"><a href="#cb14-761" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-762"><a href="#cb14-762" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-763"><a href="#cb14-763" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-764"><a href="#cb14-764" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2. **Comparación de Performance: dtplyr vs dplyr puro**</span></span>
<span id="cb14-765"><a href="#cb14-765" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-768"><a href="#cb14-768" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-769"><a href="#cb14-769" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: dtplyr-performance</span></span>
<span id="cb14-770"><a href="#cb14-770" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb14-771"><a href="#cb14-771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-772"><a href="#cb14-772" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">requireNamespace</span>(<span class="st">"dtplyr"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>) <span class="sc">&amp;&amp;</span> <span class="fu">requireNamespace</span>(<span class="st">"dplyr"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb14-773"><a href="#cb14-773" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(microbenchmark)</span>
<span id="cb14-774"><a href="#cb14-774" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-775"><a href="#cb14-775" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Crear dataset más grande para benchmark</span></span>
<span id="cb14-776"><a href="#cb14-776" aria-hidden="true" tabindex="-1"></a>  datos_benchmark <span class="ot">&lt;-</span> <span class="fu">rbindlist</span>(<span class="fu">replicate</span>(<span class="dv">5</span>, datos_clientes, <span class="at">simplify =</span> <span class="cn">FALSE</span>))</span>
<span id="cb14-777"><a href="#cb14-777" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-778"><a href="#cb14-778" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Operación compleja para comparar</span></span>
<span id="cb14-779"><a href="#cb14-779" aria-hidden="true" tabindex="-1"></a>  operacion_compleja <span class="ot">&lt;-</span> <span class="cf">function</span>(data, metodo) {</span>
<span id="cb14-780"><a href="#cb14-780" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(metodo <span class="sc">==</span> <span class="st">"dplyr"</span>) {</span>
<span id="cb14-781"><a href="#cb14-781" aria-hidden="true" tabindex="-1"></a>      <span class="co"># dplyr puro sobre data.frame</span></span>
<span id="cb14-782"><a href="#cb14-782" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.data.frame</span>(data) <span class="sc">%&gt;%</span></span>
<span id="cb14-783"><a href="#cb14-783" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(edad <span class="sc">&gt;=</span> <span class="dv">30</span>, satisfaccion <span class="sc">&gt;=</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-784"><a href="#cb14-784" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(region, categoria_ingresos) <span class="sc">%&gt;%</span></span>
<span id="cb14-785"><a href="#cb14-785" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarise</span>(</span>
<span id="cb14-786"><a href="#cb14-786" aria-hidden="true" tabindex="-1"></a>          <span class="at">clientes =</span> <span class="fu">n</span>(),</span>
<span id="cb14-787"><a href="#cb14-787" aria-hidden="true" tabindex="-1"></a>          <span class="at">valor_total =</span> <span class="fu">sum</span>(valor_cliente),</span>
<span id="cb14-788"><a href="#cb14-788" aria-hidden="true" tabindex="-1"></a>          <span class="at">engagement_avg =</span> <span class="fu">mean</span>(engagement_score),</span>
<span id="cb14-789"><a href="#cb14-789" aria-hidden="true" tabindex="-1"></a>          <span class="at">.groups =</span> <span class="st">'drop'</span></span>
<span id="cb14-790"><a href="#cb14-790" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb14-791"><a href="#cb14-791" aria-hidden="true" tabindex="-1"></a>        <span class="fu">arrange</span>(<span class="fu">desc</span>(valor_total))</span>
<span id="cb14-792"><a href="#cb14-792" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span>(metodo <span class="sc">==</span> <span class="st">"dtplyr"</span>) {</span>
<span id="cb14-793"><a href="#cb14-793" aria-hidden="true" tabindex="-1"></a>      <span class="co"># dtplyr (sintaxis dplyr + motor data.table)</span></span>
<span id="cb14-794"><a href="#cb14-794" aria-hidden="true" tabindex="-1"></a>      <span class="fu">lazy_dt</span>(data) <span class="sc">%&gt;%</span></span>
<span id="cb14-795"><a href="#cb14-795" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(edad <span class="sc">&gt;=</span> <span class="dv">30</span>, satisfaccion <span class="sc">&gt;=</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-796"><a href="#cb14-796" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(region, categoria_ingresos) <span class="sc">%&gt;%</span></span>
<span id="cb14-797"><a href="#cb14-797" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarise</span>(</span>
<span id="cb14-798"><a href="#cb14-798" aria-hidden="true" tabindex="-1"></a>          <span class="at">clientes =</span> <span class="fu">n</span>(),</span>
<span id="cb14-799"><a href="#cb14-799" aria-hidden="true" tabindex="-1"></a>          <span class="at">valor_total =</span> <span class="fu">sum</span>(valor_cliente),</span>
<span id="cb14-800"><a href="#cb14-800" aria-hidden="true" tabindex="-1"></a>          <span class="at">engagement_avg =</span> <span class="fu">mean</span>(engagement_score),</span>
<span id="cb14-801"><a href="#cb14-801" aria-hidden="true" tabindex="-1"></a>          <span class="at">.groups =</span> <span class="st">'drop'</span></span>
<span id="cb14-802"><a href="#cb14-802" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb14-803"><a href="#cb14-803" aria-hidden="true" tabindex="-1"></a>        <span class="fu">arrange</span>(<span class="fu">desc</span>(valor_total)) <span class="sc">%&gt;%</span></span>
<span id="cb14-804"><a href="#cb14-804" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as.data.table</span>()</span>
<span id="cb14-805"><a href="#cb14-805" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb14-806"><a href="#cb14-806" aria-hidden="true" tabindex="-1"></a>      <span class="co"># data.table puro</span></span>
<span id="cb14-807"><a href="#cb14-807" aria-hidden="true" tabindex="-1"></a>      data[</span>
<span id="cb14-808"><a href="#cb14-808" aria-hidden="true" tabindex="-1"></a>        edad <span class="sc">&gt;=</span> <span class="dv">30</span> <span class="sc">&amp;</span> satisfaccion <span class="sc">&gt;=</span> <span class="dv">3</span>,</span>
<span id="cb14-809"><a href="#cb14-809" aria-hidden="true" tabindex="-1"></a>        .(</span>
<span id="cb14-810"><a href="#cb14-810" aria-hidden="true" tabindex="-1"></a>          <span class="at">clientes =</span> .N,</span>
<span id="cb14-811"><a href="#cb14-811" aria-hidden="true" tabindex="-1"></a>          <span class="at">valor_total =</span> <span class="fu">sum</span>(valor_cliente),</span>
<span id="cb14-812"><a href="#cb14-812" aria-hidden="true" tabindex="-1"></a>          <span class="at">engagement_avg =</span> <span class="fu">mean</span>(engagement_score)</span>
<span id="cb14-813"><a href="#cb14-813" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb14-814"><a href="#cb14-814" aria-hidden="true" tabindex="-1"></a>        by <span class="ot">=</span> .(region, categoria_ingresos)</span>
<span id="cb14-815"><a href="#cb14-815" aria-hidden="true" tabindex="-1"></a>      ][<span class="fu">order</span>(<span class="sc">-</span>valor_total)]</span>
<span id="cb14-816"><a href="#cb14-816" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-817"><a href="#cb14-817" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-818"><a href="#cb14-818" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-819"><a href="#cb14-819" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Benchmark</span></span>
<span id="cb14-820"><a href="#cb14-820" aria-hidden="true" tabindex="-1"></a>  benchmark_results <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(</span>
<span id="cb14-821"><a href="#cb14-821" aria-hidden="true" tabindex="-1"></a>    <span class="at">dplyr_puro =</span> <span class="fu">operacion_compleja</span>(datos_benchmark, <span class="st">"dplyr"</span>),</span>
<span id="cb14-822"><a href="#cb14-822" aria-hidden="true" tabindex="-1"></a>    <span class="at">dtplyr =</span> <span class="fu">operacion_compleja</span>(datos_benchmark, <span class="st">"dtplyr"</span>),</span>
<span id="cb14-823"><a href="#cb14-823" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_table =</span> <span class="fu">operacion_compleja</span>(datos_benchmark, <span class="st">"data.table"</span>),</span>
<span id="cb14-824"><a href="#cb14-824" aria-hidden="true" tabindex="-1"></a>    <span class="at">times =</span> <span class="dv">10</span></span>
<span id="cb14-825"><a href="#cb14-825" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-826"><a href="#cb14-826" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-827"><a href="#cb14-827" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"=== BENCHMARK DE PERFORMANCE ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-828"><a href="#cb14-828" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(benchmark_results)</span>
<span id="cb14-829"><a href="#cb14-829" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-830"><a href="#cb14-830" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular speedup</span></span>
<span id="cb14-831"><a href="#cb14-831" aria-hidden="true" tabindex="-1"></a>  medias <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(time <span class="sc">~</span> expr, <span class="at">data =</span> benchmark_results, <span class="at">FUN =</span> mean)</span>
<span id="cb14-832"><a href="#cb14-832" aria-hidden="true" tabindex="-1"></a>  medias<span class="sc">$</span>speedup <span class="ot">&lt;-</span> medias<span class="sc">$</span>time[medias<span class="sc">$</span>expr <span class="sc">==</span> <span class="st">"dplyr_puro"</span>] <span class="sc">/</span> medias<span class="sc">$</span>time</span>
<span id="cb14-833"><a href="#cb14-833" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-834"><a href="#cb14-834" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== SPEEDUP RELATIVO (vs dplyr puro) ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-835"><a href="#cb14-835" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(medias[, <span class="fu">c</span>(<span class="st">"expr"</span>, <span class="st">"speedup"</span>)])</span>
<span id="cb14-836"><a href="#cb14-836" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-837"><a href="#cb14-837" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb14-838"><a href="#cb14-838" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Benchmark requiere dtplyr y dplyr instalados</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-839"><a href="#cb14-839" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-840"><a href="#cb14-840" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-841"><a href="#cb14-841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-842"><a href="#cb14-842" aria-hidden="true" tabindex="-1"></a><span class="fu">## Conexión con Bases de Datos y Big Data</span></span>
<span id="cb14-843"><a href="#cb14-843" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-844"><a href="#cb14-844" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1. **Lectura/Escritura Eficiente con fread/fwrite**</span></span>
<span id="cb14-845"><a href="#cb14-845" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-848"><a href="#cb14-848" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-849"><a href="#cb14-849" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: io-eficiente</span></span>
<span id="cb14-850"><a href="#cb14-850" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb14-851"><a href="#cb14-851" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-852"><a href="#cb14-852" aria-hidden="true" tabindex="-1"></a><span class="co"># === FREAD: Lectura ultrarrápida ===</span></span>
<span id="cb14-853"><a href="#cb14-853" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear archivo de ejemplo grande</span></span>
<span id="cb14-854"><a href="#cb14-854" aria-hidden="true" tabindex="-1"></a>archivo_test <span class="ot">&lt;-</span> <span class="fu">tempfile</span>(<span class="at">fileext =</span> <span class="st">".csv"</span>)</span>
<span id="cb14-855"><a href="#cb14-855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-856"><a href="#cb14-856" aria-hidden="true" tabindex="-1"></a><span class="co"># Generar datos sintéticos para el ejemplo</span></span>
<span id="cb14-857"><a href="#cb14-857" aria-hidden="true" tabindex="-1"></a>datos_grandes <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb14-858"><a href="#cb14-858" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100000</span>,</span>
<span id="cb14-859"><a href="#cb14-859" aria-hidden="true" tabindex="-1"></a>  <span class="at">timestamp =</span> <span class="fu">seq</span>(<span class="fu">as.POSIXct</span>(<span class="st">"2024-01-01"</span>), <span class="at">by =</span> <span class="st">"min"</span>, <span class="at">length.out =</span> <span class="dv">100000</span>),</span>
<span id="cb14-860"><a href="#cb14-860" aria-hidden="true" tabindex="-1"></a>  <span class="at">sensor_value =</span> <span class="fu">round</span>(<span class="fu">rnorm</span>(<span class="dv">100000</span>, <span class="dv">50</span>, <span class="dv">15</span>), <span class="dv">2</span>),</span>
<span id="cb14-861"><a href="#cb14-861" aria-hidden="true" tabindex="-1"></a>  <span class="at">location =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Factory_A"</span>, <span class="st">"Factory_B"</span>, <span class="st">"Factory_C"</span>), <span class="dv">100000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-862"><a href="#cb14-862" aria-hidden="true" tabindex="-1"></a>  <span class="at">quality_score =</span> <span class="fu">round</span>(<span class="fu">runif</span>(<span class="dv">100000</span>, <span class="fl">0.8</span>, <span class="fl">1.0</span>), <span class="dv">3</span>),</span>
<span id="cb14-863"><a href="#cb14-863" aria-hidden="true" tabindex="-1"></a>  <span class="at">batch_id =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>, <span class="dv">100000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-864"><a href="#cb14-864" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-865"><a href="#cb14-865" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-866"><a href="#cb14-866" aria-hidden="true" tabindex="-1"></a><span class="co"># Escribir archivo</span></span>
<span id="cb14-867"><a href="#cb14-867" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Escribiendo archivo de prueba...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-868"><a href="#cb14-868" aria-hidden="true" tabindex="-1"></a>tiempo_write <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb14-869"><a href="#cb14-869" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fwrite</span>(datos_grandes, archivo_test, </span>
<span id="cb14-870"><a href="#cb14-870" aria-hidden="true" tabindex="-1"></a>         <span class="at">nThread =</span> <span class="fu">getDTthreads</span>(),</span>
<span id="cb14-871"><a href="#cb14-871" aria-hidden="true" tabindex="-1"></a>         <span class="at">showProgress =</span> <span class="cn">FALSE</span>)</span>
<span id="cb14-872"><a href="#cb14-872" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb14-873"><a href="#cb14-873" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-874"><a href="#cb14-874" aria-hidden="true" tabindex="-1"></a><span class="co"># Información del archivo</span></span>
<span id="cb14-875"><a href="#cb14-875" aria-hidden="true" tabindex="-1"></a>info_archivo <span class="ot">&lt;-</span> <span class="fu">file.info</span>(archivo_test)</span>
<span id="cb14-876"><a href="#cb14-876" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Archivo creado:"</span>, <span class="fu">round</span>(info_archivo<span class="sc">$</span>size <span class="sc">/</span> <span class="dv">1024</span><span class="sc">^</span><span class="dv">2</span>, <span class="dv">2</span>), <span class="st">"MB</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-877"><a href="#cb14-877" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Tiempo de escritura:"</span>, <span class="fu">round</span>(tiempo_write[<span class="dv">3</span>], <span class="dv">3</span>), <span class="st">"segundos</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-878"><a href="#cb14-878" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-879"><a href="#cb14-879" aria-hidden="true" tabindex="-1"></a><span class="co"># Lectura con diferentes configuraciones</span></span>
<span id="cb14-880"><a href="#cb14-880" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== COMPARACIÓN DE MÉTODOS DE LECTURA ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-881"><a href="#cb14-881" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-882"><a href="#cb14-882" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. fread básico</span></span>
<span id="cb14-883"><a href="#cb14-883" aria-hidden="true" tabindex="-1"></a>tiempo_fread_basico <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb14-884"><a href="#cb14-884" aria-hidden="true" tabindex="-1"></a>  datos_fread <span class="ot">&lt;-</span> <span class="fu">fread</span>(archivo_test, <span class="at">showProgress =</span> <span class="cn">FALSE</span>)</span>
<span id="cb14-885"><a href="#cb14-885" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb14-886"><a href="#cb14-886" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-887"><a href="#cb14-887" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. fread optimizado</span></span>
<span id="cb14-888"><a href="#cb14-888" aria-hidden="true" tabindex="-1"></a>tiempo_fread_opt <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb14-889"><a href="#cb14-889" aria-hidden="true" tabindex="-1"></a>  datos_fread_opt <span class="ot">&lt;-</span> <span class="fu">fread</span>(</span>
<span id="cb14-890"><a href="#cb14-890" aria-hidden="true" tabindex="-1"></a>    archivo_test,</span>
<span id="cb14-891"><a href="#cb14-891" aria-hidden="true" tabindex="-1"></a>    <span class="at">nThread =</span> <span class="fu">getDTthreads</span>(),</span>
<span id="cb14-892"><a href="#cb14-892" aria-hidden="true" tabindex="-1"></a>    <span class="at">select =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"timestamp"</span>, <span class="st">"sensor_value"</span>, <span class="st">"location"</span>),  <span class="co"># Solo columnas necesarias</span></span>
<span id="cb14-893"><a href="#cb14-893" aria-hidden="true" tabindex="-1"></a>    <span class="at">colClasses =</span> <span class="fu">list</span>(<span class="at">character =</span> <span class="st">"location"</span>, <span class="at">numeric =</span> <span class="fu">c</span>(<span class="st">"sensor_value"</span>)),</span>
<span id="cb14-894"><a href="#cb14-894" aria-hidden="true" tabindex="-1"></a>    <span class="at">showProgress =</span> <span class="cn">FALSE</span></span>
<span id="cb14-895"><a href="#cb14-895" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-896"><a href="#cb14-896" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb14-897"><a href="#cb14-897" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-898"><a href="#cb14-898" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. read.csv para comparación</span></span>
<span id="cb14-899"><a href="#cb14-899" aria-hidden="true" tabindex="-1"></a>tiempo_base_r <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb14-900"><a href="#cb14-900" aria-hidden="true" tabindex="-1"></a>  datos_base <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(archivo_test, <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb14-901"><a href="#cb14-901" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb14-902"><a href="#cb14-902" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-903"><a href="#cb14-903" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"fread básico:"</span>, <span class="fu">round</span>(tiempo_fread_basico[<span class="dv">3</span>], <span class="dv">3</span>), <span class="st">"segundos</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-904"><a href="#cb14-904" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"fread optimizado:"</span>, <span class="fu">round</span>(tiempo_fread_opt[<span class="dv">3</span>], <span class="dv">3</span>), <span class="st">"segundos</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-905"><a href="#cb14-905" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"read.csv (base R):"</span>, <span class="fu">round</span>(tiempo_base_r[<span class="dv">3</span>], <span class="dv">3</span>), <span class="st">"segundos</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-906"><a href="#cb14-906" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Speedup fread vs base R:"</span>, <span class="fu">round</span>(tiempo_base_r[<span class="dv">3</span>] <span class="sc">/</span> tiempo_fread_basico[<span class="dv">3</span>], <span class="dv">1</span>), <span class="st">"x</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-907"><a href="#cb14-907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-908"><a href="#cb14-908" aria-hidden="true" tabindex="-1"></a><span class="co"># Verificar que los datos son idénticos</span></span>
<span id="cb14-909"><a href="#cb14-909" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Datos idénticos:"</span>, <span class="fu">identical</span>(datos_fread<span class="sc">$</span>id, datos_fread_opt<span class="sc">$</span>id), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-910"><a href="#cb14-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-911"><a href="#cb14-911" aria-hidden="true" tabindex="-1"></a><span class="co"># Limpiar</span></span>
<span id="cb14-912"><a href="#cb14-912" aria-hidden="true" tabindex="-1"></a><span class="fu">unlink</span>(archivo_test)</span>
<span id="cb14-913"><a href="#cb14-913" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-914"><a href="#cb14-914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-915"><a href="#cb14-915" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2. **Integración con Bases de Datos**</span></span>
<span id="cb14-916"><a href="#cb14-916" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-919"><a href="#cb14-919" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-920"><a href="#cb14-920" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: db-integration</span></span>
<span id="cb14-921"><a href="#cb14-921" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb14-922"><a href="#cb14-922" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb14-923"><a href="#cb14-923" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-924"><a href="#cb14-924" aria-hidden="true" tabindex="-1"></a><span class="co"># Ejemplo de integración con bases de datos</span></span>
<span id="cb14-925"><a href="#cb14-925" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DBI)</span>
<span id="cb14-926"><a href="#cb14-926" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RSQLite)  <span class="co"># o RPostgreSQL, RMySQL, etc.</span></span>
<span id="cb14-927"><a href="#cb14-927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-928"><a href="#cb14-928" aria-hidden="true" tabindex="-1"></a><span class="co"># === SETUP DE CONEXIÓN ===</span></span>
<span id="cb14-929"><a href="#cb14-929" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear base de datos SQLite para el ejemplo</span></span>
<span id="cb14-930"><a href="#cb14-930" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(RSQLite<span class="sc">::</span><span class="fu">SQLite</span>(), <span class="st">":memory:"</span>)</span>
<span id="cb14-931"><a href="#cb14-931" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-932"><a href="#cb14-932" aria-hidden="true" tabindex="-1"></a><span class="co"># Escribir data.table a la base de datos</span></span>
<span id="cb14-933"><a href="#cb14-933" aria-hidden="true" tabindex="-1"></a><span class="fu">dbWriteTable</span>(con, <span class="st">"clientes"</span>, datos_clientes)</span>
<span id="cb14-934"><a href="#cb14-934" aria-hidden="true" tabindex="-1"></a><span class="fu">dbWriteTable</span>(con, <span class="st">"transacciones"</span>, transacciones_detalle)</span>
<span id="cb14-935"><a href="#cb14-935" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-936"><a href="#cb14-936" aria-hidden="true" tabindex="-1"></a><span class="co"># === WORKFLOW HÍBRIDO: SQL + data.table ===</span></span>
<span id="cb14-937"><a href="#cb14-937" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-938"><a href="#cb14-938" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Query inicial en SQL (aprovechar índices de DB)</span></span>
<span id="cb14-939"><a href="#cb14-939" aria-hidden="true" tabindex="-1"></a>query_sql <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb14-940"><a href="#cb14-940" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT c.cliente_id, c.region, c.edad, c.ingresos,</span></span>
<span id="cb14-941"><a href="#cb14-941" aria-hidden="true" tabindex="-1"></a><span class="st">         t.monto, t.fecha_transaccion, t.producto_categoria</span></span>
<span id="cb14-942"><a href="#cb14-942" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM clientes c</span></span>
<span id="cb14-943"><a href="#cb14-943" aria-hidden="true" tabindex="-1"></a><span class="st">  JOIN transacciones t ON c.cliente_id = t.cliente_id</span></span>
<span id="cb14-944"><a href="#cb14-944" aria-hidden="true" tabindex="-1"></a><span class="st">  WHERE c.edad &gt;= 25 AND c.edad &lt;= 65</span></span>
<span id="cb14-945"><a href="#cb14-945" aria-hidden="true" tabindex="-1"></a><span class="st">    AND t.fecha_transaccion &gt;= '2024-01-01'</span></span>
<span id="cb14-946"><a href="#cb14-946" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb14-947"><a href="#cb14-947" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-948"><a href="#cb14-948" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Traer datos a data.table</span></span>
<span id="cb14-949"><a href="#cb14-949" aria-hidden="true" tabindex="-1"></a>datos_query <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">dbGetQuery</span>(con, query_sql))</span>
<span id="cb14-950"><a href="#cb14-950" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-951"><a href="#cb14-951" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Análisis complejo con data.table (más rápido que SQL)</span></span>
<span id="cb14-952"><a href="#cb14-952" aria-hidden="true" tabindex="-1"></a>analisis_hibrido <span class="ot">&lt;-</span> datos_query[,</span>
<span id="cb14-953"><a href="#cb14-953" aria-hidden="true" tabindex="-1"></a>  .(</span>
<span id="cb14-954"><a href="#cb14-954" aria-hidden="true" tabindex="-1"></a>    <span class="at">transacciones_total =</span> .N,</span>
<span id="cb14-955"><a href="#cb14-955" aria-hidden="true" tabindex="-1"></a>    <span class="at">monto_total =</span> <span class="fu">sum</span>(monto),</span>
<span id="cb14-956"><a href="#cb14-956" aria-hidden="true" tabindex="-1"></a>    <span class="at">monto_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(monto), <span class="dv">2</span>),</span>
<span id="cb14-957"><a href="#cb14-957" aria-hidden="true" tabindex="-1"></a>    <span class="at">categorias_distintas =</span> <span class="fu">uniqueN</span>(producto_categoria),</span>
<span id="cb14-958"><a href="#cb14-958" aria-hidden="true" tabindex="-1"></a>    <span class="at">primera_compra =</span> <span class="fu">min</span>(fecha_transaccion),</span>
<span id="cb14-959"><a href="#cb14-959" aria-hidden="true" tabindex="-1"></a>    <span class="at">ultima_compra =</span> <span class="fu">max</span>(fecha_transaccion)</span>
<span id="cb14-960"><a href="#cb14-960" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb14-961"><a href="#cb14-961" aria-hidden="true" tabindex="-1"></a>  by <span class="ot">=</span> .(cliente_id, region)</span>
<span id="cb14-962"><a href="#cb14-962" aria-hidden="true" tabindex="-1"></a>][, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-963"><a href="#cb14-963" aria-hidden="true" tabindex="-1"></a>  <span class="at">dias_activo =</span> <span class="fu">as.numeric</span>(<span class="fu">as.Date</span>(ultima_compra) <span class="sc">-</span> <span class="fu">as.Date</span>(primera_compra)) <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb14-964"><a href="#cb14-964" aria-hidden="true" tabindex="-1"></a>  <span class="at">frecuencia_compra =</span> transacciones_total <span class="sc">/</span> <span class="fu">pmax</span>(<span class="fu">as.numeric</span>(<span class="fu">as.Date</span>(ultima_compra) <span class="sc">-</span> <span class="fu">as.Date</span>(primera_compra)) <span class="sc">+</span> <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb14-965"><a href="#cb14-965" aria-hidden="true" tabindex="-1"></a>)][<span class="fu">order</span>(<span class="sc">-</span>monto_total)]</span>
<span id="cb14-966"><a href="#cb14-966" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-967"><a href="#cb14-967" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Escribir resultados de vuelta a DB (opcional)</span></span>
<span id="cb14-968"><a href="#cb14-968" aria-hidden="true" tabindex="-1"></a><span class="fu">dbWriteTable</span>(con, <span class="st">"analisis_clientes"</span>, analisis_hibrido, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-969"><a href="#cb14-969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-970"><a href="#cb14-970" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Verificación</span></span>
<span id="cb14-971"><a href="#cb14-971" aria-hidden="true" tabindex="-1"></a>resumen_db <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con, <span class="st">"SELECT COUNT(*) as clientes_analizados FROM analisis_clientes"</span>)</span>
<span id="cb14-972"><a href="#cb14-972" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Clientes analizados en DB:"</span>, resumen_db<span class="sc">$</span>clientes_analizados, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-973"><a href="#cb14-973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-974"><a href="#cb14-974" aria-hidden="true" tabindex="-1"></a><span class="co"># Cerrar conexión</span></span>
<span id="cb14-975"><a href="#cb14-975" aria-hidden="true" tabindex="-1"></a><span class="fu">dbDisconnect</span>(con)</span>
<span id="cb14-976"><a href="#cb14-976" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-977"><a href="#cb14-977" aria-hidden="true" tabindex="-1"></a><span class="co"># === MEJORES PRÁCTICAS ===</span></span>
<span id="cb14-978"><a href="#cb14-978" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Usar SQL para filtros iniciales y joins simples</span></span>
<span id="cb14-979"><a href="#cb14-979" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Traer datos a data.table para análisis complejos</span></span>
<span id="cb14-980"><a href="#cb14-980" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Aprovechar índices de DB para WHERE y JOIN</span></span>
<span id="cb14-981"><a href="#cb14-981" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Usar data.table para agregaciones complejas y feature engineering</span></span>
<span id="cb14-982"><a href="#cb14-982" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Escribir resultados finales de vuelta a DB si es necesario</span></span>
<span id="cb14-983"><a href="#cb14-983" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-984"><a href="#cb14-984" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-985"><a href="#cb14-985" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3. **Integración con Apache Arrow/Parquet**</span></span>
<span id="cb14-986"><a href="#cb14-986" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-989"><a href="#cb14-989" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-990"><a href="#cb14-990" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: arrow-integration</span></span>
<span id="cb14-991"><a href="#cb14-991" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb14-992"><a href="#cb14-992" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb14-993"><a href="#cb14-993" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-994"><a href="#cb14-994" aria-hidden="true" tabindex="-1"></a><span class="co"># Ejemplo de integración con ecosistema Arrow</span></span>
<span id="cb14-995"><a href="#cb14-995" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(arrow)</span>
<span id="cb14-996"><a href="#cb14-996" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-997"><a href="#cb14-997" aria-hidden="true" tabindex="-1"></a><span class="co"># === ESCRITURA A PARQUET ===</span></span>
<span id="cb14-998"><a href="#cb14-998" aria-hidden="true" tabindex="-1"></a><span class="co"># Parquet es ultra-eficiente para datasets grandes</span></span>
<span id="cb14-999"><a href="#cb14-999" aria-hidden="true" tabindex="-1"></a>archivo_parquet <span class="ot">&lt;-</span> <span class="fu">tempfile</span>(<span class="at">fileext =</span> <span class="st">".parquet"</span>)</span>
<span id="cb14-1000"><a href="#cb14-1000" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1001"><a href="#cb14-1001" aria-hidden="true" tabindex="-1"></a><span class="co"># Escribir data.table a Parquet</span></span>
<span id="cb14-1002"><a href="#cb14-1002" aria-hidden="true" tabindex="-1"></a><span class="fu">write_parquet</span>(datos_clientes, archivo_parquet)</span>
<span id="cb14-1003"><a href="#cb14-1003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1004"><a href="#cb14-1004" aria-hidden="true" tabindex="-1"></a><span class="co"># === LECTURA DESDE PARQUET ===</span></span>
<span id="cb14-1005"><a href="#cb14-1005" aria-hidden="true" tabindex="-1"></a><span class="co"># Leer directo a data.table</span></span>
<span id="cb14-1006"><a href="#cb14-1006" aria-hidden="true" tabindex="-1"></a>datos_parquet <span class="ot">&lt;-</span> <span class="fu">read_parquet</span>(archivo_parquet, <span class="at">as_data_frame =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-1007"><a href="#cb14-1007" aria-hidden="true" tabindex="-1"></a><span class="fu">setDT</span>(datos_parquet)  <span class="co"># Asegurar que es data.table</span></span>
<span id="cb14-1008"><a href="#cb14-1008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1009"><a href="#cb14-1009" aria-hidden="true" tabindex="-1"></a><span class="co"># === DATASETS PARTICIONADOS ===</span></span>
<span id="cb14-1010"><a href="#cb14-1010" aria-hidden="true" tabindex="-1"></a><span class="co"># Para datasets muy grandes, usar particiones</span></span>
<span id="cb14-1011"><a href="#cb14-1011" aria-hidden="true" tabindex="-1"></a>directorio_particionado <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">tempdir</span>(), <span class="st">"partitioned_data"</span>)</span>
<span id="cb14-1012"><a href="#cb14-1012" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(directorio_particionado, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-1013"><a href="#cb14-1013" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1014"><a href="#cb14-1014" aria-hidden="true" tabindex="-1"></a><span class="co"># Particionar por región - método más robusto</span></span>
<span id="cb14-1015"><a href="#cb14-1015" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(region_name <span class="cf">in</span> <span class="fu">unique</span>(datos_clientes<span class="sc">$</span>region)) {</span>
<span id="cb14-1016"><a href="#cb14-1016" aria-hidden="true" tabindex="-1"></a>  region_data <span class="ot">&lt;-</span> datos_clientes[region <span class="sc">==</span> region_name]</span>
<span id="cb14-1017"><a href="#cb14-1017" aria-hidden="true" tabindex="-1"></a>  archivo_region <span class="ot">&lt;-</span> <span class="fu">file.path</span>(directorio_particionado, <span class="fu">paste0</span>(<span class="st">"region_"</span>, region_name, <span class="st">".parquet"</span>))</span>
<span id="cb14-1018"><a href="#cb14-1018" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_parquet</span>(region_data, archivo_region)</span>
<span id="cb14-1019"><a href="#cb14-1019" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-1020"><a href="#cb14-1020" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1021"><a href="#cb14-1021" aria-hidden="true" tabindex="-1"></a><span class="co"># Verificar que los archivos se crearon correctamente</span></span>
<span id="cb14-1022"><a href="#cb14-1022" aria-hidden="true" tabindex="-1"></a>archivos_parquet <span class="ot">&lt;-</span> <span class="fu">list.files</span>(directorio_particionado, <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.parquet$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-1023"><a href="#cb14-1023" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Archivos Parquet creados:"</span>, <span class="fu">length</span>(archivos_parquet), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-1024"><a href="#cb14-1024" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1025"><a href="#cb14-1025" aria-hidden="true" tabindex="-1"></a><span class="co"># Leer dataset particionado solo si hay archivos válidos</span></span>
<span id="cb14-1026"><a href="#cb14-1026" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(archivos_parquet) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb14-1027"><a href="#cb14-1027" aria-hidden="true" tabindex="-1"></a>  dataset <span class="ot">&lt;-</span> <span class="fu">open_dataset</span>(directorio_particionado)</span>
<span id="cb14-1028"><a href="#cb14-1028" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb14-1029"><a href="#cb14-1029" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"No se pudieron crear archivos Parquet válidos"</span>)</span>
<span id="cb14-1030"><a href="#cb14-1030" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-1031"><a href="#cb14-1031" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1032"><a href="#cb14-1032" aria-hidden="true" tabindex="-1"></a><span class="co"># Query con pushdown de predicados (muy eficiente)</span></span>
<span id="cb14-1033"><a href="#cb14-1033" aria-hidden="true" tabindex="-1"></a><span class="fu">tryCatch</span>({</span>
<span id="cb14-1034"><a href="#cb14-1034" aria-hidden="true" tabindex="-1"></a>  resultado_arrow <span class="ot">&lt;-</span> dataset <span class="sc">%&gt;%</span></span>
<span id="cb14-1035"><a href="#cb14-1035" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(edad <span class="sc">&gt;=</span> <span class="dv">30</span>, satisfaccion <span class="sc">&gt;=</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-1036"><a href="#cb14-1036" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(region) <span class="sc">%&gt;%</span></span>
<span id="cb14-1037"><a href="#cb14-1037" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb14-1038"><a href="#cb14-1038" aria-hidden="true" tabindex="-1"></a>      <span class="at">clientes =</span> <span class="fu">n</span>(),</span>
<span id="cb14-1039"><a href="#cb14-1039" aria-hidden="true" tabindex="-1"></a>      <span class="at">valor_promedio =</span> <span class="fu">mean</span>(valor_cliente),</span>
<span id="cb14-1040"><a href="#cb14-1040" aria-hidden="true" tabindex="-1"></a>      <span class="at">ingresos_promedio =</span> <span class="fu">mean</span>(ingresos)</span>
<span id="cb14-1041"><a href="#cb14-1041" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb14-1042"><a href="#cb14-1042" aria-hidden="true" tabindex="-1"></a>    <span class="fu">collect</span>() <span class="sc">%&gt;%</span>  <span class="co"># Traer a memoria</span></span>
<span id="cb14-1043"><a href="#cb14-1043" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.data.table</span>()  <span class="co"># Convertir a data.table</span></span>
<span id="cb14-1044"><a href="#cb14-1044" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-1045"><a href="#cb14-1045" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(resultado_arrow)</span>
<span id="cb14-1046"><a href="#cb14-1046" aria-hidden="true" tabindex="-1"></a>}, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb14-1047"><a href="#cb14-1047" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Error en consulta Arrow:"</span>, <span class="fu">conditionMessage</span>(e), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-1048"><a href="#cb14-1048" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Usando método alternativo con data.table directo...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-1049"><a href="#cb14-1049" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-1050"><a href="#cb14-1050" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fallback: usar data.table directamente</span></span>
<span id="cb14-1051"><a href="#cb14-1051" aria-hidden="true" tabindex="-1"></a>  resultado_arrow <span class="ot">&lt;-</span> datos_clientes[edad <span class="sc">&gt;=</span> <span class="dv">30</span> <span class="sc">&amp;</span> satisfaccion <span class="sc">&gt;=</span> <span class="dv">4</span>, .(</span>
<span id="cb14-1052"><a href="#cb14-1052" aria-hidden="true" tabindex="-1"></a>    <span class="at">clientes =</span> .N,</span>
<span id="cb14-1053"><a href="#cb14-1053" aria-hidden="true" tabindex="-1"></a>    <span class="at">valor_promedio =</span> <span class="fu">mean</span>(valor_cliente),</span>
<span id="cb14-1054"><a href="#cb14-1054" aria-hidden="true" tabindex="-1"></a>    <span class="at">ingresos_promedio =</span> <span class="fu">mean</span>(ingresos)</span>
<span id="cb14-1055"><a href="#cb14-1055" aria-hidden="true" tabindex="-1"></a>  ), by <span class="ot">=</span> region]</span>
<span id="cb14-1056"><a href="#cb14-1056" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-1057"><a href="#cb14-1057" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(resultado_arrow)</span>
<span id="cb14-1058"><a href="#cb14-1058" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb14-1059"><a href="#cb14-1059" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1060"><a href="#cb14-1060" aria-hidden="true" tabindex="-1"></a><span class="co"># === VENTAJAS DEL WORKFLOW ARROW + DATA.TABLE ===</span></span>
<span id="cb14-1061"><a href="#cb14-1061" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Parquet es extremadamente eficiente en espacio</span></span>
<span id="cb14-1062"><a href="#cb14-1062" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Pushdown de predicados reduce transferencia de datos</span></span>
<span id="cb14-1063"><a href="#cb14-1063" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Compatibilidad con otros lenguajes (Python, Spark)</span></span>
<span id="cb14-1064"><a href="#cb14-1064" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. data.table para análisis final en R</span></span>
<span id="cb14-1065"><a href="#cb14-1065" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-1066"><a href="#cb14-1066" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1067"><a href="#cb14-1067" aria-hidden="true" tabindex="-1"></a><span class="fu">## Casos de Uso Industriales Reales</span></span>
<span id="cb14-1068"><a href="#cb14-1068" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1069"><a href="#cb14-1069" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1. **Sistema de Monitoreo IoT en Tiempo Real**</span></span>
<span id="cb14-1070"><a href="#cb14-1070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1073"><a href="#cb14-1073" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-1074"><a href="#cb14-1074" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: iot-monitoring</span></span>
<span id="cb14-1075"><a href="#cb14-1075" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb14-1076"><a href="#cb14-1076" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1077"><a href="#cb14-1077" aria-hidden="true" tabindex="-1"></a><span class="co"># === ANÁLISIS DE SENSORES IOT ===</span></span>
<span id="cb14-1078"><a href="#cb14-1078" aria-hidden="true" tabindex="-1"></a><span class="co"># Simular análisis en tiempo real de sensores</span></span>
<span id="cb14-1079"><a href="#cb14-1079" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1080"><a href="#cb14-1080" aria-hidden="true" tabindex="-1"></a><span class="co"># Función para procesar batch de datos de sensores</span></span>
<span id="cb14-1081"><a href="#cb14-1081" aria-hidden="true" tabindex="-1"></a>procesar_batch_sensores <span class="ot">&lt;-</span> <span class="cf">function</span>(datos_sensores, <span class="at">ventana_horas =</span> <span class="dv">1</span>) {</span>
<span id="cb14-1082"><a href="#cb14-1082" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Análisis de anomalías en tiempo real</span></span>
<span id="cb14-1083"><a href="#cb14-1083" aria-hidden="true" tabindex="-1"></a>  datos_sensores[,</span>
<span id="cb14-1084"><a href="#cb14-1084" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-1085"><a href="#cb14-1085" aria-hidden="true" tabindex="-1"></a>      <span class="at">temp_anomaly =</span> <span class="fu">abs</span>(temperatura <span class="sc">-</span> <span class="fu">mean</span>(temperatura)) <span class="sc">&gt;</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">sd</span>(temperatura),</span>
<span id="cb14-1086"><a href="#cb14-1086" aria-hidden="true" tabindex="-1"></a>      <span class="at">humidity_anomaly =</span> <span class="fu">abs</span>(humedad <span class="sc">-</span> <span class="fu">mean</span>(humedad)) <span class="sc">&gt;</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">sd</span>(humedad),</span>
<span id="cb14-1087"><a href="#cb14-1087" aria-hidden="true" tabindex="-1"></a>      <span class="at">battery_critical =</span> nivel_bateria <span class="sc">&lt;</span> <span class="dv">15</span></span>
<span id="cb14-1088"><a href="#cb14-1088" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb14-1089"><a href="#cb14-1089" aria-hidden="true" tabindex="-1"></a>    by <span class="ot">=</span> .(sensor_id, fecha)</span>
<span id="cb14-1090"><a href="#cb14-1090" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb14-1091"><a href="#cb14-1091" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-1092"><a href="#cb14-1092" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Resumen por sensor y hora</span></span>
<span id="cb14-1093"><a href="#cb14-1093" aria-hidden="true" tabindex="-1"></a>  resumen_sensores <span class="ot">&lt;-</span> datos_sensores[,</span>
<span id="cb14-1094"><a href="#cb14-1094" aria-hidden="true" tabindex="-1"></a>    .(</span>
<span id="cb14-1095"><a href="#cb14-1095" aria-hidden="true" tabindex="-1"></a>      <span class="at">temp_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(temperatura), <span class="dv">2</span>),</span>
<span id="cb14-1096"><a href="#cb14-1096" aria-hidden="true" tabindex="-1"></a>      <span class="at">temp_min =</span> <span class="fu">min</span>(temperatura),</span>
<span id="cb14-1097"><a href="#cb14-1097" aria-hidden="true" tabindex="-1"></a>      <span class="at">temp_max =</span> <span class="fu">max</span>(temperatura),</span>
<span id="cb14-1098"><a href="#cb14-1098" aria-hidden="true" tabindex="-1"></a>      <span class="at">humedad_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(humedad), <span class="dv">1</span>),</span>
<span id="cb14-1099"><a href="#cb14-1099" aria-hidden="true" tabindex="-1"></a>      <span class="at">presion_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(presion), <span class="dv">1</span>),</span>
<span id="cb14-1100"><a href="#cb14-1100" aria-hidden="true" tabindex="-1"></a>      <span class="at">movimientos_detectados =</span> <span class="fu">sum</span>(movimiento_detectado),</span>
<span id="cb14-1101"><a href="#cb14-1101" aria-hidden="true" tabindex="-1"></a>      <span class="at">anomalias_temp =</span> <span class="fu">sum</span>(temp_anomaly),</span>
<span id="cb14-1102"><a href="#cb14-1102" aria-hidden="true" tabindex="-1"></a>      <span class="at">anomalias_humedad =</span> <span class="fu">sum</span>(humidity_anomaly),</span>
<span id="cb14-1103"><a href="#cb14-1103" aria-hidden="true" tabindex="-1"></a>      <span class="at">alertas_bateria =</span> <span class="fu">sum</span>(battery_critical),</span>
<span id="cb14-1104"><a href="#cb14-1104" aria-hidden="true" tabindex="-1"></a>      <span class="at">lecturas_total =</span> .N,</span>
<span id="cb14-1105"><a href="#cb14-1105" aria-hidden="true" tabindex="-1"></a>      <span class="at">uptime_pct =</span> <span class="fu">round</span>((<span class="dv">1</span> <span class="sc">-</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(temperatura)) <span class="sc">/</span> .N) <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>)</span>
<span id="cb14-1106"><a href="#cb14-1106" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb14-1107"><a href="#cb14-1107" aria-hidden="true" tabindex="-1"></a>    by <span class="ot">=</span> .(sensor_id, fecha, hora)</span>
<span id="cb14-1108"><a href="#cb14-1108" aria-hidden="true" tabindex="-1"></a>  ][, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-1109"><a href="#cb14-1109" aria-hidden="true" tabindex="-1"></a>    <span class="at">estado_sensor =</span> <span class="fu">fcase</span>(</span>
<span id="cb14-1110"><a href="#cb14-1110" aria-hidden="true" tabindex="-1"></a>      alertas_bateria <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"CRÍTICO"</span>,</span>
<span id="cb14-1111"><a href="#cb14-1111" aria-hidden="true" tabindex="-1"></a>      anomalias_temp <span class="sc">+</span> anomalias_humedad <span class="sc">&gt;</span> <span class="dv">5</span>, <span class="st">"ADVERTENCIA"</span>,</span>
<span id="cb14-1112"><a href="#cb14-1112" aria-hidden="true" tabindex="-1"></a>      uptime_pct <span class="sc">&lt;</span> <span class="dv">95</span>, <span class="st">"DEGRADADO"</span>,</span>
<span id="cb14-1113"><a href="#cb14-1113" aria-hidden="true" tabindex="-1"></a>      <span class="at">default =</span> <span class="st">"NORMAL"</span></span>
<span id="cb14-1114"><a href="#cb14-1114" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb14-1115"><a href="#cb14-1115" aria-hidden="true" tabindex="-1"></a>    <span class="at">score_salud =</span> <span class="fu">pmin</span>(<span class="dv">100</span>, uptime_pct <span class="sc">-</span> (anomalias_temp <span class="sc">+</span> anomalias_humedad) <span class="sc">*</span> <span class="dv">5</span> <span class="sc">-</span> alertas_bateria <span class="sc">*</span> <span class="dv">20</span>)</span>
<span id="cb14-1116"><a href="#cb14-1116" aria-hidden="true" tabindex="-1"></a>  )]</span>
<span id="cb14-1117"><a href="#cb14-1117" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-1118"><a href="#cb14-1118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(resumen_sensores)</span>
<span id="cb14-1119"><a href="#cb14-1119" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-1120"><a href="#cb14-1120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1121"><a href="#cb14-1121" aria-hidden="true" tabindex="-1"></a><span class="co"># Procesar datos de sensores</span></span>
<span id="cb14-1122"><a href="#cb14-1122" aria-hidden="true" tabindex="-1"></a>analisis_sensores <span class="ot">&lt;-</span> <span class="fu">procesar_batch_sensores</span>(sensores_iot)</span>
<span id="cb14-1123"><a href="#cb14-1123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1124"><a href="#cb14-1124" aria-hidden="true" tabindex="-1"></a><span class="co"># Dashboard de alertas críticas</span></span>
<span id="cb14-1125"><a href="#cb14-1125" aria-hidden="true" tabindex="-1"></a>alertas_criticas <span class="ot">&lt;-</span> analisis_sensores[</span>
<span id="cb14-1126"><a href="#cb14-1126" aria-hidden="true" tabindex="-1"></a>  estado_sensor <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"CRÍTICO"</span>, <span class="st">"ADVERTENCIA"</span>),</span>
<span id="cb14-1127"><a href="#cb14-1127" aria-hidden="true" tabindex="-1"></a>  .(</span>
<span id="cb14-1128"><a href="#cb14-1128" aria-hidden="true" tabindex="-1"></a>    sensor_id, fecha, hora,</span>
<span id="cb14-1129"><a href="#cb14-1129" aria-hidden="true" tabindex="-1"></a>    estado_sensor, score_salud,</span>
<span id="cb14-1130"><a href="#cb14-1130" aria-hidden="true" tabindex="-1"></a>    anomalias_temp, anomalias_humedad, alertas_bateria,</span>
<span id="cb14-1131"><a href="#cb14-1131" aria-hidden="true" tabindex="-1"></a>    <span class="at">accion_requerida =</span> <span class="fu">fcase</span>(</span>
<span id="cb14-1132"><a href="#cb14-1132" aria-hidden="true" tabindex="-1"></a>      alertas_bateria <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Cambiar_Batería"</span>,</span>
<span id="cb14-1133"><a href="#cb14-1133" aria-hidden="true" tabindex="-1"></a>      anomalias_temp <span class="sc">&gt;</span> <span class="dv">3</span>, <span class="st">"Revisar_Sensor_Temperatura"</span>,</span>
<span id="cb14-1134"><a href="#cb14-1134" aria-hidden="true" tabindex="-1"></a>      anomalias_humedad <span class="sc">&gt;</span> <span class="dv">3</span>, <span class="st">"Revisar_Sensor_Humedad"</span>,</span>
<span id="cb14-1135"><a href="#cb14-1135" aria-hidden="true" tabindex="-1"></a>      <span class="at">default =</span> <span class="st">"Inspección_General"</span></span>
<span id="cb14-1136"><a href="#cb14-1136" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-1137"><a href="#cb14-1137" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-1138"><a href="#cb14-1138" aria-hidden="true" tabindex="-1"></a>][<span class="fu">order</span>(fecha, hora, <span class="sc">-</span>score_salud)]</span>
<span id="cb14-1139"><a href="#cb14-1139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1140"><a href="#cb14-1140" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== ALERTAS CRÍTICAS DEL SISTEMA IOT ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-1141"><a href="#cb14-1141" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(alertas_criticas, <span class="dv">15</span>))</span>
<span id="cb14-1142"><a href="#cb14-1142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1143"><a href="#cb14-1143" aria-hidden="true" tabindex="-1"></a><span class="co"># Estadísticas de salud del sistema</span></span>
<span id="cb14-1144"><a href="#cb14-1144" aria-hidden="true" tabindex="-1"></a>salud_sistema <span class="ot">&lt;-</span> analisis_sensores[,</span>
<span id="cb14-1145"><a href="#cb14-1145" aria-hidden="true" tabindex="-1"></a>  .(</span>
<span id="cb14-1146"><a href="#cb14-1146" aria-hidden="true" tabindex="-1"></a>    <span class="at">sensores_activos =</span> <span class="fu">uniqueN</span>(sensor_id),</span>
<span id="cb14-1147"><a href="#cb14-1147" aria-hidden="true" tabindex="-1"></a>    <span class="at">sensores_criticos =</span> <span class="fu">uniqueN</span>(sensor_id[estado_sensor <span class="sc">==</span> <span class="st">"CRÍTICO"</span>]),</span>
<span id="cb14-1148"><a href="#cb14-1148" aria-hidden="true" tabindex="-1"></a>    <span class="at">sensores_degradados =</span> <span class="fu">uniqueN</span>(sensor_id[estado_sensor <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"ADVERTENCIA"</span>, <span class="st">"DEGRADADO"</span>)]),</span>
<span id="cb14-1149"><a href="#cb14-1149" aria-hidden="true" tabindex="-1"></a>    <span class="at">score_salud_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(score_salud), <span class="dv">1</span>),</span>
<span id="cb14-1150"><a href="#cb14-1150" aria-hidden="true" tabindex="-1"></a>    <span class="at">anomalias_totales =</span> <span class="fu">sum</span>(anomalias_temp <span class="sc">+</span> anomalias_humedad),</span>
<span id="cb14-1151"><a href="#cb14-1151" aria-hidden="true" tabindex="-1"></a>    <span class="at">uptime_sistema =</span> <span class="fu">round</span>(<span class="fu">mean</span>(uptime_pct), <span class="dv">1</span>)</span>
<span id="cb14-1152"><a href="#cb14-1152" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb14-1153"><a href="#cb14-1153" aria-hidden="true" tabindex="-1"></a>  by <span class="ot">=</span> .(fecha)</span>
<span id="cb14-1154"><a href="#cb14-1154" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb14-1155"><a href="#cb14-1155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1156"><a href="#cb14-1156" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== SALUD GENERAL DEL SISTEMA ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-1157"><a href="#cb14-1157" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(salud_sistema))</span>
<span id="cb14-1158"><a href="#cb14-1158" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-1159"><a href="#cb14-1159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1160"><a href="#cb14-1160" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2. **Sistema de Recomendaciones E-commerce**</span></span>
<span id="cb14-1161"><a href="#cb14-1161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1164"><a href="#cb14-1164" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-1165"><a href="#cb14-1165" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: recommender-system</span></span>
<span id="cb14-1166"><a href="#cb14-1166" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb14-1167"><a href="#cb14-1167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1168"><a href="#cb14-1168" aria-hidden="true" tabindex="-1"></a><span class="co"># === MOTOR DE RECOMENDACIONES ===</span></span>
<span id="cb14-1169"><a href="#cb14-1169" aria-hidden="true" tabindex="-1"></a><span class="co"># Sistema basado en comportamiento de compra</span></span>
<span id="cb14-1170"><a href="#cb14-1170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1171"><a href="#cb14-1171" aria-hidden="true" tabindex="-1"></a><span class="co"># Función para calcular similaridad entre clientes</span></span>
<span id="cb14-1172"><a href="#cb14-1172" aria-hidden="true" tabindex="-1"></a>calcular_recomendaciones <span class="ot">&lt;-</span> <span class="cf">function</span>(transacciones_dt, cliente_target, <span class="at">top_n =</span> <span class="dv">5</span>) {</span>
<span id="cb14-1173"><a href="#cb14-1173" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-1174"><a href="#cb14-1174" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Matriz de compras por cliente-categoría</span></span>
<span id="cb14-1175"><a href="#cb14-1175" aria-hidden="true" tabindex="-1"></a>  matriz_compras <span class="ot">&lt;-</span> transacciones_dt[,</span>
<span id="cb14-1176"><a href="#cb14-1176" aria-hidden="true" tabindex="-1"></a>    .(</span>
<span id="cb14-1177"><a href="#cb14-1177" aria-hidden="true" tabindex="-1"></a>      <span class="at">total_comprado =</span> <span class="fu">sum</span>(monto_final),</span>
<span id="cb14-1178"><a href="#cb14-1178" aria-hidden="true" tabindex="-1"></a>      <span class="at">frecuencia =</span> .N</span>
<span id="cb14-1179"><a href="#cb14-1179" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb14-1180"><a href="#cb14-1180" aria-hidden="true" tabindex="-1"></a>    by <span class="ot">=</span> .(cliente_id, producto_categoria)</span>
<span id="cb14-1181"><a href="#cb14-1181" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb14-1182"><a href="#cb14-1182" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-1183"><a href="#cb14-1183" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Perfil del cliente target</span></span>
<span id="cb14-1184"><a href="#cb14-1184" aria-hidden="true" tabindex="-1"></a>  perfil_target <span class="ot">&lt;-</span> matriz_compras[cliente_id <span class="sc">==</span> cliente_target]</span>
<span id="cb14-1185"><a href="#cb14-1185" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-1186"><a href="#cb14-1186" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(perfil_target) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb14-1187"><a href="#cb14-1187" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.table</span>(<span class="at">mensaje =</span> <span class="st">"Cliente no encontrado"</span>))</span>
<span id="cb14-1188"><a href="#cb14-1188" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-1189"><a href="#cb14-1189" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-1190"><a href="#cb14-1190" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Encontrar clientes similares</span></span>
<span id="cb14-1191"><a href="#cb14-1191" aria-hidden="true" tabindex="-1"></a>  clientes_similares <span class="ot">&lt;-</span> matriz_compras[</span>
<span id="cb14-1192"><a href="#cb14-1192" aria-hidden="true" tabindex="-1"></a>    producto_categoria <span class="sc">%in%</span> perfil_target<span class="sc">$</span>producto_categoria <span class="sc">&amp;</span> </span>
<span id="cb14-1193"><a href="#cb14-1193" aria-hidden="true" tabindex="-1"></a>    cliente_id <span class="sc">!=</span> cliente_target,</span>
<span id="cb14-1194"><a href="#cb14-1194" aria-hidden="true" tabindex="-1"></a>    .(</span>
<span id="cb14-1195"><a href="#cb14-1195" aria-hidden="true" tabindex="-1"></a>      <span class="at">overlap_categorias =</span> .N,</span>
<span id="cb14-1196"><a href="#cb14-1196" aria-hidden="true" tabindex="-1"></a>      <span class="at">valor_similar =</span> <span class="fu">sum</span>(total_comprado)</span>
<span id="cb14-1197"><a href="#cb14-1197" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb14-1198"><a href="#cb14-1198" aria-hidden="true" tabindex="-1"></a>    by <span class="ot">=</span> cliente_id</span>
<span id="cb14-1199"><a href="#cb14-1199" aria-hidden="true" tabindex="-1"></a>  ][overlap_categorias <span class="sc">&gt;=</span> <span class="dv">2</span>][<span class="fu">order</span>(<span class="sc">-</span>overlap_categorias, <span class="sc">-</span>valor_similar)]</span>
<span id="cb14-1200"><a href="#cb14-1200" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-1201"><a href="#cb14-1201" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Recomendaciones basadas en clientes similares</span></span>
<span id="cb14-1202"><a href="#cb14-1202" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(clientes_similares) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb14-1203"><a href="#cb14-1203" aria-hidden="true" tabindex="-1"></a>    recomendaciones <span class="ot">&lt;-</span> matriz_compras[</span>
<span id="cb14-1204"><a href="#cb14-1204" aria-hidden="true" tabindex="-1"></a>      cliente_id <span class="sc">%in%</span> <span class="fu">head</span>(clientes_similares<span class="sc">$</span>cliente_id, <span class="dv">20</span>) <span class="sc">&amp;</span></span>
<span id="cb14-1205"><a href="#cb14-1205" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!</span>producto_categoria <span class="sc">%in%</span> perfil_target<span class="sc">$</span>producto_categoria,</span>
<span id="cb14-1206"><a href="#cb14-1206" aria-hidden="true" tabindex="-1"></a>      .(</span>
<span id="cb14-1207"><a href="#cb14-1207" aria-hidden="true" tabindex="-1"></a>        <span class="at">score_recomendacion =</span> <span class="fu">sum</span>(total_comprado),</span>
<span id="cb14-1208"><a href="#cb14-1208" aria-hidden="true" tabindex="-1"></a>        <span class="at">clientes_que_compran =</span> .N,</span>
<span id="cb14-1209"><a href="#cb14-1209" aria-hidden="true" tabindex="-1"></a>        <span class="at">frecuencia_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(frecuencia), <span class="dv">1</span>)</span>
<span id="cb14-1210"><a href="#cb14-1210" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb14-1211"><a href="#cb14-1211" aria-hidden="true" tabindex="-1"></a>      by <span class="ot">=</span> producto_categoria</span>
<span id="cb14-1212"><a href="#cb14-1212" aria-hidden="true" tabindex="-1"></a>    ][clientes_que_compran <span class="sc">&gt;=</span> <span class="dv">3</span>][<span class="fu">order</span>(<span class="sc">-</span>score_recomendacion)][<span class="dv">1</span><span class="sc">:</span>top_n]</span>
<span id="cb14-1213"><a href="#cb14-1213" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-1214"><a href="#cb14-1214" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(recomendaciones)</span>
<span id="cb14-1215"><a href="#cb14-1215" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb14-1216"><a href="#cb14-1216" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.table</span>(<span class="at">mensaje =</span> <span class="st">"No hay suficientes datos para recomendaciones"</span>))</span>
<span id="cb14-1217"><a href="#cb14-1217" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-1218"><a href="#cb14-1218" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-1219"><a href="#cb14-1219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1220"><a href="#cb14-1220" aria-hidden="true" tabindex="-1"></a><span class="co"># Función para análisis de mercado</span></span>
<span id="cb14-1221"><a href="#cb14-1221" aria-hidden="true" tabindex="-1"></a>analizar_tendencias_mercado <span class="ot">&lt;-</span> <span class="cf">function</span>(transacciones_dt, <span class="at">periodo_dias =</span> <span class="dv">30</span>) {</span>
<span id="cb14-1222"><a href="#cb14-1222" aria-hidden="true" tabindex="-1"></a>  fecha_corte <span class="ot">&lt;-</span> <span class="fu">max</span>(transacciones_dt<span class="sc">$</span>fecha_transaccion) <span class="sc">-</span> periodo_dias</span>
<span id="cb14-1223"><a href="#cb14-1223" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-1224"><a href="#cb14-1224" aria-hidden="true" tabindex="-1"></a>  tendencias <span class="ot">&lt;-</span> transacciones_dt[</span>
<span id="cb14-1225"><a href="#cb14-1225" aria-hidden="true" tabindex="-1"></a>    fecha_transaccion <span class="sc">&gt;=</span> fecha_corte,</span>
<span id="cb14-1226"><a href="#cb14-1226" aria-hidden="true" tabindex="-1"></a>    .(</span>
<span id="cb14-1227"><a href="#cb14-1227" aria-hidden="true" tabindex="-1"></a>      <span class="at">ventas_recientes =</span> <span class="fu">sum</span>(monto_final),</span>
<span id="cb14-1228"><a href="#cb14-1228" aria-hidden="true" tabindex="-1"></a>      <span class="at">transacciones_recientes =</span> .N,</span>
<span id="cb14-1229"><a href="#cb14-1229" aria-hidden="true" tabindex="-1"></a>      <span class="at">clientes_unicos =</span> <span class="fu">uniqueN</span>(cliente_id),</span>
<span id="cb14-1230"><a href="#cb14-1230" aria-hidden="true" tabindex="-1"></a>      <span class="at">ticket_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(monto_final), <span class="dv">2</span>),</span>
<span id="cb14-1231"><a href="#cb14-1231" aria-hidden="true" tabindex="-1"></a>      <span class="at">crecimiento_semanal =</span> .N <span class="sc">/</span> (periodo_dias <span class="sc">/</span> <span class="dv">7</span>)</span>
<span id="cb14-1232"><a href="#cb14-1232" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb14-1233"><a href="#cb14-1233" aria-hidden="true" tabindex="-1"></a>    by <span class="ot">=</span> producto_categoria</span>
<span id="cb14-1234"><a href="#cb14-1234" aria-hidden="true" tabindex="-1"></a>  ][<span class="fu">order</span>(<span class="sc">-</span>ventas_recientes)]</span>
<span id="cb14-1235"><a href="#cb14-1235" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-1236"><a href="#cb14-1236" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular métricas adicionales</span></span>
<span id="cb14-1237"><a href="#cb14-1237" aria-hidden="true" tabindex="-1"></a>  tendencias[, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-1238"><a href="#cb14-1238" aria-hidden="true" tabindex="-1"></a>    <span class="at">penetracion_mercado =</span> <span class="fu">round</span>((clientes_unicos <span class="sc">/</span> <span class="fu">uniqueN</span>(transacciones_dt<span class="sc">$</span>cliente_id)) <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>),</span>
<span id="cb14-1239"><a href="#cb14-1239" aria-hidden="true" tabindex="-1"></a>    <span class="at">velocidad_venta =</span> <span class="fu">round</span>(transacciones_recientes <span class="sc">/</span> periodo_dias, <span class="dv">2</span>),</span>
<span id="cb14-1240"><a href="#cb14-1240" aria-hidden="true" tabindex="-1"></a>    <span class="at">categoria_trend =</span> <span class="fu">fcase</span>(</span>
<span id="cb14-1241"><a href="#cb14-1241" aria-hidden="true" tabindex="-1"></a>      crecimiento_semanal <span class="sc">&gt;</span> <span class="fu">quantile</span>(crecimiento_semanal, <span class="fl">0.75</span>), <span class="st">"📈 CRECIENTE"</span>,</span>
<span id="cb14-1242"><a href="#cb14-1242" aria-hidden="true" tabindex="-1"></a>      crecimiento_semanal <span class="sc">&lt;</span> <span class="fu">quantile</span>(crecimiento_semanal, <span class="fl">0.25</span>), <span class="st">"📉 DECLINANTE"</span>,</span>
<span id="cb14-1243"><a href="#cb14-1243" aria-hidden="true" tabindex="-1"></a>      <span class="at">default =</span> <span class="st">"➡️ ESTABLE"</span></span>
<span id="cb14-1244"><a href="#cb14-1244" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-1245"><a href="#cb14-1245" aria-hidden="true" tabindex="-1"></a>  )]</span>
<span id="cb14-1246"><a href="#cb14-1246" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-1247"><a href="#cb14-1247" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(tendencias)</span>
<span id="cb14-1248"><a href="#cb14-1248" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-1249"><a href="#cb14-1249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1250"><a href="#cb14-1250" aria-hidden="true" tabindex="-1"></a><span class="co"># Ejecutar análisis de recomendaciones</span></span>
<span id="cb14-1251"><a href="#cb14-1251" aria-hidden="true" tabindex="-1"></a>cliente_ejemplo <span class="ot">&lt;-</span> datos_clientes[<span class="fu">sample</span>(.N, <span class="dv">1</span>), cliente_id]</span>
<span id="cb14-1252"><a href="#cb14-1252" aria-hidden="true" tabindex="-1"></a>recomendaciones <span class="ot">&lt;-</span> <span class="fu">calcular_recomendaciones</span>(transacciones_detalle, cliente_ejemplo)</span>
<span id="cb14-1253"><a href="#cb14-1253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1254"><a href="#cb14-1254" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== RECOMENDACIONES PARA CLIENTE"</span>, cliente_ejemplo, <span class="st">"===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-1255"><a href="#cb14-1255" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(recomendaciones)</span>
<span id="cb14-1256"><a href="#cb14-1256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1257"><a href="#cb14-1257" aria-hidden="true" tabindex="-1"></a><span class="co"># Análisis de tendencias de mercado</span></span>
<span id="cb14-1258"><a href="#cb14-1258" aria-hidden="true" tabindex="-1"></a>tendencias_mercado <span class="ot">&lt;-</span> <span class="fu">analizar_tendencias_mercado</span>(transacciones_detalle, <span class="dv">60</span>)</span>
<span id="cb14-1259"><a href="#cb14-1259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1260"><a href="#cb14-1260" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== TENDENCIAS DE MERCADO (últimos 60 días) ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-1261"><a href="#cb14-1261" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(tendencias_mercado)</span>
<span id="cb14-1262"><a href="#cb14-1262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1263"><a href="#cb14-1263" aria-hidden="true" tabindex="-1"></a><span class="co"># Análisis de cohorstes de clientes</span></span>
<span id="cb14-1264"><a href="#cb14-1264" aria-hidden="true" tabindex="-1"></a>analisis_cohortes <span class="ot">&lt;-</span> transacciones_detalle[,</span>
<span id="cb14-1265"><a href="#cb14-1265" aria-hidden="true" tabindex="-1"></a>  .(</span>
<span id="cb14-1266"><a href="#cb14-1266" aria-hidden="true" tabindex="-1"></a>    <span class="at">primera_compra =</span> <span class="fu">min</span>(fecha_transaccion),</span>
<span id="cb14-1267"><a href="#cb14-1267" aria-hidden="true" tabindex="-1"></a>    <span class="at">ultima_compra =</span> <span class="fu">max</span>(fecha_transaccion),</span>
<span id="cb14-1268"><a href="#cb14-1268" aria-hidden="true" tabindex="-1"></a>    <span class="at">valor_total =</span> <span class="fu">sum</span>(monto_final),</span>
<span id="cb14-1269"><a href="#cb14-1269" aria-hidden="true" tabindex="-1"></a>    <span class="at">frecuencia_compra =</span> .N</span>
<span id="cb14-1270"><a href="#cb14-1270" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb14-1271"><a href="#cb14-1271" aria-hidden="true" tabindex="-1"></a>  by <span class="ot">=</span> cliente_id</span>
<span id="cb14-1272"><a href="#cb14-1272" aria-hidden="true" tabindex="-1"></a>][, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-1273"><a href="#cb14-1273" aria-hidden="true" tabindex="-1"></a>  <span class="at">cohorte_mes =</span> <span class="fu">format</span>(primera_compra, <span class="st">"%Y-%m"</span>),</span>
<span id="cb14-1274"><a href="#cb14-1274" aria-hidden="true" tabindex="-1"></a>  <span class="at">dias_como_cliente =</span> <span class="fu">as.numeric</span>(ultima_compra <span class="sc">-</span> primera_compra) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb14-1275"><a href="#cb14-1275" aria-hidden="true" tabindex="-1"></a>)][, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-1276"><a href="#cb14-1276" aria-hidden="true" tabindex="-1"></a>  <span class="at">valor_por_dia =</span> <span class="fu">round</span>(valor_total <span class="sc">/</span> <span class="fu">pmax</span>(dias_como_cliente, <span class="dv">1</span>), <span class="dv">2</span>)</span>
<span id="cb14-1277"><a href="#cb14-1277" aria-hidden="true" tabindex="-1"></a>)][,</span>
<span id="cb14-1278"><a href="#cb14-1278" aria-hidden="true" tabindex="-1"></a>  .(</span>
<span id="cb14-1279"><a href="#cb14-1279" aria-hidden="true" tabindex="-1"></a>    <span class="at">clientes_cohorte =</span> .N,</span>
<span id="cb14-1280"><a href="#cb14-1280" aria-hidden="true" tabindex="-1"></a>    <span class="at">valor_promedio_cohorte =</span> <span class="fu">round</span>(<span class="fu">mean</span>(valor_total), <span class="dv">2</span>),</span>
<span id="cb14-1281"><a href="#cb14-1281" aria-hidden="true" tabindex="-1"></a>    <span class="at">dias_retencion_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(dias_como_cliente), <span class="dv">1</span>),</span>
<span id="cb14-1282"><a href="#cb14-1282" aria-hidden="true" tabindex="-1"></a>    <span class="at">valor_por_dia_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(valor_por_dia), <span class="dv">2</span>)</span>
<span id="cb14-1283"><a href="#cb14-1283" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb14-1284"><a href="#cb14-1284" aria-hidden="true" tabindex="-1"></a>  by <span class="ot">=</span> cohorte_mes</span>
<span id="cb14-1285"><a href="#cb14-1285" aria-hidden="true" tabindex="-1"></a>][<span class="fu">order</span>(cohorte_mes)]</span>
<span id="cb14-1286"><a href="#cb14-1286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1287"><a href="#cb14-1287" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== ANÁLISIS DE COHORTES POR MES ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-1288"><a href="#cb14-1288" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(analisis_cohortes, <span class="dv">12</span>))</span>
<span id="cb14-1289"><a href="#cb14-1289" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-1290"><a href="#cb14-1290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1291"><a href="#cb14-1291" aria-hidden="true" tabindex="-1"></a><span class="fu">## Ejercicio Final: Aplicación Completa de Producción</span></span>
<span id="cb14-1292"><a href="#cb14-1292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1293"><a href="#cb14-1293" aria-hidden="true" tabindex="-1"></a>::: {.callout-note icon="false"}</span>
<span id="cb14-1294"><a href="#cb14-1294" aria-hidden="true" tabindex="-1"></a><span class="fu">## 🏋️ Ejercicio 10: Sistema de Analytics Empresarial</span></span>
<span id="cb14-1295"><a href="#cb14-1295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1296"><a href="#cb14-1296" aria-hidden="true" tabindex="-1"></a>Diseña un sistema completo que integre:</span>
<span id="cb14-1297"><a href="#cb14-1297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1298"><a href="#cb14-1298" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Pipeline de datos** con data.table</span>
<span id="cb14-1299"><a href="#cb14-1299" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Dashboard Shiny** interactivo</span>
<span id="cb14-1300"><a href="#cb14-1300" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Modelo predictivo** con tidymodels</span>
<span id="cb14-1301"><a href="#cb14-1301" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Alertas automáticas** </span>
<span id="cb14-1302"><a href="#cb14-1302" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Reportes ejecutivos**</span>
<span id="cb14-1303"><a href="#cb14-1303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1304"><a href="#cb14-1304" aria-hidden="true" tabindex="-1"></a>Usa los datasets de clientes, transacciones y sensores como base.</span>
<span id="cb14-1305"><a href="#cb14-1305" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb14-1306"><a href="#cb14-1306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1307"><a href="#cb14-1307" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip collapse="true"}</span>
<span id="cb14-1308"><a href="#cb14-1308" aria-hidden="true" tabindex="-1"></a><span class="fu">## 💡 Solución del Ejercicio 10</span></span>
<span id="cb14-1309"><a href="#cb14-1309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1312"><a href="#cb14-1312" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-1313"><a href="#cb14-1313" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: solucion-ejercicio-10</span></span>
<span id="cb14-1314"><a href="#cb14-1314" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb14-1315"><a href="#cb14-1315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1316"><a href="#cb14-1316" aria-hidden="true" tabindex="-1"></a><span class="co"># === PIPELINE DE DATOS UNIFICADO ===</span></span>
<span id="cb14-1317"><a href="#cb14-1317" aria-hidden="true" tabindex="-1"></a>crear_pipeline_analytics <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb14-1318"><a href="#cb14-1318" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-1319"><a href="#cb14-1319" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1. CONSOLIDACIÓN DE DATOS</span></span>
<span id="cb14-1320"><a href="#cb14-1320" aria-hidden="true" tabindex="-1"></a>  pipeline_data <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb14-1321"><a href="#cb14-1321" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-1322"><a href="#cb14-1322" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Métricas de clientes</span></span>
<span id="cb14-1323"><a href="#cb14-1323" aria-hidden="true" tabindex="-1"></a>  pipeline_data<span class="sc">$</span>clientes_kpis <span class="ot">&lt;-</span> datos_clientes[,</span>
<span id="cb14-1324"><a href="#cb14-1324" aria-hidden="true" tabindex="-1"></a>    .(</span>
<span id="cb14-1325"><a href="#cb14-1325" aria-hidden="true" tabindex="-1"></a>      <span class="at">clientes_total =</span> .N,</span>
<span id="cb14-1326"><a href="#cb14-1326" aria-hidden="true" tabindex="-1"></a>      <span class="at">valor_total =</span> <span class="fu">sum</span>(valor_cliente),</span>
<span id="cb14-1327"><a href="#cb14-1327" aria-hidden="true" tabindex="-1"></a>      <span class="at">churn_rate =</span> <span class="fu">round</span>(<span class="fu">mean</span>(churn_flag) <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>),</span>
<span id="cb14-1328"><a href="#cb14-1328" aria-hidden="true" tabindex="-1"></a>      <span class="at">satisfaccion_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(satisfaccion), <span class="dv">2</span>),</span>
<span id="cb14-1329"><a href="#cb14-1329" aria-hidden="true" tabindex="-1"></a>      <span class="at">engagement_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(engagement_score), <span class="dv">2</span>)</span>
<span id="cb14-1330"><a href="#cb14-1330" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb14-1331"><a href="#cb14-1331" aria-hidden="true" tabindex="-1"></a>    by <span class="ot">=</span> .(region, categoria_ingresos)</span>
<span id="cb14-1332"><a href="#cb14-1332" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb14-1333"><a href="#cb14-1333" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-1334"><a href="#cb14-1334" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Métricas de transacciones</span></span>
<span id="cb14-1335"><a href="#cb14-1335" aria-hidden="true" tabindex="-1"></a>  pipeline_data<span class="sc">$</span>transacciones_kpis <span class="ot">&lt;-</span> transacciones_detalle[</span>
<span id="cb14-1336"><a href="#cb14-1336" aria-hidden="true" tabindex="-1"></a>    fecha_transaccion <span class="sc">&gt;=</span> <span class="fu">Sys.Date</span>() <span class="sc">-</span> <span class="dv">90</span>,  <span class="co"># Últimos 90 días</span></span>
<span id="cb14-1337"><a href="#cb14-1337" aria-hidden="true" tabindex="-1"></a>    .(</span>
<span id="cb14-1338"><a href="#cb14-1338" aria-hidden="true" tabindex="-1"></a>      <span class="at">revenue_total =</span> <span class="fu">sum</span>(monto_final),</span>
<span id="cb14-1339"><a href="#cb14-1339" aria-hidden="true" tabindex="-1"></a>      <span class="at">transacciones_total =</span> .N,</span>
<span id="cb14-1340"><a href="#cb14-1340" aria-hidden="true" tabindex="-1"></a>      <span class="at">ticket_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(monto_final), <span class="dv">2</span>),</span>
<span id="cb14-1341"><a href="#cb14-1341" aria-hidden="true" tabindex="-1"></a>      <span class="at">clientes_activos =</span> <span class="fu">uniqueN</span>(cliente_id),</span>
<span id="cb14-1342"><a href="#cb14-1342" aria-hidden="true" tabindex="-1"></a>      <span class="at">productos_vendidos =</span> <span class="fu">sum</span>(<span class="dv">1</span> <span class="sc">-</span> es_devolucion)</span>
<span id="cb14-1343"><a href="#cb14-1343" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb14-1344"><a href="#cb14-1344" aria-hidden="true" tabindex="-1"></a>    by <span class="ot">=</span> .(<span class="at">mes =</span> <span class="fu">month</span>(fecha_transaccion), producto_categoria)</span>
<span id="cb14-1345"><a href="#cb14-1345" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb14-1346"><a href="#cb14-1346" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-1347"><a href="#cb14-1347" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estado de sensores IoT</span></span>
<span id="cb14-1348"><a href="#cb14-1348" aria-hidden="true" tabindex="-1"></a>  pipeline_data<span class="sc">$</span>sensores_status <span class="ot">&lt;-</span> sensores_iot[</span>
<span id="cb14-1349"><a href="#cb14-1349" aria-hidden="true" tabindex="-1"></a>    fecha <span class="sc">&gt;=</span> <span class="fu">Sys.Date</span>() <span class="sc">-</span> <span class="dv">7</span>,  <span class="co"># Última semana</span></span>
<span id="cb14-1350"><a href="#cb14-1350" aria-hidden="true" tabindex="-1"></a>    .(</span>
<span id="cb14-1351"><a href="#cb14-1351" aria-hidden="true" tabindex="-1"></a>      <span class="at">sensores_activos =</span> <span class="fu">uniqueN</span>(sensor_id),</span>
<span id="cb14-1352"><a href="#cb14-1352" aria-hidden="true" tabindex="-1"></a>      <span class="at">alertas_criticas =</span> <span class="fu">sum</span>(alerta_temperatura <span class="sc">+</span> alerta_bateria <span class="sc">+</span> alerta_humedad),</span>
<span id="cb14-1353"><a href="#cb14-1353" aria-hidden="true" tabindex="-1"></a>      <span class="at">uptime_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(<span class="dv">1</span> <span class="sc">-</span> <span class="fu">is.na</span>(temperatura)) <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>),</span>
<span id="cb14-1354"><a href="#cb14-1354" aria-hidden="true" tabindex="-1"></a>      <span class="at">score_salud =</span> <span class="fu">round</span>(<span class="fu">mean</span>(<span class="dv">100</span> <span class="sc">-</span> alerta_temperatura <span class="sc">*</span> <span class="dv">20</span> <span class="sc">-</span> alerta_bateria <span class="sc">*</span> <span class="dv">30</span>), <span class="dv">1</span>)</span>
<span id="cb14-1355"><a href="#cb14-1355" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb14-1356"><a href="#cb14-1356" aria-hidden="true" tabindex="-1"></a>    by <span class="ot">=</span> fecha</span>
<span id="cb14-1357"><a href="#cb14-1357" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb14-1358"><a href="#cb14-1358" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-1359"><a href="#cb14-1359" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2. ALERTAS AUTOMÁTICAS</span></span>
<span id="cb14-1360"><a href="#cb14-1360" aria-hidden="true" tabindex="-1"></a>  alertas <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb14-1361"><a href="#cb14-1361" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-1362"><a href="#cb14-1362" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Alerta de churn elevado</span></span>
<span id="cb14-1363"><a href="#cb14-1363" aria-hidden="true" tabindex="-1"></a>  alertas<span class="sc">$</span>churn_critico <span class="ot">&lt;-</span> pipeline_data<span class="sc">$</span>clientes_kpis[</span>
<span id="cb14-1364"><a href="#cb14-1364" aria-hidden="true" tabindex="-1"></a>    churn_rate <span class="sc">&gt;</span> <span class="dv">15</span>,</span>
<span id="cb14-1365"><a href="#cb14-1365" aria-hidden="true" tabindex="-1"></a>    .(region, categoria_ingresos, churn_rate, valor_total)</span>
<span id="cb14-1366"><a href="#cb14-1366" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb14-1367"><a href="#cb14-1367" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-1368"><a href="#cb14-1368" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Alerta de caída de revenue</span></span>
<span id="cb14-1369"><a href="#cb14-1369" aria-hidden="true" tabindex="-1"></a>  alertas<span class="sc">$</span>revenue_bajo <span class="ot">&lt;-</span> pipeline_data<span class="sc">$</span>transacciones_kpis[,</span>
<span id="cb14-1370"><a href="#cb14-1370" aria-hidden="true" tabindex="-1"></a>    .(<span class="at">revenue_cambio =</span> (revenue_total <span class="sc">/</span> <span class="fu">shift</span>(revenue_total, <span class="dv">1</span>) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">100</span>),</span>
<span id="cb14-1371"><a href="#cb14-1371" aria-hidden="true" tabindex="-1"></a>    by <span class="ot">=</span> producto_categoria</span>
<span id="cb14-1372"><a href="#cb14-1372" aria-hidden="true" tabindex="-1"></a>  ][revenue_cambio <span class="sc">&lt;</span> <span class="sc">-</span><span class="dv">10</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(revenue_cambio)]</span>
<span id="cb14-1373"><a href="#cb14-1373" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-1374"><a href="#cb14-1374" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Alerta de sensores críticos</span></span>
<span id="cb14-1375"><a href="#cb14-1375" aria-hidden="true" tabindex="-1"></a>  alertas<span class="sc">$</span>sensores_criticos <span class="ot">&lt;-</span> pipeline_data<span class="sc">$</span>sensores_status[</span>
<span id="cb14-1376"><a href="#cb14-1376" aria-hidden="true" tabindex="-1"></a>    score_salud <span class="sc">&lt;</span> <span class="dv">80</span> <span class="sc">|</span> alertas_criticas <span class="sc">&gt;</span> <span class="dv">10</span></span>
<span id="cb14-1377"><a href="#cb14-1377" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb14-1378"><a href="#cb14-1378" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-1379"><a href="#cb14-1379" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3. DASHBOARD SUMMARY</span></span>
<span id="cb14-1380"><a href="#cb14-1380" aria-hidden="true" tabindex="-1"></a>  dashboard_summary <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb14-1381"><a href="#cb14-1381" aria-hidden="true" tabindex="-1"></a>    <span class="at">kpis_generales =</span> <span class="fu">list</span>(</span>
<span id="cb14-1382"><a href="#cb14-1382" aria-hidden="true" tabindex="-1"></a>      <span class="at">clientes_total =</span> <span class="fu">sum</span>(pipeline_data<span class="sc">$</span>clientes_kpis<span class="sc">$</span>clientes_total),</span>
<span id="cb14-1383"><a href="#cb14-1383" aria-hidden="true" tabindex="-1"></a>      <span class="at">revenue_total =</span> <span class="fu">sum</span>(pipeline_data<span class="sc">$</span>transacciones_kpis<span class="sc">$</span>revenue_total),</span>
<span id="cb14-1384"><a href="#cb14-1384" aria-hidden="true" tabindex="-1"></a>      <span class="at">churn_promedio =</span> <span class="fu">round</span>(<span class="fu">weighted.mean</span>(pipeline_data<span class="sc">$</span>clientes_kpis<span class="sc">$</span>churn_rate, </span>
<span id="cb14-1385"><a href="#cb14-1385" aria-hidden="true" tabindex="-1"></a>                                          pipeline_data<span class="sc">$</span>clientes_kpis<span class="sc">$</span>clientes_total), <span class="dv">1</span>),</span>
<span id="cb14-1386"><a href="#cb14-1386" aria-hidden="true" tabindex="-1"></a>      <span class="at">alertas_activas =</span> <span class="fu">length</span>(alertas<span class="sc">$</span>churn_critico) <span class="sc">+</span> <span class="fu">nrow</span>(alertas<span class="sc">$</span>revenue_bajo) <span class="sc">+</span> <span class="fu">nrow</span>(alertas<span class="sc">$</span>sensores_criticos)</span>
<span id="cb14-1387"><a href="#cb14-1387" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb14-1388"><a href="#cb14-1388" aria-hidden="true" tabindex="-1"></a>    <span class="at">alertas_activas =</span> alertas,</span>
<span id="cb14-1389"><a href="#cb14-1389" aria-hidden="true" tabindex="-1"></a>    <span class="at">datos_pipeline =</span> pipeline_data</span>
<span id="cb14-1390"><a href="#cb14-1390" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-1391"><a href="#cb14-1391" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-1392"><a href="#cb14-1392" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(dashboard_summary)</span>
<span id="cb14-1393"><a href="#cb14-1393" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-1394"><a href="#cb14-1394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1395"><a href="#cb14-1395" aria-hidden="true" tabindex="-1"></a><span class="co"># Ejecutar pipeline</span></span>
<span id="cb14-1396"><a href="#cb14-1396" aria-hidden="true" tabindex="-1"></a>sistema_analytics <span class="ot">&lt;-</span> <span class="fu">crear_pipeline_analytics</span>()</span>
<span id="cb14-1397"><a href="#cb14-1397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1398"><a href="#cb14-1398" aria-hidden="true" tabindex="-1"></a><span class="co"># === REPORTE EJECUTIVO AUTOMÁTICO ===</span></span>
<span id="cb14-1399"><a href="#cb14-1399" aria-hidden="true" tabindex="-1"></a>generar_reporte_ejecutivo <span class="ot">&lt;-</span> <span class="cf">function</span>(analytics_data) {</span>
<span id="cb14-1400"><a href="#cb14-1400" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-1401"><a href="#cb14-1401" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"                    📊 REPORTE EJECUTIVO EMPRESARIAL                     </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-1402"><a href="#cb14-1402" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb14-1403"><a href="#cb14-1403" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-1404"><a href="#cb14-1404" aria-hidden="true" tabindex="-1"></a>  kpis <span class="ot">&lt;-</span> analytics_data<span class="sc">$</span>kpis_generales</span>
<span id="cb14-1405"><a href="#cb14-1405" aria-hidden="true" tabindex="-1"></a>  alertas <span class="ot">&lt;-</span> analytics_data<span class="sc">$</span>alertas_activas</span>
<span id="cb14-1406"><a href="#cb14-1406" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-1407"><a href="#cb14-1407" aria-hidden="true" tabindex="-1"></a>  <span class="co"># KPIs principales</span></span>
<span id="cb14-1408"><a href="#cb14-1408" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"📈 INDICADORES CLAVE DE RENDIMIENTO:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-1409"><a href="#cb14-1409" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"   • Total de Clientes:"</span>, scales<span class="sc">::</span><span class="fu">comma</span>(kpis<span class="sc">$</span>clientes_total), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-1410"><a href="#cb14-1410" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"   • Revenue Total:"</span>, scales<span class="sc">::</span><span class="fu">dollar</span>(kpis<span class="sc">$</span>revenue_total), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-1411"><a href="#cb14-1411" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"   • Tasa de Churn Promedio:"</span>, kpis<span class="sc">$</span>churn_promedio, <span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-1412"><a href="#cb14-1412" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"   • Alertas Activas:"</span>, kpis<span class="sc">$</span>alertas_activas, <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb14-1413"><a href="#cb14-1413" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-1414"><a href="#cb14-1414" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estado de alertas</span></span>
<span id="cb14-1415"><a href="#cb14-1415" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"🚨 ESTADO DE ALERTAS:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-1416"><a href="#cb14-1416" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"   • Regiones con Churn Crítico:"</span>, <span class="fu">nrow</span>(alertas<span class="sc">$</span>churn_critico), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-1417"><a href="#cb14-1417" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"   • Productos con Revenue Bajo:"</span>, <span class="fu">nrow</span>(alertas<span class="sc">$</span>revenue_bajo), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-1418"><a href="#cb14-1418" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"   • Sensores en Estado Crítico:"</span>, <span class="fu">nrow</span>(alertas<span class="sc">$</span>sensores_criticos), <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb14-1419"><a href="#cb14-1419" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-1420"><a href="#cb14-1420" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Recomendaciones automáticas</span></span>
<span id="cb14-1421"><a href="#cb14-1421" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"💡 RECOMENDACIONES AUTOMÁTICAS:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-1422"><a href="#cb14-1422" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(alertas<span class="sc">$</span>churn_critico) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb14-1423"><a href="#cb14-1423" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"   • ACCIÓN INMEDIATA: Implementar programa de retención en regiones críticas</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-1424"><a href="#cb14-1424" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-1425"><a href="#cb14-1425" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(alertas<span class="sc">$</span>revenue_bajo) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb14-1426"><a href="#cb14-1426" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"   • ANÁLISIS REQUERIDO: Investigar caída de ventas en productos específicos</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-1427"><a href="#cb14-1427" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-1428"><a href="#cb14-1428" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(alertas<span class="sc">$</span>sensores_criticos) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb14-1429"><a href="#cb14-1429" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"   • MANTENIMIENTO: Revisar sensores con bajo score de salud</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-1430"><a href="#cb14-1430" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-1431"><a href="#cb14-1431" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(kpis<span class="sc">$</span>alertas_activas <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb14-1432"><a href="#cb14-1432" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"   • ✅ SISTEMA SALUDABLE: Todos los indicadores dentro de rangos normales</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-1433"><a href="#cb14-1433" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-1434"><a href="#cb14-1434" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-1435"><a href="#cb14-1435" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-1436"><a href="#cb14-1436" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Reporte generado automáticamente:"</span>, <span class="fu">format</span>(<span class="fu">Sys.time</span>(), <span class="st">"%Y-%m-%d %H:%M:%S"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-1437"><a href="#cb14-1437" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-1438"><a href="#cb14-1438" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-1439"><a href="#cb14-1439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1440"><a href="#cb14-1440" aria-hidden="true" tabindex="-1"></a><span class="co"># Generar reporte</span></span>
<span id="cb14-1441"><a href="#cb14-1441" aria-hidden="true" tabindex="-1"></a><span class="fu">generar_reporte_ejecutivo</span>(sistema_analytics)</span>
<span id="cb14-1442"><a href="#cb14-1442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1443"><a href="#cb14-1443" aria-hidden="true" tabindex="-1"></a><span class="co"># === MÉTRICAS DETALLADAS ===</span></span>
<span id="cb14-1444"><a href="#cb14-1444" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">📊 DETALLE DE ALERTAS CRÍTICAS:</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb14-1445"><a href="#cb14-1445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1446"><a href="#cb14-1446" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(sistema_analytics<span class="sc">$</span>alertas_activas<span class="sc">$</span>churn_critico) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb14-1447"><a href="#cb14-1447" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"🔴 CHURN CRÍTICO POR REGIÓN:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-1448"><a href="#cb14-1448" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(sistema_analytics<span class="sc">$</span>alertas_activas<span class="sc">$</span>churn_critico)</span>
<span id="cb14-1449"><a href="#cb14-1449" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-1450"><a href="#cb14-1450" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-1451"><a href="#cb14-1451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1452"><a href="#cb14-1452" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(sistema_analytics<span class="sc">$</span>alertas_activas<span class="sc">$</span>revenue_bajo) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb14-1453"><a href="#cb14-1453" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"📉 PRODUCTOS CON REVENUE BAJO:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-1454"><a href="#cb14-1454" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">head</span>(sistema_analytics<span class="sc">$</span>alertas_activas<span class="sc">$</span>revenue_bajo))</span>
<span id="cb14-1455"><a href="#cb14-1455" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-1456"><a href="#cb14-1456" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-1457"><a href="#cb14-1457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1458"><a href="#cb14-1458" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(sistema_analytics<span class="sc">$</span>alertas_activas<span class="sc">$</span>sensores_criticos) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb14-1459"><a href="#cb14-1459" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"⚠️ SENSORES EN ESTADO CRÍTICO:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-1460"><a href="#cb14-1460" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">head</span>(sistema_analytics<span class="sc">$</span>alertas_activas<span class="sc">$</span>sensores_criticos))</span>
<span id="cb14-1461"><a href="#cb14-1461" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-1462"><a href="#cb14-1462" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-1463"><a href="#cb14-1463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1464"><a href="#cb14-1464" aria-hidden="true" tabindex="-1"></a>**Componentes del Sistema Completo:**</span>
<span id="cb14-1465"><a href="#cb14-1465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1466"><a href="#cb14-1466" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Pipeline de Datos**: Consolidación automática de múltiples fuentes</span>
<span id="cb14-1467"><a href="#cb14-1467" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Sistema de Alertas**: Detección automática de anomalías</span>
<span id="cb14-1468"><a href="#cb14-1468" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Dashboard KPIs**: Métricas en tiempo real</span>
<span id="cb14-1469"><a href="#cb14-1469" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Reporte Ejecutivo**: Generación automática de insights</span>
<span id="cb14-1470"><a href="#cb14-1470" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Recomendaciones**: Acciones basadas en datos</span>
<span id="cb14-1471"><a href="#cb14-1471" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>**Escalabilidad**: Modular y extensible</span>
<span id="cb14-1472"><a href="#cb14-1472" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb14-1473"><a href="#cb14-1473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1474"><a href="#cb14-1474" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb14-1475"><a href="#cb14-1475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1476"><a href="#cb14-1476" aria-hidden="true" tabindex="-1"></a>::: {.callout-important}</span>
<span id="cb14-1477"><a href="#cb14-1477" aria-hidden="true" tabindex="-1"></a><span class="fu">## 🎯 Puntos Clave de Este Capítulo</span></span>
<span id="cb14-1478"><a href="#cb14-1478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1479"><a href="#cb14-1479" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Shiny + data.table** = Aplicaciones web ultrarrápidas y responsivas</span>
<span id="cb14-1480"><a href="#cb14-1480" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**tidymodels** se integra perfectamente con data.table para ML robusto</span>
<span id="cb14-1481"><a href="#cb14-1481" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**dtplyr** facilita la transición desde dplyr manteniendo performance</span>
<span id="cb14-1482"><a href="#cb14-1482" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**fread/fwrite** son las herramientas más rápidas de R para I/O</span>
<span id="cb14-1483"><a href="#cb14-1483" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Bases de datos** + data.table = Workflow híbrido óptimo</span>
<span id="cb14-1484"><a href="#cb14-1484" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>**Casos reales** demuestran la versatilidad industrial de data.table</span>
<span id="cb14-1485"><a href="#cb14-1485" aria-hidden="true" tabindex="-1"></a><span class="ss">7. </span>**Sistemas completos** integran múltiples componentes de forma modular</span>
<span id="cb14-1486"><a href="#cb14-1486" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb14-1487"><a href="#cb14-1487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1488"><a href="#cb14-1488" aria-hidden="true" tabindex="-1"></a>Has completado tu formación integral en aplicaciones del mundo real con <span class="in">`data.table`</span>. Ahora tienes las herramientas para construir sistemas completos de analytics empresarial de nivel industrial.</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/tutorial-datatable/tutorial_data.table/issues" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer><script src="site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>