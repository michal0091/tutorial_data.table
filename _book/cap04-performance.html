<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>9&nbsp; Optimización de Performance – Domina data.table en R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./cap04-buenas-practicas.html" rel="next">
<link href="./cap03-reshape.html" rel="prev">
<link href="./images/favicon.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-d14ef1f108961a0fb37502f1e6f08aaf.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-aecbfc4a73d8344c2d918b5cbe22c140.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><style>html{ scroll-behavior: smooth; }</style>
<link rel="stylesheet" href="styles.css">
</head>
<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./cap04-performance.html"><strong>Módulo 4</strong>: Optimización y Buenas Prácticas</a></li><li class="breadcrumb-item"><a href="./cap04-performance.html"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Optimización de Performance</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      <img src="./logos\kinelytic-header-logo.svg" alt="Company name with logo" class="sidebar-logo py-0 d-lg-inline d-none"></a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Domina data.table en R</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/tutorial-datatable/tutorial_data.table" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Prefacio</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introducción a <code>data.table</code></span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text"><strong>Módulo 1</strong>: Fundamentos y Sintaxis Esencial</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap01-sintaxis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">La Sintaxis <code>DT[i, j, by]</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap01-simbolos.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Símbolos Especiales en <code>data.table</code></span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text"><strong>Módulo 2</strong>: Manipulación de Datos Intermedia</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap02-encadenamiento.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Encadenamiento de Operaciones (Chaining)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap02-joins.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Uniones de Datos (Joins)</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text"><strong>Módulo 3</strong>: Técnicas Avanzadas y Funciones Especiales</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap03-joins-avanzados.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Joins Avanzados: Non-Equi y Rolling Joins</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap03-funciones-especiales.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Funciones Especiales y Análisis Temporal</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap03-reshape.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Remodelación de Datos: <code>melt()</code> y <code>dcast()</code></span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text"><strong>Módulo 4</strong>: Optimización y Buenas Prácticas</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap04-performance.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Optimización de Performance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap04-buenas-practicas.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Buenas Prácticas y Código Idiomático</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text"><strong>Módulo 5</strong>: Integración con el Ecosistema R</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap05-visualizacion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Visualización de Datos con data.table</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap05-aplicaciones.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Aplicaciones del Mundo Real</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./conclusion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Conclusiones y Próximos Pasos</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Referencias</span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="2"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#configuraci%C3%B3n-de-threading-para-m%C3%BAltiples-n%C3%BAcleos" id="toc-configuración-de-threading-para-múltiples-núcleos" class="nav-link active" data-scroll-target="#configuraci%C3%B3n-de-threading-para-m%C3%BAltiples-n%C3%BAcleos"><span class="header-section-number">9.1</span> Configuración de Threading para Múltiples Núcleos</a>
  <ul class="collapse">
<li><a href="#configuraci%C3%B3n-%C3%B3ptima-de-threads" id="toc-configuración-óptima-de-threads" class="nav-link" data-scroll-target="#configuraci%C3%B3n-%C3%B3ptima-de-threads"><span class="header-section-number">9.1.1</span> 1. <strong>Configuración Óptima de Threads</strong></a></li>
  <li><a href="#benchmark-de-threading-performance" id="toc-benchmark-de-threading-performance" class="nav-link" data-scroll-target="#benchmark-de-threading-performance"><span class="header-section-number">9.1.2</span> 2. <strong>Benchmark de Threading Performance</strong></a></li>
  </ul>
</li>
  <li>
<a href="#keys-e-%C3%ADndices-la-base-de-la-velocidad" id="toc-keys-e-índices-la-base-de-la-velocidad" class="nav-link" data-scroll-target="#keys-e-%C3%ADndices-la-base-de-la-velocidad"><span class="header-section-number">9.2</span> Keys e Índices: La Base de la Velocidad</a>
  <ul class="collapse">
<li><a href="#setkey-ordenamiento-f%C3%ADsico-para-velocidad" id="toc-setkey-ordenamiento-físico-para-velocidad" class="nav-link" data-scroll-target="#setkey-ordenamiento-f%C3%ADsico-para-velocidad"><span class="header-section-number">9.2.1</span> 1. <strong>Setkey: Ordenamiento Físico para Velocidad</strong></a></li>
  <li><a href="#m%C3%BAltiples-keys-para-diferentes-patrones-de-consulta" id="toc-múltiples-keys-para-diferentes-patrones-de-consulta" class="nav-link" data-scroll-target="#m%C3%BAltiples-keys-para-diferentes-patrones-de-consulta"><span class="header-section-number">9.2.2</span> 2. <strong>Múltiples Keys para Diferentes Patrones de Consulta</strong></a></li>
  <li><a href="#%C3%ADndices-secundarios-con-setindex" id="toc-índices-secundarios-con-setindex" class="nav-link" data-scroll-target="#%C3%ADndices-secundarios-con-setindex"><span class="header-section-number">9.2.3</span> 3. <strong>Índices Secundarios con setindex()</strong></a></li>
  </ul>
</li>
  <li>
<a href="#profiling-y-benchmarking-sistem%C3%A1tico" id="toc-profiling-y-benchmarking-sistemático" class="nav-link" data-scroll-target="#profiling-y-benchmarking-sistem%C3%A1tico"><span class="header-section-number">9.3</span> Profiling y Benchmarking Sistemático</a>
  <ul class="collapse">
<li><a href="#modo-verbose-para-an%C3%A1lisis-detallado" id="toc-modo-verbose-para-análisis-detallado" class="nav-link" data-scroll-target="#modo-verbose-para-an%C3%A1lisis-detallado"><span class="header-section-number">9.3.1</span> 1. <strong>Modo Verbose para Análisis Detallado</strong></a></li>
  <li><a href="#benchmarking-comparativo-de-estrategias" id="toc-benchmarking-comparativo-de-estrategias" class="nav-link" data-scroll-target="#benchmarking-comparativo-de-estrategias"><span class="header-section-number">9.3.2</span> 2. <strong>Benchmarking Comparativo de Estrategias</strong></a></li>
  <li><a href="#memory-profiling-avanzado" id="toc-memory-profiling-avanzado" class="nav-link" data-scroll-target="#memory-profiling-avanzado"><span class="header-section-number">9.3.3</span> 3. <strong>Memory Profiling Avanzado</strong></a></li>
  </ul>
</li>
  <li>
<a href="#optimizaci%C3%B3n-de-operaciones-espec%C3%ADficas" id="toc-optimización-de-operaciones-específicas" class="nav-link" data-scroll-target="#optimizaci%C3%B3n-de-operaciones-espec%C3%ADficas"><span class="header-section-number">9.4</span> Optimización de Operaciones Específicas</a>
  <ul class="collapse">
<li><a href="#joins-a-gran-escala" id="toc-joins-a-gran-escala" class="nav-link" data-scroll-target="#joins-a-gran-escala"><span class="header-section-number">9.4.1</span> 1. <strong>Joins a Gran Escala</strong></a></li>
  <li><a href="#operaciones-temporales-optimizadas" id="toc-operaciones-temporales-optimizadas" class="nav-link" data-scroll-target="#operaciones-temporales-optimizadas"><span class="header-section-number">9.4.2</span> 2. <strong>Operaciones Temporales Optimizadas</strong></a></li>
  </ul>
</li>
  <li>
<a href="#casos-de-uso-de-optimizaci%C3%B3n-extrema" id="toc-casos-de-uso-de-optimización-extrema" class="nav-link" data-scroll-target="#casos-de-uso-de-optimizaci%C3%B3n-extrema"><span class="header-section-number">9.5</span> Casos de Uso de Optimización Extrema</a>
  <ul class="collapse">
<li><a href="#pipeline-de-an%C3%A1lisis-de-alto-rendimiento" id="toc-pipeline-de-análisis-de-alto-rendimiento" class="nav-link" data-scroll-target="#pipeline-de-an%C3%A1lisis-de-alto-rendimiento"><span class="header-section-number">9.5.1</span> 1. <strong>Pipeline de Análisis de Alto Rendimiento</strong></a></li>
  <li><a href="#sistema-de-monitoreo-de-performance-en-tiempo-real" id="toc-sistema-de-monitoreo-de-performance-en-tiempo-real" class="nav-link" data-scroll-target="#sistema-de-monitoreo-de-performance-en-tiempo-real"><span class="header-section-number">9.5.2</span> 2. <strong>Sistema de Monitoreo de Performance en Tiempo Real</strong></a></li>
  </ul>
</li>
  <li><a href="#ejercicio-pr%C3%A1ctico-de-optimizaci%C3%B3n" id="toc-ejercicio-práctico-de-optimización" class="nav-link" data-scroll-target="#ejercicio-pr%C3%A1ctico-de-optimizaci%C3%B3n"><span class="header-section-number">9.6</span> Ejercicio Práctico de Optimización</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/tutorial-datatable/tutorial_data.table/issues" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./cap04-performance.html"><strong>Módulo 4</strong>: Optimización y Buenas Prácticas</a></li><li class="breadcrumb-item"><a href="./cap04-performance.html"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Optimización de Performance</span></a></li></ol></nav><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">
<span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Optimización de Performance</span>
</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Código</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
En este capítulo dominarás
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>
<strong>Configuración de threading</strong> para aprovechar múltiples núcleos</li>
<li>
<strong>Keys e índices</strong> para búsquedas ultra-rápidas</li>
<li>
<strong>Profiling y benchmarking</strong> sistemático de código</li>
<li>
<strong>Optimización de memoria</strong> y gestión eficiente de recursos</li>
<li>
<strong>Identificación de cuellos de botella</strong> en pipelines complejos</li>
<li>
<strong>Técnicas específicas</strong> para datasets grandes (&gt;1M filas)</li>
</ul>
</div>
</div>
<section id="configuración-de-threading-para-múltiples-núcleos" class="level2" data-number="9.1"><h2 data-number="9.1" class="anchored" data-anchor-id="configuración-de-threading-para-múltiples-núcleos">
<span class="header-section-number">9.1</span> Configuración de Threading para Múltiples Núcleos</h2>
<p>El threading automático de <code>data.table</code> puede acelerar dramáticamente las operaciones en máquinas multi-core.</p>
<section id="configuración-óptima-de-threads" class="level3" data-number="9.1.1"><h3 data-number="9.1.1" class="anchored" data-anchor-id="configuración-óptima-de-threads">
<span class="header-section-number">9.1.1</span> 1. <strong>Configuración Óptima de Threads</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Evaluar configuración del sistema</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"=== CONFIGURACIÓN DEL SISTEMA ===\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; === CONFIGURACIÓN DEL SISTEMA ===</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"CPU cores disponibles:"</span>, <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; CPU cores disponibles: 16</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"CPU cores con hyperthreading:"</span>, <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span>logical <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; CPU cores con hyperthreading: 16</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Threads configurados en data.table:"</span>, <span class="fu">getDTthreads</span><span class="op">(</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Threads configurados en data.table: 8</span></span>
<span></span>
<span><span class="co"># Función para determinar configuración óptima</span></span>
<span><span class="va">determine_optimal_threads</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">max_cores</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span>logical <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># Cores físicos</span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">max_cores</span> <span class="op">&lt;=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">max_cores</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">max_cores</span> <span class="op">&lt;=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">max_cores</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">max_cores</span> <span class="op">&lt;=</span> <span class="fl">8</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">max_cores</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>  <span class="co"># Dejar un core libre</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fl">8</span>, <span class="va">max_cores</span> <span class="op">-</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>  <span class="co"># Para sistemas muy grandes, no usar todos</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">optimal_threads</span> <span class="op">&lt;-</span> <span class="fu">determine_optimal_threads</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Configuración recomendada:"</span>, <span class="va">optimal_threads</span>, <span class="st">"threads\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Configuración recomendada: 7 threads</span></span>
<span></span>
<span><span class="co"># Aplicar configuración óptima</span></span>
<span><span class="fu">setDTthreads</span><span class="op">(</span><span class="va">optimal_threads</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Configuración aplicada:"</span>, <span class="fu">getDTthreads</span><span class="op">(</span><span class="op">)</span>, <span class="st">"threads\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Configuración aplicada: 7 threads</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="benchmark-de-threading-performance" class="level3" data-number="9.1.2"><h3 data-number="9.1.2" class="anchored" data-anchor-id="benchmark-de-threading-performance">
<span class="header-section-number">9.1.2</span> 2. <strong>Benchmark de Threading Performance</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Función para benchmark con diferentes configuraciones de threads</span></span>
<span><span class="va">benchmark_threading</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n_threads</span>, <span class="va">dataset_size</span> <span class="op">=</span> <span class="fl">500000</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">setDTthreads</span><span class="op">(</span><span class="va">n_threads</span><span class="op">)</span></span>
<span>  <span class="va">dt_sample</span> <span class="op">&lt;-</span> <span class="va">big_dataset</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">.N</span>, <span class="va">dataset_size</span><span class="op">)</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Operaciones que se benefician del threading</span></span>
<span>  <span class="va">tiempo_agregacion</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">result_agg</span> <span class="op">&lt;-</span> <span class="va">dt_sample</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>      mean_value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">value_numeric</span><span class="op">)</span>,</span>
<span>      sum_amount <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">amount</span><span class="op">)</span>,</span>
<span>      count_records <span class="op">=</span> <span class="va">.N</span>,</span>
<span>      median_value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">value_numeric</span><span class="op">)</span></span>
<span>    <span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">group_major</span>, <span class="va">group_minor</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">tiempo_sort</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">result_sort</span> <span class="op">&lt;-</span> <span class="va">dt_sample</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">value_numeric</span>, <span class="va">group_major</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    threads <span class="op">=</span> <span class="va">n_threads</span>,</span>
<span>    agregacion <span class="op">=</span> <span class="va">tiempo_agregacion</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,</span>
<span>    ordenamiento <span class="op">=</span> <span class="va">tiempo_sort</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,</span>
<span>    total <span class="op">=</span> <span class="va">tiempo_agregacion</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">+</span> <span class="va">tiempo_sort</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Comparar diferentes configuraciones</span></span>
<span><span class="va">configuraciones_threads</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">4</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">resultados_threads</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"=== BENCHMARK DE THREADING ===\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; === BENCHMARK DE THREADING ===</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">configuraciones_threads</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">n_threads</span> <span class="op">&lt;-</span> <span class="va">configuraciones_threads</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Probando con"</span>, <span class="va">n_threads</span>, <span class="st">"thread(s)... "</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">resultado</span> <span class="op">&lt;-</span> <span class="fu">benchmark_threading</span><span class="op">(</span><span class="va">n_threads</span>, <span class="fl">300000</span><span class="op">)</span>  <span class="co"># Dataset más pequeño para rapidez</span></span>
<span>  <span class="va">resultados_threads</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">resultado</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Agregación:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">resultado</span><span class="op">$</span><span class="va">agregacion</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"s, "</span>,</span>
<span>      <span class="st">"Ordenamiento:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">resultado</span><span class="op">$</span><span class="va">ordenamiento</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"s, "</span>,</span>
<span>      <span class="st">"Total:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">resultado</span><span class="op">$</span><span class="va">total</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"s\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Probando con 1 thread(s)... Agregación: 0 s,  Ordenamiento: 0.01 s,  Total: 0.01 s</span></span>
<span><span class="co">#&gt; Probando con 2 thread(s)... Agregación: 0.02 s,  Ordenamiento: 0.02 s,  Total: 0.04 s</span></span>
<span><span class="co">#&gt; Probando con 4 thread(s)... Agregación: 0.02 s,  Ordenamiento: 0.02 s,  Total: 0.04 s</span></span>
<span><span class="co">#&gt; Probando con 8 thread(s)... Agregación: 0 s,  Ordenamiento: 0.01 s,  Total: 0.01 s</span></span>
<span></span>
<span><span class="co"># Crear tabla de resultados</span></span>
<span><span class="va">tabla_threads</span> <span class="op">&lt;-</span> <span class="fu">rbindlist</span><span class="op">(</span><span class="va">resultados_threads</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"\nComparación de performance por número de threads:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "\nComparación de performance por número de threads:"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">tabla_threads</span><span class="op">)</span></span>
<span><span class="co">#&gt;    threads agregacion ordenamiento total</span></span>
<span><span class="co">#&gt;      &lt;num&gt;      &lt;num&gt;        &lt;num&gt; &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:       1       0.00         0.01  0.01</span></span>
<span><span class="co">#&gt; 2:       2       0.02         0.02  0.04</span></span>
<span><span class="co">#&gt; 3:       4       0.02         0.02  0.04</span></span>
<span><span class="co">#&gt; 4:       8       0.00         0.01  0.01</span></span>
<span></span>
<span><span class="co"># Calcular speedup relativo al baseline (1 thread)</span></span>
<span><span class="va">baseline</span> <span class="op">&lt;-</span> <span class="va">tabla_threads</span><span class="op">[</span><span class="va">threads</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">total</span><span class="op">]</span></span>
<span><span class="va">tabla_threads</span><span class="op">[</span>, <span class="va">speedup</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">baseline</span> <span class="op">/</span> <span class="va">total</span>, <span class="fl">2</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"\nSpeedup relativo (vs 1 thread):"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "\nSpeedup relativo (vs 1 thread):"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">tabla_threads</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">threads</span>, <span class="va">total</span>, <span class="va">speedup</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;    threads total speedup</span></span>
<span><span class="co">#&gt;      &lt;num&gt; &lt;num&gt;   &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:       1  0.01    1.00</span></span>
<span><span class="co">#&gt; 2:       2  0.04    0.25</span></span>
<span><span class="co">#&gt; 3:       4  0.04    0.25</span></span>
<span><span class="co">#&gt; 4:       8  0.01    1.00</span></span>
<span></span>
<span><span class="co"># Restaurar configuración óptima</span></span>
<span><span class="fu">setDTthreads</span><span class="op">(</span><span class="va">optimal_threads</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="keys-e-índices-la-base-de-la-velocidad" class="level2" data-number="9.2"><h2 data-number="9.2" class="anchored" data-anchor-id="keys-e-índices-la-base-de-la-velocidad">
<span class="header-section-number">9.2</span> Keys e Índices: La Base de la Velocidad</h2>
<section id="setkey-ordenamiento-físico-para-velocidad" class="level3" data-number="9.2.1"><h3 data-number="9.2.1" class="anchored" data-anchor-id="setkey-ordenamiento-físico-para-velocidad">
<span class="header-section-number">9.2.1</span> 1. <strong>Setkey: Ordenamiento Físico para Velocidad</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Comparar performance con y sin keys</span></span>
<span><span class="va">dt_no_key</span> <span class="op">&lt;-</span> <span class="fu">copy</span><span class="op">(</span><span class="va">big_dataset</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">.N</span>, <span class="fl">500000</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">dt_with_key</span> <span class="op">&lt;-</span> <span class="fu">copy</span><span class="op">(</span><span class="va">dt_no_key</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"=== COMPARACIÓN SETKEY ===\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; === COMPARACIÓN SETKEY ===</span></span>
<span></span>
<span><span class="co"># Tiempo para establecer key</span></span>
<span><span class="va">tiempo_setkey</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="fu">setkey</span><span class="op">(</span><span class="va">dt_with_key</span>, <span class="va">group_major</span>, <span class="va">group_minor</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Tiempo para establecer key:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">tiempo_setkey</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"segundos\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Tiempo para establecer key: 0.02 segundos</span></span>
<span></span>
<span><span class="co"># Comparar búsquedas simples</span></span>
<span><span class="va">valores_busqueda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>, <span class="st">"D"</span>, <span class="st">"E"</span><span class="op">)</span></span>
<span><span class="va">sub_valores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"c"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tiempo_sin_key</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">result_no_key</span> <span class="op">&lt;-</span> <span class="va">dt_no_key</span><span class="op">[</span><span class="va">group_major</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">valores_busqueda</span> <span class="op">&amp;</span> <span class="va">group_minor</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">sub_valores</span><span class="op">]</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tiempo_con_key</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">result_with_key</span> <span class="op">&lt;-</span> <span class="va">dt_with_key</span><span class="op">[</span><span class="fu">.</span><span class="op">(</span><span class="va">valores_busqueda</span>, <span class="va">sub_valores</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Búsqueda sin key:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">tiempo_sin_key</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"segundos\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Búsqueda sin key: 0.02 segundos</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Búsqueda con key:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">tiempo_con_key</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"segundos\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Búsqueda con key: 0 segundos</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Speedup:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">tiempo_sin_key</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">/</span> <span class="va">tiempo_con_key</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"x más rápido\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Speedup: Inf x más rápido</span></span>
<span></span>
<span><span class="co"># Verificar que ambos resultados son equivalentes</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Resultados equivalentes:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">result_no_key</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">result_with_key</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Resultados equivalentes: FALSE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="múltiples-keys-para-diferentes-patrones-de-consulta" class="level3" data-number="9.2.2"><h3 data-number="9.2.2" class="anchored" data-anchor-id="múltiples-keys-para-diferentes-patrones-de-consulta">
<span class="header-section-number">9.2.2</span> 2. <strong>Múltiples Keys para Diferentes Patrones de Consulta</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Crear múltiples copias para diferentes estrategias de indexing</span></span>
<span><span class="va">dt_by_group</span> <span class="op">&lt;-</span> <span class="fu">copy</span><span class="op">(</span><span class="va">big_dataset</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">.N</span>, <span class="fl">300000</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">dt_by_time</span> <span class="op">&lt;-</span> <span class="fu">copy</span><span class="op">(</span><span class="va">dt_by_group</span><span class="op">)</span></span>
<span><span class="va">dt_by_id</span> <span class="op">&lt;-</span> <span class="fu">copy</span><span class="op">(</span><span class="va">dt_by_group</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Establecer diferentes keys según el patrón de uso</span></span>
<span><span class="fu">setkey</span><span class="op">(</span><span class="va">dt_by_group</span>, <span class="va">group_major</span>, <span class="va">group_minor</span><span class="op">)</span></span>
<span><span class="fu">setkey</span><span class="op">(</span><span class="va">dt_by_time</span>, <span class="va">timestamp</span><span class="op">)</span></span>
<span><span class="fu">setkey</span><span class="op">(</span><span class="va">dt_by_id</span>, <span class="va">id</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"=== ESTRATEGIAS DE KEYS ===\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; === ESTRATEGIAS DE KEYS ===</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"dt_by_group key:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu">key</span><span class="op">(</span><span class="va">dt_by_group</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; dt_by_group key: group_major, group_minor</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"dt_by_time key:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu">key</span><span class="op">(</span><span class="va">dt_by_time</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; dt_by_time key: timestamp</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"dt_by_id key:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu">key</span><span class="op">(</span><span class="va">dt_by_id</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span>, <span class="st">"\n\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; dt_by_id key: id</span></span>
<span></span>
<span><span class="co"># Consultas optimizadas según la key</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Consultando por grupos...\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Consultando por grupos...</span></span>
<span><span class="va">tiempo_grupo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">result_grupo</span> <span class="op">&lt;-</span> <span class="va">dt_by_group</span><span class="op">[</span><span class="fu">.</span><span class="op">(</span><span class="st">"A"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"c"</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Consultando por tiempo...\n"</span><span class="op">)</span> </span>
<span><span class="co">#&gt; Consultando por tiempo...</span></span>
<span><span class="va">tiempo_temporal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">result_temporal</span> <span class="op">&lt;-</span> <span class="va">dt_by_time</span><span class="op">[</span><span class="va">timestamp</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"2024-01-01"</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>                               <span class="va">timestamp</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"2024-02-01"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Consultando por IDs...\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Consultando por IDs...</span></span>
<span><span class="va">ids_especificos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">1000000</span>, <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="va">tiempo_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">result_ids</span> <span class="op">&lt;-</span> <span class="va">dt_by_id</span><span class="op">[</span><span class="fu">.</span><span class="op">(</span><span class="va">ids_especificos</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Tiempos de consulta optimizada:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Tiempos de consulta optimizada:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"• Por grupos:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">tiempo_grupo</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"segundos\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; • Por grupos: 0 segundos</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"• Por tiempo:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">tiempo_temporal</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"segundos\n"</span><span class="op">)</span> </span>
<span><span class="co">#&gt; • Por tiempo: 0 segundos</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"• Por IDs:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">tiempo_ids</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"segundos\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; • Por IDs: 0 segundos</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="índices-secundarios-con-setindex" class="level3" data-number="9.2.3"><h3 data-number="9.2.3" class="anchored" data-anchor-id="índices-secundarios-con-setindex">
<span class="header-section-number">9.2.3</span> 3. <strong>Índices Secundarios con setindex()</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Crear tabla con key principal e índices secundarios</span></span>
<span><span class="va">dt_indexed</span> <span class="op">&lt;-</span> <span class="fu">copy</span><span class="op">(</span><span class="va">big_dataset</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">.N</span>, <span class="fl">400000</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu">setkey</span><span class="op">(</span><span class="va">dt_indexed</span>, <span class="va">group_major</span><span class="op">)</span>  <span class="co"># Key principal</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"=== ÍNDICES SECUNDARIOS ===\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; === ÍNDICES SECUNDARIOS ===</span></span>
<span></span>
<span><span class="co"># Crear índices secundarios para consultas frecuentes</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Creando índices secundarios...\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Creando índices secundarios...</span></span>
<span><span class="va">tiempo_indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu">setindex</span><span class="op">(</span><span class="va">dt_indexed</span>, <span class="va">category</span><span class="op">)</span></span>
<span>  <span class="fu">setindex</span><span class="op">(</span><span class="va">dt_indexed</span>, <span class="va">status</span><span class="op">)</span></span>
<span>  <span class="fu">setindex</span><span class="op">(</span><span class="va">dt_indexed</span>, <span class="va">region</span><span class="op">)</span></span>
<span>  <span class="fu">setindex</span><span class="op">(</span><span class="va">dt_indexed</span>, <span class="va">timestamp</span><span class="op">)</span></span>
<span>  <span class="fu">setindex</span><span class="op">(</span><span class="va">dt_indexed</span>, <span class="va">id</span>, <span class="va">value_numeric</span><span class="op">)</span>  <span class="co"># Índice compuesto</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Tiempo para crear índices:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">tiempo_indices</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"segundos\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Tiempo para crear índices: 0.01 segundos</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Índices creados:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu">indices</span><span class="op">(</span><span class="va">dt_indexed</span><span class="op">)</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Índices creados: 5</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu">indices</span><span class="op">(</span><span class="va">dt_indexed</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "category"          "status"            "region"           </span></span>
<span><span class="co">#&gt; [4] "timestamp"         "id__value_numeric"</span></span>
<span></span>
<span><span class="co"># Comparar consultas con y sin índices</span></span>
<span><span class="va">dt_sin_indices</span> <span class="op">&lt;-</span> <span class="fu">copy</span><span class="op">(</span><span class="va">big_dataset</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">.N</span>, <span class="fl">400000</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Consulta que puede usar índice</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\nComparando consultas por categoría:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Comparando consultas por categoría:</span></span>
<span><span class="va">tiempo_sin_indice</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">result_sin_indice</span> <span class="op">&lt;-</span> <span class="va">dt_sin_indices</span><span class="op">[</span><span class="va">category</span> <span class="op">==</span> <span class="st">"Cat_5"</span> <span class="op">&amp;</span> <span class="va">status</span> <span class="op">==</span> <span class="st">"Active"</span><span class="op">]</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tiempo_con_indice</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">result_con_indice</span> <span class="op">&lt;-</span> <span class="va">dt_indexed</span><span class="op">[</span><span class="va">category</span> <span class="op">==</span> <span class="st">"Cat_5"</span> <span class="op">&amp;</span> <span class="va">status</span> <span class="op">==</span> <span class="st">"Active"</span><span class="op">]</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Sin índice:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">tiempo_sin_indice</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"segundos\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Sin índice: 0 segundos</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Con índice:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">tiempo_con_indice</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"segundos\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Con índice: 0 segundos</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Speedup:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">tiempo_sin_indice</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">/</span> <span class="va">tiempo_con_indice</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"x\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Speedup: NaN x</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="profiling-y-benchmarking-sistemático" class="level2" data-number="9.3"><h2 data-number="9.3" class="anchored" data-anchor-id="profiling-y-benchmarking-sistemático">
<span class="header-section-number">9.3</span> Profiling y Benchmarking Sistemático</h2>
<section id="modo-verbose-para-análisis-detallado" class="level3" data-number="9.3.1"><h3 data-number="9.3.1" class="anchored" data-anchor-id="modo-verbose-para-análisis-detallado">
<span class="header-section-number">9.3.1</span> 1. <strong>Modo Verbose para Análisis Detallado</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Activar modo verbose para operaciones específicas</span></span>
<span><span class="va">verbose_analysis</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dt</span>, <span class="va">operation_name</span>, <span class="va">operation_func</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"=== ANÁLISIS:"</span>, <span class="va">operation_name</span>, <span class="st">"===\n"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Activar verbose temporalmente</span></span>
<span>  <span class="va">old_verbose</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html">getOption</a></span><span class="op">(</span><span class="st">"datatable.verbose"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>datatable.verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Ejecutar operación</span></span>
<span>  <span class="va">start_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">operation_func</span><span class="op">(</span><span class="va">dt</span><span class="op">)</span></span>
<span>  <span class="va">end_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Restaurar verbose</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>datatable.verbose <span class="op">=</span> <span class="va">old_verbose</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Tiempo total:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">end_time</span> <span class="op">-</span> <span class="va">start_time</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"segundos\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Filas resultado:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span>, <span class="st">"\n\n"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Ejemplo de análisis con verbose</span></span>
<span><span class="va">dt_sample</span> <span class="op">&lt;-</span> <span class="va">big_dataset</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">.N</span>, <span class="fl">100000</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Operación compleja para analizar</span></span>
<span><span class="va">resultado_verbose</span> <span class="op">&lt;-</span> <span class="fu">verbose_analysis</span><span class="op">(</span><span class="va">dt_sample</span>, <span class="st">"Agregación Compleja"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">dt</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">dt</span><span class="op">[</span><span class="va">status</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Active"</span>, <span class="st">"Completed"</span><span class="op">)</span>, </span>
<span>     <span class="fu">.</span><span class="op">(</span>avg_value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">value_numeric</span><span class="op">)</span>,</span>
<span>       sum_amount <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">amount</span><span class="op">)</span>,</span>
<span>       count <span class="op">=</span> <span class="va">.N</span>,</span>
<span>       median_amount <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">amount</span><span class="op">)</span><span class="op">)</span>, </span>
<span>     by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">group_major</span>, <span class="va">category</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; === ANÁLISIS: Agregación Compleja ===</span></span>
<span><span class="co">#&gt; Creando nuevo índice 'status'</span></span>
<span><span class="co">#&gt; Creación de índice status finalizó en ...&lt;forder.c&gt;: recibió 100000 filas y 10 columnas</span></span>
<span><span class="co">#&gt; forderReuseSorting: opt=-1, tomó 0.001s</span></span>
<span><span class="co">#&gt; 0.000s elapsed (0.000s cpu) </span></span>
<span><span class="co">#&gt; Se optimizó la selección de subconjunto con índice 'status'</span></span>
<span><span class="co">#&gt; &lt;forder.c&gt;: recibió 2 filas y 1 columnas</span></span>
<span><span class="co">#&gt; forderReuseSorting: opt=-1, tomó 0.000s</span></span>
<span><span class="co">#&gt; forder tomó 0.000 seg</span></span>
<span><span class="co">#&gt; x ya está ordenado por estas columnas, no se requiere 'reorder'</span></span>
<span><span class="co">#&gt; i.status tiene el mismo tipo (character) que x.status. No se requiere coerción.</span></span>
<span><span class="co">#&gt; on= coincide con índice existente, usando índice</span></span>
<span><span class="co">#&gt; Inidiando bmerge ...</span></span>
<span><span class="co">#&gt; forderReuseSorting: usando key: __status</span></span>
<span><span class="co">#&gt; forderReuseSorting: opt=1, tomó 0.001s</span></span>
<span><span class="co">#&gt; bmerge: bucle bmerge_r tomó 0.000s</span></span>
<span><span class="co">#&gt; bmerge: tomó 0.001s</span></span>
<span><span class="co">#&gt; bmerge finalizado en 0.000s elapsed (0.000s cpu)</span></span>
<span><span class="co">#&gt; Construyendo irows para '!byjoin || nqbyjoin' ... 0.000s elapsed (0.000s cpu) </span></span>
<span><span class="co">#&gt; Reordenar 49856 filas luego de bmerge finalizó en ... forderReuseSorting: opt no posible: is.data.table(DT)=0, sortGroups=1, all1(ascArg)=1</span></span>
<span><span class="co">#&gt; &lt;forder.c&gt;: recibió un tipo de vector 'integer' de longitud 49856</span></span>
<span><span class="co">#&gt; forderReuseSorting: opt=0, tomó 0.001s</span></span>
<span><span class="co">#&gt; 0.000s elapsed (0.000s cpu) </span></span>
<span><span class="co">#&gt; cláusula 'i' presente y se detectaron las columnas usadas en by, sólo este subconjunto: [group_major, category]</span></span>
<span><span class="co">#&gt; Se detectó que j usa estas columnas: [value_numeric, amount]</span></span>
<span><span class="co">#&gt; Buscando grupos conn forderv ... forderReuseSorting: opt no posible: is.data.table(DT)=0, sortGroups=0, all1(ascArg)=1</span></span>
<span><span class="co">#&gt; &lt;forder.c&gt;: recibió 49856 filas y 2 columnas</span></span>
<span><span class="co">#&gt; forderReuseSorting: opt=0, tomó 0.000s</span></span>
<span><span class="co">#&gt; 0.000s elapsed (0.000s cpu) </span></span>
<span><span class="co">#&gt; Buscando tamaño de grupos a partir de la posición (se puede omitir para ahorrar RAM) ... 0.000s elapsed (0.000s cpu) </span></span>
<span><span class="co">#&gt; Restaurando orden original ... forderReuseSorting: opt no posible: is.data.table(DT)=0, sortGroups=1, all1(ascArg)=1</span></span>
<span><span class="co">#&gt; &lt;forder.c&gt;: recibió un tipo de vector 'integer' de longitud 540</span></span>
<span><span class="co">#&gt; forderReuseSorting: opt=0, tomó 0.001s</span></span>
<span><span class="co">#&gt; 0.000s elapsed (0.000s cpu) </span></span>
<span><span class="co">#&gt; Optimización de lapply activada, j sin cambios: 'list(mean(value_numeric), sum(amount), .N, median(amount))'</span></span>
<span><span class="co">#&gt; Optimización GForce de j: 'list(gmean(value_numeric), gsum(amount), .N, gmedian(amount))' (see ?GForce)</span></span>
<span><span class="co">#&gt; Generando grupos y ejecutando j en cada uno (GForce TRUE) ... gforce población inicial de grp tomó 0.000</span></span>
<span><span class="co">#&gt; asignación gforce high y low tomó 0.000</span></span>
<span><span class="co">#&gt; Este gmean tomó (narm=FALSE)... la recopilación tomó  0.000s</span></span>
<span><span class="co">#&gt; 0.000s</span></span>
<span><span class="co">#&gt; Este gsum (narm=FALSE) tomó... la recopilación tomó  0.000s</span></span>
<span><span class="co">#&gt; 0.000s</span></span>
<span><span class="co">#&gt; la evaluación de gforce tomó 0.001</span></span>
<span><span class="co">#&gt; 0.000s elapsed (0.000s cpu) </span></span>
<span><span class="co">#&gt; Tiempo total: 0.1081 segundos</span></span>
<span><span class="co">#&gt; Filas resultado: 540</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">resultado_verbose</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    group_major category avg_value sum_amount count median_amount</span></span>
<span><span class="co">#&gt;         &lt;char&gt;   &lt;char&gt;     &lt;num&gt;      &lt;num&gt; &lt;int&gt;         &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:           A    Cat_1 100.70722   28843.49    51        148.84</span></span>
<span><span class="co">#&gt; 2:        &lt;NA&gt;   Cat_14 101.44601  668919.82  1237        158.52</span></span>
<span><span class="co">#&gt; 3:           R   Cat_17  98.79088   21923.92    59         90.07</span></span>
<span><span class="co">#&gt; 4:        &lt;NA&gt;   Cat_16 100.60555  590698.94  1215        147.68</span></span>
<span><span class="co">#&gt; 5:           E    Cat_3  95.65443   34422.37    53        216.94</span></span>
<span><span class="co">#&gt; 6:        &lt;NA&gt;    Cat_7 101.14619  520769.40  1213        150.37</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="benchmarking-comparativo-de-estrategias" class="level3" data-number="9.3.2"><h3 data-number="9.3.2" class="anchored" data-anchor-id="benchmarking-comparativo-de-estrategias">
<span class="header-section-number">9.3.2</span> 2. <strong>Benchmarking Comparativo de Estrategias</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Crear función de benchmark comprehensiva</span></span>
<span><span class="va">benchmark_comprehensive</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dt_size</span> <span class="op">=</span> <span class="fl">200000</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">dt_test</span> <span class="op">&lt;-</span> <span class="va">big_dataset</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">.N</span>, <span class="va">dt_size</span><span class="op">)</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Estrategia 1: Sin optimizaciones</span></span>
<span>  <span class="va">strategy1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">dt_test</span><span class="op">[</span><span class="va">group_major</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">status</span> <span class="op">==</span> <span class="st">"Active"</span>,</span>
<span>           <span class="fu">.</span><span class="op">(</span>mean_val <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">value_numeric</span><span class="op">)</span>, </span>
<span>             sum_amount <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">amount</span><span class="op">)</span>,</span>
<span>             count <span class="op">=</span> <span class="va">.N</span><span class="op">)</span>,</span>
<span>           by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">group_minor</span>, <span class="va">category</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Estrategia 2: Con setkey optimizado</span></span>
<span>  <span class="va">dt_keyed</span> <span class="op">&lt;-</span> <span class="fu">copy</span><span class="op">(</span><span class="va">dt_test</span><span class="op">)</span></span>
<span>  <span class="fu">setkey</span><span class="op">(</span><span class="va">dt_keyed</span>, <span class="va">group_major</span>, <span class="va">group_minor</span><span class="op">)</span></span>
<span>  <span class="va">strategy2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">dt_keyed</span><span class="op">[</span><span class="fu">.</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="va">status</span> <span class="op">==</span> <span class="st">"Active"</span>,</span>
<span>            <span class="fu">.</span><span class="op">(</span>mean_val <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">value_numeric</span><span class="op">)</span>,</span>
<span>              sum_amount <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">amount</span><span class="op">)</span>, </span>
<span>              count <span class="op">=</span> <span class="va">.N</span><span class="op">)</span>,</span>
<span>            by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">group_minor</span>, <span class="va">category</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Estrategia 3: Pre-filtrar luego agrupar</span></span>
<span>  <span class="va">strategy3</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">dt_filtered</span> <span class="op">&lt;-</span> <span class="va">dt_test</span><span class="op">[</span><span class="va">group_major</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">status</span> <span class="op">==</span> <span class="st">"Active"</span><span class="op">]</span></span>
<span>    <span class="va">dt_filtered</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>mean_val <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">value_numeric</span><span class="op">)</span>,</span>
<span>                   sum_amount <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">amount</span><span class="op">)</span>,</span>
<span>                   count <span class="op">=</span> <span class="va">.N</span><span class="op">)</span>,</span>
<span>               by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">group_minor</span>, <span class="va">category</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Estrategia 4: Con índices secundarios</span></span>
<span>  <span class="va">dt_indexed</span> <span class="op">&lt;-</span> <span class="fu">copy</span><span class="op">(</span><span class="va">dt_test</span><span class="op">)</span></span>
<span>  <span class="fu">setindex</span><span class="op">(</span><span class="va">dt_indexed</span>, <span class="va">group_major</span><span class="op">)</span></span>
<span>  <span class="fu">setindex</span><span class="op">(</span><span class="va">dt_indexed</span>, <span class="va">status</span><span class="op">)</span></span>
<span>  <span class="va">strategy4</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">dt_indexed</span><span class="op">[</span><span class="va">group_major</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">status</span> <span class="op">==</span> <span class="st">"Active"</span>,</span>
<span>              <span class="fu">.</span><span class="op">(</span>mean_val <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">value_numeric</span><span class="op">)</span>,</span>
<span>                sum_amount <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">amount</span><span class="op">)</span>,</span>
<span>                count <span class="op">=</span> <span class="va">.N</span><span class="op">)</span>,</span>
<span>              by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">group_minor</span>, <span class="va">category</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Ejecutar benchmark</span></span>
<span>  <span class="va">benchmark_result</span> <span class="op">&lt;-</span> <span class="fu">microbenchmark</span><span class="op">(</span></span>
<span>    <span class="st">"Sin optimizar"</span> <span class="op">=</span> <span class="fu">strategy1</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    <span class="st">"Con setkey"</span> <span class="op">=</span> <span class="fu">strategy2</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    <span class="st">"Pre-filtrar"</span> <span class="op">=</span> <span class="fu">strategy3</span><span class="op">(</span><span class="op">)</span>, </span>
<span>    <span class="st">"Con índices"</span> <span class="op">=</span> <span class="fu">strategy4</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    times <span class="op">=</span> <span class="fl">10</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">benchmark_result</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Ejecutar benchmark comprehensivo</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"=== BENCHMARK COMPREHENSIVO DE ESTRATEGIAS ===\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; === BENCHMARK COMPREHENSIVO DE ESTRATEGIAS ===</span></span>
<span><span class="va">benchmark_result</span> <span class="op">&lt;-</span> <span class="fu">benchmark_comprehensive</span><span class="op">(</span><span class="fl">150000</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">benchmark_result</span><span class="op">)</span></span>
<span><span class="co">#&gt; Unit: milliseconds</span></span>
<span><span class="co">#&gt;           expr    min     lq    mean  median     uq    max neval</span></span>
<span><span class="co">#&gt;  Sin optimizar 2.1022 2.1491 2.28405 2.21155 2.3934 2.5935    10</span></span>
<span><span class="co">#&gt;     Con setkey 2.5918 2.7351 3.01076 2.95595 3.1528 3.8886    10</span></span>
<span><span class="co">#&gt;    Pre-filtrar 2.2044 2.4296 3.00480 2.75425 3.1098 4.5300    10</span></span>
<span><span class="co">#&gt;    Con índices 2.1676 2.3223 2.51195 2.41860 2.4670 3.7775    10</span></span>
<span></span>
<span><span class="co"># Crear visualización si ggplot2 está disponible</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">plot_benchmark</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">benchmark_result</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Comparación de Estrategias de Optimización"</span>,</span>
<span>         subtitle <span class="op">=</span> <span class="st">"Menor tiempo = mejor performance"</span>,</span>
<span>         y <span class="op">=</span> <span class="st">"Tiempo (milisegundos)"</span>,</span>
<span>         x <span class="op">=</span> <span class="st">"Estrategia"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">plot_benchmark</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="cap04-performance_files/figure-html/benchmark-estrategias-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span></span>
<span><span class="co"># Análisis de resultados</span></span>
<span><span class="va">summary_benchmark</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">benchmark_result</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"\nResumen de performance:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "\nResumen de performance:"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">summary_benchmark</span><span class="op">)</span></span>
<span><span class="co">#&gt;            expr    min     lq    mean  median     uq    max neval</span></span>
<span><span class="co">#&gt; 1 Sin optimizar 2.1022 2.1491 2.28405 2.21155 2.3934 2.5935    10</span></span>
<span><span class="co">#&gt; 2    Con setkey 2.5918 2.7351 3.01076 2.95595 3.1528 3.8886    10</span></span>
<span><span class="co">#&gt; 3   Pre-filtrar 2.2044 2.4296 3.00480 2.75425 3.1098 4.5300    10</span></span>
<span><span class="co">#&gt; 4   Con índices 2.1676 2.3223 2.51195 2.41860 2.4670 3.7775    10</span></span>
<span></span>
<span><span class="co"># Calcular speedup relativo</span></span>
<span><span class="va">baseline_median</span> <span class="op">&lt;-</span> <span class="va">summary_benchmark</span><span class="op">[</span><span class="va">summary_benchmark</span><span class="op">$</span><span class="va">expr</span> <span class="op">==</span> <span class="st">"Sin optimizar"</span>, <span class="st">"median"</span><span class="op">]</span></span>
<span><span class="va">summary_benchmark</span><span class="op">$</span><span class="va">speedup</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">baseline_median</span> <span class="op">/</span> <span class="va">summary_benchmark</span><span class="op">$</span><span class="va">median</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"\nSpeedup relativo (vs sin optimizar):"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "\nSpeedup relativo (vs sin optimizar):"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">summary_benchmark</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"expr"</span>, <span class="st">"median"</span>, <span class="st">"speedup"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;            expr  median speedup</span></span>
<span><span class="co">#&gt; 1 Sin optimizar 2.21155    1.00</span></span>
<span><span class="co">#&gt; 2    Con setkey 2.95595    0.75</span></span>
<span><span class="co">#&gt; 3   Pre-filtrar 2.75425    0.80</span></span>
<span><span class="co">#&gt; 4   Con índices 2.41860    0.91</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="memory-profiling-avanzado" class="level3" data-number="9.3.3"><h3 data-number="9.3.3" class="anchored" data-anchor-id="memory-profiling-avanzado">
<span class="header-section-number">9.3.3</span> 3. <strong>Memory Profiling Avanzado</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Función para análisis detallado de memoria</span></span>
<span><span class="va">memory_analysis</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">operation_name</span>, <span class="va">operation_func</span>, <span class="va">dt_input</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"=== ANÁLISIS DE MEMORIA:"</span>, <span class="va">operation_name</span>, <span class="st">"===\n"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Limpiar garbage collector</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/gc.html">gc</a></span><span class="op">(</span>verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Memoria antes</span></span>
<span>  <span class="va">mem_before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html">object.size</a></span><span class="op">(</span><span class="va">dt_input</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Ejecutar operación y medir tiempo</span></span>
<span>  <span class="va">start_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">operation_func</span><span class="op">(</span><span class="va">dt_input</span><span class="op">)</span></span>
<span>  <span class="va">end_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Memoria después</span></span>
<span>  <span class="va">mem_after</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html">object.size</a></span><span class="op">(</span><span class="va">dt_input</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">mem_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html">object.size</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Reportar resultados</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Tiempo de ejecución:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">end_time</span> <span class="op">-</span> <span class="va">start_time</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"segundos\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Memoria input:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="va">mem_before</span>, units <span class="op">=</span> <span class="st">"auto"</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Memoria después:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="va">mem_after</span>, units <span class="op">=</span> <span class="st">"auto"</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Memoria resultado:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="va">mem_result</span>, units <span class="op">=</span> <span class="st">"auto"</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Cambio en memoria input:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="va">mem_after</span> <span class="op">-</span> <span class="va">mem_before</span>, units <span class="op">=</span> <span class="st">"auto"</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Eficiencia memoria:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">mem_result</span> <span class="op">/</span> <span class="va">mem_before</span> <span class="op">*</span> <span class="fl">100</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"% del input\n\n"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Comparar diferentes operaciones</span></span>
<span><span class="va">dt_mem_test</span> <span class="op">&lt;-</span> <span class="va">big_dataset</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">.N</span>, <span class="fl">100000</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Operación 1: Modificación por referencia</span></span>
<span><span class="va">result1</span> <span class="op">&lt;-</span> <span class="fu">memory_analysis</span><span class="op">(</span><span class="st">"Modificación por referencia"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">dt</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">dt</span><span class="op">[</span>, <span class="va">new_computed_col</span> <span class="op">:=</span> <span class="va">value_numeric</span> <span class="op">*</span> <span class="va">amount</span> <span class="op">*</span> <span class="fl">1.1</span><span class="op">]</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span></span>
<span><span class="op">}</span>, <span class="fu">copy</span><span class="op">(</span><span class="va">dt_mem_test</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; === ANÁLISIS DE MEMORIA: Modificación por referencia ===</span></span>
<span><span class="co">#&gt; Tiempo de ejecución: 7e-04 segundos</span></span>
<span><span class="co">#&gt; Memoria input: 7207216 </span></span>
<span><span class="co">#&gt; Memoria después: 8007424 </span></span>
<span><span class="co">#&gt; Memoria resultado: 8007424 </span></span>
<span><span class="co">#&gt; Cambio en memoria input: 800208 </span></span>
<span><span class="co">#&gt; Eficiencia memoria: 111.1 % del input</span></span>
<span></span>
<span><span class="co"># Operación 2: Crear nueva tabla</span></span>
<span><span class="va">result2</span> <span class="op">&lt;-</span> <span class="fu">memory_analysis</span><span class="op">(</span><span class="st">"Crear nueva tabla"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">dt</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">dt</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">id</span>, <span class="va">group_major</span>, <span class="va">value_numeric</span>, <span class="va">amount</span>, </span>
<span>         new_computed_col <span class="op">=</span> <span class="va">value_numeric</span> <span class="op">*</span> <span class="va">amount</span> <span class="op">*</span> <span class="fl">1.1</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">}</span>, <span class="va">dt_mem_test</span><span class="op">)</span></span>
<span><span class="co">#&gt; === ANÁLISIS DE MEMORIA: Crear nueva tabla ===</span></span>
<span><span class="co">#&gt; Tiempo de ejecución: 0.0012 segundos</span></span>
<span><span class="co">#&gt; Memoria input: 7207216 </span></span>
<span><span class="co">#&gt; Memoria después: 7207216 </span></span>
<span><span class="co">#&gt; Memoria resultado: 3603448 </span></span>
<span><span class="co">#&gt; Cambio en memoria input: 0 </span></span>
<span><span class="co">#&gt; Eficiencia memoria: 50 % del input</span></span>
<span></span>
<span><span class="co"># Operación 3: Agregación</span></span>
<span><span class="va">result3</span> <span class="op">&lt;-</span> <span class="fu">memory_analysis</span><span class="op">(</span><span class="st">"Agregación por grupos"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">dt</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">dt</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>mean_value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">value_numeric</span><span class="op">)</span>,</span>
<span>         sum_amount <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">amount</span><span class="op">)</span>,</span>
<span>         count <span class="op">=</span> <span class="va">.N</span><span class="op">)</span>, </span>
<span>     by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">group_major</span>, <span class="va">group_minor</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">}</span>, <span class="va">dt_mem_test</span><span class="op">)</span></span>
<span><span class="co">#&gt; === ANÁLISIS DE MEMORIA: Agregación por grupos ===</span></span>
<span><span class="co">#&gt; Tiempo de ejecución: 0.003 segundos</span></span>
<span><span class="co">#&gt; Memoria input: 7207216 </span></span>
<span><span class="co">#&gt; Memoria después: 7207216 </span></span>
<span><span class="co">#&gt; Memoria resultado: 13712 </span></span>
<span><span class="co">#&gt; Cambio en memoria input: 0 </span></span>
<span><span class="co">#&gt; Eficiencia memoria: 0.2 % del input</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="optimización-de-operaciones-específicas" class="level2" data-number="9.4"><h2 data-number="9.4" class="anchored" data-anchor-id="optimización-de-operaciones-específicas">
<span class="header-section-number">9.4</span> Optimización de Operaciones Específicas</h2>
<section id="joins-a-gran-escala" class="level3" data-number="9.4.1"><h3 data-number="9.4.1" class="anchored" data-anchor-id="joins-a-gran-escala">
<span class="header-section-number">9.4.1</span> 1. <strong>Joins a Gran Escala</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Preparar datos para joins de diferentes tamaños</span></span>
<span><span class="va">dt_left_large</span> <span class="op">&lt;-</span> <span class="va">big_dataset</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">.N</span>, <span class="fl">200000</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">dt_right_large</span> <span class="op">&lt;-</span> <span class="va">lookup_data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">.N</span>, <span class="fl">100000</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"=== OPTIMIZACIÓN DE JOINS GRANDES ===\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; === OPTIMIZACIÓN DE JOINS GRANDES ===</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Tabla izquierda:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">dt_left_large</span><span class="op">)</span>, <span class="st">"filas\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Tabla izquierda: 200000 filas</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Tabla derecha:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">dt_right_large</span><span class="op">)</span>, <span class="st">"filas\n\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Tabla derecha: 100000 filas</span></span>
<span></span>
<span><span class="co"># Estrategia 1: Merge básico</span></span>
<span><span class="va">tiempo_merge</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">result_merge</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span><span class="va">dt_left_large</span>, <span class="va">dt_right_large</span>, by <span class="op">=</span> <span class="st">"id"</span>, all.x <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Estrategia 2: Join con setkey</span></span>
<span><span class="va">dt_left_key</span> <span class="op">&lt;-</span> <span class="fu">copy</span><span class="op">(</span><span class="va">dt_left_large</span><span class="op">)</span></span>
<span><span class="va">dt_right_key</span> <span class="op">&lt;-</span> <span class="fu">copy</span><span class="op">(</span><span class="va">dt_right_large</span><span class="op">)</span></span>
<span><span class="fu">setkey</span><span class="op">(</span><span class="va">dt_left_key</span>, <span class="va">id</span><span class="op">)</span></span>
<span><span class="fu">setkey</span><span class="op">(</span><span class="va">dt_right_key</span>, <span class="va">id</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tiempo_setkey_join</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">result_setkey</span> <span class="op">&lt;-</span> <span class="va">dt_right_key</span><span class="op">[</span><span class="va">dt_left_key</span><span class="op">]</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Estrategia 3: Join con on= (sin modificar tablas originales)</span></span>
<span><span class="va">tiempo_on_join</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">result_on</span> <span class="op">&lt;-</span> <span class="va">dt_left_large</span><span class="op">[</span><span class="va">dt_right_large</span>, on <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">id</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Estrategia 4: Join filtrado (cuando sabemos que solo necesitamos subset)</span></span>
<span><span class="va">ids_relevantes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html">intersect</a></span><span class="op">(</span><span class="va">dt_left_large</span><span class="op">$</span><span class="va">id</span>, <span class="va">dt_right_large</span><span class="op">$</span><span class="va">id</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">50000</span><span class="op">]</span></span>
<span><span class="va">tiempo_filtered_join</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">dt_left_filtered</span> <span class="op">&lt;-</span> <span class="va">dt_left_large</span><span class="op">[</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">ids_relevantes</span><span class="op">]</span></span>
<span>  <span class="va">dt_right_filtered</span> <span class="op">&lt;-</span> <span class="va">dt_right_large</span><span class="op">[</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">ids_relevantes</span><span class="op">]</span></span>
<span>  <span class="va">result_filtered</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span><span class="va">dt_left_filtered</span>, <span class="va">dt_right_filtered</span>, by <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Comparar resultados</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Resultados de joins:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Resultados de joins:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"• Merge básico:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">tiempo_merge</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"segundos,"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">result_merge</span><span class="op">)</span>, <span class="st">"filas\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; • Merge básico: 0.03 segundos, 200000 filas</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"• Con setkey:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">tiempo_setkey_join</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"segundos,"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">result_setkey</span><span class="op">)</span>, <span class="st">"filas\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; • Con setkey: 0.02 segundos, 200000 filas</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"• Con on=:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">tiempo_on_join</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"segundos,"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">result_on</span><span class="op">)</span>, <span class="st">"filas\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; • Con on=: 0.01 segundos, 101800 filas</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"• Join filtrado:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">tiempo_filtered_join</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"segundos,"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">result_filtered</span><span class="op">)</span>, <span class="st">"filas\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; • Join filtrado: 0.01 segundos, 19881 filas</span></span>
<span></span>
<span><span class="co"># Mejor estrategia</span></span>
<span><span class="va">tiempos_join</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">tiempo_merge</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="va">tiempo_setkey_join</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="va">tiempo_on_join</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="va">tiempo_filtered_join</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">mejor_join</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.min.html">which.min</a></span><span class="op">(</span><span class="va">tiempos_join</span><span class="op">)</span></span>
<span><span class="va">estrategias_join</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Merge básico"</span>, <span class="st">"Con setkey"</span>, <span class="st">"Con on="</span>, <span class="st">"Join filtrado"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\nMejor estrategia:"</span>, <span class="va">estrategias_join</span><span class="op">[</span><span class="va">mejor_join</span><span class="op">]</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Mejor estrategia: Con on=</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="operaciones-temporales-optimizadas" class="level3" data-number="9.4.2"><h3 data-number="9.4.2" class="anchored" data-anchor-id="operaciones-temporales-optimizadas">
<span class="header-section-number">9.4.2</span> 2. <strong>Operaciones Temporales Optimizadas</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Optimizar consultas en datos temporales</span></span>
<span><span class="va">dt_temporal</span> <span class="op">&lt;-</span> <span class="fu">copy</span><span class="op">(</span><span class="va">temporal_dataset</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">.N</span>, <span class="fl">50000</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"=== OPTIMIZACIÓN DE CONSULTAS TEMPORALES ===\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; === OPTIMIZACIÓN DE CONSULTAS TEMPORALES ===</span></span>
<span></span>
<span><span class="co"># Consulta 1: Rango de fechas sin optimizar</span></span>
<span><span class="va">tiempo_temporal_sin_key</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">result_no_key</span> <span class="op">&lt;-</span> <span class="va">dt_temporal</span><span class="op">[</span><span class="va">timestamp</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"2024-06-01"</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>                              <span class="va">timestamp</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"2024-07-01"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Consulta 2: Con key temporal</span></span>
<span><span class="va">dt_temporal_keyed</span> <span class="op">&lt;-</span> <span class="fu">copy</span><span class="op">(</span><span class="va">dt_temporal</span><span class="op">)</span></span>
<span><span class="fu">setkey</span><span class="op">(</span><span class="va">dt_temporal_keyed</span>, <span class="va">timestamp</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tiempo_temporal_con_key</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">inicio</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"2024-06-01"</span><span class="op">)</span></span>
<span>  <span class="va">fin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"2024-07-01"</span><span class="op">)</span></span>
<span>  <span class="va">result_with_key</span> <span class="op">&lt;-</span> <span class="va">dt_temporal_keyed</span><span class="op">[</span><span class="va">timestamp</span> <span class="op">%between%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">inicio</span>, <span class="va">fin</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Consulta 3: Con rolling joins (para datos temporales complejos)</span></span>
<span><span class="co"># Simular eventos de referencia</span></span>
<span><span class="va">eventos_ref</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="op">(</span></span>
<span>  event_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"2024-06-01"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"2024-06-30"</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"day"</span><span class="op">)</span>,</span>
<span>  event_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span><span class="op">)</span>, <span class="fl">30</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu">setkey</span><span class="op">(</span><span class="va">eventos_ref</span>, <span class="va">event_time</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tiempo_rolling_join</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">result_rolling</span> <span class="op">&lt;-</span> <span class="va">dt_temporal_keyed</span><span class="op">[</span><span class="va">eventos_ref</span>, roll <span class="op">=</span> <span class="cn">TRUE</span><span class="op">]</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Resultados de consultas temporales:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Resultados de consultas temporales:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"• Sin key:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">tiempo_temporal_sin_key</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"segundos,"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">result_no_key</span><span class="op">)</span>, <span class="st">"filas\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; • Sin key: 0.02 segundos, 2039 filas</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"• Con key:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">tiempo_temporal_con_key</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"segundos,"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">result_with_key</span><span class="op">)</span>, <span class="st">"filas\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; • Con key: 0 segundos, 2039 filas</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"• Rolling join:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">tiempo_rolling_join</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"segundos,"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">result_rolling</span><span class="op">)</span>, <span class="st">"filas\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; • Rolling join: 0 segundos, 30 filas</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="casos-de-uso-de-optimización-extrema" class="level2" data-number="9.5"><h2 data-number="9.5" class="anchored" data-anchor-id="casos-de-uso-de-optimización-extrema">
<span class="header-section-number">9.5</span> Casos de Uso de Optimización Extrema</h2>
<section id="pipeline-de-análisis-de-alto-rendimiento" class="level3" data-number="9.5.1"><h3 data-number="9.5.1" class="anchored" data-anchor-id="pipeline-de-análisis-de-alto-rendimiento">
<span class="header-section-number">9.5.1</span> 1. <strong>Pipeline de Análisis de Alto Rendimiento</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Pipeline optimizado para análisis complejo</span></span>
<span><span class="va">create_optimized_pipeline</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dt</span>, <span class="va">sample_size</span> <span class="op">=</span> <span class="fl">100000</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"=== PIPELINE DE ALTO RENDIMIENTO ===\n"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Paso 1: Muestreo estratificado eficiente</span></span>
<span>  <span class="va">dt_sample</span> <span class="op">&lt;-</span> <span class="va">dt</span><span class="op">[</span>, <span class="va">.SD</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">.N</span>, <span class="va">sample_size</span><span class="op">)</span>, <span class="va">sample_size</span><span class="op">)</span><span class="op">]</span>, by <span class="op">=</span> <span class="va">region</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Paso 2: Establecer key óptima para operaciones posteriores</span></span>
<span>  <span class="fu">setkey</span><span class="op">(</span><span class="va">dt_sample</span>, <span class="va">group_major</span>, <span class="va">group_minor</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Paso 3: Cálculos intermedios optimizados (por referencia)</span></span>
<span>  <span class="va">dt_sample</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span></span>
<span>    value_normalized <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">value_numeric</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,</span>
<span>    amount_log <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log1p</a></span><span class="op">(</span><span class="va">amount</span><span class="op">)</span>,  <span class="co"># log1p es más estable que log</span></span>
<span>    efficiency_ratio <span class="op">=</span> <span class="va">value_numeric</span> <span class="op">/</span> <span class="op">(</span><span class="va">amount</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>    timestamp_hour <span class="op">=</span> <span class="fu">hour</span><span class="op">(</span><span class="va">timestamp</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Paso 4: Agregaciones complejas usando .SD optimizado</span></span>
<span>  <span class="va">result_aggregated</span> <span class="op">&lt;-</span> <span class="va">dt_sample</span><span class="op">[</span>, </span>
<span>    <span class="fu">.</span><span class="op">(</span></span>
<span>      <span class="co"># Estadísticas básicas</span></span>
<span>      count <span class="op">=</span> <span class="va">.N</span>,</span>
<span>      mean_value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">value_normalized</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>      median_amount <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">amount_log</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>      </span>
<span>      <span class="co"># Estadísticas avanzadas</span></span>
<span>      p95_efficiency <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">efficiency_ratio</span>, <span class="fl">0.95</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>      cv_value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">value_normalized</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">value_normalized</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      </span>
<span>      <span class="co"># Análisis temporal</span></span>
<span>      peak_hour <span class="op">=</span> <span class="va">timestamp_hour</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html">which.max</a></span><span class="op">(</span><span class="va">value_numeric</span><span class="op">)</span><span class="op">]</span>,</span>
<span>      active_hours <span class="op">=</span> <span class="fu">uniqueN</span><span class="op">(</span><span class="va">timestamp_hour</span><span class="op">)</span>,</span>
<span>      </span>
<span>      <span class="co"># Diversidad</span></span>
<span>      categories_used <span class="op">=</span> <span class="fu">uniqueN</span><span class="op">(</span><span class="va">category</span><span class="op">)</span>,</span>
<span>      status_diversity <span class="op">=</span> <span class="fu">uniqueN</span><span class="op">(</span><span class="va">status</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">region</span>, <span class="va">group_major</span><span class="op">)</span>,</span>
<span>    .SDcols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"value_normalized"</span>, <span class="st">"amount_log"</span>, <span class="st">"efficiency_ratio"</span>, </span>
<span>                <span class="st">"timestamp_hour"</span>, <span class="st">"value_numeric"</span>, <span class="st">"category"</span>, <span class="st">"status"</span><span class="op">)</span></span>
<span>  <span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Paso 5: Post-procesamiento optimizado</span></span>
<span>  <span class="va">result_aggregated</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span></span>
<span>    performance_score <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="op">(</span><span class="va">mean_value</span> <span class="op">+</span> <span class="va">p95_efficiency</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log1p</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    complexity_index <span class="op">=</span> <span class="va">categories_used</span> <span class="op">*</span> <span class="va">status_diversity</span> <span class="op">*</span> <span class="va">active_hours</span></span>
<span>  <span class="op">)</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Paso 6: Ranking y clasificación final</span></span>
<span>  <span class="va">result_aggregated</span><span class="op">[</span>, <span class="va">rank_performance</span> <span class="op">:=</span> <span class="fu">frank</span><span class="op">(</span><span class="op">-</span><span class="va">performance_score</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">region</span><span class="op">]</span></span>
<span>  <span class="va">result_aggregated</span><span class="op">[</span>, <span class="va">tier</span> <span class="op">:=</span> <span class="fu">fcase</span><span class="op">(</span></span>
<span>    <span class="va">rank_performance</span> <span class="op">&lt;=</span> <span class="fl">3</span>, <span class="st">"Tier_1"</span>,</span>
<span>    <span class="va">rank_performance</span> <span class="op">&lt;=</span> <span class="fl">10</span>, <span class="st">"Tier_2"</span>, </span>
<span>    <span class="va">rank_performance</span> <span class="op">&lt;=</span> <span class="fl">20</span>, <span class="st">"Tier_3"</span>,</span>
<span>    default <span class="op">=</span> <span class="st">"Tier_4"</span></span>
<span>  <span class="op">)</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">result_aggregated</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">performance_score</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Ejecutar pipeline optimizado</span></span>
<span><span class="va">tiempo_pipeline</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">resultado_pipeline</span> <span class="op">&lt;-</span> <span class="fu">create_optimized_pipeline</span><span class="op">(</span><span class="va">big_dataset</span>, <span class="fl">80000</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; === PIPELINE DE ALTO RENDIMIENTO ===</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Tiempo total del pipeline:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">tiempo_pipeline</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"segundos\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Tiempo total del pipeline: 0.22 segundos</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Registros procesados: ~80,000 → "</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">resultado_pipeline</span><span class="op">)</span>, <span class="st">"grupos finales\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Registros procesados: ~80,000 →  135 grupos finales</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Reducción de datos:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">resultado_pipeline</span><span class="op">)</span><span class="op">/</span><span class="fl">80000</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"%\n\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Reducción de datos: 99.8 %</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Top 10 grupos por performance:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Top 10 grupos por performance:"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">resultado_pipeline</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fu">.</span><span class="op">(</span><span class="va">region</span>, <span class="va">group_major</span>, <span class="va">count</span>, <span class="va">performance_score</span>, <span class="va">tier</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;      region group_major count performance_score   tier</span></span>
<span><span class="co">#&gt;      &lt;char&gt;      &lt;char&gt; &lt;int&gt;             &lt;num&gt; &lt;char&gt;</span></span>
<span><span class="co">#&gt;  1:   North        &lt;NA&gt; 38443             79.25 Tier_1</span></span>
<span><span class="co">#&gt;  2:    East        &lt;NA&gt; 38482             78.27 Tier_1</span></span>
<span><span class="co">#&gt;  3:   South        &lt;NA&gt; 38511             77.88 Tier_1</span></span>
<span><span class="co">#&gt;  4:    West        &lt;NA&gt; 38478             77.56 Tier_1</span></span>
<span><span class="co">#&gt;  5: Central        &lt;NA&gt; 38371             76.97 Tier_1</span></span>
<span><span class="co">#&gt;  6: Central           N  1554             61.91 Tier_1</span></span>
<span><span class="co">#&gt;  7:    East           M  1647             61.90 Tier_1</span></span>
<span><span class="co">#&gt;  8:   North           Q  1641             61.34 Tier_1</span></span>
<span><span class="co">#&gt;  9:    West           G  1635             61.30 Tier_1</span></span>
<span><span class="co">#&gt; 10:   South           F  1590             61.00 Tier_1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="sistema-de-monitoreo-de-performance-en-tiempo-real" class="level3" data-number="9.5.2"><h3 data-number="9.5.2" class="anchored" data-anchor-id="sistema-de-monitoreo-de-performance-en-tiempo-real">
<span class="header-section-number">9.5.2</span> 2. <strong>Sistema de Monitoreo de Performance en Tiempo Real</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Sistema para monitorear performance de operaciones data.table</span></span>
<span><span class="va">performance_monitor</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Crear registro de operaciones</span></span>
<span>  <span class="va">operations_log</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="op">(</span></span>
<span>    operation_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    operation_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    dataset_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">integer</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    execution_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    memory_used <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    threads_used <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">integer</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    timestamp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/base-internal.html">.POSIXct</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Función para registrar operación</span></span>
<span>  <span class="va">log_operation</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">op_type</span>, <span class="va">dt_size</span>, <span class="va">exec_time</span>, <span class="va">mem_usage</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">new_entry</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="op">(</span></span>
<span>      operation_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">op_type</span>, <span class="st">"_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"%H%M%S"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      operation_type <span class="op">=</span> <span class="va">op_type</span>,</span>
<span>      dataset_size <span class="op">=</span> <span class="va">dt_size</span>,</span>
<span>      execution_time <span class="op">=</span> <span class="va">exec_time</span>,</span>
<span>      memory_used <span class="op">=</span> <span class="va">mem_usage</span>,</span>
<span>      threads_used <span class="op">=</span> <span class="fu">getDTthreads</span><span class="op">(</span><span class="op">)</span>,</span>
<span>      timestamp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">operations_log</span> <span class="op">&lt;&lt;-</span> <span class="fu">rbindlist</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">operations_log</span>, <span class="va">new_entry</span><span class="op">)</span>, use.names <span class="op">=</span> <span class="cn">TRUE</span>, fill <span class="op">=</span> <span class="cn">TRUE</span>, ignore.attr <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Función para analizar performance</span></span>
<span>  <span class="va">analyze_performance</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">operations_log</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"No hay operaciones registradas\n"</span><span class="op">)</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="co"># Análisis por tipo de operación</span></span>
<span>    <span class="va">performance_summary</span> <span class="op">&lt;-</span> <span class="va">operations_log</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>      operations_count <span class="op">=</span> <span class="va">.N</span>,</span>
<span>      avg_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">execution_time</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>      median_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">execution_time</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>      max_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">execution_time</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>      avg_memory <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">memory_used</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>      throughput_rows_per_sec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">dataset_size</span> <span class="op">/</span> <span class="va">execution_time</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="op">)</span>, by <span class="op">=</span> <span class="va">operation_type</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">performance_summary</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>log <span class="op">=</span> <span class="va">log_operation</span>, analyze <span class="op">=</span> <span class="va">analyze_performance</span>, get_log <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="va">operations_log</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Inicializar sistema de monitoreo</span></span>
<span><span class="va">monitor</span> <span class="op">&lt;-</span> <span class="fu">performance_monitor</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Simular diferentes operaciones y monitorearlas</span></span>
<span><span class="va">dt_test</span> <span class="op">&lt;-</span> <span class="va">big_dataset</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">.N</span>, <span class="fl">50000</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Operación 1: Agregación</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Monitoreando operaciones:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Monitoreando operaciones:</span></span>
<span><span class="va">tiempo_agg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">result_agg</span> <span class="op">&lt;-</span> <span class="va">dt_test</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>mean_val <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">value_numeric</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">group_major</span><span class="op">]</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">monitor</span><span class="op">$</span><span class="fu">log</span><span class="op">(</span><span class="st">"aggregation"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">dt_test</span><span class="op">)</span>, <span class="va">tiempo_agg</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/utils/object.size.html">object.size</a></span><span class="op">(</span><span class="va">result_agg</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Operación 2: Join</span></span>
<span><span class="va">tiempo_join</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">result_join</span> <span class="op">&lt;-</span> <span class="va">dt_test</span><span class="op">[</span><span class="va">lookup_data</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10000</span><span class="op">]</span>, on <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">id</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">monitor</span><span class="op">$</span><span class="fu">log</span><span class="op">(</span><span class="st">"join"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">dt_test</span><span class="op">)</span>, <span class="va">tiempo_join</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/utils/object.size.html">object.size</a></span><span class="op">(</span><span class="va">result_join</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Operación 3: Sort</span></span>
<span><span class="va">tiempo_sort</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">result_sort</span> <span class="op">&lt;-</span> <span class="va">dt_test</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">value_numeric</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">monitor</span><span class="op">$</span><span class="fu">log</span><span class="op">(</span><span class="st">"sort"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">dt_test</span><span class="op">)</span>, <span class="va">tiempo_sort</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/utils/object.size.html">object.size</a></span><span class="op">(</span><span class="va">result_sort</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Análisis de performance</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\n=== ANÁLISIS DE PERFORMANCE ===\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; === ANÁLISIS DE PERFORMANCE ===</span></span>
<span><span class="va">performance_analysis</span> <span class="op">&lt;-</span> <span class="va">monitor</span><span class="op">$</span><span class="fu">analyze</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">performance_analysis</span><span class="op">)</span></span>
<span><span class="co">#&gt;    operation_type operations_count avg_time median_time max_time avg_memory</span></span>
<span><span class="co">#&gt;            &lt;char&gt;            &lt;int&gt;    &lt;num&gt;       &lt;num&gt;    &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:    aggregation                1     0.00        0.00     0.00       3256</span></span>
<span><span class="co">#&gt; 2:           join                1     0.28        0.28     0.28    1729416</span></span>
<span><span class="co">#&gt; 3:           sort                1     0.00        0.00     0.00    3607216</span></span>
<span><span class="co">#&gt;    throughput_rows_per_sec</span></span>
<span><span class="co">#&gt;                      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:                     Inf</span></span>
<span><span class="co">#&gt; 2:                  178571</span></span>
<span><span class="co">#&gt; 3:                     Inf</span></span>
<span></span>
<span><span class="co"># Identificar operaciones problemáticas</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">performance_analysis</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">problematic_ops</span> <span class="op">&lt;-</span> <span class="va">performance_analysis</span><span class="op">[</span><span class="va">avg_time</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">avg_time</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">problematic_ops</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\n⚠️ Operaciones con performance subóptima:\n"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">problematic_ops</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\n✅ Todas las operaciones tienen performance aceptable\n"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ⚠️ Operaciones con performance subóptima:</span></span>
<span><span class="co">#&gt;    operation_type operations_count avg_time median_time max_time avg_memory</span></span>
<span><span class="co">#&gt;            &lt;char&gt;            &lt;int&gt;    &lt;num&gt;       &lt;num&gt;    &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:           join                1     0.28        0.28     0.28    1729416</span></span>
<span><span class="co">#&gt;    throughput_rows_per_sec</span></span>
<span><span class="co">#&gt;                      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:                  178571</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="ejercicio-práctico-de-optimización" class="level2" data-number="9.6"><h2 data-number="9.6" class="anchored" data-anchor-id="ejercicio-práctico-de-optimización">
<span class="header-section-number">9.6</span> Ejercicio Práctico de Optimización</h2>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
🏋️ Ejercicio 15: Optimización Integral
</div>
</div>
<div class="callout-body-container callout-body">
<p>Dado el siguiente código ineficiente, optimízalo usando todas las técnicas aprendidas:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Código INEFICIENTE para optimizar</span></span>
<span><span class="va">analyze_data_slow</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">big_data</span>, <span class="va">lookup</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Procesar cada región por separado</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">region</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">big_data</span><span class="op">$</span><span class="va">region</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">region_data</span> <span class="op">&lt;-</span> <span class="va">big_data</span><span class="op">[</span><span class="va">big_data</span><span class="op">$</span><span class="va">region</span> <span class="op">==</span> <span class="va">region</span>, <span class="op">]</span></span>
<span>    </span>
<span>    <span class="co"># Procesar cada grupo dentro de la región</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">group</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">region_data</span><span class="op">$</span><span class="va">group_major</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">group_data</span> <span class="op">&lt;-</span> <span class="va">region_data</span><span class="op">[</span><span class="va">region_data</span><span class="op">$</span><span class="va">group_major</span> <span class="op">==</span> <span class="va">group</span>, <span class="op">]</span></span>
<span>      </span>
<span>      <span class="co"># Cálculos por grupo</span></span>
<span>      <span class="va">group_stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>        region <span class="op">=</span> <span class="va">region</span>,</span>
<span>        group <span class="op">=</span> <span class="va">group</span>,</span>
<span>        count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">group_data</span><span class="op">)</span>,</span>
<span>        mean_value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">group_data</span><span class="op">$</span><span class="va">value_numeric</span><span class="op">)</span>,</span>
<span>        sum_amount <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">group_data</span><span class="op">$</span><span class="va">amount</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>      </span>
<span>      <span class="co"># Join con lookup (ineficiente)</span></span>
<span>      <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">group_stats</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">matched_lookup</span> <span class="op">&lt;-</span> <span class="va">lookup</span><span class="op">[</span><span class="va">lookup</span><span class="op">$</span><span class="va">entity_type</span> <span class="op">==</span> <span class="st">"Premium"</span>, <span class="op">]</span></span>
<span>        <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">matched_lookup</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="va">group_stats</span><span class="op">$</span><span class="va">premium_factor</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">matched_lookup</span><span class="op">$</span><span class="va">weight_factor</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">}</span></span>
<span>      </span>
<span>      <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">results</span>, <span class="va">group_stats</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Optimízalo para: 1. Eliminar todos los bucles 2. Usar operaciones vectorizadas 3. Implementar joins eficientes 4. Minimizar copias de memoria</p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
💡 Solución del Ejercicio 15
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Versión OPTIMIZADA</span></span>
<span><span class="va">analyze_data_fast</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">big_data</span>, <span class="va">lookup</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Pre-calcular el premium_factor una sola vez</span></span>
<span>  <span class="va">premium_factor</span> <span class="op">&lt;-</span> <span class="va">lookup</span><span class="op">[</span><span class="va">entity_type</span> <span class="op">==</span> <span class="st">"Premium"</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">weight_factor</span><span class="op">)</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Una sola operación vectorizada que reemplaza todos los bucles</span></span>
<span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="va">big_data</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>    count <span class="op">=</span> <span class="va">.N</span>,</span>
<span>    mean_value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">value_numeric</span><span class="op">)</span>,</span>
<span>    sum_amount <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">amount</span><span class="op">)</span>,</span>
<span>    premium_factor <span class="op">=</span> <span class="va">premium_factor</span>  <span class="co"># Usar valor pre-calculado</span></span>
<span>  <span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">region</span>, group <span class="op">=</span> <span class="va">group_major</span><span class="op">)</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Comparar performance</span></span>
<span><span class="va">dt_test_large</span> <span class="op">&lt;-</span> <span class="va">big_dataset</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">.N</span>, <span class="fl">20000</span><span class="op">)</span><span class="op">]</span>  <span class="co"># Dataset más pequeño para el test</span></span>
<span><span class="va">lookup_test</span> <span class="op">&lt;-</span> <span class="va">lookup_data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">.N</span>, <span class="fl">5000</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"=== COMPARACIÓN DE PERFORMANCE ===\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; === COMPARACIÓN DE PERFORMANCE ===</span></span>
<span></span>
<span><span class="co"># Versión lenta (simulada de forma más rápida para el ejemplo)</span></span>
<span><span class="va">tiempo_lento</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="co"># Simulamos la lógica ineficiente pero sin bucles extremos</span></span>
<span>  <span class="va">result_slow</span> <span class="op">&lt;-</span> <span class="va">dt_test_large</span><span class="op">[</span>, <span class="op">{</span></span>
<span>    <span class="co"># Múltiples operaciones separadas (ineficiente)</span></span>
<span>    <span class="va">temp_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">group_major</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">group_val</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">group_major</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>      <span class="va">group_subset</span> <span class="op">&lt;-</span> <span class="va">.SD</span><span class="op">[</span><span class="va">group_major</span> <span class="op">==</span> <span class="va">group_val</span><span class="op">]</span></span>
<span>      <span class="va">temp_results</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="op">(</span></span>
<span>        region <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span>,</span>
<span>        group <span class="op">=</span> <span class="va">group_val</span>,</span>
<span>        count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">group_subset</span><span class="op">)</span>,</span>
<span>        mean_value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">group_subset</span><span class="op">$</span><span class="va">value_numeric</span><span class="op">)</span>,</span>
<span>        sum_amount <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">group_subset</span><span class="op">$</span><span class="va">amount</span><span class="op">)</span>,</span>
<span>        premium_factor <span class="op">=</span> <span class="va">lookup_test</span><span class="op">[</span><span class="va">entity_type</span> <span class="op">==</span> <span class="st">"Premium"</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">weight_factor</span><span class="op">)</span><span class="op">]</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu">rbindlist</span><span class="op">(</span><span class="va">temp_results</span><span class="op">)</span></span>
<span>  <span class="op">}</span>, by <span class="op">=</span> <span class="va">region</span><span class="op">]</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Versión optimizada</span></span>
<span><span class="va">tiempo_rapido</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">result_fast</span> <span class="op">&lt;-</span> <span class="fu">analyze_data_fast</span><span class="op">(</span><span class="va">dt_test_large</span>, <span class="va">lookup_test</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Método ineficiente (simulado):"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">tiempo_lento</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"segundos\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Método ineficiente (simulado): 0.11 segundos</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Método optimizado:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">tiempo_rapido</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"segundos\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Método optimizado: 0 segundos</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Mejora de velocidad:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">tiempo_lento</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">/</span> <span class="va">tiempo_rapido</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"x más rápido\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Mejora de velocidad: Inf x más rápido</span></span>
<span></span>
<span><span class="co"># Verificar resultados equivalentes</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Resultados similares:"</span>, </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">result_slow</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">result_fast</span><span class="op">)</span>, </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span><span class="va">result_slow</span><span class="op">$</span><span class="va">count</span>, <span class="va">result_fast</span><span class="op">$</span><span class="va">count</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Resultados similares: TRUE Mean relative difference: 1.077508</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"\nPrimeras filas del resultado optimizado:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "\nPrimeras filas del resultado optimizado:"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">result_fast</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;     region  group count mean_value sum_amount premium_factor</span></span>
<span><span class="co">#&gt;     &lt;char&gt; &lt;char&gt; &lt;int&gt;      &lt;num&gt;      &lt;num&gt;          &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: Central      G    94  108.12594   39703.33       1.252676</span></span>
<span><span class="co">#&gt; 2: Central   &lt;NA&gt;  1887   99.26696  886126.91       1.252676</span></span>
<span><span class="co">#&gt; 3:   South      E    82  102.41588   51290.98       1.252676</span></span>
<span><span class="co">#&gt; 4:    East      B    82   97.44042   26863.57       1.252676</span></span>
<span><span class="co">#&gt; 5:    West      J    92  100.79471   36067.56       1.252676</span></span>
<span><span class="co">#&gt; 6: Central      C    69   98.34540   25937.61       1.252676</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\n=== TÉCNICAS DE OPTIMIZACIÓN APLICADAS ===\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; === TÉCNICAS DE OPTIMIZACIÓN APLICADAS ===</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"1. ✅ Eliminación completa de bucles for\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; 1. ✅ Eliminación completa de bucles for</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"2. ✅ Una sola operación by= vectorizada\n"</span><span class="op">)</span> </span>
<span><span class="co">#&gt; 2. ✅ Una sola operación by= vectorizada</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"3. ✅ Pre-cálculo de valores constantes\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; 3. ✅ Pre-cálculo de valores constantes</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"4. ✅ Eliminación de rbind repetitivo\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; 4. ✅ Eliminación de rbind repetitivo</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"5. ✅ Sintaxis data.table pura (sin data.frame)\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; 5. ✅ Sintaxis data.table pura (sin data.frame)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"6. ✅ Operaciones vectorizadas nativas\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; 6. ✅ Operaciones vectorizadas nativas</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"7. ✅ Mínimo uso de memoria\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; 7. ✅ Mínimo uso de memoria</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<hr>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
🎯 Puntos Clave de Este Capítulo
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>
<strong>Threading automático</strong> puede acelerar operaciones 2-10x en sistemas multi-core</li>
<li>
<strong>setkey()</strong> es esencial para datasets &gt;100K filas con consultas repetitivas</li>
<li>
<strong>Índices secundarios</strong> con setindex() permiten múltiples patrones de consulta eficientes</li>
<li>
<strong>Benchmarking sistemático</strong> revela cuellos de botella reales vs percibidos</li>
<li>
<strong>Una operación data.table vectorizada</strong> puede reemplazar docenas de bucles</li>
<li>
<strong>Profiling de memoria</strong> es crucial para datasets que se acercan a los límites de RAM</li>
<li>
<strong>La optimización correcta</strong> puede resultar en mejoras de 10-100x en casos extremos</li>
</ol>
</div>
</div>
<p>El dominio de estas técnicas de optimización te permite trabajar con datasets que de otra manera serían imposibles de procesar eficientemente. En el próximo capítulo exploraremos las mejores prácticas y patrones que complementan estas optimizaciones.</p>
<p><function_calls><invoke name="TodoWrite"><parameter name="todos">[{“content”: “Reorganizar M0f3dulo 1: dividir fundamentos en sintaxis y s0edmbolos”, “status”: “completed”, “id”: “1”}, {“content”: “Crear cap01-simbolos.qmd para s0edmbolos especiales del M0f3dulo 1”, “status”: “completed”, “id”: “1-new”}, {“content”: “Reorganizar M0f3dulo 2: dividir en encadenamiento y joins”, “status”: “completed”, “id”: “2”}, {“content”: “Crear cap03-joins-avanzados.qmd para joins avanzados del M0f3dulo 3”, “status”: “completed”, “id”: “3-1”}, {“content”: “Crear cap03-funciones-especiales.qmd para funciones especiales del M0f3dulo 3”, “status”: “completed”, “id”: “3-2”}, {“content”: “Crear cap03-reshape.qmd para reshape del M0f3dulo 3”, “status”: “completed”, “id”: “3-3”}, {“content”: “Crear cap04-performance.qmd para optimización de performance del M0f3dulo 4”, “status”: “completed”, “id”: “4-1”}, {“content”: “Crear cap04-buenas-practicas.qmd para mejores pr0e1cticas del M0f3dulo 4”, “status”: “in_progress”, “id”: “4-2”}, {“content”: “Reorganizar M0f3dulo 5: dividir en visualizaci0f3n y aplicaciones”, “status”: “pending”, “id”: “5”}]</parameter></invoke></function_calls></p>


<!-- -->

</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/tutorial-datatable\.github\.io\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./cap03-reshape.html" class="pagination-link" aria-label="Remodelación de Datos: `melt()` y `dcast()`">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Remodelación de Datos: <code>melt()</code> y <code>dcast()</code></span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./cap04-buenas-practicas.html" class="pagination-link" aria-label="Buenas Prácticas y Código Idiomático">
        <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Buenas Prácticas y Código Idiomático</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb16" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Optimización de Performance</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip icon="false"}</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="fu">## En este capítulo dominarás</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Configuración de threading** para aprovechar múltiples núcleos</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Keys e índices** para búsquedas ultra-rápidas</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Profiling y benchmarking** sistemático de código</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Optimización de memoria** y gestión eficiente de recursos</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Identificación de cuellos de botella** en pipelines complejos</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Técnicas específicas** para datasets grandes (&gt;1M filas)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup-cap04-performance</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(microbenchmark)</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parallel)</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Configuración</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">datatable.print.nrows =</span> <span class="dv">8</span>)</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">datatable.print.class =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Datasets para performance testing</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2024</span>)</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Dataset grande para benchmarking</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>big_dataset <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">1000000</span>, <span class="dv">2000000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">group_major =</span> <span class="fu">sample</span>(LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>], <span class="dv">2000000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">group_minor =</span> <span class="fu">sample</span>(letters[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>], <span class="dv">2000000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">value_numeric =</span> <span class="fu">rnorm</span>(<span class="dv">2000000</span>, <span class="dv">100</span>, <span class="dv">25</span>),</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">value_integer =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>, <span class="dv">2000000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">timestamp =</span> <span class="fu">sample</span>(<span class="fu">seq.POSIXt</span>(<span class="fu">as.POSIXct</span>(<span class="st">"2020-01-01"</span>), <span class="fu">as.POSIXct</span>(<span class="st">"2024-12-31"</span>), <span class="at">by =</span> <span class="st">"min"</span>), <span class="dv">2000000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">category =</span> <span class="fu">sample</span>(<span class="fu">paste0</span>(<span class="st">"Cat_"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>), <span class="dv">2000000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">status =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Active"</span>, <span class="st">"Inactive"</span>, <span class="st">"Pending"</span>, <span class="st">"Completed"</span>), <span class="dv">2000000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.4</span>, <span class="fl">0.3</span>, <span class="fl">0.2</span>, <span class="fl">0.1</span>)),</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">region =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"North"</span>, <span class="st">"South"</span>, <span class="st">"East"</span>, <span class="st">"West"</span>, <span class="st">"Central"</span>), <span class="dv">2000000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">amount =</span> <span class="fu">round</span>(<span class="fu">exp</span>(<span class="fu">rnorm</span>(<span class="dv">2000000</span>, <span class="dv">5</span>, <span class="fl">1.5</span>)), <span class="dv">2</span>)</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Dataset de lookup para joins</span></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>lookup_data <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000000</span>,</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">entity_name =</span> <span class="fu">paste0</span>(<span class="st">"Entity_"</span>, <span class="fu">sprintf</span>(<span class="st">"%07d"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">1000000</span>)),</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>  <span class="at">entity_type =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Premium"</span>, <span class="st">"Standard"</span>, <span class="st">"Basic"</span>, <span class="st">"VIP"</span>), <span class="dv">1000000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>  <span class="at">weight_factor =</span> <span class="fu">round</span>(<span class="fu">runif</span>(<span class="dv">1000000</span>, <span class="fl">0.5</span>, <span class="fl">2.0</span>), <span class="dv">3</span>),</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>  <span class="at">creation_date =</span> <span class="fu">sample</span>(<span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">"2019-01-01"</span>), <span class="fu">as.Date</span>(<span class="st">"2024-01-01"</span>), <span class="at">by =</span> <span class="st">"day"</span>), <span class="dv">1000000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>  <span class="at">is_active =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="cn">TRUE</span>, <span class="cn">FALSE</span>), <span class="dv">1000000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.8</span>, <span class="fl">0.2</span>))</span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Dataset temporal para análisis de series de tiempo</span></span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>temporal_dataset <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>  <span class="at">timestamp =</span> <span class="fu">seq</span>(<span class="fu">as.POSIXct</span>(<span class="st">"2023-01-01 00:00:00"</span>), </span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">as.POSIXct</span>(<span class="st">"2024-12-31 23:59:59"</span>), </span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>                 <span class="at">by =</span> <span class="st">"5 min"</span>),</span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>  <span class="at">device_id =</span> <span class="fu">rep</span>(<span class="fu">paste0</span>(<span class="st">"DEV_"</span>, <span class="fu">sprintf</span>(<span class="st">"%04d"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">500</span>)), <span class="at">length.out =</span> <span class="dv">210240</span>),</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>  <span class="at">sensor_temp =</span> <span class="fu">round</span>(<span class="dv">20</span> <span class="sc">+</span> <span class="dv">10</span><span class="sc">*</span><span class="fu">sin</span>(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">20</span><span class="sc">*</span>pi, <span class="at">length.out =</span> <span class="dv">210240</span>)) <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">210240</span>, <span class="dv">0</span>, <span class="dv">2</span>), <span class="dv">1</span>),</span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>  <span class="at">sensor_pressure =</span> <span class="fu">round</span>(<span class="dv">1013</span> <span class="sc">+</span> <span class="dv">50</span><span class="sc">*</span><span class="fu">cos</span>(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">15</span><span class="sc">*</span>pi, <span class="at">length.out =</span> <span class="dv">210240</span>)) <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">210240</span>, <span class="dv">0</span>, <span class="dv">10</span>), <span class="dv">1</span>),</span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>  <span class="at">sensor_humidity =</span> <span class="fu">round</span>(<span class="dv">50</span> <span class="sc">+</span> <span class="dv">30</span><span class="sc">*</span><span class="fu">sin</span>(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">25</span><span class="sc">*</span>pi, <span class="at">length.out =</span> <span class="dv">210240</span>)) <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">210240</span>, <span class="dv">0</span>, <span class="dv">5</span>), <span class="dv">1</span>),</span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>  <span class="at">quality_flag =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"OK"</span>, <span class="st">"WARNING"</span>, <span class="st">"ERROR"</span>), <span class="dv">210240</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.85</span>, <span class="fl">0.12</span>, <span class="fl">0.03</span>))</span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Datasets creados para performance testing:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"• big_dataset:"</span>, <span class="fu">nrow</span>(big_dataset), <span class="st">"filas,"</span>, <span class="fu">ncol</span>(big_dataset), <span class="st">"columnas</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"• lookup_data:"</span>, <span class="fu">nrow</span>(lookup_data), <span class="st">"filas,"</span>, <span class="fu">ncol</span>(lookup_data), <span class="st">"columnas</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"• temporal_dataset:"</span>, <span class="fu">nrow</span>(temporal_dataset), <span class="st">"filas,"</span>, <span class="fu">ncol</span>(temporal_dataset), <span class="st">"columnas</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a><span class="fu">## Configuración de Threading para Múltiples Núcleos</span></span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a>El threading automático de <span class="in">`data.table`</span> puede acelerar dramáticamente las operaciones en máquinas multi-core.</span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1. **Configuración Óptima de Threads**</span></span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-82"><a href="#cb16-82" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-83"><a href="#cb16-83" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: threading-configuracion</span></span>
<span id="cb16-84"><a href="#cb16-84" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb16-85"><a href="#cb16-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-86"><a href="#cb16-86" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluar configuración del sistema</span></span>
<span id="cb16-87"><a href="#cb16-87" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== CONFIGURACIÓN DEL SISTEMA ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-88"><a href="#cb16-88" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"CPU cores disponibles:"</span>, parallel<span class="sc">::</span><span class="fu">detectCores</span>(), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-89"><a href="#cb16-89" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"CPU cores con hyperthreading:"</span>, parallel<span class="sc">::</span><span class="fu">detectCores</span>(<span class="at">logical =</span> <span class="cn">TRUE</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-90"><a href="#cb16-90" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Threads configurados en data.table:"</span>, <span class="fu">getDTthreads</span>(), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-91"><a href="#cb16-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-92"><a href="#cb16-92" aria-hidden="true" tabindex="-1"></a><span class="co"># Función para determinar configuración óptima</span></span>
<span id="cb16-93"><a href="#cb16-93" aria-hidden="true" tabindex="-1"></a>determine_optimal_threads <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb16-94"><a href="#cb16-94" aria-hidden="true" tabindex="-1"></a>  max_cores <span class="ot">&lt;-</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>(<span class="at">logical =</span> <span class="cn">FALSE</span>)  <span class="co"># Cores físicos</span></span>
<span id="cb16-95"><a href="#cb16-95" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-96"><a href="#cb16-96" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(max_cores <span class="sc">&lt;=</span> <span class="dv">2</span>) {</span>
<span id="cb16-97"><a href="#cb16-97" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(max_cores)</span>
<span id="cb16-98"><a href="#cb16-98" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span>(max_cores <span class="sc">&lt;=</span> <span class="dv">4</span>) {</span>
<span id="cb16-99"><a href="#cb16-99" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(max_cores)</span>
<span id="cb16-100"><a href="#cb16-100" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span>(max_cores <span class="sc">&lt;=</span> <span class="dv">8</span>) {</span>
<span id="cb16-101"><a href="#cb16-101" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(max_cores <span class="sc">-</span> <span class="dv">1</span>)  <span class="co"># Dejar un core libre</span></span>
<span id="cb16-102"><a href="#cb16-102" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb16-103"><a href="#cb16-103" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">min</span>(<span class="dv">8</span>, max_cores <span class="sc">-</span> <span class="dv">2</span>))  <span class="co"># Para sistemas muy grandes, no usar todos</span></span>
<span id="cb16-104"><a href="#cb16-104" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-105"><a href="#cb16-105" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-106"><a href="#cb16-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-107"><a href="#cb16-107" aria-hidden="true" tabindex="-1"></a>optimal_threads <span class="ot">&lt;-</span> <span class="fu">determine_optimal_threads</span>()</span>
<span id="cb16-108"><a href="#cb16-108" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Configuración recomendada:"</span>, optimal_threads, <span class="st">"threads</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-109"><a href="#cb16-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-110"><a href="#cb16-110" aria-hidden="true" tabindex="-1"></a><span class="co"># Aplicar configuración óptima</span></span>
<span id="cb16-111"><a href="#cb16-111" aria-hidden="true" tabindex="-1"></a><span class="fu">setDTthreads</span>(optimal_threads)</span>
<span id="cb16-112"><a href="#cb16-112" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Configuración aplicada:"</span>, <span class="fu">getDTthreads</span>(), <span class="st">"threads</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-113"><a href="#cb16-113" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-114"><a href="#cb16-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-115"><a href="#cb16-115" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2. **Benchmark de Threading Performance**</span></span>
<span id="cb16-116"><a href="#cb16-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-119"><a href="#cb16-119" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-120"><a href="#cb16-120" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: threading-benchmark</span></span>
<span id="cb16-121"><a href="#cb16-121" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb16-122"><a href="#cb16-122" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: true</span></span>
<span id="cb16-123"><a href="#cb16-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-124"><a href="#cb16-124" aria-hidden="true" tabindex="-1"></a><span class="co"># Función para benchmark con diferentes configuraciones de threads</span></span>
<span id="cb16-125"><a href="#cb16-125" aria-hidden="true" tabindex="-1"></a>benchmark_threading <span class="ot">&lt;-</span> <span class="cf">function</span>(n_threads, <span class="at">dataset_size =</span> <span class="dv">500000</span>) {</span>
<span id="cb16-126"><a href="#cb16-126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setDTthreads</span>(n_threads)</span>
<span id="cb16-127"><a href="#cb16-127" aria-hidden="true" tabindex="-1"></a>  dt_sample <span class="ot">&lt;-</span> big_dataset[<span class="fu">sample</span>(.N, dataset_size)]</span>
<span id="cb16-128"><a href="#cb16-128" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-129"><a href="#cb16-129" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Operaciones que se benefician del threading</span></span>
<span id="cb16-130"><a href="#cb16-130" aria-hidden="true" tabindex="-1"></a>  tiempo_agregacion <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb16-131"><a href="#cb16-131" aria-hidden="true" tabindex="-1"></a>    result_agg <span class="ot">&lt;-</span> dt_sample[, .(</span>
<span id="cb16-132"><a href="#cb16-132" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_value =</span> <span class="fu">mean</span>(value_numeric),</span>
<span id="cb16-133"><a href="#cb16-133" aria-hidden="true" tabindex="-1"></a>      <span class="at">sum_amount =</span> <span class="fu">sum</span>(amount),</span>
<span id="cb16-134"><a href="#cb16-134" aria-hidden="true" tabindex="-1"></a>      <span class="at">count_records =</span> .N,</span>
<span id="cb16-135"><a href="#cb16-135" aria-hidden="true" tabindex="-1"></a>      <span class="at">median_value =</span> <span class="fu">median</span>(value_numeric)</span>
<span id="cb16-136"><a href="#cb16-136" aria-hidden="true" tabindex="-1"></a>    ), by <span class="ot">=</span> .(group_major, group_minor)]</span>
<span id="cb16-137"><a href="#cb16-137" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb16-138"><a href="#cb16-138" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-139"><a href="#cb16-139" aria-hidden="true" tabindex="-1"></a>  tiempo_sort <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb16-140"><a href="#cb16-140" aria-hidden="true" tabindex="-1"></a>    result_sort <span class="ot">&lt;-</span> dt_sample[<span class="fu">order</span>(<span class="sc">-</span>value_numeric, group_major)]</span>
<span id="cb16-141"><a href="#cb16-141" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb16-142"><a href="#cb16-142" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-143"><a href="#cb16-143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb16-144"><a href="#cb16-144" aria-hidden="true" tabindex="-1"></a>    <span class="at">threads =</span> n_threads,</span>
<span id="cb16-145"><a href="#cb16-145" aria-hidden="true" tabindex="-1"></a>    <span class="at">agregacion =</span> tiempo_agregacion[<span class="dv">3</span>],</span>
<span id="cb16-146"><a href="#cb16-146" aria-hidden="true" tabindex="-1"></a>    <span class="at">ordenamiento =</span> tiempo_sort[<span class="dv">3</span>],</span>
<span id="cb16-147"><a href="#cb16-147" aria-hidden="true" tabindex="-1"></a>    <span class="at">total =</span> tiempo_agregacion[<span class="dv">3</span>] <span class="sc">+</span> tiempo_sort[<span class="dv">3</span>]</span>
<span id="cb16-148"><a href="#cb16-148" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb16-149"><a href="#cb16-149" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-150"><a href="#cb16-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-151"><a href="#cb16-151" aria-hidden="true" tabindex="-1"></a><span class="co"># Comparar diferentes configuraciones</span></span>
<span id="cb16-152"><a href="#cb16-152" aria-hidden="true" tabindex="-1"></a>configuraciones_threads <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="fu">min</span>(<span class="dv">8</span>, parallel<span class="sc">::</span><span class="fu">detectCores</span>()))</span>
<span id="cb16-153"><a href="#cb16-153" aria-hidden="true" tabindex="-1"></a>resultados_threads <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb16-154"><a href="#cb16-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-155"><a href="#cb16-155" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== BENCHMARK DE THREADING ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-156"><a href="#cb16-156" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(configuraciones_threads)) {</span>
<span id="cb16-157"><a href="#cb16-157" aria-hidden="true" tabindex="-1"></a>  n_threads <span class="ot">&lt;-</span> configuraciones_threads[i]</span>
<span id="cb16-158"><a href="#cb16-158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Probando con"</span>, n_threads, <span class="st">"thread(s)... "</span>)</span>
<span id="cb16-159"><a href="#cb16-159" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-160"><a href="#cb16-160" aria-hidden="true" tabindex="-1"></a>  resultado <span class="ot">&lt;-</span> <span class="fu">benchmark_threading</span>(n_threads, <span class="dv">300000</span>)  <span class="co"># Dataset más pequeño para rapidez</span></span>
<span id="cb16-161"><a href="#cb16-161" aria-hidden="true" tabindex="-1"></a>  resultados_threads[[i]] <span class="ot">&lt;-</span> resultado</span>
<span id="cb16-162"><a href="#cb16-162" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-163"><a href="#cb16-163" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Agregación:"</span>, <span class="fu">round</span>(resultado<span class="sc">$</span>agregacion, <span class="dv">3</span>), <span class="st">"s, "</span>,</span>
<span id="cb16-164"><a href="#cb16-164" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Ordenamiento:"</span>, <span class="fu">round</span>(resultado<span class="sc">$</span>ordenamiento, <span class="dv">3</span>), <span class="st">"s, "</span>,</span>
<span id="cb16-165"><a href="#cb16-165" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Total:"</span>, <span class="fu">round</span>(resultado<span class="sc">$</span>total, <span class="dv">3</span>), <span class="st">"s</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-166"><a href="#cb16-166" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-167"><a href="#cb16-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-168"><a href="#cb16-168" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear tabla de resultados</span></span>
<span id="cb16-169"><a href="#cb16-169" aria-hidden="true" tabindex="-1"></a>tabla_threads <span class="ot">&lt;-</span> <span class="fu">rbindlist</span>(resultados_threads)</span>
<span id="cb16-170"><a href="#cb16-170" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Comparación de performance por número de threads:"</span>)</span>
<span id="cb16-171"><a href="#cb16-171" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(tabla_threads)</span>
<span id="cb16-172"><a href="#cb16-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-173"><a href="#cb16-173" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular speedup relativo al baseline (1 thread)</span></span>
<span id="cb16-174"><a href="#cb16-174" aria-hidden="true" tabindex="-1"></a>baseline <span class="ot">&lt;-</span> tabla_threads[threads <span class="sc">==</span> <span class="dv">1</span>, total]</span>
<span id="cb16-175"><a href="#cb16-175" aria-hidden="true" tabindex="-1"></a>tabla_threads[, speedup <span class="sc">:</span><span class="er">=</span> <span class="fu">round</span>(baseline <span class="sc">/</span> total, <span class="dv">2</span>)]</span>
<span id="cb16-176"><a href="#cb16-176" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Speedup relativo (vs 1 thread):"</span>)</span>
<span id="cb16-177"><a href="#cb16-177" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(tabla_threads[, .(threads, total, speedup)])</span>
<span id="cb16-178"><a href="#cb16-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-179"><a href="#cb16-179" aria-hidden="true" tabindex="-1"></a><span class="co"># Restaurar configuración óptima</span></span>
<span id="cb16-180"><a href="#cb16-180" aria-hidden="true" tabindex="-1"></a><span class="fu">setDTthreads</span>(optimal_threads)</span>
<span id="cb16-181"><a href="#cb16-181" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-182"><a href="#cb16-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-183"><a href="#cb16-183" aria-hidden="true" tabindex="-1"></a><span class="fu">## Keys e Índices: La Base de la Velocidad</span></span>
<span id="cb16-184"><a href="#cb16-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-185"><a href="#cb16-185" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1. **Setkey: Ordenamiento Físico para Velocidad**</span></span>
<span id="cb16-186"><a href="#cb16-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-189"><a href="#cb16-189" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-190"><a href="#cb16-190" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setkey-performance</span></span>
<span id="cb16-191"><a href="#cb16-191" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb16-192"><a href="#cb16-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-193"><a href="#cb16-193" aria-hidden="true" tabindex="-1"></a><span class="co"># Comparar performance con y sin keys</span></span>
<span id="cb16-194"><a href="#cb16-194" aria-hidden="true" tabindex="-1"></a>dt_no_key <span class="ot">&lt;-</span> <span class="fu">copy</span>(big_dataset[<span class="fu">sample</span>(.N, <span class="dv">500000</span>)])</span>
<span id="cb16-195"><a href="#cb16-195" aria-hidden="true" tabindex="-1"></a>dt_with_key <span class="ot">&lt;-</span> <span class="fu">copy</span>(dt_no_key)</span>
<span id="cb16-196"><a href="#cb16-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-197"><a href="#cb16-197" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== COMPARACIÓN SETKEY ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-198"><a href="#cb16-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-199"><a href="#cb16-199" aria-hidden="true" tabindex="-1"></a><span class="co"># Tiempo para establecer key</span></span>
<span id="cb16-200"><a href="#cb16-200" aria-hidden="true" tabindex="-1"></a>tiempo_setkey <span class="ot">&lt;-</span> <span class="fu">system.time</span>(<span class="fu">setkey</span>(dt_with_key, group_major, group_minor))</span>
<span id="cb16-201"><a href="#cb16-201" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Tiempo para establecer key:"</span>, <span class="fu">round</span>(tiempo_setkey[<span class="dv">3</span>], <span class="dv">3</span>), <span class="st">"segundos</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-202"><a href="#cb16-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-203"><a href="#cb16-203" aria-hidden="true" tabindex="-1"></a><span class="co"># Comparar búsquedas simples</span></span>
<span id="cb16-204"><a href="#cb16-204" aria-hidden="true" tabindex="-1"></a>valores_busqueda <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>, <span class="st">"D"</span>, <span class="st">"E"</span>)</span>
<span id="cb16-205"><a href="#cb16-205" aria-hidden="true" tabindex="-1"></a>sub_valores <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"c"</span>)</span>
<span id="cb16-206"><a href="#cb16-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-207"><a href="#cb16-207" aria-hidden="true" tabindex="-1"></a>tiempo_sin_key <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb16-208"><a href="#cb16-208" aria-hidden="true" tabindex="-1"></a>  result_no_key <span class="ot">&lt;-</span> dt_no_key[group_major <span class="sc">%in%</span> valores_busqueda <span class="sc">&amp;</span> group_minor <span class="sc">%in%</span> sub_valores]</span>
<span id="cb16-209"><a href="#cb16-209" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb16-210"><a href="#cb16-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-211"><a href="#cb16-211" aria-hidden="true" tabindex="-1"></a>tiempo_con_key <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb16-212"><a href="#cb16-212" aria-hidden="true" tabindex="-1"></a>  result_with_key <span class="ot">&lt;-</span> dt_with_key[.(valores_busqueda, sub_valores)]</span>
<span id="cb16-213"><a href="#cb16-213" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb16-214"><a href="#cb16-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-215"><a href="#cb16-215" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Búsqueda sin key:"</span>, <span class="fu">round</span>(tiempo_sin_key[<span class="dv">3</span>], <span class="dv">4</span>), <span class="st">"segundos</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-216"><a href="#cb16-216" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Búsqueda con key:"</span>, <span class="fu">round</span>(tiempo_con_key[<span class="dv">3</span>], <span class="dv">4</span>), <span class="st">"segundos</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-217"><a href="#cb16-217" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Speedup:"</span>, <span class="fu">round</span>(tiempo_sin_key[<span class="dv">3</span>] <span class="sc">/</span> tiempo_con_key[<span class="dv">3</span>], <span class="dv">1</span>), <span class="st">"x más rápido</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-218"><a href="#cb16-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-219"><a href="#cb16-219" aria-hidden="true" tabindex="-1"></a><span class="co"># Verificar que ambos resultados son equivalentes</span></span>
<span id="cb16-220"><a href="#cb16-220" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Resultados equivalentes:"</span>, <span class="fu">nrow</span>(result_no_key) <span class="sc">==</span> <span class="fu">nrow</span>(result_with_key), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-221"><a href="#cb16-221" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-222"><a href="#cb16-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-223"><a href="#cb16-223" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2. **Múltiples Keys para Diferentes Patrones de Consulta**</span></span>
<span id="cb16-224"><a href="#cb16-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-227"><a href="#cb16-227" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-228"><a href="#cb16-228" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: multiple-keys-strategy</span></span>
<span id="cb16-229"><a href="#cb16-229" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb16-230"><a href="#cb16-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-231"><a href="#cb16-231" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear múltiples copias para diferentes estrategias de indexing</span></span>
<span id="cb16-232"><a href="#cb16-232" aria-hidden="true" tabindex="-1"></a>dt_by_group <span class="ot">&lt;-</span> <span class="fu">copy</span>(big_dataset[<span class="fu">sample</span>(.N, <span class="dv">300000</span>)])</span>
<span id="cb16-233"><a href="#cb16-233" aria-hidden="true" tabindex="-1"></a>dt_by_time <span class="ot">&lt;-</span> <span class="fu">copy</span>(dt_by_group)</span>
<span id="cb16-234"><a href="#cb16-234" aria-hidden="true" tabindex="-1"></a>dt_by_id <span class="ot">&lt;-</span> <span class="fu">copy</span>(dt_by_group)</span>
<span id="cb16-235"><a href="#cb16-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-236"><a href="#cb16-236" aria-hidden="true" tabindex="-1"></a><span class="co"># Establecer diferentes keys según el patrón de uso</span></span>
<span id="cb16-237"><a href="#cb16-237" aria-hidden="true" tabindex="-1"></a><span class="fu">setkey</span>(dt_by_group, group_major, group_minor)</span>
<span id="cb16-238"><a href="#cb16-238" aria-hidden="true" tabindex="-1"></a><span class="fu">setkey</span>(dt_by_time, timestamp)</span>
<span id="cb16-239"><a href="#cb16-239" aria-hidden="true" tabindex="-1"></a><span class="fu">setkey</span>(dt_by_id, id)</span>
<span id="cb16-240"><a href="#cb16-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-241"><a href="#cb16-241" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== ESTRATEGIAS DE KEYS ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-242"><a href="#cb16-242" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"dt_by_group key:"</span>, <span class="fu">paste</span>(<span class="fu">key</span>(dt_by_group), <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-243"><a href="#cb16-243" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"dt_by_time key:"</span>, <span class="fu">paste</span>(<span class="fu">key</span>(dt_by_time), <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-244"><a href="#cb16-244" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"dt_by_id key:"</span>, <span class="fu">paste</span>(<span class="fu">key</span>(dt_by_id), <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb16-245"><a href="#cb16-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-246"><a href="#cb16-246" aria-hidden="true" tabindex="-1"></a><span class="co"># Consultas optimizadas según la key</span></span>
<span id="cb16-247"><a href="#cb16-247" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Consultando por grupos...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-248"><a href="#cb16-248" aria-hidden="true" tabindex="-1"></a>tiempo_grupo <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb16-249"><a href="#cb16-249" aria-hidden="true" tabindex="-1"></a>  result_grupo <span class="ot">&lt;-</span> dt_by_group[.(<span class="st">"A"</span>, <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"c"</span>))]</span>
<span id="cb16-250"><a href="#cb16-250" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb16-251"><a href="#cb16-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-252"><a href="#cb16-252" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Consultando por tiempo...</span><span class="sc">\n</span><span class="st">"</span>) </span>
<span id="cb16-253"><a href="#cb16-253" aria-hidden="true" tabindex="-1"></a>tiempo_temporal <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb16-254"><a href="#cb16-254" aria-hidden="true" tabindex="-1"></a>  result_temporal <span class="ot">&lt;-</span> dt_by_time[timestamp <span class="sc">&gt;=</span> <span class="fu">as.POSIXct</span>(<span class="st">"2024-01-01"</span>) <span class="sc">&amp;</span> </span>
<span id="cb16-255"><a href="#cb16-255" aria-hidden="true" tabindex="-1"></a>                               timestamp <span class="sc">&lt;</span> <span class="fu">as.POSIXct</span>(<span class="st">"2024-02-01"</span>)]</span>
<span id="cb16-256"><a href="#cb16-256" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb16-257"><a href="#cb16-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-258"><a href="#cb16-258" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Consultando por IDs...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-259"><a href="#cb16-259" aria-hidden="true" tabindex="-1"></a>ids_especificos <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">1000000</span>, <span class="dv">1000</span>)</span>
<span id="cb16-260"><a href="#cb16-260" aria-hidden="true" tabindex="-1"></a>tiempo_ids <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb16-261"><a href="#cb16-261" aria-hidden="true" tabindex="-1"></a>  result_ids <span class="ot">&lt;-</span> dt_by_id[.(ids_especificos)]</span>
<span id="cb16-262"><a href="#cb16-262" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb16-263"><a href="#cb16-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-264"><a href="#cb16-264" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Tiempos de consulta optimizada:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-265"><a href="#cb16-265" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"• Por grupos:"</span>, <span class="fu">round</span>(tiempo_grupo[<span class="dv">3</span>], <span class="dv">4</span>), <span class="st">"segundos</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-266"><a href="#cb16-266" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"• Por tiempo:"</span>, <span class="fu">round</span>(tiempo_temporal[<span class="dv">3</span>], <span class="dv">4</span>), <span class="st">"segundos</span><span class="sc">\n</span><span class="st">"</span>) </span>
<span id="cb16-267"><a href="#cb16-267" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"• Por IDs:"</span>, <span class="fu">round</span>(tiempo_ids[<span class="dv">3</span>], <span class="dv">4</span>), <span class="st">"segundos</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-268"><a href="#cb16-268" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-269"><a href="#cb16-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-270"><a href="#cb16-270" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3. **Índices Secundarios con setindex()**</span></span>
<span id="cb16-271"><a href="#cb16-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-274"><a href="#cb16-274" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-275"><a href="#cb16-275" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setindex-secondary</span></span>
<span id="cb16-276"><a href="#cb16-276" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb16-277"><a href="#cb16-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-278"><a href="#cb16-278" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear tabla con key principal e índices secundarios</span></span>
<span id="cb16-279"><a href="#cb16-279" aria-hidden="true" tabindex="-1"></a>dt_indexed <span class="ot">&lt;-</span> <span class="fu">copy</span>(big_dataset[<span class="fu">sample</span>(.N, <span class="dv">400000</span>)])</span>
<span id="cb16-280"><a href="#cb16-280" aria-hidden="true" tabindex="-1"></a><span class="fu">setkey</span>(dt_indexed, group_major)  <span class="co"># Key principal</span></span>
<span id="cb16-281"><a href="#cb16-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-282"><a href="#cb16-282" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== ÍNDICES SECUNDARIOS ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-283"><a href="#cb16-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-284"><a href="#cb16-284" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear índices secundarios para consultas frecuentes</span></span>
<span id="cb16-285"><a href="#cb16-285" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Creando índices secundarios...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-286"><a href="#cb16-286" aria-hidden="true" tabindex="-1"></a>tiempo_indices <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb16-287"><a href="#cb16-287" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setindex</span>(dt_indexed, category)</span>
<span id="cb16-288"><a href="#cb16-288" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setindex</span>(dt_indexed, status)</span>
<span id="cb16-289"><a href="#cb16-289" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setindex</span>(dt_indexed, region)</span>
<span id="cb16-290"><a href="#cb16-290" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setindex</span>(dt_indexed, timestamp)</span>
<span id="cb16-291"><a href="#cb16-291" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setindex</span>(dt_indexed, id, value_numeric)  <span class="co"># Índice compuesto</span></span>
<span id="cb16-292"><a href="#cb16-292" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb16-293"><a href="#cb16-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-294"><a href="#cb16-294" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Tiempo para crear índices:"</span>, <span class="fu">round</span>(tiempo_indices[<span class="dv">3</span>], <span class="dv">3</span>), <span class="st">"segundos</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-295"><a href="#cb16-295" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Índices creados:"</span>, <span class="fu">length</span>(<span class="fu">indices</span>(dt_indexed)), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-296"><a href="#cb16-296" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">indices</span>(dt_indexed))</span>
<span id="cb16-297"><a href="#cb16-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-298"><a href="#cb16-298" aria-hidden="true" tabindex="-1"></a><span class="co"># Comparar consultas con y sin índices</span></span>
<span id="cb16-299"><a href="#cb16-299" aria-hidden="true" tabindex="-1"></a>dt_sin_indices <span class="ot">&lt;-</span> <span class="fu">copy</span>(big_dataset[<span class="fu">sample</span>(.N, <span class="dv">400000</span>)])</span>
<span id="cb16-300"><a href="#cb16-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-301"><a href="#cb16-301" aria-hidden="true" tabindex="-1"></a><span class="co"># Consulta que puede usar índice</span></span>
<span id="cb16-302"><a href="#cb16-302" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Comparando consultas por categoría:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-303"><a href="#cb16-303" aria-hidden="true" tabindex="-1"></a>tiempo_sin_indice <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb16-304"><a href="#cb16-304" aria-hidden="true" tabindex="-1"></a>  result_sin_indice <span class="ot">&lt;-</span> dt_sin_indices[category <span class="sc">==</span> <span class="st">"Cat_5"</span> <span class="sc">&amp;</span> status <span class="sc">==</span> <span class="st">"Active"</span>]</span>
<span id="cb16-305"><a href="#cb16-305" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb16-306"><a href="#cb16-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-307"><a href="#cb16-307" aria-hidden="true" tabindex="-1"></a>tiempo_con_indice <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb16-308"><a href="#cb16-308" aria-hidden="true" tabindex="-1"></a>  result_con_indice <span class="ot">&lt;-</span> dt_indexed[category <span class="sc">==</span> <span class="st">"Cat_5"</span> <span class="sc">&amp;</span> status <span class="sc">==</span> <span class="st">"Active"</span>]</span>
<span id="cb16-309"><a href="#cb16-309" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb16-310"><a href="#cb16-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-311"><a href="#cb16-311" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Sin índice:"</span>, <span class="fu">round</span>(tiempo_sin_indice[<span class="dv">3</span>], <span class="dv">4</span>), <span class="st">"segundos</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-312"><a href="#cb16-312" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Con índice:"</span>, <span class="fu">round</span>(tiempo_con_indice[<span class="dv">3</span>], <span class="dv">4</span>), <span class="st">"segundos</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-313"><a href="#cb16-313" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Speedup:"</span>, <span class="fu">round</span>(tiempo_sin_indice[<span class="dv">3</span>] <span class="sc">/</span> tiempo_con_indice[<span class="dv">3</span>], <span class="dv">1</span>), <span class="st">"x</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-314"><a href="#cb16-314" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-315"><a href="#cb16-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-316"><a href="#cb16-316" aria-hidden="true" tabindex="-1"></a><span class="fu">## Profiling y Benchmarking Sistemático</span></span>
<span id="cb16-317"><a href="#cb16-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-318"><a href="#cb16-318" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1. **Modo Verbose para Análisis Detallado**</span></span>
<span id="cb16-319"><a href="#cb16-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-322"><a href="#cb16-322" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-323"><a href="#cb16-323" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: verbose-analysis</span></span>
<span id="cb16-324"><a href="#cb16-324" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb16-325"><a href="#cb16-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-326"><a href="#cb16-326" aria-hidden="true" tabindex="-1"></a><span class="co"># Activar modo verbose para operaciones específicas</span></span>
<span id="cb16-327"><a href="#cb16-327" aria-hidden="true" tabindex="-1"></a>verbose_analysis <span class="ot">&lt;-</span> <span class="cf">function</span>(dt, operation_name, operation_func) {</span>
<span id="cb16-328"><a href="#cb16-328" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"=== ANÁLISIS:"</span>, operation_name, <span class="st">"===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-329"><a href="#cb16-329" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-330"><a href="#cb16-330" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Activar verbose temporalmente</span></span>
<span id="cb16-331"><a href="#cb16-331" aria-hidden="true" tabindex="-1"></a>  old_verbose <span class="ot">&lt;-</span> <span class="fu">getOption</span>(<span class="st">"datatable.verbose"</span>)</span>
<span id="cb16-332"><a href="#cb16-332" aria-hidden="true" tabindex="-1"></a>  <span class="fu">options</span>(<span class="at">datatable.verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-333"><a href="#cb16-333" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-334"><a href="#cb16-334" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ejecutar operación</span></span>
<span id="cb16-335"><a href="#cb16-335" aria-hidden="true" tabindex="-1"></a>  start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb16-336"><a href="#cb16-336" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">operation_func</span>(dt)</span>
<span id="cb16-337"><a href="#cb16-337" aria-hidden="true" tabindex="-1"></a>  end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb16-338"><a href="#cb16-338" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-339"><a href="#cb16-339" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Restaurar verbose</span></span>
<span id="cb16-340"><a href="#cb16-340" aria-hidden="true" tabindex="-1"></a>  <span class="fu">options</span>(<span class="at">datatable.verbose =</span> old_verbose)</span>
<span id="cb16-341"><a href="#cb16-341" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-342"><a href="#cb16-342" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Tiempo total:"</span>, <span class="fu">round</span>(<span class="fu">as.numeric</span>(end_time <span class="sc">-</span> start_time), <span class="dv">4</span>), <span class="st">"segundos</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-343"><a href="#cb16-343" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Filas resultado:"</span>, <span class="fu">nrow</span>(result), <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb16-344"><a href="#cb16-344" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-345"><a href="#cb16-345" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb16-346"><a href="#cb16-346" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-347"><a href="#cb16-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-348"><a href="#cb16-348" aria-hidden="true" tabindex="-1"></a><span class="co"># Ejemplo de análisis con verbose</span></span>
<span id="cb16-349"><a href="#cb16-349" aria-hidden="true" tabindex="-1"></a>dt_sample <span class="ot">&lt;-</span> big_dataset[<span class="fu">sample</span>(.N, <span class="dv">100000</span>)]</span>
<span id="cb16-350"><a href="#cb16-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-351"><a href="#cb16-351" aria-hidden="true" tabindex="-1"></a><span class="co"># Operación compleja para analizar</span></span>
<span id="cb16-352"><a href="#cb16-352" aria-hidden="true" tabindex="-1"></a>resultado_verbose <span class="ot">&lt;-</span> <span class="fu">verbose_analysis</span>(dt_sample, <span class="st">"Agregación Compleja"</span>, <span class="cf">function</span>(dt) {</span>
<span id="cb16-353"><a href="#cb16-353" aria-hidden="true" tabindex="-1"></a>  dt[status <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Active"</span>, <span class="st">"Completed"</span>), </span>
<span id="cb16-354"><a href="#cb16-354" aria-hidden="true" tabindex="-1"></a>     .(<span class="at">avg_value =</span> <span class="fu">mean</span>(value_numeric),</span>
<span id="cb16-355"><a href="#cb16-355" aria-hidden="true" tabindex="-1"></a>       <span class="at">sum_amount =</span> <span class="fu">sum</span>(amount),</span>
<span id="cb16-356"><a href="#cb16-356" aria-hidden="true" tabindex="-1"></a>       <span class="at">count =</span> .N,</span>
<span id="cb16-357"><a href="#cb16-357" aria-hidden="true" tabindex="-1"></a>       <span class="at">median_amount =</span> <span class="fu">median</span>(amount)), </span>
<span id="cb16-358"><a href="#cb16-358" aria-hidden="true" tabindex="-1"></a>     by <span class="ot">=</span> .(group_major, category)]</span>
<span id="cb16-359"><a href="#cb16-359" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb16-360"><a href="#cb16-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-361"><a href="#cb16-361" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(resultado_verbose))</span>
<span id="cb16-362"><a href="#cb16-362" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-363"><a href="#cb16-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-364"><a href="#cb16-364" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2. **Benchmarking Comparativo de Estrategias**</span></span>
<span id="cb16-365"><a href="#cb16-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-368"><a href="#cb16-368" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-369"><a href="#cb16-369" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: benchmark-estrategias</span></span>
<span id="cb16-370"><a href="#cb16-370" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb16-371"><a href="#cb16-371" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: true</span></span>
<span id="cb16-372"><a href="#cb16-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-373"><a href="#cb16-373" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear función de benchmark comprehensiva</span></span>
<span id="cb16-374"><a href="#cb16-374" aria-hidden="true" tabindex="-1"></a>benchmark_comprehensive <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">dt_size =</span> <span class="dv">200000</span>) {</span>
<span id="cb16-375"><a href="#cb16-375" aria-hidden="true" tabindex="-1"></a>  dt_test <span class="ot">&lt;-</span> big_dataset[<span class="fu">sample</span>(.N, dt_size)]</span>
<span id="cb16-376"><a href="#cb16-376" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-377"><a href="#cb16-377" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estrategia 1: Sin optimizaciones</span></span>
<span id="cb16-378"><a href="#cb16-378" aria-hidden="true" tabindex="-1"></a>  strategy1 <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb16-379"><a href="#cb16-379" aria-hidden="true" tabindex="-1"></a>    dt_test[group_major <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>) <span class="sc">&amp;</span> status <span class="sc">==</span> <span class="st">"Active"</span>,</span>
<span id="cb16-380"><a href="#cb16-380" aria-hidden="true" tabindex="-1"></a>           .(<span class="at">mean_val =</span> <span class="fu">mean</span>(value_numeric), </span>
<span id="cb16-381"><a href="#cb16-381" aria-hidden="true" tabindex="-1"></a>             <span class="at">sum_amount =</span> <span class="fu">sum</span>(amount),</span>
<span id="cb16-382"><a href="#cb16-382" aria-hidden="true" tabindex="-1"></a>             <span class="at">count =</span> .N),</span>
<span id="cb16-383"><a href="#cb16-383" aria-hidden="true" tabindex="-1"></a>           by <span class="ot">=</span> .(group_minor, category)]</span>
<span id="cb16-384"><a href="#cb16-384" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-385"><a href="#cb16-385" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-386"><a href="#cb16-386" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estrategia 2: Con setkey optimizado</span></span>
<span id="cb16-387"><a href="#cb16-387" aria-hidden="true" tabindex="-1"></a>  dt_keyed <span class="ot">&lt;-</span> <span class="fu">copy</span>(dt_test)</span>
<span id="cb16-388"><a href="#cb16-388" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setkey</span>(dt_keyed, group_major, group_minor)</span>
<span id="cb16-389"><a href="#cb16-389" aria-hidden="true" tabindex="-1"></a>  strategy2 <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb16-390"><a href="#cb16-390" aria-hidden="true" tabindex="-1"></a>    dt_keyed[.(<span class="fu">c</span>(<span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>))][status <span class="sc">==</span> <span class="st">"Active"</span>,</span>
<span id="cb16-391"><a href="#cb16-391" aria-hidden="true" tabindex="-1"></a>            .(<span class="at">mean_val =</span> <span class="fu">mean</span>(value_numeric),</span>
<span id="cb16-392"><a href="#cb16-392" aria-hidden="true" tabindex="-1"></a>              <span class="at">sum_amount =</span> <span class="fu">sum</span>(amount), </span>
<span id="cb16-393"><a href="#cb16-393" aria-hidden="true" tabindex="-1"></a>              <span class="at">count =</span> .N),</span>
<span id="cb16-394"><a href="#cb16-394" aria-hidden="true" tabindex="-1"></a>            by <span class="ot">=</span> .(group_minor, category)]</span>
<span id="cb16-395"><a href="#cb16-395" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-396"><a href="#cb16-396" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-397"><a href="#cb16-397" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estrategia 3: Pre-filtrar luego agrupar</span></span>
<span id="cb16-398"><a href="#cb16-398" aria-hidden="true" tabindex="-1"></a>  strategy3 <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb16-399"><a href="#cb16-399" aria-hidden="true" tabindex="-1"></a>    dt_filtered <span class="ot">&lt;-</span> dt_test[group_major <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>) <span class="sc">&amp;</span> status <span class="sc">==</span> <span class="st">"Active"</span>]</span>
<span id="cb16-400"><a href="#cb16-400" aria-hidden="true" tabindex="-1"></a>    dt_filtered[, .(<span class="at">mean_val =</span> <span class="fu">mean</span>(value_numeric),</span>
<span id="cb16-401"><a href="#cb16-401" aria-hidden="true" tabindex="-1"></a>                   <span class="at">sum_amount =</span> <span class="fu">sum</span>(amount),</span>
<span id="cb16-402"><a href="#cb16-402" aria-hidden="true" tabindex="-1"></a>                   <span class="at">count =</span> .N),</span>
<span id="cb16-403"><a href="#cb16-403" aria-hidden="true" tabindex="-1"></a>               by <span class="ot">=</span> .(group_minor, category)]</span>
<span id="cb16-404"><a href="#cb16-404" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-405"><a href="#cb16-405" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-406"><a href="#cb16-406" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estrategia 4: Con índices secundarios</span></span>
<span id="cb16-407"><a href="#cb16-407" aria-hidden="true" tabindex="-1"></a>  dt_indexed <span class="ot">&lt;-</span> <span class="fu">copy</span>(dt_test)</span>
<span id="cb16-408"><a href="#cb16-408" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setindex</span>(dt_indexed, group_major)</span>
<span id="cb16-409"><a href="#cb16-409" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setindex</span>(dt_indexed, status)</span>
<span id="cb16-410"><a href="#cb16-410" aria-hidden="true" tabindex="-1"></a>  strategy4 <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb16-411"><a href="#cb16-411" aria-hidden="true" tabindex="-1"></a>    dt_indexed[group_major <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>) <span class="sc">&amp;</span> status <span class="sc">==</span> <span class="st">"Active"</span>,</span>
<span id="cb16-412"><a href="#cb16-412" aria-hidden="true" tabindex="-1"></a>              .(<span class="at">mean_val =</span> <span class="fu">mean</span>(value_numeric),</span>
<span id="cb16-413"><a href="#cb16-413" aria-hidden="true" tabindex="-1"></a>                <span class="at">sum_amount =</span> <span class="fu">sum</span>(amount),</span>
<span id="cb16-414"><a href="#cb16-414" aria-hidden="true" tabindex="-1"></a>                <span class="at">count =</span> .N),</span>
<span id="cb16-415"><a href="#cb16-415" aria-hidden="true" tabindex="-1"></a>              by <span class="ot">=</span> .(group_minor, category)]</span>
<span id="cb16-416"><a href="#cb16-416" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-417"><a href="#cb16-417" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-418"><a href="#cb16-418" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ejecutar benchmark</span></span>
<span id="cb16-419"><a href="#cb16-419" aria-hidden="true" tabindex="-1"></a>  benchmark_result <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(</span>
<span id="cb16-420"><a href="#cb16-420" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sin optimizar"</span> <span class="ot">=</span> <span class="fu">strategy1</span>(),</span>
<span id="cb16-421"><a href="#cb16-421" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Con setkey"</span> <span class="ot">=</span> <span class="fu">strategy2</span>(),</span>
<span id="cb16-422"><a href="#cb16-422" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Pre-filtrar"</span> <span class="ot">=</span> <span class="fu">strategy3</span>(), </span>
<span id="cb16-423"><a href="#cb16-423" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Con índices"</span> <span class="ot">=</span> <span class="fu">strategy4</span>(),</span>
<span id="cb16-424"><a href="#cb16-424" aria-hidden="true" tabindex="-1"></a>    <span class="at">times =</span> <span class="dv">10</span></span>
<span id="cb16-425"><a href="#cb16-425" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-426"><a href="#cb16-426" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-427"><a href="#cb16-427" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(benchmark_result)</span>
<span id="cb16-428"><a href="#cb16-428" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-429"><a href="#cb16-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-430"><a href="#cb16-430" aria-hidden="true" tabindex="-1"></a><span class="co"># Ejecutar benchmark comprehensivo</span></span>
<span id="cb16-431"><a href="#cb16-431" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== BENCHMARK COMPREHENSIVO DE ESTRATEGIAS ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-432"><a href="#cb16-432" aria-hidden="true" tabindex="-1"></a>benchmark_result <span class="ot">&lt;-</span> <span class="fu">benchmark_comprehensive</span>(<span class="dv">150000</span>)</span>
<span id="cb16-433"><a href="#cb16-433" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(benchmark_result)</span>
<span id="cb16-434"><a href="#cb16-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-435"><a href="#cb16-435" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear visualización si ggplot2 está disponible</span></span>
<span id="cb16-436"><a href="#cb16-436" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">require</span>(ggplot2, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb16-437"><a href="#cb16-437" aria-hidden="true" tabindex="-1"></a>  plot_benchmark <span class="ot">&lt;-</span> <span class="fu">autoplot</span>(benchmark_result) <span class="sc">+</span></span>
<span id="cb16-438"><a href="#cb16-438" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Comparación de Estrategias de Optimización"</span>,</span>
<span id="cb16-439"><a href="#cb16-439" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="st">"Menor tiempo = mejor performance"</span>,</span>
<span id="cb16-440"><a href="#cb16-440" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Tiempo (milisegundos)"</span>,</span>
<span id="cb16-441"><a href="#cb16-441" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Estrategia"</span>) <span class="sc">+</span></span>
<span id="cb16-442"><a href="#cb16-442" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb16-443"><a href="#cb16-443" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span>
<span id="cb16-444"><a href="#cb16-444" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-445"><a href="#cb16-445" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(plot_benchmark)</span>
<span id="cb16-446"><a href="#cb16-446" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-447"><a href="#cb16-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-448"><a href="#cb16-448" aria-hidden="true" tabindex="-1"></a><span class="co"># Análisis de resultados</span></span>
<span id="cb16-449"><a href="#cb16-449" aria-hidden="true" tabindex="-1"></a>summary_benchmark <span class="ot">&lt;-</span> <span class="fu">summary</span>(benchmark_result)</span>
<span id="cb16-450"><a href="#cb16-450" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Resumen de performance:"</span>)</span>
<span id="cb16-451"><a href="#cb16-451" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(summary_benchmark)</span>
<span id="cb16-452"><a href="#cb16-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-453"><a href="#cb16-453" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular speedup relativo</span></span>
<span id="cb16-454"><a href="#cb16-454" aria-hidden="true" tabindex="-1"></a>baseline_median <span class="ot">&lt;-</span> summary_benchmark[summary_benchmark<span class="sc">$</span>expr <span class="sc">==</span> <span class="st">"Sin optimizar"</span>, <span class="st">"median"</span>]</span>
<span id="cb16-455"><a href="#cb16-455" aria-hidden="true" tabindex="-1"></a>summary_benchmark<span class="sc">$</span>speedup <span class="ot">&lt;-</span> <span class="fu">round</span>(baseline_median <span class="sc">/</span> summary_benchmark<span class="sc">$</span>median, <span class="dv">2</span>)</span>
<span id="cb16-456"><a href="#cb16-456" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Speedup relativo (vs sin optimizar):"</span>)</span>
<span id="cb16-457"><a href="#cb16-457" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(summary_benchmark[, <span class="fu">c</span>(<span class="st">"expr"</span>, <span class="st">"median"</span>, <span class="st">"speedup"</span>)])</span>
<span id="cb16-458"><a href="#cb16-458" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-459"><a href="#cb16-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-460"><a href="#cb16-460" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3. **Memory Profiling Avanzado**</span></span>
<span id="cb16-461"><a href="#cb16-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-464"><a href="#cb16-464" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-465"><a href="#cb16-465" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: memory-profiling-advanced</span></span>
<span id="cb16-466"><a href="#cb16-466" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb16-467"><a href="#cb16-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-468"><a href="#cb16-468" aria-hidden="true" tabindex="-1"></a><span class="co"># Función para análisis detallado de memoria</span></span>
<span id="cb16-469"><a href="#cb16-469" aria-hidden="true" tabindex="-1"></a>memory_analysis <span class="ot">&lt;-</span> <span class="cf">function</span>(operation_name, operation_func, dt_input) {</span>
<span id="cb16-470"><a href="#cb16-470" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"=== ANÁLISIS DE MEMORIA:"</span>, operation_name, <span class="st">"===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-471"><a href="#cb16-471" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-472"><a href="#cb16-472" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Limpiar garbage collector</span></span>
<span id="cb16-473"><a href="#cb16-473" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(<span class="fu">gc</span>(<span class="at">verbose =</span> <span class="cn">FALSE</span>))</span>
<span id="cb16-474"><a href="#cb16-474" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-475"><a href="#cb16-475" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Memoria antes</span></span>
<span id="cb16-476"><a href="#cb16-476" aria-hidden="true" tabindex="-1"></a>  mem_before <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">object.size</span>(dt_input))</span>
<span id="cb16-477"><a href="#cb16-477" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-478"><a href="#cb16-478" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ejecutar operación y medir tiempo</span></span>
<span id="cb16-479"><a href="#cb16-479" aria-hidden="true" tabindex="-1"></a>  start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb16-480"><a href="#cb16-480" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">operation_func</span>(dt_input)</span>
<span id="cb16-481"><a href="#cb16-481" aria-hidden="true" tabindex="-1"></a>  end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb16-482"><a href="#cb16-482" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-483"><a href="#cb16-483" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Memoria después</span></span>
<span id="cb16-484"><a href="#cb16-484" aria-hidden="true" tabindex="-1"></a>  mem_after <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">object.size</span>(dt_input))</span>
<span id="cb16-485"><a href="#cb16-485" aria-hidden="true" tabindex="-1"></a>  mem_result <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">object.size</span>(result))</span>
<span id="cb16-486"><a href="#cb16-486" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-487"><a href="#cb16-487" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Reportar resultados</span></span>
<span id="cb16-488"><a href="#cb16-488" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Tiempo de ejecución:"</span>, <span class="fu">round</span>(<span class="fu">as.numeric</span>(end_time <span class="sc">-</span> start_time), <span class="dv">4</span>), <span class="st">"segundos</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-489"><a href="#cb16-489" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Memoria input:"</span>, <span class="fu">format</span>(mem_before, <span class="at">units =</span> <span class="st">"auto"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-490"><a href="#cb16-490" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Memoria después:"</span>, <span class="fu">format</span>(mem_after, <span class="at">units =</span> <span class="st">"auto"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-491"><a href="#cb16-491" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Memoria resultado:"</span>, <span class="fu">format</span>(mem_result, <span class="at">units =</span> <span class="st">"auto"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-492"><a href="#cb16-492" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Cambio en memoria input:"</span>, <span class="fu">format</span>(mem_after <span class="sc">-</span> mem_before, <span class="at">units =</span> <span class="st">"auto"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-493"><a href="#cb16-493" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Eficiencia memoria:"</span>, <span class="fu">round</span>(mem_result <span class="sc">/</span> mem_before <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"% del input</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb16-494"><a href="#cb16-494" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-495"><a href="#cb16-495" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb16-496"><a href="#cb16-496" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-497"><a href="#cb16-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-498"><a href="#cb16-498" aria-hidden="true" tabindex="-1"></a><span class="co"># Comparar diferentes operaciones</span></span>
<span id="cb16-499"><a href="#cb16-499" aria-hidden="true" tabindex="-1"></a>dt_mem_test <span class="ot">&lt;-</span> big_dataset[<span class="fu">sample</span>(.N, <span class="dv">100000</span>)]</span>
<span id="cb16-500"><a href="#cb16-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-501"><a href="#cb16-501" aria-hidden="true" tabindex="-1"></a><span class="co"># Operación 1: Modificación por referencia</span></span>
<span id="cb16-502"><a href="#cb16-502" aria-hidden="true" tabindex="-1"></a>result1 <span class="ot">&lt;-</span> <span class="fu">memory_analysis</span>(<span class="st">"Modificación por referencia"</span>, <span class="cf">function</span>(dt) {</span>
<span id="cb16-503"><a href="#cb16-503" aria-hidden="true" tabindex="-1"></a>  dt[, new_computed_col <span class="sc">:</span><span class="er">=</span> value_numeric <span class="sc">*</span> amount <span class="sc">*</span> <span class="fl">1.1</span>]</span>
<span id="cb16-504"><a href="#cb16-504" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(dt)</span>
<span id="cb16-505"><a href="#cb16-505" aria-hidden="true" tabindex="-1"></a>}, <span class="fu">copy</span>(dt_mem_test))</span>
<span id="cb16-506"><a href="#cb16-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-507"><a href="#cb16-507" aria-hidden="true" tabindex="-1"></a><span class="co"># Operación 2: Crear nueva tabla</span></span>
<span id="cb16-508"><a href="#cb16-508" aria-hidden="true" tabindex="-1"></a>result2 <span class="ot">&lt;-</span> <span class="fu">memory_analysis</span>(<span class="st">"Crear nueva tabla"</span>, <span class="cf">function</span>(dt) {</span>
<span id="cb16-509"><a href="#cb16-509" aria-hidden="true" tabindex="-1"></a>  dt[, .(id, group_major, value_numeric, amount, </span>
<span id="cb16-510"><a href="#cb16-510" aria-hidden="true" tabindex="-1"></a>         <span class="at">new_computed_col =</span> value_numeric <span class="sc">*</span> amount <span class="sc">*</span> <span class="fl">1.1</span>)]</span>
<span id="cb16-511"><a href="#cb16-511" aria-hidden="true" tabindex="-1"></a>}, dt_mem_test)</span>
<span id="cb16-512"><a href="#cb16-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-513"><a href="#cb16-513" aria-hidden="true" tabindex="-1"></a><span class="co"># Operación 3: Agregación</span></span>
<span id="cb16-514"><a href="#cb16-514" aria-hidden="true" tabindex="-1"></a>result3 <span class="ot">&lt;-</span> <span class="fu">memory_analysis</span>(<span class="st">"Agregación por grupos"</span>, <span class="cf">function</span>(dt) {</span>
<span id="cb16-515"><a href="#cb16-515" aria-hidden="true" tabindex="-1"></a>  dt[, .(<span class="at">mean_value =</span> <span class="fu">mean</span>(value_numeric),</span>
<span id="cb16-516"><a href="#cb16-516" aria-hidden="true" tabindex="-1"></a>         <span class="at">sum_amount =</span> <span class="fu">sum</span>(amount),</span>
<span id="cb16-517"><a href="#cb16-517" aria-hidden="true" tabindex="-1"></a>         <span class="at">count =</span> .N), </span>
<span id="cb16-518"><a href="#cb16-518" aria-hidden="true" tabindex="-1"></a>     by <span class="ot">=</span> .(group_major, group_minor)]</span>
<span id="cb16-519"><a href="#cb16-519" aria-hidden="true" tabindex="-1"></a>}, dt_mem_test)</span>
<span id="cb16-520"><a href="#cb16-520" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-521"><a href="#cb16-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-522"><a href="#cb16-522" aria-hidden="true" tabindex="-1"></a><span class="fu">## Optimización de Operaciones Específicas</span></span>
<span id="cb16-523"><a href="#cb16-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-524"><a href="#cb16-524" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1. **Joins a Gran Escala**</span></span>
<span id="cb16-525"><a href="#cb16-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-528"><a href="#cb16-528" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-529"><a href="#cb16-529" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: optimize-large-joins</span></span>
<span id="cb16-530"><a href="#cb16-530" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb16-531"><a href="#cb16-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-532"><a href="#cb16-532" aria-hidden="true" tabindex="-1"></a><span class="co"># Preparar datos para joins de diferentes tamaños</span></span>
<span id="cb16-533"><a href="#cb16-533" aria-hidden="true" tabindex="-1"></a>dt_left_large <span class="ot">&lt;-</span> big_dataset[<span class="fu">sample</span>(.N, <span class="dv">200000</span>)]</span>
<span id="cb16-534"><a href="#cb16-534" aria-hidden="true" tabindex="-1"></a>dt_right_large <span class="ot">&lt;-</span> lookup_data[<span class="fu">sample</span>(.N, <span class="dv">100000</span>)]</span>
<span id="cb16-535"><a href="#cb16-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-536"><a href="#cb16-536" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== OPTIMIZACIÓN DE JOINS GRANDES ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-537"><a href="#cb16-537" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Tabla izquierda:"</span>, <span class="fu">nrow</span>(dt_left_large), <span class="st">"filas</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-538"><a href="#cb16-538" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Tabla derecha:"</span>, <span class="fu">nrow</span>(dt_right_large), <span class="st">"filas</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb16-539"><a href="#cb16-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-540"><a href="#cb16-540" aria-hidden="true" tabindex="-1"></a><span class="co"># Estrategia 1: Merge básico</span></span>
<span id="cb16-541"><a href="#cb16-541" aria-hidden="true" tabindex="-1"></a>tiempo_merge <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb16-542"><a href="#cb16-542" aria-hidden="true" tabindex="-1"></a>  result_merge <span class="ot">&lt;-</span> <span class="fu">merge</span>(dt_left_large, dt_right_large, <span class="at">by =</span> <span class="st">"id"</span>, <span class="at">all.x =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-543"><a href="#cb16-543" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb16-544"><a href="#cb16-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-545"><a href="#cb16-545" aria-hidden="true" tabindex="-1"></a><span class="co"># Estrategia 2: Join con setkey</span></span>
<span id="cb16-546"><a href="#cb16-546" aria-hidden="true" tabindex="-1"></a>dt_left_key <span class="ot">&lt;-</span> <span class="fu">copy</span>(dt_left_large)</span>
<span id="cb16-547"><a href="#cb16-547" aria-hidden="true" tabindex="-1"></a>dt_right_key <span class="ot">&lt;-</span> <span class="fu">copy</span>(dt_right_large)</span>
<span id="cb16-548"><a href="#cb16-548" aria-hidden="true" tabindex="-1"></a><span class="fu">setkey</span>(dt_left_key, id)</span>
<span id="cb16-549"><a href="#cb16-549" aria-hidden="true" tabindex="-1"></a><span class="fu">setkey</span>(dt_right_key, id)</span>
<span id="cb16-550"><a href="#cb16-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-551"><a href="#cb16-551" aria-hidden="true" tabindex="-1"></a>tiempo_setkey_join <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb16-552"><a href="#cb16-552" aria-hidden="true" tabindex="-1"></a>  result_setkey <span class="ot">&lt;-</span> dt_right_key[dt_left_key]</span>
<span id="cb16-553"><a href="#cb16-553" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb16-554"><a href="#cb16-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-555"><a href="#cb16-555" aria-hidden="true" tabindex="-1"></a><span class="co"># Estrategia 3: Join con on= (sin modificar tablas originales)</span></span>
<span id="cb16-556"><a href="#cb16-556" aria-hidden="true" tabindex="-1"></a>tiempo_on_join <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb16-557"><a href="#cb16-557" aria-hidden="true" tabindex="-1"></a>  result_on <span class="ot">&lt;-</span> dt_left_large[dt_right_large, on <span class="ot">=</span> .(id)]</span>
<span id="cb16-558"><a href="#cb16-558" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb16-559"><a href="#cb16-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-560"><a href="#cb16-560" aria-hidden="true" tabindex="-1"></a><span class="co"># Estrategia 4: Join filtrado (cuando sabemos que solo necesitamos subset)</span></span>
<span id="cb16-561"><a href="#cb16-561" aria-hidden="true" tabindex="-1"></a>ids_relevantes <span class="ot">&lt;-</span> <span class="fu">intersect</span>(dt_left_large<span class="sc">$</span>id, dt_right_large<span class="sc">$</span>id)[<span class="dv">1</span><span class="sc">:</span><span class="dv">50000</span>]</span>
<span id="cb16-562"><a href="#cb16-562" aria-hidden="true" tabindex="-1"></a>tiempo_filtered_join <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb16-563"><a href="#cb16-563" aria-hidden="true" tabindex="-1"></a>  dt_left_filtered <span class="ot">&lt;-</span> dt_left_large[id <span class="sc">%in%</span> ids_relevantes]</span>
<span id="cb16-564"><a href="#cb16-564" aria-hidden="true" tabindex="-1"></a>  dt_right_filtered <span class="ot">&lt;-</span> dt_right_large[id <span class="sc">%in%</span> ids_relevantes]</span>
<span id="cb16-565"><a href="#cb16-565" aria-hidden="true" tabindex="-1"></a>  result_filtered <span class="ot">&lt;-</span> <span class="fu">merge</span>(dt_left_filtered, dt_right_filtered, <span class="at">by =</span> <span class="st">"id"</span>)</span>
<span id="cb16-566"><a href="#cb16-566" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb16-567"><a href="#cb16-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-568"><a href="#cb16-568" aria-hidden="true" tabindex="-1"></a><span class="co"># Comparar resultados</span></span>
<span id="cb16-569"><a href="#cb16-569" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Resultados de joins:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-570"><a href="#cb16-570" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"• Merge básico:"</span>, <span class="fu">round</span>(tiempo_merge[<span class="dv">3</span>], <span class="dv">4</span>), <span class="st">"segundos,"</span>, <span class="fu">nrow</span>(result_merge), <span class="st">"filas</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-571"><a href="#cb16-571" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"• Con setkey:"</span>, <span class="fu">round</span>(tiempo_setkey_join[<span class="dv">3</span>], <span class="dv">4</span>), <span class="st">"segundos,"</span>, <span class="fu">nrow</span>(result_setkey), <span class="st">"filas</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-572"><a href="#cb16-572" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"• Con on=:"</span>, <span class="fu">round</span>(tiempo_on_join[<span class="dv">3</span>], <span class="dv">4</span>), <span class="st">"segundos,"</span>, <span class="fu">nrow</span>(result_on), <span class="st">"filas</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-573"><a href="#cb16-573" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"• Join filtrado:"</span>, <span class="fu">round</span>(tiempo_filtered_join[<span class="dv">3</span>], <span class="dv">4</span>), <span class="st">"segundos,"</span>, <span class="fu">nrow</span>(result_filtered), <span class="st">"filas</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-574"><a href="#cb16-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-575"><a href="#cb16-575" aria-hidden="true" tabindex="-1"></a><span class="co"># Mejor estrategia</span></span>
<span id="cb16-576"><a href="#cb16-576" aria-hidden="true" tabindex="-1"></a>tiempos_join <span class="ot">&lt;-</span> <span class="fu">c</span>(tiempo_merge[<span class="dv">3</span>], tiempo_setkey_join[<span class="dv">3</span>], tiempo_on_join[<span class="dv">3</span>], tiempo_filtered_join[<span class="dv">3</span>])</span>
<span id="cb16-577"><a href="#cb16-577" aria-hidden="true" tabindex="-1"></a>mejor_join <span class="ot">&lt;-</span> <span class="fu">which.min</span>(tiempos_join)</span>
<span id="cb16-578"><a href="#cb16-578" aria-hidden="true" tabindex="-1"></a>estrategias_join <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Merge básico"</span>, <span class="st">"Con setkey"</span>, <span class="st">"Con on="</span>, <span class="st">"Join filtrado"</span>)</span>
<span id="cb16-579"><a href="#cb16-579" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Mejor estrategia:"</span>, estrategias_join[mejor_join], <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-580"><a href="#cb16-580" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-581"><a href="#cb16-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-582"><a href="#cb16-582" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2. **Operaciones Temporales Optimizadas**</span></span>
<span id="cb16-583"><a href="#cb16-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-586"><a href="#cb16-586" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-587"><a href="#cb16-587" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: optimize-temporal-operations</span></span>
<span id="cb16-588"><a href="#cb16-588" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb16-589"><a href="#cb16-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-590"><a href="#cb16-590" aria-hidden="true" tabindex="-1"></a><span class="co"># Optimizar consultas en datos temporales</span></span>
<span id="cb16-591"><a href="#cb16-591" aria-hidden="true" tabindex="-1"></a>dt_temporal <span class="ot">&lt;-</span> <span class="fu">copy</span>(temporal_dataset[<span class="fu">sample</span>(.N, <span class="dv">50000</span>)])</span>
<span id="cb16-592"><a href="#cb16-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-593"><a href="#cb16-593" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== OPTIMIZACIÓN DE CONSULTAS TEMPORALES ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-594"><a href="#cb16-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-595"><a href="#cb16-595" aria-hidden="true" tabindex="-1"></a><span class="co"># Consulta 1: Rango de fechas sin optimizar</span></span>
<span id="cb16-596"><a href="#cb16-596" aria-hidden="true" tabindex="-1"></a>tiempo_temporal_sin_key <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb16-597"><a href="#cb16-597" aria-hidden="true" tabindex="-1"></a>  result_no_key <span class="ot">&lt;-</span> dt_temporal[timestamp <span class="sc">&gt;=</span> <span class="fu">as.POSIXct</span>(<span class="st">"2024-06-01"</span>) <span class="sc">&amp;</span> </span>
<span id="cb16-598"><a href="#cb16-598" aria-hidden="true" tabindex="-1"></a>                              timestamp <span class="sc">&lt;</span> <span class="fu">as.POSIXct</span>(<span class="st">"2024-07-01"</span>)]</span>
<span id="cb16-599"><a href="#cb16-599" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb16-600"><a href="#cb16-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-601"><a href="#cb16-601" aria-hidden="true" tabindex="-1"></a><span class="co"># Consulta 2: Con key temporal</span></span>
<span id="cb16-602"><a href="#cb16-602" aria-hidden="true" tabindex="-1"></a>dt_temporal_keyed <span class="ot">&lt;-</span> <span class="fu">copy</span>(dt_temporal)</span>
<span id="cb16-603"><a href="#cb16-603" aria-hidden="true" tabindex="-1"></a><span class="fu">setkey</span>(dt_temporal_keyed, timestamp)</span>
<span id="cb16-604"><a href="#cb16-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-605"><a href="#cb16-605" aria-hidden="true" tabindex="-1"></a>tiempo_temporal_con_key <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb16-606"><a href="#cb16-606" aria-hidden="true" tabindex="-1"></a>  inicio <span class="ot">&lt;-</span> <span class="fu">as.POSIXct</span>(<span class="st">"2024-06-01"</span>)</span>
<span id="cb16-607"><a href="#cb16-607" aria-hidden="true" tabindex="-1"></a>  fin <span class="ot">&lt;-</span> <span class="fu">as.POSIXct</span>(<span class="st">"2024-07-01"</span>)</span>
<span id="cb16-608"><a href="#cb16-608" aria-hidden="true" tabindex="-1"></a>  result_with_key <span class="ot">&lt;-</span> dt_temporal_keyed[timestamp <span class="sc">%between%</span> <span class="fu">c</span>(inicio, fin)]</span>
<span id="cb16-609"><a href="#cb16-609" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb16-610"><a href="#cb16-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-611"><a href="#cb16-611" aria-hidden="true" tabindex="-1"></a><span class="co"># Consulta 3: Con rolling joins (para datos temporales complejos)</span></span>
<span id="cb16-612"><a href="#cb16-612" aria-hidden="true" tabindex="-1"></a><span class="co"># Simular eventos de referencia</span></span>
<span id="cb16-613"><a href="#cb16-613" aria-hidden="true" tabindex="-1"></a>eventos_ref <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb16-614"><a href="#cb16-614" aria-hidden="true" tabindex="-1"></a>  <span class="at">event_time =</span> <span class="fu">seq</span>(<span class="fu">as.POSIXct</span>(<span class="st">"2024-06-01"</span>), <span class="fu">as.POSIXct</span>(<span class="st">"2024-06-30"</span>), <span class="at">by =</span> <span class="st">"day"</span>),</span>
<span id="cb16-615"><a href="#cb16-615" aria-hidden="true" tabindex="-1"></a>  <span class="at">event_type =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>), <span class="dv">30</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-616"><a href="#cb16-616" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-617"><a href="#cb16-617" aria-hidden="true" tabindex="-1"></a><span class="fu">setkey</span>(eventos_ref, event_time)</span>
<span id="cb16-618"><a href="#cb16-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-619"><a href="#cb16-619" aria-hidden="true" tabindex="-1"></a>tiempo_rolling_join <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb16-620"><a href="#cb16-620" aria-hidden="true" tabindex="-1"></a>  result_rolling <span class="ot">&lt;-</span> dt_temporal_keyed[eventos_ref, roll <span class="ot">=</span> <span class="cn">TRUE</span>]</span>
<span id="cb16-621"><a href="#cb16-621" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb16-622"><a href="#cb16-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-623"><a href="#cb16-623" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Resultados de consultas temporales:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-624"><a href="#cb16-624" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"• Sin key:"</span>, <span class="fu">round</span>(tiempo_temporal_sin_key[<span class="dv">3</span>], <span class="dv">4</span>), <span class="st">"segundos,"</span>, <span class="fu">nrow</span>(result_no_key), <span class="st">"filas</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-625"><a href="#cb16-625" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"• Con key:"</span>, <span class="fu">round</span>(tiempo_temporal_con_key[<span class="dv">3</span>], <span class="dv">4</span>), <span class="st">"segundos,"</span>, <span class="fu">nrow</span>(result_with_key), <span class="st">"filas</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-626"><a href="#cb16-626" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"• Rolling join:"</span>, <span class="fu">round</span>(tiempo_rolling_join[<span class="dv">3</span>], <span class="dv">4</span>), <span class="st">"segundos,"</span>, <span class="fu">nrow</span>(result_rolling), <span class="st">"filas</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-627"><a href="#cb16-627" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-628"><a href="#cb16-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-629"><a href="#cb16-629" aria-hidden="true" tabindex="-1"></a><span class="fu">## Casos de Uso de Optimización Extrema</span></span>
<span id="cb16-630"><a href="#cb16-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-631"><a href="#cb16-631" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1. **Pipeline de Análisis de Alto Rendimiento**</span></span>
<span id="cb16-632"><a href="#cb16-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-635"><a href="#cb16-635" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-636"><a href="#cb16-636" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: high-performance-pipeline</span></span>
<span id="cb16-637"><a href="#cb16-637" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb16-638"><a href="#cb16-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-639"><a href="#cb16-639" aria-hidden="true" tabindex="-1"></a><span class="co"># Pipeline optimizado para análisis complejo</span></span>
<span id="cb16-640"><a href="#cb16-640" aria-hidden="true" tabindex="-1"></a>create_optimized_pipeline <span class="ot">&lt;-</span> <span class="cf">function</span>(dt, <span class="at">sample_size =</span> <span class="dv">100000</span>) {</span>
<span id="cb16-641"><a href="#cb16-641" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"=== PIPELINE DE ALTO RENDIMIENTO ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-642"><a href="#cb16-642" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-643"><a href="#cb16-643" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Paso 1: Muestreo estratificado eficiente</span></span>
<span id="cb16-644"><a href="#cb16-644" aria-hidden="true" tabindex="-1"></a>  dt_sample <span class="ot">&lt;-</span> dt[, .SD[<span class="fu">sample</span>(<span class="fu">min</span>(.N, sample_size), sample_size)], by <span class="ot">=</span> region]</span>
<span id="cb16-645"><a href="#cb16-645" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-646"><a href="#cb16-646" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Paso 2: Establecer key óptima para operaciones posteriores</span></span>
<span id="cb16-647"><a href="#cb16-647" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setkey</span>(dt_sample, group_major, group_minor)</span>
<span id="cb16-648"><a href="#cb16-648" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-649"><a href="#cb16-649" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Paso 3: Cálculos intermedios optimizados (por referencia)</span></span>
<span id="cb16-650"><a href="#cb16-650" aria-hidden="true" tabindex="-1"></a>  dt_sample[, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb16-651"><a href="#cb16-651" aria-hidden="true" tabindex="-1"></a>    <span class="at">value_normalized =</span> <span class="fu">scale</span>(value_numeric)[,<span class="dv">1</span>],</span>
<span id="cb16-652"><a href="#cb16-652" aria-hidden="true" tabindex="-1"></a>    <span class="at">amount_log =</span> <span class="fu">log1p</span>(amount),  <span class="co"># log1p es más estable que log</span></span>
<span id="cb16-653"><a href="#cb16-653" aria-hidden="true" tabindex="-1"></a>    <span class="at">efficiency_ratio =</span> value_numeric <span class="sc">/</span> (amount <span class="sc">+</span> <span class="dv">1</span>),</span>
<span id="cb16-654"><a href="#cb16-654" aria-hidden="true" tabindex="-1"></a>    <span class="at">timestamp_hour =</span> <span class="fu">hour</span>(timestamp)</span>
<span id="cb16-655"><a href="#cb16-655" aria-hidden="true" tabindex="-1"></a>  )]</span>
<span id="cb16-656"><a href="#cb16-656" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-657"><a href="#cb16-657" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Paso 4: Agregaciones complejas usando .SD optimizado</span></span>
<span id="cb16-658"><a href="#cb16-658" aria-hidden="true" tabindex="-1"></a>  result_aggregated <span class="ot">&lt;-</span> dt_sample[, </span>
<span id="cb16-659"><a href="#cb16-659" aria-hidden="true" tabindex="-1"></a>    .(</span>
<span id="cb16-660"><a href="#cb16-660" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Estadísticas básicas</span></span>
<span id="cb16-661"><a href="#cb16-661" aria-hidden="true" tabindex="-1"></a>      <span class="at">count =</span> .N,</span>
<span id="cb16-662"><a href="#cb16-662" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_value =</span> <span class="fu">mean</span>(value_normalized, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb16-663"><a href="#cb16-663" aria-hidden="true" tabindex="-1"></a>      <span class="at">median_amount =</span> <span class="fu">median</span>(amount_log, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb16-664"><a href="#cb16-664" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb16-665"><a href="#cb16-665" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Estadísticas avanzadas</span></span>
<span id="cb16-666"><a href="#cb16-666" aria-hidden="true" tabindex="-1"></a>      <span class="at">p95_efficiency =</span> <span class="fu">quantile</span>(efficiency_ratio, <span class="fl">0.95</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb16-667"><a href="#cb16-667" aria-hidden="true" tabindex="-1"></a>      <span class="at">cv_value =</span> <span class="fu">sd</span>(value_normalized, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">abs</span>(<span class="fu">mean</span>(value_normalized, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb16-668"><a href="#cb16-668" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb16-669"><a href="#cb16-669" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Análisis temporal</span></span>
<span id="cb16-670"><a href="#cb16-670" aria-hidden="true" tabindex="-1"></a>      <span class="at">peak_hour =</span> timestamp_hour[<span class="fu">which.max</span>(value_numeric)],</span>
<span id="cb16-671"><a href="#cb16-671" aria-hidden="true" tabindex="-1"></a>      <span class="at">active_hours =</span> <span class="fu">uniqueN</span>(timestamp_hour),</span>
<span id="cb16-672"><a href="#cb16-672" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb16-673"><a href="#cb16-673" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Diversidad</span></span>
<span id="cb16-674"><a href="#cb16-674" aria-hidden="true" tabindex="-1"></a>      <span class="at">categories_used =</span> <span class="fu">uniqueN</span>(category),</span>
<span id="cb16-675"><a href="#cb16-675" aria-hidden="true" tabindex="-1"></a>      <span class="at">status_diversity =</span> <span class="fu">uniqueN</span>(status)</span>
<span id="cb16-676"><a href="#cb16-676" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb16-677"><a href="#cb16-677" aria-hidden="true" tabindex="-1"></a>    by <span class="ot">=</span> .(region, group_major),</span>
<span id="cb16-678"><a href="#cb16-678" aria-hidden="true" tabindex="-1"></a>    .SDcols <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"value_normalized"</span>, <span class="st">"amount_log"</span>, <span class="st">"efficiency_ratio"</span>, </span>
<span id="cb16-679"><a href="#cb16-679" aria-hidden="true" tabindex="-1"></a>                <span class="st">"timestamp_hour"</span>, <span class="st">"value_numeric"</span>, <span class="st">"category"</span>, <span class="st">"status"</span>)</span>
<span id="cb16-680"><a href="#cb16-680" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb16-681"><a href="#cb16-681" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-682"><a href="#cb16-682" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Paso 5: Post-procesamiento optimizado</span></span>
<span id="cb16-683"><a href="#cb16-683" aria-hidden="true" tabindex="-1"></a>  result_aggregated[, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb16-684"><a href="#cb16-684" aria-hidden="true" tabindex="-1"></a>    <span class="at">performance_score =</span> <span class="fu">round</span>((mean_value <span class="sc">+</span> p95_efficiency) <span class="sc">*</span> <span class="fu">log1p</span>(count), <span class="dv">2</span>),</span>
<span id="cb16-685"><a href="#cb16-685" aria-hidden="true" tabindex="-1"></a>    <span class="at">complexity_index =</span> categories_used <span class="sc">*</span> status_diversity <span class="sc">*</span> active_hours</span>
<span id="cb16-686"><a href="#cb16-686" aria-hidden="true" tabindex="-1"></a>  )]</span>
<span id="cb16-687"><a href="#cb16-687" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-688"><a href="#cb16-688" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Paso 6: Ranking y clasificación final</span></span>
<span id="cb16-689"><a href="#cb16-689" aria-hidden="true" tabindex="-1"></a>  result_aggregated[, rank_performance <span class="sc">:</span><span class="er">=</span> <span class="fu">frank</span>(<span class="sc">-</span>performance_score), by <span class="ot">=</span> region]</span>
<span id="cb16-690"><a href="#cb16-690" aria-hidden="true" tabindex="-1"></a>  result_aggregated[, tier <span class="sc">:</span><span class="er">=</span> <span class="fu">fcase</span>(</span>
<span id="cb16-691"><a href="#cb16-691" aria-hidden="true" tabindex="-1"></a>    rank_performance <span class="sc">&lt;=</span> <span class="dv">3</span>, <span class="st">"Tier_1"</span>,</span>
<span id="cb16-692"><a href="#cb16-692" aria-hidden="true" tabindex="-1"></a>    rank_performance <span class="sc">&lt;=</span> <span class="dv">10</span>, <span class="st">"Tier_2"</span>, </span>
<span id="cb16-693"><a href="#cb16-693" aria-hidden="true" tabindex="-1"></a>    rank_performance <span class="sc">&lt;=</span> <span class="dv">20</span>, <span class="st">"Tier_3"</span>,</span>
<span id="cb16-694"><a href="#cb16-694" aria-hidden="true" tabindex="-1"></a>    <span class="at">default =</span> <span class="st">"Tier_4"</span></span>
<span id="cb16-695"><a href="#cb16-695" aria-hidden="true" tabindex="-1"></a>  )]</span>
<span id="cb16-696"><a href="#cb16-696" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-697"><a href="#cb16-697" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result_aggregated[<span class="fu">order</span>(<span class="sc">-</span>performance_score)])</span>
<span id="cb16-698"><a href="#cb16-698" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-699"><a href="#cb16-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-700"><a href="#cb16-700" aria-hidden="true" tabindex="-1"></a><span class="co"># Ejecutar pipeline optimizado</span></span>
<span id="cb16-701"><a href="#cb16-701" aria-hidden="true" tabindex="-1"></a>tiempo_pipeline <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb16-702"><a href="#cb16-702" aria-hidden="true" tabindex="-1"></a>  resultado_pipeline <span class="ot">&lt;-</span> <span class="fu">create_optimized_pipeline</span>(big_dataset, <span class="dv">80000</span>)</span>
<span id="cb16-703"><a href="#cb16-703" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb16-704"><a href="#cb16-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-705"><a href="#cb16-705" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Tiempo total del pipeline:"</span>, <span class="fu">round</span>(tiempo_pipeline[<span class="dv">3</span>], <span class="dv">3</span>), <span class="st">"segundos</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-706"><a href="#cb16-706" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Registros procesados: ~80,000 → "</span>, <span class="fu">nrow</span>(resultado_pipeline), <span class="st">"grupos finales</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-707"><a href="#cb16-707" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Reducción de datos:"</span>, <span class="fu">round</span>((<span class="dv">1</span> <span class="sc">-</span> <span class="fu">nrow</span>(resultado_pipeline)<span class="sc">/</span><span class="dv">80000</span>) <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb16-708"><a href="#cb16-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-709"><a href="#cb16-709" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Top 10 grupos por performance:"</span>)</span>
<span id="cb16-710"><a href="#cb16-710" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(resultado_pipeline[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, .(region, group_major, count, performance_score, tier)])</span>
<span id="cb16-711"><a href="#cb16-711" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-712"><a href="#cb16-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-713"><a href="#cb16-713" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2. **Sistema de Monitoreo de Performance en Tiempo Real**</span></span>
<span id="cb16-714"><a href="#cb16-714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-717"><a href="#cb16-717" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-718"><a href="#cb16-718" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: real-time-performance-monitoring</span></span>
<span id="cb16-719"><a href="#cb16-719" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb16-720"><a href="#cb16-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-721"><a href="#cb16-721" aria-hidden="true" tabindex="-1"></a><span class="co"># Sistema para monitorear performance de operaciones data.table</span></span>
<span id="cb16-722"><a href="#cb16-722" aria-hidden="true" tabindex="-1"></a>performance_monitor <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb16-723"><a href="#cb16-723" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Crear registro de operaciones</span></span>
<span id="cb16-724"><a href="#cb16-724" aria-hidden="true" tabindex="-1"></a>  operations_log <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb16-725"><a href="#cb16-725" aria-hidden="true" tabindex="-1"></a>    <span class="at">operation_id =</span> <span class="fu">character</span>(),</span>
<span id="cb16-726"><a href="#cb16-726" aria-hidden="true" tabindex="-1"></a>    <span class="at">operation_type =</span> <span class="fu">character</span>(),</span>
<span id="cb16-727"><a href="#cb16-727" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset_size =</span> <span class="fu">integer</span>(),</span>
<span id="cb16-728"><a href="#cb16-728" aria-hidden="true" tabindex="-1"></a>    <span class="at">execution_time =</span> <span class="fu">numeric</span>(),</span>
<span id="cb16-729"><a href="#cb16-729" aria-hidden="true" tabindex="-1"></a>    <span class="at">memory_used =</span> <span class="fu">numeric</span>(),</span>
<span id="cb16-730"><a href="#cb16-730" aria-hidden="true" tabindex="-1"></a>    <span class="at">threads_used =</span> <span class="fu">integer</span>(),</span>
<span id="cb16-731"><a href="#cb16-731" aria-hidden="true" tabindex="-1"></a>    <span class="at">timestamp =</span> <span class="fu">.POSIXct</span>(<span class="fu">numeric</span>())</span>
<span id="cb16-732"><a href="#cb16-732" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-733"><a href="#cb16-733" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-734"><a href="#cb16-734" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Función para registrar operación</span></span>
<span id="cb16-735"><a href="#cb16-735" aria-hidden="true" tabindex="-1"></a>  log_operation <span class="ot">&lt;-</span> <span class="cf">function</span>(op_type, dt_size, exec_time, mem_usage) {</span>
<span id="cb16-736"><a href="#cb16-736" aria-hidden="true" tabindex="-1"></a>    new_entry <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb16-737"><a href="#cb16-737" aria-hidden="true" tabindex="-1"></a>      <span class="at">operation_id =</span> <span class="fu">paste0</span>(op_type, <span class="st">"_"</span>, <span class="fu">format</span>(<span class="fu">Sys.time</span>(), <span class="st">"%H%M%S"</span>)),</span>
<span id="cb16-738"><a href="#cb16-738" aria-hidden="true" tabindex="-1"></a>      <span class="at">operation_type =</span> op_type,</span>
<span id="cb16-739"><a href="#cb16-739" aria-hidden="true" tabindex="-1"></a>      <span class="at">dataset_size =</span> dt_size,</span>
<span id="cb16-740"><a href="#cb16-740" aria-hidden="true" tabindex="-1"></a>      <span class="at">execution_time =</span> exec_time,</span>
<span id="cb16-741"><a href="#cb16-741" aria-hidden="true" tabindex="-1"></a>      <span class="at">memory_used =</span> mem_usage,</span>
<span id="cb16-742"><a href="#cb16-742" aria-hidden="true" tabindex="-1"></a>      <span class="at">threads_used =</span> <span class="fu">getDTthreads</span>(),</span>
<span id="cb16-743"><a href="#cb16-743" aria-hidden="true" tabindex="-1"></a>      <span class="at">timestamp =</span> <span class="fu">Sys.time</span>()</span>
<span id="cb16-744"><a href="#cb16-744" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-745"><a href="#cb16-745" aria-hidden="true" tabindex="-1"></a>    operations_log <span class="ot">&lt;&lt;-</span> <span class="fu">rbindlist</span>(<span class="fu">list</span>(operations_log, new_entry), <span class="at">use.names =</span> <span class="cn">TRUE</span>, <span class="at">fill =</span> <span class="cn">TRUE</span>, <span class="at">ignore.attr =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-746"><a href="#cb16-746" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-747"><a href="#cb16-747" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-748"><a href="#cb16-748" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Función para analizar performance</span></span>
<span id="cb16-749"><a href="#cb16-749" aria-hidden="true" tabindex="-1"></a>  analyze_performance <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb16-750"><a href="#cb16-750" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">nrow</span>(operations_log) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb16-751"><a href="#cb16-751" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"No hay operaciones registradas</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-752"><a href="#cb16-752" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb16-753"><a href="#cb16-753" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb16-754"><a href="#cb16-754" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-755"><a href="#cb16-755" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Análisis por tipo de operación</span></span>
<span id="cb16-756"><a href="#cb16-756" aria-hidden="true" tabindex="-1"></a>    performance_summary <span class="ot">&lt;-</span> operations_log[, .(</span>
<span id="cb16-757"><a href="#cb16-757" aria-hidden="true" tabindex="-1"></a>      <span class="at">operations_count =</span> .N,</span>
<span id="cb16-758"><a href="#cb16-758" aria-hidden="true" tabindex="-1"></a>      <span class="at">avg_time =</span> <span class="fu">round</span>(<span class="fu">mean</span>(execution_time), <span class="dv">4</span>),</span>
<span id="cb16-759"><a href="#cb16-759" aria-hidden="true" tabindex="-1"></a>      <span class="at">median_time =</span> <span class="fu">round</span>(<span class="fu">median</span>(execution_time), <span class="dv">4</span>),</span>
<span id="cb16-760"><a href="#cb16-760" aria-hidden="true" tabindex="-1"></a>      <span class="at">max_time =</span> <span class="fu">round</span>(<span class="fu">max</span>(execution_time), <span class="dv">4</span>),</span>
<span id="cb16-761"><a href="#cb16-761" aria-hidden="true" tabindex="-1"></a>      <span class="at">avg_memory =</span> <span class="fu">round</span>(<span class="fu">mean</span>(memory_used), <span class="dv">0</span>),</span>
<span id="cb16-762"><a href="#cb16-762" aria-hidden="true" tabindex="-1"></a>      <span class="at">throughput_rows_per_sec =</span> <span class="fu">round</span>(<span class="fu">mean</span>(dataset_size <span class="sc">/</span> execution_time), <span class="dv">0</span>)</span>
<span id="cb16-763"><a href="#cb16-763" aria-hidden="true" tabindex="-1"></a>    ), by <span class="ot">=</span> operation_type]</span>
<span id="cb16-764"><a href="#cb16-764" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-765"><a href="#cb16-765" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(performance_summary)</span>
<span id="cb16-766"><a href="#cb16-766" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-767"><a href="#cb16-767" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-768"><a href="#cb16-768" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">log =</span> log_operation, <span class="at">analyze =</span> analyze_performance, <span class="at">get_log =</span> <span class="cf">function</span>() operations_log))</span>
<span id="cb16-769"><a href="#cb16-769" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-770"><a href="#cb16-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-771"><a href="#cb16-771" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicializar sistema de monitoreo</span></span>
<span id="cb16-772"><a href="#cb16-772" aria-hidden="true" tabindex="-1"></a>monitor <span class="ot">&lt;-</span> <span class="fu">performance_monitor</span>()</span>
<span id="cb16-773"><a href="#cb16-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-774"><a href="#cb16-774" aria-hidden="true" tabindex="-1"></a><span class="co"># Simular diferentes operaciones y monitorearlas</span></span>
<span id="cb16-775"><a href="#cb16-775" aria-hidden="true" tabindex="-1"></a>dt_test <span class="ot">&lt;-</span> big_dataset[<span class="fu">sample</span>(.N, <span class="dv">50000</span>)]</span>
<span id="cb16-776"><a href="#cb16-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-777"><a href="#cb16-777" aria-hidden="true" tabindex="-1"></a><span class="co"># Operación 1: Agregación</span></span>
<span id="cb16-778"><a href="#cb16-778" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Monitoreando operaciones:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-779"><a href="#cb16-779" aria-hidden="true" tabindex="-1"></a>tiempo_agg <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb16-780"><a href="#cb16-780" aria-hidden="true" tabindex="-1"></a>  result_agg <span class="ot">&lt;-</span> dt_test[, .(<span class="at">mean_val =</span> <span class="fu">mean</span>(value_numeric)), by <span class="ot">=</span> group_major]</span>
<span id="cb16-781"><a href="#cb16-781" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb16-782"><a href="#cb16-782" aria-hidden="true" tabindex="-1"></a>monitor<span class="sc">$</span><span class="fu">log</span>(<span class="st">"aggregation"</span>, <span class="fu">nrow</span>(dt_test), tiempo_agg[<span class="dv">3</span>], <span class="fu">object.size</span>(result_agg))</span>
<span id="cb16-783"><a href="#cb16-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-784"><a href="#cb16-784" aria-hidden="true" tabindex="-1"></a><span class="co"># Operación 2: Join</span></span>
<span id="cb16-785"><a href="#cb16-785" aria-hidden="true" tabindex="-1"></a>tiempo_join <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb16-786"><a href="#cb16-786" aria-hidden="true" tabindex="-1"></a>  result_join <span class="ot">&lt;-</span> dt_test[lookup_data[<span class="dv">1</span><span class="sc">:</span><span class="dv">10000</span>], on <span class="ot">=</span> .(id)]</span>
<span id="cb16-787"><a href="#cb16-787" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb16-788"><a href="#cb16-788" aria-hidden="true" tabindex="-1"></a>monitor<span class="sc">$</span><span class="fu">log</span>(<span class="st">"join"</span>, <span class="fu">nrow</span>(dt_test), tiempo_join[<span class="dv">3</span>], <span class="fu">object.size</span>(result_join))</span>
<span id="cb16-789"><a href="#cb16-789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-790"><a href="#cb16-790" aria-hidden="true" tabindex="-1"></a><span class="co"># Operación 3: Sort</span></span>
<span id="cb16-791"><a href="#cb16-791" aria-hidden="true" tabindex="-1"></a>tiempo_sort <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb16-792"><a href="#cb16-792" aria-hidden="true" tabindex="-1"></a>  result_sort <span class="ot">&lt;-</span> dt_test[<span class="fu">order</span>(<span class="sc">-</span>value_numeric)]</span>
<span id="cb16-793"><a href="#cb16-793" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb16-794"><a href="#cb16-794" aria-hidden="true" tabindex="-1"></a>monitor<span class="sc">$</span><span class="fu">log</span>(<span class="st">"sort"</span>, <span class="fu">nrow</span>(dt_test), tiempo_sort[<span class="dv">3</span>], <span class="fu">object.size</span>(result_sort))</span>
<span id="cb16-795"><a href="#cb16-795" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-796"><a href="#cb16-796" aria-hidden="true" tabindex="-1"></a><span class="co"># Análisis de performance</span></span>
<span id="cb16-797"><a href="#cb16-797" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== ANÁLISIS DE PERFORMANCE ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-798"><a href="#cb16-798" aria-hidden="true" tabindex="-1"></a>performance_analysis <span class="ot">&lt;-</span> monitor<span class="sc">$</span><span class="fu">analyze</span>()</span>
<span id="cb16-799"><a href="#cb16-799" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(performance_analysis)</span>
<span id="cb16-800"><a href="#cb16-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-801"><a href="#cb16-801" aria-hidden="true" tabindex="-1"></a><span class="co"># Identificar operaciones problemáticas</span></span>
<span id="cb16-802"><a href="#cb16-802" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(performance_analysis)) {</span>
<span id="cb16-803"><a href="#cb16-803" aria-hidden="true" tabindex="-1"></a>  problematic_ops <span class="ot">&lt;-</span> performance_analysis[avg_time <span class="sc">&gt;</span> <span class="fu">median</span>(avg_time) <span class="sc">*</span> <span class="dv">2</span>]</span>
<span id="cb16-804"><a href="#cb16-804" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(problematic_ops) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb16-805"><a href="#cb16-805" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">⚠️ Operaciones con performance subóptima:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-806"><a href="#cb16-806" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(problematic_ops)</span>
<span id="cb16-807"><a href="#cb16-807" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb16-808"><a href="#cb16-808" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">✅ Todas las operaciones tienen performance aceptable</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-809"><a href="#cb16-809" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-810"><a href="#cb16-810" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-811"><a href="#cb16-811" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-812"><a href="#cb16-812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-813"><a href="#cb16-813" aria-hidden="true" tabindex="-1"></a><span class="fu">## Ejercicio Práctico de Optimización</span></span>
<span id="cb16-814"><a href="#cb16-814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-815"><a href="#cb16-815" aria-hidden="true" tabindex="-1"></a>::: {.callout-note icon="false"}</span>
<span id="cb16-816"><a href="#cb16-816" aria-hidden="true" tabindex="-1"></a><span class="fu">## 🏋️ Ejercicio 15: Optimización Integral</span></span>
<span id="cb16-817"><a href="#cb16-817" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-818"><a href="#cb16-818" aria-hidden="true" tabindex="-1"></a>Dado el siguiente código ineficiente, optimízalo usando todas las técnicas aprendidas:</span>
<span id="cb16-819"><a href="#cb16-819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-820"><a href="#cb16-820" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb16-821"><a href="#cb16-821" aria-hidden="true" tabindex="-1"></a><span class="co"># Código INEFICIENTE para optimizar</span></span>
<span id="cb16-822"><a href="#cb16-822" aria-hidden="true" tabindex="-1"></a>analyze_data_slow <span class="ot">&lt;-</span> <span class="cf">function</span>(big_data, lookup) {</span>
<span id="cb16-823"><a href="#cb16-823" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">data.table</span>()</span>
<span id="cb16-824"><a href="#cb16-824" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-825"><a href="#cb16-825" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Procesar cada región por separado</span></span>
<span id="cb16-826"><a href="#cb16-826" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(region <span class="cf">in</span> <span class="fu">unique</span>(big_data<span class="sc">$</span>region)) {</span>
<span id="cb16-827"><a href="#cb16-827" aria-hidden="true" tabindex="-1"></a>    region_data <span class="ot">&lt;-</span> big_data[big_data<span class="sc">$</span>region <span class="sc">==</span> region, ]</span>
<span id="cb16-828"><a href="#cb16-828" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-829"><a href="#cb16-829" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Procesar cada grupo dentro de la región</span></span>
<span id="cb16-830"><a href="#cb16-830" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(group <span class="cf">in</span> <span class="fu">unique</span>(region_data<span class="sc">$</span>group_major)) {</span>
<span id="cb16-831"><a href="#cb16-831" aria-hidden="true" tabindex="-1"></a>      group_data <span class="ot">&lt;-</span> region_data[region_data<span class="sc">$</span>group_major <span class="sc">==</span> group, ]</span>
<span id="cb16-832"><a href="#cb16-832" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb16-833"><a href="#cb16-833" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Cálculos por grupo</span></span>
<span id="cb16-834"><a href="#cb16-834" aria-hidden="true" tabindex="-1"></a>      group_stats <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb16-835"><a href="#cb16-835" aria-hidden="true" tabindex="-1"></a>        <span class="at">region =</span> region,</span>
<span id="cb16-836"><a href="#cb16-836" aria-hidden="true" tabindex="-1"></a>        <span class="at">group =</span> group,</span>
<span id="cb16-837"><a href="#cb16-837" aria-hidden="true" tabindex="-1"></a>        <span class="at">count =</span> <span class="fu">nrow</span>(group_data),</span>
<span id="cb16-838"><a href="#cb16-838" aria-hidden="true" tabindex="-1"></a>        <span class="at">mean_value =</span> <span class="fu">mean</span>(group_data<span class="sc">$</span>value_numeric),</span>
<span id="cb16-839"><a href="#cb16-839" aria-hidden="true" tabindex="-1"></a>        <span class="at">sum_amount =</span> <span class="fu">sum</span>(group_data<span class="sc">$</span>amount)</span>
<span id="cb16-840"><a href="#cb16-840" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb16-841"><a href="#cb16-841" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb16-842"><a href="#cb16-842" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Join con lookup (ineficiente)</span></span>
<span id="cb16-843"><a href="#cb16-843" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(group_stats)) {</span>
<span id="cb16-844"><a href="#cb16-844" aria-hidden="true" tabindex="-1"></a>        matched_lookup <span class="ot">&lt;-</span> lookup[lookup<span class="sc">$</span>entity_type <span class="sc">==</span> <span class="st">"Premium"</span>, ]</span>
<span id="cb16-845"><a href="#cb16-845" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">nrow</span>(matched_lookup) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb16-846"><a href="#cb16-846" aria-hidden="true" tabindex="-1"></a>          group_stats<span class="sc">$</span>premium_factor[i] <span class="ot">&lt;-</span> <span class="fu">mean</span>(matched_lookup<span class="sc">$</span>weight_factor)</span>
<span id="cb16-847"><a href="#cb16-847" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb16-848"><a href="#cb16-848" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb16-849"><a href="#cb16-849" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb16-850"><a href="#cb16-850" aria-hidden="true" tabindex="-1"></a>      results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, group_stats)</span>
<span id="cb16-851"><a href="#cb16-851" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb16-852"><a href="#cb16-852" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-853"><a href="#cb16-853" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-854"><a href="#cb16-854" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results)</span>
<span id="cb16-855"><a href="#cb16-855" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-856"><a href="#cb16-856" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-857"><a href="#cb16-857" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-858"><a href="#cb16-858" aria-hidden="true" tabindex="-1"></a>Optimízalo para:</span>
<span id="cb16-859"><a href="#cb16-859" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Eliminar todos los bucles</span>
<span id="cb16-860"><a href="#cb16-860" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Usar operaciones vectorizadas</span>
<span id="cb16-861"><a href="#cb16-861" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Implementar joins eficientes</span>
<span id="cb16-862"><a href="#cb16-862" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Minimizar copias de memoria</span>
<span id="cb16-863"><a href="#cb16-863" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb16-864"><a href="#cb16-864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-865"><a href="#cb16-865" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip collapse="true"}</span>
<span id="cb16-866"><a href="#cb16-866" aria-hidden="true" tabindex="-1"></a><span class="fu">## 💡 Solución del Ejercicio 15</span></span>
<span id="cb16-867"><a href="#cb16-867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-870"><a href="#cb16-870" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb16-871"><a href="#cb16-871" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: solucion-ejercicio-15</span></span>
<span id="cb16-872"><a href="#cb16-872" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb16-873"><a href="#cb16-873" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-874"><a href="#cb16-874" aria-hidden="true" tabindex="-1"></a><span class="co"># Versión OPTIMIZADA</span></span>
<span id="cb16-875"><a href="#cb16-875" aria-hidden="true" tabindex="-1"></a>analyze_data_fast <span class="ot">&lt;-</span> <span class="cf">function</span>(big_data, lookup) {</span>
<span id="cb16-876"><a href="#cb16-876" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-877"><a href="#cb16-877" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Pre-calcular el premium_factor una sola vez</span></span>
<span id="cb16-878"><a href="#cb16-878" aria-hidden="true" tabindex="-1"></a>  premium_factor <span class="ot">&lt;-</span> lookup[entity_type <span class="sc">==</span> <span class="st">"Premium"</span>, <span class="fu">mean</span>(weight_factor)]</span>
<span id="cb16-879"><a href="#cb16-879" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-880"><a href="#cb16-880" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Una sola operación vectorizada que reemplaza todos los bucles</span></span>
<span id="cb16-881"><a href="#cb16-881" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> big_data[, .(</span>
<span id="cb16-882"><a href="#cb16-882" aria-hidden="true" tabindex="-1"></a>    <span class="at">count =</span> .N,</span>
<span id="cb16-883"><a href="#cb16-883" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_value =</span> <span class="fu">mean</span>(value_numeric),</span>
<span id="cb16-884"><a href="#cb16-884" aria-hidden="true" tabindex="-1"></a>    <span class="at">sum_amount =</span> <span class="fu">sum</span>(amount),</span>
<span id="cb16-885"><a href="#cb16-885" aria-hidden="true" tabindex="-1"></a>    <span class="at">premium_factor =</span> premium_factor  <span class="co"># Usar valor pre-calculado</span></span>
<span id="cb16-886"><a href="#cb16-886" aria-hidden="true" tabindex="-1"></a>  ), by <span class="ot">=</span> .(region, <span class="at">group =</span> group_major)]</span>
<span id="cb16-887"><a href="#cb16-887" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-888"><a href="#cb16-888" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb16-889"><a href="#cb16-889" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-890"><a href="#cb16-890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-891"><a href="#cb16-891" aria-hidden="true" tabindex="-1"></a><span class="co"># Comparar performance</span></span>
<span id="cb16-892"><a href="#cb16-892" aria-hidden="true" tabindex="-1"></a>dt_test_large <span class="ot">&lt;-</span> big_dataset[<span class="fu">sample</span>(.N, <span class="dv">20000</span>)]  <span class="co"># Dataset más pequeño para el test</span></span>
<span id="cb16-893"><a href="#cb16-893" aria-hidden="true" tabindex="-1"></a>lookup_test <span class="ot">&lt;-</span> lookup_data[<span class="fu">sample</span>(.N, <span class="dv">5000</span>)]</span>
<span id="cb16-894"><a href="#cb16-894" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-895"><a href="#cb16-895" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== COMPARACIÓN DE PERFORMANCE ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-896"><a href="#cb16-896" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-897"><a href="#cb16-897" aria-hidden="true" tabindex="-1"></a><span class="co"># Versión lenta (simulada de forma más rápida para el ejemplo)</span></span>
<span id="cb16-898"><a href="#cb16-898" aria-hidden="true" tabindex="-1"></a>tiempo_lento <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb16-899"><a href="#cb16-899" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Simulamos la lógica ineficiente pero sin bucles extremos</span></span>
<span id="cb16-900"><a href="#cb16-900" aria-hidden="true" tabindex="-1"></a>  result_slow <span class="ot">&lt;-</span> dt_test_large[, {</span>
<span id="cb16-901"><a href="#cb16-901" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Múltiples operaciones separadas (ineficiente)</span></span>
<span id="cb16-902"><a href="#cb16-902" aria-hidden="true" tabindex="-1"></a>    temp_results <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb16-903"><a href="#cb16-903" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(<span class="fu">unique</span>(group_major))) {</span>
<span id="cb16-904"><a href="#cb16-904" aria-hidden="true" tabindex="-1"></a>      group_val <span class="ot">&lt;-</span> <span class="fu">unique</span>(group_major)[i]</span>
<span id="cb16-905"><a href="#cb16-905" aria-hidden="true" tabindex="-1"></a>      group_subset <span class="ot">&lt;-</span> .SD[group_major <span class="sc">==</span> group_val]</span>
<span id="cb16-906"><a href="#cb16-906" aria-hidden="true" tabindex="-1"></a>      temp_results[[i]] <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb16-907"><a href="#cb16-907" aria-hidden="true" tabindex="-1"></a>        <span class="at">region =</span> <span class="fu">unique</span>(region),</span>
<span id="cb16-908"><a href="#cb16-908" aria-hidden="true" tabindex="-1"></a>        <span class="at">group =</span> group_val,</span>
<span id="cb16-909"><a href="#cb16-909" aria-hidden="true" tabindex="-1"></a>        <span class="at">count =</span> <span class="fu">nrow</span>(group_subset),</span>
<span id="cb16-910"><a href="#cb16-910" aria-hidden="true" tabindex="-1"></a>        <span class="at">mean_value =</span> <span class="fu">mean</span>(group_subset<span class="sc">$</span>value_numeric),</span>
<span id="cb16-911"><a href="#cb16-911" aria-hidden="true" tabindex="-1"></a>        <span class="at">sum_amount =</span> <span class="fu">sum</span>(group_subset<span class="sc">$</span>amount),</span>
<span id="cb16-912"><a href="#cb16-912" aria-hidden="true" tabindex="-1"></a>        <span class="at">premium_factor =</span> lookup_test[entity_type <span class="sc">==</span> <span class="st">"Premium"</span>, <span class="fu">mean</span>(weight_factor)]</span>
<span id="cb16-913"><a href="#cb16-913" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb16-914"><a href="#cb16-914" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb16-915"><a href="#cb16-915" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rbindlist</span>(temp_results)</span>
<span id="cb16-916"><a href="#cb16-916" aria-hidden="true" tabindex="-1"></a>  }, by <span class="ot">=</span> region]</span>
<span id="cb16-917"><a href="#cb16-917" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb16-918"><a href="#cb16-918" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-919"><a href="#cb16-919" aria-hidden="true" tabindex="-1"></a><span class="co"># Versión optimizada</span></span>
<span id="cb16-920"><a href="#cb16-920" aria-hidden="true" tabindex="-1"></a>tiempo_rapido <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb16-921"><a href="#cb16-921" aria-hidden="true" tabindex="-1"></a>  result_fast <span class="ot">&lt;-</span> <span class="fu">analyze_data_fast</span>(dt_test_large, lookup_test)</span>
<span id="cb16-922"><a href="#cb16-922" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb16-923"><a href="#cb16-923" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-924"><a href="#cb16-924" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Método ineficiente (simulado):"</span>, <span class="fu">round</span>(tiempo_lento[<span class="dv">3</span>], <span class="dv">4</span>), <span class="st">"segundos</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-925"><a href="#cb16-925" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Método optimizado:"</span>, <span class="fu">round</span>(tiempo_rapido[<span class="dv">3</span>], <span class="dv">4</span>), <span class="st">"segundos</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-926"><a href="#cb16-926" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Mejora de velocidad:"</span>, <span class="fu">round</span>(tiempo_lento[<span class="dv">3</span>] <span class="sc">/</span> tiempo_rapido[<span class="dv">3</span>], <span class="dv">1</span>), <span class="st">"x más rápido</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-927"><a href="#cb16-927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-928"><a href="#cb16-928" aria-hidden="true" tabindex="-1"></a><span class="co"># Verificar resultados equivalentes</span></span>
<span id="cb16-929"><a href="#cb16-929" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Resultados similares:"</span>, </span>
<span id="cb16-930"><a href="#cb16-930" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nrow</span>(result_slow) <span class="sc">==</span> <span class="fu">nrow</span>(result_fast), </span>
<span id="cb16-931"><a href="#cb16-931" aria-hidden="true" tabindex="-1"></a>    <span class="fu">all.equal</span>(result_slow<span class="sc">$</span>count, result_fast<span class="sc">$</span>count), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-932"><a href="#cb16-932" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-933"><a href="#cb16-933" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Primeras filas del resultado optimizado:"</span>)</span>
<span id="cb16-934"><a href="#cb16-934" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(result_fast))</span>
<span id="cb16-935"><a href="#cb16-935" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-936"><a href="#cb16-936" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== TÉCNICAS DE OPTIMIZACIÓN APLICADAS ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-937"><a href="#cb16-937" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"1. ✅ Eliminación completa de bucles for</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-938"><a href="#cb16-938" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"2. ✅ Una sola operación by= vectorizada</span><span class="sc">\n</span><span class="st">"</span>) </span>
<span id="cb16-939"><a href="#cb16-939" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"3. ✅ Pre-cálculo de valores constantes</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-940"><a href="#cb16-940" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"4. ✅ Eliminación de rbind repetitivo</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-941"><a href="#cb16-941" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"5. ✅ Sintaxis data.table pura (sin data.frame)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-942"><a href="#cb16-942" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"6. ✅ Operaciones vectorizadas nativas</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-943"><a href="#cb16-943" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"7. ✅ Mínimo uso de memoria</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-944"><a href="#cb16-944" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-945"><a href="#cb16-945" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb16-946"><a href="#cb16-946" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-947"><a href="#cb16-947" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb16-948"><a href="#cb16-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-949"><a href="#cb16-949" aria-hidden="true" tabindex="-1"></a>::: {.callout-important}</span>
<span id="cb16-950"><a href="#cb16-950" aria-hidden="true" tabindex="-1"></a><span class="fu">## 🎯 Puntos Clave de Este Capítulo</span></span>
<span id="cb16-951"><a href="#cb16-951" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-952"><a href="#cb16-952" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Threading automático** puede acelerar operaciones 2-10x en sistemas multi-core</span>
<span id="cb16-953"><a href="#cb16-953" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**setkey()** es esencial para datasets &gt;100K filas con consultas repetitivas</span>
<span id="cb16-954"><a href="#cb16-954" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Índices secundarios** con setindex() permiten múltiples patrones de consulta eficientes</span>
<span id="cb16-955"><a href="#cb16-955" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Benchmarking sistemático** revela cuellos de botella reales vs percibidos</span>
<span id="cb16-956"><a href="#cb16-956" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Una operación data.table vectorizada** puede reemplazar docenas de bucles</span>
<span id="cb16-957"><a href="#cb16-957" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>**Profiling de memoria** es crucial para datasets que se acercan a los límites de RAM</span>
<span id="cb16-958"><a href="#cb16-958" aria-hidden="true" tabindex="-1"></a><span class="ss">7. </span>**La optimización correcta** puede resultar en mejoras de 10-100x en casos extremos</span>
<span id="cb16-959"><a href="#cb16-959" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb16-960"><a href="#cb16-960" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-961"><a href="#cb16-961" aria-hidden="true" tabindex="-1"></a>El dominio de estas técnicas de optimización te permite trabajar con datasets que de otra manera serían imposibles de procesar eficientemente. En el próximo capítulo exploraremos las mejores prácticas y patrones que complementan estas optimizaciones.</span>
<span id="cb16-962"><a href="#cb16-962" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-963"><a href="#cb16-963" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">function_calls</span><span class="dt">&gt;</span></span>
<span id="cb16-964"><a href="#cb16-964" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">invoke</span><span class="ot"> name</span><span class="op">=</span><span class="st">"TodoWrite"</span><span class="dt">&gt;</span></span>
<span id="cb16-965"><a href="#cb16-965" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">parameter</span><span class="ot"> name</span><span class="op">=</span><span class="st">"todos"</span><span class="dt">&gt;</span><span class="co">[</span><span class="ot">{"content": "Reorganizar M\u00f3dulo 1: dividir fundamentos en sintaxis y s\u00edmbolos", "status": "completed", "id": "1"}, {"content": "Crear cap01-simbolos.qmd para s\u00edmbolos especiales del M\u00f3dulo 1", "status": "completed", "id": "1-new"}, {"content": "Reorganizar M\u00f3dulo 2: dividir en encadenamiento y joins", "status": "completed", "id": "2"}, {"content": "Crear cap03-joins-avanzados.qmd para joins avanzados del M\u00f3dulo 3", "status": "completed", "id": "3-1"}, {"content": "Crear cap03-funciones-especiales.qmd para funciones especiales del M\u00f3dulo 3", "status": "completed", "id": "3-2"}, {"content": "Crear cap03-reshape.qmd para reshape del M\u00f3dulo 3", "status": "completed", "id": "3-3"}, {"content": "Crear cap04-performance.qmd para optimización de performance del M\u00f3dulo 4", "status": "completed", "id": "4-1"}, {"content": "Crear cap04-buenas-practicas.qmd para mejores pr\u00e1cticas del M\u00f3dulo 4", "status": "in_progress", "id": "4-2"}, {"content": "Reorganizar M\u00f3dulo 5: dividir en visualizaci\u00f3n y aplicaciones", "status": "pending", "id": "5"}</span><span class="co">]</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/tutorial-datatable/tutorial_data.table/issues" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer><script src="site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>