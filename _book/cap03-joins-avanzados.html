<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>6&nbsp; Joins Avanzados: Non-Equi y Rolling Joins – Domina data.table en R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./cap03-funciones-especiales.html" rel="next">
<link href="./cap02-joins.html" rel="prev">
<link href="./images/favicon.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-d14ef1f108961a0fb37502f1e6f08aaf.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-aecbfc4a73d8344c2d918b5cbe22c140.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><style>html{ scroll-behavior: smooth; }</style>
<link rel="stylesheet" href="styles.css">
</head>
<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./cap03-joins-avanzados.html"><strong>Módulo 3</strong>: Técnicas Avanzadas y Funciones Especiales</a></li><li class="breadcrumb-item"><a href="./cap03-joins-avanzados.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Joins Avanzados: Non-Equi y Rolling Joins</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      <img src="./logos\kinelytic-header-logo.svg" alt="Company name with logo" class="sidebar-logo py-0 d-lg-inline d-none"></a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Domina data.table en R</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/tutorial-datatable/tutorial_data.table" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Prefacio</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introducción a <code>data.table</code></span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text"><strong>Módulo 1</strong>: Fundamentos y Sintaxis Esencial</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap01-sintaxis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">La Sintaxis <code>DT[i, j, by]</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap01-simbolos.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Símbolos Especiales en <code>data.table</code></span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text"><strong>Módulo 2</strong>: Manipulación de Datos Intermedia</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap02-encadenamiento.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Encadenamiento de Operaciones (Chaining)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap02-joins.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Uniones de Datos (Joins)</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text"><strong>Módulo 3</strong>: Técnicas Avanzadas y Funciones Especiales</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap03-joins-avanzados.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Joins Avanzados: Non-Equi y Rolling Joins</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap03-funciones-especiales.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Funciones Especiales y Análisis Temporal</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap03-reshape.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Remodelación de Datos: <code>melt()</code> y <code>dcast()</code></span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text"><strong>Módulo 4</strong>: Optimización y Buenas Prácticas</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap04-performance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Optimización de Performance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap04-buenas-practicas.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Buenas Prácticas y Código Idiomático</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text"><strong>Módulo 5</strong>: Integración con el Ecosistema R</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap05-visualizacion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Visualización de Datos con data.table</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap05-aplicaciones.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Aplicaciones del Mundo Real</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./conclusion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Conclusiones y Próximos Pasos</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Referencias</span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="2"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#non-equi-joins-m%C3%A1s-all%C3%A1-de-la-igualdad" id="toc-non-equi-joins-más-allá-de-la-igualdad" class="nav-link active" data-scroll-target="#non-equi-joins-m%C3%A1s-all%C3%A1-de-la-igualdad"><span class="header-section-number">6.1</span> Non-Equi Joins: Más Allá de la Igualdad</a>
  <ul class="collapse">
<li><a href="#conceptos-fundamentales" id="toc-conceptos-fundamentales" class="nav-link" data-scroll-target="#conceptos-fundamentales"><span class="header-section-number">6.1.1</span> 1. <strong>Conceptos Fundamentales</strong></a></li>
  <li><a href="#non-equi-join-con-m%C3%BAltiples-condiciones" id="toc-non-equi-join-con-múltiples-condiciones" class="nav-link" data-scroll-target="#non-equi-join-con-m%C3%BAltiples-condiciones"><span class="header-section-number">6.1.2</span> 2. <strong>Non-Equi Join con Múltiples Condiciones</strong></a></li>
  <li><a href="#non-equi-join-para-ventanas-temporales" id="toc-non-equi-join-para-ventanas-temporales" class="nav-link" data-scroll-target="#non-equi-join-para-ventanas-temporales"><span class="header-section-number">6.1.3</span> 3. <strong>Non-Equi Join para Ventanas Temporales</strong></a></li>
  </ul>
</li>
  <li>
<a href="#rolling-joins-la-joya-para-series-temporales" id="toc-rolling-joins-la-joya-para-series-temporales" class="nav-link" data-scroll-target="#rolling-joins-la-joya-para-series-temporales"><span class="header-section-number">6.2</span> Rolling Joins: La Joya para Series Temporales</a>
  <ul class="collapse">
<li><a href="#rolling-join-b%C3%A1sico" id="toc-rolling-join-básico" class="nav-link" data-scroll-target="#rolling-join-b%C3%A1sico"><span class="header-section-number">6.2.1</span> 1. <strong>Rolling Join Básico</strong></a></li>
  <li><a href="#rolling-join-con-l%C3%ADmites-temporales" id="toc-rolling-join-con-límites-temporales" class="nav-link" data-scroll-target="#rolling-join-con-l%C3%ADmites-temporales"><span class="header-section-number">6.2.2</span> 2. <strong>Rolling Join con Límites Temporales</strong></a></li>
  <li><a href="#rolling-join-bidireccional-nearest" id="toc-rolling-join-bidireccional-nearest" class="nav-link" data-scroll-target="#rolling-join-bidireccional-nearest"><span class="header-section-number">6.2.3</span> 3. <strong>Rolling Join Bidireccional (Nearest)</strong></a></li>
  <li><a href="#rolling-join-con-sensores-iot" id="toc-rolling-join-con-sensores-iot" class="nav-link" data-scroll-target="#rolling-join-con-sensores-iot"><span class="header-section-number">6.2.4</span> 4. <strong>Rolling Join con Sensores IoT</strong></a></li>
  </ul>
</li>
  <li>
<a href="#update-joins-avanzados-con-condiciones" id="toc-update-joins-avanzados-con-condiciones" class="nav-link" data-scroll-target="#update-joins-avanzados-con-condiciones"><span class="header-section-number">6.3</span> Update Joins Avanzados con Condiciones</a>
  <ul class="collapse">
<li><a href="#update-join-condicional" id="toc-update-join-condicional" class="nav-link" data-scroll-target="#update-join-condicional"><span class="header-section-number">6.3.1</span> 1. <strong>Update Join Condicional</strong></a></li>
  <li><a href="#update-join-con-agregaciones-complejas" id="toc-update-join-con-agregaciones-complejas" class="nav-link" data-scroll-target="#update-join-con-agregaciones-complejas"><span class="header-section-number">6.3.2</span> 2. <strong>Update Join con Agregaciones Complejas</strong></a></li>
  </ul>
</li>
  <li>
<a href="#casos-de-uso-complejos-combinando-t%C3%A9cnicas" id="toc-casos-de-uso-complejos-combinando-técnicas" class="nav-link" data-scroll-target="#casos-de-uso-complejos-combinando-t%C3%A9cnicas"><span class="header-section-number">6.4</span> Casos de Uso Complejos: Combinando Técnicas</a>
  <ul class="collapse">
<li><a href="#pipeline-completo-finanzas" id="toc-pipeline-completo-finanzas" class="nav-link" data-scroll-target="#pipeline-completo-finanzas"><span class="header-section-number">6.4.1</span> 1. <strong>Pipeline Completo: Finanzas</strong></a></li>
  <li><a href="#pipeline-m%C3%A9dico-avanzado" id="toc-pipeline-médico-avanzado" class="nav-link" data-scroll-target="#pipeline-m%C3%A9dico-avanzado"><span class="header-section-number">6.4.2</span> 2. <strong>Pipeline Médico Avanzado</strong></a></li>
  </ul>
</li>
  <li><a href="#ejercicios-pr%C3%A1cticos" id="toc-ejercicios-prácticos" class="nav-link" data-scroll-target="#ejercicios-pr%C3%A1cticos"><span class="header-section-number">6.5</span> Ejercicios Prácticos</a></li>
  <li>
<a href="#mejores-pr%C3%A1cticas-para-joins-avanzados" id="toc-mejores-prácticas-para-joins-avanzados" class="nav-link" data-scroll-target="#mejores-pr%C3%A1cticas-para-joins-avanzados"><span class="header-section-number">6.6</span> Mejores Prácticas para Joins Avanzados</a>
  <ul class="collapse">
<li><a href="#performance-y-optimizaci%C3%B3n" id="toc-performance-y-optimización" class="nav-link" data-scroll-target="#performance-y-optimizaci%C3%B3n"><span class="header-section-number">6.6.1</span> 1. <strong>Performance y Optimización</strong></a></li>
  <li><a href="#manejo-de-casos-edge" id="toc-manejo-de-casos-edge" class="nav-link" data-scroll-target="#manejo-de-casos-edge"><span class="header-section-number">6.6.2</span> 2. <strong>Manejo de Casos Edge</strong></a></li>
  </ul>
</li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/tutorial-datatable/tutorial_data.table/issues" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./cap03-joins-avanzados.html"><strong>Módulo 3</strong>: Técnicas Avanzadas y Funciones Especiales</a></li><li class="breadcrumb-item"><a href="./cap03-joins-avanzados.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Joins Avanzados: Non-Equi y Rolling Joins</span></a></li></ol></nav><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">
<span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Joins Avanzados: Non-Equi y Rolling Joins</span>
</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Código</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
En este capítulo dominarás
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>
<strong>Non-equi joins</strong>: Uniones basadas en rangos y desigualdades</li>
<li>
<strong>Rolling joins</strong>: La herramienta perfecta para series temporales</li>
<li>
<strong>Update joins avanzados</strong> con condiciones complejas</li>
<li>
<strong>Joins múltiples</strong> con condiciones heterogéneas</li>
<li>
<strong>Casos de uso reales</strong> en finanzas, medicina y análisis temporal</li>
</ul>
</div>
</div>
<section id="non-equi-joins-más-allá-de-la-igualdad" class="level2" data-number="6.1"><h2 data-number="6.1" class="anchored" data-anchor-id="non-equi-joins-más-allá-de-la-igualdad">
<span class="header-section-number">6.1</span> Non-Equi Joins: Más Allá de la Igualdad</h2>
<p>Los non-equi joins permiten unir tablas basándose en rangos, desigualdades y condiciones complejas. Son especialmente útiles en análisis médico, financiero y clasificación por rangos.</p>
<section id="conceptos-fundamentales" class="level3" data-number="6.1.1"><h3 data-number="6.1.1" class="anchored" data-anchor-id="conceptos-fundamentales">
<span class="header-section-number">6.1.1</span> 1. <strong>Conceptos Fundamentales</strong>
</h3>
<p>Un non-equi join utiliza operadores de comparación (<code>&lt;=</code>, <code>&gt;=</code>, <code>&lt;</code>, <code>&gt;</code>) en lugar de igualdad (<code>==</code>):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Ejemplo simple: clasificar pacientes por IMC</span></span>
<span><span class="va">rangos_imc</span> <span class="op">&lt;-</span> <span class="va">rangos_medicos</span><span class="op">[</span><span class="va">parametro</span> <span class="op">==</span> <span class="st">"IMC"</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Rangos de IMC:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Rangos de IMC:"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">rangos_imc</span><span class="op">)</span></span>
<span><span class="co">#&gt;    parametro valor_min valor_max     categoria nivel_riesgo</span></span>
<span><span class="co">#&gt;       &lt;char&gt;     &lt;num&gt;     &lt;num&gt;        &lt;char&gt;       &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1:       IMC       0.0      18.4   Bajo/Normal         Bajo</span></span>
<span><span class="co">#&gt; 2:       IMC      18.5      24.9 Normal/Óptimo       Normal</span></span>
<span><span class="co">#&gt; 3:       IMC      25.0       Inf   Alto/Riesgo         Alto</span></span>
<span></span>
<span><span class="co"># Non-equi join básico</span></span>
<span><span class="va">pacientes_clasificados_imc</span> <span class="op">&lt;-</span> <span class="va">rangos_imc</span><span class="op">[</span><span class="va">pacientes_clinica</span>,</span>
<span>  on <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">valor_min</span> <span class="op">&lt;=</span> <span class="va">imc</span>, <span class="va">valor_max</span> <span class="op">&gt;=</span> <span class="va">imc</span><span class="op">)</span>,</span>
<span>  <span class="fu">.</span><span class="op">(</span><span class="va">paciente_id</span>, <span class="va">nombre</span>, <span class="va">imc</span>, <span class="va">categoria</span>, <span class="va">nivel_riesgo</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Pacientes clasificados por IMC:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Pacientes clasificados por IMC:"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">pacientes_clasificados_imc</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">imc</span><span class="op">)</span><span class="op">]</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;     paciente_id      nombre   imc   categoria nivel_riesgo</span></span>
<span><span class="co">#&gt;           &lt;int&gt;      &lt;char&gt; &lt;num&gt;      &lt;char&gt;       &lt;char&gt;</span></span>
<span><span class="co">#&gt;  1:          69 Paciente_69   8.6 Bajo/Normal         Bajo</span></span>
<span><span class="co">#&gt;  2:           5  Paciente_5  11.2 Bajo/Normal         Bajo</span></span>
<span><span class="co">#&gt;  3:          98 Paciente_98  11.7 Bajo/Normal         Bajo</span></span>
<span><span class="co">#&gt;  4:          57 Paciente_57  12.2 Bajo/Normal         Bajo</span></span>
<span><span class="co">#&gt;  5:          46 Paciente_46  13.1 Bajo/Normal         Bajo</span></span>
<span><span class="co">#&gt;  6:          73 Paciente_73  13.9 Bajo/Normal         Bajo</span></span>
<span><span class="co">#&gt;  7:          66 Paciente_66  14.7 Bajo/Normal         Bajo</span></span>
<span><span class="co">#&gt;  8:          90 Paciente_90  14.7 Bajo/Normal         Bajo</span></span>
<span><span class="co">#&gt;  9:           7  Paciente_7  15.5 Bajo/Normal         Bajo</span></span>
<span><span class="co">#&gt; 10:          65 Paciente_65  15.7 Bajo/Normal         Bajo</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="non-equi-join-con-múltiples-condiciones" class="level3" data-number="6.1.2"><h3 data-number="6.1.2" class="anchored" data-anchor-id="non-equi-join-con-múltiples-condiciones">
<span class="header-section-number">6.1.2</span> 2. <strong>Non-Equi Join con Múltiples Condiciones</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Clasificar pacientes por múltiples parámetros simultáneamente</span></span>
<span><span class="co"># Crear función auxiliar para clasificar</span></span>
<span><span class="va">clasificar_parametro</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dt</span>, <span class="va">param_name</span>, <span class="va">value_col</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">rangos</span> <span class="op">&lt;-</span> <span class="va">rangos_medicos</span><span class="op">[</span><span class="va">parametro</span> <span class="op">==</span> <span class="va">param_name</span><span class="op">]</span></span>
<span>  <span class="va">resultado</span> <span class="op">&lt;-</span> <span class="va">rangos</span><span class="op">[</span><span class="va">dt</span>, on <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"valor_min"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">value_col</span>, <span class="st">"&gt;="</span><span class="op">)</span>, <span class="st">"valor_max"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">value_col</span>, <span class="st">"&lt;="</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                     <span class="fu">.</span><span class="op">(</span><span class="va">paciente_id</span>, <span class="va">parametro</span>, <span class="va">categoria</span>, <span class="va">nivel_riesgo</span><span class="op">)</span>,</span>
<span>                     nomatch <span class="op">=</span> <span class="cn">NULL</span><span class="op">]</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">resultado</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Clasificar por glucosa</span></span>
<span><span class="va">pacientes_glucosa</span> <span class="op">&lt;-</span> <span class="va">rangos_medicos</span><span class="op">[</span><span class="va">parametro</span> <span class="op">==</span> <span class="st">"Glucosa"</span><span class="op">]</span><span class="op">[</span><span class="va">pacientes_clinica</span>,</span>
<span>  on <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">valor_min</span> <span class="op">&lt;=</span> <span class="va">glucosa</span>, <span class="va">valor_max</span> <span class="op">&gt;=</span> <span class="va">glucosa</span><span class="op">)</span>,</span>
<span>  <span class="fu">.</span><span class="op">(</span><span class="va">paciente_id</span>, parametro <span class="op">=</span> <span class="st">"Glucosa"</span>, valor <span class="op">=</span> <span class="va">glucosa</span>, <span class="va">categoria</span>, <span class="va">nivel_riesgo</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Clasificar por presión sistólica</span></span>
<span><span class="va">pacientes_presion</span> <span class="op">&lt;-</span> <span class="va">rangos_medicos</span><span class="op">[</span><span class="va">parametro</span> <span class="op">==</span> <span class="st">"Presión"</span><span class="op">]</span><span class="op">[</span><span class="va">pacientes_clinica</span>,</span>
<span>  on <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">valor_min</span> <span class="op">&lt;=</span> <span class="va">presion_sistolica</span>, <span class="va">valor_max</span> <span class="op">&gt;=</span> <span class="va">presion_sistolica</span><span class="op">)</span>,  </span>
<span>  <span class="fu">.</span><span class="op">(</span><span class="va">paciente_id</span>, parametro <span class="op">=</span> <span class="st">"Presion"</span>, valor <span class="op">=</span> <span class="va">presion_sistolica</span>, <span class="va">categoria</span>, <span class="va">nivel_riesgo</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Combinar clasificaciones</span></span>
<span><span class="va">todas_clasificaciones</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span></span>
<span>  <span class="va">pacientes_glucosa</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">categoria</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  <span class="va">pacientes_presion</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">categoria</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Resumen de riesgos por paciente</span></span>
<span><span class="va">resumen_riesgo_pacientes</span> <span class="op">&lt;-</span> <span class="va">todas_clasificaciones</span><span class="op">[</span>,</span>
<span>  <span class="fu">.</span><span class="op">(</span></span>
<span>    parametros_evaluados <span class="op">=</span> <span class="va">.N</span>,</span>
<span>    riesgos_altos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">nivel_riesgo</span> <span class="op">==</span> <span class="st">"Alto"</span><span class="op">)</span>,</span>
<span>    riesgos_normales <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">nivel_riesgo</span> <span class="op">==</span> <span class="st">"Normal"</span><span class="op">)</span>,</span>
<span>    clasificacion_general <span class="op">=</span> <span class="fu">fcase</span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">nivel_riesgo</span> <span class="op">==</span> <span class="st">"Alto"</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fl">2</span>, <span class="st">"Alto Riesgo Múltiple"</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">nivel_riesgo</span> <span class="op">==</span> <span class="st">"Alto"</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">"Riesgo Moderado"</span>, </span>
<span>      default <span class="op">=</span> <span class="st">"Bajo Riesgo"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>, by <span class="op">=</span> <span class="va">paciente_id</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Resumen de riesgos por paciente:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Resumen de riesgos por paciente:"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">resumen_riesgo_pacientes</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">riesgos_altos</span><span class="op">)</span><span class="op">]</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;     paciente_id parametros_evaluados riesgos_altos riesgos_normales</span></span>
<span><span class="co">#&gt;           &lt;int&gt;                &lt;int&gt;         &lt;int&gt;            &lt;int&gt;</span></span>
<span><span class="co">#&gt;  1:           1                    2             2                0</span></span>
<span><span class="co">#&gt;  2:           2                    2             2                0</span></span>
<span><span class="co">#&gt;  3:           4                    2             2                0</span></span>
<span><span class="co">#&gt;  4:           8                    2             2                0</span></span>
<span><span class="co">#&gt;  5:           9                    2             2                0</span></span>
<span><span class="co">#&gt;  6:          12                    2             2                0</span></span>
<span><span class="co">#&gt;  7:          16                    2             2                0</span></span>
<span><span class="co">#&gt;  8:          18                    2             2                0</span></span>
<span><span class="co">#&gt;  9:          19                    2             2                0</span></span>
<span><span class="co">#&gt; 10:          20                    2             2                0</span></span>
<span><span class="co">#&gt;     clasificacion_general</span></span>
<span><span class="co">#&gt;                    &lt;char&gt;</span></span>
<span><span class="co">#&gt;  1:  Alto Riesgo Múltiple</span></span>
<span><span class="co">#&gt;  2:  Alto Riesgo Múltiple</span></span>
<span><span class="co">#&gt;  3:  Alto Riesgo Múltiple</span></span>
<span><span class="co">#&gt;  4:  Alto Riesgo Múltiple</span></span>
<span><span class="co">#&gt;  5:  Alto Riesgo Múltiple</span></span>
<span><span class="co">#&gt;  6:  Alto Riesgo Múltiple</span></span>
<span><span class="co">#&gt;  7:  Alto Riesgo Múltiple</span></span>
<span><span class="co">#&gt;  8:  Alto Riesgo Múltiple</span></span>
<span><span class="co">#&gt;  9:  Alto Riesgo Múltiple</span></span>
<span><span class="co">#&gt; 10:  Alto Riesgo Múltiple</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="non-equi-join-para-ventanas-temporales" class="level3" data-number="6.1.3"><h3 data-number="6.1.3" class="anchored" data-anchor-id="non-equi-join-para-ventanas-temporales">
<span class="header-section-number">6.1.3</span> 3. <strong>Non-Equi Join para Ventanas Temporales</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Encontrar todas las operaciones que ocurrieron dentro de ventanas de eventos</span></span>
<span><span class="va">operaciones_en_ventanas</span> <span class="op">&lt;-</span> <span class="va">eventos_mercado</span><span class="op">[</span><span class="va">operaciones_trading</span>,</span>
<span>  on <span class="op">=</span> <span class="fu">.</span><span class="op">(</span>ticker_afectado <span class="op">=</span> <span class="va">ticker</span>,</span>
<span>         <span class="va">fecha_inicio_ventana</span> <span class="op">&lt;=</span> <span class="va">fecha_operacion</span>,</span>
<span>         <span class="va">fecha_fin_ventana</span> <span class="op">&gt;=</span> <span class="va">fecha_operacion</span><span class="op">)</span>,</span>
<span>  <span class="fu">.</span><span class="op">(</span><span class="va">evento_id</span>, <span class="va">tipo_evento</span>, <span class="va">fecha_evento</span>, <span class="va">impacto_esperado</span>,</span>
<span>    <span class="va">operacion_id</span>, <span class="va">fecha_operacion</span>, <span class="va">tipo</span>, <span class="va">cantidad</span>, <span class="va">precio_limite</span><span class="op">)</span>,</span>
<span>  nomatch <span class="op">=</span> <span class="cn">NULL</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Análisis de comportamiento en ventanas de eventos</span></span>
<span><span class="va">comportamiento_eventos</span> <span class="op">&lt;-</span> <span class="va">operaciones_en_ventanas</span><span class="op">[</span>,</span>
<span>  <span class="fu">.</span><span class="op">(</span></span>
<span>    operaciones_total <span class="op">=</span> <span class="va">.N</span>,</span>
<span>    operaciones_compra <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">tipo</span> <span class="op">==</span> <span class="st">"COMPRA"</span><span class="op">)</span>,</span>
<span>    operaciones_venta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">tipo</span> <span class="op">==</span> <span class="st">"VENTA"</span><span class="op">)</span>,</span>
<span>    volumen_total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">cantidad</span><span class="op">)</span>,</span>
<span>    precio_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">precio_limite</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    dias_promedio_evento <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">fecha_operacion</span> <span class="op">-</span> <span class="va">fecha_evento</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">tipo_evento</span>, <span class="va">impacto_esperado</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Comportamiento de trading en ventanas de eventos:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Comportamiento de trading en ventanas de eventos:"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">comportamiento_eventos</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">volumen_total</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;       tipo_evento impacto_esperado operaciones_total operaciones_compra</span></span>
<span><span class="co">#&gt;            &lt;char&gt;           &lt;char&gt;             &lt;int&gt;              &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1:       Earnings         Positivo                 7                  4</span></span>
<span><span class="co">#&gt; 2:       Earnings           Neutro                 9                  7</span></span>
<span><span class="co">#&gt; 3:         Merger         Positivo                 8                  4</span></span>
<span><span class="co">#&gt; 4:   FDA_Approval         Positivo                 7                  3</span></span>
<span><span class="co">#&gt; 5:   FDA_Approval           Neutro                 5                  5</span></span>
<span><span class="co">#&gt; 6:          Split         Positivo                 6                  3</span></span>
<span><span class="co">#&gt; 7:         Merger           Neutro                 1                  1</span></span>
<span><span class="co">#&gt; 8: Product_Launch         Positivo                 2                  0</span></span>
<span><span class="co">#&gt; 9:       Earnings         Negativo                 1                  1</span></span>
<span><span class="co">#&gt;    operaciones_venta volumen_total precio_promedio dias_promedio_evento</span></span>
<span><span class="co">#&gt;                &lt;int&gt;         &lt;num&gt;           &lt;num&gt;                &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:                 3          5550         1114.30                  3.1</span></span>
<span><span class="co">#&gt; 2:                 2          3150         1407.04                  4.3</span></span>
<span><span class="co">#&gt; 3:                 4          3100         1581.95                  5.1</span></span>
<span><span class="co">#&gt; 4:                 4          2400         1328.23                  3.1</span></span>
<span><span class="co">#&gt; 5:                 0          1950         1803.68                  4.8</span></span>
<span><span class="co">#&gt; 6:                 3          1200         1841.82                  4.8</span></span>
<span><span class="co">#&gt; 7:                 0          1000         2428.78                  2.0</span></span>
<span><span class="co">#&gt; 8:                 2           600         1234.13                  2.0</span></span>
<span><span class="co">#&gt; 9:                 0           500         1804.09                  5.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="rolling-joins-la-joya-para-series-temporales" class="level2" data-number="6.2"><h2 data-number="6.2" class="anchored" data-anchor-id="rolling-joins-la-joya-para-series-temporales">
<span class="header-section-number">6.2</span> Rolling Joins: La Joya para Series Temporales</h2>
<p>Los rolling joins son perfectos para conectar cada observación con el último valor disponible en el tiempo.</p>
<section id="rolling-join-básico" class="level3" data-number="6.2.1"><h3 data-number="6.2.1" class="anchored" data-anchor-id="rolling-join-básico">
<span class="header-section-number">6.2.1</span> 1. <strong>Rolling Join Básico</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Preparar datos con keys para rolling join</span></span>
<span><span class="va">precios_key</span> <span class="op">&lt;-</span> <span class="fu">copy</span><span class="op">(</span><span class="va">precios_historicos</span><span class="op">)</span></span>
<span><span class="va">operaciones_key</span> <span class="op">&lt;-</span> <span class="fu">copy</span><span class="op">(</span><span class="va">operaciones_trading</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Establecer keys compuestas: ticker + fecha</span></span>
<span><span class="fu">setkey</span><span class="op">(</span><span class="va">precios_key</span>, <span class="va">ticker</span>, <span class="va">fecha</span><span class="op">)</span></span>
<span><span class="fu">setkey</span><span class="op">(</span><span class="va">operaciones_key</span>, <span class="va">ticker</span>, <span class="va">fecha_operacion</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Rolling join: obtener el último precio disponible para cada operación</span></span>
<span><span class="va">operaciones_con_precio</span> <span class="op">&lt;-</span> <span class="va">precios_key</span><span class="op">[</span><span class="va">operaciones_key</span>, roll <span class="op">=</span> <span class="cn">TRUE</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Verificar estructura del resultado</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Columnas disponibles después del rolling join:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Columnas disponibles después del rolling join:"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">operaciones_con_precio</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "fecha"         "ticker"        "precio_cierre" "volumen"      </span></span>
<span><span class="co">#&gt; [5] "operacion_id"  "tipo"          "cantidad"      "precio_limite"</span></span>
<span><span class="co">#&gt; [9] "trader_id"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Primeras filas para entender la estructura:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Primeras filas para entender la estructura:"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">operaciones_con_precio</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Clave &lt;ticker, fecha&gt;</span></span>
<span><span class="co">#&gt;         fecha ticker precio_cierre  volumen operacion_id   tipo cantidad</span></span>
<span><span class="co">#&gt;        &lt;Date&gt; &lt;char&gt;         &lt;num&gt;    &lt;num&gt;        &lt;int&gt; &lt;char&gt;    &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: 2024-01-01   AAPL        155.41 15619654          471 COMPRA       50</span></span>
<span><span class="co">#&gt; 2: 2024-01-04   AAPL        157.65 42789129          437 COMPRA      100</span></span>
<span><span class="co">#&gt; 3: 2024-01-06   AAPL        170.90  4219831           37  VENTA       50</span></span>
<span><span class="co">#&gt;    precio_limite trader_id</span></span>
<span><span class="co">#&gt;            &lt;num&gt;    &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1:       1827.71        T5</span></span>
<span><span class="co">#&gt; 2:       2802.78       T18</span></span>
<span><span class="co">#&gt; 3:        971.83        T9</span></span>
<span></span>
<span><span class="co"># En un rolling join X[Y], el resultado incluye todas las columnas de Y más las de X</span></span>
<span><span class="co"># Las columnas de la fecha de Y se mantienen, no se prefijan con i.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Operaciones con precios históricos (rolling join):"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Operaciones con precios históricos (rolling join):"</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="st">"fecha_operacion"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">operaciones_con_precio</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Si fecha_operacion existe directamente</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">operaciones_con_precio</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">ticker</span>, <span class="va">fecha</span>, <span class="va">precio_cierre</span>, </span>
<span>                                       <span class="va">operacion_id</span>, <span class="va">fecha_operacion</span>, <span class="va">tipo</span>, <span class="va">cantidad</span><span class="op">)</span><span class="op">]</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># Calcular diferencia temporal</span></span>
<span>  <span class="va">operaciones_con_precio</span><span class="op">[</span>, <span class="va">dias_diferencia</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">fecha_operacion</span> <span class="op">-</span> <span class="va">fecha</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="co"># Buscar columnas con fecha en el nombre</span></span>
<span>  <span class="va">fecha_cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"fecha"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">operaciones_con_precio</span><span class="op">)</span>, value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Columnas con 'fecha' encontradas:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">fecha_cols</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Mostrar primeras columnas disponibles</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">operaciones_con_precio</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">operaciones_con_precio</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; [1] "Columnas con 'fecha' encontradas: fecha"</span></span>
<span><span class="co">#&gt; Clave &lt;ticker, fecha&gt;</span></span>
<span><span class="co">#&gt;          fecha ticker precio_cierre  volumen operacion_id   tipo cantidad</span></span>
<span><span class="co">#&gt;         &lt;Date&gt; &lt;char&gt;         &lt;num&gt;    &lt;num&gt;        &lt;int&gt; &lt;char&gt;    &lt;num&gt;</span></span>
<span><span class="co">#&gt;  1: 2024-01-01   AAPL        155.41 15619654          471 COMPRA       50</span></span>
<span><span class="co">#&gt;  2: 2024-01-04   AAPL        157.65 42789129          437 COMPRA      100</span></span>
<span><span class="co">#&gt;  3: 2024-01-06   AAPL        170.90  4219831           37  VENTA       50</span></span>
<span><span class="co">#&gt;  4: 2024-01-17   AAPL        144.56 22593327          260 COMPRA      100</span></span>
<span><span class="co">#&gt;  5: 2024-01-21   AAPL        136.44 22967352           35 COMPRA      200</span></span>
<span><span class="co">#&gt;  6: 2024-01-25   AAPL        146.15 16764243          362  VENTA     1000</span></span>
<span><span class="co">#&gt;  7: 2024-01-26   AAPL        138.94 25121176          302 COMPRA      100</span></span>
<span><span class="co">#&gt;  8: 2024-01-28   AAPL        142.77  4554781          102 COMPRA      100</span></span>
<span><span class="co">#&gt;  9: 2024-02-01   AAPL        125.12 39017505          135 COMPRA      100</span></span>
<span><span class="co">#&gt; 10: 2024-02-12   AAPL        130.18  3604906          237 COMPRA      200</span></span>
<span><span class="co">#&gt;     precio_limite</span></span>
<span><span class="co">#&gt;             &lt;num&gt;</span></span>
<span><span class="co">#&gt;  1:       1827.71</span></span>
<span><span class="co">#&gt;  2:       2802.78</span></span>
<span><span class="co">#&gt;  3:        971.83</span></span>
<span><span class="co">#&gt;  4:        740.76</span></span>
<span><span class="co">#&gt;  5:        463.55</span></span>
<span><span class="co">#&gt;  6:       1978.25</span></span>
<span><span class="co">#&gt;  7:        758.49</span></span>
<span><span class="co">#&gt;  8:       2694.70</span></span>
<span><span class="co">#&gt;  9:       1218.84</span></span>
<span><span class="co">#&gt; 10:       1558.66</span></span>
<span></span>
<span><span class="co"># Estadísticas de la calidad del match (solo si dias_diferencia fue creada)</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="st">"dias_diferencia"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">operaciones_con_precio</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Estadísticas del rolling join:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"• Operaciones con precio exacto (mismo día):"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">operaciones_con_precio</span><span class="op">$</span><span class="va">dias_diferencia</span> <span class="op">==</span> <span class="fl">0</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"• Operaciones con precio de días anteriores:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">operaciones_con_precio</span><span class="op">$</span><span class="va">dias_diferencia</span> <span class="op">&gt;</span> <span class="fl">0</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"• Diferencia promedio en días:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">operaciones_con_precio</span><span class="op">$</span><span class="va">dias_diferencia</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"La variable dias_diferencia no pudo ser creada debido a problemas con las columnas de fecha.\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; La variable dias_diferencia no pudo ser creada debido a problemas con las columnas de fecha.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="rolling-join-con-límites-temporales" class="level3" data-number="6.2.2"><h3 data-number="6.2.2" class="anchored" data-anchor-id="rolling-join-con-límites-temporales">
<span class="header-section-number">6.2.2</span> 2. <strong>Rolling Join con Límites Temporales</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Rolling join con límite: solo usar precios de máximo 7 días anteriores</span></span>
<span><span class="va">operaciones_precio_limitado</span> <span class="op">&lt;-</span> <span class="va">precios_key</span><span class="op">[</span><span class="va">operaciones_key</span>, </span>
<span>                                          roll <span class="op">=</span> <span class="fl">7</span>,  <span class="co"># máximo 7 días</span></span>
<span>                                          rollends <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">TRUE</span>, <span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Comparar con rolling join ilimitado</span></span>
<span><span class="va">matches_limitado</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">operaciones_precio_limitado</span><span class="op">$</span><span class="va">precio_cierre</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">matches_ilimitado</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">operaciones_con_precio</span><span class="op">$</span><span class="va">precio_cierre</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Comparación de rolling joins:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Comparación de rolling joins:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"• Matches con rolling limitado (7 días):"</span>, <span class="va">matches_limitado</span>, <span class="st">"\n"</span><span class="op">)</span> </span>
<span><span class="co">#&gt; • Matches con rolling limitado (7 días): 111</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"• Matches con rolling ilimitado:"</span>, <span class="va">matches_ilimitado</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; • Matches con rolling ilimitado: 291</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"• Diferencia:"</span>, <span class="va">matches_ilimitado</span> <span class="op">-</span> <span class="va">matches_limitado</span>, <span class="st">"operaciones\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; • Diferencia: 180 operaciones</span></span>
<span></span>
<span><span class="co"># Analizar operaciones sin match en rolling limitado</span></span>
<span><span class="va">operaciones_sin_precio</span> <span class="op">&lt;-</span> <span class="va">operaciones_precio_limitado</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">precio_cierre</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">operaciones_sin_precio</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"• Operaciones sin precio (primeros días del año o fines de semana largos):"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">operaciones_sin_precio</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; • Operaciones sin precio (primeros días del año o fines de semana largos): 389</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="rolling-join-bidireccional-nearest" class="level3" data-number="6.2.3"><h3 data-number="6.2.3" class="anchored" data-anchor-id="rolling-join-bidireccional-nearest">
<span class="header-section-number">6.2.3</span> 3. <strong>Rolling Join Bidireccional (Nearest)</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Rolling join "nearest": buscar el precio más cercano (antes o después)</span></span>
<span><span class="va">operaciones_nearest</span> <span class="op">&lt;-</span> <span class="va">precios_key</span><span class="op">[</span><span class="va">operaciones_key</span>, roll <span class="op">=</span> <span class="st">"nearest"</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Comparar diferentes tipos de rolling join</span></span>
<span><span class="va">comparacion_rolling</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="op">(</span></span>
<span>  Tipo_Rolling <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Backward (TRUE)"</span>, <span class="st">"Limited (7 days)"</span>, <span class="st">"Nearest"</span><span class="op">)</span>,</span>
<span>  Matches <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">operaciones_con_precio</span><span class="op">$</span><span class="va">precio_cierre</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">operaciones_precio_limitado</span><span class="op">$</span><span class="va">precio_cierre</span><span class="op">)</span><span class="op">)</span>, </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">operaciones_nearest</span><span class="op">$</span><span class="va">precio_cierre</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  Cobertura_Pct <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">operaciones_con_precio</span><span class="op">$</span><span class="va">precio_cierre</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">operaciones_precio_limitado</span><span class="op">$</span><span class="va">precio_cierre</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">operaciones_nearest</span><span class="op">$</span><span class="va">precio_cierre</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span></span>
<span>  <span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Comparación de tipos de rolling join:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Comparación de tipos de rolling join:"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">comparacion_rolling</span><span class="op">)</span></span>
<span><span class="co">#&gt;        Tipo_Rolling Matches Cobertura_Pct</span></span>
<span><span class="co">#&gt;              &lt;char&gt;   &lt;int&gt;         &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:  Backward (TRUE)     291          58.2</span></span>
<span><span class="co">#&gt; 2: Limited (7 days)     111          22.2</span></span>
<span><span class="co">#&gt; 3:          Nearest     500         100.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="rolling-join-con-sensores-iot" class="level3" data-number="6.2.4"><h3 data-number="6.2.4" class="anchored" data-anchor-id="rolling-join-con-sensores-iot">
<span class="header-section-number">6.2.4</span> 4. <strong>Rolling Join con Sensores IoT</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Caso práctico: asociar eventos de mantenimiento con lecturas de sensores</span></span>
<span><span class="fu">setkey</span><span class="op">(</span><span class="va">sensores_iot</span>, <span class="va">sensor_id</span>, <span class="va">timestamp</span><span class="op">)</span></span>
<span><span class="fu">setkey</span><span class="op">(</span><span class="va">mantenimiento</span>, <span class="va">sensor_id</span>, <span class="va">fecha_mantenimiento</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Rolling join para obtener la última lectura antes del mantenimiento</span></span>
<span><span class="va">lecturas_pre_mantenimiento</span> <span class="op">&lt;-</span> <span class="va">sensores_iot</span><span class="op">[</span><span class="va">mantenimiento</span>, roll <span class="op">=</span> <span class="cn">TRUE</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Verificar estructura del resultado</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Columnas disponibles después del rolling join de sensores:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Columnas disponibles después del rolling join de sensores:"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">lecturas_pre_mantenimiento</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "timestamp"          "sensor_id"          "valor"             </span></span>
<span><span class="co">#&gt; [4] "ubicacion"          "mantenimiento_id"   "tipo_mantenimiento"</span></span>
<span><span class="co">#&gt; [7] "duracion_horas"</span></span>
<span></span>
<span><span class="co"># Análisis del estado de sensores antes del mantenimiento</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="st">"fecha_mantenimiento"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">lecturas_pre_mantenimiento</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Si fecha_mantenimiento existe directamente</span></span>
<span>  <span class="va">analisis_pre_mantenimiento</span> <span class="op">&lt;-</span> <span class="va">lecturas_pre_mantenimiento</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">valor</span><span class="op">)</span>,</span>
<span>    <span class="fu">.</span><span class="op">(</span></span>
<span>      valor_promedio_pre <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">valor</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>      valor_min_pre <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">valor</span><span class="op">)</span>,</span>
<span>      valor_max_pre <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">valor</span><span class="op">)</span>,</span>
<span>      eventos_mantenimiento <span class="op">=</span> <span class="va">.N</span>,</span>
<span>      tiempo_promedio_desde_lectura <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">fecha_mantenimiento</span> <span class="op">-</span> <span class="va">timestamp</span><span class="op">)</span> <span class="op">/</span> <span class="fl">60</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span> <span class="co"># minutos</span></span>
<span>    <span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">sensor_id</span>, <span class="va">tipo_mantenimiento</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="co"># Buscar columnas con fecha o mantenimiento en el nombre</span></span>
<span>  <span class="va">fecha_cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"fecha|mantenimiento"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">lecturas_pre_mantenimiento</span><span class="op">)</span>, value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Columnas con 'fecha' o 'mantenimiento' encontradas:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">fecha_cols</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Análisis simplificado sin cálculo temporal</span></span>
<span>  <span class="va">analisis_pre_mantenimiento</span> <span class="op">&lt;-</span> <span class="va">lecturas_pre_mantenimiento</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">valor</span><span class="op">)</span>,</span>
<span>    <span class="fu">.</span><span class="op">(</span></span>
<span>      valor_promedio_pre <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">valor</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>      valor_min_pre <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">valor</span><span class="op">)</span>,</span>
<span>      valor_max_pre <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">valor</span><span class="op">)</span>,</span>
<span>      eventos_mantenimiento <span class="op">=</span> <span class="va">.N</span></span>
<span>    <span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">sensor_id</span>, <span class="va">tipo_mantenimiento</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; [1] "Columnas con 'fecha' o 'mantenimiento' encontradas: mantenimiento_id, tipo_mantenimiento"</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Análisis de sensores antes del mantenimiento:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Análisis de sensores antes del mantenimiento:"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">analisis_pre_mantenimiento</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">sensor_id</span>, <span class="va">tipo_mantenimiento</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;       sensor_id tipo_mantenimiento valor_promedio_pre valor_min_pre</span></span>
<span><span class="co">#&gt;          &lt;char&gt;             &lt;char&gt;              &lt;num&gt;         &lt;num&gt;</span></span>
<span><span class="co">#&gt;  1:    HUMID_01        Calibracion              82.65         82.65</span></span>
<span><span class="co">#&gt;  2:    HUMID_01          Reemplazo             290.32         24.02</span></span>
<span><span class="co">#&gt;  3: PRESSURE_01           Limpieza             508.30         20.37</span></span>
<span><span class="co">#&gt;  4: PRESSURE_01          Reemplazo              19.74         19.74</span></span>
<span><span class="co">#&gt;  5:     TEMP_01        Calibracion             992.82        992.82</span></span>
<span><span class="co">#&gt;  6:     TEMP_01           Limpieza              22.69         22.69</span></span>
<span><span class="co">#&gt;  7:     TEMP_01          Reemplazo             529.52         55.85</span></span>
<span><span class="co">#&gt;  8:     TEMP_02        Calibracion              73.00         73.00</span></span>
<span><span class="co">#&gt;  9:     TEMP_02           Limpieza              21.75         20.97</span></span>
<span><span class="co">#&gt; 10:     TEMP_02          Reemplazo              29.41         20.87</span></span>
<span><span class="co">#&gt;     valor_max_pre eventos_mantenimiento</span></span>
<span><span class="co">#&gt;             &lt;num&gt;                 &lt;int&gt;</span></span>
<span><span class="co">#&gt;  1:         82.65                     1</span></span>
<span><span class="co">#&gt;  2:       1035.33                     4</span></span>
<span><span class="co">#&gt;  3:        996.24                     2</span></span>
<span><span class="co">#&gt;  4:         19.74                     1</span></span>
<span><span class="co">#&gt;  5:        992.82                     1</span></span>
<span><span class="co">#&gt;  6:         22.69                     1</span></span>
<span><span class="co">#&gt;  7:       1003.20                     2</span></span>
<span><span class="co">#&gt;  8:         73.00                     1</span></span>
<span><span class="co">#&gt;  9:         22.45                     3</span></span>
<span><span class="co">#&gt; 10:         51.82                     4</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="update-joins-avanzados-con-condiciones" class="level2" data-number="6.3"><h2 data-number="6.3" class="anchored" data-anchor-id="update-joins-avanzados-con-condiciones">
<span class="header-section-number">6.3</span> Update Joins Avanzados con Condiciones</h2>
<section id="update-join-condicional" class="level3" data-number="6.3.1"><h3 data-number="6.3.1" class="anchored" data-anchor-id="update-join-condicional">
<span class="header-section-number">6.3.1</span> 1. <strong>Update Join Condicional</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Update join para marcar operaciones riesgosas</span></span>
<span><span class="co"># Crear tabla de límites de riesgo por ticker</span></span>
<span><span class="va">limites_riesgo</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="op">(</span></span>
<span>  ticker <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"AAPL"</span>, <span class="st">"GOOGL"</span>, <span class="st">"MSFT"</span>, <span class="st">"TSLA"</span>, <span class="st">"AMZN"</span><span class="op">)</span>,</span>
<span>  precio_max_seguro <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">200</span>, <span class="fl">3000</span>, <span class="fl">400</span>, <span class="fl">250</span>, <span class="fl">150</span><span class="op">)</span>,</span>
<span>  volumen_max_seguro <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">500</span>, <span class="fl">800</span>, <span class="fl">2000</span>, <span class="fl">1200</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Hacer copia para update join</span></span>
<span><span class="va">operaciones_riesgo</span> <span class="op">&lt;-</span> <span class="fu">copy</span><span class="op">(</span><span class="va">operaciones_trading</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Update join condicional</span></span>
<span><span class="va">operaciones_riesgo</span><span class="op">[</span><span class="va">limites_riesgo</span>, on <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">ticker</span><span class="op">)</span>,</span>
<span>                  <span class="fu">`:=`</span><span class="op">(</span></span>
<span>                    precio_limite_riesgoso <span class="op">=</span> <span class="va">i.precio_max_seguro</span> <span class="op">&lt;</span> <span class="va">precio_limite</span>,</span>
<span>                    volumen_riesgoso <span class="op">=</span> <span class="va">i.volumen_max_seguro</span> <span class="op">&lt;</span> <span class="va">cantidad</span>,</span>
<span>                    limite_precio_ref <span class="op">=</span> <span class="va">i.precio_max_seguro</span>,</span>
<span>                    limite_volumen_ref <span class="op">=</span> <span class="va">i.volumen_max_seguro</span></span>
<span>                  <span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Clasificar nivel de riesgo general</span></span>
<span><span class="va">operaciones_riesgo</span><span class="op">[</span>, <span class="va">nivel_riesgo</span> <span class="op">:=</span> <span class="fu">fcase</span><span class="op">(</span></span>
<span>  <span class="va">precio_limite_riesgoso</span> <span class="op">&amp;</span> <span class="va">volumen_riesgoso</span>, <span class="st">"Alto Riesgo"</span>,</span>
<span>  <span class="va">precio_limite_riesgoso</span> <span class="op">|</span> <span class="va">volumen_riesgoso</span>, <span class="st">"Riesgo Moderado"</span>,</span>
<span>  default <span class="op">=</span> <span class="st">"Bajo Riesgo"</span></span>
<span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Resumen de riesgos</span></span>
<span><span class="va">resumen_riesgos</span> <span class="op">&lt;-</span> <span class="va">operaciones_riesgo</span><span class="op">[</span>, <span class="va">.N</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">ticker</span>, <span class="va">nivel_riesgo</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">ticker</span>, <span class="va">nivel_riesgo</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Distribución de riesgo por ticker:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Distribución de riesgo por ticker:"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">resumen_riesgos</span><span class="op">)</span></span>
<span><span class="co">#&gt;     ticker    nivel_riesgo     N</span></span>
<span><span class="co">#&gt;     &lt;char&gt;          &lt;char&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt;  1:   AAPL     Bajo Riesgo     3</span></span>
<span><span class="co">#&gt;  2:   AAPL Riesgo Moderado    91</span></span>
<span><span class="co">#&gt;  3:   AMZN     Bajo Riesgo     1</span></span>
<span><span class="co">#&gt;  4:   AMZN Riesgo Moderado   105</span></span>
<span><span class="co">#&gt;  5:  GOOGL     Bajo Riesgo    83</span></span>
<span><span class="co">#&gt;  6:  GOOGL Riesgo Moderado    21</span></span>
<span><span class="co">#&gt;  7:   MSFT     Alto Riesgo    16</span></span>
<span><span class="co">#&gt;  8:   MSFT     Bajo Riesgo     9</span></span>
<span><span class="co">#&gt;  9:   MSFT Riesgo Moderado    74</span></span>
<span><span class="co">#&gt; 10:   TSLA     Bajo Riesgo     3</span></span>
<span><span class="co">#&gt; 11:   TSLA Riesgo Moderado    94</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="update-join-con-agregaciones-complejas" class="level3" data-number="6.3.2"><h3 data-number="6.3.2" class="anchored" data-anchor-id="update-join-con-agregaciones-complejas">
<span class="header-section-number">6.3.2</span> 2. <strong>Update Join con Agregaciones Complejas</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Calcular estadísticas móviles y actualizar tabla principal</span></span>
<span><span class="va">estadisticas_ticker</span> <span class="op">&lt;-</span> <span class="va">operaciones_trading</span><span class="op">[</span>,</span>
<span>  <span class="fu">.</span><span class="op">(</span></span>
<span>    operaciones_historicas <span class="op">=</span> <span class="va">.N</span>,</span>
<span>    precio_promedio_historico <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">precio_limite</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    volumen_promedio_historico <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">cantidad</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>    precio_max_historico <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">precio_limite</span><span class="op">)</span>,</span>
<span>    precio_min_historico <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">precio_limite</span><span class="op">)</span>,</span>
<span>    ratio_compra_venta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">tipo</span> <span class="op">==</span> <span class="st">"COMPRA"</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">)</span>, by <span class="op">=</span> <span class="va">ticker</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Update join para agregar contexto histórico</span></span>
<span><span class="va">operaciones_riesgo</span><span class="op">[</span><span class="va">estadisticas_ticker</span>, on <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">ticker</span><span class="op">)</span>,</span>
<span>                  <span class="fu">`:=`</span><span class="op">(</span></span>
<span>                    percentil_precio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="op">(</span><span class="va">precio_limite</span> <span class="op">-</span> <span class="va">i.precio_min_historico</span><span class="op">)</span> <span class="op">/</span> </span>
<span>                                           <span class="op">(</span><span class="va">i.precio_max_historico</span> <span class="op">-</span> <span class="va">i.precio_min_historico</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>                    precio_vs_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">precio_limite</span> <span class="op">/</span> <span class="va">i.precio_promedio_historico</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>                    volumen_vs_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">cantidad</span> <span class="op">/</span> <span class="va">i.volumen_promedio_historico</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>                    operaciones_ticker_total <span class="op">=</span> <span class="va">i.operaciones_historicas</span></span>
<span>                  <span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Operaciones con contexto histórico:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Operaciones con contexto histórico:"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">operaciones_riesgo</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">ticker</span>, <span class="va">precio_limite</span>, <span class="va">percentil_precio</span>, </span>
<span>                                 <span class="va">precio_vs_promedio</span>, <span class="va">volumen_vs_promedio</span>, <span class="va">nivel_riesgo</span><span class="op">)</span><span class="op">]</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;     ticker precio_limite percentil_precio precio_vs_promedio</span></span>
<span><span class="co">#&gt;     &lt;char&gt;         &lt;num&gt;            &lt;num&gt;              &lt;num&gt;</span></span>
<span><span class="co">#&gt;  1:   AAPL       2596.34             87.1               1.60</span></span>
<span><span class="co">#&gt;  2:   MSFT       2878.99             97.6               1.82</span></span>
<span><span class="co">#&gt;  3:   MSFT        264.94              5.7               0.17</span></span>
<span><span class="co">#&gt;  4:   AAPL       2745.92             92.4               1.69</span></span>
<span><span class="co">#&gt;  5:   AMZN       2631.01             87.5               1.66</span></span>
<span><span class="co">#&gt;  6:   TSLA       1407.00             45.3               0.92</span></span>
<span><span class="co">#&gt;  7:   AMZN       2465.81             81.7               1.56</span></span>
<span><span class="co">#&gt;  8:  GOOGL       1629.14             53.4               1.09</span></span>
<span><span class="co">#&gt;  9:  GOOGL        910.92             28.1               0.61</span></span>
<span><span class="co">#&gt; 10:   TSLA       2405.32             80.6               1.58</span></span>
<span><span class="co">#&gt;     volumen_vs_promedio    nivel_riesgo</span></span>
<span><span class="co">#&gt;                   &lt;num&gt;          &lt;char&gt;</span></span>
<span><span class="co">#&gt;  1:                2.34 Riesgo Moderado</span></span>
<span><span class="co">#&gt;  2:                0.14 Riesgo Moderado</span></span>
<span><span class="co">#&gt;  3:                0.14     Bajo Riesgo</span></span>
<span><span class="co">#&gt;  4:                2.34 Riesgo Moderado</span></span>
<span><span class="co">#&gt;  5:                0.12 Riesgo Moderado</span></span>
<span><span class="co">#&gt;  6:                0.29 Riesgo Moderado</span></span>
<span><span class="co">#&gt;  7:                0.25 Riesgo Moderado</span></span>
<span><span class="co">#&gt;  8:                2.70 Riesgo Moderado</span></span>
<span><span class="co">#&gt;  9:                0.27     Bajo Riesgo</span></span>
<span><span class="co">#&gt; 10:                0.15 Riesgo Moderado</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="casos-de-uso-complejos-combinando-técnicas" class="level2" data-number="6.4"><h2 data-number="6.4" class="anchored" data-anchor-id="casos-de-uso-complejos-combinando-técnicas">
<span class="header-section-number">6.4</span> Casos de Uso Complejos: Combinando Técnicas</h2>
<section id="pipeline-completo-finanzas" class="level3" data-number="6.4.1"><h3 data-number="6.4.1" class="anchored" data-anchor-id="pipeline-completo-finanzas">
<span class="header-section-number">6.4.1</span> 1. <strong>Pipeline Completo: Finanzas</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Pipeline complejo que combina non-equi y rolling joins</span></span>
<span><span class="co"># Paso a paso para facilitar el debugging</span></span>
<span><span class="va">step1</span> <span class="op">&lt;-</span> <span class="va">operaciones_trading</span><span class="op">[</span></span>
<span>  <span class="co"># 1. Rolling join para obtener precios históricos</span></span>
<span>  <span class="va">precios_historicos</span>, on <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">ticker</span>, fecha_operacion <span class="op">=</span> <span class="va">fecha</span><span class="op">)</span>, roll <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">]</span><span class="op">[</span></span>
<span>  <span class="co"># 2. Filtrar solo operaciones con precio disponible</span></span>
<span>  <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">precio_cierre</span><span class="op">)</span></span>
<span><span class="op">]</span><span class="op">[</span></span>
<span>  <span class="co"># 3. Calcular métricas de trading</span></span>
<span>  , <span class="fu">`:=`</span><span class="op">(</span></span>
<span>    diferencia_precio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">precio_limite</span> <span class="op">-</span> <span class="va">precio_cierre</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    ratio_precio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">precio_limite</span> <span class="op">/</span> <span class="va">precio_cierre</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>    valor_operacion <span class="op">=</span> <span class="va">precio_limite</span> <span class="op">*</span> <span class="va">cantidad</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Verificar columnas antes del non-equi join</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Columnas disponibles antes del non-equi join:"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">step1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">step2</span> <span class="op">&lt;-</span> <span class="va">step1</span><span class="op">[</span></span>
<span>  <span class="co"># 4. Non-equi join con eventos de mercado para ventanas temporales</span></span>
<span>  <span class="va">eventos_mercado</span>, </span>
<span>  on <span class="op">=</span> <span class="fu">.</span><span class="op">(</span>ticker <span class="op">=</span> <span class="va">ticker_afectado</span>,</span>
<span>         <span class="va">fecha_operacion</span> <span class="op">&gt;=</span> <span class="va">fecha_inicio_ventana</span>,</span>
<span>         <span class="va">fecha_operacion</span> <span class="op">&lt;=</span> <span class="va">fecha_fin_ventana</span><span class="op">)</span>,</span>
<span>  allow.cartesian <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Verificar columnas después del non-equi join</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Columnas disponibles después del non-equi join:"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">step2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Determinar qué columna usar para ticker en la agrupación</span></span>
<span><span class="va">ticker_col</span> <span class="op">&lt;-</span> <span class="kw">if</span><span class="op">(</span><span class="st">"ticker_afectado"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">step2</span><span class="op">)</span><span class="op">)</span> <span class="st">"ticker_afectado"</span> <span class="kw">else</span> <span class="st">"ticker"</span></span>
<span></span>
<span><span class="co"># 5. Agregar análisis por evento</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="st">"ticker_afectado"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">step2</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pipeline_financiero</span> <span class="op">&lt;-</span> <span class="va">step2</span><span class="op">[</span></span>
<span>    , <span class="fu">.</span><span class="op">(</span></span>
<span>      operaciones_en_ventana <span class="op">=</span> <span class="va">.N</span>,</span>
<span>      valor_total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">valor_operacion</span><span class="op">)</span>,</span>
<span>      precio_promedio_limite <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">precio_limite</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>      precio_promedio_mercado <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">precio_cierre</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>      spread_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">diferencia_precio</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>      operaciones_compra <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">tipo</span> <span class="op">==</span> <span class="st">"COMPRA"</span><span class="op">)</span>,</span>
<span>      operaciones_venta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">tipo</span> <span class="op">==</span> <span class="st">"VENTA"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">evento_id</span>, <span class="va">tipo_evento</span>, <span class="va">ticker_afectado</span>, <span class="va">impacto_esperado</span><span class="op">)</span></span>
<span>  <span class="op">]</span><span class="op">[</span></span>
<span>    <span class="va">operaciones_en_ventana</span> <span class="op">&gt;=</span> <span class="fl">3</span>  <span class="co"># Solo eventos con suficiente actividad</span></span>
<span>  <span class="op">]</span><span class="op">[</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">valor_total</span><span class="op">)</span></span>
<span>  <span class="op">]</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="co"># Usar ticker en lugar de ticker_afectado</span></span>
<span>  <span class="va">pipeline_financiero</span> <span class="op">&lt;-</span> <span class="va">step2</span><span class="op">[</span></span>
<span>    , <span class="fu">.</span><span class="op">(</span></span>
<span>      operaciones_en_ventana <span class="op">=</span> <span class="va">.N</span>,</span>
<span>      valor_total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">valor_operacion</span><span class="op">)</span>,</span>
<span>      precio_promedio_limite <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">precio_limite</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>      precio_promedio_mercado <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">precio_cierre</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>      spread_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">diferencia_precio</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>      operaciones_compra <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">tipo</span> <span class="op">==</span> <span class="st">"COMPRA"</span><span class="op">)</span>,</span>
<span>      operaciones_venta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">tipo</span> <span class="op">==</span> <span class="st">"VENTA"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">evento_id</span>, <span class="va">tipo_evento</span>, <span class="va">ticker</span>, <span class="va">impacto_esperado</span><span class="op">)</span></span>
<span>  <span class="op">]</span><span class="op">[</span></span>
<span>    <span class="va">operaciones_en_ventana</span> <span class="op">&gt;=</span> <span class="fl">3</span>  <span class="co"># Solo eventos con suficiente actividad</span></span>
<span>  <span class="op">]</span><span class="op">[</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">valor_total</span><span class="op">)</span></span>
<span>  <span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Análisis de trading en ventanas de eventos:"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">pipeline_financiero</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># # Crear tabla interactiva del análisis (comentado para PDF)</span></span>
<span><span class="co"># DT::datatable(</span></span>
<span><span class="co">#   pipeline_financiero,</span></span>
<span><span class="co">#   caption = "Análisis de Trading en Ventanas de Eventos de Mercado",</span></span>
<span><span class="co">#   options = list(pageLength = 8, scrollX = TRUE)</span></span>
<span><span class="co"># ) %&gt;%</span></span>
<span><span class="co">#   DT::formatCurrency("valor_total", currency = "$") %&gt;%</span></span>
<span><span class="co">#   DT::formatRound(c("precio_promedio_limite", "precio_promedio_mercado", "spread_promedio"), digits = 2)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="pipeline-médico-avanzado" class="level3" data-number="6.4.2"><h3 data-number="6.4.2" class="anchored" data-anchor-id="pipeline-médico-avanzado">
<span class="header-section-number">6.4.2</span> 2. <strong>Pipeline Médico Avanzado</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Pipeline médico combinando múltiples non-equi joins</span></span>
<span><span class="va">evaluacion_medica_completa</span> <span class="op">&lt;-</span> <span class="va">pacientes_clinica</span><span class="op">[</span></span>
<span>  <span class="co"># Añadir columna de edad en décadas para agrupación</span></span>
<span>  , <span class="va">decada</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="va">edad</span><span class="op">/</span><span class="fl">10</span><span class="op">)</span><span class="op">*</span><span class="fl">10</span>, <span class="st">"s"</span><span class="op">)</span></span>
<span><span class="op">]</span><span class="op">[</span></span>
<span>  <span class="co"># 1. Clasificar por IMC</span></span>
<span>  <span class="va">rangos_medicos</span><span class="op">[</span><span class="va">parametro</span> <span class="op">==</span> <span class="st">"IMC"</span><span class="op">]</span>, </span>
<span>  on <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">imc</span> <span class="op">&gt;=</span> <span class="va">valor_min</span>, <span class="va">imc</span> <span class="op">&lt;=</span> <span class="va">valor_max</span><span class="op">)</span>,</span>
<span>  <span class="fu">.</span><span class="op">(</span><span class="va">paciente_id</span>, <span class="va">nombre</span>, <span class="va">edad</span>, <span class="va">decada</span>, <span class="va">peso</span>, <span class="va">altura</span>, <span class="va">imc</span>, </span>
<span>    categoria_imc <span class="op">=</span> <span class="va">categoria</span>, riesgo_imc <span class="op">=</span> <span class="va">nivel_riesgo</span>,</span>
<span>    <span class="va">glucosa</span>, <span class="va">presion_sistolica</span>, <span class="va">colesterol</span><span class="op">)</span></span>
<span><span class="op">]</span><span class="op">[</span></span>
<span>  <span class="co"># 2. Clasificar por glucosa  </span></span>
<span>  <span class="va">rangos_medicos</span><span class="op">[</span><span class="va">parametro</span> <span class="op">==</span> <span class="st">"Glucosa"</span><span class="op">]</span>,</span>
<span>  on <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">glucosa</span> <span class="op">&gt;=</span> <span class="va">valor_min</span>, <span class="va">glucosa</span> <span class="op">&lt;=</span> <span class="va">valor_max</span><span class="op">)</span>,</span>
<span>  <span class="fu">.</span><span class="op">(</span><span class="va">paciente_id</span>, <span class="va">nombre</span>, <span class="va">edad</span>, <span class="va">decada</span>, <span class="va">peso</span>, <span class="va">altura</span>, <span class="va">imc</span>, </span>
<span>    <span class="va">categoria_imc</span>, <span class="va">riesgo_imc</span>, <span class="va">glucosa</span>,</span>
<span>    categoria_glucosa <span class="op">=</span> <span class="va">i.categoria</span>, riesgo_glucosa <span class="op">=</span> <span class="va">i.nivel_riesgo</span>,</span>
<span>    <span class="va">presion_sistolica</span>, <span class="va">colesterol</span><span class="op">)</span></span>
<span><span class="op">]</span><span class="op">[</span></span>
<span>  <span class="co"># 3. Clasificar por presión</span></span>
<span>  <span class="va">rangos_medicos</span><span class="op">[</span><span class="va">parametro</span> <span class="op">==</span> <span class="st">"Presión"</span><span class="op">]</span>,</span>
<span>  on <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">presion_sistolica</span> <span class="op">&gt;=</span> <span class="va">valor_min</span>, <span class="va">presion_sistolica</span> <span class="op">&lt;=</span> <span class="va">valor_max</span><span class="op">)</span>,</span>
<span>  <span class="fu">.</span><span class="op">(</span><span class="va">paciente_id</span>, <span class="va">nombre</span>, <span class="va">edad</span>, <span class="va">decada</span>, <span class="va">peso</span>, <span class="va">altura</span>, <span class="va">imc</span>,</span>
<span>    <span class="va">categoria_imc</span>, <span class="va">riesgo_imc</span>, <span class="va">glucosa</span>, <span class="va">categoria_glucosa</span>, <span class="va">riesgo_glucosa</span>,</span>
<span>    <span class="va">presion_sistolica</span>, categoria_presion <span class="op">=</span> <span class="va">i.categoria</span>, riesgo_presion <span class="op">=</span> <span class="va">i.nivel_riesgo</span>,</span>
<span>    <span class="va">colesterol</span><span class="op">)</span></span>
<span><span class="op">]</span><span class="op">[</span></span>
<span>  <span class="co"># 4. Calcular score de riesgo compuesto</span></span>
<span>  , <span class="fu">`:=`</span><span class="op">(</span></span>
<span>    factores_riesgo_alto <span class="op">=</span> <span class="op">(</span><span class="va">riesgo_imc</span> <span class="op">==</span> <span class="st">"Alto"</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">riesgo_glucosa</span> <span class="op">==</span> <span class="st">"Alto"</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">riesgo_presion</span> <span class="op">==</span> <span class="st">"Alto"</span><span class="op">)</span>,</span>
<span>    factores_riesgo_total <span class="op">=</span> <span class="fl">3</span>,</span>
<span>    score_riesgo <span class="op">=</span> <span class="op">(</span></span>
<span>      <span class="op">(</span><span class="va">riesgo_imc</span> <span class="op">==</span> <span class="st">"Alto"</span><span class="op">)</span> <span class="op">*</span> <span class="fl">3</span> <span class="op">+</span> <span class="op">(</span><span class="va">riesgo_imc</span> <span class="op">==</span> <span class="st">"Normal"</span><span class="op">)</span> <span class="op">*</span> <span class="fl">1</span> <span class="op">+</span></span>
<span>      <span class="op">(</span><span class="va">riesgo_glucosa</span> <span class="op">==</span> <span class="st">"Alto"</span><span class="op">)</span> <span class="op">*</span> <span class="fl">3</span> <span class="op">+</span> <span class="op">(</span><span class="va">riesgo_glucosa</span> <span class="op">==</span> <span class="st">"Normal"</span><span class="op">)</span> <span class="op">*</span> <span class="fl">1</span> <span class="op">+</span></span>
<span>      <span class="op">(</span><span class="va">riesgo_presion</span> <span class="op">==</span> <span class="st">"Alto"</span><span class="op">)</span> <span class="op">*</span> <span class="fl">3</span> <span class="op">+</span> <span class="op">(</span><span class="va">riesgo_presion</span> <span class="op">==</span> <span class="st">"Normal"</span><span class="op">)</span> <span class="op">*</span> <span class="fl">1</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">]</span><span class="op">[</span></span>
<span>  <span class="co"># 5. Clasificación final de riesgo</span></span>
<span>  , <span class="va">clasificacion_final</span> <span class="op">:=</span> <span class="fu">fcase</span><span class="op">(</span></span>
<span>    <span class="va">factores_riesgo_alto</span> <span class="op">&gt;=</span> <span class="fl">2</span>, <span class="st">"Paciente Alto Riesgo - Seguimiento Inmediato"</span>,</span>
<span>    <span class="va">factores_riesgo_alto</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">"Paciente Riesgo Moderado - Seguimiento Regular"</span>, </span>
<span>    <span class="va">score_riesgo</span> <span class="op">&gt;=</span> <span class="fl">6</span>, <span class="st">"Paciente Bajo Riesgo - Seguimiento Rutinario"</span>,</span>
<span>    default <span class="op">=</span> <span class="st">"Paciente Muy Bajo Riesgo - Seguimiento Anual"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">]</span><span class="op">[</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">score_riesgo</span><span class="op">)</span></span>
<span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Resumen por grupo de edad</span></span>
<span><span class="va">resumen_por_decada</span> <span class="op">&lt;-</span> <span class="va">evaluacion_medica_completa</span><span class="op">[</span>,</span>
<span>  <span class="fu">.</span><span class="op">(</span></span>
<span>    pacientes <span class="op">=</span> <span class="va">.N</span>,</span>
<span>    edad_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">edad</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    imc_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">imc</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    alto_riesgo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">factores_riesgo_alto</span> <span class="op">&gt;=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>    riesgo_moderado <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">factores_riesgo_alto</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>    bajo_riesgo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">factores_riesgo_alto</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>    score_riesgo_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">score_riesgo</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span>, by <span class="op">=</span> <span class="va">decada</span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">decada</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Resumen de evaluación médica por década:"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">resumen_por_decada</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"\nPacientes de mayor riesgo:"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">evaluacion_medica_completa</span><span class="op">[</span><span class="va">factores_riesgo_alto</span> <span class="op">&gt;=</span> <span class="fl">2</span>, </span>
<span>                                     <span class="fu">.</span><span class="op">(</span><span class="va">nombre</span>, <span class="va">edad</span>, <span class="va">factores_riesgo_alto</span>, <span class="va">score_riesgo</span>, <span class="va">clasificacion_final</span><span class="op">)</span><span class="op">]</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="ejercicios-prácticos" class="level2" data-number="6.5"><h2 data-number="6.5" class="anchored" data-anchor-id="ejercicios-prácticos">
<span class="header-section-number">6.5</span> Ejercicios Prácticos</h2>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
🏋️ Ejercicio 10: Sistema de Alertas de Trading
</div>
</div>
<div class="callout-body-container callout-body">
<p>Usando los datasets de precios y operaciones:</p>
<ol type="1">
<li>
<strong>Rolling join</strong> para obtener precios en tiempo real</li>
<li>
<strong>Non-equi join</strong> para identificar operaciones en rangos de volatilidad alta</li>
<li>
<strong>Update join</strong> para calcular PnL potencial</li>
<li>
<strong>Crear sistema de alertas</strong> basado en múltiples condiciones</li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
💡 Solución del Ejercicio 10
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Sistema completo de alertas de trading</span></span>
<span><span class="co"># 1. Calcular volatilidad histórica</span></span>
<span><span class="va">volatilidad_historica</span> <span class="op">&lt;-</span> <span class="va">precios_historicos</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">ticker</span>, <span class="va">fecha</span><span class="op">)</span><span class="op">]</span><span class="op">[</span>,</span>
<span>  <span class="fu">.</span><span class="op">(</span><span class="va">fecha</span>, volatilidad_10d <span class="op">=</span> <span class="fu">frollapply</span><span class="op">(</span><span class="va">precio_cierre</span>, <span class="fl">10</span>, <span class="va">sd</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  by <span class="op">=</span> <span class="va">ticker</span><span class="op">]</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">volatilidad_10d</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># 2. Definir rangos de volatilidad para non-equi join</span></span>
<span><span class="va">rangos_volatilidad</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="op">(</span></span>
<span>  nivel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Baja"</span>, <span class="st">"Media"</span>, <span class="st">"Alta"</span>, <span class="st">"Extrema"</span><span class="op">)</span>,</span>
<span>  vol_min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span>, <span class="fl">15</span>, <span class="fl">30</span><span class="op">)</span>,</span>
<span>  vol_max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">15</span>, <span class="fl">30</span>, <span class="cn">Inf</span><span class="op">)</span>,</span>
<span>  factor_riesgo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. Pipeline completo del sistema de alertas</span></span>
<span><span class="va">sistema_alertas</span> <span class="op">&lt;-</span> <span class="va">operaciones_trading</span><span class="op">[</span></span>
<span>  <span class="co"># Rolling join con precios históricos</span></span>
<span>  <span class="va">precios_historicos</span>, on <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">ticker</span>, fecha_operacion <span class="op">=</span> <span class="va">fecha</span><span class="op">)</span>, roll <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">]</span><span class="op">[</span></span>
<span>  <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">precio_cierre</span><span class="op">)</span>  <span class="co"># Solo operaciones con precio disponible</span></span>
<span><span class="op">]</span><span class="op">[</span></span>
<span>  <span class="co"># Rolling join con volatilidad</span></span>
<span>  <span class="va">volatilidad_historica</span>, on <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">ticker</span>, fecha_operacion <span class="op">=</span> <span class="va">fecha</span><span class="op">)</span>, roll <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">]</span><span class="op">[</span></span>
<span>  <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">volatilidad_10d</span><span class="op">)</span>  <span class="co"># Solo con volatilidad calculada</span></span>
<span><span class="op">]</span><span class="op">[</span></span>
<span>  <span class="co"># Non-equi join para clasificar por volatilidad</span></span>
<span>  <span class="va">rangos_volatilidad</span>, on <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">volatilidad_10d</span> <span class="op">&gt;=</span> <span class="va">vol_min</span>, <span class="va">volatilidad_10d</span> <span class="op">&lt;=</span> <span class="va">vol_max</span><span class="op">)</span>,</span>
<span>  <span class="fu">.</span><span class="op">(</span><span class="va">operacion_id</span>, <span class="va">ticker</span>, <span class="va">fecha_operacion</span>, <span class="va">tipo</span>, <span class="va">cantidad</span>, <span class="va">precio_limite</span>, <span class="va">precio_cierre</span>,</span>
<span>    <span class="va">volatilidad_10d</span>, nivel_volatilidad <span class="op">=</span> <span class="va">nivel</span>, <span class="va">factor_riesgo</span><span class="op">)</span></span>
<span><span class="op">]</span><span class="op">[</span></span>
<span>  <span class="co"># 4. Calcular métricas de riesgo y PnL potencial</span></span>
<span>  , <span class="fu">`:=`</span><span class="op">(</span></span>
<span>    diferencia_precio <span class="op">=</span> <span class="va">precio_limite</span> <span class="op">-</span> <span class="va">precio_cierre</span>,</span>
<span>    pnl_potencial_pct <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="op">(</span><span class="va">precio_limite</span> <span class="op">-</span> <span class="va">precio_cierre</span><span class="op">)</span> <span class="op">/</span> <span class="va">precio_cierre</span> <span class="op">*</span> <span class="fl">100</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    valor_operacion <span class="op">=</span> <span class="va">precio_limite</span> <span class="op">*</span> <span class="va">cantidad</span>,</span>
<span>    riesgo_volatilidad <span class="op">=</span> <span class="va">volatilidad_10d</span> <span class="op">*</span> <span class="va">factor_riesgo</span>,</span>
<span>    spread_pct <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">precio_limite</span> <span class="op">-</span> <span class="va">precio_cierre</span><span class="op">)</span> <span class="op">/</span> <span class="va">precio_cierre</span> <span class="op">*</span> <span class="fl">100</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">]</span><span class="op">[</span></span>
<span>  <span class="co"># 5. Sistema de alertas basado en múltiples condiciones</span></span>
<span>  , <span class="va">alerta_tipo</span> <span class="op">:=</span> <span class="fu">fcase</span><span class="op">(</span></span>
<span>    <span class="co"># Alerta crítica: alta volatilidad + spread alto + operación grande</span></span>
<span>    <span class="va">nivel_volatilidad</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Alta"</span>, <span class="st">"Extrema"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">spread_pct</span> <span class="op">&gt;</span> <span class="fl">5</span> <span class="op">&amp;</span> <span class="va">valor_operacion</span> <span class="op">&gt;</span> <span class="fl">100000</span>,</span>
<span>    <span class="st">"CRÍTICA - Alta Volatilidad + Spread Alto + Volumen Alto"</span>,</span>
<span>    </span>
<span>    <span class="co"># Alerta alta: precio muy diferente del mercado</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">pnl_potencial_pct</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">10</span> <span class="op">&amp;</span> <span class="va">valor_operacion</span> <span class="op">&gt;</span> <span class="fl">50000</span>,</span>
<span>    <span class="st">"ALTA - Precio Fuera de Rango + Volumen Significativo"</span>,</span>
<span>    </span>
<span>    <span class="co"># Alerta media: volatilidad alta</span></span>
<span>    <span class="va">nivel_volatilidad</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Alta"</span>, <span class="st">"Extrema"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">valor_operacion</span> <span class="op">&gt;</span> <span class="fl">25000</span>,</span>
<span>    <span class="st">"MEDIA - Alta Volatilidad"</span>,</span>
<span>    </span>
<span>    <span class="co"># Alerta baja: spread moderado</span></span>
<span>    <span class="va">spread_pct</span> <span class="op">&gt;</span> <span class="fl">3</span> <span class="op">&amp;</span> <span class="va">valor_operacion</span> <span class="op">&gt;</span> <span class="fl">10000</span>,</span>
<span>    <span class="st">"BAJA - Spread Moderado"</span>,</span>
<span>    </span>
<span>    default <span class="op">=</span> <span class="st">"SIN ALERTA"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">]</span><span class="op">[</span></span>
<span>  <span class="co"># 6. Filtrar solo operaciones con alertas</span></span>
<span>  <span class="va">alerta_tipo</span> <span class="op">!=</span> <span class="st">"SIN ALERTA"</span></span>
<span><span class="op">]</span><span class="op">[</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">riesgo_volatilidad</span>, <span class="op">-</span><span class="va">valor_operacion</span><span class="op">)</span></span>
<span><span class="op">]</span><span class="op">[</span></span>
<span>  <span class="co"># 7. Agregar prioridad numérica para ordenamiento</span></span>
<span>  , <span class="va">prioridad</span> <span class="op">:=</span> <span class="fu">fcase</span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"CRÍTICA"</span>, <span class="va">alerta_tipo</span><span class="op">)</span>, <span class="fl">1</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"ALTA"</span>, <span class="va">alerta_tipo</span><span class="op">)</span>, <span class="fl">2</span>, </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"MEDIA"</span>, <span class="va">alerta_tipo</span><span class="op">)</span>, <span class="fl">3</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"BAJA"</span>, <span class="va">alerta_tipo</span><span class="op">)</span>, <span class="fl">4</span>,</span>
<span>    default <span class="op">=</span> <span class="fl">5</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">]</span><span class="op">[</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">prioridad</span>, <span class="op">-</span><span class="va">valor_operacion</span><span class="op">)</span></span>
<span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Dashboard de alertas</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"🚨 SISTEMA DE ALERTAS DE TRADING 🚨\n\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; 🚨 SISTEMA DE ALERTAS DE TRADING 🚨</span></span>
<span></span>
<span><span class="co"># Resumen por tipo de alerta</span></span>
<span><span class="va">resumen_alertas</span> <span class="op">&lt;-</span> <span class="va">sistema_alertas</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>  operaciones <span class="op">=</span> <span class="va">.N</span>,</span>
<span>  valor_total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">valor_operacion</span><span class="op">)</span>,</span>
<span>  volatilidad_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">volatilidad_10d</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  spread_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">spread_pct</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">alerta_tipo</span>, <span class="va">prioridad</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">prioridad</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"RESUMEN DE ALERTAS:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "RESUMEN DE ALERTAS:"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">resumen_alertas</span><span class="op">)</span></span>
<span><span class="co">#&gt;                                                alerta_tipo prioridad</span></span>
<span><span class="co">#&gt;                                                     &lt;char&gt;     &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: CRÍTICA - Alta Volatilidad + Spread Alto + Volumen Alto         1</span></span>
<span><span class="co">#&gt; 2:    ALTA - Precio Fuera de Rango + Volumen Significativo         2</span></span>
<span><span class="co">#&gt; 3:                                MEDIA - Alta Volatilidad         3</span></span>
<span><span class="co">#&gt; 4:                                  BAJA - Spread Moderado         4</span></span>
<span><span class="co">#&gt;    operaciones valor_total volatilidad_promedio spread_promedio</span></span>
<span><span class="co">#&gt;          &lt;int&gt;       &lt;num&gt;                &lt;num&gt;           &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:          61    41874580                16.23          319.11</span></span>
<span><span class="co">#&gt; 2:         197   100551879                 5.58          500.71</span></span>
<span><span class="co">#&gt; 3:          10      353714                15.00          116.39</span></span>
<span><span class="co">#&gt; 4:          59     7979808                 6.78          172.47</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\n📊 TOP 10 OPERACIONES DE MAYOR RIESGO:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 📊 TOP 10 OPERACIONES DE MAYOR RIESGO:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">sistema_alertas</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>  Ticker <span class="op">=</span> <span class="va">ticker</span>, </span>
<span>  Tipo <span class="op">=</span> <span class="va">tipo</span>,</span>
<span>  Valor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"$"</span>, <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="va">valor_operacion</span>, big.mark <span class="op">=</span> <span class="st">","</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  Spread <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">spread_pct</span>, <span class="st">"%"</span><span class="op">)</span>,</span>
<span>  Volatilidad <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">volatilidad_10d</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  Alerta <span class="op">=</span> <span class="va">alerta_tipo</span></span>
<span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;     Ticker   Tipo      Valor  Spread Volatilidad</span></span>
<span><span class="co">#&gt;     &lt;char&gt; &lt;char&gt;     &lt;char&gt;  &lt;char&gt;      &lt;char&gt;</span></span>
<span><span class="co">#&gt;  1:   TSLA  VENTA $2,161,110 683.66%          15</span></span>
<span><span class="co">#&gt;  2:   TSLA  VENTA $2,161,110 680.32%          15</span></span>
<span><span class="co">#&gt;  3:   TSLA  VENTA $2,161,110 623.26%          15</span></span>
<span><span class="co">#&gt;  4:   TSLA  VENTA $2,161,110 518.59%          15</span></span>
<span><span class="co">#&gt;  5:   TSLA  VENTA $2,161,110 544.22%          15</span></span>
<span><span class="co">#&gt;  6:   TSLA  VENTA $2,161,110 514.93%          15</span></span>
<span><span class="co">#&gt;  7:  GOOGL COMPRA $1,463,000  47.18%          15</span></span>
<span><span class="co">#&gt;  8:  GOOGL COMPRA $1,463,000  46.66%          15</span></span>
<span><span class="co">#&gt;  9:  GOOGL COMPRA $1,463,000  47.21%          15</span></span>
<span><span class="co">#&gt; 10:   TSLA COMPRA $1,350,470  351.9%          15</span></span>
<span><span class="co">#&gt;                                                      Alerta</span></span>
<span><span class="co">#&gt;                                                      &lt;char&gt;</span></span>
<span><span class="co">#&gt;  1: CRÍTICA - Alta Volatilidad + Spread Alto + Volumen Alto</span></span>
<span><span class="co">#&gt;  2: CRÍTICA - Alta Volatilidad + Spread Alto + Volumen Alto</span></span>
<span><span class="co">#&gt;  3: CRÍTICA - Alta Volatilidad + Spread Alto + Volumen Alto</span></span>
<span><span class="co">#&gt;  4: CRÍTICA - Alta Volatilidad + Spread Alto + Volumen Alto</span></span>
<span><span class="co">#&gt;  5: CRÍTICA - Alta Volatilidad + Spread Alto + Volumen Alto</span></span>
<span><span class="co">#&gt;  6: CRÍTICA - Alta Volatilidad + Spread Alto + Volumen Alto</span></span>
<span><span class="co">#&gt;  7: CRÍTICA - Alta Volatilidad + Spread Alto + Volumen Alto</span></span>
<span><span class="co">#&gt;  8: CRÍTICA - Alta Volatilidad + Spread Alto + Volumen Alto</span></span>
<span><span class="co">#&gt;  9: CRÍTICA - Alta Volatilidad + Spread Alto + Volumen Alto</span></span>
<span><span class="co">#&gt; 10: CRÍTICA - Alta Volatilidad + Spread Alto + Volumen Alto</span></span>
<span></span>
<span><span class="co"># # Crear tabla interactiva (comentado para PDF)</span></span>
<span><span class="co"># DT::datatable(</span></span>
<span><span class="co">#   sistema_alertas[1:20],</span></span>
<span><span class="co">#   caption = "Sistema de Alertas de Trading - Top 20 Operaciones de Riesgo",</span></span>
<span><span class="co">#   options = list(pageLength = 10, scrollX = TRUE)</span></span>
<span><span class="co"># ) %&gt;%</span></span>
<span><span class="co">#   DT::formatCurrency("valor_operacion", currency = "$") %&gt;%</span></span>
<span><span class="co">#   DT::formatRound(c("volatilidad_10d", "spread_pct"), digits = 2) %&gt;%</span></span>
<span><span class="co">#   DT::formatStyle(</span></span>
<span><span class="co">#     "alerta_tipo",</span></span>
<span><span class="co">#     backgroundColor = DT::styleEqual(</span></span>
<span><span class="co">#       c("CRÍTICA - Alta Volatilidad + Spread Alto + Volumen Alto",</span></span>
<span><span class="co">#         "ALTA - Precio Fuera de Rango + Volumen Significativo", </span></span>
<span><span class="co">#         "MEDIA - Alta Volatilidad",</span></span>
<span><span class="co">#         "BAJA - Spread Moderado"),</span></span>
<span><span class="co">#       c("red", "orange", "yellow", "lightblue")</span></span>
<span><span class="co">#     )</span></span>
<span><span class="co">#   )</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section><section id="mejores-prácticas-para-joins-avanzados" class="level2" data-number="6.6"><h2 data-number="6.6" class="anchored" data-anchor-id="mejores-prácticas-para-joins-avanzados">
<span class="header-section-number">6.6</span> Mejores Prácticas para Joins Avanzados</h2>
<section id="performance-y-optimización" class="level3" data-number="6.6.1"><h3 data-number="6.6.1" class="anchored" data-anchor-id="performance-y-optimización">
<span class="header-section-number">6.6.1</span> 1. <strong>Performance y Optimización</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># ✅ HACER: Establecer keys antes de rolling joins repetitivos</span></span>
<span><span class="fu">setkey</span><span class="op">(</span><span class="va">tabla_temporal</span>, <span class="va">id</span>, <span class="va">timestamp</span><span class="op">)</span></span>
<span><span class="fu">setkey</span><span class="op">(</span><span class="va">tabla_eventos</span>, <span class="va">id</span>, <span class="va">fecha_evento</span><span class="op">)</span></span>
<span><span class="va">resultado</span> <span class="op">&lt;-</span> <span class="va">tabla_temporal</span><span class="op">[</span><span class="va">tabla_eventos</span>, roll <span class="op">=</span> <span class="cn">TRUE</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># ✅ HACER: Filtrar antes de joins complejos</span></span>
<span><span class="va">tabla_filtrada</span> <span class="op">&lt;-</span> <span class="va">tabla_grande</span><span class="op">[</span><span class="va">fecha</span> <span class="op">&gt;=</span> <span class="va">fecha_inicio</span> <span class="op">&amp;</span> <span class="va">fecha</span> <span class="op">&lt;=</span> <span class="va">fecha_fin</span><span class="op">]</span></span>
<span><span class="va">resultado</span> <span class="op">&lt;-</span> <span class="va">tabla_filtrada</span><span class="op">[</span><span class="va">otra_tabla</span>, on <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">columna</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># ✅ HACER: Usar nomatch = NULL para inner joins en non-equi</span></span>
<span><span class="va">resultado</span> <span class="op">&lt;-</span> <span class="va">tabla1</span><span class="op">[</span><span class="va">tabla2</span>, on <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">col1</span> <span class="op">&gt;=</span> <span class="va">min_val</span>, <span class="va">col1</span> <span class="op">&lt;=</span> <span class="va">max_val</span><span class="op">)</span>, nomatch <span class="op">=</span> <span class="cn">NULL</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># ❌ EVITAR: Non-equi joins sin filtros previos en tablas enormes</span></span>
<span><span class="co"># Puede generar productos cartesianos masivos</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="manejo-de-casos-edge" class="level3" data-number="6.6.2"><h3 data-number="6.6.2" class="anchored" data-anchor-id="manejo-de-casos-edge">
<span class="header-section-number">6.6.2</span> 2. <strong>Manejo de Casos Edge</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># ✅ HACER: Validar resultados de rolling joins</span></span>
<span><span class="va">resultado</span> <span class="op">&lt;-</span> <span class="va">tabla1</span><span class="op">[</span><span class="va">tabla2</span>, roll <span class="op">=</span> <span class="cn">TRUE</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Matches encontrados:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">resultado</span><span class="op">$</span><span class="va">columna_tabla1</span><span class="op">)</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Matches perdidos:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">resultado</span><span class="op">$</span><span class="va">columna_tabla1</span><span class="op">)</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ✅ HACER: Establecer límites razonables en rolling joins</span></span>
<span><span class="va">resultado</span> <span class="op">&lt;-</span> <span class="va">tabla1</span><span class="op">[</span><span class="va">tabla2</span>, roll <span class="op">=</span> <span class="fl">7</span><span class="op">]</span>  <span class="co"># máximo 7 unidades de tiempo</span></span>
<span></span>
<span><span class="co"># ✅ HACER: Verificar cartesian products en non-equi joins</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">resultado</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">tabla2</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/warning.html">warning</a></span><span class="op">(</span><span class="st">"Posible cartesian product no deseado"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
🎯 Puntos Clave de Este Capítulo
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>
<strong>Non-equi joins</strong> permiten uniones basadas en rangos y desigualdades - perfectos para clasificaciones médicas y financieras</li>
<li>
<strong>Rolling joins</strong> son esenciales para series temporales - conectan cada punto con el último valor disponible</li>
<li>
<strong>Combinar técnicas</strong> (non-equi + rolling + update) permite análisis muy sofisticados</li>
<li>
<strong>Performance</strong>: Establecer keys apropiadas es crucial para joins avanzados</li>
<li>
<strong>Validación</strong>: Siempre verificar resultados para evitar cartesian products no deseados</li>
<li>
<strong>Casos de uso reales</strong>: Finanzas, medicina, IoT - cualquier dominio con rangos temporales o de valores</li>
</ol>
</div>
</div>
<p>Los joins avanzados son herramientas poderosas que abren posibilidades analíticas únicas. En el próximo capítulo exploraremos las funciones especiales que complementan estos joins para análisis aún más sofisticados.</p>
<p><function_calls><invoke name="TodoWrite"><parameter name="todos">[{“content”: “Reorganizar M0f3dulo 1: dividir fundamentos en sintaxis y s0edmbolos”, “status”: “completed”, “id”: “1”}, {“content”: “Crear cap01-simbolos.qmd para s0edmbolos especiales del M0f3dulo 1”, “status”: “completed”, “id”: “1-new”}, {“content”: “Reorganizar M0f3dulo 2: dividir en encadenamiento y joins”, “status”: “completed”, “id”: “2”}, {“content”: “Crear cap03-joins-avanzados.qmd para joins avanzados del M0f3dulo 3”, “status”: “completed”, “id”: “3-1”}, {“content”: “Crear cap03-funciones-especiales.qmd para funciones especiales del M0f3dulo 3”, “status”: “in_progress”, “id”: “3-2”}, {“content”: “Crear cap03-reshape.qmd para reshape del M0f3dulo 3”, “status”: “pending”, “id”: “3-3”}, {“content”: “Reorganizar M0f3dulo 4: dividir en performance y buenas pr0e1cticas”, “status”: “pending”, “id”: “4”}, {“content”: “Reorganizar M0f3dulo 5: dividir en visualizaci0f3n y aplicaciones”, “status”: “pending”, “id”: “5”}]</parameter></invoke></function_calls></p>


<!-- -->

</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/tutorial-datatable\.github\.io\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./cap02-joins.html" class="pagination-link" aria-label="Uniones de Datos (Joins)">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Uniones de Datos (Joins)</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./cap03-funciones-especiales.html" class="pagination-link" aria-label="Funciones Especiales y Análisis Temporal">
        <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Funciones Especiales y Análisis Temporal</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb15" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Joins Avanzados: Non-Equi y Rolling Joins</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip icon="false"}</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="fu">## En este capítulo dominarás</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Non-equi joins**: Uniones basadas en rangos y desigualdades</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Rolling joins**: La herramienta perfecta para series temporales</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Update joins avanzados** con condiciones complejas</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Joins múltiples** con condiciones heterogéneas</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Casos de uso reales** en finanzas, medicina y análisis temporal</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup-cap03-joins-avanzados</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DT)</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Configuración</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">datatable.print.nrows =</span> <span class="dv">8</span>)</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">datatable.print.class =</span> <span class="cn">TRUE</span>)</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Datasets especializados para joins avanzados</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2024</span>)</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Dataset financiero para rolling joins</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>precios_historicos <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">fecha =</span> <span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">"2024-01-01"</span>), <span class="fu">as.Date</span>(<span class="st">"2024-12-31"</span>), <span class="at">by =</span> <span class="st">"day"</span>),</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">ticker =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"AAPL"</span>, <span class="st">"GOOGL"</span>, <span class="st">"MSFT"</span>, <span class="st">"TSLA"</span>, <span class="st">"AMZN"</span>), <span class="at">each =</span> <span class="dv">73</span>),</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">precio_cierre =</span> <span class="fu">round</span>(<span class="fu">c</span>(</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cumsum</span>(<span class="fu">rnorm</span>(<span class="dv">73</span>, <span class="fl">0.5</span>, <span class="dv">5</span>)) <span class="sc">+</span> <span class="dv">150</span>,  <span class="co"># AAPL trend alcista</span></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cumsum</span>(<span class="fu">rnorm</span>(<span class="dv">73</span>, <span class="fl">0.2</span>, <span class="dv">15</span>)) <span class="sc">+</span> <span class="dv">2800</span>, <span class="co"># GOOGL menos volátil</span></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cumsum</span>(<span class="fu">rnorm</span>(<span class="dv">73</span>, <span class="fl">0.3</span>, <span class="dv">8</span>)) <span class="sc">+</span> <span class="dv">350</span>,   <span class="co"># MSFT estable</span></span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cumsum</span>(<span class="fu">rnorm</span>(<span class="dv">73</span>, <span class="sc">-</span><span class="fl">0.1</span>, <span class="dv">20</span>)) <span class="sc">+</span> <span class="dv">200</span>, <span class="co"># TSLA bajista</span></span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cumsum</span>(<span class="fu">rnorm</span>(<span class="dv">73</span>, <span class="fl">0.4</span>, <span class="dv">12</span>)) <span class="sc">+</span> <span class="dv">120</span>   <span class="co"># AMZN moderado</span></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>  ), <span class="dv">2</span>),</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">volumen =</span> <span class="fu">round</span>(<span class="fu">runif</span>(<span class="dv">365</span>, <span class="dv">1000000</span>, <span class="dv">50000000</span>), <span class="dv">0</span>)</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>)[precio_cierre <span class="sc">&gt;</span> <span class="dv">0</span>]  <span class="co"># Asegurar precios positivos</span></span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Transacciones de trading para rolling joins</span></span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>operaciones_trading <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">operacion_id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">500</span>,</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>  <span class="at">ticker =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"AAPL"</span>, <span class="st">"GOOGL"</span>, <span class="st">"MSFT"</span>, <span class="st">"TSLA"</span>, <span class="st">"AMZN"</span>), <span class="dv">500</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">fecha_operacion =</span> <span class="fu">sample</span>(<span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">"2024-01-01"</span>), <span class="fu">as.Date</span>(<span class="st">"2024-12-31"</span>), <span class="at">by =</span> <span class="st">"day"</span>), <span class="dv">500</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>  <span class="at">tipo =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"COMPRA"</span>, <span class="st">"VENTA"</span>), <span class="dv">500</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.6</span>, <span class="fl">0.4</span>)),</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>  <span class="at">cantidad =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">200</span>, <span class="dv">500</span>, <span class="dv">1000</span>), <span class="dv">500</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>  <span class="at">precio_limite =</span> <span class="fu">round</span>(<span class="fu">runif</span>(<span class="dv">500</span>, <span class="dv">100</span>, <span class="dv">3000</span>), <span class="dv">2</span>),</span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>  <span class="at">trader_id =</span> <span class="fu">sample</span>(<span class="fu">paste0</span>(<span class="st">"T"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>), <span class="dv">500</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Dataset médico para non-equi joins</span></span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a>pacientes_clinica <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>  <span class="at">paciente_id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>,</span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>  <span class="at">nombre =</span> <span class="fu">paste0</span>(<span class="st">"Paciente_"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>),</span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>  <span class="at">edad =</span> <span class="fu">sample</span>(<span class="dv">18</span><span class="sc">:</span><span class="dv">85</span>, <span class="dv">100</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>  <span class="at">peso =</span> <span class="fu">round</span>(<span class="fu">rnorm</span>(<span class="dv">100</span>, <span class="dv">70</span>, <span class="dv">15</span>), <span class="dv">1</span>),</span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a>  <span class="at">altura =</span> <span class="fu">round</span>(<span class="fu">runif</span>(<span class="dv">100</span>, <span class="fl">1.50</span>, <span class="fl">1.95</span>), <span class="dv">2</span>),</span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a>  <span class="at">glucosa =</span> <span class="fu">round</span>(<span class="fu">runif</span>(<span class="dv">100</span>, <span class="dv">70</span>, <span class="dv">300</span>), <span class="dv">1</span>),</span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>  <span class="at">presion_sistolica =</span> <span class="fu">sample</span>(<span class="dv">90</span><span class="sc">:</span><span class="dv">200</span>, <span class="dv">100</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>  <span class="at">presion_diastolica =</span> <span class="fu">sample</span>(<span class="dv">60</span><span class="sc">:</span><span class="dv">110</span>, <span class="dv">100</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a>  <span class="at">colesterol =</span> <span class="fu">round</span>(<span class="fu">rnorm</span>(<span class="dv">100</span>, <span class="dv">200</span>, <span class="dv">50</span>), <span class="dv">0</span>),</span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a>  <span class="at">fecha_consulta =</span> <span class="fu">sample</span>(<span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">"2024-01-01"</span>), <span class="fu">as.Date</span>(<span class="st">"2024-12-31"</span>), <span class="at">by =</span> <span class="st">"day"</span>), <span class="dv">100</span>)</span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular IMC y asegurar tipos consistentes</span></span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a>pacientes_clinica[, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a>  <span class="at">imc =</span> <span class="fu">round</span>(peso <span class="sc">/</span> (altura<span class="sc">^</span><span class="dv">2</span>), <span class="dv">1</span>),</span>
<span id="cb15-73"><a href="#cb15-73" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convertir a numeric para consistencia con rangos_medicos</span></span>
<span id="cb15-74"><a href="#cb15-74" aria-hidden="true" tabindex="-1"></a>  <span class="at">glucosa =</span> <span class="fu">as.numeric</span>(glucosa),</span>
<span id="cb15-75"><a href="#cb15-75" aria-hidden="true" tabindex="-1"></a>  <span class="at">presion_sistolica =</span> <span class="fu">as.numeric</span>(presion_sistolica),</span>
<span id="cb15-76"><a href="#cb15-76" aria-hidden="true" tabindex="-1"></a>  <span class="at">presion_diastolica =</span> <span class="fu">as.numeric</span>(presion_diastolica),</span>
<span id="cb15-77"><a href="#cb15-77" aria-hidden="true" tabindex="-1"></a>  <span class="at">colesterol =</span> <span class="fu">as.numeric</span>(colesterol)</span>
<span id="cb15-78"><a href="#cb15-78" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb15-79"><a href="#cb15-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-80"><a href="#cb15-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Rangos de referencia médica para non-equi joins</span></span>
<span id="cb15-81"><a href="#cb15-81" aria-hidden="true" tabindex="-1"></a>rangos_medicos <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb15-82"><a href="#cb15-82" aria-hidden="true" tabindex="-1"></a>  <span class="at">parametro =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"IMC"</span>, <span class="st">"Glucosa"</span>, <span class="st">"Presión"</span>, <span class="st">"Colesterol"</span>), <span class="at">each =</span> <span class="dv">3</span>),</span>
<span id="cb15-83"><a href="#cb15-83" aria-hidden="true" tabindex="-1"></a>  <span class="at">valor_min =</span> <span class="fu">as.numeric</span>(<span class="fu">c</span>(</span>
<span id="cb15-84"><a href="#cb15-84" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, <span class="fl">18.5</span>, <span class="dv">25</span>,      <span class="co"># IMC: Bajo, Normal, Sobrepeso</span></span>
<span id="cb15-85"><a href="#cb15-85" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, <span class="dv">100</span>, <span class="dv">126</span>,      <span class="co"># Glucosa: Normal, Prediabetes, Diabetes  </span></span>
<span id="cb15-86"><a href="#cb15-86" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, <span class="dv">120</span>, <span class="dv">140</span>,      <span class="co"># Presión: Normal, Elevada, Hipertensión</span></span>
<span id="cb15-87"><a href="#cb15-87" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, <span class="dv">200</span>, <span class="dv">240</span>       <span class="co"># Colesterol: Deseable, Límite, Alto</span></span>
<span id="cb15-88"><a href="#cb15-88" aria-hidden="true" tabindex="-1"></a>  )),</span>
<span id="cb15-89"><a href="#cb15-89" aria-hidden="true" tabindex="-1"></a>  <span class="at">valor_max =</span> <span class="fu">as.numeric</span>(<span class="fu">c</span>(</span>
<span id="cb15-90"><a href="#cb15-90" aria-hidden="true" tabindex="-1"></a>    <span class="fl">18.4</span>, <span class="fl">24.9</span>, <span class="cn">Inf</span>,  <span class="co"># IMC</span></span>
<span id="cb15-91"><a href="#cb15-91" aria-hidden="true" tabindex="-1"></a>    <span class="dv">99</span>, <span class="dv">125</span>, <span class="cn">Inf</span>,     <span class="co"># Glucosa</span></span>
<span id="cb15-92"><a href="#cb15-92" aria-hidden="true" tabindex="-1"></a>    <span class="dv">119</span>, <span class="dv">139</span>, <span class="cn">Inf</span>,    <span class="co"># Presión</span></span>
<span id="cb15-93"><a href="#cb15-93" aria-hidden="true" tabindex="-1"></a>    <span class="dv">199</span>, <span class="dv">239</span>, <span class="cn">Inf</span>     <span class="co"># Colesterol</span></span>
<span id="cb15-94"><a href="#cb15-94" aria-hidden="true" tabindex="-1"></a>  )),</span>
<span id="cb15-95"><a href="#cb15-95" aria-hidden="true" tabindex="-1"></a>  <span class="at">categoria =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Bajo/Normal"</span>, <span class="st">"Normal/Óptimo"</span>, <span class="st">"Alto/Riesgo"</span>), <span class="dv">4</span>),</span>
<span id="cb15-96"><a href="#cb15-96" aria-hidden="true" tabindex="-1"></a>  <span class="at">nivel_riesgo =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Bajo"</span>, <span class="st">"Normal"</span>, <span class="st">"Alto"</span>), <span class="dv">4</span>)</span>
<span id="cb15-97"><a href="#cb15-97" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-98"><a href="#cb15-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-99"><a href="#cb15-99" aria-hidden="true" tabindex="-1"></a><span class="co"># Dataset de eventos para análisis temporal</span></span>
<span id="cb15-100"><a href="#cb15-100" aria-hidden="true" tabindex="-1"></a>eventos_mercado <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb15-101"><a href="#cb15-101" aria-hidden="true" tabindex="-1"></a>  <span class="at">evento_id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">15</span>,</span>
<span id="cb15-102"><a href="#cb15-102" aria-hidden="true" tabindex="-1"></a>  <span class="at">tipo_evento =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Earnings"</span>, <span class="st">"FDA_Approval"</span>, <span class="st">"Product_Launch"</span>, <span class="st">"Merger"</span>, <span class="st">"Split"</span>), <span class="dv">15</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb15-103"><a href="#cb15-103" aria-hidden="true" tabindex="-1"></a>  <span class="at">ticker_afectado =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"AAPL"</span>, <span class="st">"GOOGL"</span>, <span class="st">"MSFT"</span>, <span class="st">"TSLA"</span>, <span class="st">"AMZN"</span>), <span class="dv">15</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb15-104"><a href="#cb15-104" aria-hidden="true" tabindex="-1"></a>  <span class="at">fecha_evento =</span> <span class="fu">sample</span>(<span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">"2024-02-01"</span>), <span class="fu">as.Date</span>(<span class="st">"2024-11-30"</span>), <span class="at">by =</span> <span class="st">"week"</span>), <span class="dv">15</span>),</span>
<span id="cb15-105"><a href="#cb15-105" aria-hidden="true" tabindex="-1"></a>  <span class="at">impacto_esperado =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Positivo"</span>, <span class="st">"Negativo"</span>, <span class="st">"Neutro"</span>), <span class="dv">15</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.4</span>, <span class="fl">0.3</span>, <span class="fl">0.3</span>)),</span>
<span id="cb15-106"><a href="#cb15-106" aria-hidden="true" tabindex="-1"></a>  <span class="at">ventana_dias_pre =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">7</span>, <span class="dv">10</span>), <span class="dv">15</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb15-107"><a href="#cb15-107" aria-hidden="true" tabindex="-1"></a>  <span class="at">ventana_dias_post =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">7</span>, <span class="dv">10</span>, <span class="dv">15</span>), <span class="dv">15</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb15-108"><a href="#cb15-108" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-109"><a href="#cb15-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-110"><a href="#cb15-110" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular ventanas de tiempo</span></span>
<span id="cb15-111"><a href="#cb15-111" aria-hidden="true" tabindex="-1"></a>eventos_mercado[, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb15-112"><a href="#cb15-112" aria-hidden="true" tabindex="-1"></a>  <span class="at">fecha_inicio_ventana =</span> fecha_evento <span class="sc">-</span> ventana_dias_pre,</span>
<span id="cb15-113"><a href="#cb15-113" aria-hidden="true" tabindex="-1"></a>  <span class="at">fecha_fin_ventana =</span> fecha_evento <span class="sc">+</span> ventana_dias_post</span>
<span id="cb15-114"><a href="#cb15-114" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb15-115"><a href="#cb15-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-116"><a href="#cb15-116" aria-hidden="true" tabindex="-1"></a><span class="co"># Dataset de sensores IoT para rolling joins temporales</span></span>
<span id="cb15-117"><a href="#cb15-117" aria-hidden="true" tabindex="-1"></a>sensores_iot <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb15-118"><a href="#cb15-118" aria-hidden="true" tabindex="-1"></a>  <span class="at">timestamp =</span> <span class="fu">seq</span>(<span class="fu">as.POSIXct</span>(<span class="st">"2024-01-01 00:00:00"</span>), </span>
<span id="cb15-119"><a href="#cb15-119" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">as.POSIXct</span>(<span class="st">"2024-01-07 23:59:59"</span>), </span>
<span id="cb15-120"><a href="#cb15-120" aria-hidden="true" tabindex="-1"></a>                 <span class="at">by =</span> <span class="st">"15 min"</span>),</span>
<span id="cb15-121"><a href="#cb15-121" aria-hidden="true" tabindex="-1"></a>  <span class="at">sensor_id =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"TEMP_01"</span>, <span class="st">"TEMP_02"</span>, <span class="st">"HUMID_01"</span>, <span class="st">"PRESSURE_01"</span>), <span class="at">length.out =</span> <span class="dv">672</span>),</span>
<span id="cb15-122"><a href="#cb15-122" aria-hidden="true" tabindex="-1"></a>  <span class="at">valor =</span> <span class="fu">round</span>(<span class="fu">c</span>(</span>
<span id="cb15-123"><a href="#cb15-123" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rnorm</span>(<span class="dv">168</span>, <span class="dv">22</span>, <span class="dv">3</span>),    <span class="co"># TEMP_01</span></span>
<span id="cb15-124"><a href="#cb15-124" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rnorm</span>(<span class="dv">168</span>, <span class="dv">24</span>, <span class="fl">2.5</span>),  <span class="co"># TEMP_02  </span></span>
<span id="cb15-125"><a href="#cb15-125" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rnorm</span>(<span class="dv">168</span>, <span class="dv">65</span>, <span class="dv">10</span>),   <span class="co"># HUMID_01</span></span>
<span id="cb15-126"><a href="#cb15-126" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rnorm</span>(<span class="dv">168</span>, <span class="dv">1013</span>, <span class="dv">15</span>)  <span class="co"># PRESSURE_01</span></span>
<span id="cb15-127"><a href="#cb15-127" aria-hidden="true" tabindex="-1"></a>  ), <span class="dv">2</span>),</span>
<span id="cb15-128"><a href="#cb15-128" aria-hidden="true" tabindex="-1"></a>  <span class="at">ubicacion =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Planta_A"</span>, <span class="st">"Planta_A"</span>, <span class="st">"Planta_B"</span>, <span class="st">"Planta_B"</span>), <span class="at">length.out =</span> <span class="dv">672</span>)</span>
<span id="cb15-129"><a href="#cb15-129" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-130"><a href="#cb15-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-131"><a href="#cb15-131" aria-hidden="true" tabindex="-1"></a><span class="co"># Eventos de mantenimiento para rolling joins</span></span>
<span id="cb15-132"><a href="#cb15-132" aria-hidden="true" tabindex="-1"></a>mantenimiento <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb15-133"><a href="#cb15-133" aria-hidden="true" tabindex="-1"></a>  <span class="at">mantenimiento_id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>,</span>
<span id="cb15-134"><a href="#cb15-134" aria-hidden="true" tabindex="-1"></a>  <span class="at">sensor_id =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"TEMP_01"</span>, <span class="st">"TEMP_02"</span>, <span class="st">"HUMID_01"</span>, <span class="st">"PRESSURE_01"</span>), <span class="dv">20</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb15-135"><a href="#cb15-135" aria-hidden="true" tabindex="-1"></a>  <span class="at">fecha_mantenimiento =</span> <span class="fu">sample</span>(<span class="fu">seq</span>(<span class="fu">as.POSIXct</span>(<span class="st">"2024-01-01 08:00:00"</span>), </span>
<span id="cb15-136"><a href="#cb15-136" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">as.POSIXct</span>(<span class="st">"2024-01-07 18:00:00"</span>), </span>
<span id="cb15-137"><a href="#cb15-137" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">by =</span> <span class="st">"6 hour"</span>), <span class="dv">20</span>),</span>
<span id="cb15-138"><a href="#cb15-138" aria-hidden="true" tabindex="-1"></a>  <span class="at">tipo_mantenimiento =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Calibracion"</span>, <span class="st">"Limpieza"</span>, <span class="st">"Reemplazo"</span>), <span class="dv">20</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb15-139"><a href="#cb15-139" aria-hidden="true" tabindex="-1"></a>  <span class="at">duracion_horas =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">4</span>), <span class="dv">20</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb15-140"><a href="#cb15-140" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-141"><a href="#cb15-141" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-142"><a href="#cb15-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-143"><a href="#cb15-143" aria-hidden="true" tabindex="-1"></a><span class="fu">## Non-Equi Joins: Más Allá de la Igualdad</span></span>
<span id="cb15-144"><a href="#cb15-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-145"><a href="#cb15-145" aria-hidden="true" tabindex="-1"></a>Los non-equi joins permiten unir tablas basándose en rangos, desigualdades y condiciones complejas. Son especialmente útiles en análisis médico, financiero y clasificación por rangos.</span>
<span id="cb15-146"><a href="#cb15-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-147"><a href="#cb15-147" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1. **Conceptos Fundamentales**</span></span>
<span id="cb15-148"><a href="#cb15-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-149"><a href="#cb15-149" aria-hidden="true" tabindex="-1"></a>Un non-equi join utiliza operadores de comparación (<span class="in">`&lt;=`</span>, <span class="in">`&gt;=`</span>, <span class="in">`&lt;`</span>, <span class="in">`&gt;`</span>) en lugar de igualdad (<span class="in">`==`</span>):</span>
<span id="cb15-150"><a href="#cb15-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-153"><a href="#cb15-153" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb15-154"><a href="#cb15-154" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: non-equi-conceptos</span></span>
<span id="cb15-155"><a href="#cb15-155" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb15-156"><a href="#cb15-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-157"><a href="#cb15-157" aria-hidden="true" tabindex="-1"></a><span class="co"># Ejemplo simple: clasificar pacientes por IMC</span></span>
<span id="cb15-158"><a href="#cb15-158" aria-hidden="true" tabindex="-1"></a>rangos_imc <span class="ot">&lt;-</span> rangos_medicos[parametro <span class="sc">==</span> <span class="st">"IMC"</span>]</span>
<span id="cb15-159"><a href="#cb15-159" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Rangos de IMC:"</span>)</span>
<span id="cb15-160"><a href="#cb15-160" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(rangos_imc)</span>
<span id="cb15-161"><a href="#cb15-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-162"><a href="#cb15-162" aria-hidden="true" tabindex="-1"></a><span class="co"># Non-equi join básico</span></span>
<span id="cb15-163"><a href="#cb15-163" aria-hidden="true" tabindex="-1"></a>pacientes_clasificados_imc <span class="ot">&lt;-</span> rangos_imc[pacientes_clinica,</span>
<span id="cb15-164"><a href="#cb15-164" aria-hidden="true" tabindex="-1"></a>  on <span class="ot">=</span> .(valor_min <span class="sc">&lt;=</span> imc, valor_max <span class="sc">&gt;=</span> imc),</span>
<span id="cb15-165"><a href="#cb15-165" aria-hidden="true" tabindex="-1"></a>  .(paciente_id, nombre, imc, categoria, nivel_riesgo)]</span>
<span id="cb15-166"><a href="#cb15-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-167"><a href="#cb15-167" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Pacientes clasificados por IMC:"</span>)</span>
<span id="cb15-168"><a href="#cb15-168" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(pacientes_clasificados_imc[<span class="fu">order</span>(imc)], <span class="dv">10</span>))</span>
<span id="cb15-169"><a href="#cb15-169" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-170"><a href="#cb15-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-171"><a href="#cb15-171" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2. **Non-Equi Join con Múltiples Condiciones**</span></span>
<span id="cb15-172"><a href="#cb15-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-175"><a href="#cb15-175" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb15-176"><a href="#cb15-176" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: non-equi-multiples-condiciones</span></span>
<span id="cb15-177"><a href="#cb15-177" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb15-178"><a href="#cb15-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-179"><a href="#cb15-179" aria-hidden="true" tabindex="-1"></a><span class="co"># Clasificar pacientes por múltiples parámetros simultáneamente</span></span>
<span id="cb15-180"><a href="#cb15-180" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear función auxiliar para clasificar</span></span>
<span id="cb15-181"><a href="#cb15-181" aria-hidden="true" tabindex="-1"></a>clasificar_parametro <span class="ot">&lt;-</span> <span class="cf">function</span>(dt, param_name, value_col) {</span>
<span id="cb15-182"><a href="#cb15-182" aria-hidden="true" tabindex="-1"></a>  rangos <span class="ot">&lt;-</span> rangos_medicos[parametro <span class="sc">==</span> param_name]</span>
<span id="cb15-183"><a href="#cb15-183" aria-hidden="true" tabindex="-1"></a>  resultado <span class="ot">&lt;-</span> rangos[dt, on <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"valor_min"</span> <span class="ot">=</span> <span class="fu">paste0</span>(value_col, <span class="st">"&gt;="</span>), <span class="st">"valor_max"</span> <span class="ot">=</span> <span class="fu">paste0</span>(value_col, <span class="st">"&lt;="</span>)),</span>
<span id="cb15-184"><a href="#cb15-184" aria-hidden="true" tabindex="-1"></a>                     .(paciente_id, parametro, categoria, nivel_riesgo),</span>
<span id="cb15-185"><a href="#cb15-185" aria-hidden="true" tabindex="-1"></a>                     nomatch <span class="ot">=</span> <span class="cn">NULL</span>]</span>
<span id="cb15-186"><a href="#cb15-186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(resultado)</span>
<span id="cb15-187"><a href="#cb15-187" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-188"><a href="#cb15-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-189"><a href="#cb15-189" aria-hidden="true" tabindex="-1"></a><span class="co"># Clasificar por glucosa</span></span>
<span id="cb15-190"><a href="#cb15-190" aria-hidden="true" tabindex="-1"></a>pacientes_glucosa <span class="ot">&lt;-</span> rangos_medicos[parametro <span class="sc">==</span> <span class="st">"Glucosa"</span>][pacientes_clinica,</span>
<span id="cb15-191"><a href="#cb15-191" aria-hidden="true" tabindex="-1"></a>  on <span class="ot">=</span> .(valor_min <span class="sc">&lt;=</span> glucosa, valor_max <span class="sc">&gt;=</span> glucosa),</span>
<span id="cb15-192"><a href="#cb15-192" aria-hidden="true" tabindex="-1"></a>  .(paciente_id, <span class="at">parametro =</span> <span class="st">"Glucosa"</span>, <span class="at">valor =</span> glucosa, categoria, nivel_riesgo)]</span>
<span id="cb15-193"><a href="#cb15-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-194"><a href="#cb15-194" aria-hidden="true" tabindex="-1"></a><span class="co"># Clasificar por presión sistólica</span></span>
<span id="cb15-195"><a href="#cb15-195" aria-hidden="true" tabindex="-1"></a>pacientes_presion <span class="ot">&lt;-</span> rangos_medicos[parametro <span class="sc">==</span> <span class="st">"Presión"</span>][pacientes_clinica,</span>
<span id="cb15-196"><a href="#cb15-196" aria-hidden="true" tabindex="-1"></a>  on <span class="ot">=</span> .(valor_min <span class="sc">&lt;=</span> presion_sistolica, valor_max <span class="sc">&gt;=</span> presion_sistolica),  </span>
<span id="cb15-197"><a href="#cb15-197" aria-hidden="true" tabindex="-1"></a>  .(paciente_id, <span class="at">parametro =</span> <span class="st">"Presion"</span>, <span class="at">valor =</span> presion_sistolica, categoria, nivel_riesgo)]</span>
<span id="cb15-198"><a href="#cb15-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-199"><a href="#cb15-199" aria-hidden="true" tabindex="-1"></a><span class="co"># Combinar clasificaciones</span></span>
<span id="cb15-200"><a href="#cb15-200" aria-hidden="true" tabindex="-1"></a>todas_clasificaciones <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb15-201"><a href="#cb15-201" aria-hidden="true" tabindex="-1"></a>  pacientes_glucosa[<span class="sc">!</span><span class="fu">is.na</span>(categoria)],</span>
<span id="cb15-202"><a href="#cb15-202" aria-hidden="true" tabindex="-1"></a>  pacientes_presion[<span class="sc">!</span><span class="fu">is.na</span>(categoria)]</span>
<span id="cb15-203"><a href="#cb15-203" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-204"><a href="#cb15-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-205"><a href="#cb15-205" aria-hidden="true" tabindex="-1"></a><span class="co"># Resumen de riesgos por paciente</span></span>
<span id="cb15-206"><a href="#cb15-206" aria-hidden="true" tabindex="-1"></a>resumen_riesgo_pacientes <span class="ot">&lt;-</span> todas_clasificaciones[,</span>
<span id="cb15-207"><a href="#cb15-207" aria-hidden="true" tabindex="-1"></a>  .(</span>
<span id="cb15-208"><a href="#cb15-208" aria-hidden="true" tabindex="-1"></a>    <span class="at">parametros_evaluados =</span> .N,</span>
<span id="cb15-209"><a href="#cb15-209" aria-hidden="true" tabindex="-1"></a>    <span class="at">riesgos_altos =</span> <span class="fu">sum</span>(nivel_riesgo <span class="sc">==</span> <span class="st">"Alto"</span>),</span>
<span id="cb15-210"><a href="#cb15-210" aria-hidden="true" tabindex="-1"></a>    <span class="at">riesgos_normales =</span> <span class="fu">sum</span>(nivel_riesgo <span class="sc">==</span> <span class="st">"Normal"</span>),</span>
<span id="cb15-211"><a href="#cb15-211" aria-hidden="true" tabindex="-1"></a>    <span class="at">clasificacion_general =</span> <span class="fu">fcase</span>(</span>
<span id="cb15-212"><a href="#cb15-212" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sum</span>(nivel_riesgo <span class="sc">==</span> <span class="st">"Alto"</span>) <span class="sc">&gt;=</span> <span class="dv">2</span>, <span class="st">"Alto Riesgo Múltiple"</span>,</span>
<span id="cb15-213"><a href="#cb15-213" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sum</span>(nivel_riesgo <span class="sc">==</span> <span class="st">"Alto"</span>) <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"Riesgo Moderado"</span>, </span>
<span id="cb15-214"><a href="#cb15-214" aria-hidden="true" tabindex="-1"></a>      <span class="at">default =</span> <span class="st">"Bajo Riesgo"</span></span>
<span id="cb15-215"><a href="#cb15-215" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-216"><a href="#cb15-216" aria-hidden="true" tabindex="-1"></a>  ), by <span class="ot">=</span> paciente_id]</span>
<span id="cb15-217"><a href="#cb15-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-218"><a href="#cb15-218" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Resumen de riesgos por paciente:"</span>)</span>
<span id="cb15-219"><a href="#cb15-219" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(resumen_riesgo_pacientes[<span class="fu">order</span>(<span class="sc">-</span>riesgos_altos)], <span class="dv">10</span>))</span>
<span id="cb15-220"><a href="#cb15-220" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-221"><a href="#cb15-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-222"><a href="#cb15-222" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3. **Non-Equi Join para Ventanas Temporales**</span></span>
<span id="cb15-223"><a href="#cb15-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-226"><a href="#cb15-226" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb15-227"><a href="#cb15-227" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: non-equi-ventanas-temporales</span></span>
<span id="cb15-228"><a href="#cb15-228" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb15-229"><a href="#cb15-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-230"><a href="#cb15-230" aria-hidden="true" tabindex="-1"></a><span class="co"># Encontrar todas las operaciones que ocurrieron dentro de ventanas de eventos</span></span>
<span id="cb15-231"><a href="#cb15-231" aria-hidden="true" tabindex="-1"></a>operaciones_en_ventanas <span class="ot">&lt;-</span> eventos_mercado[operaciones_trading,</span>
<span id="cb15-232"><a href="#cb15-232" aria-hidden="true" tabindex="-1"></a>  on <span class="ot">=</span> .(<span class="at">ticker_afectado =</span> ticker,</span>
<span id="cb15-233"><a href="#cb15-233" aria-hidden="true" tabindex="-1"></a>         fecha_inicio_ventana <span class="sc">&lt;=</span> fecha_operacion,</span>
<span id="cb15-234"><a href="#cb15-234" aria-hidden="true" tabindex="-1"></a>         fecha_fin_ventana <span class="sc">&gt;=</span> fecha_operacion),</span>
<span id="cb15-235"><a href="#cb15-235" aria-hidden="true" tabindex="-1"></a>  .(evento_id, tipo_evento, fecha_evento, impacto_esperado,</span>
<span id="cb15-236"><a href="#cb15-236" aria-hidden="true" tabindex="-1"></a>    operacion_id, fecha_operacion, tipo, cantidad, precio_limite),</span>
<span id="cb15-237"><a href="#cb15-237" aria-hidden="true" tabindex="-1"></a>  nomatch <span class="ot">=</span> <span class="cn">NULL</span>]</span>
<span id="cb15-238"><a href="#cb15-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-239"><a href="#cb15-239" aria-hidden="true" tabindex="-1"></a><span class="co"># Análisis de comportamiento en ventanas de eventos</span></span>
<span id="cb15-240"><a href="#cb15-240" aria-hidden="true" tabindex="-1"></a>comportamiento_eventos <span class="ot">&lt;-</span> operaciones_en_ventanas[,</span>
<span id="cb15-241"><a href="#cb15-241" aria-hidden="true" tabindex="-1"></a>  .(</span>
<span id="cb15-242"><a href="#cb15-242" aria-hidden="true" tabindex="-1"></a>    <span class="at">operaciones_total =</span> .N,</span>
<span id="cb15-243"><a href="#cb15-243" aria-hidden="true" tabindex="-1"></a>    <span class="at">operaciones_compra =</span> <span class="fu">sum</span>(tipo <span class="sc">==</span> <span class="st">"COMPRA"</span>),</span>
<span id="cb15-244"><a href="#cb15-244" aria-hidden="true" tabindex="-1"></a>    <span class="at">operaciones_venta =</span> <span class="fu">sum</span>(tipo <span class="sc">==</span> <span class="st">"VENTA"</span>),</span>
<span id="cb15-245"><a href="#cb15-245" aria-hidden="true" tabindex="-1"></a>    <span class="at">volumen_total =</span> <span class="fu">sum</span>(cantidad),</span>
<span id="cb15-246"><a href="#cb15-246" aria-hidden="true" tabindex="-1"></a>    <span class="at">precio_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(precio_limite), <span class="dv">2</span>),</span>
<span id="cb15-247"><a href="#cb15-247" aria-hidden="true" tabindex="-1"></a>    <span class="at">dias_promedio_evento =</span> <span class="fu">round</span>(<span class="fu">mean</span>(<span class="fu">as.numeric</span>(<span class="fu">abs</span>(fecha_operacion <span class="sc">-</span> fecha_evento))), <span class="dv">1</span>)</span>
<span id="cb15-248"><a href="#cb15-248" aria-hidden="true" tabindex="-1"></a>  ), by <span class="ot">=</span> .(tipo_evento, impacto_esperado)]</span>
<span id="cb15-249"><a href="#cb15-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-250"><a href="#cb15-250" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Comportamiento de trading en ventanas de eventos:"</span>)</span>
<span id="cb15-251"><a href="#cb15-251" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(comportamiento_eventos[<span class="fu">order</span>(<span class="sc">-</span>volumen_total)])</span>
<span id="cb15-252"><a href="#cb15-252" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-253"><a href="#cb15-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-254"><a href="#cb15-254" aria-hidden="true" tabindex="-1"></a><span class="fu">## Rolling Joins: La Joya para Series Temporales</span></span>
<span id="cb15-255"><a href="#cb15-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-256"><a href="#cb15-256" aria-hidden="true" tabindex="-1"></a>Los rolling joins son perfectos para conectar cada observación con el último valor disponible en el tiempo.</span>
<span id="cb15-257"><a href="#cb15-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-258"><a href="#cb15-258" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1. **Rolling Join Básico**</span></span>
<span id="cb15-259"><a href="#cb15-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-262"><a href="#cb15-262" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb15-263"><a href="#cb15-263" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: rolling-join-basico</span></span>
<span id="cb15-264"><a href="#cb15-264" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb15-265"><a href="#cb15-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-266"><a href="#cb15-266" aria-hidden="true" tabindex="-1"></a><span class="co"># Preparar datos con keys para rolling join</span></span>
<span id="cb15-267"><a href="#cb15-267" aria-hidden="true" tabindex="-1"></a>precios_key <span class="ot">&lt;-</span> <span class="fu">copy</span>(precios_historicos)</span>
<span id="cb15-268"><a href="#cb15-268" aria-hidden="true" tabindex="-1"></a>operaciones_key <span class="ot">&lt;-</span> <span class="fu">copy</span>(operaciones_trading)</span>
<span id="cb15-269"><a href="#cb15-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-270"><a href="#cb15-270" aria-hidden="true" tabindex="-1"></a><span class="co"># Establecer keys compuestas: ticker + fecha</span></span>
<span id="cb15-271"><a href="#cb15-271" aria-hidden="true" tabindex="-1"></a><span class="fu">setkey</span>(precios_key, ticker, fecha)</span>
<span id="cb15-272"><a href="#cb15-272" aria-hidden="true" tabindex="-1"></a><span class="fu">setkey</span>(operaciones_key, ticker, fecha_operacion)</span>
<span id="cb15-273"><a href="#cb15-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-274"><a href="#cb15-274" aria-hidden="true" tabindex="-1"></a><span class="co"># Rolling join: obtener el último precio disponible para cada operación</span></span>
<span id="cb15-275"><a href="#cb15-275" aria-hidden="true" tabindex="-1"></a>operaciones_con_precio <span class="ot">&lt;-</span> precios_key[operaciones_key, roll <span class="ot">=</span> <span class="cn">TRUE</span>]</span>
<span id="cb15-276"><a href="#cb15-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-277"><a href="#cb15-277" aria-hidden="true" tabindex="-1"></a><span class="co"># Verificar estructura del resultado</span></span>
<span id="cb15-278"><a href="#cb15-278" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Columnas disponibles después del rolling join:"</span>)</span>
<span id="cb15-279"><a href="#cb15-279" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">names</span>(operaciones_con_precio))</span>
<span id="cb15-280"><a href="#cb15-280" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Primeras filas para entender la estructura:"</span>)</span>
<span id="cb15-281"><a href="#cb15-281" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(operaciones_con_precio, <span class="dv">3</span>))</span>
<span id="cb15-282"><a href="#cb15-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-283"><a href="#cb15-283" aria-hidden="true" tabindex="-1"></a><span class="co"># En un rolling join X[Y], el resultado incluye todas las columnas de Y más las de X</span></span>
<span id="cb15-284"><a href="#cb15-284" aria-hidden="true" tabindex="-1"></a><span class="co"># Las columnas de la fecha de Y se mantienen, no se prefijan con i.</span></span>
<span id="cb15-285"><a href="#cb15-285" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Operaciones con precios históricos (rolling join):"</span>)</span>
<span id="cb15-286"><a href="#cb15-286" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="st">"fecha_operacion"</span> <span class="sc">%in%</span> <span class="fu">names</span>(operaciones_con_precio)) {</span>
<span id="cb15-287"><a href="#cb15-287" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Si fecha_operacion existe directamente</span></span>
<span id="cb15-288"><a href="#cb15-288" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">head</span>(operaciones_con_precio[, .(ticker, fecha, precio_cierre, </span>
<span id="cb15-289"><a href="#cb15-289" aria-hidden="true" tabindex="-1"></a>                                       operacion_id, fecha_operacion, tipo, cantidad)], <span class="dv">10</span>))</span>
<span id="cb15-290"><a href="#cb15-290" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcular diferencia temporal</span></span>
<span id="cb15-291"><a href="#cb15-291" aria-hidden="true" tabindex="-1"></a>  operaciones_con_precio[, dias_diferencia <span class="sc">:</span><span class="er">=</span> <span class="fu">as.numeric</span>(fecha_operacion <span class="sc">-</span> fecha)]</span>
<span id="cb15-292"><a href="#cb15-292" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb15-293"><a href="#cb15-293" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Buscar columnas con fecha en el nombre</span></span>
<span id="cb15-294"><a href="#cb15-294" aria-hidden="true" tabindex="-1"></a>  fecha_cols <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"fecha"</span>, <span class="fu">names</span>(operaciones_con_precio), <span class="at">value =</span> <span class="cn">TRUE</span>)</span>
<span id="cb15-295"><a href="#cb15-295" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Columnas con 'fecha' encontradas:"</span>, <span class="fu">paste</span>(fecha_cols, <span class="at">collapse =</span> <span class="st">", "</span>)))</span>
<span id="cb15-296"><a href="#cb15-296" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-297"><a href="#cb15-297" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Mostrar primeras columnas disponibles</span></span>
<span id="cb15-298"><a href="#cb15-298" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">head</span>(operaciones_con_precio[, <span class="dv">1</span><span class="sc">:</span><span class="fu">min</span>(<span class="dv">8</span>, <span class="fu">ncol</span>(operaciones_con_precio))], <span class="dv">10</span>))</span>
<span id="cb15-299"><a href="#cb15-299" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-300"><a href="#cb15-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-301"><a href="#cb15-301" aria-hidden="true" tabindex="-1"></a><span class="co"># Estadísticas de la calidad del match (solo si dias_diferencia fue creada)</span></span>
<span id="cb15-302"><a href="#cb15-302" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="st">"dias_diferencia"</span> <span class="sc">%in%</span> <span class="fu">names</span>(operaciones_con_precio)) {</span>
<span id="cb15-303"><a href="#cb15-303" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Estadísticas del rolling join:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb15-304"><a href="#cb15-304" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"• Operaciones con precio exacto (mismo día):"</span>, <span class="fu">sum</span>(operaciones_con_precio<span class="sc">$</span>dias_diferencia <span class="sc">==</span> <span class="dv">0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb15-305"><a href="#cb15-305" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"• Operaciones con precio de días anteriores:"</span>, <span class="fu">sum</span>(operaciones_con_precio<span class="sc">$</span>dias_diferencia <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb15-306"><a href="#cb15-306" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"• Diferencia promedio en días:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(operaciones_con_precio<span class="sc">$</span>dias_diferencia, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">1</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb15-307"><a href="#cb15-307" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb15-308"><a href="#cb15-308" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"La variable dias_diferencia no pudo ser creada debido a problemas con las columnas de fecha.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb15-309"><a href="#cb15-309" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-310"><a href="#cb15-310" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-311"><a href="#cb15-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-312"><a href="#cb15-312" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2. **Rolling Join con Límites Temporales**</span></span>
<span id="cb15-313"><a href="#cb15-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-316"><a href="#cb15-316" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb15-317"><a href="#cb15-317" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: rolling-join-limitado</span></span>
<span id="cb15-318"><a href="#cb15-318" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb15-319"><a href="#cb15-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-320"><a href="#cb15-320" aria-hidden="true" tabindex="-1"></a><span class="co"># Rolling join con límite: solo usar precios de máximo 7 días anteriores</span></span>
<span id="cb15-321"><a href="#cb15-321" aria-hidden="true" tabindex="-1"></a>operaciones_precio_limitado <span class="ot">&lt;-</span> precios_key[operaciones_key, </span>
<span id="cb15-322"><a href="#cb15-322" aria-hidden="true" tabindex="-1"></a>                                          roll <span class="ot">=</span> <span class="dv">7</span>,  <span class="co"># máximo 7 días</span></span>
<span id="cb15-323"><a href="#cb15-323" aria-hidden="true" tabindex="-1"></a>                                          rollends <span class="ot">=</span> <span class="fu">c</span>(<span class="cn">TRUE</span>, <span class="cn">TRUE</span>)]</span>
<span id="cb15-324"><a href="#cb15-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-325"><a href="#cb15-325" aria-hidden="true" tabindex="-1"></a><span class="co"># Comparar con rolling join ilimitado</span></span>
<span id="cb15-326"><a href="#cb15-326" aria-hidden="true" tabindex="-1"></a>matches_limitado <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(operaciones_precio_limitado<span class="sc">$</span>precio_cierre))</span>
<span id="cb15-327"><a href="#cb15-327" aria-hidden="true" tabindex="-1"></a>matches_ilimitado <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(operaciones_con_precio<span class="sc">$</span>precio_cierre))</span>
<span id="cb15-328"><a href="#cb15-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-329"><a href="#cb15-329" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Comparación de rolling joins:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb15-330"><a href="#cb15-330" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"• Matches con rolling limitado (7 días):"</span>, matches_limitado, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>) </span>
<span id="cb15-331"><a href="#cb15-331" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"• Matches con rolling ilimitado:"</span>, matches_ilimitado, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb15-332"><a href="#cb15-332" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"• Diferencia:"</span>, matches_ilimitado <span class="sc">-</span> matches_limitado, <span class="st">"operaciones</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb15-333"><a href="#cb15-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-334"><a href="#cb15-334" aria-hidden="true" tabindex="-1"></a><span class="co"># Analizar operaciones sin match en rolling limitado</span></span>
<span id="cb15-335"><a href="#cb15-335" aria-hidden="true" tabindex="-1"></a>operaciones_sin_precio <span class="ot">&lt;-</span> operaciones_precio_limitado[<span class="fu">is.na</span>(precio_cierre)]</span>
<span id="cb15-336"><a href="#cb15-336" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(operaciones_sin_precio) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb15-337"><a href="#cb15-337" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"• Operaciones sin precio (primeros días del año o fines de semana largos):"</span>, <span class="fu">nrow</span>(operaciones_sin_precio), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb15-338"><a href="#cb15-338" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-339"><a href="#cb15-339" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-340"><a href="#cb15-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-341"><a href="#cb15-341" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3. **Rolling Join Bidireccional (Nearest)**</span></span>
<span id="cb15-342"><a href="#cb15-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-345"><a href="#cb15-345" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb15-346"><a href="#cb15-346" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: rolling-join-nearest</span></span>
<span id="cb15-347"><a href="#cb15-347" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb15-348"><a href="#cb15-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-349"><a href="#cb15-349" aria-hidden="true" tabindex="-1"></a><span class="co"># Rolling join "nearest": buscar el precio más cercano (antes o después)</span></span>
<span id="cb15-350"><a href="#cb15-350" aria-hidden="true" tabindex="-1"></a>operaciones_nearest <span class="ot">&lt;-</span> precios_key[operaciones_key, roll <span class="ot">=</span> <span class="st">"nearest"</span>]</span>
<span id="cb15-351"><a href="#cb15-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-352"><a href="#cb15-352" aria-hidden="true" tabindex="-1"></a><span class="co"># Comparar diferentes tipos de rolling join</span></span>
<span id="cb15-353"><a href="#cb15-353" aria-hidden="true" tabindex="-1"></a>comparacion_rolling <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb15-354"><a href="#cb15-354" aria-hidden="true" tabindex="-1"></a>  <span class="at">Tipo_Rolling =</span> <span class="fu">c</span>(<span class="st">"Backward (TRUE)"</span>, <span class="st">"Limited (7 days)"</span>, <span class="st">"Nearest"</span>),</span>
<span id="cb15-355"><a href="#cb15-355" aria-hidden="true" tabindex="-1"></a>  <span class="at">Matches =</span> <span class="fu">c</span>(</span>
<span id="cb15-356"><a href="#cb15-356" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(operaciones_con_precio<span class="sc">$</span>precio_cierre)),</span>
<span id="cb15-357"><a href="#cb15-357" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(operaciones_precio_limitado<span class="sc">$</span>precio_cierre)), </span>
<span id="cb15-358"><a href="#cb15-358" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(operaciones_nearest<span class="sc">$</span>precio_cierre))</span>
<span id="cb15-359"><a href="#cb15-359" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb15-360"><a href="#cb15-360" aria-hidden="true" tabindex="-1"></a>  <span class="at">Cobertura_Pct =</span> <span class="fu">round</span>(<span class="fu">c</span>(</span>
<span id="cb15-361"><a href="#cb15-361" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>(<span class="sc">!</span><span class="fu">is.na</span>(operaciones_con_precio<span class="sc">$</span>precio_cierre)) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb15-362"><a href="#cb15-362" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>(<span class="sc">!</span><span class="fu">is.na</span>(operaciones_precio_limitado<span class="sc">$</span>precio_cierre)) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb15-363"><a href="#cb15-363" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>(<span class="sc">!</span><span class="fu">is.na</span>(operaciones_nearest<span class="sc">$</span>precio_cierre)) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb15-364"><a href="#cb15-364" aria-hidden="true" tabindex="-1"></a>  ), <span class="dv">1</span>)</span>
<span id="cb15-365"><a href="#cb15-365" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-366"><a href="#cb15-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-367"><a href="#cb15-367" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Comparación de tipos de rolling join:"</span>)</span>
<span id="cb15-368"><a href="#cb15-368" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(comparacion_rolling)</span>
<span id="cb15-369"><a href="#cb15-369" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-370"><a href="#cb15-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-371"><a href="#cb15-371" aria-hidden="true" tabindex="-1"></a><span class="fu">### 4. **Rolling Join con Sensores IoT**</span></span>
<span id="cb15-372"><a href="#cb15-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-375"><a href="#cb15-375" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb15-376"><a href="#cb15-376" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: rolling-join-sensores</span></span>
<span id="cb15-377"><a href="#cb15-377" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb15-378"><a href="#cb15-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-379"><a href="#cb15-379" aria-hidden="true" tabindex="-1"></a><span class="co"># Caso práctico: asociar eventos de mantenimiento con lecturas de sensores</span></span>
<span id="cb15-380"><a href="#cb15-380" aria-hidden="true" tabindex="-1"></a><span class="fu">setkey</span>(sensores_iot, sensor_id, timestamp)</span>
<span id="cb15-381"><a href="#cb15-381" aria-hidden="true" tabindex="-1"></a><span class="fu">setkey</span>(mantenimiento, sensor_id, fecha_mantenimiento)</span>
<span id="cb15-382"><a href="#cb15-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-383"><a href="#cb15-383" aria-hidden="true" tabindex="-1"></a><span class="co"># Rolling join para obtener la última lectura antes del mantenimiento</span></span>
<span id="cb15-384"><a href="#cb15-384" aria-hidden="true" tabindex="-1"></a>lecturas_pre_mantenimiento <span class="ot">&lt;-</span> sensores_iot[mantenimiento, roll <span class="ot">=</span> <span class="cn">TRUE</span>]</span>
<span id="cb15-385"><a href="#cb15-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-386"><a href="#cb15-386" aria-hidden="true" tabindex="-1"></a><span class="co"># Verificar estructura del resultado</span></span>
<span id="cb15-387"><a href="#cb15-387" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Columnas disponibles después del rolling join de sensores:"</span>)</span>
<span id="cb15-388"><a href="#cb15-388" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">names</span>(lecturas_pre_mantenimiento))</span>
<span id="cb15-389"><a href="#cb15-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-390"><a href="#cb15-390" aria-hidden="true" tabindex="-1"></a><span class="co"># Análisis del estado de sensores antes del mantenimiento</span></span>
<span id="cb15-391"><a href="#cb15-391" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="st">"fecha_mantenimiento"</span> <span class="sc">%in%</span> <span class="fu">names</span>(lecturas_pre_mantenimiento)) {</span>
<span id="cb15-392"><a href="#cb15-392" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Si fecha_mantenimiento existe directamente</span></span>
<span id="cb15-393"><a href="#cb15-393" aria-hidden="true" tabindex="-1"></a>  analisis_pre_mantenimiento <span class="ot">&lt;-</span> lecturas_pre_mantenimiento[<span class="sc">!</span><span class="fu">is.na</span>(valor),</span>
<span id="cb15-394"><a href="#cb15-394" aria-hidden="true" tabindex="-1"></a>    .(</span>
<span id="cb15-395"><a href="#cb15-395" aria-hidden="true" tabindex="-1"></a>      <span class="at">valor_promedio_pre =</span> <span class="fu">round</span>(<span class="fu">mean</span>(valor), <span class="dv">2</span>),</span>
<span id="cb15-396"><a href="#cb15-396" aria-hidden="true" tabindex="-1"></a>      <span class="at">valor_min_pre =</span> <span class="fu">min</span>(valor),</span>
<span id="cb15-397"><a href="#cb15-397" aria-hidden="true" tabindex="-1"></a>      <span class="at">valor_max_pre =</span> <span class="fu">max</span>(valor),</span>
<span id="cb15-398"><a href="#cb15-398" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventos_mantenimiento =</span> .N,</span>
<span id="cb15-399"><a href="#cb15-399" aria-hidden="true" tabindex="-1"></a>      <span class="at">tiempo_promedio_desde_lectura =</span> <span class="fu">round</span>(<span class="fu">mean</span>(<span class="fu">as.numeric</span>(fecha_mantenimiento <span class="sc">-</span> timestamp) <span class="sc">/</span> <span class="dv">60</span>), <span class="dv">1</span>) <span class="co"># minutos</span></span>
<span id="cb15-400"><a href="#cb15-400" aria-hidden="true" tabindex="-1"></a>    ), by <span class="ot">=</span> .(sensor_id, tipo_mantenimiento)]</span>
<span id="cb15-401"><a href="#cb15-401" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb15-402"><a href="#cb15-402" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Buscar columnas con fecha o mantenimiento en el nombre</span></span>
<span id="cb15-403"><a href="#cb15-403" aria-hidden="true" tabindex="-1"></a>  fecha_cols <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"fecha|mantenimiento"</span>, <span class="fu">names</span>(lecturas_pre_mantenimiento), <span class="at">value =</span> <span class="cn">TRUE</span>)</span>
<span id="cb15-404"><a href="#cb15-404" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Columnas con 'fecha' o 'mantenimiento' encontradas:"</span>, <span class="fu">paste</span>(fecha_cols, <span class="at">collapse =</span> <span class="st">", "</span>)))</span>
<span id="cb15-405"><a href="#cb15-405" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-406"><a href="#cb15-406" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Análisis simplificado sin cálculo temporal</span></span>
<span id="cb15-407"><a href="#cb15-407" aria-hidden="true" tabindex="-1"></a>  analisis_pre_mantenimiento <span class="ot">&lt;-</span> lecturas_pre_mantenimiento[<span class="sc">!</span><span class="fu">is.na</span>(valor),</span>
<span id="cb15-408"><a href="#cb15-408" aria-hidden="true" tabindex="-1"></a>    .(</span>
<span id="cb15-409"><a href="#cb15-409" aria-hidden="true" tabindex="-1"></a>      <span class="at">valor_promedio_pre =</span> <span class="fu">round</span>(<span class="fu">mean</span>(valor), <span class="dv">2</span>),</span>
<span id="cb15-410"><a href="#cb15-410" aria-hidden="true" tabindex="-1"></a>      <span class="at">valor_min_pre =</span> <span class="fu">min</span>(valor),</span>
<span id="cb15-411"><a href="#cb15-411" aria-hidden="true" tabindex="-1"></a>      <span class="at">valor_max_pre =</span> <span class="fu">max</span>(valor),</span>
<span id="cb15-412"><a href="#cb15-412" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventos_mantenimiento =</span> .N</span>
<span id="cb15-413"><a href="#cb15-413" aria-hidden="true" tabindex="-1"></a>    ), by <span class="ot">=</span> .(sensor_id, tipo_mantenimiento)]</span>
<span id="cb15-414"><a href="#cb15-414" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-415"><a href="#cb15-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-416"><a href="#cb15-416" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Análisis de sensores antes del mantenimiento:"</span>)</span>
<span id="cb15-417"><a href="#cb15-417" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(analisis_pre_mantenimiento[<span class="fu">order</span>(sensor_id, tipo_mantenimiento)])</span>
<span id="cb15-418"><a href="#cb15-418" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-419"><a href="#cb15-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-420"><a href="#cb15-420" aria-hidden="true" tabindex="-1"></a><span class="fu">## Update Joins Avanzados con Condiciones</span></span>
<span id="cb15-421"><a href="#cb15-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-422"><a href="#cb15-422" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1. **Update Join Condicional**</span></span>
<span id="cb15-423"><a href="#cb15-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-426"><a href="#cb15-426" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb15-427"><a href="#cb15-427" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: update-join-condicional</span></span>
<span id="cb15-428"><a href="#cb15-428" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb15-429"><a href="#cb15-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-430"><a href="#cb15-430" aria-hidden="true" tabindex="-1"></a><span class="co"># Update join para marcar operaciones riesgosas</span></span>
<span id="cb15-431"><a href="#cb15-431" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear tabla de límites de riesgo por ticker</span></span>
<span id="cb15-432"><a href="#cb15-432" aria-hidden="true" tabindex="-1"></a>limites_riesgo <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb15-433"><a href="#cb15-433" aria-hidden="true" tabindex="-1"></a>  <span class="at">ticker =</span> <span class="fu">c</span>(<span class="st">"AAPL"</span>, <span class="st">"GOOGL"</span>, <span class="st">"MSFT"</span>, <span class="st">"TSLA"</span>, <span class="st">"AMZN"</span>),</span>
<span id="cb15-434"><a href="#cb15-434" aria-hidden="true" tabindex="-1"></a>  <span class="at">precio_max_seguro =</span> <span class="fu">c</span>(<span class="dv">200</span>, <span class="dv">3000</span>, <span class="dv">400</span>, <span class="dv">250</span>, <span class="dv">150</span>),</span>
<span id="cb15-435"><a href="#cb15-435" aria-hidden="true" tabindex="-1"></a>  <span class="at">volumen_max_seguro =</span> <span class="fu">c</span>(<span class="dv">1000</span>, <span class="dv">500</span>, <span class="dv">800</span>, <span class="dv">2000</span>, <span class="dv">1200</span>)</span>
<span id="cb15-436"><a href="#cb15-436" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-437"><a href="#cb15-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-438"><a href="#cb15-438" aria-hidden="true" tabindex="-1"></a><span class="co"># Hacer copia para update join</span></span>
<span id="cb15-439"><a href="#cb15-439" aria-hidden="true" tabindex="-1"></a>operaciones_riesgo <span class="ot">&lt;-</span> <span class="fu">copy</span>(operaciones_trading)</span>
<span id="cb15-440"><a href="#cb15-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-441"><a href="#cb15-441" aria-hidden="true" tabindex="-1"></a><span class="co"># Update join condicional</span></span>
<span id="cb15-442"><a href="#cb15-442" aria-hidden="true" tabindex="-1"></a>operaciones_riesgo[limites_riesgo, on <span class="ot">=</span> .(ticker),</span>
<span id="cb15-443"><a href="#cb15-443" aria-hidden="true" tabindex="-1"></a>                  <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb15-444"><a href="#cb15-444" aria-hidden="true" tabindex="-1"></a>                    <span class="at">precio_limite_riesgoso =</span> i.precio_max_seguro <span class="sc">&lt;</span> precio_limite,</span>
<span id="cb15-445"><a href="#cb15-445" aria-hidden="true" tabindex="-1"></a>                    <span class="at">volumen_riesgoso =</span> i.volumen_max_seguro <span class="sc">&lt;</span> cantidad,</span>
<span id="cb15-446"><a href="#cb15-446" aria-hidden="true" tabindex="-1"></a>                    <span class="at">limite_precio_ref =</span> i.precio_max_seguro,</span>
<span id="cb15-447"><a href="#cb15-447" aria-hidden="true" tabindex="-1"></a>                    <span class="at">limite_volumen_ref =</span> i.volumen_max_seguro</span>
<span id="cb15-448"><a href="#cb15-448" aria-hidden="true" tabindex="-1"></a>                  )]</span>
<span id="cb15-449"><a href="#cb15-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-450"><a href="#cb15-450" aria-hidden="true" tabindex="-1"></a><span class="co"># Clasificar nivel de riesgo general</span></span>
<span id="cb15-451"><a href="#cb15-451" aria-hidden="true" tabindex="-1"></a>operaciones_riesgo[, nivel_riesgo <span class="sc">:</span><span class="er">=</span> <span class="fu">fcase</span>(</span>
<span id="cb15-452"><a href="#cb15-452" aria-hidden="true" tabindex="-1"></a>  precio_limite_riesgoso <span class="sc">&amp;</span> volumen_riesgoso, <span class="st">"Alto Riesgo"</span>,</span>
<span id="cb15-453"><a href="#cb15-453" aria-hidden="true" tabindex="-1"></a>  precio_limite_riesgoso <span class="sc">|</span> volumen_riesgoso, <span class="st">"Riesgo Moderado"</span>,</span>
<span id="cb15-454"><a href="#cb15-454" aria-hidden="true" tabindex="-1"></a>  <span class="at">default =</span> <span class="st">"Bajo Riesgo"</span></span>
<span id="cb15-455"><a href="#cb15-455" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb15-456"><a href="#cb15-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-457"><a href="#cb15-457" aria-hidden="true" tabindex="-1"></a><span class="co"># Resumen de riesgos</span></span>
<span id="cb15-458"><a href="#cb15-458" aria-hidden="true" tabindex="-1"></a>resumen_riesgos <span class="ot">&lt;-</span> operaciones_riesgo[, .N, by <span class="ot">=</span> .(ticker, nivel_riesgo)][<span class="fu">order</span>(ticker, nivel_riesgo)]</span>
<span id="cb15-459"><a href="#cb15-459" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Distribución de riesgo por ticker:"</span>)</span>
<span id="cb15-460"><a href="#cb15-460" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(resumen_riesgos)</span>
<span id="cb15-461"><a href="#cb15-461" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-462"><a href="#cb15-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-463"><a href="#cb15-463" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2. **Update Join con Agregaciones Complejas**</span></span>
<span id="cb15-464"><a href="#cb15-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-467"><a href="#cb15-467" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb15-468"><a href="#cb15-468" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: update-join-agregaciones</span></span>
<span id="cb15-469"><a href="#cb15-469" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb15-470"><a href="#cb15-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-471"><a href="#cb15-471" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular estadísticas móviles y actualizar tabla principal</span></span>
<span id="cb15-472"><a href="#cb15-472" aria-hidden="true" tabindex="-1"></a>estadisticas_ticker <span class="ot">&lt;-</span> operaciones_trading[,</span>
<span id="cb15-473"><a href="#cb15-473" aria-hidden="true" tabindex="-1"></a>  .(</span>
<span id="cb15-474"><a href="#cb15-474" aria-hidden="true" tabindex="-1"></a>    <span class="at">operaciones_historicas =</span> .N,</span>
<span id="cb15-475"><a href="#cb15-475" aria-hidden="true" tabindex="-1"></a>    <span class="at">precio_promedio_historico =</span> <span class="fu">round</span>(<span class="fu">mean</span>(precio_limite), <span class="dv">2</span>),</span>
<span id="cb15-476"><a href="#cb15-476" aria-hidden="true" tabindex="-1"></a>    <span class="at">volumen_promedio_historico =</span> <span class="fu">round</span>(<span class="fu">mean</span>(cantidad), <span class="dv">0</span>),</span>
<span id="cb15-477"><a href="#cb15-477" aria-hidden="true" tabindex="-1"></a>    <span class="at">precio_max_historico =</span> <span class="fu">max</span>(precio_limite),</span>
<span id="cb15-478"><a href="#cb15-478" aria-hidden="true" tabindex="-1"></a>    <span class="at">precio_min_historico =</span> <span class="fu">min</span>(precio_limite),</span>
<span id="cb15-479"><a href="#cb15-479" aria-hidden="true" tabindex="-1"></a>    <span class="at">ratio_compra_venta =</span> <span class="fu">round</span>(<span class="fu">mean</span>(tipo <span class="sc">==</span> <span class="st">"COMPRA"</span>), <span class="dv">2</span>)</span>
<span id="cb15-480"><a href="#cb15-480" aria-hidden="true" tabindex="-1"></a>  ), by <span class="ot">=</span> ticker]</span>
<span id="cb15-481"><a href="#cb15-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-482"><a href="#cb15-482" aria-hidden="true" tabindex="-1"></a><span class="co"># Update join para agregar contexto histórico</span></span>
<span id="cb15-483"><a href="#cb15-483" aria-hidden="true" tabindex="-1"></a>operaciones_riesgo[estadisticas_ticker, on <span class="ot">=</span> .(ticker),</span>
<span id="cb15-484"><a href="#cb15-484" aria-hidden="true" tabindex="-1"></a>                  <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb15-485"><a href="#cb15-485" aria-hidden="true" tabindex="-1"></a>                    <span class="at">percentil_precio =</span> <span class="fu">round</span>((precio_limite <span class="sc">-</span> i.precio_min_historico) <span class="sc">/</span> </span>
<span id="cb15-486"><a href="#cb15-486" aria-hidden="true" tabindex="-1"></a>                                           (i.precio_max_historico <span class="sc">-</span> i.precio_min_historico) <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>),</span>
<span id="cb15-487"><a href="#cb15-487" aria-hidden="true" tabindex="-1"></a>                    <span class="at">precio_vs_promedio =</span> <span class="fu">round</span>(precio_limite <span class="sc">/</span> i.precio_promedio_historico, <span class="dv">2</span>),</span>
<span id="cb15-488"><a href="#cb15-488" aria-hidden="true" tabindex="-1"></a>                    <span class="at">volumen_vs_promedio =</span> <span class="fu">round</span>(cantidad <span class="sc">/</span> i.volumen_promedio_historico, <span class="dv">2</span>),</span>
<span id="cb15-489"><a href="#cb15-489" aria-hidden="true" tabindex="-1"></a>                    <span class="at">operaciones_ticker_total =</span> i.operaciones_historicas</span>
<span id="cb15-490"><a href="#cb15-490" aria-hidden="true" tabindex="-1"></a>                  )]</span>
<span id="cb15-491"><a href="#cb15-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-492"><a href="#cb15-492" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Operaciones con contexto histórico:"</span>)</span>
<span id="cb15-493"><a href="#cb15-493" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(operaciones_riesgo[, .(ticker, precio_limite, percentil_precio, </span>
<span id="cb15-494"><a href="#cb15-494" aria-hidden="true" tabindex="-1"></a>                                 precio_vs_promedio, volumen_vs_promedio, nivel_riesgo)], <span class="dv">10</span>))</span>
<span id="cb15-495"><a href="#cb15-495" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-496"><a href="#cb15-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-497"><a href="#cb15-497" aria-hidden="true" tabindex="-1"></a><span class="fu">## Casos de Uso Complejos: Combinando Técnicas</span></span>
<span id="cb15-498"><a href="#cb15-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-499"><a href="#cb15-499" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1. **Pipeline Completo: Finanzas**</span></span>
<span id="cb15-500"><a href="#cb15-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-503"><a href="#cb15-503" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb15-504"><a href="#cb15-504" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: pipeline-finanzas-completo</span></span>
<span id="cb15-505"><a href="#cb15-505" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb15-506"><a href="#cb15-506" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb15-507"><a href="#cb15-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-508"><a href="#cb15-508" aria-hidden="true" tabindex="-1"></a><span class="co"># Pipeline complejo que combina non-equi y rolling joins</span></span>
<span id="cb15-509"><a href="#cb15-509" aria-hidden="true" tabindex="-1"></a><span class="co"># Paso a paso para facilitar el debugging</span></span>
<span id="cb15-510"><a href="#cb15-510" aria-hidden="true" tabindex="-1"></a>step1 <span class="ot">&lt;-</span> operaciones_trading[</span>
<span id="cb15-511"><a href="#cb15-511" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1. Rolling join para obtener precios históricos</span></span>
<span id="cb15-512"><a href="#cb15-512" aria-hidden="true" tabindex="-1"></a>  precios_historicos, on <span class="ot">=</span> .(ticker, <span class="at">fecha_operacion =</span> fecha), roll <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb15-513"><a href="#cb15-513" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb15-514"><a href="#cb15-514" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2. Filtrar solo operaciones con precio disponible</span></span>
<span id="cb15-515"><a href="#cb15-515" aria-hidden="true" tabindex="-1"></a>  <span class="sc">!</span><span class="fu">is.na</span>(precio_cierre)</span>
<span id="cb15-516"><a href="#cb15-516" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb15-517"><a href="#cb15-517" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3. Calcular métricas de trading</span></span>
<span id="cb15-518"><a href="#cb15-518" aria-hidden="true" tabindex="-1"></a>  , <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb15-519"><a href="#cb15-519" aria-hidden="true" tabindex="-1"></a>    <span class="at">diferencia_precio =</span> <span class="fu">round</span>(precio_limite <span class="sc">-</span> precio_cierre, <span class="dv">2</span>),</span>
<span id="cb15-520"><a href="#cb15-520" aria-hidden="true" tabindex="-1"></a>    <span class="at">ratio_precio =</span> <span class="fu">round</span>(precio_limite <span class="sc">/</span> precio_cierre, <span class="dv">3</span>),</span>
<span id="cb15-521"><a href="#cb15-521" aria-hidden="true" tabindex="-1"></a>    <span class="at">valor_operacion =</span> precio_limite <span class="sc">*</span> cantidad</span>
<span id="cb15-522"><a href="#cb15-522" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb15-523"><a href="#cb15-523" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb15-524"><a href="#cb15-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-525"><a href="#cb15-525" aria-hidden="true" tabindex="-1"></a><span class="co"># Verificar columnas antes del non-equi join</span></span>
<span id="cb15-526"><a href="#cb15-526" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Columnas disponibles antes del non-equi join:"</span>)</span>
<span id="cb15-527"><a href="#cb15-527" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">names</span>(step1))</span>
<span id="cb15-528"><a href="#cb15-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-529"><a href="#cb15-529" aria-hidden="true" tabindex="-1"></a>step2 <span class="ot">&lt;-</span> step1[</span>
<span id="cb15-530"><a href="#cb15-530" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 4. Non-equi join con eventos de mercado para ventanas temporales</span></span>
<span id="cb15-531"><a href="#cb15-531" aria-hidden="true" tabindex="-1"></a>  eventos_mercado, </span>
<span id="cb15-532"><a href="#cb15-532" aria-hidden="true" tabindex="-1"></a>  on <span class="ot">=</span> .(<span class="at">ticker =</span> ticker_afectado,</span>
<span id="cb15-533"><a href="#cb15-533" aria-hidden="true" tabindex="-1"></a>         fecha_operacion <span class="sc">&gt;=</span> fecha_inicio_ventana,</span>
<span id="cb15-534"><a href="#cb15-534" aria-hidden="true" tabindex="-1"></a>         fecha_operacion <span class="sc">&lt;=</span> fecha_fin_ventana),</span>
<span id="cb15-535"><a href="#cb15-535" aria-hidden="true" tabindex="-1"></a>  allow.cartesian <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb15-536"><a href="#cb15-536" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb15-537"><a href="#cb15-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-538"><a href="#cb15-538" aria-hidden="true" tabindex="-1"></a><span class="co"># Verificar columnas después del non-equi join</span></span>
<span id="cb15-539"><a href="#cb15-539" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Columnas disponibles después del non-equi join:"</span>)</span>
<span id="cb15-540"><a href="#cb15-540" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">names</span>(step2))</span>
<span id="cb15-541"><a href="#cb15-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-542"><a href="#cb15-542" aria-hidden="true" tabindex="-1"></a><span class="co"># Determinar qué columna usar para ticker en la agrupación</span></span>
<span id="cb15-543"><a href="#cb15-543" aria-hidden="true" tabindex="-1"></a>ticker_col <span class="ot">&lt;-</span> <span class="cf">if</span>(<span class="st">"ticker_afectado"</span> <span class="sc">%in%</span> <span class="fu">names</span>(step2)) <span class="st">"ticker_afectado"</span> <span class="cf">else</span> <span class="st">"ticker"</span></span>
<span id="cb15-544"><a href="#cb15-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-545"><a href="#cb15-545" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Agregar análisis por evento</span></span>
<span id="cb15-546"><a href="#cb15-546" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="st">"ticker_afectado"</span> <span class="sc">%in%</span> <span class="fu">names</span>(step2)) {</span>
<span id="cb15-547"><a href="#cb15-547" aria-hidden="true" tabindex="-1"></a>  pipeline_financiero <span class="ot">&lt;-</span> step2[</span>
<span id="cb15-548"><a href="#cb15-548" aria-hidden="true" tabindex="-1"></a>    , .(</span>
<span id="cb15-549"><a href="#cb15-549" aria-hidden="true" tabindex="-1"></a>      <span class="at">operaciones_en_ventana =</span> .N,</span>
<span id="cb15-550"><a href="#cb15-550" aria-hidden="true" tabindex="-1"></a>      <span class="at">valor_total =</span> <span class="fu">sum</span>(valor_operacion),</span>
<span id="cb15-551"><a href="#cb15-551" aria-hidden="true" tabindex="-1"></a>      <span class="at">precio_promedio_limite =</span> <span class="fu">round</span>(<span class="fu">mean</span>(precio_limite), <span class="dv">2</span>),</span>
<span id="cb15-552"><a href="#cb15-552" aria-hidden="true" tabindex="-1"></a>      <span class="at">precio_promedio_mercado =</span> <span class="fu">round</span>(<span class="fu">mean</span>(precio_cierre), <span class="dv">2</span>),</span>
<span id="cb15-553"><a href="#cb15-553" aria-hidden="true" tabindex="-1"></a>      <span class="at">spread_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(<span class="fu">abs</span>(diferencia_precio)), <span class="dv">2</span>),</span>
<span id="cb15-554"><a href="#cb15-554" aria-hidden="true" tabindex="-1"></a>      <span class="at">operaciones_compra =</span> <span class="fu">sum</span>(tipo <span class="sc">==</span> <span class="st">"COMPRA"</span>),</span>
<span id="cb15-555"><a href="#cb15-555" aria-hidden="true" tabindex="-1"></a>      <span class="at">operaciones_venta =</span> <span class="fu">sum</span>(tipo <span class="sc">==</span> <span class="st">"VENTA"</span>)</span>
<span id="cb15-556"><a href="#cb15-556" aria-hidden="true" tabindex="-1"></a>    ), by <span class="ot">=</span> .(evento_id, tipo_evento, ticker_afectado, impacto_esperado)</span>
<span id="cb15-557"><a href="#cb15-557" aria-hidden="true" tabindex="-1"></a>  ][</span>
<span id="cb15-558"><a href="#cb15-558" aria-hidden="true" tabindex="-1"></a>    operaciones_en_ventana <span class="sc">&gt;=</span> <span class="dv">3</span>  <span class="co"># Solo eventos con suficiente actividad</span></span>
<span id="cb15-559"><a href="#cb15-559" aria-hidden="true" tabindex="-1"></a>  ][</span>
<span id="cb15-560"><a href="#cb15-560" aria-hidden="true" tabindex="-1"></a>    <span class="fu">order</span>(<span class="sc">-</span>valor_total)</span>
<span id="cb15-561"><a href="#cb15-561" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb15-562"><a href="#cb15-562" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb15-563"><a href="#cb15-563" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Usar ticker en lugar de ticker_afectado</span></span>
<span id="cb15-564"><a href="#cb15-564" aria-hidden="true" tabindex="-1"></a>  pipeline_financiero <span class="ot">&lt;-</span> step2[</span>
<span id="cb15-565"><a href="#cb15-565" aria-hidden="true" tabindex="-1"></a>    , .(</span>
<span id="cb15-566"><a href="#cb15-566" aria-hidden="true" tabindex="-1"></a>      <span class="at">operaciones_en_ventana =</span> .N,</span>
<span id="cb15-567"><a href="#cb15-567" aria-hidden="true" tabindex="-1"></a>      <span class="at">valor_total =</span> <span class="fu">sum</span>(valor_operacion),</span>
<span id="cb15-568"><a href="#cb15-568" aria-hidden="true" tabindex="-1"></a>      <span class="at">precio_promedio_limite =</span> <span class="fu">round</span>(<span class="fu">mean</span>(precio_limite), <span class="dv">2</span>),</span>
<span id="cb15-569"><a href="#cb15-569" aria-hidden="true" tabindex="-1"></a>      <span class="at">precio_promedio_mercado =</span> <span class="fu">round</span>(<span class="fu">mean</span>(precio_cierre), <span class="dv">2</span>),</span>
<span id="cb15-570"><a href="#cb15-570" aria-hidden="true" tabindex="-1"></a>      <span class="at">spread_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(<span class="fu">abs</span>(diferencia_precio)), <span class="dv">2</span>),</span>
<span id="cb15-571"><a href="#cb15-571" aria-hidden="true" tabindex="-1"></a>      <span class="at">operaciones_compra =</span> <span class="fu">sum</span>(tipo <span class="sc">==</span> <span class="st">"COMPRA"</span>),</span>
<span id="cb15-572"><a href="#cb15-572" aria-hidden="true" tabindex="-1"></a>      <span class="at">operaciones_venta =</span> <span class="fu">sum</span>(tipo <span class="sc">==</span> <span class="st">"VENTA"</span>)</span>
<span id="cb15-573"><a href="#cb15-573" aria-hidden="true" tabindex="-1"></a>    ), by <span class="ot">=</span> .(evento_id, tipo_evento, ticker, impacto_esperado)</span>
<span id="cb15-574"><a href="#cb15-574" aria-hidden="true" tabindex="-1"></a>  ][</span>
<span id="cb15-575"><a href="#cb15-575" aria-hidden="true" tabindex="-1"></a>    operaciones_en_ventana <span class="sc">&gt;=</span> <span class="dv">3</span>  <span class="co"># Solo eventos con suficiente actividad</span></span>
<span id="cb15-576"><a href="#cb15-576" aria-hidden="true" tabindex="-1"></a>  ][</span>
<span id="cb15-577"><a href="#cb15-577" aria-hidden="true" tabindex="-1"></a>    <span class="fu">order</span>(<span class="sc">-</span>valor_total)</span>
<span id="cb15-578"><a href="#cb15-578" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb15-579"><a href="#cb15-579" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-580"><a href="#cb15-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-581"><a href="#cb15-581" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Análisis de trading en ventanas de eventos:"</span>)</span>
<span id="cb15-582"><a href="#cb15-582" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(pipeline_financiero, <span class="dv">10</span>))</span>
<span id="cb15-583"><a href="#cb15-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-584"><a href="#cb15-584" aria-hidden="true" tabindex="-1"></a><span class="co"># # Crear tabla interactiva del análisis (comentado para PDF)</span></span>
<span id="cb15-585"><a href="#cb15-585" aria-hidden="true" tabindex="-1"></a><span class="co"># DT::datatable(</span></span>
<span id="cb15-586"><a href="#cb15-586" aria-hidden="true" tabindex="-1"></a><span class="co">#   pipeline_financiero,</span></span>
<span id="cb15-587"><a href="#cb15-587" aria-hidden="true" tabindex="-1"></a><span class="co">#   caption = "Análisis de Trading en Ventanas de Eventos de Mercado",</span></span>
<span id="cb15-588"><a href="#cb15-588" aria-hidden="true" tabindex="-1"></a><span class="co">#   options = list(pageLength = 8, scrollX = TRUE)</span></span>
<span id="cb15-589"><a href="#cb15-589" aria-hidden="true" tabindex="-1"></a><span class="co"># ) %&gt;%</span></span>
<span id="cb15-590"><a href="#cb15-590" aria-hidden="true" tabindex="-1"></a><span class="co">#   DT::formatCurrency("valor_total", currency = "$") %&gt;%</span></span>
<span id="cb15-591"><a href="#cb15-591" aria-hidden="true" tabindex="-1"></a><span class="co">#   DT::formatRound(c("precio_promedio_limite", "precio_promedio_mercado", "spread_promedio"), digits = 2)</span></span>
<span id="cb15-592"><a href="#cb15-592" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-593"><a href="#cb15-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-594"><a href="#cb15-594" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2. **Pipeline Médico Avanzado**</span></span>
<span id="cb15-595"><a href="#cb15-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-598"><a href="#cb15-598" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb15-599"><a href="#cb15-599" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: pipeline-medico</span></span>
<span id="cb15-600"><a href="#cb15-600" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb15-601"><a href="#cb15-601" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb15-602"><a href="#cb15-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-603"><a href="#cb15-603" aria-hidden="true" tabindex="-1"></a><span class="co"># Pipeline médico combinando múltiples non-equi joins</span></span>
<span id="cb15-604"><a href="#cb15-604" aria-hidden="true" tabindex="-1"></a>evaluacion_medica_completa <span class="ot">&lt;-</span> pacientes_clinica[</span>
<span id="cb15-605"><a href="#cb15-605" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Añadir columna de edad en décadas para agrupación</span></span>
<span id="cb15-606"><a href="#cb15-606" aria-hidden="true" tabindex="-1"></a>  , decada <span class="sc">:</span><span class="er">=</span> <span class="fu">paste0</span>(<span class="fu">floor</span>(edad<span class="sc">/</span><span class="dv">10</span>)<span class="sc">*</span><span class="dv">10</span>, <span class="st">"s"</span>)</span>
<span id="cb15-607"><a href="#cb15-607" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb15-608"><a href="#cb15-608" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1. Clasificar por IMC</span></span>
<span id="cb15-609"><a href="#cb15-609" aria-hidden="true" tabindex="-1"></a>  rangos_medicos[parametro <span class="sc">==</span> <span class="st">"IMC"</span>], </span>
<span id="cb15-610"><a href="#cb15-610" aria-hidden="true" tabindex="-1"></a>  on <span class="ot">=</span> .(imc <span class="sc">&gt;=</span> valor_min, imc <span class="sc">&lt;=</span> valor_max),</span>
<span id="cb15-611"><a href="#cb15-611" aria-hidden="true" tabindex="-1"></a>  .(paciente_id, nombre, edad, decada, peso, altura, imc, </span>
<span id="cb15-612"><a href="#cb15-612" aria-hidden="true" tabindex="-1"></a>    <span class="at">categoria_imc =</span> categoria, <span class="at">riesgo_imc =</span> nivel_riesgo,</span>
<span id="cb15-613"><a href="#cb15-613" aria-hidden="true" tabindex="-1"></a>    glucosa, presion_sistolica, colesterol)</span>
<span id="cb15-614"><a href="#cb15-614" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb15-615"><a href="#cb15-615" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2. Clasificar por glucosa  </span></span>
<span id="cb15-616"><a href="#cb15-616" aria-hidden="true" tabindex="-1"></a>  rangos_medicos[parametro <span class="sc">==</span> <span class="st">"Glucosa"</span>],</span>
<span id="cb15-617"><a href="#cb15-617" aria-hidden="true" tabindex="-1"></a>  on <span class="ot">=</span> .(glucosa <span class="sc">&gt;=</span> valor_min, glucosa <span class="sc">&lt;=</span> valor_max),</span>
<span id="cb15-618"><a href="#cb15-618" aria-hidden="true" tabindex="-1"></a>  .(paciente_id, nombre, edad, decada, peso, altura, imc, </span>
<span id="cb15-619"><a href="#cb15-619" aria-hidden="true" tabindex="-1"></a>    categoria_imc, riesgo_imc, glucosa,</span>
<span id="cb15-620"><a href="#cb15-620" aria-hidden="true" tabindex="-1"></a>    <span class="at">categoria_glucosa =</span> i.categoria, <span class="at">riesgo_glucosa =</span> i.nivel_riesgo,</span>
<span id="cb15-621"><a href="#cb15-621" aria-hidden="true" tabindex="-1"></a>    presion_sistolica, colesterol)</span>
<span id="cb15-622"><a href="#cb15-622" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb15-623"><a href="#cb15-623" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3. Clasificar por presión</span></span>
<span id="cb15-624"><a href="#cb15-624" aria-hidden="true" tabindex="-1"></a>  rangos_medicos[parametro <span class="sc">==</span> <span class="st">"Presión"</span>],</span>
<span id="cb15-625"><a href="#cb15-625" aria-hidden="true" tabindex="-1"></a>  on <span class="ot">=</span> .(presion_sistolica <span class="sc">&gt;=</span> valor_min, presion_sistolica <span class="sc">&lt;=</span> valor_max),</span>
<span id="cb15-626"><a href="#cb15-626" aria-hidden="true" tabindex="-1"></a>  .(paciente_id, nombre, edad, decada, peso, altura, imc,</span>
<span id="cb15-627"><a href="#cb15-627" aria-hidden="true" tabindex="-1"></a>    categoria_imc, riesgo_imc, glucosa, categoria_glucosa, riesgo_glucosa,</span>
<span id="cb15-628"><a href="#cb15-628" aria-hidden="true" tabindex="-1"></a>    presion_sistolica, <span class="at">categoria_presion =</span> i.categoria, <span class="at">riesgo_presion =</span> i.nivel_riesgo,</span>
<span id="cb15-629"><a href="#cb15-629" aria-hidden="true" tabindex="-1"></a>    colesterol)</span>
<span id="cb15-630"><a href="#cb15-630" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb15-631"><a href="#cb15-631" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 4. Calcular score de riesgo compuesto</span></span>
<span id="cb15-632"><a href="#cb15-632" aria-hidden="true" tabindex="-1"></a>  , <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb15-633"><a href="#cb15-633" aria-hidden="true" tabindex="-1"></a>    <span class="at">factores_riesgo_alto =</span> (riesgo_imc <span class="sc">==</span> <span class="st">"Alto"</span>) <span class="sc">+</span> (riesgo_glucosa <span class="sc">==</span> <span class="st">"Alto"</span>) <span class="sc">+</span> (riesgo_presion <span class="sc">==</span> <span class="st">"Alto"</span>),</span>
<span id="cb15-634"><a href="#cb15-634" aria-hidden="true" tabindex="-1"></a>    <span class="at">factores_riesgo_total =</span> <span class="dv">3</span>,</span>
<span id="cb15-635"><a href="#cb15-635" aria-hidden="true" tabindex="-1"></a>    <span class="at">score_riesgo =</span> (</span>
<span id="cb15-636"><a href="#cb15-636" aria-hidden="true" tabindex="-1"></a>      (riesgo_imc <span class="sc">==</span> <span class="st">"Alto"</span>) <span class="sc">*</span> <span class="dv">3</span> <span class="sc">+</span> (riesgo_imc <span class="sc">==</span> <span class="st">"Normal"</span>) <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span></span>
<span id="cb15-637"><a href="#cb15-637" aria-hidden="true" tabindex="-1"></a>      (riesgo_glucosa <span class="sc">==</span> <span class="st">"Alto"</span>) <span class="sc">*</span> <span class="dv">3</span> <span class="sc">+</span> (riesgo_glucosa <span class="sc">==</span> <span class="st">"Normal"</span>) <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span></span>
<span id="cb15-638"><a href="#cb15-638" aria-hidden="true" tabindex="-1"></a>      (riesgo_presion <span class="sc">==</span> <span class="st">"Alto"</span>) <span class="sc">*</span> <span class="dv">3</span> <span class="sc">+</span> (riesgo_presion <span class="sc">==</span> <span class="st">"Normal"</span>) <span class="sc">*</span> <span class="dv">1</span></span>
<span id="cb15-639"><a href="#cb15-639" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-640"><a href="#cb15-640" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb15-641"><a href="#cb15-641" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb15-642"><a href="#cb15-642" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5. Clasificación final de riesgo</span></span>
<span id="cb15-643"><a href="#cb15-643" aria-hidden="true" tabindex="-1"></a>  , clasificacion_final <span class="sc">:</span><span class="er">=</span> <span class="fu">fcase</span>(</span>
<span id="cb15-644"><a href="#cb15-644" aria-hidden="true" tabindex="-1"></a>    factores_riesgo_alto <span class="sc">&gt;=</span> <span class="dv">2</span>, <span class="st">"Paciente Alto Riesgo - Seguimiento Inmediato"</span>,</span>
<span id="cb15-645"><a href="#cb15-645" aria-hidden="true" tabindex="-1"></a>    factores_riesgo_alto <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"Paciente Riesgo Moderado - Seguimiento Regular"</span>, </span>
<span id="cb15-646"><a href="#cb15-646" aria-hidden="true" tabindex="-1"></a>    score_riesgo <span class="sc">&gt;=</span> <span class="dv">6</span>, <span class="st">"Paciente Bajo Riesgo - Seguimiento Rutinario"</span>,</span>
<span id="cb15-647"><a href="#cb15-647" aria-hidden="true" tabindex="-1"></a>    <span class="at">default =</span> <span class="st">"Paciente Muy Bajo Riesgo - Seguimiento Anual"</span></span>
<span id="cb15-648"><a href="#cb15-648" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb15-649"><a href="#cb15-649" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb15-650"><a href="#cb15-650" aria-hidden="true" tabindex="-1"></a>  <span class="fu">order</span>(<span class="sc">-</span>score_riesgo)</span>
<span id="cb15-651"><a href="#cb15-651" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb15-652"><a href="#cb15-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-653"><a href="#cb15-653" aria-hidden="true" tabindex="-1"></a><span class="co"># Resumen por grupo de edad</span></span>
<span id="cb15-654"><a href="#cb15-654" aria-hidden="true" tabindex="-1"></a>resumen_por_decada <span class="ot">&lt;-</span> evaluacion_medica_completa[,</span>
<span id="cb15-655"><a href="#cb15-655" aria-hidden="true" tabindex="-1"></a>  .(</span>
<span id="cb15-656"><a href="#cb15-656" aria-hidden="true" tabindex="-1"></a>    <span class="at">pacientes =</span> .N,</span>
<span id="cb15-657"><a href="#cb15-657" aria-hidden="true" tabindex="-1"></a>    <span class="at">edad_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(edad), <span class="dv">1</span>),</span>
<span id="cb15-658"><a href="#cb15-658" aria-hidden="true" tabindex="-1"></a>    <span class="at">imc_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(imc), <span class="dv">1</span>),</span>
<span id="cb15-659"><a href="#cb15-659" aria-hidden="true" tabindex="-1"></a>    <span class="at">alto_riesgo =</span> <span class="fu">sum</span>(factores_riesgo_alto <span class="sc">&gt;=</span> <span class="dv">2</span>),</span>
<span id="cb15-660"><a href="#cb15-660" aria-hidden="true" tabindex="-1"></a>    <span class="at">riesgo_moderado =</span> <span class="fu">sum</span>(factores_riesgo_alto <span class="sc">==</span> <span class="dv">1</span>),</span>
<span id="cb15-661"><a href="#cb15-661" aria-hidden="true" tabindex="-1"></a>    <span class="at">bajo_riesgo =</span> <span class="fu">sum</span>(factores_riesgo_alto <span class="sc">==</span> <span class="dv">0</span>),</span>
<span id="cb15-662"><a href="#cb15-662" aria-hidden="true" tabindex="-1"></a>    <span class="at">score_riesgo_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(score_riesgo), <span class="dv">1</span>)</span>
<span id="cb15-663"><a href="#cb15-663" aria-hidden="true" tabindex="-1"></a>  ), by <span class="ot">=</span> decada][<span class="fu">order</span>(decada)]</span>
<span id="cb15-664"><a href="#cb15-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-665"><a href="#cb15-665" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Resumen de evaluación médica por década:"</span>)</span>
<span id="cb15-666"><a href="#cb15-666" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(resumen_por_decada)</span>
<span id="cb15-667"><a href="#cb15-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-668"><a href="#cb15-668" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Pacientes de mayor riesgo:"</span>)</span>
<span id="cb15-669"><a href="#cb15-669" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(evaluacion_medica_completa[factores_riesgo_alto <span class="sc">&gt;=</span> <span class="dv">2</span>, </span>
<span id="cb15-670"><a href="#cb15-670" aria-hidden="true" tabindex="-1"></a>                                     .(nombre, edad, factores_riesgo_alto, score_riesgo, clasificacion_final)], <span class="dv">8</span>))</span>
<span id="cb15-671"><a href="#cb15-671" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-672"><a href="#cb15-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-673"><a href="#cb15-673" aria-hidden="true" tabindex="-1"></a><span class="fu">## Ejercicios Prácticos</span></span>
<span id="cb15-674"><a href="#cb15-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-675"><a href="#cb15-675" aria-hidden="true" tabindex="-1"></a>::: {.callout-note icon="false"}</span>
<span id="cb15-676"><a href="#cb15-676" aria-hidden="true" tabindex="-1"></a><span class="fu">## 🏋️ Ejercicio 10: Sistema de Alertas de Trading</span></span>
<span id="cb15-677"><a href="#cb15-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-678"><a href="#cb15-678" aria-hidden="true" tabindex="-1"></a>Usando los datasets de precios y operaciones:</span>
<span id="cb15-679"><a href="#cb15-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-680"><a href="#cb15-680" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Rolling join** para obtener precios en tiempo real</span>
<span id="cb15-681"><a href="#cb15-681" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Non-equi join** para identificar operaciones en rangos de volatilidad alta</span>
<span id="cb15-682"><a href="#cb15-682" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Update join** para calcular PnL potencial </span>
<span id="cb15-683"><a href="#cb15-683" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Crear sistema de alertas** basado en múltiples condiciones</span>
<span id="cb15-684"><a href="#cb15-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-685"><a href="#cb15-685" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb15-686"><a href="#cb15-686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-687"><a href="#cb15-687" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip collapse="true"}</span>
<span id="cb15-688"><a href="#cb15-688" aria-hidden="true" tabindex="-1"></a><span class="fu">## 💡 Solución del Ejercicio 10</span></span>
<span id="cb15-689"><a href="#cb15-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-692"><a href="#cb15-692" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb15-693"><a href="#cb15-693" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: solucion-ejercicio-10</span></span>
<span id="cb15-694"><a href="#cb15-694" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb15-695"><a href="#cb15-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-696"><a href="#cb15-696" aria-hidden="true" tabindex="-1"></a><span class="co"># Sistema completo de alertas de trading</span></span>
<span id="cb15-697"><a href="#cb15-697" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Calcular volatilidad histórica</span></span>
<span id="cb15-698"><a href="#cb15-698" aria-hidden="true" tabindex="-1"></a>volatilidad_historica <span class="ot">&lt;-</span> precios_historicos[<span class="fu">order</span>(ticker, fecha)][,</span>
<span id="cb15-699"><a href="#cb15-699" aria-hidden="true" tabindex="-1"></a>  .(fecha, <span class="at">volatilidad_10d =</span> <span class="fu">frollapply</span>(precio_cierre, <span class="dv">10</span>, sd, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb15-700"><a href="#cb15-700" aria-hidden="true" tabindex="-1"></a>  by <span class="ot">=</span> ticker][<span class="sc">!</span><span class="fu">is.na</span>(volatilidad_10d)]</span>
<span id="cb15-701"><a href="#cb15-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-702"><a href="#cb15-702" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Definir rangos de volatilidad para non-equi join</span></span>
<span id="cb15-703"><a href="#cb15-703" aria-hidden="true" tabindex="-1"></a>rangos_volatilidad <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb15-704"><a href="#cb15-704" aria-hidden="true" tabindex="-1"></a>  <span class="at">nivel =</span> <span class="fu">c</span>(<span class="st">"Baja"</span>, <span class="st">"Media"</span>, <span class="st">"Alta"</span>, <span class="st">"Extrema"</span>),</span>
<span id="cb15-705"><a href="#cb15-705" aria-hidden="true" tabindex="-1"></a>  <span class="at">vol_min =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">15</span>, <span class="dv">30</span>),</span>
<span id="cb15-706"><a href="#cb15-706" aria-hidden="true" tabindex="-1"></a>  <span class="at">vol_max =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">15</span>, <span class="dv">30</span>, <span class="cn">Inf</span>),</span>
<span id="cb15-707"><a href="#cb15-707" aria-hidden="true" tabindex="-1"></a>  <span class="at">factor_riesgo =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>)</span>
<span id="cb15-708"><a href="#cb15-708" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-709"><a href="#cb15-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-710"><a href="#cb15-710" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Pipeline completo del sistema de alertas</span></span>
<span id="cb15-711"><a href="#cb15-711" aria-hidden="true" tabindex="-1"></a>sistema_alertas <span class="ot">&lt;-</span> operaciones_trading[</span>
<span id="cb15-712"><a href="#cb15-712" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Rolling join con precios históricos</span></span>
<span id="cb15-713"><a href="#cb15-713" aria-hidden="true" tabindex="-1"></a>  precios_historicos, on <span class="ot">=</span> .(ticker, <span class="at">fecha_operacion =</span> fecha), roll <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb15-714"><a href="#cb15-714" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb15-715"><a href="#cb15-715" aria-hidden="true" tabindex="-1"></a>  <span class="sc">!</span><span class="fu">is.na</span>(precio_cierre)  <span class="co"># Solo operaciones con precio disponible</span></span>
<span id="cb15-716"><a href="#cb15-716" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb15-717"><a href="#cb15-717" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Rolling join con volatilidad</span></span>
<span id="cb15-718"><a href="#cb15-718" aria-hidden="true" tabindex="-1"></a>  volatilidad_historica, on <span class="ot">=</span> .(ticker, <span class="at">fecha_operacion =</span> fecha), roll <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb15-719"><a href="#cb15-719" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb15-720"><a href="#cb15-720" aria-hidden="true" tabindex="-1"></a>  <span class="sc">!</span><span class="fu">is.na</span>(volatilidad_10d)  <span class="co"># Solo con volatilidad calculada</span></span>
<span id="cb15-721"><a href="#cb15-721" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb15-722"><a href="#cb15-722" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Non-equi join para clasificar por volatilidad</span></span>
<span id="cb15-723"><a href="#cb15-723" aria-hidden="true" tabindex="-1"></a>  rangos_volatilidad, on <span class="ot">=</span> .(volatilidad_10d <span class="sc">&gt;=</span> vol_min, volatilidad_10d <span class="sc">&lt;=</span> vol_max),</span>
<span id="cb15-724"><a href="#cb15-724" aria-hidden="true" tabindex="-1"></a>  .(operacion_id, ticker, fecha_operacion, tipo, cantidad, precio_limite, precio_cierre,</span>
<span id="cb15-725"><a href="#cb15-725" aria-hidden="true" tabindex="-1"></a>    volatilidad_10d, <span class="at">nivel_volatilidad =</span> nivel, factor_riesgo)</span>
<span id="cb15-726"><a href="#cb15-726" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb15-727"><a href="#cb15-727" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 4. Calcular métricas de riesgo y PnL potencial</span></span>
<span id="cb15-728"><a href="#cb15-728" aria-hidden="true" tabindex="-1"></a>  , <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb15-729"><a href="#cb15-729" aria-hidden="true" tabindex="-1"></a>    <span class="at">diferencia_precio =</span> precio_limite <span class="sc">-</span> precio_cierre,</span>
<span id="cb15-730"><a href="#cb15-730" aria-hidden="true" tabindex="-1"></a>    <span class="at">pnl_potencial_pct =</span> <span class="fu">round</span>((precio_limite <span class="sc">-</span> precio_cierre) <span class="sc">/</span> precio_cierre <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">2</span>),</span>
<span id="cb15-731"><a href="#cb15-731" aria-hidden="true" tabindex="-1"></a>    <span class="at">valor_operacion =</span> precio_limite <span class="sc">*</span> cantidad,</span>
<span id="cb15-732"><a href="#cb15-732" aria-hidden="true" tabindex="-1"></a>    <span class="at">riesgo_volatilidad =</span> volatilidad_10d <span class="sc">*</span> factor_riesgo,</span>
<span id="cb15-733"><a href="#cb15-733" aria-hidden="true" tabindex="-1"></a>    <span class="at">spread_pct =</span> <span class="fu">round</span>(<span class="fu">abs</span>(precio_limite <span class="sc">-</span> precio_cierre) <span class="sc">/</span> precio_cierre <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">2</span>)</span>
<span id="cb15-734"><a href="#cb15-734" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb15-735"><a href="#cb15-735" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb15-736"><a href="#cb15-736" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5. Sistema de alertas basado en múltiples condiciones</span></span>
<span id="cb15-737"><a href="#cb15-737" aria-hidden="true" tabindex="-1"></a>  , alerta_tipo <span class="sc">:</span><span class="er">=</span> <span class="fu">fcase</span>(</span>
<span id="cb15-738"><a href="#cb15-738" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Alerta crítica: alta volatilidad + spread alto + operación grande</span></span>
<span id="cb15-739"><a href="#cb15-739" aria-hidden="true" tabindex="-1"></a>    nivel_volatilidad <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Alta"</span>, <span class="st">"Extrema"</span>) <span class="sc">&amp;</span> spread_pct <span class="sc">&gt;</span> <span class="dv">5</span> <span class="sc">&amp;</span> valor_operacion <span class="sc">&gt;</span> <span class="dv">100000</span>,</span>
<span id="cb15-740"><a href="#cb15-740" aria-hidden="true" tabindex="-1"></a>    <span class="st">"CRÍTICA - Alta Volatilidad + Spread Alto + Volumen Alto"</span>,</span>
<span id="cb15-741"><a href="#cb15-741" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-742"><a href="#cb15-742" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Alerta alta: precio muy diferente del mercado</span></span>
<span id="cb15-743"><a href="#cb15-743" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abs</span>(pnl_potencial_pct) <span class="sc">&gt;</span> <span class="dv">10</span> <span class="sc">&amp;</span> valor_operacion <span class="sc">&gt;</span> <span class="dv">50000</span>,</span>
<span id="cb15-744"><a href="#cb15-744" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ALTA - Precio Fuera de Rango + Volumen Significativo"</span>,</span>
<span id="cb15-745"><a href="#cb15-745" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-746"><a href="#cb15-746" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Alerta media: volatilidad alta</span></span>
<span id="cb15-747"><a href="#cb15-747" aria-hidden="true" tabindex="-1"></a>    nivel_volatilidad <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Alta"</span>, <span class="st">"Extrema"</span>) <span class="sc">&amp;</span> valor_operacion <span class="sc">&gt;</span> <span class="dv">25000</span>,</span>
<span id="cb15-748"><a href="#cb15-748" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MEDIA - Alta Volatilidad"</span>,</span>
<span id="cb15-749"><a href="#cb15-749" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-750"><a href="#cb15-750" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Alerta baja: spread moderado</span></span>
<span id="cb15-751"><a href="#cb15-751" aria-hidden="true" tabindex="-1"></a>    spread_pct <span class="sc">&gt;</span> <span class="dv">3</span> <span class="sc">&amp;</span> valor_operacion <span class="sc">&gt;</span> <span class="dv">10000</span>,</span>
<span id="cb15-752"><a href="#cb15-752" aria-hidden="true" tabindex="-1"></a>    <span class="st">"BAJA - Spread Moderado"</span>,</span>
<span id="cb15-753"><a href="#cb15-753" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-754"><a href="#cb15-754" aria-hidden="true" tabindex="-1"></a>    <span class="at">default =</span> <span class="st">"SIN ALERTA"</span></span>
<span id="cb15-755"><a href="#cb15-755" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb15-756"><a href="#cb15-756" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb15-757"><a href="#cb15-757" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 6. Filtrar solo operaciones con alertas</span></span>
<span id="cb15-758"><a href="#cb15-758" aria-hidden="true" tabindex="-1"></a>  alerta_tipo <span class="sc">!=</span> <span class="st">"SIN ALERTA"</span></span>
<span id="cb15-759"><a href="#cb15-759" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb15-760"><a href="#cb15-760" aria-hidden="true" tabindex="-1"></a>  <span class="fu">order</span>(<span class="sc">-</span>riesgo_volatilidad, <span class="sc">-</span>valor_operacion)</span>
<span id="cb15-761"><a href="#cb15-761" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb15-762"><a href="#cb15-762" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 7. Agregar prioridad numérica para ordenamiento</span></span>
<span id="cb15-763"><a href="#cb15-763" aria-hidden="true" tabindex="-1"></a>  , prioridad <span class="sc">:</span><span class="er">=</span> <span class="fu">fcase</span>(</span>
<span id="cb15-764"><a href="#cb15-764" aria-hidden="true" tabindex="-1"></a>    <span class="fu">grepl</span>(<span class="st">"CRÍTICA"</span>, alerta_tipo), <span class="dv">1</span>,</span>
<span id="cb15-765"><a href="#cb15-765" aria-hidden="true" tabindex="-1"></a>    <span class="fu">grepl</span>(<span class="st">"ALTA"</span>, alerta_tipo), <span class="dv">2</span>, </span>
<span id="cb15-766"><a href="#cb15-766" aria-hidden="true" tabindex="-1"></a>    <span class="fu">grepl</span>(<span class="st">"MEDIA"</span>, alerta_tipo), <span class="dv">3</span>,</span>
<span id="cb15-767"><a href="#cb15-767" aria-hidden="true" tabindex="-1"></a>    <span class="fu">grepl</span>(<span class="st">"BAJA"</span>, alerta_tipo), <span class="dv">4</span>,</span>
<span id="cb15-768"><a href="#cb15-768" aria-hidden="true" tabindex="-1"></a>    <span class="at">default =</span> <span class="dv">5</span></span>
<span id="cb15-769"><a href="#cb15-769" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb15-770"><a href="#cb15-770" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb15-771"><a href="#cb15-771" aria-hidden="true" tabindex="-1"></a>  <span class="fu">order</span>(prioridad, <span class="sc">-</span>valor_operacion)</span>
<span id="cb15-772"><a href="#cb15-772" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb15-773"><a href="#cb15-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-774"><a href="#cb15-774" aria-hidden="true" tabindex="-1"></a><span class="co"># Dashboard de alertas</span></span>
<span id="cb15-775"><a href="#cb15-775" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"🚨 SISTEMA DE ALERTAS DE TRADING 🚨</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb15-776"><a href="#cb15-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-777"><a href="#cb15-777" aria-hidden="true" tabindex="-1"></a><span class="co"># Resumen por tipo de alerta</span></span>
<span id="cb15-778"><a href="#cb15-778" aria-hidden="true" tabindex="-1"></a>resumen_alertas <span class="ot">&lt;-</span> sistema_alertas[, .(</span>
<span id="cb15-779"><a href="#cb15-779" aria-hidden="true" tabindex="-1"></a>  <span class="at">operaciones =</span> .N,</span>
<span id="cb15-780"><a href="#cb15-780" aria-hidden="true" tabindex="-1"></a>  <span class="at">valor_total =</span> <span class="fu">sum</span>(valor_operacion),</span>
<span id="cb15-781"><a href="#cb15-781" aria-hidden="true" tabindex="-1"></a>  <span class="at">volatilidad_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(volatilidad_10d), <span class="dv">2</span>),</span>
<span id="cb15-782"><a href="#cb15-782" aria-hidden="true" tabindex="-1"></a>  <span class="at">spread_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(spread_pct), <span class="dv">2</span>)</span>
<span id="cb15-783"><a href="#cb15-783" aria-hidden="true" tabindex="-1"></a>), by <span class="ot">=</span> .(alerta_tipo, prioridad)][<span class="fu">order</span>(prioridad)]</span>
<span id="cb15-784"><a href="#cb15-784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-785"><a href="#cb15-785" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"RESUMEN DE ALERTAS:"</span>)</span>
<span id="cb15-786"><a href="#cb15-786" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(resumen_alertas)</span>
<span id="cb15-787"><a href="#cb15-787" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-788"><a href="#cb15-788" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">📊 TOP 10 OPERACIONES DE MAYOR RIESGO:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb15-789"><a href="#cb15-789" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(sistema_alertas[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, .(</span>
<span id="cb15-790"><a href="#cb15-790" aria-hidden="true" tabindex="-1"></a>  <span class="at">Ticker =</span> ticker, </span>
<span id="cb15-791"><a href="#cb15-791" aria-hidden="true" tabindex="-1"></a>  <span class="at">Tipo =</span> tipo,</span>
<span id="cb15-792"><a href="#cb15-792" aria-hidden="true" tabindex="-1"></a>  <span class="at">Valor =</span> <span class="fu">paste0</span>(<span class="st">"$"</span>, <span class="fu">format</span>(valor_operacion, <span class="at">big.mark =</span> <span class="st">","</span>)),</span>
<span id="cb15-793"><a href="#cb15-793" aria-hidden="true" tabindex="-1"></a>  <span class="at">Spread =</span> <span class="fu">paste0</span>(spread_pct, <span class="st">"%"</span>),</span>
<span id="cb15-794"><a href="#cb15-794" aria-hidden="true" tabindex="-1"></a>  <span class="at">Volatilidad =</span> <span class="fu">paste0</span>(<span class="fu">round</span>(volatilidad_10d, <span class="dv">1</span>)),</span>
<span id="cb15-795"><a href="#cb15-795" aria-hidden="true" tabindex="-1"></a>  <span class="at">Alerta =</span> alerta_tipo</span>
<span id="cb15-796"><a href="#cb15-796" aria-hidden="true" tabindex="-1"></a>)])</span>
<span id="cb15-797"><a href="#cb15-797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-798"><a href="#cb15-798" aria-hidden="true" tabindex="-1"></a><span class="co"># # Crear tabla interactiva (comentado para PDF)</span></span>
<span id="cb15-799"><a href="#cb15-799" aria-hidden="true" tabindex="-1"></a><span class="co"># DT::datatable(</span></span>
<span id="cb15-800"><a href="#cb15-800" aria-hidden="true" tabindex="-1"></a><span class="co">#   sistema_alertas[1:20],</span></span>
<span id="cb15-801"><a href="#cb15-801" aria-hidden="true" tabindex="-1"></a><span class="co">#   caption = "Sistema de Alertas de Trading - Top 20 Operaciones de Riesgo",</span></span>
<span id="cb15-802"><a href="#cb15-802" aria-hidden="true" tabindex="-1"></a><span class="co">#   options = list(pageLength = 10, scrollX = TRUE)</span></span>
<span id="cb15-803"><a href="#cb15-803" aria-hidden="true" tabindex="-1"></a><span class="co"># ) %&gt;%</span></span>
<span id="cb15-804"><a href="#cb15-804" aria-hidden="true" tabindex="-1"></a><span class="co">#   DT::formatCurrency("valor_operacion", currency = "$") %&gt;%</span></span>
<span id="cb15-805"><a href="#cb15-805" aria-hidden="true" tabindex="-1"></a><span class="co">#   DT::formatRound(c("volatilidad_10d", "spread_pct"), digits = 2) %&gt;%</span></span>
<span id="cb15-806"><a href="#cb15-806" aria-hidden="true" tabindex="-1"></a><span class="co">#   DT::formatStyle(</span></span>
<span id="cb15-807"><a href="#cb15-807" aria-hidden="true" tabindex="-1"></a><span class="co">#     "alerta_tipo",</span></span>
<span id="cb15-808"><a href="#cb15-808" aria-hidden="true" tabindex="-1"></a><span class="co">#     backgroundColor = DT::styleEqual(</span></span>
<span id="cb15-809"><a href="#cb15-809" aria-hidden="true" tabindex="-1"></a><span class="co">#       c("CRÍTICA - Alta Volatilidad + Spread Alto + Volumen Alto",</span></span>
<span id="cb15-810"><a href="#cb15-810" aria-hidden="true" tabindex="-1"></a><span class="co">#         "ALTA - Precio Fuera de Rango + Volumen Significativo", </span></span>
<span id="cb15-811"><a href="#cb15-811" aria-hidden="true" tabindex="-1"></a><span class="co">#         "MEDIA - Alta Volatilidad",</span></span>
<span id="cb15-812"><a href="#cb15-812" aria-hidden="true" tabindex="-1"></a><span class="co">#         "BAJA - Spread Moderado"),</span></span>
<span id="cb15-813"><a href="#cb15-813" aria-hidden="true" tabindex="-1"></a><span class="co">#       c("red", "orange", "yellow", "lightblue")</span></span>
<span id="cb15-814"><a href="#cb15-814" aria-hidden="true" tabindex="-1"></a><span class="co">#     )</span></span>
<span id="cb15-815"><a href="#cb15-815" aria-hidden="true" tabindex="-1"></a><span class="co">#   )</span></span>
<span id="cb15-816"><a href="#cb15-816" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-817"><a href="#cb15-817" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb15-818"><a href="#cb15-818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-819"><a href="#cb15-819" aria-hidden="true" tabindex="-1"></a><span class="fu">## Mejores Prácticas para Joins Avanzados</span></span>
<span id="cb15-820"><a href="#cb15-820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-821"><a href="#cb15-821" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1. **Performance y Optimización**</span></span>
<span id="cb15-822"><a href="#cb15-822" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-825"><a href="#cb15-825" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb15-826"><a href="#cb15-826" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: mejores-practicas-performance</span></span>
<span id="cb15-827"><a href="#cb15-827" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb15-828"><a href="#cb15-828" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb15-829"><a href="#cb15-829" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-830"><a href="#cb15-830" aria-hidden="true" tabindex="-1"></a><span class="co"># ✅ HACER: Establecer keys antes de rolling joins repetitivos</span></span>
<span id="cb15-831"><a href="#cb15-831" aria-hidden="true" tabindex="-1"></a><span class="fu">setkey</span>(tabla_temporal, id, timestamp)</span>
<span id="cb15-832"><a href="#cb15-832" aria-hidden="true" tabindex="-1"></a><span class="fu">setkey</span>(tabla_eventos, id, fecha_evento)</span>
<span id="cb15-833"><a href="#cb15-833" aria-hidden="true" tabindex="-1"></a>resultado <span class="ot">&lt;-</span> tabla_temporal[tabla_eventos, roll <span class="ot">=</span> <span class="cn">TRUE</span>]</span>
<span id="cb15-834"><a href="#cb15-834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-835"><a href="#cb15-835" aria-hidden="true" tabindex="-1"></a><span class="co"># ✅ HACER: Filtrar antes de joins complejos</span></span>
<span id="cb15-836"><a href="#cb15-836" aria-hidden="true" tabindex="-1"></a>tabla_filtrada <span class="ot">&lt;-</span> tabla_grande[fecha <span class="sc">&gt;=</span> fecha_inicio <span class="sc">&amp;</span> fecha <span class="sc">&lt;=</span> fecha_fin]</span>
<span id="cb15-837"><a href="#cb15-837" aria-hidden="true" tabindex="-1"></a>resultado <span class="ot">&lt;-</span> tabla_filtrada[otra_tabla, on <span class="ot">=</span> .(columna)]</span>
<span id="cb15-838"><a href="#cb15-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-839"><a href="#cb15-839" aria-hidden="true" tabindex="-1"></a><span class="co"># ✅ HACER: Usar nomatch = NULL para inner joins en non-equi</span></span>
<span id="cb15-840"><a href="#cb15-840" aria-hidden="true" tabindex="-1"></a>resultado <span class="ot">&lt;-</span> tabla1[tabla2, on <span class="ot">=</span> .(col1 <span class="sc">&gt;=</span> min_val, col1 <span class="sc">&lt;=</span> max_val), nomatch <span class="ot">=</span> <span class="cn">NULL</span>]</span>
<span id="cb15-841"><a href="#cb15-841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-842"><a href="#cb15-842" aria-hidden="true" tabindex="-1"></a><span class="co"># ❌ EVITAR: Non-equi joins sin filtros previos en tablas enormes</span></span>
<span id="cb15-843"><a href="#cb15-843" aria-hidden="true" tabindex="-1"></a><span class="co"># Puede generar productos cartesianos masivos</span></span>
<span id="cb15-844"><a href="#cb15-844" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-845"><a href="#cb15-845" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-846"><a href="#cb15-846" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2. **Manejo de Casos Edge**</span></span>
<span id="cb15-847"><a href="#cb15-847" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-850"><a href="#cb15-850" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb15-851"><a href="#cb15-851" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: mejores-practicas-edge-cases</span></span>
<span id="cb15-852"><a href="#cb15-852" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb15-853"><a href="#cb15-853" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb15-854"><a href="#cb15-854" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-855"><a href="#cb15-855" aria-hidden="true" tabindex="-1"></a><span class="co"># ✅ HACER: Validar resultados de rolling joins</span></span>
<span id="cb15-856"><a href="#cb15-856" aria-hidden="true" tabindex="-1"></a>resultado <span class="ot">&lt;-</span> tabla1[tabla2, roll <span class="ot">=</span> <span class="cn">TRUE</span>]</span>
<span id="cb15-857"><a href="#cb15-857" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Matches encontrados:"</span>, <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(resultado<span class="sc">$</span>columna_tabla1)), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb15-858"><a href="#cb15-858" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Matches perdidos:"</span>, <span class="fu">sum</span>(<span class="fu">is.na</span>(resultado<span class="sc">$</span>columna_tabla1)), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb15-859"><a href="#cb15-859" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-860"><a href="#cb15-860" aria-hidden="true" tabindex="-1"></a><span class="co"># ✅ HACER: Establecer límites razonables en rolling joins</span></span>
<span id="cb15-861"><a href="#cb15-861" aria-hidden="true" tabindex="-1"></a>resultado <span class="ot">&lt;-</span> tabla1[tabla2, roll <span class="ot">=</span> <span class="dv">7</span>]  <span class="co"># máximo 7 unidades de tiempo</span></span>
<span id="cb15-862"><a href="#cb15-862" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-863"><a href="#cb15-863" aria-hidden="true" tabindex="-1"></a><span class="co"># ✅ HACER: Verificar cartesian products en non-equi joins</span></span>
<span id="cb15-864"><a href="#cb15-864" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(resultado) <span class="sc">&gt;</span> <span class="fu">nrow</span>(tabla2) <span class="sc">*</span> <span class="dv">2</span>) {</span>
<span id="cb15-865"><a href="#cb15-865" aria-hidden="true" tabindex="-1"></a>  <span class="fu">warning</span>(<span class="st">"Posible cartesian product no deseado"</span>)</span>
<span id="cb15-866"><a href="#cb15-866" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-867"><a href="#cb15-867" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-868"><a href="#cb15-868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-869"><a href="#cb15-869" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb15-870"><a href="#cb15-870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-871"><a href="#cb15-871" aria-hidden="true" tabindex="-1"></a>::: {.callout-important}</span>
<span id="cb15-872"><a href="#cb15-872" aria-hidden="true" tabindex="-1"></a><span class="fu">## 🎯 Puntos Clave de Este Capítulo</span></span>
<span id="cb15-873"><a href="#cb15-873" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-874"><a href="#cb15-874" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Non-equi joins** permiten uniones basadas en rangos y desigualdades - perfectos para clasificaciones médicas y financieras</span>
<span id="cb15-875"><a href="#cb15-875" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Rolling joins** son esenciales para series temporales - conectan cada punto con el último valor disponible</span>
<span id="cb15-876"><a href="#cb15-876" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Combinar técnicas** (non-equi + rolling + update) permite análisis muy sofisticados</span>
<span id="cb15-877"><a href="#cb15-877" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Performance**: Establecer keys apropiadas es crucial para joins avanzados</span>
<span id="cb15-878"><a href="#cb15-878" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Validación**: Siempre verificar resultados para evitar cartesian products no deseados</span>
<span id="cb15-879"><a href="#cb15-879" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>**Casos de uso reales**: Finanzas, medicina, IoT - cualquier dominio con rangos temporales o de valores</span>
<span id="cb15-880"><a href="#cb15-880" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb15-881"><a href="#cb15-881" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-882"><a href="#cb15-882" aria-hidden="true" tabindex="-1"></a>Los joins avanzados son herramientas poderosas que abren posibilidades analíticas únicas. En el próximo capítulo exploraremos las funciones especiales que complementan estos joins para análisis aún más sofisticados.</span>
<span id="cb15-883"><a href="#cb15-883" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-884"><a href="#cb15-884" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">function_calls</span><span class="dt">&gt;</span></span>
<span id="cb15-885"><a href="#cb15-885" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">invoke</span><span class="ot"> name</span><span class="op">=</span><span class="st">"TodoWrite"</span><span class="dt">&gt;</span></span>
<span id="cb15-886"><a href="#cb15-886" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">parameter</span><span class="ot"> name</span><span class="op">=</span><span class="st">"todos"</span><span class="dt">&gt;</span><span class="co">[</span><span class="ot">{"content": "Reorganizar M\u00f3dulo 1: dividir fundamentos en sintaxis y s\u00edmbolos", "status": "completed", "id": "1"}, {"content": "Crear cap01-simbolos.qmd para s\u00edmbolos especiales del M\u00f3dulo 1", "status": "completed", "id": "1-new"}, {"content": "Reorganizar M\u00f3dulo 2: dividir en encadenamiento y joins", "status": "completed", "id": "2"}, {"content": "Crear cap03-joins-avanzados.qmd para joins avanzados del M\u00f3dulo 3", "status": "completed", "id": "3-1"}, {"content": "Crear cap03-funciones-especiales.qmd para funciones especiales del M\u00f3dulo 3", "status": "in_progress", "id": "3-2"}, {"content": "Crear cap03-reshape.qmd para reshape del M\u00f3dulo 3", "status": "pending", "id": "3-3"}, {"content": "Reorganizar M\u00f3dulo 4: dividir en performance y buenas pr\u00e1cticas", "status": "pending", "id": "4"}, {"content": "Reorganizar M\u00f3dulo 5: dividir en visualizaci\u00f3n y aplicaciones", "status": "pending", "id": "5"}</span><span class="co">]</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/tutorial-datatable/tutorial_data.table/issues" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer><script src="site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>