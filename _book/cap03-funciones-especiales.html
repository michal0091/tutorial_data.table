<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>7&nbsp; Funciones Especiales y Análisis Temporal – Domina data.table en R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./cap03-reshape.html" rel="next">
<link href="./cap03-joins-avanzados.html" rel="prev">
<link href="./images/favicon.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-d14ef1f108961a0fb37502f1e6f08aaf.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-aecbfc4a73d8344c2d918b5cbe22c140.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><style>html{ scroll-behavior: smooth; }</style>
<link rel="stylesheet" href="styles.css">
</head>
<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./cap03-joins-avanzados.html"><strong>Módulo 3</strong>: Técnicas Avanzadas y Funciones Especiales</a></li><li class="breadcrumb-item"><a href="./cap03-funciones-especiales.html"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Funciones Especiales y Análisis Temporal</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      <img src="./logos\kinelytic-header-logo.svg" alt="Company name with logo" class="sidebar-logo py-0 d-lg-inline d-none"></a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Domina data.table en R</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/tutorial-datatable/tutorial_data.table" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Prefacio</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introducción a <code>data.table</code></span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text"><strong>Módulo 1</strong>: Fundamentos y Sintaxis Esencial</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap01-sintaxis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">La Sintaxis <code>DT[i, j, by]</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap01-simbolos.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Símbolos Especiales en <code>data.table</code></span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text"><strong>Módulo 2</strong>: Manipulación de Datos Intermedia</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap02-encadenamiento.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Encadenamiento de Operaciones (Chaining)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap02-joins.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Uniones de Datos (Joins)</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text"><strong>Módulo 3</strong>: Técnicas Avanzadas y Funciones Especiales</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap03-joins-avanzados.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Joins Avanzados: Non-Equi y Rolling Joins</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap03-funciones-especiales.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Funciones Especiales y Análisis Temporal</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap03-reshape.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Remodelación de Datos: <code>melt()</code> y <code>dcast()</code></span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text"><strong>Módulo 4</strong>: Optimización y Buenas Prácticas</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap04-performance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Optimización de Performance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap04-buenas-practicas.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Buenas Prácticas y Código Idiomático</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text"><strong>Módulo 5</strong>: Integración con el Ecosistema R</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap05-visualizacion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Visualización de Datos con data.table</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cap05-aplicaciones.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Aplicaciones del Mundo Real</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./conclusion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Conclusiones y Próximos Pasos</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Referencias</span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="2"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#funciones-de-ventana-window-functions" id="toc-funciones-de-ventana-window-functions" class="nav-link active" data-scroll-target="#funciones-de-ventana-window-functions"><span class="header-section-number">7.1</span> Funciones de Ventana (Window Functions)</a>
  <ul class="collapse">
<li><a href="#shift-valores-anteriores-y-posteriores" id="toc-shift-valores-anteriores-y-posteriores" class="nav-link" data-scroll-target="#shift-valores-anteriores-y-posteriores"><span class="header-section-number">7.1.1</span> 1. <strong><code>shift()</code>: Valores Anteriores y Posteriores</strong></a></li>
  <li><a href="#frollmean-y-medias-m%C3%B3viles" id="toc-frollmean-y-medias-móviles" class="nav-link" data-scroll-target="#frollmean-y-medias-m%C3%B3viles"><span class="header-section-number">7.1.2</span> 2. <strong><code>frollmean()</code> y Medias Móviles</strong></a></li>
  <li><a href="#frollapply-funciones-personalizadas" id="toc-frollapply-funciones-personalizadas" class="nav-link" data-scroll-target="#frollapply-funciones-personalizadas"><span class="header-section-number">7.1.3</span> 3. <strong><code>frollapply()</code>: Funciones Personalizadas</strong></a></li>
  </ul>
</li>
  <li>
<a href="#funciones-condicionales-optimizadas" id="toc-funciones-condicionales-optimizadas" class="nav-link" data-scroll-target="#funciones-condicionales-optimizadas"><span class="header-section-number">7.2</span> Funciones Condicionales Optimizadas</a>
  <ul class="collapse">
<li><a href="#fifelse-condicionales-r%C3%A1pidas" id="toc-fifelse-condicionales-rápidas" class="nav-link" data-scroll-target="#fifelse-condicionales-r%C3%A1pidas"><span class="header-section-number">7.2.1</span> 1. <strong><code>fifelse()</code>: Condicionales Rápidas</strong></a></li>
  <li><a href="#fcase-m%C3%BAltiples-condiciones-elegantes" id="toc-fcase-múltiples-condiciones-elegantes" class="nav-link" data-scroll-target="#fcase-m%C3%BAltiples-condiciones-elegantes"><span class="header-section-number">7.2.2</span> 2. <strong><code>fcase()</code>: Múltiples Condiciones Elegantes</strong></a></li>
  <li><a href="#between-rangos-eficientes" id="toc-between-rangos-eficientes" class="nav-link" data-scroll-target="#between-rangos-eficientes"><span class="header-section-number">7.2.3</span> 3. <strong><code>between()</code>: Rangos Eficientes</strong></a></li>
  </ul>
</li>
  <li>
<a href="#funciones-de-agregaci%C3%B3n-especiales" id="toc-funciones-de-agregación-especiales" class="nav-link" data-scroll-target="#funciones-de-agregaci%C3%B3n-especiales"><span class="header-section-number">7.3</span> Funciones de Agregación Especiales</a>
  <ul class="collapse">
<li><a href="#frank-rankings-y-percentiles" id="toc-frank-rankings-y-percentiles" class="nav-link" data-scroll-target="#frank-rankings-y-percentiles"><span class="header-section-number">7.3.1</span> 1. <strong><code>frank()</code>: Rankings y Percentiles</strong></a></li>
  <li><a href="#rleid-identificaci%C3%B3n-de-runs" id="toc-rleid-identificación-de-runs" class="nav-link" data-scroll-target="#rleid-identificaci%C3%B3n-de-runs"><span class="header-section-number">7.3.2</span> 2. <strong><code>rleid()</code>: Identificación de Runs</strong></a></li>
  <li><a href="#uniquen-conteos-de-%C3%BAnicos-eficientes" id="toc-uniquen-conteos-de-únicos-eficientes" class="nav-link" data-scroll-target="#uniquen-conteos-de-%C3%BAnicos-eficientes"><span class="header-section-number">7.3.3</span> 3. <strong><code>uniqueN()</code>: Conteos de Únicos Eficientes</strong></a></li>
  </ul>
</li>
  <li>
<a href="#an%C3%A1lisis-temporal-avanzado" id="toc-análisis-temporal-avanzado" class="nav-link" data-scroll-target="#an%C3%A1lisis-temporal-avanzado"><span class="header-section-number">7.4</span> Análisis Temporal Avanzado</a>
  <ul class="collapse">
<li><a href="#detecci%C3%B3n-de-anomal%C3%ADas-temporales" id="toc-detección-de-anomalías-temporales" class="nav-link" data-scroll-target="#detecci%C3%B3n-de-anomal%C3%ADas-temporales"><span class="header-section-number">7.4.1</span> 1. <strong>Detección de Anomalías Temporales</strong></a></li>
  <li><a href="#an%C3%A1lisis-de-ciclos-y-estacionalidad" id="toc-análisis-de-ciclos-y-estacionalidad" class="nav-link" data-scroll-target="#an%C3%A1lisis-de-ciclos-y-estacionalidad"><span class="header-section-number">7.4.2</span> 2. <strong>Análisis de Ciclos y Estacionalidad</strong></a></li>
  </ul>
</li>
  <li><a href="#ejercicios-pr%C3%A1cticos" id="toc-ejercicios-prácticos" class="nav-link" data-scroll-target="#ejercicios-pr%C3%A1cticos"><span class="header-section-number">7.5</span> Ejercicios Prácticos</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/tutorial-datatable/tutorial_data.table/issues" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./cap03-joins-avanzados.html"><strong>Módulo 3</strong>: Técnicas Avanzadas y Funciones Especiales</a></li><li class="breadcrumb-item"><a href="./cap03-funciones-especiales.html"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Funciones Especiales y Análisis Temporal</span></a></li></ol></nav><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">
<span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Funciones Especiales y Análisis Temporal</span>
</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Código</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
En este capítulo dominarás
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>
<strong>Funciones de ventana</strong>: <code>shift()</code>, <code>frollmean()</code>, <code>frollapply()</code>
</li>
<li>
<strong>Funciones condicionales rápidas</strong>: <code>fifelse()</code>, <code>fcase()</code>, <code>between()</code>
</li>
<li>
<strong>Análisis temporal avanzado</strong> con series de tiempo</li>
<li>
<strong>Funciones de agregación especiales</strong>: <code>frank()</code>, <code>rleid()</code>, <code>uniqueN()</code>
</li>
<li>
<strong>Operaciones con strings</strong> optimizadas para data.table</li>
<li>
<strong>Análisis de supervivencia</strong> y detección de patrones</li>
</ul>
</div>
</div>
<section id="funciones-de-ventana-window-functions" class="level2" data-number="7.1"><h2 data-number="7.1" class="anchored" data-anchor-id="funciones-de-ventana-window-functions">
<span class="header-section-number">7.1</span> Funciones de Ventana (Window Functions)</h2>
<p>Las funciones de ventana permiten realizar cálculos sobre un conjunto de filas relacionadas con la fila actual, sin colapsar el resultado como lo harían las funciones de agregación.</p>
<section id="shift-valores-anteriores-y-posteriores" class="level3" data-number="7.1.1"><h3 data-number="7.1.1" class="anchored" data-anchor-id="shift-valores-anteriores-y-posteriores">
<span class="header-section-number">7.1.1</span> 1. <strong><code>shift()</code>: Valores Anteriores y Posteriores</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Calcular cambios diarios en precios</span></span>
<span><span class="va">precios_con_lag</span> <span class="op">&lt;-</span> <span class="va">precios_diarios</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">ticker</span>, <span class="va">fecha</span><span class="op">)</span><span class="op">]</span><span class="op">[</span>,</span>
<span>  <span class="fu">`:=`</span><span class="op">(</span></span>
<span>    precio_anterior <span class="op">=</span> <span class="fu">shift</span><span class="op">(</span><span class="va">precio_cierre</span>, <span class="fl">1</span><span class="op">)</span>,          <span class="co"># t-1</span></span>
<span>    precio_siguiente <span class="op">=</span> <span class="fu">shift</span><span class="op">(</span><span class="va">precio_cierre</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span>,        <span class="co"># t+1</span></span>
<span>    precio_3_dias_antes <span class="op">=</span> <span class="fu">shift</span><span class="op">(</span><span class="va">precio_cierre</span>, <span class="fl">3</span><span class="op">)</span>,      <span class="co"># t-3</span></span>
<span>    volumen_anterior <span class="op">=</span> <span class="fu">shift</span><span class="op">(</span><span class="va">volumen</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span>, by <span class="op">=</span> <span class="va">ticker</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Calcular métricas de cambio</span></span>
<span><span class="va">precios_con_lag</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span></span>
<span>  cambio_diario <span class="op">=</span> <span class="va">precio_cierre</span> <span class="op">-</span> <span class="va">precio_anterior</span>,</span>
<span>  cambio_pct <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="op">(</span><span class="va">precio_cierre</span> <span class="op">-</span> <span class="va">precio_anterior</span><span class="op">)</span> <span class="op">/</span> <span class="va">precio_anterior</span> <span class="op">*</span> <span class="fl">100</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  volatilidad_3d <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">precio_cierre</span> <span class="op">-</span> <span class="va">precio_3_dias_antes</span><span class="op">)</span> <span class="op">/</span> <span class="va">precio_3_dias_antes</span> <span class="op">*</span> <span class="fl">100</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  cambio_volumen <span class="op">=</span> <span class="va">volumen</span> <span class="op">-</span> <span class="va">volumen_anterior</span></span>
<span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Análisis de cambios diarios:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Análisis de cambios diarios:"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">precios_con_lag</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">precio_anterior</span><span class="op">)</span>, </span>
<span>                          <span class="fu">.</span><span class="op">(</span><span class="va">ticker</span>, <span class="va">fecha</span>, <span class="va">precio_cierre</span>, <span class="va">cambio_diario</span>, <span class="va">cambio_pct</span>, <span class="va">volatilidad_3d</span><span class="op">)</span><span class="op">]</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;     ticker      fecha precio_cierre cambio_diario cambio_pct volatilidad_3d</span></span>
<span><span class="co">#&gt;     &lt;char&gt;     &lt;Date&gt;         &lt;num&gt;         &lt;num&gt;      &lt;num&gt;          &lt;num&gt;</span></span>
<span><span class="co">#&gt;  1:   AAPL 2024-01-02      183.4407     2.3071617       1.27             NA</span></span>
<span><span class="co">#&gt;  2:   AAPL 2024-01-03      181.4614    -1.9792962      -1.08             NA</span></span>
<span><span class="co">#&gt;  3:   AAPL 2024-01-04      182.1432     0.6817462       0.38           0.56</span></span>
<span><span class="co">#&gt;  4:   AAPL 2024-01-05      184.6943     2.5510975       1.40           0.68</span></span>
<span><span class="co">#&gt;  5:   AAPL 2024-01-06      187.7013     3.0069915       1.63           3.44</span></span>
<span><span class="co">#&gt;  6:   AAPL 2024-01-07      190.0722     2.3709305       1.26           4.35</span></span>
<span><span class="co">#&gt;  7:   AAPL 2024-01-08      188.8158    -1.2563592      -0.66           2.23</span></span>
<span><span class="co">#&gt;  8:   AAPL 2024-01-09      188.3688    -0.4470651      -0.24           0.36</span></span>
<span><span class="co">#&gt;  9:   AAPL 2024-01-10      185.8614    -2.5073326      -1.33           2.22</span></span>
<span><span class="co">#&gt; 10:   AAPL 2024-01-11      180.8085    -5.0529325      -2.72           4.24</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="frollmean-y-medias-móviles" class="level3" data-number="7.1.2"><h3 data-number="7.1.2" class="anchored" data-anchor-id="frollmean-y-medias-móviles">
<span class="header-section-number">7.1.2</span> 2. <strong><code>frollmean()</code> y Medias Móviles</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Múltiples medias móviles para análisis técnico</span></span>
<span><span class="va">precios_ma</span> <span class="op">&lt;-</span> <span class="va">precios_diarios</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">ticker</span>, <span class="va">fecha</span><span class="op">)</span><span class="op">]</span><span class="op">[</span>,</span>
<span>  <span class="fu">`:=`</span><span class="op">(</span></span>
<span>    ma_5 <span class="op">=</span> <span class="fu">frollmean</span><span class="op">(</span><span class="va">precio_cierre</span>, <span class="fl">5</span><span class="op">)</span>,           <span class="co"># Media móvil 5 días</span></span>
<span>    ma_20 <span class="op">=</span> <span class="fu">frollmean</span><span class="op">(</span><span class="va">precio_cierre</span>, <span class="fl">20</span><span class="op">)</span>,         <span class="co"># Media móvil 20 días</span></span>
<span>    ma_50 <span class="op">=</span> <span class="fu">frollmean</span><span class="op">(</span><span class="va">precio_cierre</span>, <span class="fl">50</span><span class="op">)</span>,         <span class="co"># Media móvil 50 días</span></span>
<span>    volume_ma_10 <span class="op">=</span> <span class="fu">frollmean</span><span class="op">(</span><span class="va">volumen</span>, <span class="fl">10</span><span class="op">)</span>,        <span class="co"># Media móvil volumen 10 días</span></span>
<span>    volatilidad_20 <span class="op">=</span> <span class="fu">frollapply</span><span class="op">(</span><span class="va">precio_cierre</span>, <span class="fl">20</span>, <span class="va">sd</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>  <span class="co"># Volatilidad 20 días</span></span>
<span>  <span class="op">)</span>, by <span class="op">=</span> <span class="va">ticker</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Señales técnicas basadas en cruces de medias móviles</span></span>
<span><span class="va">precios_ma</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">ma_50</span><span class="op">)</span>, <span class="fu">`:=`</span><span class="op">(</span></span>
<span>  señal_alcista <span class="op">=</span> <span class="va">ma_5</span> <span class="op">&gt;</span> <span class="va">ma_20</span> <span class="op">&amp;</span> <span class="va">ma_20</span> <span class="op">&gt;</span> <span class="va">ma_50</span>,</span>
<span>  señal_bajista <span class="op">=</span> <span class="va">ma_5</span> <span class="op">&lt;</span> <span class="va">ma_20</span> <span class="op">&amp;</span> <span class="va">ma_20</span> <span class="op">&lt;</span> <span class="va">ma_50</span>,</span>
<span>  precio_sobre_ma20 <span class="op">=</span> <span class="va">precio_cierre</span> <span class="op">&gt;</span> <span class="va">ma_20</span>,</span>
<span>  volumen_alto <span class="op">=</span> <span class="va">volumen</span> <span class="op">&gt;</span> <span class="va">volume_ma_10</span> <span class="op">*</span> <span class="fl">1.5</span></span>
<span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Resumen de señales por ticker</span></span>
<span><span class="va">señales_resumen</span> <span class="op">&lt;-</span> <span class="va">precios_ma</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">señal_alcista</span><span class="op">)</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>  dias_analizados <span class="op">=</span> <span class="va">.N</span>,</span>
<span>  señales_alcistas <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">señal_alcista</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  señales_bajistas <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">señal_bajista</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  dias_sobre_ma20 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">precio_sobre_ma20</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  volatilidad_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">volatilidad_20</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span>, by <span class="op">=</span> <span class="va">ticker</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Resumen de señales técnicas:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Resumen de señales técnicas:"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">señales_resumen</span><span class="op">)</span></span>
<span><span class="co">#&gt;    ticker dias_analizados señales_alcistas señales_bajistas dias_sobre_ma20</span></span>
<span><span class="co">#&gt;    &lt;char&gt;           &lt;int&gt;            &lt;int&gt;            &lt;int&gt;           &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1:   AAPL             133               80               19              93</span></span>
<span><span class="co">#&gt; 2:  GOOGL             133               63               19              81</span></span>
<span><span class="co">#&gt; 3:   MSFT             133               85               17              84</span></span>
<span><span class="co">#&gt; 4:   NVDA             133               34               41              77</span></span>
<span><span class="co">#&gt;    volatilidad_promedio</span></span>
<span><span class="co">#&gt;                   &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:                 3.67</span></span>
<span><span class="co">#&gt; 2:                15.24</span></span>
<span><span class="co">#&gt; 3:                 5.17</span></span>
<span><span class="co">#&gt; 4:                21.08</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="frollapply-funciones-personalizadas" class="level3" data-number="7.1.3"><h3 data-number="7.1.3" class="anchored" data-anchor-id="frollapply-funciones-personalizadas">
<span class="header-section-number">7.1.3</span> 3. <strong><code>frollapply()</code>: Funciones Personalizadas</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Funciones personalizadas para análisis de ventana</span></span>
<span><span class="va">precios_estadisticas</span> <span class="op">&lt;-</span> <span class="va">precios_diarios</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">ticker</span>, <span class="va">fecha</span><span class="op">)</span><span class="op">]</span><span class="op">[</span>,</span>
<span>  <span class="fu">`:=`</span><span class="op">(</span></span>
<span>    rango_10d <span class="op">=</span> <span class="fu">frollapply</span><span class="op">(</span><span class="va">precio_cierre</span>, <span class="fl">10</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    percentil_75_20d <span class="op">=</span> <span class="fu">frollapply</span><span class="op">(</span><span class="va">precio_cierre</span>, <span class="fl">20</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0.75</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    coef_variacion_15d <span class="op">=</span> <span class="fu">frollapply</span><span class="op">(</span><span class="va">precio_cierre</span>, <span class="fl">15</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    precio_z_score_30d <span class="op">=</span> <span class="fu">frollapply</span><span class="op">(</span><span class="va">precio_cierre</span>, <span class="fl">30</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">30</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span></span>
<span>      <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span>,</span>
<span>    tendencia_5d <span class="op">=</span> <span class="fu">frollapply</span><span class="op">(</span><span class="va">precio_cierre</span>, <span class="fl">5</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">5</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span></span>
<span>      <span class="va">lm_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">x</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">lm_result</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>  <span class="co"># Pendiente</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="op">)</span>, by <span class="op">=</span> <span class="va">ticker</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Análisis de distribuciones y outliers</span></span>
<span><span class="va">analisis_outliers</span> <span class="op">&lt;-</span> <span class="va">precios_estadisticas</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">precio_z_score_30d</span><span class="op">)</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>  <span class="va">ticker</span>,</span>
<span>  <span class="va">fecha</span>,</span>
<span>  <span class="va">precio_cierre</span>,</span>
<span>  z_score <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">precio_z_score_30d</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  coef_var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">coef_variacion_15d</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>  tendencia <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">tendencia_5d</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>  outlier_extremo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">precio_z_score_30d</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">2</span></span>
<span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="va">outlier_extremo</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">z_score</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Precios con comportamiento outlier (|z-score| &gt; 2):"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Precios con comportamiento outlier (|z-score| &gt; 2):"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">analisis_outliers</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;     ticker      fecha precio_cierre z_score coef_var tendencia outlier_extremo</span></span>
<span><span class="co">#&gt;     &lt;char&gt;     &lt;Date&gt;         &lt;num&gt;   &lt;num&gt;    &lt;num&gt;     &lt;num&gt;          &lt;lgcl&gt;</span></span>
<span><span class="co">#&gt;  1:   MSFT 2024-05-20      457.1759    3.62    0.007    1.9420            TRUE</span></span>
<span><span class="co">#&gt;  2:   MSFT 2024-06-08      431.7858   -3.00    0.015   -2.5880            TRUE</span></span>
<span><span class="co">#&gt;  3:   MSFT 2024-03-08      433.9277    2.92    0.019    5.5208            TRUE</span></span>
<span><span class="co">#&gt;  4:   MSFT 2024-03-07      428.3405    2.76    0.014    2.8564            TRUE</span></span>
<span><span class="co">#&gt;  5:   MSFT 2024-06-09      430.4144   -2.72    0.017   -3.3287            TRUE</span></span>
<span><span class="co">#&gt;  6:   AAPL 2024-05-29      196.4133    2.65    0.027    2.5945            TRUE</span></span>
<span><span class="co">#&gt;  7:   MSFT 2024-04-14      445.9479    2.64    0.015    2.6979            TRUE</span></span>
<span><span class="co">#&gt;  8:  GOOGL 2024-02-19     2892.6715    2.61    0.005    6.6683            TRUE</span></span>
<span><span class="co">#&gt;  9:   AAPL 2024-06-26      214.5298    2.58    0.023    1.7983            TRUE</span></span>
<span><span class="co">#&gt; 10:   NVDA 2024-05-13      546.1066   -2.57    0.024   -1.1179            TRUE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="funciones-condicionales-optimizadas" class="level2" data-number="7.2"><h2 data-number="7.2" class="anchored" data-anchor-id="funciones-condicionales-optimizadas">
<span class="header-section-number">7.2</span> Funciones Condicionales Optimizadas</h2>
<section id="fifelse-condicionales-rápidas" class="level3" data-number="7.2.1"><h3 data-number="7.2.1" class="anchored" data-anchor-id="fifelse-condicionales-rápidas">
<span class="header-section-number">7.2.1</span> 1. <strong><code>fifelse()</code>: Condicionales Rápidas</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Comparación de rendimiento: fifelse vs ifelse</span></span>
<span><span class="va">clientes_clasificacion</span> <span class="op">&lt;-</span> <span class="fu">copy</span><span class="op">(</span><span class="va">clientes_retencion</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># fifelse para clasificaciones múltiples y anidadas</span></span>
<span><span class="va">clientes_clasificacion</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span></span>
<span>  segmento_edad <span class="op">=</span> <span class="fu">fifelse</span><span class="op">(</span></span>
<span>    <span class="va">edad</span> <span class="op">&lt;</span> <span class="fl">25</span>, <span class="st">"Joven"</span>,</span>
<span>    <span class="fu">fifelse</span><span class="op">(</span><span class="va">edad</span> <span class="op">&lt;</span> <span class="fl">45</span>, <span class="st">"Adulto"</span>, <span class="st">"Senior"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  categoria_ingresos <span class="op">=</span> <span class="fu">fifelse</span><span class="op">(</span></span>
<span>    <span class="va">ingresos_mensuales</span> <span class="op">&lt;</span> <span class="fl">2000</span>, <span class="st">"Bajos"</span>,</span>
<span>    <span class="fu">fifelse</span><span class="op">(</span><span class="va">ingresos_mensuales</span> <span class="op">&lt;</span> <span class="fl">5000</span>, <span class="st">"Medios"</span>, <span class="st">"Altos"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  tipo_cliente <span class="op">=</span> <span class="fu">fifelse</span><span class="op">(</span></span>
<span>    <span class="va">plan</span> <span class="op">==</span> <span class="st">"Empresarial"</span>, <span class="st">"Corporativo"</span>,</span>
<span>    <span class="fu">fifelse</span><span class="op">(</span><span class="va">activo</span> <span class="op">&amp;</span> <span class="va">ingresos_mensuales</span> <span class="op">&gt;</span> <span class="fl">3000</span>, <span class="st">"Premium_Activo"</span>, <span class="st">"Estándar"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Análisis de segmentos</span></span>
<span><span class="va">segmentos_analisis</span> <span class="op">&lt;-</span> <span class="va">clientes_clasificacion</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>  clientes <span class="op">=</span> <span class="va">.N</span>,</span>
<span>  ingresos_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">ingresos_mensuales</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>  tasa_actividad <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">activo</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  planes_premium <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">plan</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Premium"</span>, <span class="st">"Empresarial"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">segmento_edad</span>, <span class="va">categoria_ingresos</span>, <span class="va">tipo_cliente</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Análisis de segmentos de clientes:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Análisis de segmentos de clientes:"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">segmentos_analisis</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">clientes</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;     segmento_edad categoria_ingresos   tipo_cliente clientes ingresos_promedio</span></span>
<span><span class="co">#&gt;            &lt;char&gt;             &lt;char&gt;         &lt;char&gt;    &lt;int&gt;             &lt;num&gt;</span></span>
<span><span class="co">#&gt;  1:        Senior              Altos Premium_Activo      191             13130</span></span>
<span><span class="co">#&gt;  2:        Adulto              Altos Premium_Activo      116             12750</span></span>
<span><span class="co">#&gt;  3:        Senior              Bajos       Estándar       96              1301</span></span>
<span><span class="co">#&gt;  4:        Senior             Medios Premium_Activo       74              3916</span></span>
<span><span class="co">#&gt;  5:        Senior             Medios       Estándar       72              2973</span></span>
<span><span class="co">#&gt; ---                                                                           </span></span>
<span><span class="co">#&gt; 20:         Joven              Altos       Estándar        9             12540</span></span>
<span><span class="co">#&gt; 21:         Joven              Altos    Corporativo        6             11067</span></span>
<span><span class="co">#&gt; 22:         Joven             Medios    Corporativo        4              3249</span></span>
<span><span class="co">#&gt; 23:        Adulto              Bajos    Corporativo        4              1292</span></span>
<span><span class="co">#&gt; 24:         Joven              Bajos    Corporativo        1              1952</span></span>
<span><span class="co">#&gt;     tasa_actividad planes_premium</span></span>
<span><span class="co">#&gt;              &lt;num&gt;          &lt;int&gt;</span></span>
<span><span class="co">#&gt;  1:          100.0             71</span></span>
<span><span class="co">#&gt;  2:          100.0             41</span></span>
<span><span class="co">#&gt;  3:           68.8             26</span></span>
<span><span class="co">#&gt;  4:          100.0             22</span></span>
<span><span class="co">#&gt;  5:           50.0             28</span></span>
<span><span class="co">#&gt; ---                              </span></span>
<span><span class="co">#&gt; 20:            0.0              0</span></span>
<span><span class="co">#&gt; 21:           33.3              6</span></span>
<span><span class="co">#&gt; 22:          100.0              4</span></span>
<span><span class="co">#&gt; 23:           75.0              4</span></span>
<span><span class="co">#&gt; 24:            0.0              1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="fcase-múltiples-condiciones-elegantes" class="level3" data-number="7.2.2"><h3 data-number="7.2.2" class="anchored" data-anchor-id="fcase-múltiples-condiciones-elegantes">
<span class="header-section-number">7.2.2</span> 2. <strong><code>fcase()</code>: Múltiples Condiciones Elegantes</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Sistema de scoring complejo con fcase</span></span>
<span><span class="va">clientes_clasificacion</span><span class="op">[</span>, <span class="va">score_retencion</span> <span class="op">:=</span> <span class="fu">fcase</span><span class="op">(</span></span>
<span>  <span class="co"># Casos de alto valor</span></span>
<span>  <span class="va">plan</span> <span class="op">==</span> <span class="st">"Empresarial"</span> <span class="op">&amp;</span> <span class="va">activo</span> <span class="op">&amp;</span> <span class="va">ingresos_mensuales</span> <span class="op">&gt;</span> <span class="fl">5000</span>, <span class="fl">95</span>,</span>
<span>  <span class="va">plan</span> <span class="op">==</span> <span class="st">"Premium"</span> <span class="op">&amp;</span> <span class="va">activo</span> <span class="op">&amp;</span> <span class="va">ingresos_mensuales</span> <span class="op">&gt;</span> <span class="fl">3000</span>, <span class="fl">85</span>,</span>
<span>  <span class="va">plan</span> <span class="op">==</span> <span class="st">"Básico"</span> <span class="op">&amp;</span> <span class="va">activo</span> <span class="op">&amp;</span> <span class="va">ingresos_mensuales</span> <span class="op">&gt;</span> <span class="fl">4000</span>, <span class="fl">80</span>,</span>
<span>  </span>
<span>  <span class="co"># Casos de riesgo medio</span></span>
<span>  <span class="op">!</span><span class="va">activo</span> <span class="op">&amp;</span> <span class="va">ingresos_mensuales</span> <span class="op">&gt;</span> <span class="fl">3000</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">fecha_ultima_actividad</span><span class="op">)</span>, <span class="fl">60</span>,</span>
<span>  <span class="va">activo</span> <span class="op">&amp;</span> <span class="va">ingresos_mensuales</span> <span class="op">&lt;</span> <span class="fl">2000</span>, <span class="fl">55</span>,</span>
<span>  </span>
<span>  <span class="co"># Casos de alto riesgo</span></span>
<span>  <span class="op">!</span><span class="va">activo</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">fecha_ultima_actividad</span><span class="op">)</span>, <span class="fl">20</span>,</span>
<span>  <span class="op">!</span><span class="va">activo</span> <span class="op">&amp;</span> <span class="va">ingresos_mensuales</span> <span class="op">&lt;</span> <span class="fl">2000</span>, <span class="fl">15</span>,</span>
<span>  </span>
<span>  <span class="co"># Caso por defecto</span></span>
<span>  default <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Estrategia de retención basada en score</span></span>
<span><span class="va">clientes_clasificacion</span><span class="op">[</span>, <span class="va">estrategia_retencion</span> <span class="op">:=</span> <span class="fu">fcase</span><span class="op">(</span></span>
<span>  <span class="va">score_retencion</span> <span class="op">&gt;=</span> <span class="fl">90</span>, <span class="st">"Mantener_Premium"</span>,</span>
<span>  <span class="va">score_retencion</span> <span class="op">&gt;=</span> <span class="fl">70</span>, <span class="st">"Fidelizar_Activo"</span>, </span>
<span>  <span class="va">score_retencion</span> <span class="op">&gt;=</span> <span class="fl">50</span>, <span class="st">"Reactivar_Moderado"</span>,</span>
<span>  <span class="va">score_retencion</span> <span class="op">&gt;=</span> <span class="fl">30</span>, <span class="st">"Reactivar_Intensivo"</span>,</span>
<span>  default <span class="op">=</span> <span class="st">"Evaluar_Cancelación"</span></span>
<span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Resumen estratégico</span></span>
<span><span class="va">resumen_estrategia</span> <span class="op">&lt;-</span> <span class="va">clientes_clasificacion</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>  clientes <span class="op">=</span> <span class="va">.N</span>,</span>
<span>  score_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">score_retencion</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  ingresos_totales <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">ingresos_mensuales</span><span class="op">)</span>,</span>
<span>  valor_cliente_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">ingresos_mensuales</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="op">)</span>, by <span class="op">=</span> <span class="va">estrategia_retencion</span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">score_promedio</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Estrategias de retención por score:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Estrategias de retención por score:"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">resumen_estrategia</span><span class="op">)</span></span>
<span><span class="co">#&gt;    estrategia_retencion clientes score_promedio ingresos_totales</span></span>
<span><span class="co">#&gt;                  &lt;char&gt;    &lt;int&gt;          &lt;num&gt;            &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:     Mantener_Premium       21           95.0           243714</span></span>
<span><span class="co">#&gt; 2:     Fidelizar_Activo      430           82.0          5089950</span></span>
<span><span class="co">#&gt; 3:   Reactivar_Moderado      306           52.4           667565</span></span>
<span><span class="co">#&gt; 4:  Evaluar_Cancelación      243           20.0          1853637</span></span>
<span><span class="co">#&gt;    valor_cliente_promedio</span></span>
<span><span class="co">#&gt;                     &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:                  11605</span></span>
<span><span class="co">#&gt; 2:                  11837</span></span>
<span><span class="co">#&gt; 3:                   2182</span></span>
<span><span class="co">#&gt; 4:                   7628</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="between-rangos-eficientes" class="level3" data-number="7.2.3"><h3 data-number="7.2.3" class="anchored" data-anchor-id="between-rangos-eficientes">
<span class="header-section-number">7.2.3</span> 3. <strong><code>between()</code>: Rangos Eficientes</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Usar between para clasificaciones por rangos</span></span>
<span><span class="va">transacciones_analisis</span> <span class="op">&lt;-</span> <span class="fu">copy</span><span class="op">(</span><span class="va">transacciones_comportamiento</span><span class="op">)</span></span>
<span></span>
<span><span class="va">transacciones_analisis</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span></span>
<span>  <span class="co"># Clasificación por monto usando between</span></span>
<span>  categoria_monto <span class="op">=</span> <span class="fu">fcase</span><span class="op">(</span></span>
<span>    <span class="fu">between</span><span class="op">(</span><span class="va">monto</span>, <span class="fl">0</span>, <span class="fl">20</span><span class="op">)</span>, <span class="st">"Micro"</span>,</span>
<span>    <span class="fu">between</span><span class="op">(</span><span class="va">monto</span>, <span class="fl">20.01</span>, <span class="fl">100</span><span class="op">)</span>, <span class="st">"Pequeña"</span>, </span>
<span>    <span class="fu">between</span><span class="op">(</span><span class="va">monto</span>, <span class="fl">100.01</span>, <span class="fl">500</span><span class="op">)</span>, <span class="st">"Mediana"</span>,</span>
<span>    <span class="fu">between</span><span class="op">(</span><span class="va">monto</span>, <span class="fl">500.01</span>, <span class="fl">2000</span><span class="op">)</span>, <span class="st">"Grande"</span>,</span>
<span>    <span class="va">monto</span> <span class="op">&gt;</span> <span class="fl">2000</span>, <span class="st">"Muy Grande"</span>,</span>
<span>    default <span class="op">=</span> <span class="st">"Sin Clasificar"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># Clasificación temporal</span></span>
<span>  hora <span class="op">=</span> <span class="fu">hour</span><span class="op">(</span><span class="va">fecha_transaccion</span><span class="op">)</span>,</span>
<span>  franja_horaria <span class="op">=</span> <span class="fu">fcase</span><span class="op">(</span></span>
<span>    <span class="fu">between</span><span class="op">(</span><span class="fu">hour</span><span class="op">(</span><span class="va">fecha_transaccion</span><span class="op">)</span>, <span class="fl">6</span>, <span class="fl">11</span><span class="op">)</span>, <span class="st">"Mañana"</span>,</span>
<span>    <span class="fu">between</span><span class="op">(</span><span class="fu">hour</span><span class="op">(</span><span class="va">fecha_transaccion</span><span class="op">)</span>, <span class="fl">12</span>, <span class="fl">17</span><span class="op">)</span>, <span class="st">"Tarde"</span>, </span>
<span>    <span class="fu">between</span><span class="op">(</span><span class="fu">hour</span><span class="op">(</span><span class="va">fecha_transaccion</span><span class="op">)</span>, <span class="fl">18</span>, <span class="fl">22</span><span class="op">)</span>, <span class="st">"Noche"</span>,</span>
<span>    default <span class="op">=</span> <span class="st">"Madrugada"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># Día de la semana</span></span>
<span>  dia_semana <span class="op">=</span> <span class="fu">wday</span><span class="op">(</span><span class="va">fecha_transaccion</span>, label <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  es_fin_semana <span class="op">=</span> <span class="fu">wday</span><span class="op">(</span><span class="va">fecha_transaccion</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">7</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Análisis de patrones de comportamiento</span></span>
<span><span class="va">patrones_comportamiento</span> <span class="op">&lt;-</span> <span class="va">transacciones_analisis</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>  transacciones <span class="op">=</span> <span class="va">.N</span>,</span>
<span>  monto_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">monto</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  monto_mediana <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">monto</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  monto_total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">monto</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">categoria_monto</span>, <span class="va">franja_horaria</span>, <span class="va">es_fin_semana</span><span class="op">)</span><span class="op">]</span><span class="op">[</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">transacciones</span><span class="op">)</span></span>
<span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Patrones de comportamiento transaccional:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Patrones de comportamiento transaccional:"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">patrones_comportamiento</span>, <span class="fl">12</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;     categoria_monto franja_horaria es_fin_semana transacciones monto_promedio</span></span>
<span><span class="co">#&gt;              &lt;char&gt;         &lt;char&gt;        &lt;lgcl&gt;         &lt;int&gt;          &lt;num&gt;</span></span>
<span><span class="co">#&gt;  1:         Pequeña      Madrugada         FALSE           537          49.61</span></span>
<span><span class="co">#&gt;  2:         Pequeña          Tarde         FALSE           466          50.91</span></span>
<span><span class="co">#&gt;  3:         Pequeña         Mañana         FALSE           439          51.73</span></span>
<span><span class="co">#&gt;  4:         Pequeña          Noche         FALSE           362          50.49</span></span>
<span><span class="co">#&gt;  5:         Mediana      Madrugada         FALSE           308         199.17</span></span>
<span><span class="co">#&gt; ---                                                                          </span></span>
<span><span class="co">#&gt;  8:         Mediana         Mañana         FALSE           211         197.70</span></span>
<span><span class="co">#&gt;  9:           Micro      Madrugada         FALSE           204          11.42</span></span>
<span><span class="co">#&gt; 10:         Mediana          Noche         FALSE           202         200.49</span></span>
<span><span class="co">#&gt; 11:           Micro          Tarde         FALSE           187          11.64</span></span>
<span><span class="co">#&gt; 12:           Micro         Mañana         FALSE           181          11.72</span></span>
<span><span class="co">#&gt;     monto_mediana monto_total</span></span>
<span><span class="co">#&gt;             &lt;num&gt;       &lt;num&gt;</span></span>
<span><span class="co">#&gt;  1:         46.62    26642.18</span></span>
<span><span class="co">#&gt;  2:         45.80    23722.06</span></span>
<span><span class="co">#&gt;  3:         48.07    22711.20</span></span>
<span><span class="co">#&gt;  4:         46.15    18276.34</span></span>
<span><span class="co">#&gt;  5:        166.66    61345.74</span></span>
<span><span class="co">#&gt; ---                          </span></span>
<span><span class="co">#&gt;  8:        161.64    41715.23</span></span>
<span><span class="co">#&gt;  9:         11.62     2330.31</span></span>
<span><span class="co">#&gt; 10:        169.60    40499.76</span></span>
<span><span class="co">#&gt; 11:         11.99     2176.52</span></span>
<span><span class="co">#&gt; 12:         11.66     2121.67</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="funciones-de-agregación-especiales" class="level2" data-number="7.3"><h2 data-number="7.3" class="anchored" data-anchor-id="funciones-de-agregación-especiales">
<span class="header-section-number">7.3</span> Funciones de Agregación Especiales</h2>
<section id="frank-rankings-y-percentiles" class="level3" data-number="7.3.1"><h3 data-number="7.3.1" class="anchored" data-anchor-id="frank-rankings-y-percentiles">
<span class="header-section-number">7.3.1</span> 1. <strong><code>frank()</code>: Rankings y Percentiles</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Rankings complejos con frank()</span></span>
<span><span class="va">rankings_clientes</span> <span class="op">&lt;-</span> <span class="va">clientes_clasificacion</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span></span>
<span>  <span class="co"># Ranking por ingresos (descendente)</span></span>
<span>  rank_ingresos <span class="op">=</span> <span class="fu">frank</span><span class="op">(</span><span class="op">-</span><span class="va">ingresos_mensuales</span><span class="op">)</span>,</span>
<span>  rank_ingresos_pct <span class="op">=</span> <span class="fu">frank</span><span class="op">(</span><span class="op">-</span><span class="va">ingresos_mensuales</span> <span class="op">/</span> <span class="va">.N</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># Ranking por score de retención</span></span>
<span>  rank_retencion <span class="op">=</span> <span class="fu">frank</span><span class="op">(</span><span class="op">-</span><span class="va">score_retencion</span><span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># Ranking dentro de cada plan</span></span>
<span>  rank_en_plan <span class="op">=</span> <span class="fu">frank</span><span class="op">(</span><span class="va">.SD</span><span class="op">[</span>,<span class="op">-</span><span class="va">ingresos_mensuales</span>, by <span class="op">=</span> <span class="va">plan</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  rank_en_pais <span class="op">=</span> <span class="fu">frank</span><span class="op">(</span><span class="va">.SD</span><span class="op">[</span>,<span class="op">-</span><span class="va">ingresos_mensuales</span>, by <span class="op">=</span> <span class="va">pais</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Top performers por categoría</span></span>
<span><span class="va">top_performers</span> <span class="op">&lt;-</span> <span class="va">rankings_clientes</span><span class="op">[</span><span class="va">rank_ingresos</span> <span class="op">&lt;=</span> <span class="fl">50</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>  <span class="va">cliente_id</span>, <span class="va">plan</span>, <span class="va">pais</span>, <span class="va">ingresos_mensuales</span>, <span class="va">score_retencion</span>,</span>
<span>  rank_global <span class="op">=</span> <span class="va">rank_ingresos</span>,</span>
<span>  <span class="va">rank_en_plan</span>, <span class="va">rank_en_pais</span>,</span>
<span>  percentil_ingresos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">-</span> <span class="va">rank_ingresos_pct</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">rank_global</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Top 10 clientes por ingresos:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Top 10 clientes por ingresos:"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">top_performers</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;     cliente_id    plan      pais ingresos_mensuales score_retencion rank_global</span></span>
<span><span class="co">#&gt;          &lt;int&gt;  &lt;char&gt;    &lt;char&gt;              &lt;num&gt;           &lt;num&gt;       &lt;num&gt;</span></span>
<span><span class="co">#&gt;  1:        780  Básico    España             114272              80           1</span></span>
<span><span class="co">#&gt;  2:        579  Básico    México             112313              20           2</span></span>
<span><span class="co">#&gt;  3:        862  Básico Argentina              93104              80           3</span></span>
<span><span class="co">#&gt;  4:        537 Premium    España              74834              20           4</span></span>
<span><span class="co">#&gt;  5:        204 Premium Argentina              66981              85           5</span></span>
<span><span class="co">#&gt;  6:        559 Premium Argentina              64783              85           6</span></span>
<span><span class="co">#&gt;  7:        370  Básico     Chile              63261              80           7</span></span>
<span><span class="co">#&gt;  8:        447 Premium    España              58316              85           8</span></span>
<span><span class="co">#&gt;  9:        220  Básico  Colombia              47912              80           9</span></span>
<span><span class="co">#&gt; 10:        522  Básico    México              44810              80          10</span></span>
<span><span class="co">#&gt;     rank_en_plan rank_en_pais percentil_ingresos</span></span>
<span><span class="co">#&gt;            &lt;num&gt;        &lt;num&gt;              &lt;num&gt;</span></span>
<span><span class="co">#&gt;  1:          270          797                 99</span></span>
<span><span class="co">#&gt;  2:          408          448                 98</span></span>
<span><span class="co">#&gt;  3:          430          401                 97</span></span>
<span><span class="co">#&gt;  4:          575          597                 96</span></span>
<span><span class="co">#&gt;  5:          833          159                 95</span></span>
<span><span class="co">#&gt;  6:          223          588                 94</span></span>
<span><span class="co">#&gt;  7:          500          198                 93</span></span>
<span><span class="co">#&gt;  8:          229          612                 92</span></span>
<span><span class="co">#&gt;  9:          979           80                 91</span></span>
<span><span class="co">#&gt; 10:           16          485                 90</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="rleid-identificación-de-runs" class="level3" data-number="7.3.2"><h3 data-number="7.3.2" class="anchored" data-anchor-id="rleid-identificación-de-runs">
<span class="header-section-number">7.3.2</span> 2. <strong><code>rleid()</code>: Identificación de Runs</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Identificar secuencias de comportamiento con rleid()</span></span>
<span><span class="va">sensores_runs</span> <span class="op">&lt;-</span> <span class="va">sensores_temperatura</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">sensor_id</span>, <span class="va">timestamp</span><span class="op">)</span><span class="op">]</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span></span>
<span>  <span class="co"># Clasificar temperatura en rangos</span></span>
<span>  temp_categoria <span class="op">=</span> <span class="fu">fcase</span><span class="op">(</span></span>
<span>    <span class="va">temperatura</span> <span class="op">&lt;</span> <span class="fl">18</span>, <span class="st">"Baja"</span>,</span>
<span>    <span class="fu">between</span><span class="op">(</span><span class="va">temperatura</span>, <span class="fl">18</span>, <span class="fl">22</span><span class="op">)</span>, <span class="st">"Normal"</span>,</span>
<span>    <span class="fu">between</span><span class="op">(</span><span class="va">temperatura</span>, <span class="fl">22</span>, <span class="fl">26</span><span class="op">)</span>, <span class="st">"Alta"</span>,</span>
<span>    <span class="va">temperatura</span> <span class="op">&gt;</span> <span class="fl">26</span>, <span class="st">"Muy Alta"</span>,</span>
<span>    default <span class="op">=</span> <span class="st">"Sin Datos"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span><span class="op">]</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span></span>
<span>  <span class="co"># Identificar runs (secuencias consecutivas)</span></span>
<span>  run_id <span class="op">=</span> <span class="fu">rleid</span><span class="op">(</span><span class="va">temp_categoria</span><span class="op">)</span>,</span>
<span>  <span class="co"># También podemos identificar runs de tendencia</span></span>
<span>  tendencia <span class="op">=</span> <span class="fu">fcase</span><span class="op">(</span></span>
<span>    <span class="va">temperatura</span> <span class="op">&gt;</span> <span class="fu">shift</span><span class="op">(</span><span class="va">temperatura</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"Subida"</span>,</span>
<span>    <span class="va">temperatura</span> <span class="op">&lt;</span> <span class="fu">shift</span><span class="op">(</span><span class="va">temperatura</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"Bajada"</span>, </span>
<span>    default <span class="op">=</span> <span class="st">"Estable"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span>, by <span class="op">=</span> <span class="va">sensor_id</span><span class="op">]</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span></span>
<span>  run_tendencia <span class="op">=</span> <span class="fu">rleid</span><span class="op">(</span><span class="va">tendencia</span><span class="op">)</span></span>
<span><span class="op">)</span>, by <span class="op">=</span> <span class="va">sensor_id</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Análisis de runs de temperatura</span></span>
<span><span class="va">analisis_runs</span> <span class="op">&lt;-</span> <span class="va">sensores_runs</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">temperatura</span><span class="op">)</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>  duracion_run <span class="op">=</span> <span class="va">.N</span>,</span>
<span>  temp_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">temperatura</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  temp_min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">temperatura</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  temp_max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">temperatura</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  inicio_run <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">timestamp</span><span class="op">)</span>,</span>
<span>  fin_run <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">timestamp</span><span class="op">)</span></span>
<span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">sensor_id</span>, <span class="va">temp_categoria</span>, <span class="va">run_id</span><span class="op">)</span><span class="op">]</span><span class="op">[</span></span>
<span>  <span class="va">duracion_run</span> <span class="op">&gt;=</span> <span class="fl">4</span>  <span class="co"># Solo runs de al menos 4 mediciones (1 hora)</span></span>
<span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">sensor_id</span>, <span class="op">-</span><span class="va">duracion_run</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Runs de temperatura más largos:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Runs de temperatura más largos:"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">analisis_runs</span>, <span class="fl">12</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;     sensor_id temp_categoria run_id duracion_run temp_promedio temp_min</span></span>
<span><span class="co">#&gt;        &lt;char&gt;         &lt;char&gt;  &lt;int&gt;        &lt;int&gt;         &lt;num&gt;    &lt;num&gt;</span></span>
<span><span class="co">#&gt;  1:    TEMP_A           Baja     82           31          15.8     13.4</span></span>
<span><span class="co">#&gt;  2:    TEMP_A           Baja    126           31          15.7     13.4</span></span>
<span><span class="co">#&gt;  3:    TEMP_A           Baja    144           31          15.8     13.2</span></span>
<span><span class="co">#&gt;  4:    TEMP_A           Alta    118           30          24.1     22.5</span></span>
<span><span class="co">#&gt;  5:    TEMP_A           Baja     20           28          15.9     13.5</span></span>
<span><span class="co">#&gt; ---                                                                    </span></span>
<span><span class="co">#&gt;  8:    TEMP_A           Alta    132           22          24.4     22.5</span></span>
<span><span class="co">#&gt;  9:    TEMP_A           Baja    106           21          15.5     13.2</span></span>
<span><span class="co">#&gt; 10:    TEMP_A           Alta     48           20          24.0     22.1</span></span>
<span><span class="co">#&gt; 11:    TEMP_A           Alta     94           19          24.2     22.3</span></span>
<span><span class="co">#&gt; 12:    TEMP_A           Alta     26           18          23.9     22.2</span></span>
<span><span class="co">#&gt;     temp_max          inicio_run             fin_run</span></span>
<span><span class="co">#&gt;        &lt;num&gt;              &lt;POSc&gt;              &lt;POSc&gt;</span></span>
<span><span class="co">#&gt;  1:     17.9 2024-06-04 14:30:00 2024-06-04 22:00:00</span></span>
<span><span class="co">#&gt;  2:     18.0 2024-06-06 14:15:00 2024-06-06 21:45:00</span></span>
<span><span class="co">#&gt;  3:     17.7 2024-06-07 14:00:00 2024-06-07 21:30:00</span></span>
<span><span class="co">#&gt;  4:     25.8 2024-06-06 02:30:00 2024-06-06 09:45:00</span></span>
<span><span class="co">#&gt;  5:     18.0 2024-06-01 15:15:00 2024-06-01 22:00:00</span></span>
<span><span class="co">#&gt; ---                                                 </span></span>
<span><span class="co">#&gt;  8:     26.0 2024-06-07 02:00:00 2024-06-07 07:15:00</span></span>
<span><span class="co">#&gt;  9:     17.3 2024-06-05 15:00:00 2024-06-05 20:00:00</span></span>
<span><span class="co">#&gt; 10:     25.5 2024-06-03 05:45:00 2024-06-03 10:30:00</span></span>
<span><span class="co">#&gt; 11:     26.0 2024-06-05 05:00:00 2024-06-05 09:30:00</span></span>
<span><span class="co">#&gt; 12:     25.7 2024-06-02 01:45:00 2024-06-02 06:00:00</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="uniquen-conteos-de-únicos-eficientes" class="level3" data-number="7.3.3"><h3 data-number="7.3.3" class="anchored" data-anchor-id="uniquen-conteos-de-únicos-eficientes">
<span class="header-section-number">7.3.3</span> 3. <strong><code>uniqueN()</code>: Conteos de Únicos Eficientes</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Análisis de diversidad con uniqueN()</span></span>
<span><span class="va">diversidad_transacciones</span> <span class="op">&lt;-</span> <span class="va">transacciones_analisis</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>  <span class="co"># Diversidad básica</span></span>
<span>  transacciones_totales <span class="op">=</span> <span class="va">.N</span>,</span>
<span>  categorias_usadas <span class="op">=</span> <span class="fu">uniqueN</span><span class="op">(</span><span class="va">categoria</span><span class="op">)</span>,</span>
<span>  comercios_visitados <span class="op">=</span> <span class="fu">uniqueN</span><span class="op">(</span><span class="va">comercio_id</span><span class="op">)</span>,</span>
<span>  metodos_pago_usados <span class="op">=</span> <span class="fu">uniqueN</span><span class="op">(</span><span class="va">metodo_pago</span><span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># Métricas de comportamiento</span></span>
<span>  dias_activos <span class="op">=</span> <span class="fu">uniqueN</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">fecha_transaccion</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  horas_activas <span class="op">=</span> <span class="fu">uniqueN</span><span class="op">(</span><span class="fu">hour</span><span class="op">(</span><span class="va">fecha_transaccion</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  monto_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">monto</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># Diversidad temporal</span></span>
<span>  meses_activos <span class="op">=</span> <span class="fu">uniqueN</span><span class="op">(</span><span class="fu">month</span><span class="op">(</span><span class="va">fecha_transaccion</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  dias_semana_activos <span class="op">=</span> <span class="fu">uniqueN</span><span class="op">(</span><span class="fu">wday</span><span class="op">(</span><span class="va">fecha_transaccion</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span>, by <span class="op">=</span> <span class="va">cliente_id</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Calcular índices de diversidad</span></span>
<span><span class="va">diversidad_transacciones</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span></span>
<span>  indice_diversidad_categoria <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">categorias_usadas</span> <span class="op">/</span> <span class="fl">5</span> <span class="op">*</span> <span class="fl">100</span>, <span class="fl">1</span><span class="op">)</span>,  <span class="co"># 5 categorías posibles</span></span>
<span>  indice_diversidad_temporal <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">horas_activas</span> <span class="op">/</span> <span class="fl">24</span> <span class="op">*</span> <span class="fl">100</span>, <span class="fl">1</span><span class="op">)</span>,      <span class="co"># 24 horas posibles</span></span>
<span>  indice_actividad <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">dias_activos</span> <span class="op">/</span> <span class="fl">180</span> <span class="op">*</span> <span class="fl">100</span>, <span class="fl">1</span><span class="op">)</span>,                <span class="co"># ~180 días en periodo</span></span>
<span>  score_engagement <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="op">(</span><span class="va">categorias_usadas</span> <span class="op">*</span> <span class="fl">10</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">dias_activos</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">comercios_visitados</span> <span class="op">*</span> <span class="fl">3</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Clasificar clientes por engagement</span></span>
<span><span class="va">diversidad_transacciones</span><span class="op">[</span>, <span class="va">categoria_engagement</span> <span class="op">:=</span> <span class="fu">fcase</span><span class="op">(</span></span>
<span>  <span class="va">score_engagement</span> <span class="op">&gt;</span> <span class="fl">200</span>, <span class="st">"Muy Alto"</span>,</span>
<span>  <span class="va">score_engagement</span> <span class="op">&gt;</span> <span class="fl">100</span>, <span class="st">"Alto"</span>,</span>
<span>  <span class="va">score_engagement</span> <span class="op">&gt;</span> <span class="fl">50</span>, <span class="st">"Medio"</span>, </span>
<span>  <span class="va">score_engagement</span> <span class="op">&gt;</span> <span class="fl">20</span>, <span class="st">"Bajo"</span>,</span>
<span>  default <span class="op">=</span> <span class="st">"Muy Bajo"</span></span>
<span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Resumen por categoría de engagement</span></span>
<span><span class="va">resumen_engagement</span> <span class="op">&lt;-</span> <span class="va">diversidad_transacciones</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>  clientes <span class="op">=</span> <span class="va">.N</span>,</span>
<span>  transacciones_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">transacciones_totales</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  diversidad_categoria_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">indice_diversidad_categoria</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  score_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">score_engagement</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="op">)</span>, by <span class="op">=</span> <span class="va">categoria_engagement</span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">score_promedio</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Análisis de engagement de clientes:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Análisis de engagement de clientes:"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">resumen_engagement</span><span class="op">)</span></span>
<span><span class="co">#&gt;    categoria_engagement clientes transacciones_promedio</span></span>
<span><span class="co">#&gt;                  &lt;char&gt;    &lt;int&gt;                  &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:                 Alto       10                   11.7</span></span>
<span><span class="co">#&gt; 2:                Medio      582                    6.3</span></span>
<span><span class="co">#&gt; 3:                 Bajo      352                    3.3</span></span>
<span><span class="co">#&gt; 4:             Muy Bajo       46                    1.3</span></span>
<span><span class="co">#&gt;    diversidad_categoria_promedio score_promedio</span></span>
<span><span class="co">#&gt;                            &lt;num&gt;          &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:                         100.0            107</span></span>
<span><span class="co">#&gt; 2:                          74.8             68</span></span>
<span><span class="co">#&gt; 3:                          48.0             40</span></span>
<span><span class="co">#&gt; 4:                          20.0             16</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="análisis-temporal-avanzado" class="level2" data-number="7.4"><h2 data-number="7.4" class="anchored" data-anchor-id="análisis-temporal-avanzado">
<span class="header-section-number">7.4</span> Análisis Temporal Avanzado</h2>
<section id="detección-de-anomalías-temporales" class="level3" data-number="7.4.1"><h3 data-number="7.4.1" class="anchored" data-anchor-id="detección-de-anomalías-temporales">
<span class="header-section-number">7.4.1</span> 1. <strong>Detección de Anomalías Temporales</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Sistema de detección de anomalías para sensores</span></span>
<span><span class="va">anomalias_sensores</span> <span class="op">&lt;-</span> <span class="va">sensores_temperatura</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">sensor_id</span>, <span class="va">timestamp</span><span class="op">)</span><span class="op">]</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span></span>
<span>  <span class="co"># Medias móviles para diferentes ventanas</span></span>
<span>  temp_ma_short <span class="op">=</span> <span class="fu">frollmean</span><span class="op">(</span><span class="va">temperatura</span>, <span class="fl">4</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,    <span class="co"># 1 hora</span></span>
<span>  temp_ma_long <span class="op">=</span> <span class="fu">frollmean</span><span class="op">(</span><span class="va">temperatura</span>, <span class="fl">24</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,    <span class="co"># 6 horas</span></span>
<span>  temp_sd_window <span class="op">=</span> <span class="fu">frollapply</span><span class="op">(</span><span class="va">temperatura</span>, <span class="fl">12</span>, <span class="va">sd</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="co"># Desviación móvil</span></span>
<span>  </span>
<span>  <span class="co"># Cambios absolutos</span></span>
<span>  cambio_temp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">temperatura</span> <span class="op">-</span> <span class="fu">shift</span><span class="op">(</span><span class="va">temperatura</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  cambio_temp_2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">temperatura</span> <span class="op">-</span> <span class="fu">shift</span><span class="op">(</span><span class="va">temperatura</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span>, by <span class="op">=</span> <span class="va">sensor_id</span><span class="op">]</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span></span>
<span>  <span class="co"># Detección de anomalías</span></span>
<span>  anomalia_spike <span class="op">=</span> <span class="va">cambio_temp</span> <span class="op">&gt;</span> <span class="fl">3</span>,  <span class="co"># Cambio súbito &gt; 3 grados</span></span>
<span>  anomalia_drift <span class="op">=</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">temp_ma_long</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">temperatura</span> <span class="op">-</span> <span class="va">temp_ma_long</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">5</span>, <span class="co"># Desviación &gt; 5 grados de media larga</span></span>
<span>  anomalia_variabilidad <span class="op">=</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">temp_sd_window</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">temp_sd_window</span> <span class="op">&gt;</span> <span class="fl">2</span> <span class="co"># Alta variabilidad</span></span>
<span>  </span>
<span> </span>
<span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Score compuesto de anomalía</span></span>
<span><span class="va">anomalias_sensores</span><span class="op">[</span>, <span class="va">score_anomalia</span> <span class="op">:=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">anomalia_spike</span><span class="op">)</span> <span class="op">*</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                  <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">anomalia_drift</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                  <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">anomalia_variabilidad</span><span class="op">)</span> <span class="op">*</span> <span class="fl">1</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span></span>
<span><span class="co"># Resumen de anomalías por sensor</span></span>
<span><span class="va">resumen_anomalias</span> <span class="op">&lt;-</span> <span class="va">anomalias_sensores</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">temperatura</span><span class="op">)</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>  lecturas_totales <span class="op">=</span> <span class="va">.N</span>,</span>
<span>  anomalias_spike <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">anomalia_spike</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  anomalias_drift <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">anomalia_drift</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  anomalias_variabilidad <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">anomalia_variabilidad</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  score_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">score_anomalia</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  temp_min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">temperatura</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  temp_max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">temperatura</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">sensor_id</span>, <span class="va">ubicacion</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Resumen de anomalías por sensor:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Resumen de anomalías por sensor:"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">resumen_anomalias</span><span class="op">)</span></span>
<span><span class="co">#&gt;    sensor_id ubicacion lecturas_totales anomalias_spike anomalias_drift</span></span>
<span><span class="co">#&gt;       &lt;char&gt;    &lt;char&gt;            &lt;int&gt;           &lt;int&gt;           &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1:    TEMP_A Almacén_A              672              19               8</span></span>
<span><span class="co">#&gt; 2:    TEMP_B Almacén_B              672              10               0</span></span>
<span><span class="co">#&gt; 3:    TEMP_C Almacén_C              672               0               0</span></span>
<span><span class="co">#&gt;    anomalias_variabilidad score_promedio temp_min temp_max</span></span>
<span><span class="co">#&gt;                     &lt;int&gt;          &lt;num&gt;    &lt;num&gt;    &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:                      1           0.11     13.2     27.2</span></span>
<span><span class="co">#&gt; 2:                      0           0.04     16.5     27.1</span></span>
<span><span class="co">#&gt; 3:                      0           0.00     15.9     38.8</span></span>
<span></span>
<span><span class="co"># Top anomalías individuales</span></span>
<span><span class="va">top_anomalias</span> <span class="op">&lt;-</span> <span class="va">anomalias_sensores</span><span class="op">[</span><span class="va">score_anomalia</span> <span class="op">&gt;=</span> <span class="fl">2</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>  <span class="va">sensor_id</span>, <span class="va">timestamp</span>, <span class="va">temperatura</span>, <span class="va">temp_ma_long</span>, </span>
<span>  <span class="va">cambio_temp</span>, <span class="va">score_anomalia</span></span>
<span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">score_anomalia</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">top_anomalias</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"\nTop anomalías detectadas:"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">top_anomalias</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\nNo se detectaron anomalías significativas (score &gt;= 2)\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; [1] "\nTop anomalías detectadas:"</span></span>
<span><span class="co">#&gt;    sensor_id           timestamp temperatura temp_ma_long cambio_temp</span></span>
<span><span class="co">#&gt;       &lt;char&gt;              &lt;POSc&gt;       &lt;num&gt;        &lt;num&gt;       &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:    TEMP_A 2024-06-01 15:30:00    13.50388     19.24389    3.124197</span></span>
<span><span class="co">#&gt; 2:    TEMP_A 2024-06-06 02:30:00    25.62026     19.74337    4.480706</span></span>
<span><span class="co">#&gt; 3:    TEMP_A 2024-06-07 15:00:00    13.46347     19.12156    3.591262</span></span>
<span><span class="co">#&gt; 4:    TEMP_A 2024-06-01 02:00:00    20.49440           NA    3.496907</span></span>
<span><span class="co">#&gt; 5:    TEMP_A 2024-06-01 05:00:00    26.15761           NA    3.017316</span></span>
<span><span class="co">#&gt; 6:    TEMP_A 2024-06-02 08:00:00    22.85221     24.44104    3.189825</span></span>
<span><span class="co">#&gt; 7:    TEMP_A 2024-06-02 17:15:00    17.92243     17.55434    3.547180</span></span>
<span><span class="co">#&gt; 8:    TEMP_A 2024-06-03 19:15:00    17.64803     16.20537    3.936311</span></span>
<span><span class="co">#&gt;    score_anomalia</span></span>
<span><span class="co">#&gt;             &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:              5</span></span>
<span><span class="co">#&gt; 2:              5</span></span>
<span><span class="co">#&gt; 3:              5</span></span>
<span><span class="co">#&gt; 4:              3</span></span>
<span><span class="co">#&gt; 5:              3</span></span>
<span><span class="co">#&gt; 6:              3</span></span>
<span><span class="co">#&gt; 7:              3</span></span>
<span><span class="co">#&gt; 8:              3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="análisis-de-ciclos-y-estacionalidad" class="level3" data-number="7.4.2"><h3 data-number="7.4.2" class="anchored" data-anchor-id="análisis-de-ciclos-y-estacionalidad">
<span class="header-section-number">7.4.2</span> 2. <strong>Análisis de Ciclos y Estacionalidad</strong>
</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Análisis de patrones cíclicos en datos de sensores</span></span>
<span><span class="va">patrones_ciclicos</span> <span class="op">&lt;-</span> <span class="va">sensores_temperatura</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">temperatura</span><span class="op">)</span><span class="op">]</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span></span>
<span>  hora <span class="op">=</span> <span class="fu">hour</span><span class="op">(</span><span class="va">timestamp</span><span class="op">)</span>,</span>
<span>  dia <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">timestamp</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">timestamp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>,</span>
<span>  minuto_del_dia <span class="op">=</span> <span class="fu">hour</span><span class="op">(</span><span class="va">timestamp</span><span class="op">)</span> <span class="op">*</span> <span class="fl">60</span> <span class="op">+</span> <span class="fu">minute</span><span class="op">(</span><span class="va">timestamp</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">]</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>  temperatura_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">temperatura</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  temperatura_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">temperatura</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  lecturas <span class="op">=</span> <span class="va">.N</span></span>
<span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">sensor_id</span>, <span class="va">hora</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Identificar patrones horarios</span></span>
<span><span class="va">patrones_resumen</span> <span class="op">&lt;-</span> <span class="va">patrones_ciclicos</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>  hora_mas_fria <span class="op">=</span> <span class="va">hora</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html">which.min</a></span><span class="op">(</span><span class="va">temperatura_promedio</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  temp_mas_fria <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">temperatura_promedio</span><span class="op">)</span>,</span>
<span>  hora_mas_calida <span class="op">=</span> <span class="va">hora</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html">which.max</a></span><span class="op">(</span><span class="va">temperatura_promedio</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  temp_mas_calida <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">temperatura_promedio</span><span class="op">)</span>,</span>
<span>  amplitud_termica <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">temperatura_promedio</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">temperatura_promedio</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  variabilidad_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">temperatura_sd</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span>, by <span class="op">=</span> <span class="va">sensor_id</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Patrones térmicos diarios por sensor:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Patrones térmicos diarios por sensor:"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">patrones_resumen</span><span class="op">)</span></span>
<span><span class="co">#&gt;    sensor_id hora_mas_fria temp_mas_fria hora_mas_calida temp_mas_calida</span></span>
<span><span class="co">#&gt;       &lt;char&gt;         &lt;int&gt;         &lt;num&gt;           &lt;int&gt;           &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:    TEMP_A            17          15.1               5            25.0</span></span>
<span><span class="co">#&gt; 2:    TEMP_B            10          19.0              22            25.1</span></span>
<span><span class="co">#&gt; 3:    TEMP_C             4          23.3              21            26.1</span></span>
<span><span class="co">#&gt;    amplitud_termica variabilidad_promedio</span></span>
<span><span class="co">#&gt;               &lt;num&gt;                 &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:              9.9                  1.01</span></span>
<span><span class="co">#&gt; 2:              6.1                  0.84</span></span>
<span><span class="co">#&gt; 3:              2.8                  5.23</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="ejercicios-prácticos" class="level2" data-number="7.5"><h2 data-number="7.5" class="anchored" data-anchor-id="ejercicios-prácticos">
<span class="header-section-number">7.5</span> Ejercicios Prácticos</h2>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
🏋️ Ejercicio 11: Sistema de Alertas de Anomalías
</div>
</div>
<div class="callout-body-container callout-body">
<p>Usando los datasets de sensores y transacciones:</p>
<ol type="1">
<li>
<strong>Implementa</strong> un sistema de detección de anomalías multicapa</li>
<li>
<strong>Usa <code>frollapply()</code></strong> para ventanas personalizadas de detección</li>
<li>
<strong>Clasifica anomalías</strong> con <code>fcase()</code> por severidad</li>
<li>
<strong>Genera alertas</strong> automáticas con <code>rleid()</code> para secuencias anómalas</li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
💡 Solución del Ejercicio 11
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Sistema completo de detección de anomalías multicapa</span></span>
<span><span class="co"># CAPA 1: Anomalías estadísticas</span></span>
<span><span class="va">sistema_anomalias</span> <span class="op">&lt;-</span> <span class="va">sensores_temperatura</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">sensor_id</span>, <span class="va">timestamp</span><span class="op">)</span><span class="op">]</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span></span>
<span>  <span class="co"># Ventanas de referencia</span></span>
<span>  temp_ma_1h <span class="op">=</span> <span class="fu">frollmean</span><span class="op">(</span><span class="va">temperatura</span>, <span class="fl">4</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  temp_ma_6h <span class="op">=</span> <span class="fu">frollmean</span><span class="op">(</span><span class="va">temperatura</span>, <span class="fl">24</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>  temp_ma_24h <span class="op">=</span> <span class="fu">frollmean</span><span class="op">(</span><span class="va">temperatura</span>, <span class="fl">96</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># Medidas de variabilidad</span></span>
<span>  temp_sd_1h <span class="op">=</span> <span class="fu">frollapply</span><span class="op">(</span><span class="va">temperatura</span>, <span class="fl">4</span>, <span class="va">sd</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  temp_sd_6h <span class="op">=</span> <span class="fu">frollapply</span><span class="op">(</span><span class="va">temperatura</span>, <span class="fl">24</span>, <span class="va">sd</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># Percentiles móviles</span></span>
<span>  temp_p25_6h <span class="op">=</span> <span class="fu">frollapply</span><span class="op">(</span><span class="va">temperatura</span>, <span class="fl">24</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0.25</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  temp_p75_6h <span class="op">=</span> <span class="fu">frollapply</span><span class="op">(</span><span class="va">temperatura</span>, <span class="fl">24</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0.75</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># Cambios temporales</span></span>
<span>  cambio_15min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">temperatura</span> <span class="op">-</span> <span class="fu">shift</span><span class="op">(</span><span class="va">temperatura</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  cambio_1h <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">temperatura</span> <span class="op">-</span> <span class="fu">shift</span><span class="op">(</span><span class="va">temperatura</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  tendencia_1h <span class="op">=</span> <span class="fu">frollapply</span><span class="op">(</span><span class="va">temperatura</span>, <span class="fl">4</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">4</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">x</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">)</span>, by <span class="op">=</span> <span class="va">sensor_id</span><span class="op">]</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span></span>
<span>  <span class="co"># CAPA 2: Detección de anomalías específicas</span></span>
<span>  anomalia_spike <span class="op">=</span> <span class="va">cambio_15min</span> <span class="op">&gt;</span> <span class="fl">5</span>,  <span class="co"># Cambio súbito &gt; 5°C</span></span>
<span>  anomalia_drift <span class="op">=</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">temp_ma_6h</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">temperatura</span> <span class="op">-</span> <span class="va">temp_ma_6h</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">4</span>, <span class="co"># Drift &gt; 4°C</span></span>
<span>  anomalia_variabilidad <span class="op">=</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">temp_sd_1h</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">temp_sd_1h</span> <span class="op">&gt;</span> <span class="fl">3</span>, <span class="co"># Alta variabilidad</span></span>
<span>  anomalia_outlier <span class="op">=</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">temp_p25_6h</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">temp_p75_6h</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>                    <span class="op">(</span><span class="va">temperatura</span> <span class="op">&lt;</span> <span class="op">(</span><span class="va">temp_p25_6h</span> <span class="op">-</span> <span class="fl">1.5</span><span class="op">*</span><span class="op">(</span><span class="va">temp_p75_6h</span> <span class="op">-</span> <span class="va">temp_p25_6h</span><span class="op">)</span><span class="op">)</span> <span class="op">|</span></span>
<span>                     <span class="va">temperatura</span> <span class="op">&gt;</span> <span class="op">(</span><span class="va">temp_p75_6h</span> <span class="op">+</span> <span class="fl">1.5</span><span class="op">*</span><span class="op">(</span><span class="va">temp_p75_6h</span> <span class="op">-</span> <span class="va">temp_p25_6h</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  anomalia_tendencia <span class="op">=</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">tendencia_1h</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">tendencia_1h</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span>, <span class="co"># Tendencia &gt; 1°C/15min</span></span>
<span>  anomalia_frozen <span class="op">=</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">temp_sd_1h</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">temp_sd_1h</span> <span class="op">&lt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">temperatura</span><span class="op">)</span>  <span class="co"># Sensor "congelado"</span></span>
<span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># CAPA 3: Clasificación por severidad con fcase()</span></span>
<span><span class="va">sistema_anomalias</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span></span>
<span>  <span class="co"># Score compuesto</span></span>
<span>  score_anomalia <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">anomalia_spike</span><span class="op">)</span> <span class="op">*</span> <span class="fl">5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                  <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">anomalia_drift</span><span class="op">)</span> <span class="op">*</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>                  <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">anomalia_variabilidad</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>                  <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">anomalia_outlier</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>                  <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">anomalia_tendencia</span><span class="op">)</span> <span class="op">*</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>                  <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">anomalia_frozen</span><span class="op">)</span> <span class="op">*</span> <span class="fl">6</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">]</span><span class="op">[</span>, <span class="va">severidad</span> <span class="op">:=</span> <span class="fu">fcase</span><span class="op">(</span></span>
<span>  <span class="va">score_anomalia</span> <span class="op">&gt;=</span> <span class="fl">10</span>, <span class="st">"CRÍTICA"</span>,</span>
<span>  <span class="va">score_anomalia</span> <span class="op">&gt;=</span> <span class="fl">6</span>, <span class="st">"ALTA"</span>, </span>
<span>  <span class="va">score_anomalia</span> <span class="op">&gt;=</span> <span class="fl">3</span>, <span class="st">"MEDIA"</span>,</span>
<span>  <span class="va">score_anomalia</span> <span class="op">&gt;=</span> <span class="fl">1</span>, <span class="st">"BAJA"</span>,</span>
<span>  default <span class="op">=</span> <span class="st">"NORMAL"</span></span>
<span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># CAPA 4: Detección de secuencias anómalas con rleid()</span></span>
<span><span class="va">sistema_anomalias</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span></span>
<span>  es_anomalo <span class="op">=</span> <span class="va">severidad</span> <span class="op">!=</span> <span class="st">"NORMAL"</span>,</span>
<span>  secuencia_id <span class="op">=</span> <span class="fu">rleid</span><span class="op">(</span><span class="va">severidad</span> <span class="op">!=</span> <span class="st">"NORMAL"</span><span class="op">)</span></span>
<span><span class="op">)</span>, by <span class="op">=</span> <span class="va">sensor_id</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Análisis de secuencias anómalas</span></span>
<span><span class="va">secuencias_anomalas</span> <span class="op">&lt;-</span> <span class="va">sistema_anomalias</span><span class="op">[</span><span class="va">es_anomalo</span> <span class="op">==</span> <span class="cn">TRUE</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>  duracion_minutos <span class="op">=</span> <span class="va">.N</span> <span class="op">*</span> <span class="fl">15</span>,  <span class="co"># 15 min por medición</span></span>
<span>  severidad_maxima <span class="op">=</span> <span class="va">severidad</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html">which.max</a></span><span class="op">(</span><span class="va">score_anomalia</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  score_maximo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">score_anomalia</span><span class="op">)</span>,</span>
<span>  score_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">score_anomalia</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  temp_min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">temperatura</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  temp_max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">temperatura</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  inicio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">timestamp</span><span class="op">)</span>,</span>
<span>  fin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">timestamp</span><span class="op">)</span>,</span>
<span>  tipos_anomalia <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="va">anomalia_spike</span><span class="op">)</span><span class="op">)</span> <span class="st">"SPIKE"</span>,</span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="va">anomalia_drift</span><span class="op">)</span><span class="op">)</span> <span class="st">"DRIFT"</span>, </span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="va">anomalia_variabilidad</span><span class="op">)</span><span class="op">)</span> <span class="st">"VARIABILIDAD"</span>,</span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="va">anomalia_outlier</span><span class="op">)</span><span class="op">)</span> <span class="st">"OUTLIER"</span>,</span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="va">anomalia_tendencia</span><span class="op">)</span><span class="op">)</span> <span class="st">"TENDENCIA"</span>,</span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="va">anomalia_frozen</span><span class="op">)</span><span class="op">)</span> <span class="st">"FROZEN"</span></span>
<span>  <span class="op">)</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span></span>
<span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">sensor_id</span>, <span class="va">secuencia_id</span><span class="op">)</span><span class="op">]</span><span class="op">[</span></span>
<span>  <span class="va">duracion_minutos</span> <span class="op">&gt;=</span> <span class="fl">30</span>  <span class="co"># Solo secuencias de al menos 30 minutos</span></span>
<span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">score_maximo</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># SISTEMA DE ALERTAS AUTOMÁTICAS</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"🚨 SISTEMA DE ALERTAS DE ANOMALÍAS 🚨\n\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; 🚨 SISTEMA DE ALERTAS DE ANOMALÍAS 🚨</span></span>
<span></span>
<span><span class="co"># Alertas activas por sensor</span></span>
<span><span class="va">alertas_activas</span> <span class="op">&lt;-</span> <span class="va">sistema_anomalias</span><span class="op">[</span><span class="va">es_anomalo</span> <span class="op">==</span> <span class="cn">TRUE</span>, <span class="va">.N</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">sensor_id</span>, <span class="va">severidad</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">sensor_id</span>, <span class="va">severidad</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">alertas_activas</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"ALERTAS ACTIVAS POR SENSOR:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">alertas_activas</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"✅ No hay alertas activas en este momento.\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; ALERTAS ACTIVAS POR SENSOR:</span></span>
<span><span class="co">#&gt;    sensor_id severidad     N</span></span>
<span><span class="co">#&gt;       &lt;char&gt;    &lt;char&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1:    TEMP_A      ALTA    12</span></span>
<span><span class="co">#&gt; 2:    TEMP_A      BAJA    13</span></span>
<span><span class="co">#&gt; 3:    TEMP_A     MEDIA    66</span></span>
<span><span class="co">#&gt; 4:    TEMP_B      ALTA     5</span></span>
<span><span class="co">#&gt; 5:    TEMP_B      BAJA    17</span></span>
<span><span class="co">#&gt; 6:    TEMP_B     MEDIA     7</span></span>
<span><span class="co">#&gt; 7:    TEMP_C      ALTA     7</span></span>
<span><span class="co">#&gt; 8:    TEMP_C      BAJA    34</span></span>
<span></span>
<span><span class="co"># Top secuencias críticas</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">secuencias_anomalas</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\n🔥 TOP SECUENCIAS ANÓMALAS:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">secuencias_anomalas</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">sensor_id</span>, <span class="va">severidad_maxima</span>, <span class="va">duracion_minutos</span>, </span>
<span>                                    <span class="va">score_maximo</span>, <span class="va">tipos_anomalia</span>, <span class="va">inicio</span><span class="op">)</span><span class="op">]</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\n✅ No se detectaron secuencias anómalas significativas.\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 🔥 TOP SECUENCIAS ANÓMALAS:</span></span>
<span><span class="co">#&gt;    sensor_id severidad_maxima duracion_minutos score_maximo</span></span>
<span><span class="co">#&gt;       &lt;char&gt;           &lt;char&gt;            &lt;num&gt;        &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:    TEMP_A             ALTA               30            9</span></span>
<span><span class="co">#&gt; 2:    TEMP_A             ALTA               30            7</span></span>
<span><span class="co">#&gt; 3:    TEMP_A             ALTA               45            7</span></span>
<span><span class="co">#&gt; 4:    TEMP_A             ALTA               30            6</span></span>
<span><span class="co">#&gt; 5:    TEMP_A             ALTA               30            6</span></span>
<span><span class="co">#&gt; 6:    TEMP_A             ALTA               30            6</span></span>
<span><span class="co">#&gt; 7:    TEMP_B             ALTA               30            6</span></span>
<span><span class="co">#&gt; 8:    TEMP_B             ALTA               30            6</span></span>
<span><span class="co">#&gt;               tipos_anomalia              inicio</span></span>
<span><span class="co">#&gt;                       &lt;char&gt;              &lt;POSc&gt;</span></span>
<span><span class="co">#&gt; 1: DRIFT, OUTLIER, TENDENCIA 2024-06-01 15:30:00</span></span>
<span><span class="co">#&gt; 2:          DRIFT, TENDENCIA 2024-06-04 11:15:00</span></span>
<span><span class="co">#&gt; 3:          DRIFT, TENDENCIA 2024-06-04 13:00:00</span></span>
<span><span class="co">#&gt; 4:        OUTLIER, TENDENCIA 2024-06-01 08:45:00</span></span>
<span><span class="co">#&gt; 5:        OUTLIER, TENDENCIA 2024-06-01 23:00:00</span></span>
<span><span class="co">#&gt; 6:        OUTLIER, TENDENCIA 2024-06-06 22:00:00</span></span>
<span><span class="co">#&gt; 7:        OUTLIER, TENDENCIA 2024-06-03 06:15:00</span></span>
<span><span class="co">#&gt; 8:             DRIFT, FROZEN 2024-06-07 20:00:00</span></span>
<span></span>
<span><span class="co"># Resumen estadístico</span></span>
<span><span class="va">resumen_sistema</span> <span class="op">&lt;-</span> <span class="va">sistema_anomalias</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">temperatura</span><span class="op">)</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>  lecturas_totales <span class="op">=</span> <span class="va">.N</span>,</span>
<span>  anomalias_detectadas <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">es_anomalo</span><span class="op">)</span>,</span>
<span>  pct_anomalias <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">es_anomalo</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  score_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">score_anomalia</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span>, by <span class="op">=</span> <span class="va">sensor_id</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\n📊 RESUMEN DEL SISTEMA:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 📊 RESUMEN DEL SISTEMA:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">resumen_sistema</span><span class="op">)</span></span>
<span><span class="co">#&gt;    sensor_id lecturas_totales anomalias_detectadas pct_anomalias score_promedio</span></span>
<span><span class="co">#&gt;       &lt;char&gt;            &lt;int&gt;                &lt;int&gt;         &lt;num&gt;          &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:    TEMP_A              672                   91         13.54             NA</span></span>
<span><span class="co">#&gt; 2:    TEMP_B              672                   29          4.32             NA</span></span>
<span><span class="co">#&gt; 3:    TEMP_C              672                   41          6.10             NA</span></span>
<span></span>
<span><span class="co"># # Crear tabla interactiva de secuencias críticas (comentado para PDF)</span></span>
<span><span class="co"># if(nrow(secuencias_anomalas) &gt; 0) {</span></span>
<span><span class="co">#   DT::datatable(</span></span>
<span><span class="co">#     secuencias_anomalas[1:min(20, nrow(secuencias_anomalas))],</span></span>
<span><span class="co">#     caption = "Secuencias Anómalas Detectadas - Sistema Multicapa",</span></span>
<span><span class="co">#     options = list(pageLength = 10, scrollX = TRUE)</span></span>
<span><span class="co">#   ) %&gt;%</span></span>
<span><span class="co">#     DT::formatStyle(</span></span>
<span><span class="co">#       "severidad_maxima",</span></span>
<span><span class="co">#       backgroundColor = DT::styleEqual(</span></span>
<span><span class="co">#         c("CRÍTICA", "ALTA", "MEDIA", "BAJA"),</span></span>
<span><span class="co">#         c("red", "orange", "yellow", "lightblue")</span></span>
<span><span class="co">#       )</span></span>
<span><span class="co">#     )</span></span>
<span><span class="co"># }</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
🏋️ Ejercicio 12: Análisis de Supervivencia de Clientes
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>
<strong>Calcula métricas temporales</strong> con <code>shift()</code> y funciones de ventana</li>
<li>
<strong>Identifica patrones de churn</strong> usando <code>rleid()</code> para secuencias de inactividad</li>
<li>
<strong>Clasifica riesgo de abandono</strong> con <code>fcase()</code> múltiples criterios</li>
<li>
<strong>Genera score predictivo</strong> combinando múltiples señales</li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
💡 Solución del Ejercicio 12
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Análisis de supervivencia y predicción de churn</span></span>
<span><span class="co"># 1. Preparar datos temporales con métricas de ventana</span></span>
<span><span class="va">analisis_supervivencia</span> <span class="op">&lt;-</span> <span class="va">clientes_retencion</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span></span>
<span>  dias_desde_registro <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2024-06-30"</span><span class="op">)</span> <span class="op">-</span> <span class="va">fecha_registro</span><span class="op">)</span>,</span>
<span>  dias_desde_ultima_actividad <span class="op">=</span> <span class="fu">fifelse</span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">fecha_ultima_actividad</span><span class="op">)</span>, </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2024-06-30"</span><span class="op">)</span> <span class="op">-</span> <span class="va">fecha_registro</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2024-06-30"</span><span class="op">)</span> <span class="op">-</span> <span class="va">fecha_ultima_actividad</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Combinar con datos transaccionales para análisis de comportamiento</span></span>
<span><span class="va">comportamiento_clientes</span> <span class="op">&lt;-</span> <span class="va">transacciones_comportamiento</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>  transacciones_totales <span class="op">=</span> <span class="va">.N</span>,</span>
<span>  gasto_total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">monto</span><span class="op">)</span>,</span>
<span>  gasto_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">monto</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  dias_activos <span class="op">=</span> <span class="fu">uniqueN</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">fecha_transaccion</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  categorias_usadas <span class="op">=</span> <span class="fu">uniqueN</span><span class="op">(</span><span class="va">categoria</span><span class="op">)</span>,</span>
<span>  ultima_transaccion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">fecha_transaccion</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  primera_transaccion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">fecha_transaccion</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span>, by <span class="op">=</span> <span class="va">cliente_id</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Join con datos de clientes</span></span>
<span><span class="va">supervivencia_completa</span> <span class="op">&lt;-</span> <span class="va">analisis_supervivencia</span><span class="op">[</span></span>
<span>  <span class="va">comportamiento_clientes</span>, on <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">cliente_id</span><span class="op">)</span>, nomatch <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">]</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span></span>
<span>  dias_desde_primera_trans <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2024-06-30"</span><span class="op">)</span> <span class="op">-</span> <span class="va">primera_transaccion</span><span class="op">)</span>,</span>
<span>  dias_desde_ultima_trans <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2024-06-30"</span><span class="op">)</span> <span class="op">-</span> <span class="va">ultima_transaccion</span><span class="op">)</span>,</span>
<span>  frecuencia_transaccional <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">transacciones_totales</span> <span class="op">/</span> <span class="va">dias_activos</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># 2. Identificar patrones de declive con funciones de ventana</span></span>
<span><span class="co"># Simular datos de actividad mensual para análisis temporal</span></span>
<span><span class="va">actividad_mensual</span> <span class="op">&lt;-</span> <span class="va">supervivencia_completa</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>  <span class="va">cliente_id</span>, <span class="va">activo</span>, <span class="va">ingresos_mensuales</span>, <span class="va">gasto_total</span>, <span class="va">transacciones_totales</span></span>
<span><span class="op">)</span><span class="op">]</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>  <span class="va">cliente_id</span>, </span>
<span>  mes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span>, <span class="va">.N</span><span class="op">)</span>,</span>
<span>  actividad_simulada <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">activo</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">.N</span> <span class="op">*</span> <span class="fl">6</span>, <span class="fl">0</span>, <span class="fl">0.3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  gasto_simulado <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">gasto_total</span> <span class="op">/</span> <span class="fl">6</span>, <span class="fl">6</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">.N</span> <span class="op">*</span> <span class="fl">6</span>, <span class="fl">0</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span>, by <span class="op">=</span> <span class="va">cliente_id</span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">cliente_id</span>, <span class="va">mes</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Aplicar funciones de ventana para detectar tendencias</span></span>
<span><span class="va">actividad_tendencias</span> <span class="op">&lt;-</span> <span class="va">actividad_mensual</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span></span>
<span>  actividad_ma3 <span class="op">=</span> <span class="fu">frollmean</span><span class="op">(</span><span class="va">actividad_simulada</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>  gasto_ma3 <span class="op">=</span> <span class="fu">frollmean</span><span class="op">(</span><span class="va">gasto_simulado</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>  actividad_anterior <span class="op">=</span> <span class="fu">shift</span><span class="op">(</span><span class="va">actividad_simulada</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  gasto_anterior <span class="op">=</span> <span class="fu">shift</span><span class="op">(</span><span class="va">gasto_simulado</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  tendencia_actividad <span class="op">=</span> <span class="va">actividad_simulada</span> <span class="op">-</span> <span class="fu">shift</span><span class="op">(</span><span class="va">actividad_simulada</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  secuencia_declive <span class="op">=</span> <span class="fu">rleid</span><span class="op">(</span><span class="va">actividad_simulada</span> <span class="op">&lt;</span> <span class="fu">shift</span><span class="op">(</span><span class="va">actividad_simulada</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span>, by <span class="op">=</span> <span class="va">cliente_id</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># 3. Análisis de riesgo de churn con múltiples criterios</span></span>
<span><span class="va">modelo_churn</span> <span class="op">&lt;-</span> <span class="va">supervivencia_completa</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span></span>
<span>  <span class="co"># Señales de riesgo temporal</span></span>
<span>  riesgo_inactividad <span class="op">=</span> <span class="fu">fcase</span><span class="op">(</span></span>
<span>    <span class="va">dias_desde_ultima_trans</span> <span class="op">&gt;</span> <span class="fl">90</span>, <span class="st">"ALTO"</span>,</span>
<span>    <span class="va">dias_desde_ultima_trans</span> <span class="op">&gt;</span> <span class="fl">60</span>, <span class="st">"MEDIO"</span>,</span>
<span>    <span class="va">dias_desde_ultima_trans</span> <span class="op">&gt;</span> <span class="fl">30</span>, <span class="st">"BAJO"</span>,</span>
<span>    default <span class="op">=</span> <span class="st">"MÍNIMO"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># Señales de comportamiento</span></span>
<span>  riesgo_engagement <span class="op">=</span> <span class="fu">fcase</span><span class="op">(</span></span>
<span>    <span class="va">frecuencia_transaccional</span> <span class="op">&lt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="va">categorias_usadas</span> <span class="op">&lt;=</span> <span class="fl">2</span>, <span class="st">"ALTO"</span>,</span>
<span>    <span class="va">frecuencia_transaccional</span> <span class="op">&lt;</span> <span class="fl">0.3</span> <span class="op">&amp;</span> <span class="va">categorias_usadas</span> <span class="op">&lt;=</span> <span class="fl">3</span>, <span class="st">"MEDIO"</span>, </span>
<span>    <span class="va">frecuencia_transaccional</span> <span class="op">&lt;</span> <span class="fl">0.5</span>, <span class="st">"BAJO"</span>,</span>
<span>    default <span class="op">=</span> <span class="st">"MÍNIMO"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># Señales económicas</span></span>
<span>  riesgo_economico <span class="op">=</span> <span class="fu">fcase</span><span class="op">(</span></span>
<span>    <span class="va">gasto_promedio</span> <span class="op">&lt;</span> <span class="va">ingresos_mensuales</span> <span class="op">*</span> <span class="fl">0.01</span>, <span class="st">"ALTO"</span>,  <span class="co"># Gasta &lt;1% de ingresos</span></span>
<span>    <span class="va">gasto_promedio</span> <span class="op">&lt;</span> <span class="va">ingresos_mensuales</span> <span class="op">*</span> <span class="fl">0.03</span>, <span class="st">"MEDIO"</span>, <span class="co"># Gasta &lt;3% de ingresos</span></span>
<span>    <span class="va">gasto_promedio</span> <span class="op">&lt;</span> <span class="va">ingresos_mensuales</span> <span class="op">*</span> <span class="fl">0.05</span>, <span class="st">"BAJO"</span>,  <span class="co"># Gasta &lt;5% de ingresos</span></span>
<span>    default <span class="op">=</span> <span class="st">"MÍNIMO"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># Señal de valor del cliente</span></span>
<span>  valor_cliente <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="op">(</span><span class="va">gasto_total</span> <span class="op">/</span> <span class="va">dias_activos</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">ingresos_mensuales</span> <span class="op">/</span> <span class="fl">1000</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">]</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span></span>
<span>  <span class="co"># Score compuesto de riesgo de churn</span></span>
<span>  score_churn <span class="op">=</span> <span class="op">(</span></span>
<span>    <span class="op">(</span><span class="va">riesgo_inactividad</span> <span class="op">==</span> <span class="st">"ALTO"</span><span class="op">)</span> <span class="op">*</span> <span class="fl">40</span> <span class="op">+</span> <span class="op">(</span><span class="va">riesgo_inactividad</span> <span class="op">==</span> <span class="st">"MEDIO"</span><span class="op">)</span> <span class="op">*</span> <span class="fl">25</span> <span class="op">+</span> <span class="op">(</span><span class="va">riesgo_inactividad</span> <span class="op">==</span> <span class="st">"BAJO"</span><span class="op">)</span> <span class="op">*</span> <span class="fl">10</span> <span class="op">+</span></span>
<span>    <span class="op">(</span><span class="va">riesgo_engagement</span> <span class="op">==</span> <span class="st">"ALTO"</span><span class="op">)</span> <span class="op">*</span> <span class="fl">30</span> <span class="op">+</span> <span class="op">(</span><span class="va">riesgo_engagement</span> <span class="op">==</span> <span class="st">"MEDIO"</span><span class="op">)</span> <span class="op">*</span> <span class="fl">20</span> <span class="op">+</span> <span class="op">(</span><span class="va">riesgo_engagement</span> <span class="op">==</span> <span class="st">"BAJO"</span><span class="op">)</span> <span class="op">*</span> <span class="fl">10</span> <span class="op">+</span></span>
<span>    <span class="op">(</span><span class="va">riesgo_economico</span> <span class="op">==</span> <span class="st">"ALTO"</span><span class="op">)</span> <span class="op">*</span> <span class="fl">20</span> <span class="op">+</span> <span class="op">(</span><span class="va">riesgo_economico</span> <span class="op">==</span> <span class="st">"MEDIO"</span><span class="op">)</span> <span class="op">*</span> <span class="fl">12</span> <span class="op">+</span> <span class="op">(</span><span class="va">riesgo_economico</span> <span class="op">==</span> <span class="st">"BAJO"</span><span class="op">)</span> <span class="op">*</span> <span class="fl">5</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="op">!</span><span class="va">activo</span>, <span class="fl">25</span>, <span class="fl">0</span><span class="op">)</span>  <span class="co"># Penalización por inactividad actual</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span><span class="op">]</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span></span>
<span>  <span class="co"># 4. Clasificación final y estrategia</span></span>
<span>  clasificacion_churn <span class="op">=</span> <span class="fu">fcase</span><span class="op">(</span></span>
<span>    <span class="va">score_churn</span> <span class="op">&gt;=</span> <span class="fl">80</span>, <span class="st">"CHURN_INMEDIATO"</span>,</span>
<span>    <span class="va">score_churn</span> <span class="op">&gt;=</span> <span class="fl">60</span>, <span class="st">"ALTO_RIESGO"</span>, </span>
<span>    <span class="va">score_churn</span> <span class="op">&gt;=</span> <span class="fl">40</span>, <span class="st">"RIESGO_MODERADO"</span>,</span>
<span>    <span class="va">score_churn</span> <span class="op">&gt;=</span> <span class="fl">20</span>, <span class="st">"BAJO_RIESGO"</span>,</span>
<span>    default <span class="op">=</span> <span class="st">"SALUDABLE"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  estrategia_retencion <span class="op">=</span> <span class="fu">fcase</span><span class="op">(</span></span>
<span>    <span class="va">score_churn</span> <span class="op">&gt;=</span> <span class="fl">80</span>, <span class="st">"Contacto_Inmediato + Oferta_Especial"</span>,</span>
<span>    <span class="va">score_churn</span> <span class="op">&gt;=</span> <span class="fl">60</span>, <span class="st">"Programa_Reactivación + Descuentos"</span>,</span>
<span>    <span class="va">score_churn</span> <span class="op">&gt;=</span> <span class="fl">40</span>, <span class="st">"Comunicación_Personalizada"</span>, </span>
<span>    <span class="va">score_churn</span> <span class="op">&gt;=</span> <span class="fl">20</span>, <span class="st">"Monitoreo_Activo"</span>,</span>
<span>    default <span class="op">=</span> <span class="st">"Mantenimiento_Rutinario"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Análisis de resultados</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"📈 ANÁLISIS DE SUPERVIVENCIA DE CLIENTES 📈\n\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; 📈 ANÁLISIS DE SUPERVIVENCIA DE CLIENTES 📈</span></span>
<span></span>
<span><span class="co"># Distribución por clasificación</span></span>
<span><span class="va">distribucion_churn</span> <span class="op">&lt;-</span> <span class="va">modelo_churn</span><span class="op">[</span>, <span class="va">.N</span>, by <span class="op">=</span> <span class="va">clasificacion_churn</span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">N</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"DISTRIBUCIÓN POR RIESGO DE CHURN:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; DISTRIBUCIÓN POR RIESGO DE CHURN:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">distribucion_churn</span><span class="op">)</span></span>
<span><span class="co">#&gt;    clasificacion_churn     N</span></span>
<span><span class="co">#&gt;                 &lt;char&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1:         BAJO_RIESGO   429</span></span>
<span><span class="co">#&gt; 2:           SALUDABLE   357</span></span>
<span><span class="co">#&gt; 3:     RIESGO_MODERADO   154</span></span>
<span><span class="co">#&gt; 4:         ALTO_RIESGO    43</span></span>
<span><span class="co">#&gt; 5:     CHURN_INMEDIATO     7</span></span>
<span></span>
<span><span class="co"># Estadísticas por grupo de riesgo</span></span>
<span><span class="va">stats_por_riesgo</span> <span class="op">&lt;-</span> <span class="va">modelo_churn</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>  clientes <span class="op">=</span> <span class="va">.N</span>,</span>
<span>  score_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">score_churn</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  ingresos_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">ingresos_mensuales</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>  valor_cliente_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">valor_cliente</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>  dias_inactividad_promedio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">dias_desde_ultima_trans</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>  tasa_actividad_actual <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">activo</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span>, by <span class="op">=</span> <span class="va">clasificacion_churn</span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">score_promedio</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\n📊 ESTADÍSTICAS POR GRUPO DE RIESGO:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 📊 ESTADÍSTICAS POR GRUPO DE RIESGO:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">stats_por_riesgo</span><span class="op">)</span></span>
<span><span class="co">#&gt;    clasificacion_churn clientes score_promedio ingresos_promedio</span></span>
<span><span class="co">#&gt;                 &lt;char&gt;    &lt;int&gt;          &lt;num&gt;             &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:     CHURN_INMEDIATO        7           85.0             18915</span></span>
<span><span class="co">#&gt; 2:         ALTO_RIESGO       43           64.4              9790</span></span>
<span><span class="co">#&gt; 3:     RIESGO_MODERADO      154           46.8             11013</span></span>
<span><span class="co">#&gt; 4:         BAJO_RIESGO      429           26.6              9481</span></span>
<span><span class="co">#&gt; 5:           SALUDABLE      357            8.2              4040</span></span>
<span><span class="co">#&gt;    valor_cliente_promedio dias_inactividad_promedio tasa_actividad_actual</span></span>
<span><span class="co">#&gt;                     &lt;num&gt;                     &lt;num&gt;                 &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:                    645                       127                   0.0</span></span>
<span><span class="co">#&gt; 2:                   1094                       103                  48.8</span></span>
<span><span class="co">#&gt; 3:                    991                        58                  40.3</span></span>
<span><span class="co">#&gt; 4:                    955                        30                  71.8</span></span>
<span><span class="co">#&gt; 5:                    576                        18                 100.0</span></span>
<span></span>
<span><span class="co"># Clientes críticos que requieren atención inmediata</span></span>
<span><span class="va">clientes_criticos</span> <span class="op">&lt;-</span> <span class="va">modelo_churn</span><span class="op">[</span><span class="va">clasificacion_churn</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"CHURN_INMEDIATO"</span>, <span class="st">"ALTO_RIESGO"</span><span class="op">)</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>  <span class="va">cliente_id</span>, <span class="va">plan</span>, <span class="va">pais</span>, <span class="va">ingresos_mensuales</span>, <span class="va">valor_cliente</span>, </span>
<span>  <span class="va">score_churn</span>, <span class="va">clasificacion_churn</span>, <span class="va">estrategia_retencion</span>,</span>
<span>  dias_inactividad <span class="op">=</span> <span class="va">dias_desde_ultima_trans</span></span>
<span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">score_churn</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\n🚨 CLIENTES QUE REQUIEREN ATENCIÓN INMEDIATA:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 🚨 CLIENTES QUE REQUIEREN ATENCIÓN INMEDIATA:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">clientes_criticos</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;     cliente_id        plan      pais ingresos_mensuales valor_cliente</span></span>
<span><span class="co">#&gt;          &lt;int&gt;      &lt;char&gt;    &lt;char&gt;              &lt;num&gt;         &lt;num&gt;</span></span>
<span><span class="co">#&gt;  1:        717     Premium Argentina              28491           180</span></span>
<span><span class="co">#&gt;  2:        677 Empresarial  Colombia               8912           276</span></span>
<span><span class="co">#&gt;  3:        368      Básico  Colombia               4248           167</span></span>
<span><span class="co">#&gt;  4:        474      Básico     Chile               4957           178</span></span>
<span><span class="co">#&gt;  5:        351      Básico     Chile               2693            18</span></span>
<span><span class="co">#&gt;  6:        205      Básico    España               8272           684</span></span>
<span><span class="co">#&gt;  7:        537     Premium    España              74834          3011</span></span>
<span><span class="co">#&gt;  8:        488     Premium    México               4999           453</span></span>
<span><span class="co">#&gt;  9:         31      Básico    España               4424           258</span></span>
<span><span class="co">#&gt; 10:        905      Básico     Chile               2805            91</span></span>
<span><span class="co">#&gt;     score_churn clasificacion_churn                 estrategia_retencion</span></span>
<span><span class="co">#&gt;           &lt;num&gt;              &lt;char&gt;                               &lt;char&gt;</span></span>
<span><span class="co">#&gt;  1:          85     CHURN_INMEDIATO Contacto_Inmediato + Oferta_Especial</span></span>
<span><span class="co">#&gt;  2:          85     CHURN_INMEDIATO Contacto_Inmediato + Oferta_Especial</span></span>
<span><span class="co">#&gt;  3:          85     CHURN_INMEDIATO Contacto_Inmediato + Oferta_Especial</span></span>
<span><span class="co">#&gt;  4:          85     CHURN_INMEDIATO Contacto_Inmediato + Oferta_Especial</span></span>
<span><span class="co">#&gt;  5:          85     CHURN_INMEDIATO Contacto_Inmediato + Oferta_Especial</span></span>
<span><span class="co">#&gt;  6:          85     CHURN_INMEDIATO Contacto_Inmediato + Oferta_Especial</span></span>
<span><span class="co">#&gt;  7:          85     CHURN_INMEDIATO Contacto_Inmediato + Oferta_Especial</span></span>
<span><span class="co">#&gt;  8:          77         ALTO_RIESGO   Programa_Reactivación + Descuentos</span></span>
<span><span class="co">#&gt;  9:          77         ALTO_RIESGO   Programa_Reactivación + Descuentos</span></span>
<span><span class="co">#&gt; 10:          77         ALTO_RIESGO   Programa_Reactivación + Descuentos</span></span>
<span><span class="co">#&gt;     dias_inactividad</span></span>
<span><span class="co">#&gt;                &lt;num&gt;</span></span>
<span><span class="co">#&gt;  1:              105</span></span>
<span><span class="co">#&gt;  2:              144</span></span>
<span><span class="co">#&gt;  3:              129</span></span>
<span><span class="co">#&gt;  4:               92</span></span>
<span><span class="co">#&gt;  5:              156</span></span>
<span><span class="co">#&gt;  6:              146</span></span>
<span><span class="co">#&gt;  7:              117</span></span>
<span><span class="co">#&gt;  8:               91</span></span>
<span><span class="co">#&gt;  9:               95</span></span>
<span><span class="co">#&gt; 10:              118</span></span>
<span></span>
<span><span class="co"># ROI potencial de estrategias de retención</span></span>
<span><span class="va">roi_estrategias</span> <span class="op">&lt;-</span> <span class="va">modelo_churn</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>  clientes_objetivo <span class="op">=</span> <span class="va">.N</span>,</span>
<span>  valor_total_riesgo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">valor_cliente</span><span class="op">)</span>,</span>
<span>  valor_promedio_cliente <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">valor_cliente</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>  inversion_retencion_estimada <span class="op">=</span> <span class="va">.N</span> <span class="op">*</span> <span class="fu">fcase</span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">clasificacion_churn</span><span class="op">)</span> <span class="op">==</span> <span class="st">"CHURN_INMEDIATO"</span>, <span class="fl">200</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">clasificacion_churn</span><span class="op">)</span> <span class="op">==</span> <span class="st">"ALTO_RIESGO"</span>, <span class="fl">100</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">clasificacion_churn</span><span class="op">)</span> <span class="op">==</span> <span class="st">"RIESGO_MODERADO"</span>, <span class="fl">50</span>,</span>
<span>    default <span class="op">=</span> <span class="fl">20</span></span>
<span>  <span class="op">)</span>,</span>
<span>  roi_potencial <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">valor_cliente</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">.N</span> <span class="op">*</span> <span class="fu">fcase</span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">clasificacion_churn</span><span class="op">)</span> <span class="op">==</span> <span class="st">"CHURN_INMEDIATO"</span>, <span class="fl">200</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">clasificacion_churn</span><span class="op">)</span> <span class="op">==</span> <span class="st">"ALTO_RIESGO"</span>, <span class="fl">100</span>, </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">clasificacion_churn</span><span class="op">)</span> <span class="op">==</span> <span class="st">"RIESGO_MODERADO"</span>, <span class="fl">50</span>,</span>
<span>    default <span class="op">=</span> <span class="fl">20</span></span>
<span>  <span class="op">)</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">clasificacion_churn</span>, <span class="va">estrategia_retencion</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">roi_potencial</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\n💰 ANÁLISIS DE ROI DE ESTRATEGIAS:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 💰 ANÁLISIS DE ROI DE ESTRATEGIAS:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">roi_estrategias</span><span class="op">)</span></span>
<span><span class="co">#&gt;    clasificacion_churn                 estrategia_retencion clientes_objetivo</span></span>
<span><span class="co">#&gt;                 &lt;char&gt;                               &lt;char&gt;             &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1:         BAJO_RIESGO                     Monitoreo_Activo               429</span></span>
<span><span class="co">#&gt; 2:           SALUDABLE              Mantenimiento_Rutinario               357</span></span>
<span><span class="co">#&gt; 3:     RIESGO_MODERADO           Comunicación_Personalizada               154</span></span>
<span><span class="co">#&gt; 4:         ALTO_RIESGO   Programa_Reactivación + Descuentos                43</span></span>
<span><span class="co">#&gt; 5:     CHURN_INMEDIATO Contacto_Inmediato + Oferta_Especial                 7</span></span>
<span><span class="co">#&gt;    valor_total_riesgo valor_promedio_cliente inversion_retencion_estimada</span></span>
<span><span class="co">#&gt;                 &lt;num&gt;                  &lt;num&gt;                        &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:             409510                    955                         8580</span></span>
<span><span class="co">#&gt; 2:             205785                    576                         7140</span></span>
<span><span class="co">#&gt; 3:             152686                    991                         7700</span></span>
<span><span class="co">#&gt; 4:              47050                   1094                         4300</span></span>
<span><span class="co">#&gt; 5:               4514                    645                         1400</span></span>
<span><span class="co">#&gt;    roi_potencial</span></span>
<span><span class="co">#&gt;            &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:          33.4</span></span>
<span><span class="co">#&gt; 2:          20.2</span></span>
<span><span class="co">#&gt; 3:          13.9</span></span>
<span><span class="co">#&gt; 4:           7.7</span></span>
<span><span class="co">#&gt; 5:           2.3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<hr>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
🎯 Puntos Clave de Este Capítulo
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>
<strong>Funciones de ventana</strong> (<code>shift</code>, <code>frollmean</code>, <code>frollapply</code>) permiten análisis temporal sofisticado sin colapsar datos</li>
<li>
<strong>Funciones condicionales</strong> (<code>fifelse</code>, <code>fcase</code>, <code>between</code>) optimizan clasificaciones complejas</li>
<li>
<strong>Funciones de agregación especiales</strong> (<code>frank</code>, <code>rleid</code>, <code>uniqueN</code>) revelan patrones ocultos en los datos</li>
<li>
<strong>Análisis temporal</strong> combina múltiples técnicas para detección de anomalías y predicción</li>
<li>
<strong>Performance</strong>: Estas funciones están altamente optimizadas y son significativamente más rápidas que alternativas de R base</li>
<li>
<strong>Casos de uso reales</strong>: Finanzas, IoT, análisis de comportamiento - las aplicaciones son ilimitadas</li>
</ol>
</div>
</div>
<p>Las funciones especiales de <code>data.table</code> te dan superpoderes para análisis complejos. En el próximo capítulo exploraremos las técnicas de reshape que complementan perfectamente estas funciones para transformaciones de datos avanzadas.</p>
<p><function_calls><invoke name="TodoWrite"><parameter name="todos">[{“content”: “Reorganizar M0f3dulo 1: dividir fundamentos en sintaxis y s0edmbolos”, “status”: “completed”, “id”: “1”}, {“content”: “Crear cap01-simbolos.qmd para s0edmbolos especiales del M0f3dulo 1”, “status”: “completed”, “id”: “1-new”}, {“content”: “Reorganizar M0f3dulo 2: dividir en encadenamiento y joins”, “status”: “completed”, “id”: “2”}, {“content”: “Crear cap03-joins-avanzados.qmd para joins avanzados del M0f3dulo 3”, “status”: “completed”, “id”: “3-1”}, {“content”: “Crear cap03-funciones-especiales.qmd para funciones especiales del M0f3dulo 3”, “status”: “completed”, “id”: “3-2”}, {“content”: “Crear cap03-reshape.qmd para reshape del M0f3dulo 3”, “status”: “in_progress”, “id”: “3-3”}, {“content”: “Reorganizar M0f3dulo 4: dividir en performance y buenas pr0e1cticas”, “status”: “pending”, “id”: “4”}, {“content”: “Reorganizar M0f3dulo 5: dividir en visualizaci0f3n y aplicaciones”, “status”: “pending”, “id”: “5”}]</parameter></invoke></function_calls></p>


<!-- -->

</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/tutorial-datatable\.github\.io\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./cap03-joins-avanzados.html" class="pagination-link" aria-label="Joins Avanzados: Non-Equi y Rolling Joins">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Joins Avanzados: Non-Equi y Rolling Joins</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./cap03-reshape.html" class="pagination-link" aria-label="Remodelación de Datos: `melt()` y `dcast()`">
        <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Remodelación de Datos: <code>melt()</code> y <code>dcast()</code></span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb14" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Funciones Especiales y Análisis Temporal</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip icon="false"}</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="fu">## En este capítulo dominarás</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Funciones de ventana**: <span class="in">`shift()`</span>, <span class="in">`frollmean()`</span>, <span class="in">`frollapply()`</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Funciones condicionales rápidas**: <span class="in">`fifelse()`</span>, <span class="in">`fcase()`</span>, <span class="in">`between()`</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Análisis temporal avanzado** con series de tiempo</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Funciones de agregación especiales**: <span class="in">`frank()`</span>, <span class="in">`rleid()`</span>, <span class="in">`uniqueN()`</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Operaciones con strings** optimizadas para data.table</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Análisis de supervivencia** y detección de patrones</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup-cap03-funciones-especiales</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DT)</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Configuración</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">datatable.print.nrows =</span> <span class="dv">8</span>)</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">datatable.print.class =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Datasets para funciones especiales</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2024</span>)</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Dataset financiero para análisis temporal</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>precios_diarios <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">fecha =</span> <span class="fu">rep</span>(<span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">"2024-01-01"</span>), <span class="fu">as.Date</span>(<span class="st">"2024-06-30"</span>), <span class="at">by =</span> <span class="st">"day"</span>), <span class="dv">4</span>),</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">ticker =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"AAPL"</span>, <span class="st">"GOOGL"</span>, <span class="st">"MSFT"</span>, <span class="st">"NVDA"</span>), <span class="at">each =</span> <span class="dv">182</span>),</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">precio_apertura =</span> <span class="fu">round</span>(<span class="fu">c</span>(</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cumsum</span>(<span class="fu">rnorm</span>(<span class="dv">182</span>, <span class="fl">0.2</span>, <span class="dv">2</span>)) <span class="sc">+</span> <span class="dv">180</span>,   <span class="co"># AAPL</span></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cumsum</span>(<span class="fu">rnorm</span>(<span class="dv">182</span>, <span class="fl">0.1</span>, <span class="dv">10</span>)) <span class="sc">+</span> <span class="dv">2800</span>, <span class="co"># GOOGL</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cumsum</span>(<span class="fu">rnorm</span>(<span class="dv">182</span>, <span class="fl">0.3</span>, <span class="dv">3</span>)) <span class="sc">+</span> <span class="dv">370</span>,   <span class="co"># MSFT</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cumsum</span>(<span class="fu">rnorm</span>(<span class="dv">182</span>, <span class="fl">1.0</span>, <span class="dv">15</span>)) <span class="sc">+</span> <span class="dv">600</span>   <span class="co"># NVDA tendencia alcista</span></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>  ), <span class="dv">2</span>),</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">volumen =</span> <span class="fu">round</span>(<span class="fu">runif</span>(<span class="dv">728</span>, <span class="dv">500000</span>, <span class="dv">20000000</span>), <span class="dv">0</span>)</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular precios derivados</span></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>precios_diarios[, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">precio_cierre =</span> precio_apertura <span class="sc">+</span> <span class="fu">rnorm</span>(.N, <span class="dv">0</span>, <span class="dv">2</span>),</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>  <span class="at">precio_max =</span> precio_apertura <span class="sc">+</span> <span class="fu">abs</span>(<span class="fu">rnorm</span>(.N, <span class="dv">2</span>, <span class="dv">1</span>)),</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">precio_min =</span> precio_apertura <span class="sc">-</span> <span class="fu">abs</span>(<span class="fu">rnorm</span>(.N, <span class="dv">1</span>, <span class="fl">0.5</span>))</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Asegurar lógica de precios</span></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>precios_diarios[, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>  <span class="at">precio_cierre =</span> <span class="fu">pmax</span>(precio_min, <span class="fu">pmin</span>(precio_max, precio_cierre)),</span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>  <span class="at">precio_max =</span> <span class="fu">pmax</span>(precio_apertura, precio_cierre, precio_max),</span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>  <span class="at">precio_min =</span> <span class="fu">pmin</span>(precio_apertura, precio_cierre, precio_min)</span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Dataset de clientes para análisis de supervivencia</span></span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>clientes_retencion <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>  <span class="at">cliente_id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>,</span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>  <span class="at">fecha_registro =</span> <span class="fu">sample</span>(<span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">"2023-01-01"</span>), <span class="fu">as.Date</span>(<span class="st">"2024-01-01"</span>), <span class="at">by =</span> <span class="st">"day"</span>), <span class="dv">1000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>  <span class="at">plan =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Básico"</span>, <span class="st">"Premium"</span>, <span class="st">"Empresarial"</span>), <span class="dv">1000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.6</span>, <span class="fl">0.3</span>, <span class="fl">0.1</span>)),</span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>  <span class="at">edad =</span> <span class="fu">sample</span>(<span class="dv">18</span><span class="sc">:</span><span class="dv">75</span>, <span class="dv">1000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>  <span class="at">pais =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"España"</span>, <span class="st">"México"</span>, <span class="st">"Argentina"</span>, <span class="st">"Colombia"</span>, <span class="st">"Chile"</span>), <span class="dv">1000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>  <span class="at">ingresos_mensuales =</span> <span class="fu">round</span>(<span class="fu">exp</span>(<span class="fu">rnorm</span>(<span class="dv">1000</span>, <span class="fl">8.5</span>, <span class="dv">1</span>)), <span class="dv">0</span>),</span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>  <span class="at">activo =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="cn">TRUE</span>, <span class="cn">FALSE</span>), <span class="dv">1000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.75</span>, <span class="fl">0.25</span>)),</span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>  <span class="at">fecha_ultima_actividad =</span> <span class="cn">NA</span></span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a><span class="co"># Simular fechas de última actividad para clientes activos</span></span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>clientes_retencion[activo <span class="sc">==</span> <span class="cn">TRUE</span>, </span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>                   fecha_ultima_actividad <span class="sc">:</span><span class="er">=</span> <span class="fu">sample</span>(<span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">"2024-01-01"</span>), <span class="fu">as.Date</span>(<span class="st">"2024-06-30"</span>), <span class="at">by =</span> <span class="st">"day"</span>), </span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a>                                                   <span class="fu">sum</span>(activo), <span class="at">replace =</span> <span class="cn">TRUE</span>)]</span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a><span class="co"># Dataset de transacciones para análisis de patrones</span></span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a>transacciones_comportamiento <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a>  <span class="at">transaccion_id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5000</span>,</span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>  <span class="at">cliente_id =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>, <span class="dv">5000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a>  <span class="at">fecha_transaccion =</span> <span class="fu">sample</span>(<span class="fu">seq</span>(<span class="fu">as.POSIXct</span>(<span class="st">"2024-01-01 00:00:00"</span>), </span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">as.POSIXct</span>(<span class="st">"2024-06-30 23:59:59"</span>), <span class="at">by =</span> <span class="st">"hour"</span>), <span class="dv">5000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a>  <span class="at">categoria =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Alimentación"</span>, <span class="st">"Transporte"</span>, <span class="st">"Entretenimiento"</span>, <span class="st">"Salud"</span>, <span class="st">"Educación"</span>), </span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a>                    <span class="dv">5000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a>  <span class="at">monto =</span> <span class="fu">round</span>(<span class="fu">exp</span>(<span class="fu">rnorm</span>(<span class="dv">5000</span>, <span class="dv">4</span>, <span class="fl">1.2</span>)), <span class="dv">2</span>),</span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a>  <span class="at">metodo_pago =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Tarjeta"</span>, <span class="st">"Efectivo"</span>, <span class="st">"Digital"</span>), <span class="dv">5000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.3</span>, <span class="fl">0.2</span>)),</span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a>  <span class="at">comercio_id =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">200</span>, <span class="dv">5000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a><span class="co"># Dataset de sensores para análisis de series temporales</span></span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a>sensores_temperatura <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a>  <span class="at">timestamp =</span> <span class="fu">rep</span>(<span class="fu">seq</span>(<span class="fu">as.POSIXct</span>(<span class="st">"2024-06-01 00:00:00"</span>), </span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">as.POSIXct</span>(<span class="st">"2024-06-07 23:59:59"</span>), <span class="at">by =</span> <span class="st">"15 min"</span>), <span class="dv">3</span>),</span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a>  <span class="at">sensor_id =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"TEMP_A"</span>, <span class="st">"TEMP_B"</span>, <span class="st">"TEMP_C"</span>), <span class="at">each =</span> <span class="dv">672</span>),</span>
<span id="cb14-94"><a href="#cb14-94" aria-hidden="true" tabindex="-1"></a>  <span class="at">temperatura =</span> <span class="fu">c</span>(</span>
<span id="cb14-95"><a href="#cb14-95" aria-hidden="true" tabindex="-1"></a>    <span class="dv">20</span> <span class="sc">+</span> <span class="dv">5</span><span class="sc">*</span><span class="fu">sin</span>(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">14</span><span class="sc">*</span>pi, <span class="at">length.out =</span> <span class="dv">672</span>)) <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">672</span>, <span class="dv">0</span>, <span class="dv">1</span>),  <span class="co"># Patrón senoidal para TEMP_A</span></span>
<span id="cb14-96"><a href="#cb14-96" aria-hidden="true" tabindex="-1"></a>    <span class="dv">22</span> <span class="sc">+</span> <span class="dv">3</span><span class="sc">*</span><span class="fu">cos</span>(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">14</span><span class="sc">*</span>pi, <span class="at">length.out =</span> <span class="dv">672</span>)) <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">672</span>, <span class="dv">0</span>, <span class="fl">0.8</span>), <span class="co"># Patrón cosenoidal para TEMP_B</span></span>
<span id="cb14-97"><a href="#cb14-97" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cumsum</span>(<span class="fu">rnorm</span>(<span class="dv">672</span>, <span class="dv">0</span>, <span class="fl">0.5</span>)) <span class="sc">+</span> <span class="dv">21</span> <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">672</span>, <span class="dv">0</span>, <span class="fl">0.3</span>)            <span class="co"># Random walk para TEMP_C</span></span>
<span id="cb14-98"><a href="#cb14-98" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb14-99"><a href="#cb14-99" aria-hidden="true" tabindex="-1"></a>  <span class="at">ubicacion =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Almacén_A"</span>, <span class="st">"Almacén_B"</span>, <span class="st">"Almacén_C"</span>), <span class="at">each =</span> <span class="dv">672</span>)</span>
<span id="cb14-100"><a href="#cb14-100" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-101"><a href="#cb14-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-102"><a href="#cb14-102" aria-hidden="true" tabindex="-1"></a><span class="co"># Limpiar valores extremos</span></span>
<span id="cb14-103"><a href="#cb14-103" aria-hidden="true" tabindex="-1"></a>sensores_temperatura[temperatura <span class="sc">&lt;</span> <span class="dv">5</span> <span class="sc">|</span> temperatura <span class="sc">&gt;</span> <span class="dv">40</span>, temperatura <span class="sc">:</span><span class="er">=</span> <span class="cn">NA</span>]</span>
<span id="cb14-104"><a href="#cb14-104" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-105"><a href="#cb14-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-106"><a href="#cb14-106" aria-hidden="true" tabindex="-1"></a><span class="fu">## Funciones de Ventana (Window Functions)</span></span>
<span id="cb14-107"><a href="#cb14-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-108"><a href="#cb14-108" aria-hidden="true" tabindex="-1"></a>Las funciones de ventana permiten realizar cálculos sobre un conjunto de filas relacionadas con la fila actual, sin colapsar el resultado como lo harían las funciones de agregación.</span>
<span id="cb14-109"><a href="#cb14-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-110"><a href="#cb14-110" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1. **`shift()`: Valores Anteriores y Posteriores**</span></span>
<span id="cb14-111"><a href="#cb14-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-114"><a href="#cb14-114" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-115"><a href="#cb14-115" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: shift-basico</span></span>
<span id="cb14-116"><a href="#cb14-116" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb14-117"><a href="#cb14-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-118"><a href="#cb14-118" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular cambios diarios en precios</span></span>
<span id="cb14-119"><a href="#cb14-119" aria-hidden="true" tabindex="-1"></a>precios_con_lag <span class="ot">&lt;-</span> precios_diarios[<span class="fu">order</span>(ticker, fecha)][,</span>
<span id="cb14-120"><a href="#cb14-120" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-121"><a href="#cb14-121" aria-hidden="true" tabindex="-1"></a>    <span class="at">precio_anterior =</span> <span class="fu">shift</span>(precio_cierre, <span class="dv">1</span>),          <span class="co"># t-1</span></span>
<span id="cb14-122"><a href="#cb14-122" aria-hidden="true" tabindex="-1"></a>    <span class="at">precio_siguiente =</span> <span class="fu">shift</span>(precio_cierre, <span class="sc">-</span><span class="dv">1</span>),        <span class="co"># t+1</span></span>
<span id="cb14-123"><a href="#cb14-123" aria-hidden="true" tabindex="-1"></a>    <span class="at">precio_3_dias_antes =</span> <span class="fu">shift</span>(precio_cierre, <span class="dv">3</span>),      <span class="co"># t-3</span></span>
<span id="cb14-124"><a href="#cb14-124" aria-hidden="true" tabindex="-1"></a>    <span class="at">volumen_anterior =</span> <span class="fu">shift</span>(volumen, <span class="dv">1</span>)</span>
<span id="cb14-125"><a href="#cb14-125" aria-hidden="true" tabindex="-1"></a>  ), by <span class="ot">=</span> ticker]</span>
<span id="cb14-126"><a href="#cb14-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-127"><a href="#cb14-127" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular métricas de cambio</span></span>
<span id="cb14-128"><a href="#cb14-128" aria-hidden="true" tabindex="-1"></a>precios_con_lag[, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-129"><a href="#cb14-129" aria-hidden="true" tabindex="-1"></a>  <span class="at">cambio_diario =</span> precio_cierre <span class="sc">-</span> precio_anterior,</span>
<span id="cb14-130"><a href="#cb14-130" aria-hidden="true" tabindex="-1"></a>  <span class="at">cambio_pct =</span> <span class="fu">round</span>((precio_cierre <span class="sc">-</span> precio_anterior) <span class="sc">/</span> precio_anterior <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">2</span>),</span>
<span id="cb14-131"><a href="#cb14-131" aria-hidden="true" tabindex="-1"></a>  <span class="at">volatilidad_3d =</span> <span class="fu">round</span>(<span class="fu">abs</span>(precio_cierre <span class="sc">-</span> precio_3_dias_antes) <span class="sc">/</span> precio_3_dias_antes <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">2</span>),</span>
<span id="cb14-132"><a href="#cb14-132" aria-hidden="true" tabindex="-1"></a>  <span class="at">cambio_volumen =</span> volumen <span class="sc">-</span> volumen_anterior</span>
<span id="cb14-133"><a href="#cb14-133" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb14-134"><a href="#cb14-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-135"><a href="#cb14-135" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Análisis de cambios diarios:"</span>)</span>
<span id="cb14-136"><a href="#cb14-136" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(precios_con_lag[<span class="sc">!</span><span class="fu">is.na</span>(precio_anterior), </span>
<span id="cb14-137"><a href="#cb14-137" aria-hidden="true" tabindex="-1"></a>                          .(ticker, fecha, precio_cierre, cambio_diario, cambio_pct, volatilidad_3d)], <span class="dv">10</span>))</span>
<span id="cb14-138"><a href="#cb14-138" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-139"><a href="#cb14-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-140"><a href="#cb14-140" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2. **`frollmean()` y Medias Móviles**</span></span>
<span id="cb14-141"><a href="#cb14-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-144"><a href="#cb14-144" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-145"><a href="#cb14-145" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: frollmean-avanzado</span></span>
<span id="cb14-146"><a href="#cb14-146" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb14-147"><a href="#cb14-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-148"><a href="#cb14-148" aria-hidden="true" tabindex="-1"></a><span class="co"># Múltiples medias móviles para análisis técnico</span></span>
<span id="cb14-149"><a href="#cb14-149" aria-hidden="true" tabindex="-1"></a>precios_ma <span class="ot">&lt;-</span> precios_diarios[<span class="fu">order</span>(ticker, fecha)][,</span>
<span id="cb14-150"><a href="#cb14-150" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-151"><a href="#cb14-151" aria-hidden="true" tabindex="-1"></a>    <span class="at">ma_5 =</span> <span class="fu">frollmean</span>(precio_cierre, <span class="dv">5</span>),           <span class="co"># Media móvil 5 días</span></span>
<span id="cb14-152"><a href="#cb14-152" aria-hidden="true" tabindex="-1"></a>    <span class="at">ma_20 =</span> <span class="fu">frollmean</span>(precio_cierre, <span class="dv">20</span>),         <span class="co"># Media móvil 20 días</span></span>
<span id="cb14-153"><a href="#cb14-153" aria-hidden="true" tabindex="-1"></a>    <span class="at">ma_50 =</span> <span class="fu">frollmean</span>(precio_cierre, <span class="dv">50</span>),         <span class="co"># Media móvil 50 días</span></span>
<span id="cb14-154"><a href="#cb14-154" aria-hidden="true" tabindex="-1"></a>    <span class="at">volume_ma_10 =</span> <span class="fu">frollmean</span>(volumen, <span class="dv">10</span>),        <span class="co"># Media móvil volumen 10 días</span></span>
<span id="cb14-155"><a href="#cb14-155" aria-hidden="true" tabindex="-1"></a>    <span class="at">volatilidad_20 =</span> <span class="fu">frollapply</span>(precio_cierre, <span class="dv">20</span>, sd, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)  <span class="co"># Volatilidad 20 días</span></span>
<span id="cb14-156"><a href="#cb14-156" aria-hidden="true" tabindex="-1"></a>  ), by <span class="ot">=</span> ticker]</span>
<span id="cb14-157"><a href="#cb14-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-158"><a href="#cb14-158" aria-hidden="true" tabindex="-1"></a><span class="co"># Señales técnicas basadas en cruces de medias móviles</span></span>
<span id="cb14-159"><a href="#cb14-159" aria-hidden="true" tabindex="-1"></a>precios_ma[<span class="sc">!</span><span class="fu">is.na</span>(ma_50), <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-160"><a href="#cb14-160" aria-hidden="true" tabindex="-1"></a>  señal<span class="at">_alcista =</span> ma_5 <span class="sc">&gt;</span> ma_20 <span class="sc">&amp;</span> ma_20 <span class="sc">&gt;</span> ma_50,</span>
<span id="cb14-161"><a href="#cb14-161" aria-hidden="true" tabindex="-1"></a>  señal<span class="at">_bajista =</span> ma_5 <span class="sc">&lt;</span> ma_20 <span class="sc">&amp;</span> ma_20 <span class="sc">&lt;</span> ma_50,</span>
<span id="cb14-162"><a href="#cb14-162" aria-hidden="true" tabindex="-1"></a>  <span class="at">precio_sobre_ma20 =</span> precio_cierre <span class="sc">&gt;</span> ma_20,</span>
<span id="cb14-163"><a href="#cb14-163" aria-hidden="true" tabindex="-1"></a>  <span class="at">volumen_alto =</span> volumen <span class="sc">&gt;</span> volume_ma_10 <span class="sc">*</span> <span class="fl">1.5</span></span>
<span id="cb14-164"><a href="#cb14-164" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb14-165"><a href="#cb14-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-166"><a href="#cb14-166" aria-hidden="true" tabindex="-1"></a><span class="co"># Resumen de señales por ticker</span></span>
<span id="cb14-167"><a href="#cb14-167" aria-hidden="true" tabindex="-1"></a>señales_resumen <span class="ot">&lt;-</span> precios_ma[<span class="sc">!</span><span class="fu">is.na</span>(señal_alcista), .(</span>
<span id="cb14-168"><a href="#cb14-168" aria-hidden="true" tabindex="-1"></a>  <span class="at">dias_analizados =</span> .N,</span>
<span id="cb14-169"><a href="#cb14-169" aria-hidden="true" tabindex="-1"></a>  señales<span class="at">_alcistas =</span> <span class="fu">sum</span>(señal_alcista, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-170"><a href="#cb14-170" aria-hidden="true" tabindex="-1"></a>  señales<span class="at">_bajistas =</span> <span class="fu">sum</span>(señal_bajista, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-171"><a href="#cb14-171" aria-hidden="true" tabindex="-1"></a>  <span class="at">dias_sobre_ma20 =</span> <span class="fu">sum</span>(precio_sobre_ma20, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-172"><a href="#cb14-172" aria-hidden="true" tabindex="-1"></a>  <span class="at">volatilidad_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(volatilidad_20, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">2</span>)</span>
<span id="cb14-173"><a href="#cb14-173" aria-hidden="true" tabindex="-1"></a>), by <span class="ot">=</span> ticker]</span>
<span id="cb14-174"><a href="#cb14-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-175"><a href="#cb14-175" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Resumen de señales técnicas:"</span>)</span>
<span id="cb14-176"><a href="#cb14-176" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(señales_resumen)</span>
<span id="cb14-177"><a href="#cb14-177" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-178"><a href="#cb14-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-179"><a href="#cb14-179" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3. **`frollapply()`: Funciones Personalizadas**</span></span>
<span id="cb14-180"><a href="#cb14-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-183"><a href="#cb14-183" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-184"><a href="#cb14-184" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: frollapply-personalizado</span></span>
<span id="cb14-185"><a href="#cb14-185" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb14-186"><a href="#cb14-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-187"><a href="#cb14-187" aria-hidden="true" tabindex="-1"></a><span class="co"># Funciones personalizadas para análisis de ventana</span></span>
<span id="cb14-188"><a href="#cb14-188" aria-hidden="true" tabindex="-1"></a>precios_estadisticas <span class="ot">&lt;-</span> precios_diarios[<span class="fu">order</span>(ticker, fecha)][,</span>
<span id="cb14-189"><a href="#cb14-189" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-190"><a href="#cb14-190" aria-hidden="true" tabindex="-1"></a>    <span class="at">rango_10d =</span> <span class="fu">frollapply</span>(precio_cierre, <span class="dv">10</span>, <span class="cf">function</span>(x) <span class="fu">max</span>(x) <span class="sc">-</span> <span class="fu">min</span>(x)),</span>
<span id="cb14-191"><a href="#cb14-191" aria-hidden="true" tabindex="-1"></a>    <span class="at">percentil_75_20d =</span> <span class="fu">frollapply</span>(precio_cierre, <span class="dv">20</span>, <span class="cf">function</span>(x) <span class="fu">quantile</span>(x, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb14-192"><a href="#cb14-192" aria-hidden="true" tabindex="-1"></a>    <span class="at">coef_variacion_15d =</span> <span class="fu">frollapply</span>(precio_cierre, <span class="dv">15</span>, <span class="cf">function</span>(x) <span class="fu">sd</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb14-193"><a href="#cb14-193" aria-hidden="true" tabindex="-1"></a>    <span class="at">precio_z_score_30d =</span> <span class="fu">frollapply</span>(precio_cierre, <span class="dv">30</span>, <span class="cf">function</span>(x) {</span>
<span id="cb14-194"><a href="#cb14-194" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">length</span>(x) <span class="sc">&lt;</span> <span class="dv">30</span>) <span class="fu">return</span>(<span class="cn">NA</span>)</span>
<span id="cb14-195"><a href="#cb14-195" aria-hidden="true" tabindex="-1"></a>      (<span class="fu">tail</span>(x, <span class="dv">1</span>) <span class="sc">-</span> <span class="fu">mean</span>(x)) <span class="sc">/</span> <span class="fu">sd</span>(x)</span>
<span id="cb14-196"><a href="#cb14-196" aria-hidden="true" tabindex="-1"></a>    }),</span>
<span id="cb14-197"><a href="#cb14-197" aria-hidden="true" tabindex="-1"></a>    <span class="at">tendencia_5d =</span> <span class="fu">frollapply</span>(precio_cierre, <span class="dv">5</span>, <span class="cf">function</span>(x) {</span>
<span id="cb14-198"><a href="#cb14-198" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">length</span>(x) <span class="sc">&lt;</span> <span class="dv">5</span>) <span class="fu">return</span>(<span class="cn">NA</span>)</span>
<span id="cb14-199"><a href="#cb14-199" aria-hidden="true" tabindex="-1"></a>      lm_result <span class="ot">&lt;-</span> <span class="fu">lm</span>(x <span class="sc">~</span> <span class="fu">seq_along</span>(x))</span>
<span id="cb14-200"><a href="#cb14-200" aria-hidden="true" tabindex="-1"></a>      <span class="fu">coef</span>(lm_result)[<span class="dv">2</span>]  <span class="co"># Pendiente</span></span>
<span id="cb14-201"><a href="#cb14-201" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb14-202"><a href="#cb14-202" aria-hidden="true" tabindex="-1"></a>  ), by <span class="ot">=</span> ticker]</span>
<span id="cb14-203"><a href="#cb14-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-204"><a href="#cb14-204" aria-hidden="true" tabindex="-1"></a><span class="co"># Análisis de distribuciones y outliers</span></span>
<span id="cb14-205"><a href="#cb14-205" aria-hidden="true" tabindex="-1"></a>analisis_outliers <span class="ot">&lt;-</span> precios_estadisticas[<span class="sc">!</span><span class="fu">is.na</span>(precio_z_score_30d), .(</span>
<span id="cb14-206"><a href="#cb14-206" aria-hidden="true" tabindex="-1"></a>  ticker,</span>
<span id="cb14-207"><a href="#cb14-207" aria-hidden="true" tabindex="-1"></a>  fecha,</span>
<span id="cb14-208"><a href="#cb14-208" aria-hidden="true" tabindex="-1"></a>  precio_cierre,</span>
<span id="cb14-209"><a href="#cb14-209" aria-hidden="true" tabindex="-1"></a>  <span class="at">z_score =</span> <span class="fu">round</span>(precio_z_score_30d, <span class="dv">2</span>),</span>
<span id="cb14-210"><a href="#cb14-210" aria-hidden="true" tabindex="-1"></a>  <span class="at">coef_var =</span> <span class="fu">round</span>(coef_variacion_15d, <span class="dv">3</span>),</span>
<span id="cb14-211"><a href="#cb14-211" aria-hidden="true" tabindex="-1"></a>  <span class="at">tendencia =</span> <span class="fu">round</span>(tendencia_5d, <span class="dv">4</span>),</span>
<span id="cb14-212"><a href="#cb14-212" aria-hidden="true" tabindex="-1"></a>  <span class="at">outlier_extremo =</span> <span class="fu">abs</span>(precio_z_score_30d) <span class="sc">&gt;</span> <span class="dv">2</span></span>
<span id="cb14-213"><a href="#cb14-213" aria-hidden="true" tabindex="-1"></a>)][outlier_extremo <span class="sc">==</span> <span class="cn">TRUE</span>][<span class="fu">order</span>(<span class="sc">-</span><span class="fu">abs</span>(z_score))]</span>
<span id="cb14-214"><a href="#cb14-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-215"><a href="#cb14-215" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Precios con comportamiento outlier (|z-score| &gt; 2):"</span>)</span>
<span id="cb14-216"><a href="#cb14-216" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(analisis_outliers, <span class="dv">10</span>))</span>
<span id="cb14-217"><a href="#cb14-217" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-218"><a href="#cb14-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-219"><a href="#cb14-219" aria-hidden="true" tabindex="-1"></a><span class="fu">## Funciones Condicionales Optimizadas</span></span>
<span id="cb14-220"><a href="#cb14-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-221"><a href="#cb14-221" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1. **`fifelse()`: Condicionales Rápidas**</span></span>
<span id="cb14-222"><a href="#cb14-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-225"><a href="#cb14-225" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-226"><a href="#cb14-226" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fifelse-optimizado</span></span>
<span id="cb14-227"><a href="#cb14-227" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb14-228"><a href="#cb14-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-229"><a href="#cb14-229" aria-hidden="true" tabindex="-1"></a><span class="co"># Comparación de rendimiento: fifelse vs ifelse</span></span>
<span id="cb14-230"><a href="#cb14-230" aria-hidden="true" tabindex="-1"></a>clientes_clasificacion <span class="ot">&lt;-</span> <span class="fu">copy</span>(clientes_retencion)</span>
<span id="cb14-231"><a href="#cb14-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-232"><a href="#cb14-232" aria-hidden="true" tabindex="-1"></a><span class="co"># fifelse para clasificaciones múltiples y anidadas</span></span>
<span id="cb14-233"><a href="#cb14-233" aria-hidden="true" tabindex="-1"></a>clientes_clasificacion[, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-234"><a href="#cb14-234" aria-hidden="true" tabindex="-1"></a>  <span class="at">segmento_edad =</span> <span class="fu">fifelse</span>(</span>
<span id="cb14-235"><a href="#cb14-235" aria-hidden="true" tabindex="-1"></a>    edad <span class="sc">&lt;</span> <span class="dv">25</span>, <span class="st">"Joven"</span>,</span>
<span id="cb14-236"><a href="#cb14-236" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fifelse</span>(edad <span class="sc">&lt;</span> <span class="dv">45</span>, <span class="st">"Adulto"</span>, <span class="st">"Senior"</span>)</span>
<span id="cb14-237"><a href="#cb14-237" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb14-238"><a href="#cb14-238" aria-hidden="true" tabindex="-1"></a>  <span class="at">categoria_ingresos =</span> <span class="fu">fifelse</span>(</span>
<span id="cb14-239"><a href="#cb14-239" aria-hidden="true" tabindex="-1"></a>    ingresos_mensuales <span class="sc">&lt;</span> <span class="dv">2000</span>, <span class="st">"Bajos"</span>,</span>
<span id="cb14-240"><a href="#cb14-240" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fifelse</span>(ingresos_mensuales <span class="sc">&lt;</span> <span class="dv">5000</span>, <span class="st">"Medios"</span>, <span class="st">"Altos"</span>)</span>
<span id="cb14-241"><a href="#cb14-241" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb14-242"><a href="#cb14-242" aria-hidden="true" tabindex="-1"></a>  <span class="at">tipo_cliente =</span> <span class="fu">fifelse</span>(</span>
<span id="cb14-243"><a href="#cb14-243" aria-hidden="true" tabindex="-1"></a>    plan <span class="sc">==</span> <span class="st">"Empresarial"</span>, <span class="st">"Corporativo"</span>,</span>
<span id="cb14-244"><a href="#cb14-244" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fifelse</span>(activo <span class="sc">&amp;</span> ingresos_mensuales <span class="sc">&gt;</span> <span class="dv">3000</span>, <span class="st">"Premium_Activo"</span>, <span class="st">"Estándar"</span>)</span>
<span id="cb14-245"><a href="#cb14-245" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-246"><a href="#cb14-246" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb14-247"><a href="#cb14-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-248"><a href="#cb14-248" aria-hidden="true" tabindex="-1"></a><span class="co"># Análisis de segmentos</span></span>
<span id="cb14-249"><a href="#cb14-249" aria-hidden="true" tabindex="-1"></a>segmentos_analisis <span class="ot">&lt;-</span> clientes_clasificacion[, .(</span>
<span id="cb14-250"><a href="#cb14-250" aria-hidden="true" tabindex="-1"></a>  <span class="at">clientes =</span> .N,</span>
<span id="cb14-251"><a href="#cb14-251" aria-hidden="true" tabindex="-1"></a>  <span class="at">ingresos_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(ingresos_mensuales), <span class="dv">0</span>),</span>
<span id="cb14-252"><a href="#cb14-252" aria-hidden="true" tabindex="-1"></a>  <span class="at">tasa_actividad =</span> <span class="fu">round</span>(<span class="fu">mean</span>(activo) <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>),</span>
<span id="cb14-253"><a href="#cb14-253" aria-hidden="true" tabindex="-1"></a>  <span class="at">planes_premium =</span> <span class="fu">sum</span>(plan <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Premium"</span>, <span class="st">"Empresarial"</span>))</span>
<span id="cb14-254"><a href="#cb14-254" aria-hidden="true" tabindex="-1"></a>), by <span class="ot">=</span> .(segmento_edad, categoria_ingresos, tipo_cliente)]</span>
<span id="cb14-255"><a href="#cb14-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-256"><a href="#cb14-256" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Análisis de segmentos de clientes:"</span>)</span>
<span id="cb14-257"><a href="#cb14-257" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(segmentos_analisis[<span class="fu">order</span>(<span class="sc">-</span>clientes)])</span>
<span id="cb14-258"><a href="#cb14-258" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-259"><a href="#cb14-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-260"><a href="#cb14-260" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2. **`fcase()`: Múltiples Condiciones Elegantes**</span></span>
<span id="cb14-261"><a href="#cb14-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-264"><a href="#cb14-264" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-265"><a href="#cb14-265" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fcase-multiples-condiciones</span></span>
<span id="cb14-266"><a href="#cb14-266" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb14-267"><a href="#cb14-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-268"><a href="#cb14-268" aria-hidden="true" tabindex="-1"></a><span class="co"># Sistema de scoring complejo con fcase</span></span>
<span id="cb14-269"><a href="#cb14-269" aria-hidden="true" tabindex="-1"></a>clientes_clasificacion[, score_retencion <span class="sc">:</span><span class="er">=</span> <span class="fu">fcase</span>(</span>
<span id="cb14-270"><a href="#cb14-270" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Casos de alto valor</span></span>
<span id="cb14-271"><a href="#cb14-271" aria-hidden="true" tabindex="-1"></a>  plan <span class="sc">==</span> <span class="st">"Empresarial"</span> <span class="sc">&amp;</span> activo <span class="sc">&amp;</span> ingresos_mensuales <span class="sc">&gt;</span> <span class="dv">5000</span>, <span class="dv">95</span>,</span>
<span id="cb14-272"><a href="#cb14-272" aria-hidden="true" tabindex="-1"></a>  plan <span class="sc">==</span> <span class="st">"Premium"</span> <span class="sc">&amp;</span> activo <span class="sc">&amp;</span> ingresos_mensuales <span class="sc">&gt;</span> <span class="dv">3000</span>, <span class="dv">85</span>,</span>
<span id="cb14-273"><a href="#cb14-273" aria-hidden="true" tabindex="-1"></a>  plan <span class="sc">==</span> <span class="st">"Básico"</span> <span class="sc">&amp;</span> activo <span class="sc">&amp;</span> ingresos_mensuales <span class="sc">&gt;</span> <span class="dv">4000</span>, <span class="dv">80</span>,</span>
<span id="cb14-274"><a href="#cb14-274" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-275"><a href="#cb14-275" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Casos de riesgo medio</span></span>
<span id="cb14-276"><a href="#cb14-276" aria-hidden="true" tabindex="-1"></a>  <span class="sc">!</span>activo <span class="sc">&amp;</span> ingresos_mensuales <span class="sc">&gt;</span> <span class="dv">3000</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(fecha_ultima_actividad), <span class="dv">60</span>,</span>
<span id="cb14-277"><a href="#cb14-277" aria-hidden="true" tabindex="-1"></a>  activo <span class="sc">&amp;</span> ingresos_mensuales <span class="sc">&lt;</span> <span class="dv">2000</span>, <span class="dv">55</span>,</span>
<span id="cb14-278"><a href="#cb14-278" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-279"><a href="#cb14-279" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Casos de alto riesgo</span></span>
<span id="cb14-280"><a href="#cb14-280" aria-hidden="true" tabindex="-1"></a>  <span class="sc">!</span>activo <span class="sc">&amp;</span> <span class="fu">is.na</span>(fecha_ultima_actividad), <span class="dv">20</span>,</span>
<span id="cb14-281"><a href="#cb14-281" aria-hidden="true" tabindex="-1"></a>  <span class="sc">!</span>activo <span class="sc">&amp;</span> ingresos_mensuales <span class="sc">&lt;</span> <span class="dv">2000</span>, <span class="dv">15</span>,</span>
<span id="cb14-282"><a href="#cb14-282" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-283"><a href="#cb14-283" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Caso por defecto</span></span>
<span id="cb14-284"><a href="#cb14-284" aria-hidden="true" tabindex="-1"></a>  <span class="at">default =</span> <span class="dv">50</span></span>
<span id="cb14-285"><a href="#cb14-285" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb14-286"><a href="#cb14-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-287"><a href="#cb14-287" aria-hidden="true" tabindex="-1"></a><span class="co"># Estrategia de retención basada en score</span></span>
<span id="cb14-288"><a href="#cb14-288" aria-hidden="true" tabindex="-1"></a>clientes_clasificacion[, estrategia_retencion <span class="sc">:</span><span class="er">=</span> <span class="fu">fcase</span>(</span>
<span id="cb14-289"><a href="#cb14-289" aria-hidden="true" tabindex="-1"></a>  score_retencion <span class="sc">&gt;=</span> <span class="dv">90</span>, <span class="st">"Mantener_Premium"</span>,</span>
<span id="cb14-290"><a href="#cb14-290" aria-hidden="true" tabindex="-1"></a>  score_retencion <span class="sc">&gt;=</span> <span class="dv">70</span>, <span class="st">"Fidelizar_Activo"</span>, </span>
<span id="cb14-291"><a href="#cb14-291" aria-hidden="true" tabindex="-1"></a>  score_retencion <span class="sc">&gt;=</span> <span class="dv">50</span>, <span class="st">"Reactivar_Moderado"</span>,</span>
<span id="cb14-292"><a href="#cb14-292" aria-hidden="true" tabindex="-1"></a>  score_retencion <span class="sc">&gt;=</span> <span class="dv">30</span>, <span class="st">"Reactivar_Intensivo"</span>,</span>
<span id="cb14-293"><a href="#cb14-293" aria-hidden="true" tabindex="-1"></a>  <span class="at">default =</span> <span class="st">"Evaluar_Cancelación"</span></span>
<span id="cb14-294"><a href="#cb14-294" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb14-295"><a href="#cb14-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-296"><a href="#cb14-296" aria-hidden="true" tabindex="-1"></a><span class="co"># Resumen estratégico</span></span>
<span id="cb14-297"><a href="#cb14-297" aria-hidden="true" tabindex="-1"></a>resumen_estrategia <span class="ot">&lt;-</span> clientes_clasificacion[, .(</span>
<span id="cb14-298"><a href="#cb14-298" aria-hidden="true" tabindex="-1"></a>  <span class="at">clientes =</span> .N,</span>
<span id="cb14-299"><a href="#cb14-299" aria-hidden="true" tabindex="-1"></a>  <span class="at">score_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(score_retencion), <span class="dv">1</span>),</span>
<span id="cb14-300"><a href="#cb14-300" aria-hidden="true" tabindex="-1"></a>  <span class="at">ingresos_totales =</span> <span class="fu">sum</span>(ingresos_mensuales),</span>
<span id="cb14-301"><a href="#cb14-301" aria-hidden="true" tabindex="-1"></a>  <span class="at">valor_cliente_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(ingresos_mensuales), <span class="dv">0</span>)</span>
<span id="cb14-302"><a href="#cb14-302" aria-hidden="true" tabindex="-1"></a>), by <span class="ot">=</span> estrategia_retencion][<span class="fu">order</span>(<span class="sc">-</span>score_promedio)]</span>
<span id="cb14-303"><a href="#cb14-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-304"><a href="#cb14-304" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Estrategias de retención por score:"</span>)</span>
<span id="cb14-305"><a href="#cb14-305" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(resumen_estrategia)</span>
<span id="cb14-306"><a href="#cb14-306" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-307"><a href="#cb14-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-308"><a href="#cb14-308" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3. **`between()`: Rangos Eficientes**</span></span>
<span id="cb14-309"><a href="#cb14-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-312"><a href="#cb14-312" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-313"><a href="#cb14-313" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: between-rangos</span></span>
<span id="cb14-314"><a href="#cb14-314" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb14-315"><a href="#cb14-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-316"><a href="#cb14-316" aria-hidden="true" tabindex="-1"></a><span class="co"># Usar between para clasificaciones por rangos</span></span>
<span id="cb14-317"><a href="#cb14-317" aria-hidden="true" tabindex="-1"></a>transacciones_analisis <span class="ot">&lt;-</span> <span class="fu">copy</span>(transacciones_comportamiento)</span>
<span id="cb14-318"><a href="#cb14-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-319"><a href="#cb14-319" aria-hidden="true" tabindex="-1"></a>transacciones_analisis[, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-320"><a href="#cb14-320" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clasificación por monto usando between</span></span>
<span id="cb14-321"><a href="#cb14-321" aria-hidden="true" tabindex="-1"></a>  <span class="at">categoria_monto =</span> <span class="fu">fcase</span>(</span>
<span id="cb14-322"><a href="#cb14-322" aria-hidden="true" tabindex="-1"></a>    <span class="fu">between</span>(monto, <span class="dv">0</span>, <span class="dv">20</span>), <span class="st">"Micro"</span>,</span>
<span id="cb14-323"><a href="#cb14-323" aria-hidden="true" tabindex="-1"></a>    <span class="fu">between</span>(monto, <span class="fl">20.01</span>, <span class="dv">100</span>), <span class="st">"Pequeña"</span>, </span>
<span id="cb14-324"><a href="#cb14-324" aria-hidden="true" tabindex="-1"></a>    <span class="fu">between</span>(monto, <span class="fl">100.01</span>, <span class="dv">500</span>), <span class="st">"Mediana"</span>,</span>
<span id="cb14-325"><a href="#cb14-325" aria-hidden="true" tabindex="-1"></a>    <span class="fu">between</span>(monto, <span class="fl">500.01</span>, <span class="dv">2000</span>), <span class="st">"Grande"</span>,</span>
<span id="cb14-326"><a href="#cb14-326" aria-hidden="true" tabindex="-1"></a>    monto <span class="sc">&gt;</span> <span class="dv">2000</span>, <span class="st">"Muy Grande"</span>,</span>
<span id="cb14-327"><a href="#cb14-327" aria-hidden="true" tabindex="-1"></a>    <span class="at">default =</span> <span class="st">"Sin Clasificar"</span></span>
<span id="cb14-328"><a href="#cb14-328" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb14-329"><a href="#cb14-329" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-330"><a href="#cb14-330" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clasificación temporal</span></span>
<span id="cb14-331"><a href="#cb14-331" aria-hidden="true" tabindex="-1"></a>  <span class="at">hora =</span> <span class="fu">hour</span>(fecha_transaccion),</span>
<span id="cb14-332"><a href="#cb14-332" aria-hidden="true" tabindex="-1"></a>  <span class="at">franja_horaria =</span> <span class="fu">fcase</span>(</span>
<span id="cb14-333"><a href="#cb14-333" aria-hidden="true" tabindex="-1"></a>    <span class="fu">between</span>(<span class="fu">hour</span>(fecha_transaccion), <span class="dv">6</span>, <span class="dv">11</span>), <span class="st">"Mañana"</span>,</span>
<span id="cb14-334"><a href="#cb14-334" aria-hidden="true" tabindex="-1"></a>    <span class="fu">between</span>(<span class="fu">hour</span>(fecha_transaccion), <span class="dv">12</span>, <span class="dv">17</span>), <span class="st">"Tarde"</span>, </span>
<span id="cb14-335"><a href="#cb14-335" aria-hidden="true" tabindex="-1"></a>    <span class="fu">between</span>(<span class="fu">hour</span>(fecha_transaccion), <span class="dv">18</span>, <span class="dv">22</span>), <span class="st">"Noche"</span>,</span>
<span id="cb14-336"><a href="#cb14-336" aria-hidden="true" tabindex="-1"></a>    <span class="at">default =</span> <span class="st">"Madrugada"</span></span>
<span id="cb14-337"><a href="#cb14-337" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb14-338"><a href="#cb14-338" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-339"><a href="#cb14-339" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Día de la semana</span></span>
<span id="cb14-340"><a href="#cb14-340" aria-hidden="true" tabindex="-1"></a>  <span class="at">dia_semana =</span> <span class="fu">wday</span>(fecha_transaccion, <span class="at">label =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-341"><a href="#cb14-341" aria-hidden="true" tabindex="-1"></a>  <span class="at">es_fin_semana =</span> <span class="fu">wday</span>(fecha_transaccion) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">7</span>)</span>
<span id="cb14-342"><a href="#cb14-342" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb14-343"><a href="#cb14-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-344"><a href="#cb14-344" aria-hidden="true" tabindex="-1"></a><span class="co"># Análisis de patrones de comportamiento</span></span>
<span id="cb14-345"><a href="#cb14-345" aria-hidden="true" tabindex="-1"></a>patrones_comportamiento <span class="ot">&lt;-</span> transacciones_analisis[, .(</span>
<span id="cb14-346"><a href="#cb14-346" aria-hidden="true" tabindex="-1"></a>  <span class="at">transacciones =</span> .N,</span>
<span id="cb14-347"><a href="#cb14-347" aria-hidden="true" tabindex="-1"></a>  <span class="at">monto_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(monto), <span class="dv">2</span>),</span>
<span id="cb14-348"><a href="#cb14-348" aria-hidden="true" tabindex="-1"></a>  <span class="at">monto_mediana =</span> <span class="fu">round</span>(<span class="fu">median</span>(monto), <span class="dv">2</span>),</span>
<span id="cb14-349"><a href="#cb14-349" aria-hidden="true" tabindex="-1"></a>  <span class="at">monto_total =</span> <span class="fu">round</span>(<span class="fu">sum</span>(monto), <span class="dv">2</span>)</span>
<span id="cb14-350"><a href="#cb14-350" aria-hidden="true" tabindex="-1"></a>), by <span class="ot">=</span> .(categoria_monto, franja_horaria, es_fin_semana)][</span>
<span id="cb14-351"><a href="#cb14-351" aria-hidden="true" tabindex="-1"></a>  <span class="fu">order</span>(<span class="sc">-</span>transacciones)</span>
<span id="cb14-352"><a href="#cb14-352" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb14-353"><a href="#cb14-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-354"><a href="#cb14-354" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Patrones de comportamiento transaccional:"</span>)</span>
<span id="cb14-355"><a href="#cb14-355" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(patrones_comportamiento, <span class="dv">12</span>))</span>
<span id="cb14-356"><a href="#cb14-356" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-357"><a href="#cb14-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-358"><a href="#cb14-358" aria-hidden="true" tabindex="-1"></a><span class="fu">## Funciones de Agregación Especiales</span></span>
<span id="cb14-359"><a href="#cb14-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-360"><a href="#cb14-360" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1. **`frank()`: Rankings y Percentiles**</span></span>
<span id="cb14-361"><a href="#cb14-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-364"><a href="#cb14-364" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-365"><a href="#cb14-365" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: frank-rankings</span></span>
<span id="cb14-366"><a href="#cb14-366" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb14-367"><a href="#cb14-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-368"><a href="#cb14-368" aria-hidden="true" tabindex="-1"></a><span class="co"># Rankings complejos con frank()</span></span>
<span id="cb14-369"><a href="#cb14-369" aria-hidden="true" tabindex="-1"></a>rankings_clientes <span class="ot">&lt;-</span> clientes_clasificacion[, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-370"><a href="#cb14-370" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ranking por ingresos (descendente)</span></span>
<span id="cb14-371"><a href="#cb14-371" aria-hidden="true" tabindex="-1"></a>  <span class="at">rank_ingresos =</span> <span class="fu">frank</span>(<span class="sc">-</span>ingresos_mensuales),</span>
<span id="cb14-372"><a href="#cb14-372" aria-hidden="true" tabindex="-1"></a>  <span class="at">rank_ingresos_pct =</span> <span class="fu">frank</span>(<span class="sc">-</span>ingresos_mensuales <span class="sc">/</span> .N <span class="sc">*</span> <span class="dv">100</span>),</span>
<span id="cb14-373"><a href="#cb14-373" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-374"><a href="#cb14-374" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ranking por score de retención</span></span>
<span id="cb14-375"><a href="#cb14-375" aria-hidden="true" tabindex="-1"></a>  <span class="at">rank_retencion =</span> <span class="fu">frank</span>(<span class="sc">-</span>score_retencion),</span>
<span id="cb14-376"><a href="#cb14-376" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-377"><a href="#cb14-377" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ranking dentro de cada plan</span></span>
<span id="cb14-378"><a href="#cb14-378" aria-hidden="true" tabindex="-1"></a>  <span class="at">rank_en_plan =</span> <span class="fu">frank</span>(.SD[,<span class="sc">-</span>ingresos_mensuales, <span class="at">by =</span> plan]),</span>
<span id="cb14-379"><a href="#cb14-379" aria-hidden="true" tabindex="-1"></a>  <span class="at">rank_en_pais =</span> <span class="fu">frank</span>(.SD[,<span class="sc">-</span>ingresos_mensuales, <span class="at">by =</span> pais])</span>
<span id="cb14-380"><a href="#cb14-380" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb14-381"><a href="#cb14-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-382"><a href="#cb14-382" aria-hidden="true" tabindex="-1"></a><span class="co"># Top performers por categoría</span></span>
<span id="cb14-383"><a href="#cb14-383" aria-hidden="true" tabindex="-1"></a>top_performers <span class="ot">&lt;-</span> rankings_clientes[rank_ingresos <span class="sc">&lt;=</span> <span class="dv">50</span>, .(</span>
<span id="cb14-384"><a href="#cb14-384" aria-hidden="true" tabindex="-1"></a>  cliente_id, plan, pais, ingresos_mensuales, score_retencion,</span>
<span id="cb14-385"><a href="#cb14-385" aria-hidden="true" tabindex="-1"></a>  <span class="at">rank_global =</span> rank_ingresos,</span>
<span id="cb14-386"><a href="#cb14-386" aria-hidden="true" tabindex="-1"></a>  rank_en_plan, rank_en_pais,</span>
<span id="cb14-387"><a href="#cb14-387" aria-hidden="true" tabindex="-1"></a>  <span class="at">percentil_ingresos =</span> <span class="fu">round</span>(<span class="dv">100</span> <span class="sc">-</span> rank_ingresos_pct, <span class="dv">1</span>)</span>
<span id="cb14-388"><a href="#cb14-388" aria-hidden="true" tabindex="-1"></a>)][<span class="fu">order</span>(rank_global)]</span>
<span id="cb14-389"><a href="#cb14-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-390"><a href="#cb14-390" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Top 10 clientes por ingresos:"</span>)</span>
<span id="cb14-391"><a href="#cb14-391" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(top_performers, <span class="dv">10</span>))</span>
<span id="cb14-392"><a href="#cb14-392" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-393"><a href="#cb14-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-394"><a href="#cb14-394" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2. **`rleid()`: Identificación de Runs**</span></span>
<span id="cb14-395"><a href="#cb14-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-398"><a href="#cb14-398" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-399"><a href="#cb14-399" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: rleid-runs</span></span>
<span id="cb14-400"><a href="#cb14-400" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb14-401"><a href="#cb14-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-402"><a href="#cb14-402" aria-hidden="true" tabindex="-1"></a><span class="co"># Identificar secuencias de comportamiento con rleid()</span></span>
<span id="cb14-403"><a href="#cb14-403" aria-hidden="true" tabindex="-1"></a>sensores_runs <span class="ot">&lt;-</span> sensores_temperatura[<span class="fu">order</span>(sensor_id, timestamp)][, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-404"><a href="#cb14-404" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clasificar temperatura en rangos</span></span>
<span id="cb14-405"><a href="#cb14-405" aria-hidden="true" tabindex="-1"></a>  <span class="at">temp_categoria =</span> <span class="fu">fcase</span>(</span>
<span id="cb14-406"><a href="#cb14-406" aria-hidden="true" tabindex="-1"></a>    temperatura <span class="sc">&lt;</span> <span class="dv">18</span>, <span class="st">"Baja"</span>,</span>
<span id="cb14-407"><a href="#cb14-407" aria-hidden="true" tabindex="-1"></a>    <span class="fu">between</span>(temperatura, <span class="dv">18</span>, <span class="dv">22</span>), <span class="st">"Normal"</span>,</span>
<span id="cb14-408"><a href="#cb14-408" aria-hidden="true" tabindex="-1"></a>    <span class="fu">between</span>(temperatura, <span class="dv">22</span>, <span class="dv">26</span>), <span class="st">"Alta"</span>,</span>
<span id="cb14-409"><a href="#cb14-409" aria-hidden="true" tabindex="-1"></a>    temperatura <span class="sc">&gt;</span> <span class="dv">26</span>, <span class="st">"Muy Alta"</span>,</span>
<span id="cb14-410"><a href="#cb14-410" aria-hidden="true" tabindex="-1"></a>    <span class="at">default =</span> <span class="st">"Sin Datos"</span></span>
<span id="cb14-411"><a href="#cb14-411" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-412"><a href="#cb14-412" aria-hidden="true" tabindex="-1"></a>)][, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-413"><a href="#cb14-413" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Identificar runs (secuencias consecutivas)</span></span>
<span id="cb14-414"><a href="#cb14-414" aria-hidden="true" tabindex="-1"></a>  <span class="at">run_id =</span> <span class="fu">rleid</span>(temp_categoria),</span>
<span id="cb14-415"><a href="#cb14-415" aria-hidden="true" tabindex="-1"></a>  <span class="co"># También podemos identificar runs de tendencia</span></span>
<span id="cb14-416"><a href="#cb14-416" aria-hidden="true" tabindex="-1"></a>  <span class="at">tendencia =</span> <span class="fu">fcase</span>(</span>
<span id="cb14-417"><a href="#cb14-417" aria-hidden="true" tabindex="-1"></a>    temperatura <span class="sc">&gt;</span> <span class="fu">shift</span>(temperatura, <span class="dv">1</span>), <span class="st">"Subida"</span>,</span>
<span id="cb14-418"><a href="#cb14-418" aria-hidden="true" tabindex="-1"></a>    temperatura <span class="sc">&lt;</span> <span class="fu">shift</span>(temperatura, <span class="dv">1</span>), <span class="st">"Bajada"</span>, </span>
<span id="cb14-419"><a href="#cb14-419" aria-hidden="true" tabindex="-1"></a>    <span class="at">default =</span> <span class="st">"Estable"</span></span>
<span id="cb14-420"><a href="#cb14-420" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-421"><a href="#cb14-421" aria-hidden="true" tabindex="-1"></a>), by <span class="ot">=</span> sensor_id][, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-422"><a href="#cb14-422" aria-hidden="true" tabindex="-1"></a>  <span class="at">run_tendencia =</span> <span class="fu">rleid</span>(tendencia)</span>
<span id="cb14-423"><a href="#cb14-423" aria-hidden="true" tabindex="-1"></a>), by <span class="ot">=</span> sensor_id]</span>
<span id="cb14-424"><a href="#cb14-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-425"><a href="#cb14-425" aria-hidden="true" tabindex="-1"></a><span class="co"># Análisis de runs de temperatura</span></span>
<span id="cb14-426"><a href="#cb14-426" aria-hidden="true" tabindex="-1"></a>analisis_runs <span class="ot">&lt;-</span> sensores_runs[<span class="sc">!</span><span class="fu">is.na</span>(temperatura), .(</span>
<span id="cb14-427"><a href="#cb14-427" aria-hidden="true" tabindex="-1"></a>  <span class="at">duracion_run =</span> .N,</span>
<span id="cb14-428"><a href="#cb14-428" aria-hidden="true" tabindex="-1"></a>  <span class="at">temp_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(temperatura, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">1</span>),</span>
<span id="cb14-429"><a href="#cb14-429" aria-hidden="true" tabindex="-1"></a>  <span class="at">temp_min =</span> <span class="fu">round</span>(<span class="fu">min</span>(temperatura, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">1</span>),</span>
<span id="cb14-430"><a href="#cb14-430" aria-hidden="true" tabindex="-1"></a>  <span class="at">temp_max =</span> <span class="fu">round</span>(<span class="fu">max</span>(temperatura, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">1</span>),</span>
<span id="cb14-431"><a href="#cb14-431" aria-hidden="true" tabindex="-1"></a>  <span class="at">inicio_run =</span> <span class="fu">min</span>(timestamp),</span>
<span id="cb14-432"><a href="#cb14-432" aria-hidden="true" tabindex="-1"></a>  <span class="at">fin_run =</span> <span class="fu">max</span>(timestamp)</span>
<span id="cb14-433"><a href="#cb14-433" aria-hidden="true" tabindex="-1"></a>), by <span class="ot">=</span> .(sensor_id, temp_categoria, run_id)][</span>
<span id="cb14-434"><a href="#cb14-434" aria-hidden="true" tabindex="-1"></a>  duracion_run <span class="sc">&gt;=</span> <span class="dv">4</span>  <span class="co"># Solo runs de al menos 4 mediciones (1 hora)</span></span>
<span id="cb14-435"><a href="#cb14-435" aria-hidden="true" tabindex="-1"></a>][<span class="fu">order</span>(sensor_id, <span class="sc">-</span>duracion_run)]</span>
<span id="cb14-436"><a href="#cb14-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-437"><a href="#cb14-437" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Runs de temperatura más largos:"</span>)</span>
<span id="cb14-438"><a href="#cb14-438" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(analisis_runs, <span class="dv">12</span>))</span>
<span id="cb14-439"><a href="#cb14-439" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-440"><a href="#cb14-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-441"><a href="#cb14-441" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3. **`uniqueN()`: Conteos de Únicos Eficientes**</span></span>
<span id="cb14-442"><a href="#cb14-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-445"><a href="#cb14-445" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-446"><a href="#cb14-446" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: uniqueN-eficiente</span></span>
<span id="cb14-447"><a href="#cb14-447" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb14-448"><a href="#cb14-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-449"><a href="#cb14-449" aria-hidden="true" tabindex="-1"></a><span class="co"># Análisis de diversidad con uniqueN()</span></span>
<span id="cb14-450"><a href="#cb14-450" aria-hidden="true" tabindex="-1"></a>diversidad_transacciones <span class="ot">&lt;-</span> transacciones_analisis[, .(</span>
<span id="cb14-451"><a href="#cb14-451" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Diversidad básica</span></span>
<span id="cb14-452"><a href="#cb14-452" aria-hidden="true" tabindex="-1"></a>  <span class="at">transacciones_totales =</span> .N,</span>
<span id="cb14-453"><a href="#cb14-453" aria-hidden="true" tabindex="-1"></a>  <span class="at">categorias_usadas =</span> <span class="fu">uniqueN</span>(categoria),</span>
<span id="cb14-454"><a href="#cb14-454" aria-hidden="true" tabindex="-1"></a>  <span class="at">comercios_visitados =</span> <span class="fu">uniqueN</span>(comercio_id),</span>
<span id="cb14-455"><a href="#cb14-455" aria-hidden="true" tabindex="-1"></a>  <span class="at">metodos_pago_usados =</span> <span class="fu">uniqueN</span>(metodo_pago),</span>
<span id="cb14-456"><a href="#cb14-456" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-457"><a href="#cb14-457" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Métricas de comportamiento</span></span>
<span id="cb14-458"><a href="#cb14-458" aria-hidden="true" tabindex="-1"></a>  <span class="at">dias_activos =</span> <span class="fu">uniqueN</span>(<span class="fu">as.Date</span>(fecha_transaccion)),</span>
<span id="cb14-459"><a href="#cb14-459" aria-hidden="true" tabindex="-1"></a>  <span class="at">horas_activas =</span> <span class="fu">uniqueN</span>(<span class="fu">hour</span>(fecha_transaccion)),</span>
<span id="cb14-460"><a href="#cb14-460" aria-hidden="true" tabindex="-1"></a>  <span class="at">monto_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(monto), <span class="dv">2</span>),</span>
<span id="cb14-461"><a href="#cb14-461" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-462"><a href="#cb14-462" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Diversidad temporal</span></span>
<span id="cb14-463"><a href="#cb14-463" aria-hidden="true" tabindex="-1"></a>  <span class="at">meses_activos =</span> <span class="fu">uniqueN</span>(<span class="fu">month</span>(fecha_transaccion)),</span>
<span id="cb14-464"><a href="#cb14-464" aria-hidden="true" tabindex="-1"></a>  <span class="at">dias_semana_activos =</span> <span class="fu">uniqueN</span>(<span class="fu">wday</span>(fecha_transaccion))</span>
<span id="cb14-465"><a href="#cb14-465" aria-hidden="true" tabindex="-1"></a>), by <span class="ot">=</span> cliente_id]</span>
<span id="cb14-466"><a href="#cb14-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-467"><a href="#cb14-467" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular índices de diversidad</span></span>
<span id="cb14-468"><a href="#cb14-468" aria-hidden="true" tabindex="-1"></a>diversidad_transacciones[, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-469"><a href="#cb14-469" aria-hidden="true" tabindex="-1"></a>  <span class="at">indice_diversidad_categoria =</span> <span class="fu">round</span>(categorias_usadas <span class="sc">/</span> <span class="dv">5</span> <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>),  <span class="co"># 5 categorías posibles</span></span>
<span id="cb14-470"><a href="#cb14-470" aria-hidden="true" tabindex="-1"></a>  <span class="at">indice_diversidad_temporal =</span> <span class="fu">round</span>(horas_activas <span class="sc">/</span> <span class="dv">24</span> <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>),      <span class="co"># 24 horas posibles</span></span>
<span id="cb14-471"><a href="#cb14-471" aria-hidden="true" tabindex="-1"></a>  <span class="at">indice_actividad =</span> <span class="fu">round</span>(dias_activos <span class="sc">/</span> <span class="dv">180</span> <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>),                <span class="co"># ~180 días en periodo</span></span>
<span id="cb14-472"><a href="#cb14-472" aria-hidden="true" tabindex="-1"></a>  <span class="at">score_engagement =</span> <span class="fu">round</span>((categorias_usadas <span class="sc">*</span> <span class="dv">10</span>) <span class="sc">+</span> (dias_activos <span class="sc">*</span> <span class="dv">2</span>) <span class="sc">+</span> (comercios_visitados <span class="sc">*</span> <span class="dv">3</span>), <span class="dv">0</span>)</span>
<span id="cb14-473"><a href="#cb14-473" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb14-474"><a href="#cb14-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-475"><a href="#cb14-475" aria-hidden="true" tabindex="-1"></a><span class="co"># Clasificar clientes por engagement</span></span>
<span id="cb14-476"><a href="#cb14-476" aria-hidden="true" tabindex="-1"></a>diversidad_transacciones[, categoria_engagement <span class="sc">:</span><span class="er">=</span> <span class="fu">fcase</span>(</span>
<span id="cb14-477"><a href="#cb14-477" aria-hidden="true" tabindex="-1"></a>  score_engagement <span class="sc">&gt;</span> <span class="dv">200</span>, <span class="st">"Muy Alto"</span>,</span>
<span id="cb14-478"><a href="#cb14-478" aria-hidden="true" tabindex="-1"></a>  score_engagement <span class="sc">&gt;</span> <span class="dv">100</span>, <span class="st">"Alto"</span>,</span>
<span id="cb14-479"><a href="#cb14-479" aria-hidden="true" tabindex="-1"></a>  score_engagement <span class="sc">&gt;</span> <span class="dv">50</span>, <span class="st">"Medio"</span>, </span>
<span id="cb14-480"><a href="#cb14-480" aria-hidden="true" tabindex="-1"></a>  score_engagement <span class="sc">&gt;</span> <span class="dv">20</span>, <span class="st">"Bajo"</span>,</span>
<span id="cb14-481"><a href="#cb14-481" aria-hidden="true" tabindex="-1"></a>  <span class="at">default =</span> <span class="st">"Muy Bajo"</span></span>
<span id="cb14-482"><a href="#cb14-482" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb14-483"><a href="#cb14-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-484"><a href="#cb14-484" aria-hidden="true" tabindex="-1"></a><span class="co"># Resumen por categoría de engagement</span></span>
<span id="cb14-485"><a href="#cb14-485" aria-hidden="true" tabindex="-1"></a>resumen_engagement <span class="ot">&lt;-</span> diversidad_transacciones[, .(</span>
<span id="cb14-486"><a href="#cb14-486" aria-hidden="true" tabindex="-1"></a>  <span class="at">clientes =</span> .N,</span>
<span id="cb14-487"><a href="#cb14-487" aria-hidden="true" tabindex="-1"></a>  <span class="at">transacciones_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(transacciones_totales), <span class="dv">1</span>),</span>
<span id="cb14-488"><a href="#cb14-488" aria-hidden="true" tabindex="-1"></a>  <span class="at">diversidad_categoria_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(indice_diversidad_categoria), <span class="dv">1</span>),</span>
<span id="cb14-489"><a href="#cb14-489" aria-hidden="true" tabindex="-1"></a>  <span class="at">score_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(score_engagement), <span class="dv">0</span>)</span>
<span id="cb14-490"><a href="#cb14-490" aria-hidden="true" tabindex="-1"></a>), by <span class="ot">=</span> categoria_engagement][<span class="fu">order</span>(<span class="sc">-</span>score_promedio)]</span>
<span id="cb14-491"><a href="#cb14-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-492"><a href="#cb14-492" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Análisis de engagement de clientes:"</span>)</span>
<span id="cb14-493"><a href="#cb14-493" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(resumen_engagement)</span>
<span id="cb14-494"><a href="#cb14-494" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-495"><a href="#cb14-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-496"><a href="#cb14-496" aria-hidden="true" tabindex="-1"></a><span class="fu">## Análisis Temporal Avanzado</span></span>
<span id="cb14-497"><a href="#cb14-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-498"><a href="#cb14-498" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1. **Detección de Anomalías Temporales**</span></span>
<span id="cb14-499"><a href="#cb14-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-502"><a href="#cb14-502" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-503"><a href="#cb14-503" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: anomalias-temporales</span></span>
<span id="cb14-504"><a href="#cb14-504" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb14-505"><a href="#cb14-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-506"><a href="#cb14-506" aria-hidden="true" tabindex="-1"></a><span class="co"># Sistema de detección de anomalías para sensores</span></span>
<span id="cb14-507"><a href="#cb14-507" aria-hidden="true" tabindex="-1"></a>anomalias_sensores <span class="ot">&lt;-</span> sensores_temperatura[<span class="fu">order</span>(sensor_id, timestamp)][, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-508"><a href="#cb14-508" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Medias móviles para diferentes ventanas</span></span>
<span id="cb14-509"><a href="#cb14-509" aria-hidden="true" tabindex="-1"></a>  <span class="at">temp_ma_short =</span> <span class="fu">frollmean</span>(temperatura, <span class="dv">4</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),    <span class="co"># 1 hora</span></span>
<span id="cb14-510"><a href="#cb14-510" aria-hidden="true" tabindex="-1"></a>  <span class="at">temp_ma_long =</span> <span class="fu">frollmean</span>(temperatura, <span class="dv">24</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),    <span class="co"># 6 horas</span></span>
<span id="cb14-511"><a href="#cb14-511" aria-hidden="true" tabindex="-1"></a>  <span class="at">temp_sd_window =</span> <span class="fu">frollapply</span>(temperatura, <span class="dv">12</span>, sd, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="co"># Desviación móvil</span></span>
<span id="cb14-512"><a href="#cb14-512" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-513"><a href="#cb14-513" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Cambios absolutos</span></span>
<span id="cb14-514"><a href="#cb14-514" aria-hidden="true" tabindex="-1"></a>  <span class="at">cambio_temp =</span> <span class="fu">abs</span>(temperatura <span class="sc">-</span> <span class="fu">shift</span>(temperatura, <span class="dv">1</span>)),</span>
<span id="cb14-515"><a href="#cb14-515" aria-hidden="true" tabindex="-1"></a>  <span class="at">cambio_temp_2 =</span> <span class="fu">abs</span>(temperatura <span class="sc">-</span> <span class="fu">shift</span>(temperatura, <span class="dv">2</span>))</span>
<span id="cb14-516"><a href="#cb14-516" aria-hidden="true" tabindex="-1"></a>), by <span class="ot">=</span> sensor_id][, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-517"><a href="#cb14-517" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Detección de anomalías</span></span>
<span id="cb14-518"><a href="#cb14-518" aria-hidden="true" tabindex="-1"></a>  <span class="at">anomalia_spike =</span> cambio_temp <span class="sc">&gt;</span> <span class="dv">3</span>,  <span class="co"># Cambio súbito &gt; 3 grados</span></span>
<span id="cb14-519"><a href="#cb14-519" aria-hidden="true" tabindex="-1"></a>  <span class="at">anomalia_drift =</span> <span class="sc">!</span><span class="fu">is.na</span>(temp_ma_long) <span class="sc">&amp;</span> <span class="fu">abs</span>(temperatura <span class="sc">-</span> temp_ma_long) <span class="sc">&gt;</span> <span class="dv">5</span>, <span class="co"># Desviación &gt; 5 grados de media larga</span></span>
<span id="cb14-520"><a href="#cb14-520" aria-hidden="true" tabindex="-1"></a>  <span class="at">anomalia_variabilidad =</span> <span class="sc">!</span><span class="fu">is.na</span>(temp_sd_window) <span class="sc">&amp;</span> temp_sd_window <span class="sc">&gt;</span> <span class="dv">2</span> <span class="co"># Alta variabilidad</span></span>
<span id="cb14-521"><a href="#cb14-521" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-522"><a href="#cb14-522" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb14-523"><a href="#cb14-523" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb14-524"><a href="#cb14-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-525"><a href="#cb14-525" aria-hidden="true" tabindex="-1"></a><span class="co"># Score compuesto de anomalía</span></span>
<span id="cb14-526"><a href="#cb14-526" aria-hidden="true" tabindex="-1"></a>anomalias_sensores[, score_anomalia <span class="sc">:</span><span class="er">=</span> (<span class="fu">as.numeric</span>(anomalia_spike) <span class="sc">*</span> <span class="dv">3</span>) <span class="sc">+</span> </span>
<span id="cb14-527"><a href="#cb14-527" aria-hidden="true" tabindex="-1"></a>                  (<span class="fu">as.numeric</span>(anomalia_drift) <span class="sc">*</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb14-528"><a href="#cb14-528" aria-hidden="true" tabindex="-1"></a>                  (<span class="fu">as.numeric</span>(anomalia_variabilidad) <span class="sc">*</span> <span class="dv">1</span>)]</span>
<span id="cb14-529"><a href="#cb14-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-530"><a href="#cb14-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-531"><a href="#cb14-531" aria-hidden="true" tabindex="-1"></a><span class="co"># Resumen de anomalías por sensor</span></span>
<span id="cb14-532"><a href="#cb14-532" aria-hidden="true" tabindex="-1"></a>resumen_anomalias <span class="ot">&lt;-</span> anomalias_sensores[<span class="sc">!</span><span class="fu">is.na</span>(temperatura), .(</span>
<span id="cb14-533"><a href="#cb14-533" aria-hidden="true" tabindex="-1"></a>  <span class="at">lecturas_totales =</span> .N,</span>
<span id="cb14-534"><a href="#cb14-534" aria-hidden="true" tabindex="-1"></a>  <span class="at">anomalias_spike =</span> <span class="fu">sum</span>(anomalia_spike, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-535"><a href="#cb14-535" aria-hidden="true" tabindex="-1"></a>  <span class="at">anomalias_drift =</span> <span class="fu">sum</span>(anomalia_drift, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-536"><a href="#cb14-536" aria-hidden="true" tabindex="-1"></a>  <span class="at">anomalias_variabilidad =</span> <span class="fu">sum</span>(anomalia_variabilidad, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-537"><a href="#cb14-537" aria-hidden="true" tabindex="-1"></a>  <span class="at">score_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(score_anomalia, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">2</span>),</span>
<span id="cb14-538"><a href="#cb14-538" aria-hidden="true" tabindex="-1"></a>  <span class="at">temp_min =</span> <span class="fu">round</span>(<span class="fu">min</span>(temperatura, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">1</span>),</span>
<span id="cb14-539"><a href="#cb14-539" aria-hidden="true" tabindex="-1"></a>  <span class="at">temp_max =</span> <span class="fu">round</span>(<span class="fu">max</span>(temperatura, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">1</span>)</span>
<span id="cb14-540"><a href="#cb14-540" aria-hidden="true" tabindex="-1"></a>), by <span class="ot">=</span> .(sensor_id, ubicacion)]</span>
<span id="cb14-541"><a href="#cb14-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-542"><a href="#cb14-542" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Resumen de anomalías por sensor:"</span>)</span>
<span id="cb14-543"><a href="#cb14-543" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(resumen_anomalias)</span>
<span id="cb14-544"><a href="#cb14-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-545"><a href="#cb14-545" aria-hidden="true" tabindex="-1"></a><span class="co"># Top anomalías individuales</span></span>
<span id="cb14-546"><a href="#cb14-546" aria-hidden="true" tabindex="-1"></a>top_anomalias <span class="ot">&lt;-</span> anomalias_sensores[score_anomalia <span class="sc">&gt;=</span> <span class="dv">2</span>, .(</span>
<span id="cb14-547"><a href="#cb14-547" aria-hidden="true" tabindex="-1"></a>  sensor_id, timestamp, temperatura, temp_ma_long, </span>
<span id="cb14-548"><a href="#cb14-548" aria-hidden="true" tabindex="-1"></a>  cambio_temp, score_anomalia</span>
<span id="cb14-549"><a href="#cb14-549" aria-hidden="true" tabindex="-1"></a>)][<span class="fu">order</span>(<span class="sc">-</span>score_anomalia)]</span>
<span id="cb14-550"><a href="#cb14-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-551"><a href="#cb14-551" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(top_anomalias) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb14-552"><a href="#cb14-552" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Top anomalías detectadas:"</span>)</span>
<span id="cb14-553"><a href="#cb14-553" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">head</span>(top_anomalias, <span class="dv">8</span>))</span>
<span id="cb14-554"><a href="#cb14-554" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb14-555"><a href="#cb14-555" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">No se detectaron anomalías significativas (score &gt;= 2)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-556"><a href="#cb14-556" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-557"><a href="#cb14-557" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-558"><a href="#cb14-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-559"><a href="#cb14-559" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2. **Análisis de Ciclos y Estacionalidad**</span></span>
<span id="cb14-560"><a href="#cb14-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-563"><a href="#cb14-563" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-564"><a href="#cb14-564" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ciclos-estacionalidad</span></span>
<span id="cb14-565"><a href="#cb14-565" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb14-566"><a href="#cb14-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-567"><a href="#cb14-567" aria-hidden="true" tabindex="-1"></a><span class="co"># Análisis de patrones cíclicos en datos de sensores</span></span>
<span id="cb14-568"><a href="#cb14-568" aria-hidden="true" tabindex="-1"></a>patrones_ciclicos <span class="ot">&lt;-</span> sensores_temperatura[<span class="sc">!</span><span class="fu">is.na</span>(temperatura)][, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-569"><a href="#cb14-569" aria-hidden="true" tabindex="-1"></a>  <span class="at">hora =</span> <span class="fu">hour</span>(timestamp),</span>
<span id="cb14-570"><a href="#cb14-570" aria-hidden="true" tabindex="-1"></a>  <span class="at">dia =</span> <span class="fu">as.numeric</span>(<span class="fu">as.Date</span>(timestamp) <span class="sc">-</span> <span class="fu">min</span>(<span class="fu">as.Date</span>(timestamp))) <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb14-571"><a href="#cb14-571" aria-hidden="true" tabindex="-1"></a>  <span class="at">minuto_del_dia =</span> <span class="fu">hour</span>(timestamp) <span class="sc">*</span> <span class="dv">60</span> <span class="sc">+</span> <span class="fu">minute</span>(timestamp)</span>
<span id="cb14-572"><a href="#cb14-572" aria-hidden="true" tabindex="-1"></a>)][, .(</span>
<span id="cb14-573"><a href="#cb14-573" aria-hidden="true" tabindex="-1"></a>  <span class="at">temperatura_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(temperatura), <span class="dv">1</span>),</span>
<span id="cb14-574"><a href="#cb14-574" aria-hidden="true" tabindex="-1"></a>  <span class="at">temperatura_sd =</span> <span class="fu">round</span>(<span class="fu">sd</span>(temperatura), <span class="dv">2</span>),</span>
<span id="cb14-575"><a href="#cb14-575" aria-hidden="true" tabindex="-1"></a>  <span class="at">lecturas =</span> .N</span>
<span id="cb14-576"><a href="#cb14-576" aria-hidden="true" tabindex="-1"></a>), by <span class="ot">=</span> .(sensor_id, hora)]</span>
<span id="cb14-577"><a href="#cb14-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-578"><a href="#cb14-578" aria-hidden="true" tabindex="-1"></a><span class="co"># Identificar patrones horarios</span></span>
<span id="cb14-579"><a href="#cb14-579" aria-hidden="true" tabindex="-1"></a>patrones_resumen <span class="ot">&lt;-</span> patrones_ciclicos[, .(</span>
<span id="cb14-580"><a href="#cb14-580" aria-hidden="true" tabindex="-1"></a>  <span class="at">hora_mas_fria =</span> hora[<span class="fu">which.min</span>(temperatura_promedio)],</span>
<span id="cb14-581"><a href="#cb14-581" aria-hidden="true" tabindex="-1"></a>  <span class="at">temp_mas_fria =</span> <span class="fu">min</span>(temperatura_promedio),</span>
<span id="cb14-582"><a href="#cb14-582" aria-hidden="true" tabindex="-1"></a>  <span class="at">hora_mas_calida =</span> hora[<span class="fu">which.max</span>(temperatura_promedio)],</span>
<span id="cb14-583"><a href="#cb14-583" aria-hidden="true" tabindex="-1"></a>  <span class="at">temp_mas_calida =</span> <span class="fu">max</span>(temperatura_promedio),</span>
<span id="cb14-584"><a href="#cb14-584" aria-hidden="true" tabindex="-1"></a>  <span class="at">amplitud_termica =</span> <span class="fu">round</span>(<span class="fu">max</span>(temperatura_promedio) <span class="sc">-</span> <span class="fu">min</span>(temperatura_promedio), <span class="dv">1</span>),</span>
<span id="cb14-585"><a href="#cb14-585" aria-hidden="true" tabindex="-1"></a>  <span class="at">variabilidad_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(temperatura_sd), <span class="dv">2</span>)</span>
<span id="cb14-586"><a href="#cb14-586" aria-hidden="true" tabindex="-1"></a>), by <span class="ot">=</span> sensor_id]</span>
<span id="cb14-587"><a href="#cb14-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-588"><a href="#cb14-588" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Patrones térmicos diarios por sensor:"</span>)</span>
<span id="cb14-589"><a href="#cb14-589" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(patrones_resumen)</span>
<span id="cb14-590"><a href="#cb14-590" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-591"><a href="#cb14-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-592"><a href="#cb14-592" aria-hidden="true" tabindex="-1"></a><span class="fu">## Ejercicios Prácticos</span></span>
<span id="cb14-593"><a href="#cb14-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-594"><a href="#cb14-594" aria-hidden="true" tabindex="-1"></a>::: {.callout-note icon="false"}</span>
<span id="cb14-595"><a href="#cb14-595" aria-hidden="true" tabindex="-1"></a><span class="fu">## 🏋️ Ejercicio 11: Sistema de Alertas de Anomalías</span></span>
<span id="cb14-596"><a href="#cb14-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-597"><a href="#cb14-597" aria-hidden="true" tabindex="-1"></a>Usando los datasets de sensores y transacciones:</span>
<span id="cb14-598"><a href="#cb14-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-599"><a href="#cb14-599" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Implementa** un sistema de detección de anomalías multicapa</span>
<span id="cb14-600"><a href="#cb14-600" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Usa `frollapply()`** para ventanas personalizadas de detección</span>
<span id="cb14-601"><a href="#cb14-601" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Clasifica anomalías** con <span class="in">`fcase()`</span> por severidad</span>
<span id="cb14-602"><a href="#cb14-602" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Genera alertas** automáticas con <span class="in">`rleid()`</span> para secuencias anómalas</span>
<span id="cb14-603"><a href="#cb14-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-604"><a href="#cb14-604" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb14-605"><a href="#cb14-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-606"><a href="#cb14-606" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip collapse="true"}</span>
<span id="cb14-607"><a href="#cb14-607" aria-hidden="true" tabindex="-1"></a><span class="fu">## 💡 Solución del Ejercicio 11</span></span>
<span id="cb14-608"><a href="#cb14-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-611"><a href="#cb14-611" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-612"><a href="#cb14-612" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: solucion-ejercicio-11</span></span>
<span id="cb14-613"><a href="#cb14-613" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb14-614"><a href="#cb14-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-615"><a href="#cb14-615" aria-hidden="true" tabindex="-1"></a><span class="co"># Sistema completo de detección de anomalías multicapa</span></span>
<span id="cb14-616"><a href="#cb14-616" aria-hidden="true" tabindex="-1"></a><span class="co"># CAPA 1: Anomalías estadísticas</span></span>
<span id="cb14-617"><a href="#cb14-617" aria-hidden="true" tabindex="-1"></a>sistema_anomalias <span class="ot">&lt;-</span> sensores_temperatura[<span class="fu">order</span>(sensor_id, timestamp)][, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-618"><a href="#cb14-618" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ventanas de referencia</span></span>
<span id="cb14-619"><a href="#cb14-619" aria-hidden="true" tabindex="-1"></a>  <span class="at">temp_ma_1h =</span> <span class="fu">frollmean</span>(temperatura, <span class="dv">4</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-620"><a href="#cb14-620" aria-hidden="true" tabindex="-1"></a>  <span class="at">temp_ma_6h =</span> <span class="fu">frollmean</span>(temperatura, <span class="dv">24</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), </span>
<span id="cb14-621"><a href="#cb14-621" aria-hidden="true" tabindex="-1"></a>  <span class="at">temp_ma_24h =</span> <span class="fu">frollmean</span>(temperatura, <span class="dv">96</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-622"><a href="#cb14-622" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-623"><a href="#cb14-623" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Medidas de variabilidad</span></span>
<span id="cb14-624"><a href="#cb14-624" aria-hidden="true" tabindex="-1"></a>  <span class="at">temp_sd_1h =</span> <span class="fu">frollapply</span>(temperatura, <span class="dv">4</span>, sd, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-625"><a href="#cb14-625" aria-hidden="true" tabindex="-1"></a>  <span class="at">temp_sd_6h =</span> <span class="fu">frollapply</span>(temperatura, <span class="dv">24</span>, sd, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-626"><a href="#cb14-626" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-627"><a href="#cb14-627" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Percentiles móviles</span></span>
<span id="cb14-628"><a href="#cb14-628" aria-hidden="true" tabindex="-1"></a>  <span class="at">temp_p25_6h =</span> <span class="fu">frollapply</span>(temperatura, <span class="dv">24</span>, <span class="cf">function</span>(x) <span class="fu">quantile</span>(x, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb14-629"><a href="#cb14-629" aria-hidden="true" tabindex="-1"></a>  <span class="at">temp_p75_6h =</span> <span class="fu">frollapply</span>(temperatura, <span class="dv">24</span>, <span class="cf">function</span>(x) <span class="fu">quantile</span>(x, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb14-630"><a href="#cb14-630" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-631"><a href="#cb14-631" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Cambios temporales</span></span>
<span id="cb14-632"><a href="#cb14-632" aria-hidden="true" tabindex="-1"></a>  <span class="at">cambio_15min =</span> <span class="fu">abs</span>(temperatura <span class="sc">-</span> <span class="fu">shift</span>(temperatura, <span class="dv">1</span>)),</span>
<span id="cb14-633"><a href="#cb14-633" aria-hidden="true" tabindex="-1"></a>  <span class="at">cambio_1h =</span> <span class="fu">abs</span>(temperatura <span class="sc">-</span> <span class="fu">shift</span>(temperatura, <span class="dv">4</span>)),</span>
<span id="cb14-634"><a href="#cb14-634" aria-hidden="true" tabindex="-1"></a>  <span class="at">tendencia_1h =</span> <span class="fu">frollapply</span>(temperatura, <span class="dv">4</span>, <span class="cf">function</span>(x) {</span>
<span id="cb14-635"><a href="#cb14-635" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(x) <span class="sc">&lt;</span> <span class="dv">4</span>) <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb14-636"><a href="#cb14-636" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lm</span>(x <span class="sc">~</span> <span class="fu">seq_along</span>(x))<span class="sc">$</span>coefficients[<span class="dv">2</span>]</span>
<span id="cb14-637"><a href="#cb14-637" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb14-638"><a href="#cb14-638" aria-hidden="true" tabindex="-1"></a>), by <span class="ot">=</span> sensor_id][, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-639"><a href="#cb14-639" aria-hidden="true" tabindex="-1"></a>  <span class="co"># CAPA 2: Detección de anomalías específicas</span></span>
<span id="cb14-640"><a href="#cb14-640" aria-hidden="true" tabindex="-1"></a>  <span class="at">anomalia_spike =</span> cambio_15min <span class="sc">&gt;</span> <span class="dv">5</span>,  <span class="co"># Cambio súbito &gt; 5°C</span></span>
<span id="cb14-641"><a href="#cb14-641" aria-hidden="true" tabindex="-1"></a>  <span class="at">anomalia_drift =</span> <span class="sc">!</span><span class="fu">is.na</span>(temp_ma_6h) <span class="sc">&amp;</span> <span class="fu">abs</span>(temperatura <span class="sc">-</span> temp_ma_6h) <span class="sc">&gt;</span> <span class="dv">4</span>, <span class="co"># Drift &gt; 4°C</span></span>
<span id="cb14-642"><a href="#cb14-642" aria-hidden="true" tabindex="-1"></a>  <span class="at">anomalia_variabilidad =</span> <span class="sc">!</span><span class="fu">is.na</span>(temp_sd_1h) <span class="sc">&amp;</span> temp_sd_1h <span class="sc">&gt;</span> <span class="dv">3</span>, <span class="co"># Alta variabilidad</span></span>
<span id="cb14-643"><a href="#cb14-643" aria-hidden="true" tabindex="-1"></a>  <span class="at">anomalia_outlier =</span> <span class="sc">!</span><span class="fu">is.na</span>(temp_p25_6h) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(temp_p75_6h) <span class="sc">&amp;</span> </span>
<span id="cb14-644"><a href="#cb14-644" aria-hidden="true" tabindex="-1"></a>                    (temperatura <span class="sc">&lt;</span> (temp_p25_6h <span class="sc">-</span> <span class="fl">1.5</span><span class="sc">*</span>(temp_p75_6h <span class="sc">-</span> temp_p25_6h)) <span class="sc">|</span></span>
<span id="cb14-645"><a href="#cb14-645" aria-hidden="true" tabindex="-1"></a>                     temperatura <span class="sc">&gt;</span> (temp_p75_6h <span class="sc">+</span> <span class="fl">1.5</span><span class="sc">*</span>(temp_p75_6h <span class="sc">-</span> temp_p25_6h))),</span>
<span id="cb14-646"><a href="#cb14-646" aria-hidden="true" tabindex="-1"></a>  <span class="at">anomalia_tendencia =</span> <span class="sc">!</span><span class="fu">is.na</span>(tendencia_1h) <span class="sc">&amp;</span> <span class="fu">abs</span>(tendencia_1h) <span class="sc">&gt;</span> <span class="dv">1</span>, <span class="co"># Tendencia &gt; 1°C/15min</span></span>
<span id="cb14-647"><a href="#cb14-647" aria-hidden="true" tabindex="-1"></a>  <span class="at">anomalia_frozen =</span> <span class="sc">!</span><span class="fu">is.na</span>(temp_sd_1h) <span class="sc">&amp;</span> temp_sd_1h <span class="sc">&lt;</span> <span class="fl">0.1</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(temperatura)  <span class="co"># Sensor "congelado"</span></span>
<span id="cb14-648"><a href="#cb14-648" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb14-649"><a href="#cb14-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-650"><a href="#cb14-650" aria-hidden="true" tabindex="-1"></a><span class="co"># CAPA 3: Clasificación por severidad con fcase()</span></span>
<span id="cb14-651"><a href="#cb14-651" aria-hidden="true" tabindex="-1"></a>sistema_anomalias[, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-652"><a href="#cb14-652" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Score compuesto</span></span>
<span id="cb14-653"><a href="#cb14-653" aria-hidden="true" tabindex="-1"></a>  <span class="at">score_anomalia =</span> (<span class="fu">as.numeric</span>(anomalia_spike) <span class="sc">*</span> <span class="dv">5</span>) <span class="sc">+</span> </span>
<span id="cb14-654"><a href="#cb14-654" aria-hidden="true" tabindex="-1"></a>                  (<span class="fu">as.numeric</span>(anomalia_drift) <span class="sc">*</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb14-655"><a href="#cb14-655" aria-hidden="true" tabindex="-1"></a>                  (<span class="fu">as.numeric</span>(anomalia_variabilidad) <span class="sc">*</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb14-656"><a href="#cb14-656" aria-hidden="true" tabindex="-1"></a>                  (<span class="fu">as.numeric</span>(anomalia_outlier) <span class="sc">*</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb14-657"><a href="#cb14-657" aria-hidden="true" tabindex="-1"></a>                  (<span class="fu">as.numeric</span>(anomalia_tendencia) <span class="sc">*</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb14-658"><a href="#cb14-658" aria-hidden="true" tabindex="-1"></a>                  (<span class="fu">as.numeric</span>(anomalia_frozen) <span class="sc">*</span> <span class="dv">6</span>)</span>
<span id="cb14-659"><a href="#cb14-659" aria-hidden="true" tabindex="-1"></a>)][, severidad <span class="sc">:</span><span class="er">=</span> <span class="fu">fcase</span>(</span>
<span id="cb14-660"><a href="#cb14-660" aria-hidden="true" tabindex="-1"></a>  score_anomalia <span class="sc">&gt;=</span> <span class="dv">10</span>, <span class="st">"CRÍTICA"</span>,</span>
<span id="cb14-661"><a href="#cb14-661" aria-hidden="true" tabindex="-1"></a>  score_anomalia <span class="sc">&gt;=</span> <span class="dv">6</span>, <span class="st">"ALTA"</span>, </span>
<span id="cb14-662"><a href="#cb14-662" aria-hidden="true" tabindex="-1"></a>  score_anomalia <span class="sc">&gt;=</span> <span class="dv">3</span>, <span class="st">"MEDIA"</span>,</span>
<span id="cb14-663"><a href="#cb14-663" aria-hidden="true" tabindex="-1"></a>  score_anomalia <span class="sc">&gt;=</span> <span class="dv">1</span>, <span class="st">"BAJA"</span>,</span>
<span id="cb14-664"><a href="#cb14-664" aria-hidden="true" tabindex="-1"></a>  <span class="at">default =</span> <span class="st">"NORMAL"</span></span>
<span id="cb14-665"><a href="#cb14-665" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb14-666"><a href="#cb14-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-667"><a href="#cb14-667" aria-hidden="true" tabindex="-1"></a><span class="co"># CAPA 4: Detección de secuencias anómalas con rleid()</span></span>
<span id="cb14-668"><a href="#cb14-668" aria-hidden="true" tabindex="-1"></a>sistema_anomalias[, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-669"><a href="#cb14-669" aria-hidden="true" tabindex="-1"></a>  <span class="at">es_anomalo =</span> severidad <span class="sc">!=</span> <span class="st">"NORMAL"</span>,</span>
<span id="cb14-670"><a href="#cb14-670" aria-hidden="true" tabindex="-1"></a>  <span class="at">secuencia_id =</span> <span class="fu">rleid</span>(severidad <span class="sc">!=</span> <span class="st">"NORMAL"</span>)</span>
<span id="cb14-671"><a href="#cb14-671" aria-hidden="true" tabindex="-1"></a>), by <span class="ot">=</span> sensor_id]</span>
<span id="cb14-672"><a href="#cb14-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-673"><a href="#cb14-673" aria-hidden="true" tabindex="-1"></a><span class="co"># Análisis de secuencias anómalas</span></span>
<span id="cb14-674"><a href="#cb14-674" aria-hidden="true" tabindex="-1"></a>secuencias_anomalas <span class="ot">&lt;-</span> sistema_anomalias[es_anomalo <span class="sc">==</span> <span class="cn">TRUE</span>, .(</span>
<span id="cb14-675"><a href="#cb14-675" aria-hidden="true" tabindex="-1"></a>  <span class="at">duracion_minutos =</span> .N <span class="sc">*</span> <span class="dv">15</span>,  <span class="co"># 15 min por medición</span></span>
<span id="cb14-676"><a href="#cb14-676" aria-hidden="true" tabindex="-1"></a>  <span class="at">severidad_maxima =</span> severidad[<span class="fu">which.max</span>(score_anomalia)],</span>
<span id="cb14-677"><a href="#cb14-677" aria-hidden="true" tabindex="-1"></a>  <span class="at">score_maximo =</span> <span class="fu">max</span>(score_anomalia),</span>
<span id="cb14-678"><a href="#cb14-678" aria-hidden="true" tabindex="-1"></a>  <span class="at">score_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(score_anomalia), <span class="dv">1</span>),</span>
<span id="cb14-679"><a href="#cb14-679" aria-hidden="true" tabindex="-1"></a>  <span class="at">temp_min =</span> <span class="fu">round</span>(<span class="fu">min</span>(temperatura, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">1</span>),</span>
<span id="cb14-680"><a href="#cb14-680" aria-hidden="true" tabindex="-1"></a>  <span class="at">temp_max =</span> <span class="fu">round</span>(<span class="fu">max</span>(temperatura, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">1</span>),</span>
<span id="cb14-681"><a href="#cb14-681" aria-hidden="true" tabindex="-1"></a>  <span class="at">inicio =</span> <span class="fu">min</span>(timestamp),</span>
<span id="cb14-682"><a href="#cb14-682" aria-hidden="true" tabindex="-1"></a>  <span class="at">fin =</span> <span class="fu">max</span>(timestamp),</span>
<span id="cb14-683"><a href="#cb14-683" aria-hidden="true" tabindex="-1"></a>  <span class="at">tipos_anomalia =</span> <span class="fu">paste</span>(<span class="fu">unique</span>(<span class="fu">c</span>(</span>
<span id="cb14-684"><a href="#cb14-684" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">any</span>(anomalia_spike)) <span class="st">"SPIKE"</span>,</span>
<span id="cb14-685"><a href="#cb14-685" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">any</span>(anomalia_drift)) <span class="st">"DRIFT"</span>, </span>
<span id="cb14-686"><a href="#cb14-686" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">any</span>(anomalia_variabilidad)) <span class="st">"VARIABILIDAD"</span>,</span>
<span id="cb14-687"><a href="#cb14-687" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">any</span>(anomalia_outlier)) <span class="st">"OUTLIER"</span>,</span>
<span id="cb14-688"><a href="#cb14-688" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">any</span>(anomalia_tendencia)) <span class="st">"TENDENCIA"</span>,</span>
<span id="cb14-689"><a href="#cb14-689" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">any</span>(anomalia_frozen)) <span class="st">"FROZEN"</span></span>
<span id="cb14-690"><a href="#cb14-690" aria-hidden="true" tabindex="-1"></a>  )), <span class="at">collapse =</span> <span class="st">", "</span>)</span>
<span id="cb14-691"><a href="#cb14-691" aria-hidden="true" tabindex="-1"></a>), by <span class="ot">=</span> .(sensor_id, secuencia_id)][</span>
<span id="cb14-692"><a href="#cb14-692" aria-hidden="true" tabindex="-1"></a>  duracion_minutos <span class="sc">&gt;=</span> <span class="dv">30</span>  <span class="co"># Solo secuencias de al menos 30 minutos</span></span>
<span id="cb14-693"><a href="#cb14-693" aria-hidden="true" tabindex="-1"></a>][<span class="fu">order</span>(<span class="sc">-</span>score_maximo)]</span>
<span id="cb14-694"><a href="#cb14-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-695"><a href="#cb14-695" aria-hidden="true" tabindex="-1"></a><span class="co"># SISTEMA DE ALERTAS AUTOMÁTICAS</span></span>
<span id="cb14-696"><a href="#cb14-696" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"🚨 SISTEMA DE ALERTAS DE ANOMALÍAS 🚨</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb14-697"><a href="#cb14-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-698"><a href="#cb14-698" aria-hidden="true" tabindex="-1"></a><span class="co"># Alertas activas por sensor</span></span>
<span id="cb14-699"><a href="#cb14-699" aria-hidden="true" tabindex="-1"></a>alertas_activas <span class="ot">&lt;-</span> sistema_anomalias[es_anomalo <span class="sc">==</span> <span class="cn">TRUE</span>, .N, by <span class="ot">=</span> .(sensor_id, severidad)][<span class="fu">order</span>(sensor_id, severidad)]</span>
<span id="cb14-700"><a href="#cb14-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-701"><a href="#cb14-701" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(alertas_activas) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb14-702"><a href="#cb14-702" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"ALERTAS ACTIVAS POR SENSOR:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-703"><a href="#cb14-703" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(alertas_activas)</span>
<span id="cb14-704"><a href="#cb14-704" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb14-705"><a href="#cb14-705" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"✅ No hay alertas activas en este momento.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-706"><a href="#cb14-706" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-707"><a href="#cb14-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-708"><a href="#cb14-708" aria-hidden="true" tabindex="-1"></a><span class="co"># Top secuencias críticas</span></span>
<span id="cb14-709"><a href="#cb14-709" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(secuencias_anomalas) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb14-710"><a href="#cb14-710" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">🔥 TOP SECUENCIAS ANÓMALAS:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-711"><a href="#cb14-711" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">head</span>(secuencias_anomalas[, .(sensor_id, severidad_maxima, duracion_minutos, </span>
<span id="cb14-712"><a href="#cb14-712" aria-hidden="true" tabindex="-1"></a>                                    score_maximo, tipos_anomalia, inicio)], <span class="dv">8</span>))</span>
<span id="cb14-713"><a href="#cb14-713" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb14-714"><a href="#cb14-714" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">✅ No se detectaron secuencias anómalas significativas.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-715"><a href="#cb14-715" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-716"><a href="#cb14-716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-717"><a href="#cb14-717" aria-hidden="true" tabindex="-1"></a><span class="co"># Resumen estadístico</span></span>
<span id="cb14-718"><a href="#cb14-718" aria-hidden="true" tabindex="-1"></a>resumen_sistema <span class="ot">&lt;-</span> sistema_anomalias[<span class="sc">!</span><span class="fu">is.na</span>(temperatura), .(</span>
<span id="cb14-719"><a href="#cb14-719" aria-hidden="true" tabindex="-1"></a>  <span class="at">lecturas_totales =</span> .N,</span>
<span id="cb14-720"><a href="#cb14-720" aria-hidden="true" tabindex="-1"></a>  <span class="at">anomalias_detectadas =</span> <span class="fu">sum</span>(es_anomalo),</span>
<span id="cb14-721"><a href="#cb14-721" aria-hidden="true" tabindex="-1"></a>  <span class="at">pct_anomalias =</span> <span class="fu">round</span>(<span class="fu">mean</span>(es_anomalo) <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">2</span>),</span>
<span id="cb14-722"><a href="#cb14-722" aria-hidden="true" tabindex="-1"></a>  <span class="at">score_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(score_anomalia), <span class="dv">2</span>)</span>
<span id="cb14-723"><a href="#cb14-723" aria-hidden="true" tabindex="-1"></a>), by <span class="ot">=</span> sensor_id]</span>
<span id="cb14-724"><a href="#cb14-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-725"><a href="#cb14-725" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">📊 RESUMEN DEL SISTEMA:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-726"><a href="#cb14-726" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(resumen_sistema)</span>
<span id="cb14-727"><a href="#cb14-727" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-728"><a href="#cb14-728" aria-hidden="true" tabindex="-1"></a><span class="co"># # Crear tabla interactiva de secuencias críticas (comentado para PDF)</span></span>
<span id="cb14-729"><a href="#cb14-729" aria-hidden="true" tabindex="-1"></a><span class="co"># if(nrow(secuencias_anomalas) &gt; 0) {</span></span>
<span id="cb14-730"><a href="#cb14-730" aria-hidden="true" tabindex="-1"></a><span class="co">#   DT::datatable(</span></span>
<span id="cb14-731"><a href="#cb14-731" aria-hidden="true" tabindex="-1"></a><span class="co">#     secuencias_anomalas[1:min(20, nrow(secuencias_anomalas))],</span></span>
<span id="cb14-732"><a href="#cb14-732" aria-hidden="true" tabindex="-1"></a><span class="co">#     caption = "Secuencias Anómalas Detectadas - Sistema Multicapa",</span></span>
<span id="cb14-733"><a href="#cb14-733" aria-hidden="true" tabindex="-1"></a><span class="co">#     options = list(pageLength = 10, scrollX = TRUE)</span></span>
<span id="cb14-734"><a href="#cb14-734" aria-hidden="true" tabindex="-1"></a><span class="co">#   ) %&gt;%</span></span>
<span id="cb14-735"><a href="#cb14-735" aria-hidden="true" tabindex="-1"></a><span class="co">#     DT::formatStyle(</span></span>
<span id="cb14-736"><a href="#cb14-736" aria-hidden="true" tabindex="-1"></a><span class="co">#       "severidad_maxima",</span></span>
<span id="cb14-737"><a href="#cb14-737" aria-hidden="true" tabindex="-1"></a><span class="co">#       backgroundColor = DT::styleEqual(</span></span>
<span id="cb14-738"><a href="#cb14-738" aria-hidden="true" tabindex="-1"></a><span class="co">#         c("CRÍTICA", "ALTA", "MEDIA", "BAJA"),</span></span>
<span id="cb14-739"><a href="#cb14-739" aria-hidden="true" tabindex="-1"></a><span class="co">#         c("red", "orange", "yellow", "lightblue")</span></span>
<span id="cb14-740"><a href="#cb14-740" aria-hidden="true" tabindex="-1"></a><span class="co">#       )</span></span>
<span id="cb14-741"><a href="#cb14-741" aria-hidden="true" tabindex="-1"></a><span class="co">#     )</span></span>
<span id="cb14-742"><a href="#cb14-742" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb14-743"><a href="#cb14-743" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-744"><a href="#cb14-744" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb14-745"><a href="#cb14-745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-746"><a href="#cb14-746" aria-hidden="true" tabindex="-1"></a>::: {.callout-note icon="false"}</span>
<span id="cb14-747"><a href="#cb14-747" aria-hidden="true" tabindex="-1"></a><span class="fu">## 🏋️ Ejercicio 12: Análisis de Supervivencia de Clientes</span></span>
<span id="cb14-748"><a href="#cb14-748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-749"><a href="#cb14-749" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Calcula métricas temporales** con <span class="in">`shift()`</span> y funciones de ventana</span>
<span id="cb14-750"><a href="#cb14-750" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Identifica patrones de churn** usando <span class="in">`rleid()`</span> para secuencias de inactividad</span>
<span id="cb14-751"><a href="#cb14-751" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Clasifica riesgo de abandono** con <span class="in">`fcase()`</span> múltiples criterios</span>
<span id="cb14-752"><a href="#cb14-752" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Genera score predictivo** combinando múltiples señales</span>
<span id="cb14-753"><a href="#cb14-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-754"><a href="#cb14-754" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb14-755"><a href="#cb14-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-756"><a href="#cb14-756" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip collapse="true"}</span>
<span id="cb14-757"><a href="#cb14-757" aria-hidden="true" tabindex="-1"></a><span class="fu">## 💡 Solución del Ejercicio 12</span></span>
<span id="cb14-758"><a href="#cb14-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-761"><a href="#cb14-761" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-762"><a href="#cb14-762" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: solucion-ejercicio-12</span></span>
<span id="cb14-763"><a href="#cb14-763" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb14-764"><a href="#cb14-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-765"><a href="#cb14-765" aria-hidden="true" tabindex="-1"></a><span class="co"># Análisis de supervivencia y predicción de churn</span></span>
<span id="cb14-766"><a href="#cb14-766" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Preparar datos temporales con métricas de ventana</span></span>
<span id="cb14-767"><a href="#cb14-767" aria-hidden="true" tabindex="-1"></a>analisis_supervivencia <span class="ot">&lt;-</span> clientes_retencion[, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-768"><a href="#cb14-768" aria-hidden="true" tabindex="-1"></a>  <span class="at">dias_desde_registro =</span> <span class="fu">as.numeric</span>(<span class="fu">as.Date</span>(<span class="st">"2024-06-30"</span>) <span class="sc">-</span> fecha_registro),</span>
<span id="cb14-769"><a href="#cb14-769" aria-hidden="true" tabindex="-1"></a>  <span class="at">dias_desde_ultima_actividad =</span> <span class="fu">fifelse</span>(</span>
<span id="cb14-770"><a href="#cb14-770" aria-hidden="true" tabindex="-1"></a>    <span class="fu">is.na</span>(fecha_ultima_actividad), </span>
<span id="cb14-771"><a href="#cb14-771" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.numeric</span>(<span class="fu">as.Date</span>(<span class="st">"2024-06-30"</span>) <span class="sc">-</span> fecha_registro),</span>
<span id="cb14-772"><a href="#cb14-772" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.numeric</span>(<span class="fu">as.Date</span>(<span class="st">"2024-06-30"</span>) <span class="sc">-</span> fecha_ultima_actividad)</span>
<span id="cb14-773"><a href="#cb14-773" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-774"><a href="#cb14-774" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb14-775"><a href="#cb14-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-776"><a href="#cb14-776" aria-hidden="true" tabindex="-1"></a><span class="co"># Combinar con datos transaccionales para análisis de comportamiento</span></span>
<span id="cb14-777"><a href="#cb14-777" aria-hidden="true" tabindex="-1"></a>comportamiento_clientes <span class="ot">&lt;-</span> transacciones_comportamiento[, .(</span>
<span id="cb14-778"><a href="#cb14-778" aria-hidden="true" tabindex="-1"></a>  <span class="at">transacciones_totales =</span> .N,</span>
<span id="cb14-779"><a href="#cb14-779" aria-hidden="true" tabindex="-1"></a>  <span class="at">gasto_total =</span> <span class="fu">sum</span>(monto),</span>
<span id="cb14-780"><a href="#cb14-780" aria-hidden="true" tabindex="-1"></a>  <span class="at">gasto_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(monto), <span class="dv">2</span>),</span>
<span id="cb14-781"><a href="#cb14-781" aria-hidden="true" tabindex="-1"></a>  <span class="at">dias_activos =</span> <span class="fu">uniqueN</span>(<span class="fu">as.Date</span>(fecha_transaccion)),</span>
<span id="cb14-782"><a href="#cb14-782" aria-hidden="true" tabindex="-1"></a>  <span class="at">categorias_usadas =</span> <span class="fu">uniqueN</span>(categoria),</span>
<span id="cb14-783"><a href="#cb14-783" aria-hidden="true" tabindex="-1"></a>  <span class="at">ultima_transaccion =</span> <span class="fu">max</span>(<span class="fu">as.Date</span>(fecha_transaccion)),</span>
<span id="cb14-784"><a href="#cb14-784" aria-hidden="true" tabindex="-1"></a>  <span class="at">primera_transaccion =</span> <span class="fu">min</span>(<span class="fu">as.Date</span>(fecha_transaccion))</span>
<span id="cb14-785"><a href="#cb14-785" aria-hidden="true" tabindex="-1"></a>), by <span class="ot">=</span> cliente_id]</span>
<span id="cb14-786"><a href="#cb14-786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-787"><a href="#cb14-787" aria-hidden="true" tabindex="-1"></a><span class="co"># Join con datos de clientes</span></span>
<span id="cb14-788"><a href="#cb14-788" aria-hidden="true" tabindex="-1"></a>supervivencia_completa <span class="ot">&lt;-</span> analisis_supervivencia[</span>
<span id="cb14-789"><a href="#cb14-789" aria-hidden="true" tabindex="-1"></a>  comportamiento_clientes, on <span class="ot">=</span> .(cliente_id), nomatch <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb14-790"><a href="#cb14-790" aria-hidden="true" tabindex="-1"></a>][, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-791"><a href="#cb14-791" aria-hidden="true" tabindex="-1"></a>  <span class="at">dias_desde_primera_trans =</span> <span class="fu">as.numeric</span>(<span class="fu">as.Date</span>(<span class="st">"2024-06-30"</span>) <span class="sc">-</span> primera_transaccion),</span>
<span id="cb14-792"><a href="#cb14-792" aria-hidden="true" tabindex="-1"></a>  <span class="at">dias_desde_ultima_trans =</span> <span class="fu">as.numeric</span>(<span class="fu">as.Date</span>(<span class="st">"2024-06-30"</span>) <span class="sc">-</span> ultima_transaccion),</span>
<span id="cb14-793"><a href="#cb14-793" aria-hidden="true" tabindex="-1"></a>  <span class="at">frecuencia_transaccional =</span> <span class="fu">round</span>(transacciones_totales <span class="sc">/</span> dias_activos, <span class="dv">2</span>)</span>
<span id="cb14-794"><a href="#cb14-794" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb14-795"><a href="#cb14-795" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-796"><a href="#cb14-796" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Identificar patrones de declive con funciones de ventana</span></span>
<span id="cb14-797"><a href="#cb14-797" aria-hidden="true" tabindex="-1"></a><span class="co"># Simular datos de actividad mensual para análisis temporal</span></span>
<span id="cb14-798"><a href="#cb14-798" aria-hidden="true" tabindex="-1"></a>actividad_mensual <span class="ot">&lt;-</span> supervivencia_completa[, .(</span>
<span id="cb14-799"><a href="#cb14-799" aria-hidden="true" tabindex="-1"></a>  cliente_id, activo, ingresos_mensuales, gasto_total, transacciones_totales</span>
<span id="cb14-800"><a href="#cb14-800" aria-hidden="true" tabindex="-1"></a>)][, .(</span>
<span id="cb14-801"><a href="#cb14-801" aria-hidden="true" tabindex="-1"></a>  cliente_id, </span>
<span id="cb14-802"><a href="#cb14-802" aria-hidden="true" tabindex="-1"></a>  <span class="at">mes =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>, .N),</span>
<span id="cb14-803"><a href="#cb14-803" aria-hidden="true" tabindex="-1"></a>  <span class="at">actividad_simulada =</span> <span class="fu">as.numeric</span>(activo) <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="fu">abs</span>(<span class="fu">rnorm</span>(.N <span class="sc">*</span> <span class="dv">6</span>, <span class="dv">0</span>, <span class="fl">0.3</span>))),</span>
<span id="cb14-804"><a href="#cb14-804" aria-hidden="true" tabindex="-1"></a>  <span class="at">gasto_simulado =</span> <span class="fu">rep</span>(gasto_total <span class="sc">/</span> <span class="dv">6</span>, <span class="dv">6</span>) <span class="sc">*</span> <span class="fu">exp</span>(<span class="fu">rnorm</span>(.N <span class="sc">*</span> <span class="dv">6</span>, <span class="dv">0</span>, <span class="fl">0.4</span>))</span>
<span id="cb14-805"><a href="#cb14-805" aria-hidden="true" tabindex="-1"></a>), by <span class="ot">=</span> cliente_id][<span class="fu">order</span>(cliente_id, mes)]</span>
<span id="cb14-806"><a href="#cb14-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-807"><a href="#cb14-807" aria-hidden="true" tabindex="-1"></a><span class="co"># Aplicar funciones de ventana para detectar tendencias</span></span>
<span id="cb14-808"><a href="#cb14-808" aria-hidden="true" tabindex="-1"></a>actividad_tendencias <span class="ot">&lt;-</span> actividad_mensual[, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-809"><a href="#cb14-809" aria-hidden="true" tabindex="-1"></a>  <span class="at">actividad_ma3 =</span> <span class="fu">frollmean</span>(actividad_simulada, <span class="dv">3</span>),</span>
<span id="cb14-810"><a href="#cb14-810" aria-hidden="true" tabindex="-1"></a>  <span class="at">gasto_ma3 =</span> <span class="fu">frollmean</span>(gasto_simulado, <span class="dv">3</span>),</span>
<span id="cb14-811"><a href="#cb14-811" aria-hidden="true" tabindex="-1"></a>  <span class="at">actividad_anterior =</span> <span class="fu">shift</span>(actividad_simulada, <span class="dv">1</span>),</span>
<span id="cb14-812"><a href="#cb14-812" aria-hidden="true" tabindex="-1"></a>  <span class="at">gasto_anterior =</span> <span class="fu">shift</span>(gasto_simulado, <span class="dv">1</span>),</span>
<span id="cb14-813"><a href="#cb14-813" aria-hidden="true" tabindex="-1"></a>  <span class="at">tendencia_actividad =</span> actividad_simulada <span class="sc">-</span> <span class="fu">shift</span>(actividad_simulada, <span class="dv">1</span>),</span>
<span id="cb14-814"><a href="#cb14-814" aria-hidden="true" tabindex="-1"></a>  <span class="at">secuencia_declive =</span> <span class="fu">rleid</span>(actividad_simulada <span class="sc">&lt;</span> <span class="fu">shift</span>(actividad_simulada, <span class="dv">1</span>))</span>
<span id="cb14-815"><a href="#cb14-815" aria-hidden="true" tabindex="-1"></a>), by <span class="ot">=</span> cliente_id]</span>
<span id="cb14-816"><a href="#cb14-816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-817"><a href="#cb14-817" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Análisis de riesgo de churn con múltiples criterios</span></span>
<span id="cb14-818"><a href="#cb14-818" aria-hidden="true" tabindex="-1"></a>modelo_churn <span class="ot">&lt;-</span> supervivencia_completa[, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-819"><a href="#cb14-819" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Señales de riesgo temporal</span></span>
<span id="cb14-820"><a href="#cb14-820" aria-hidden="true" tabindex="-1"></a>  <span class="at">riesgo_inactividad =</span> <span class="fu">fcase</span>(</span>
<span id="cb14-821"><a href="#cb14-821" aria-hidden="true" tabindex="-1"></a>    dias_desde_ultima_trans <span class="sc">&gt;</span> <span class="dv">90</span>, <span class="st">"ALTO"</span>,</span>
<span id="cb14-822"><a href="#cb14-822" aria-hidden="true" tabindex="-1"></a>    dias_desde_ultima_trans <span class="sc">&gt;</span> <span class="dv">60</span>, <span class="st">"MEDIO"</span>,</span>
<span id="cb14-823"><a href="#cb14-823" aria-hidden="true" tabindex="-1"></a>    dias_desde_ultima_trans <span class="sc">&gt;</span> <span class="dv">30</span>, <span class="st">"BAJO"</span>,</span>
<span id="cb14-824"><a href="#cb14-824" aria-hidden="true" tabindex="-1"></a>    <span class="at">default =</span> <span class="st">"MÍNIMO"</span></span>
<span id="cb14-825"><a href="#cb14-825" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb14-826"><a href="#cb14-826" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-827"><a href="#cb14-827" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Señales de comportamiento</span></span>
<span id="cb14-828"><a href="#cb14-828" aria-hidden="true" tabindex="-1"></a>  <span class="at">riesgo_engagement =</span> <span class="fu">fcase</span>(</span>
<span id="cb14-829"><a href="#cb14-829" aria-hidden="true" tabindex="-1"></a>    frecuencia_transaccional <span class="sc">&lt;</span> <span class="fl">0.1</span> <span class="sc">&amp;</span> categorias_usadas <span class="sc">&lt;=</span> <span class="dv">2</span>, <span class="st">"ALTO"</span>,</span>
<span id="cb14-830"><a href="#cb14-830" aria-hidden="true" tabindex="-1"></a>    frecuencia_transaccional <span class="sc">&lt;</span> <span class="fl">0.3</span> <span class="sc">&amp;</span> categorias_usadas <span class="sc">&lt;=</span> <span class="dv">3</span>, <span class="st">"MEDIO"</span>, </span>
<span id="cb14-831"><a href="#cb14-831" aria-hidden="true" tabindex="-1"></a>    frecuencia_transaccional <span class="sc">&lt;</span> <span class="fl">0.5</span>, <span class="st">"BAJO"</span>,</span>
<span id="cb14-832"><a href="#cb14-832" aria-hidden="true" tabindex="-1"></a>    <span class="at">default =</span> <span class="st">"MÍNIMO"</span></span>
<span id="cb14-833"><a href="#cb14-833" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb14-834"><a href="#cb14-834" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-835"><a href="#cb14-835" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Señales económicas</span></span>
<span id="cb14-836"><a href="#cb14-836" aria-hidden="true" tabindex="-1"></a>  <span class="at">riesgo_economico =</span> <span class="fu">fcase</span>(</span>
<span id="cb14-837"><a href="#cb14-837" aria-hidden="true" tabindex="-1"></a>    gasto_promedio <span class="sc">&lt;</span> ingresos_mensuales <span class="sc">*</span> <span class="fl">0.01</span>, <span class="st">"ALTO"</span>,  <span class="co"># Gasta &lt;1% de ingresos</span></span>
<span id="cb14-838"><a href="#cb14-838" aria-hidden="true" tabindex="-1"></a>    gasto_promedio <span class="sc">&lt;</span> ingresos_mensuales <span class="sc">*</span> <span class="fl">0.03</span>, <span class="st">"MEDIO"</span>, <span class="co"># Gasta &lt;3% de ingresos</span></span>
<span id="cb14-839"><a href="#cb14-839" aria-hidden="true" tabindex="-1"></a>    gasto_promedio <span class="sc">&lt;</span> ingresos_mensuales <span class="sc">*</span> <span class="fl">0.05</span>, <span class="st">"BAJO"</span>,  <span class="co"># Gasta &lt;5% de ingresos</span></span>
<span id="cb14-840"><a href="#cb14-840" aria-hidden="true" tabindex="-1"></a>    <span class="at">default =</span> <span class="st">"MÍNIMO"</span></span>
<span id="cb14-841"><a href="#cb14-841" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb14-842"><a href="#cb14-842" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-843"><a href="#cb14-843" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Señal de valor del cliente</span></span>
<span id="cb14-844"><a href="#cb14-844" aria-hidden="true" tabindex="-1"></a>  <span class="at">valor_cliente =</span> <span class="fu">round</span>((gasto_total <span class="sc">/</span> dias_activos) <span class="sc">*</span> (ingresos_mensuales <span class="sc">/</span> <span class="dv">1000</span>), <span class="dv">0</span>)</span>
<span id="cb14-845"><a href="#cb14-845" aria-hidden="true" tabindex="-1"></a>)][, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-846"><a href="#cb14-846" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Score compuesto de riesgo de churn</span></span>
<span id="cb14-847"><a href="#cb14-847" aria-hidden="true" tabindex="-1"></a>  <span class="at">score_churn =</span> (</span>
<span id="cb14-848"><a href="#cb14-848" aria-hidden="true" tabindex="-1"></a>    (riesgo_inactividad <span class="sc">==</span> <span class="st">"ALTO"</span>) <span class="sc">*</span> <span class="dv">40</span> <span class="sc">+</span> (riesgo_inactividad <span class="sc">==</span> <span class="st">"MEDIO"</span>) <span class="sc">*</span> <span class="dv">25</span> <span class="sc">+</span> (riesgo_inactividad <span class="sc">==</span> <span class="st">"BAJO"</span>) <span class="sc">*</span> <span class="dv">10</span> <span class="sc">+</span></span>
<span id="cb14-849"><a href="#cb14-849" aria-hidden="true" tabindex="-1"></a>    (riesgo_engagement <span class="sc">==</span> <span class="st">"ALTO"</span>) <span class="sc">*</span> <span class="dv">30</span> <span class="sc">+</span> (riesgo_engagement <span class="sc">==</span> <span class="st">"MEDIO"</span>) <span class="sc">*</span> <span class="dv">20</span> <span class="sc">+</span> (riesgo_engagement <span class="sc">==</span> <span class="st">"BAJO"</span>) <span class="sc">*</span> <span class="dv">10</span> <span class="sc">+</span></span>
<span id="cb14-850"><a href="#cb14-850" aria-hidden="true" tabindex="-1"></a>    (riesgo_economico <span class="sc">==</span> <span class="st">"ALTO"</span>) <span class="sc">*</span> <span class="dv">20</span> <span class="sc">+</span> (riesgo_economico <span class="sc">==</span> <span class="st">"MEDIO"</span>) <span class="sc">*</span> <span class="dv">12</span> <span class="sc">+</span> (riesgo_economico <span class="sc">==</span> <span class="st">"BAJO"</span>) <span class="sc">*</span> <span class="dv">5</span> <span class="sc">+</span></span>
<span id="cb14-851"><a href="#cb14-851" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(<span class="sc">!</span>activo, <span class="dv">25</span>, <span class="dv">0</span>)  <span class="co"># Penalización por inactividad actual</span></span>
<span id="cb14-852"><a href="#cb14-852" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-853"><a href="#cb14-853" aria-hidden="true" tabindex="-1"></a>)][, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb14-854"><a href="#cb14-854" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 4. Clasificación final y estrategia</span></span>
<span id="cb14-855"><a href="#cb14-855" aria-hidden="true" tabindex="-1"></a>  <span class="at">clasificacion_churn =</span> <span class="fu">fcase</span>(</span>
<span id="cb14-856"><a href="#cb14-856" aria-hidden="true" tabindex="-1"></a>    score_churn <span class="sc">&gt;=</span> <span class="dv">80</span>, <span class="st">"CHURN_INMEDIATO"</span>,</span>
<span id="cb14-857"><a href="#cb14-857" aria-hidden="true" tabindex="-1"></a>    score_churn <span class="sc">&gt;=</span> <span class="dv">60</span>, <span class="st">"ALTO_RIESGO"</span>, </span>
<span id="cb14-858"><a href="#cb14-858" aria-hidden="true" tabindex="-1"></a>    score_churn <span class="sc">&gt;=</span> <span class="dv">40</span>, <span class="st">"RIESGO_MODERADO"</span>,</span>
<span id="cb14-859"><a href="#cb14-859" aria-hidden="true" tabindex="-1"></a>    score_churn <span class="sc">&gt;=</span> <span class="dv">20</span>, <span class="st">"BAJO_RIESGO"</span>,</span>
<span id="cb14-860"><a href="#cb14-860" aria-hidden="true" tabindex="-1"></a>    <span class="at">default =</span> <span class="st">"SALUDABLE"</span></span>
<span id="cb14-861"><a href="#cb14-861" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb14-862"><a href="#cb14-862" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-863"><a href="#cb14-863" aria-hidden="true" tabindex="-1"></a>  <span class="at">estrategia_retencion =</span> <span class="fu">fcase</span>(</span>
<span id="cb14-864"><a href="#cb14-864" aria-hidden="true" tabindex="-1"></a>    score_churn <span class="sc">&gt;=</span> <span class="dv">80</span>, <span class="st">"Contacto_Inmediato + Oferta_Especial"</span>,</span>
<span id="cb14-865"><a href="#cb14-865" aria-hidden="true" tabindex="-1"></a>    score_churn <span class="sc">&gt;=</span> <span class="dv">60</span>, <span class="st">"Programa_Reactivación + Descuentos"</span>,</span>
<span id="cb14-866"><a href="#cb14-866" aria-hidden="true" tabindex="-1"></a>    score_churn <span class="sc">&gt;=</span> <span class="dv">40</span>, <span class="st">"Comunicación_Personalizada"</span>, </span>
<span id="cb14-867"><a href="#cb14-867" aria-hidden="true" tabindex="-1"></a>    score_churn <span class="sc">&gt;=</span> <span class="dv">20</span>, <span class="st">"Monitoreo_Activo"</span>,</span>
<span id="cb14-868"><a href="#cb14-868" aria-hidden="true" tabindex="-1"></a>    <span class="at">default =</span> <span class="st">"Mantenimiento_Rutinario"</span></span>
<span id="cb14-869"><a href="#cb14-869" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-870"><a href="#cb14-870" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb14-871"><a href="#cb14-871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-872"><a href="#cb14-872" aria-hidden="true" tabindex="-1"></a><span class="co"># Análisis de resultados</span></span>
<span id="cb14-873"><a href="#cb14-873" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"📈 ANÁLISIS DE SUPERVIVENCIA DE CLIENTES 📈</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb14-874"><a href="#cb14-874" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-875"><a href="#cb14-875" aria-hidden="true" tabindex="-1"></a><span class="co"># Distribución por clasificación</span></span>
<span id="cb14-876"><a href="#cb14-876" aria-hidden="true" tabindex="-1"></a>distribucion_churn <span class="ot">&lt;-</span> modelo_churn[, .N, by <span class="ot">=</span> clasificacion_churn][<span class="fu">order</span>(<span class="sc">-</span>N)]</span>
<span id="cb14-877"><a href="#cb14-877" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"DISTRIBUCIÓN POR RIESGO DE CHURN:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-878"><a href="#cb14-878" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(distribucion_churn)</span>
<span id="cb14-879"><a href="#cb14-879" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-880"><a href="#cb14-880" aria-hidden="true" tabindex="-1"></a><span class="co"># Estadísticas por grupo de riesgo</span></span>
<span id="cb14-881"><a href="#cb14-881" aria-hidden="true" tabindex="-1"></a>stats_por_riesgo <span class="ot">&lt;-</span> modelo_churn[, .(</span>
<span id="cb14-882"><a href="#cb14-882" aria-hidden="true" tabindex="-1"></a>  <span class="at">clientes =</span> .N,</span>
<span id="cb14-883"><a href="#cb14-883" aria-hidden="true" tabindex="-1"></a>  <span class="at">score_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(score_churn), <span class="dv">1</span>),</span>
<span id="cb14-884"><a href="#cb14-884" aria-hidden="true" tabindex="-1"></a>  <span class="at">ingresos_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(ingresos_mensuales), <span class="dv">0</span>),</span>
<span id="cb14-885"><a href="#cb14-885" aria-hidden="true" tabindex="-1"></a>  <span class="at">valor_cliente_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(valor_cliente), <span class="dv">0</span>),</span>
<span id="cb14-886"><a href="#cb14-886" aria-hidden="true" tabindex="-1"></a>  <span class="at">dias_inactividad_promedio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(dias_desde_ultima_trans), <span class="dv">0</span>),</span>
<span id="cb14-887"><a href="#cb14-887" aria-hidden="true" tabindex="-1"></a>  <span class="at">tasa_actividad_actual =</span> <span class="fu">round</span>(<span class="fu">mean</span>(activo) <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>)</span>
<span id="cb14-888"><a href="#cb14-888" aria-hidden="true" tabindex="-1"></a>), by <span class="ot">=</span> clasificacion_churn][<span class="fu">order</span>(<span class="sc">-</span>score_promedio)]</span>
<span id="cb14-889"><a href="#cb14-889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-890"><a href="#cb14-890" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">📊 ESTADÍSTICAS POR GRUPO DE RIESGO:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-891"><a href="#cb14-891" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(stats_por_riesgo)</span>
<span id="cb14-892"><a href="#cb14-892" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-893"><a href="#cb14-893" aria-hidden="true" tabindex="-1"></a><span class="co"># Clientes críticos que requieren atención inmediata</span></span>
<span id="cb14-894"><a href="#cb14-894" aria-hidden="true" tabindex="-1"></a>clientes_criticos <span class="ot">&lt;-</span> modelo_churn[clasificacion_churn <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"CHURN_INMEDIATO"</span>, <span class="st">"ALTO_RIESGO"</span>), .(</span>
<span id="cb14-895"><a href="#cb14-895" aria-hidden="true" tabindex="-1"></a>  cliente_id, plan, pais, ingresos_mensuales, valor_cliente, </span>
<span id="cb14-896"><a href="#cb14-896" aria-hidden="true" tabindex="-1"></a>  score_churn, clasificacion_churn, estrategia_retencion,</span>
<span id="cb14-897"><a href="#cb14-897" aria-hidden="true" tabindex="-1"></a>  <span class="at">dias_inactividad =</span> dias_desde_ultima_trans</span>
<span id="cb14-898"><a href="#cb14-898" aria-hidden="true" tabindex="-1"></a>)][<span class="fu">order</span>(<span class="sc">-</span>score_churn)]</span>
<span id="cb14-899"><a href="#cb14-899" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-900"><a href="#cb14-900" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">🚨 CLIENTES QUE REQUIEREN ATENCIÓN INMEDIATA:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-901"><a href="#cb14-901" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(clientes_criticos, <span class="dv">10</span>))</span>
<span id="cb14-902"><a href="#cb14-902" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-903"><a href="#cb14-903" aria-hidden="true" tabindex="-1"></a><span class="co"># ROI potencial de estrategias de retención</span></span>
<span id="cb14-904"><a href="#cb14-904" aria-hidden="true" tabindex="-1"></a>roi_estrategias <span class="ot">&lt;-</span> modelo_churn[, .(</span>
<span id="cb14-905"><a href="#cb14-905" aria-hidden="true" tabindex="-1"></a>  <span class="at">clientes_objetivo =</span> .N,</span>
<span id="cb14-906"><a href="#cb14-906" aria-hidden="true" tabindex="-1"></a>  <span class="at">valor_total_riesgo =</span> <span class="fu">sum</span>(valor_cliente),</span>
<span id="cb14-907"><a href="#cb14-907" aria-hidden="true" tabindex="-1"></a>  <span class="at">valor_promedio_cliente =</span> <span class="fu">round</span>(<span class="fu">mean</span>(valor_cliente), <span class="dv">0</span>),</span>
<span id="cb14-908"><a href="#cb14-908" aria-hidden="true" tabindex="-1"></a>  <span class="at">inversion_retencion_estimada =</span> .N <span class="sc">*</span> <span class="fu">fcase</span>(</span>
<span id="cb14-909"><a href="#cb14-909" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unique</span>(clasificacion_churn) <span class="sc">==</span> <span class="st">"CHURN_INMEDIATO"</span>, <span class="dv">200</span>,</span>
<span id="cb14-910"><a href="#cb14-910" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unique</span>(clasificacion_churn) <span class="sc">==</span> <span class="st">"ALTO_RIESGO"</span>, <span class="dv">100</span>,</span>
<span id="cb14-911"><a href="#cb14-911" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unique</span>(clasificacion_churn) <span class="sc">==</span> <span class="st">"RIESGO_MODERADO"</span>, <span class="dv">50</span>,</span>
<span id="cb14-912"><a href="#cb14-912" aria-hidden="true" tabindex="-1"></a>    <span class="at">default =</span> <span class="dv">20</span></span>
<span id="cb14-913"><a href="#cb14-913" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb14-914"><a href="#cb14-914" aria-hidden="true" tabindex="-1"></a>  <span class="at">roi_potencial =</span> <span class="fu">round</span>((<span class="fu">sum</span>(valor_cliente) <span class="sc">*</span> <span class="fl">0.7</span>) <span class="sc">/</span> (.N <span class="sc">*</span> <span class="fu">fcase</span>(</span>
<span id="cb14-915"><a href="#cb14-915" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unique</span>(clasificacion_churn) <span class="sc">==</span> <span class="st">"CHURN_INMEDIATO"</span>, <span class="dv">200</span>,</span>
<span id="cb14-916"><a href="#cb14-916" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unique</span>(clasificacion_churn) <span class="sc">==</span> <span class="st">"ALTO_RIESGO"</span>, <span class="dv">100</span>, </span>
<span id="cb14-917"><a href="#cb14-917" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unique</span>(clasificacion_churn) <span class="sc">==</span> <span class="st">"RIESGO_MODERADO"</span>, <span class="dv">50</span>,</span>
<span id="cb14-918"><a href="#cb14-918" aria-hidden="true" tabindex="-1"></a>    <span class="at">default =</span> <span class="dv">20</span></span>
<span id="cb14-919"><a href="#cb14-919" aria-hidden="true" tabindex="-1"></a>  )), <span class="dv">1</span>)</span>
<span id="cb14-920"><a href="#cb14-920" aria-hidden="true" tabindex="-1"></a>), by <span class="ot">=</span> .(clasificacion_churn, estrategia_retencion)][<span class="fu">order</span>(<span class="sc">-</span>roi_potencial)]</span>
<span id="cb14-921"><a href="#cb14-921" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-922"><a href="#cb14-922" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">💰 ANÁLISIS DE ROI DE ESTRATEGIAS:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-923"><a href="#cb14-923" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(roi_estrategias)</span>
<span id="cb14-924"><a href="#cb14-924" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-925"><a href="#cb14-925" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb14-926"><a href="#cb14-926" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-927"><a href="#cb14-927" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb14-928"><a href="#cb14-928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-929"><a href="#cb14-929" aria-hidden="true" tabindex="-1"></a>::: {.callout-important}</span>
<span id="cb14-930"><a href="#cb14-930" aria-hidden="true" tabindex="-1"></a><span class="fu">## 🎯 Puntos Clave de Este Capítulo</span></span>
<span id="cb14-931"><a href="#cb14-931" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-932"><a href="#cb14-932" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Funciones de ventana** (<span class="in">`shift`</span>, <span class="in">`frollmean`</span>, <span class="in">`frollapply`</span>) permiten análisis temporal sofisticado sin colapsar datos</span>
<span id="cb14-933"><a href="#cb14-933" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Funciones condicionales** (<span class="in">`fifelse`</span>, <span class="in">`fcase`</span>, <span class="in">`between`</span>) optimizan clasificaciones complejas</span>
<span id="cb14-934"><a href="#cb14-934" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Funciones de agregación especiales** (<span class="in">`frank`</span>, <span class="in">`rleid`</span>, <span class="in">`uniqueN`</span>) revelan patrones ocultos en los datos</span>
<span id="cb14-935"><a href="#cb14-935" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Análisis temporal** combina múltiples técnicas para detección de anomalías y predicción</span>
<span id="cb14-936"><a href="#cb14-936" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Performance**: Estas funciones están altamente optimizadas y son significativamente más rápidas que alternativas de R base</span>
<span id="cb14-937"><a href="#cb14-937" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>**Casos de uso reales**: Finanzas, IoT, análisis de comportamiento - las aplicaciones son ilimitadas</span>
<span id="cb14-938"><a href="#cb14-938" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb14-939"><a href="#cb14-939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-940"><a href="#cb14-940" aria-hidden="true" tabindex="-1"></a>Las funciones especiales de <span class="in">`data.table`</span> te dan superpoderes para análisis complejos. En el próximo capítulo exploraremos las técnicas de reshape que complementan perfectamente estas funciones para transformaciones de datos avanzadas.</span>
<span id="cb14-941"><a href="#cb14-941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-942"><a href="#cb14-942" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">function_calls</span><span class="dt">&gt;</span></span>
<span id="cb14-943"><a href="#cb14-943" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">invoke</span><span class="ot"> name</span><span class="op">=</span><span class="st">"TodoWrite"</span><span class="dt">&gt;</span></span>
<span id="cb14-944"><a href="#cb14-944" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">parameter</span><span class="ot"> name</span><span class="op">=</span><span class="st">"todos"</span><span class="dt">&gt;</span><span class="co">[</span><span class="ot">{"content": "Reorganizar M\u00f3dulo 1: dividir fundamentos en sintaxis y s\u00edmbolos", "status": "completed", "id": "1"}, {"content": "Crear cap01-simbolos.qmd para s\u00edmbolos especiales del M\u00f3dulo 1", "status": "completed", "id": "1-new"}, {"content": "Reorganizar M\u00f3dulo 2: dividir en encadenamiento y joins", "status": "completed", "id": "2"}, {"content": "Crear cap03-joins-avanzados.qmd para joins avanzados del M\u00f3dulo 3", "status": "completed", "id": "3-1"}, {"content": "Crear cap03-funciones-especiales.qmd para funciones especiales del M\u00f3dulo 3", "status": "completed", "id": "3-2"}, {"content": "Crear cap03-reshape.qmd para reshape del M\u00f3dulo 3", "status": "in_progress", "id": "3-3"}, {"content": "Reorganizar M\u00f3dulo 4: dividir en performance y buenas pr\u00e1cticas", "status": "pending", "id": "4"}, {"content": "Reorganizar M\u00f3dulo 5: dividir en visualizaci\u00f3n y aplicaciones", "status": "pending", "id": "5"}</span><span class="co">]</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/tutorial-datatable/tutorial_data.table/issues" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer><script src="site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>